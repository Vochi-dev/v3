<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{{ enterprise_name }} —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="96x96" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <meta name="theme-color" content="#2563eb">
    <meta name="msapplication-TileColor" content="#2563eb">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin-top: 20px;
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e0e6ed;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn {
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            border: none;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .result-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #667eea;
            display: none;
        }
        .result-panel.show {
            display: block;
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .icon-input {
            position: relative;
        }
        .icon-input i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        .icon-input input, .icon-input select {
            padding-left: 45px;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: inline-block;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—Å–µ–≥–¥–∞ */
        [data-field="duration"] {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="row">
                    <!-- –ü–æ–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–∏–ø–∞ –∑–≤–æ–Ω–∫–∞ -->
                    <div class="col-md-4">
                        <div class="main-container" style="min-height: 500px;">
                            <h5><i class="fas fa-info-circle"></i> –û–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–∞ –∑–≤–æ–Ω–∫–∞</h5>
                            <div id="call-type-description" style="background: #f8f9fa; border-radius: 10px; padding: 15px; min-height: 300px; border: 2px dashed #dee2e6;">
                                <p class="text-muted text-center" style="margin-top: 100px;">
                                    <i class="fas fa-arrow-right fa-2x"></i><br><br>
                                    –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–≤–æ–Ω–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–ø–∏—Å–∞–Ω–∏—è
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
                    <div class="col-md-8">
                        <div class="main-container">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                    <div class="header">
                        <h1><i class="fas fa-phone-alt"></i> –¢–µ—Å—Ç–µ—Ä –∑–≤–æ–Ω–∫–æ–≤</h1>
                        <h3 class="text-muted">{{ enterprise_name }} ({{ enterprise_number }})</h3>
                        <p class="text-muted">–≠–º—É–ª—è—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∑–≤–æ–Ω–∫–∞ —Å –æ–±–æ–≥–∞—â–µ–Ω–∏–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏</p>
                    </div>

                    <!-- –§–æ—Ä–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                    <form id="testForm">
                        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –Ω–æ–º–µ—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è -->
                        <input type="hidden" name="enterprise" id="enterpriseInput" value="{{ enterprise_number }}">
                        
                        <div class="row">
                            <!-- –¢–∏–ø –∑–≤–æ–Ω–∫–∞ -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-phone-volume"></i> –¢–∏–ø –∑–≤–æ–Ω–∫–∞
                                    </label>
                                    <div class="icon-input">
                                        <i class="fas fa-list"></i>
                                        <select class="form-select" name="call_type" id="call_type" required>
                                            {% for ct in call_types %}
                                            <option value="{{ ct.id }}">{{ ct.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="row">
                            <!-- –í–Ω–µ—à–Ω–∏–π –Ω–æ–º–µ—Ä -->
                            <div class="col-md-6" data-field="external_phone">
                                <div class="form-group">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-mobile-alt"></i> –í–Ω–µ—à–Ω–∏–π –Ω–æ–º–µ—Ä
                                    </label>
                                    <div class="icon-input">
                                        <i class="fas fa-phone"></i>
                                        <input type="text" class="form-control" name="external_phone" 
                                               value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–Ω–µ—à–Ω–∏–π –Ω–æ–º–µ—Ä" required>
                                    </div>
                                </div>
                            </div>

                            <!-- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
                            <div class="col-md-6" data-field="duration">
                                <div class="form-group">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-clock"></i> –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)
                                    </label>
                                    <div class="icon-input">
                                        <i class="fas fa-hourglass-half"></i>
                                        <input type="number" class="form-control" name="duration_minutes" 
                                               value="3" min="1" max="60" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- –ú–µ–Ω–µ–¥–∂–µ—Ä -->
                            <div class="col-md-6" data-field="manager">
                                <div class="form-group">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-user"></i> –ú–µ–Ω–µ–¥–∂–µ—Ä
                                    </label>
                                    <div class="icon-input">
                                        <i class="fas fa-headset"></i>
                                        <select class="form-select" name="internal_phone" id="internal_phone" required>
                                            {% for phone, manager in managers.items() %}
                                            <option value="{{ phone }}">{{ phone }} - {{ manager.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- –õ–∏–Ω–∏—è -->
                            <div class="col-md-6" data-field="line">
                                <div class="form-group">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-signal"></i> –õ–∏–Ω–∏—è
                                    </label>
                                    <div class="icon-input">
                                        <i class="fas fa-broadcast-tower"></i>
                                        <select class="form-select" name="line_id" id="line_id" required>
                                            {% for line_id, line in lines.items() %}
                                            <option value="{{ line_id }}">{{ line_id }} - {{ line.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- –í—Ç–æ—Ä–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä -->
                            <div class="col-md-6" data-field="second_manager">
                                <div class="form-group">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-user-plus"></i> –í—Ç–æ—Ä–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä (–∫–æ–º—É)
                                    </label>
                                    <div class="icon-input">
                                        <i class="fas fa-headset"></i>
                                        <select class="form-select" name="second_internal_phone">
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</option>
                                            {% for phone, manager in managers.items() %}
                                            <option value="{{ phone }}">{{ phone }} - {{ manager.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- –†–µ–∑–µ—Ä–≤–Ω–∞—è –ª–∏–Ω–∏—è -->
                            <div class="col-md-6" data-field="backup_line">
                                <div class="form-group">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-sync-alt"></i> –†–µ–∑–µ—Ä–≤–Ω–∞—è –ª–∏–Ω–∏—è
                                    </label>
                                    <div class="icon-input">
                                        <i class="fas fa-broadcast-tower"></i>
                                        <select class="form-select" name="backup_line_id">
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –ª–∏–Ω–∏—é</option>
                                            {% for line_id, line in lines.items() %}
                                            <option value="{{ line_id }}">{{ line_id }} - {{ line.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg me-3">
                                <i class="fas fa-rocket"></i> 
                                <span class="loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                                <span class="btn-text">–≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–≤–æ–Ω–æ–∫</span>
                            </button>
                            <button type="button" class="btn btn-success btn-lg" onclick="previewTelegram()">
                                <i class="fab fa-telegram"></i> –ü—Ä–µ–≤—å—é Telegram
                            </button>
                        </div>
                    </form>

                    <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                    <div class="result-panel" id="resultPanel">
                        <h5><i class="fas fa-chart-line"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h5>
                        <div id="resultContent">
                            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–≤—å—é -->
    <div class="modal fade" id="telegramModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fab fa-telegram"></i> –ü—Ä–µ–≤—å—é Telegram —Å–æ–æ–±—â–µ–Ω–∏—è
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="telegram-preview" id="telegramPreview">
                        <!-- –ü—Ä–µ–≤—å—é –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –î–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–±–ª–æ–Ω–∞
        const managers = {{ managers|tojson }};
        const lines = {{ lines|tojson }};
        const callTypes = {{ call_types|tojson }};
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–∏–ø–∞ –∑–≤–æ–Ω–∫–∞
        function updateCallTypeDescription(callTypeId) {
            const descriptionDiv = document.getElementById('call-type-description');
            const callType = callTypes.find(ct => ct.id == callTypeId);
            
            if (callType) {
                const description = callType.description.replace(/\\n/g, '<br>');
                descriptionDiv.innerHTML = `
                    <h6 class="fw-bold text-primary">
                        <i class="fas fa-phone"></i> ${callType.name}
                    </h6>
                    <div class="mt-3" style="line-height: 1.6; font-size: 0.95em;">
                        ${description}
                    </div>
                `;
            } else {
                descriptionDiv.innerHTML = `
                    <p class="text-muted text-center" style="margin-top: 100px;">
                        <i class="fas fa-arrow-right fa-2x"></i><br><br>
                        –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–≤–æ–Ω–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–ø–∏—Å–∞–Ω–∏—è
                    </p>
                `;
            }
        }
        
        // –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–≤–æ–Ω–∫–∞
        const callTypeFieldMapping = {
            "1": {
                fields: ["external_phone", "manager", "line"],
                required: ["external_phone", "manager", "line"],
                description: "–ü—Ä—è–º–æ–π –Ω–∞–±–æ—Ä –Ω–æ–º–µ—Ä–∞ - –∞–±–æ–Ω–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª",
                defaultDuration: 3,
                defaultResult: "answered"
            },
            "2": {
                fields: ["external_phone", "manager", "line"],
                required: ["external_phone", "manager", "line"],
                description: "–ù–∞–±–æ—Ä –Ω–æ–º–µ—Ä–∞ —Å –≤–Ω–µ—à–Ω–µ–π –∏–Ω–∏—Ü–∏–∞—Ü–∏–µ–π (–∏–∑ —Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã, CRM) - –∑–≤–æ–Ω–æ–∫ –æ—Ç–≤–µ—á–µ–Ω",
                defaultDuration: 3,
                defaultResult: "answered"
            },
            "3": {
                fields: ["external_phone", "manager", "line", "second_manager"],
                required: ["external_phone", "manager", "line", "second_manager"],
                description: "–ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –≤—ã–∑–æ–≤–∞ —Å –∑–∞–ø—Ä–æ—Å–æ–º - –≤—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º - —Ä–∞–∑–≥–æ–≤–æ—Ä –æ—Ç–∫–ª–æ–Ω–µ–Ω",
                defaultDuration: 3,
                defaultResult: "answered"
            },
            "4": {
                fields: ["external_phone", "manager", "line", "second_manager"],
                required: ["external_phone", "manager", "line", "second_manager"],
                description: "–ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –≤—ã–∑–æ–≤–∞ —Å –∑–∞–ø—Ä–æ—Å–æ–º - –≤—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º - –æ–Ω —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å",
                defaultDuration: 3,
                defaultResult: "answered"
            },
            "5": {
                fields: ["external_phone", "manager", "line", "second_manager"],
                required: ["external_phone", "manager", "line", "second_manager"],
                description: "–ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –≤—ã–∑–æ–≤–∞ —Å –∑–∞–ø—Ä–æ—Å–æ–º - –≤—ã–∑–æ–≤ –Ω–µ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º (–Ω–µ—Ç –Ω–∞ –º–µ—Å—Ç–µ)",
                defaultDuration: 3,
                defaultResult: "answered"
            },
            "6": {
                fields: ["external_phone", "manager", "line", "second_manager"],
                required: ["external_phone", "manager", "line", "second_manager"],
                description: "–ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ - –≤—ã–∑–æ–≤ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º",
                defaultDuration: 3,
                defaultResult: "answered"
            },
            "7": {
                fields: ["external_phone", "manager", "line", "second_manager"],
                required: ["external_phone", "manager", "line", "second_manager"],
                description: "–ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ - –≤—ã–∑–æ–≤ –Ω–µ –ø—Ä–∏–Ω—è—Ç –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º",
                defaultDuration: 3,
                defaultResult: "answered"
            },
            "8": {
                fields: ["external_phone", "manager", "line"],
                required: ["external_phone", "manager", "line"],
                description: "–ü—Ä—è–º–æ–π –Ω–∞–±–æ—Ä –Ω–æ–º–µ—Ä–∞ - –∞–±–æ–Ω–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª",
                defaultDuration: 3,
                defaultResult: "noanswer"
            },
            "9": {
                fields: ["external_phone", "manager", "line", "backup_line"],
                required: ["external_phone", "manager", "line", "backup_line"],
                description: "–ü—Ä—è–º–æ–π –Ω–∞–±–æ—Ä –Ω–æ–º–µ—Ä–∞ - 151 –∑–≤–æ–Ω–∏—Ç –∞–±–æ–Ω–µ–Ω—Ç—É +375296254070, —Å–∏—Å—Ç–µ–º–∞ —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–Ω–æ –¥–∏–∞–ª–ø–ª–∞–Ω—É –Ω–∞–±—Ä–∞—Ç—å –Ω–æ–º–µ—Ä —Å –ª–∏–Ω–∏–∏ 0001363, –Ω–æ –æ–Ω–∞ –æ–∫–∞–∑–∞–ª–∞—Å—å –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–º, –∏ –∑–≤–æ–Ω–æ–∫ —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –ø–æ—à–µ–ª —Å —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –ª–∏–Ω–∏–∏ 0001366, —Ç—Ä—É–±–∫—É –ø–æ–¥–Ω—è–ª–∏",
                defaultDuration: 3,
                defaultResult: "answered"
            }
            // –î–æ–±–∞–≤–∏–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –ø–æ—à—Ç—É—á–Ω–æ
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–≤–æ–Ω–∫–∞
        function updateFieldsVisibility(callTypeId) {
            const mapping = callTypeFieldMapping[callTypeId];
            if (!mapping) {
                console.log("–ú–∞–ø–ø–∏–Ω–≥ –¥–ª—è —Ç–∏–ø–∞", callTypeId, "–Ω–µ –Ω–∞–π–¥–µ–Ω");
                return;
            }

            // –í—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ–ª—è
            const allFields = [
                "external_phone", "manager", "line", "duration",
                "second_manager", "transfer_type", "follow_me_phone", 
                "backup_line", "department", "greeting"
            ];

            // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ duration –≤—Å–µ–≥–¥–∞ (–æ–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            const hiddenFields = ["duration"];

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è
            allFields.forEach(fieldName => {
                const container = document.querySelector(`[data-field="${fieldName}"]`);
                if (container) {
                    // –í—Å–µ–≥–¥–∞ —Å–∫—Ä—ã–≤–∞–µ–º duration –∏ result
                    if (hiddenFields.includes(fieldName)) {
                        container.style.display = 'none';
                    } else {
                        container.style.display = 'none';
                    }
                    const input = container.querySelector('input, select');
                    if (input) input.required = false;
                }
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è (–∫—Ä–æ–º–µ –≤—Å–µ–≥–¥–∞ —Å–∫—Ä—ã—Ç—ã—Ö)
            mapping.fields.forEach(fieldName => {
                const container = document.querySelector(`[data-field="${fieldName}"]`);
                if (container && !hiddenFields.includes(fieldName)) {
                    container.style.display = 'block';
                    const input = container.querySelector('input, select');
                    if (input && mapping.required.includes(fieldName)) {
                        input.required = true;
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –ª–∏–Ω–∏–π –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª–µ–π
            setTimeout(updateManagerAvailability, 50);
            setTimeout(updateLineAvailability, 50);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –∑–≤–æ–Ω–∫–∞
        document.getElementById('call_type').addEventListener('change', function() {
            updateCallTypeDescription(this.value);
            updateFieldsVisibility(this.value);
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        function updateManagerAvailability() {
            const firstManager = document.getElementById('internal_phone');
            const secondManager = document.querySelector('select[name="second_internal_phone"]');
            
            if (!firstManager || !secondManager) return;
            
            const selectedFirstManager = firstManager.value;
            
            // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –≤–æ –≤—Ç–æ—Ä–æ–º —Å–µ–ª–µ–∫—Ç–µ
            Array.from(secondManager.options).forEach(option => {
                option.disabled = false;
                option.style.color = '';
                option.style.backgroundColor = '';
            });
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –ø–µ—Ä–≤–æ–º —Å–µ–ª–µ–∫—Ç–µ
            if (selectedFirstManager) {
                Array.from(secondManager.options).forEach(option => {
                    if (option.value === selectedFirstManager) {
                        option.disabled = true;
                        option.style.color = '#ccc';
                        option.style.backgroundColor = '#f5f5f5';
                    }
                });
                
                // –ï—Å–ª–∏ –≤–æ –≤—Ç–æ—Ä–æ–º —Å–µ–ª–µ–∫—Ç–µ –≤—ã–±—Ä–∞–Ω —Ç–æ—Ç –∂–µ –º–µ–Ω–µ–¥–∂–µ—Ä, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                if (secondManager.value === selectedFirstManager) {
                    secondManager.value = '';
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ª–∏–Ω–∏–π
        function updateLineAvailability() {
            const firstLine = document.getElementById('line_id');
            const backupLine = document.querySelector('select[name="backup_line_id"]');
            
            if (!firstLine || !backupLine) return;
            
            const selectedFirstLine = firstLine.value;
            
            // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –≤ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –ª–∏–Ω–∏–∏
            Array.from(backupLine.options).forEach(option => {
                option.disabled = false;
                option.style.color = '';
                option.style.backgroundColor = '';
            });
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏–Ω–∏–∏
            if (selectedFirstLine) {
                Array.from(backupLine.options).forEach(option => {
                    if (option.value === selectedFirstLine) {
                        option.disabled = true;
                        option.style.color = '#ccc';
                        option.style.backgroundColor = '#f5f5f5';
                    }
                });
                
                // –ï—Å–ª–∏ –≤ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –ª–∏–Ω–∏–∏ –≤—ã–±—Ä–∞–Ω–∞ —Ç–∞ –∂–µ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                if (backupLine.value === selectedFirstLine) {
                    backupLine.value = '';
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –ª–∏–Ω–∏–π
        document.addEventListener('DOMContentLoaded', function() {
            const firstManager = document.getElementById('internal_phone');
            const secondManager = document.querySelector('select[name="second_internal_phone"]');
            const firstLine = document.getElementById('line_id');
            const backupLine = document.querySelector('select[name="backup_line_id"]');
            
            if (firstManager) {
                firstManager.addEventListener('change', updateManagerAvailability);
            }
            if (secondManager) {
                secondManager.addEventListener('change', updateManagerAvailability);
            }
            if (firstLine) {
                firstLine.addEventListener('change', updateLineAvailability);
            }
            if (backupLine) {
                backupLine.addEventListener('change', updateLineAvailability);
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            const callTypeSelect = document.getElementById('call_type');
            if (callTypeSelect.value) {
                updateCallTypeDescription(callTypeSelect.value);
                updateFieldsVisibility(callTypeSelect.value);
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –ª–∏–Ω–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            setTimeout(updateManagerAvailability, 100);
            setTimeout(updateLineAvailability, 100);
        });



        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const loading = submitBtn.querySelector('.loading');
            const btnText = submitBtn.querySelector('.btn-text');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            loading.classList.add('show');
            btnText.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(this);
                const response = await fetch('/api/test-call', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                showResult(result);
                
            } catch (error) {
                console.error('Error:', error);
                showResult({
                    success: false,
                    message: '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞',
                    details: { errors: [error.message] }
                });
            } finally {
                // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                loading.classList.remove('show');
                btnText.textContent = '–≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–≤–æ–Ω–æ–∫';
                submitBtn.disabled = false;
            }
        });

        // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        function showResult(result) {
            const panel = document.getElementById('resultPanel');
            const content = document.getElementById('resultContent');
            
            const successIcon = result.success ? '‚úÖ' : '‚ùå';
            const statusClass = result.success ? 'text-success' : 'text-danger';
            
            let html = `
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="${statusClass}">
                            ${successIcon} ${result.message}
                        </h6>
                        <p><strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID:</strong> ${result.details.unique_id}</p>
                        <p><strong>–°–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</strong> ${result.details.events_sent}/4</p>
                        <p><strong>–û—à–∏–±–æ–∫:</strong> ${result.details.events_failed}</p>
            `;
            
            if (result.details.errors && result.details.errors.length > 0) {
                html += `<p><strong>–û—à–∏–±–∫–∏:</strong></p><ul>`;
                result.details.errors.forEach(error => {
                    html += `<li class="text-danger">${error}</li>`;
                });
                html += `</ul>`;
            }
            
            html += `</div></div>`;
            
            content.innerHTML = html;
            panel.classList.add('show');
            
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // –ü—Ä–µ–≤—å—é Telegram
        function previewTelegram() {
            const modal = new bootstrap.Modal(document.getElementById('telegramModal'));
            const preview = document.getElementById('telegramPreview');
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
            const formData = new FormData(document.getElementById('testForm'));
            const callType = parseInt(formData.get('call_type'));
            const externalPhone = formData.get('external_phone');
            const internalPhone = formData.get('internal_phone');
            const lineId = formData.get('line_id');
            const callStatus = parseInt(formData.get('call_status'));
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é
            const manager = managers[internalPhone];
            const line = lines[lineId];
            const callTypeName = callTypes.find(ct => ct.id === callType)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
            const statusText = callStatus === 2 ? '–£—Å–ø–µ—à–Ω—ã–π' : '–ù–µ—É–¥–∞—á–Ω—ã–π';
            const statusIcon = callStatus === 2 ? '‚úÖ' : '‚ùå';
            const callDirection = callType === 0 ? '–≤—Ö–æ–¥—è—â–∏–π' : (callType === 1 ? '–∏—Å—Ö–æ–¥—è—â–∏–π' : '–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π');
            
            let telegramText = `${statusIcon} ${statusText} ${callDirection} –∑–≤–æ–Ω–æ–∫\\n`;
            
            if (callType === 0) { // –í—Ö–æ–¥—è—â–∏–π
                telegramText += `${externalPhone}\\n`;
                telegramText += `${manager ? manager.name : `–î–æ–±.${internalPhone}`}\\n`;
            } else if (callType === 1) { // –ò—Å—Ö–æ–¥—è—â–∏–π  
                telegramText += `${externalPhone}\\n`;
                telegramText += `${manager ? manager.name : `–î–æ–±.${internalPhone}`}\\n`;
            } else { // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π
                telegramText += `${manager ? manager.name : `–î–æ–±.${internalPhone}`} ‚Üí ${externalPhone}\\n`;
            }
            
            telegramText += `üì°${line ? line.name : `–õ–∏–Ω–∏—è ${lineId}`}\\n`;
            telegramText += `‚åõ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${formData.get('duration_minutes')}:00\\n`;
            
            if (callStatus === 2) {
                telegramText += `üîâ–ó–∞–ø–∏—Å—å —Ä–∞–∑–≥–æ–≤–æ—Ä–∞`;
            }
            
            preview.innerHTML = `
                <div class="telegram-message" style="
                    background: #0088cc;
                    color: white;
                    padding: 15px;
                    border-radius: 15px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
                    max-width: 400px;
                    margin: 0 auto;
                    white-space: pre-line;
                ">
                    ${telegramText.replace(/\\n/g, '\\n')}
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">
                        üí° –≠—Ç–æ –ø—Ä–µ–≤—å—é —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–±–æ–≥–∞—â–µ–Ω–∏–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
                    </small>
                </div>
            `;
            
            modal.show();
        }
    </script>
</body>
</html>
