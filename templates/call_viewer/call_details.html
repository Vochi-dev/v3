<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –∑–≤–æ–Ω–∫–∞ #{{ unique_id }}</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <style>
        /* ============================================
           PLANFIX UI KIT - CSS VARIABLES
           ============================================ */
        :root {
            /* –¶–≤–µ—Ç–∞ */
            --pf-primary: #6fa92e;
            --pf-primary-dark: #5b951a;
            --pf-blue: #3377C3;
            --pf-success: #30AB50;
            --pf-danger: #d9534f;
            --pf-warning: #f59e0b;
            --pf-gray-darkest: #343434;
            --pf-gray-dark: #666666;
            --pf-gray: #999999;
            --pf-gray-light: #b3b3b3;
            --pf-gray-lighter: #d0d0d0;
            --pf-gray-lightest: #f5f5f5;
            --pf-white: #ffffff;
            
            /* –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
            --pf-font-family: -apple-system, "system-ui", "Segoe UI", roboto, "Helvetica Neue", helvetica, arial, sans-serif;
            --pf-font-size-base: 26px;
            --pf-font-size-large: 30px;
            --pf-font-size-h3: 30px;
            --pf-font-size-h2: 36px;
            --pf-font-size-h1: 48px;
            
            /* –û—Ç—Å—Ç—É–ø—ã */
            --pf-spacing-sm: 8px;
            --pf-spacing-md: 12px;
            --pf-spacing-lg: 16px;
            --pf-spacing-xl: 20px;
            --pf-spacing-xxl: 24px;
            
            /* –¢–µ–Ω–∏ */
            --pf-shadow-md: 0 1px 3px rgba(0, 0, 0, 0.1);
            
            /* –ü–µ—Ä–µ—Ö–æ–¥—ã */
            --pf-transition-base: 0.2s ease;
        }
        
        /* ============================================
           –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò
           ============================================ */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--pf-font-family);
            font-size: var(--pf-font-size-base);
            color: var(--pf-gray-darkest);
            line-height: 1.5;
            margin: 0;
            padding: 0;
            background-color: var(--pf-gray-lightest);
        }
        
        /* ============================================
           –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê
           ============================================ */
        h1 {
            font-size: var(--pf-font-size-h1);
            font-weight: 600;
            color: var(--pf-gray-darkest);
            margin: 0 0 var(--pf-spacing-md) 0;
        }
        
        h2 {
            font-size: var(--pf-font-size-h2);
            font-weight: 600;
            color: var(--pf-gray-darkest);
            margin: 0 0 var(--pf-spacing-lg) 0;
            padding-bottom: var(--pf-spacing-md);
            border-bottom: 2px solid var(--pf-primary);
        }
        
        /* ============================================
           –ö–ê–†–¢–û–ß–ö–ò
           ============================================ */
        .pf-card {
            background-color: var(--pf-white);
            border-radius: 4px;
            padding: var(--pf-spacing-xxl);
            box-shadow: var(--pf-shadow-md);
            margin-bottom: var(--pf-spacing-xxl);
        }
        
        /* ============================================
           –ö–ù–û–ü–ö–ò
           ============================================ */
        .pf-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            font-size: var(--pf-font-size-base);
            font-weight: 400;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all var(--pf-transition-base);
            text-decoration: none;
        }
        
        .pf-btn-primary {
            background-color: var(--pf-primary);
            color: var(--pf-white);
        }
        
        .pf-btn-primary:hover {
            background-color: var(--pf-primary-dark);
        }
        
        /* ============================================
           –°–¢–ê–¢–£–°–´
           ============================================ */
        .status-success { color: var(--pf-success); }
        .status-error { color: var(--pf-danger); }
        .status-warning { color: var(--pf-warning); }
        .status-info { color: var(--pf-blue); }
        
        /* ============================================
           GRID & LAYOUT
           ============================================ */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: var(--pf-spacing-xxl);
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--pf-spacing-lg);
        }
        
        .info-box {
            background-color: var(--pf-gray-lightest);
            padding: var(--pf-spacing-lg);
            border-radius: 4px;
        }
        
        .info-box-label {
            font-size: 24px;
            color: var(--pf-gray-dark);
            margin-bottom: 4px;
        }
        
        .info-box-value {
            font-size: 36px;
            font-weight: 600;
            color: var(--pf-gray-darkest);
        }
        
        /* ============================================
           –£–ß–ê–°–¢–ù–ò–ö–ò
           ============================================ */
        .participant {
            display: flex;
            align-items: center;
            gap: var(--pf-spacing-lg);
            padding: var(--pf-spacing-lg);
            border-radius: 4px;
            margin-bottom: var(--pf-spacing-md);
        }
        
        .participant-manager {
            background-color: #fef2f2;
        }
        
        .participant-client {
            background-color: #f0fdf4;
        }
        
        .participant-icon {
            font-size: 64px;
        }
        
        .participant-label {
            font-size: 24px;
            color: var(--pf-gray-dark);
        }
        
        .participant-value {
            font-size: 36px;
            font-weight: 600;
            color: var(--pf-gray-darkest);
        }
        
        .arrow-down {
            text-align: center;
            font-size: 48px;
            margin: var(--pf-spacing-md) 0;
        }
        
        /* ============================================
           TIMELINE
           ============================================ */
        .timeline {
            position: relative;
        }
        
        .timeline-item {
            display: flex;
            gap: var(--pf-spacing-lg);
            margin-bottom: var(--pf-spacing-xl);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .timeline-time {
            flex-shrink: 0;
            width: 160px;
            font-size: 30px;
            font-weight: 600;
            color: var(--pf-gray-darkest);
        }
        
        .timeline-badge {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            background-color: var(--pf-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--pf-white);
            font-weight: 600;
            font-size: 30px;
            box-shadow: var(--pf-shadow-md);
        }
        
        .timeline-content {
            flex: 1;
            background-color: var(--pf-gray-lightest);
            padding: var(--pf-spacing-lg);
            border-radius: 4px;
        }
        
        .timeline-title {
            font-size: var(--pf-font-size-large);
            font-weight: 600;
            margin-bottom: var(--pf-spacing-sm);
        }
        
        .timeline-subtitle {
            font-size: var(--pf-font-size-large);
            font-weight: 600;
            color: var(--pf-gray-darkest);
            margin-bottom: var(--pf-spacing-sm);
        }
        
        .timeline-actions {
            margin-top: var(--pf-spacing-lg);
            padding-left: var(--pf-spacing-lg);
            border-left: 4px solid var(--pf-primary);
            background-color: rgba(111, 169, 46, 0.05);
            padding: var(--pf-spacing-md);
            border-radius: 4px;
        }
        
        .timeline-actions-title {
            font-size: var(--pf-font-size-large);
            font-weight: 600;
            color: var(--pf-primary-dark);
            margin-bottom: var(--pf-spacing-sm);
        }
        
        .timeline-connector {
            margin-left: 220px;
            border-left: 2px solid var(--pf-gray-lighter);
            height: 48px;
        }
        
        /* ============================================
           ACCORDION
           ============================================ */
        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--pf-spacing-lg);
        }
        
        .accordion-toggle {
            color: var(--pf-blue);
            cursor: pointer;
            font-size: var(--pf-font-size-base);
            background: none;
            border: none;
            padding: 4px 8px;
        }
        
        .accordion-toggle:hover {
            text-decoration: underline;
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .accordion-content.active {
            max-height: 5000px;
        }
        
        /* ============================================
           DETAILS & CODE
           ============================================ */
        details {
            margin-top: var(--pf-spacing-sm);
        }
        
        summary {
            cursor: pointer;
            font-size: var(--pf-font-size-base);
            color: var(--pf-blue);
            padding: 4px 0;
        }
        
        summary:hover {
            text-decoration: underline;
        }
        
        pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: var(--pf-spacing-md);
            border-radius: 4px;
            overflow-x: auto;
            font-size: 24px;
            margin: var(--pf-spacing-sm) 0;
        }
        
        /* ============================================
           LISTS
           ============================================ */
        .action-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .action-list li {
            font-size: var(--pf-font-size-large);
            font-weight: 600;
            color: var(--pf-gray-darkest);
            margin-bottom: var(--pf-spacing-sm);
        }
        
        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .timeline-time {
                width: 120px;
                font-size: 26px;
            }
            
            .timeline-badge {
                width: 64px;
                height: 64px;
                font-size: 26px;
            }
            
            .container {
                padding: var(--pf-spacing-md);
            }
        }
        
        /* ============================================
           HEADER
           ============================================ */
        .header-flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-subtitle {
            color: var(--pf-gray-dark);
            font-size: var(--pf-font-size-base);
        }
        
        /* ============================================
           FOOTER
           ============================================ */
        .footer {
            text-align: center;
            color: var(--pf-gray);
            font-size: 24px;
            margin-top: var(--pf-spacing-xxl);
        }
    </style>
</head>
<body>
    <div class="container">
            
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="pf-card">
                <div class="header-flex">
                    <div>
                        <h1>üìû –î–µ—Ç–∞–ª–∏ –∑–≤–æ–Ω–∫–∞</h1>
                        <p class="header-subtitle">
                            –ó–≤–æ–Ω–æ–∫ #{{ unique_id[:15] }}... 
                            {% if enterprise_info %}
                            | üè¢ {{ enterprise_info.name }} ({{ enterprise_number }})
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <button onclick="window.print()" class="pf-btn pf-btn-primary">
                            üñ®Ô∏è –ü–µ—á–∞—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ë–ª–æ–∫ 1: –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="pf-card">
                <h2>üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                <div class="grid-2">
                    <div class="info-box">
                        <p class="info-box-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (GMT+3)</p>
                        <p class="info-box-value">
                            {% if call_start_time %}
                            {{ to_gmt3(call_start_time).strftime('%d.%m.%Y %H:%M:%S') }}
                            {% elif call_data.start_time %}
                            {{ to_gmt3(call_data.start_time).strftime('%d.%m.%Y %H:%M:%S') }}
                            {% else %}
                            –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ
                            {% endif %}
                        </p>
                    </div>
                    <div class="info-box">
                        <p class="info-box-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</p>
                        <p class="info-box-value">
                            {% if duration_seconds %}
                            {{ '%02d:%02d' % (duration_seconds // 60, duration_seconds % 60) }}
                            {% else %}
                            00:00
                            {% endif %}
                        </p>
                    </div>
                    <div class="info-box">
                        <p class="info-box-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</p>
                        <p class="info-box-value">
                            {% if call_direction == 'incoming' %}
                            üìû‚û°Ô∏è –í—Ö–æ–¥—è—â–∏–π (–∫ –Ω–∞–º)
                            {% elif call_direction == 'outgoing' %}
                            ‚òéÔ∏è‚û°Ô∏èüì± –ò—Å—Ö–æ–¥—è—â–∏–π (–æ—Ç –Ω–∞—Å)
                            {% elif call_direction == 'internal' %}
                            üîÑ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π
                            {% else %}
                            ‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
                            {% endif %}
                        </p>
                    </div>
                    <div class="info-box">
                        <p class="info-box-label">–°—Ç–∞—Ç—É—Å</p>
                        <p class="info-box-value">
                            {% if call_data.call_status == 'ANSWERED' or call_data.call_status == '1' or call_data.call_status == 1 %}
                            <span class="status-success">‚úÖ –û—Ç–≤–µ—á–µ–Ω</span>
                            {% elif call_data.call_status == 'completed' or call_data.call_status == '2' or call_data.call_status == 2 %}
                                {% if call_direction == 'incoming' %}
                                <span class="status-success">‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</span>
                                {% elif call_direction == 'outgoing' %}
                                <span class="status-success">‚úÖ –£—Å–ø–µ—à–Ω—ã–π –∏—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</span>
                                {% else %}
                                <span class="status-success">‚úÖ –£—Å–ø–µ—à–Ω—ã–π –∑–≤–æ–Ω–æ–∫</span>
                                {% endif %}
                            {% elif call_data.call_status == 'NO ANSWER' or call_data.call_status == '0' or call_data.call_status == 0 %}
                            <span class="status-error">‚ùå –ù–µ –æ—Ç–≤–µ—á–µ–Ω</span>
                            {% else %}
                            <span class="status-warning">‚ö†Ô∏è {{ call_data.call_status }}</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- –ë–ª–æ–∫ 2: –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
            <div class="pf-card">
                <h2>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–≤–æ–Ω–∫–∞</h2>
                <div>
                    {% if call_direction == 'incoming' %}
                    <!-- –í—Ö–æ–¥—è—â–∏–π: –ö–ª–∏–µ–Ω—Ç (—Å–≤–µ—Ä—Ö—É) –∑–≤–æ–Ω–∏—Ç –ú–µ–Ω–µ–¥–∂–µ—Ä—É (—Å–Ω–∏–∑—É) -->
                    <div class="participant participant-client">
                        <div class="participant-icon">üí∞</div>
                        <div>
                            <p class="participant-label">–ö–ª–∏–µ–Ω—Ç (–∑–≤–æ–Ω–∏—Ç)</p>
                            <p class="participant-value">
                                {% if client_info.phone %}
                                {{ format_phone(client_info.phone) }}
                                {% endif %}
                                {% if client_info.name and client_info.name != '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' and client_info.name != '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π' %}
                                {{ client_info.name }}
                                {% elif not client_info.phone %}
                                –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="arrow-down">‚¨áÔ∏è</div>
                    <div class="participant participant-manager">
                        <div class="participant-icon">‚òéÔ∏è</div>
                        <div>
                            <p class="participant-label">–ú–µ–Ω–µ–¥–∂–µ—Ä (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç)</p>
                            <p class="participant-value">
                                {% if manager_info.extension %}
                                {{ manager_info.extension }}
                                {% else %}
                                –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                                {% endif %}
                                {% if manager_info.name and manager_info.name != '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' %}
                                {{ manager_info.name }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% elif call_direction == 'internal' %}
                    <!-- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π: –ú–µ–Ω–µ–¥–∂–µ—Ä (—Å–≤–µ—Ä—Ö—É) –∑–≤–æ–Ω–∏—Ç –ú–µ–Ω–µ–¥–∂–µ—Ä—É (—Å–Ω–∏–∑—É) -->
                    <div class="participant participant-manager">
                        <div class="participant-icon">‚òéÔ∏è</div>
                        <div>
                            <p class="participant-label">–ú–µ–Ω–µ–¥–∂–µ—Ä (–∑–≤–æ–Ω–∏—Ç)</p>
                            <p class="participant-value">
                                {% if manager_info.extension %}
                                {{ manager_info.extension }}
                                {% else %}
                                –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                                {% endif %}
                                {% if manager_info.name and manager_info.name != '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' %}
                                {{ manager_info.name }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="arrow-down">‚¨áÔ∏è</div>
                    <div class="participant participant-manager">
                        <div class="participant-icon">‚òéÔ∏è</div>
                        <div>
                            <p class="participant-label">–ú–µ–Ω–µ–¥–∂–µ—Ä (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç)</p>
                            <p class="participant-value">
                                {% if receiver_info.extension %}
                                {{ receiver_info.extension }}
                                {% else %}
                                –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                                {% endif %}
                                {% if receiver_info.name and receiver_info.name != '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' %}
                                {{ receiver_info.name }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% else %}
                    <!-- –ò—Å—Ö–æ–¥—è—â–∏–π: –ú–µ–Ω–µ–¥–∂–µ—Ä (—Å–≤–µ—Ä—Ö—É) –∑–≤–æ–Ω–∏—Ç –ö–ª–∏–µ–Ω—Ç—É (—Å–Ω–∏–∑—É) -->
                    <div class="participant participant-manager">
                        <div class="participant-icon">‚òéÔ∏è</div>
                        <div>
                            <p class="participant-label">–ú–µ–Ω–µ–¥–∂–µ—Ä (–∑–≤–æ–Ω–∏—Ç)</p>
                            <p class="participant-value">
                                {% if manager_info.extension %}
                                {{ manager_info.extension }}
                                {% else %}
                                –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                                {% endif %}
                                {% if manager_info.name and manager_info.name != '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' %}
                                {{ manager_info.name }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="arrow-down">‚¨áÔ∏è</div>
                    <div class="participant participant-client">
                        <div class="participant-icon">üí∞</div>
                        <div>
                            <p class="participant-label">–ö–ª–∏–µ–Ω—Ç (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç)</p>
                            <p class="participant-value">
                                {% if client_info.phone %}
                                {{ format_phone(client_info.phone) }}
                                {% endif %}
                                {% if client_info.name and client_info.name != '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' and client_info.name != '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π' %}
                                {{ client_info.name }}
                                {% elif not client_info.phone %}
                                –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- –ë–ª–æ–∫ 3: Timeline —Å–æ–±—ã—Ç–∏–π -->
            <div class="pf-card">
                <h2>‚è±Ô∏è –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–æ–±—ã—Ç–∏–π –æ—Ç —Ö–æ—Å—Ç–∞</h2>
                <p style="font-size: 30px; color: var(--pf-gray-darkest); margin-bottom: var(--pf-spacing-lg); font-weight: 500;">–ü–æ–∫–∞–∑–∞–Ω—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç Asterisk</p>
                
                {% if call_data.unique_events %}
                {% set shown_tg_types = [] %}
                <div class="timeline">
                    {% for event in call_data.unique_events %}
                    <div class="timeline-item">
                        <div class="timeline-time">
                            {% if event.event_timestamp_dt %}
                            {{ to_gmt3(event.event_timestamp_dt).strftime('%H:%M:%S') }}
                            {% elif event.event_timestamp %}
                            {{ event.event_timestamp.split('T')[1][:8] if 'T' in event.event_timestamp else event.event_timestamp[-8:] }}
                            {% endif %}
                        </div>
                        <div class="timeline-badge">
                            {{ loop.index }}
                        </div>
                        <div class="timeline-content">
                            <p class="timeline-title">
                                {% if event.event_type == 'start' %}
                                üöÄ –ó–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω <span style="color: var(--pf-gray); font-weight: normal;">(start)</span>
                                {% elif event.event_type == 'dial' %}
                                üìû –ù–∞–±–æ—Ä –Ω–æ–º–µ—Ä–∞ <span style="color: var(--pf-gray); font-weight: normal;">(dial)</span>
                                {% elif event.event_type == 'bridge' %}
                                üîó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ <span style="color: var(--pf-gray); font-weight: normal;">(bridge)</span>
                                {% elif event.event_type == 'bridge_create' %}
                                üåâ –°–æ–∑–¥–∞–Ω –º–æ—Å—Ç –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è <span style="color: var(--pf-gray); font-weight: normal;">(bridge_create)</span>
                                {% elif event.event_type == 'bridge_leave' %}
                                üëã –£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –º–æ—Å—Ç <span style="color: var(--pf-gray); font-weight: normal;">(bridge_leave)</span>
                                {% elif event.event_type == 'bridge_destroy' %}
                                üí• –ú–æ—Å—Ç —Ä–∞–∑—Ä—É—à–µ–Ω <span style="color: var(--pf-gray); font-weight: normal;">(bridge_destroy)</span>
                                {% elif event.event_type == 'new_callerid' %}
                                üÜî –û–±–Ω–æ–≤–ª–µ–Ω CallerID <span style="color: var(--pf-gray); font-weight: normal;">(new_callerid)</span>
                                {% elif event.event_type == 'hangup' %}
                                ‚ùå –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω <span style="color: var(--pf-gray); font-weight: normal;">(hangup)</span>
                                {% else %}
                                {{ event.event_type|upper }}
                                {% endif %}
                            </p>
                            {% if event.event_data %}
                            <p class="timeline-subtitle">
                                {% if event.event_type == 'dial' and event.event_data.Phone %}
                                    {% if event.event_data.CallType == 1 %}
                                    {# –ò—Å—Ö–æ–¥—è—â–∏–π: –º–µ–Ω–µ–¥–∂–µ—Ä ‚Üí –∫–ª–∏–µ–Ω—Ç #}
                                    ‚òéÔ∏è {{ event.event_data.Extensions|join(', ') if event.event_data.Extensions else '–ú–µ–Ω–µ–¥–∂–µ—Ä' }} ‚Üí üí∞ {{ format_phone(event.event_data.Phone) }}
                                    {% else %}
                                    {# –í—Ö–æ–¥—è—â–∏–π: –∫–ª–∏–µ–Ω—Ç ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä #}
                                    üí∞ {{ format_phone(event.event_data.Phone) }} ‚Üí ‚òéÔ∏è {{ event.event_data.Extensions|join(', ') if event.event_data.Extensions else '–ú–µ–Ω–µ–¥–∂–µ—Ä' }}
                                    {% endif %}
                                {% elif event.event_type == 'bridge' and event.event_data.CallerIDNum %}
                                –£—á–∞—Å—Ç–Ω–∏–∫: {{ event.event_data.CallerIDName or event.event_data.CallerIDNum }} ({{ format_phone(event.event_data.CallerIDNum) if event.event_data.CallerIDNum|length > 4 else event.event_data.CallerIDNum }})
                                {% elif event.event_type == 'hangup' and event.event_data.CallStatus %}
                                –°—Ç–∞—Ç—É—Å: {{ event.event_data.CallStatus }}
                                {% elif event.event_type == 'new_callerid' and event.event_data.CallerIDNum %}
                                CallerID: {{ format_phone(event.event_data.CallerIDNum) }}
                                {% endif %}
                            </p>
                            {% endif %}
                            
                            <!-- –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏ —Å —ç—Ç–∏–º —Å–æ–±—ã—Ç–∏–µ–º -->
                            <div class="timeline-actions">
                                <p class="timeline-actions-title">üìã –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏:</p>
                                <ul class="action-list">
                                    <li>
                                        <details>
                                            <summary class="cursor-pointer hover:text-blue-700">‚úÖ –°–æ–±—ã—Ç–∏–µ –ø–æ–ª—É—á–µ–Ω–æ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</summary>
                                            {% if event.event_data %}
                                            <div class="mt-2 ml-6 bg-white p-3 rounded border border-gray-300">
                                                <p class="text-xl font-bold text-gray-900 mb-2">–ó–∞–ø—Ä–æ—Å –æ—Ç —Ö–æ—Å—Ç–∞:</p>
                                                <pre class="text-xl font-bold text-gray-900 bg-gray-100 p-3 rounded overflow-x-auto">{{ event.event_data|tojson(indent=2) }}</pre>
                                            </div>
                                            {% endif %}
                                        </details>
                                    </li>
                                    
                                    {% set event_timestamp = event.event_timestamp %}
                                    {% set has_actions = false %}
                                    
                                    {# –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram —Å–æ–æ–±—â–µ–Ω–∏—è - —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ #}
                                    {% if call_data.telegram_messages and event.event_type not in shown_tg_types %}
                                        {% for msg in call_data.telegram_messages %}
                                            {% if msg.message_type == event.event_type %}
                                                {% set has_actions = true %}
                                                {% if event.event_type not in shown_tg_types %}
                                                    {% set _ = shown_tg_types.append(event.event_type) %}
                                                {% endif %}
                                                <li>
                                                    <details>
                                                        <summary class="cursor-pointer hover:text-blue-700">
                                                            üì± Telegram: {{ msg.action or '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' }} —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí 
                                                            <strong>{{ msg.user_name or msg.chat_id }}</strong>
                                                            {% if msg.user_email %}<span class="text-gray-500">({{ msg.user_email }})</span>{% endif %}
                                                        </summary>
                                                        <div class="mt-2 ml-6 bg-white p-3 rounded border border-gray-300">
                                                            <p class="text-sm text-gray-600 mb-2">
                                                                Chat ID: {{ msg.chat_id }} | Message ID: {{ msg.message_id }}
                                                            </p>
                                                            {% if msg.text %}
                                                            <div class="bg-gray-100 p-3 rounded">
                                                                <p class="text-sm font-bold text-gray-700 mb-1">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</p>
                                                                <p class="text-gray-800 whitespace-pre-wrap">{{ msg.text }}</p>
                                                            </div>
                                                            {% else %}
                                                            <p class="text-gray-500 italic">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω</p>
                                                            {% endif %}
                                                        </div>
                                                    </details>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {# HTTP –∑–∞–ø—Ä–æ—Å—ã - –æ–¥–∏–Ω —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–π—Å—è –±–ª–æ–∫ —Å–æ –≤—Å–µ–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ #}
                                    {% if call_data.http_requests and event.event_type == 'dial' and loop.first %}
                                        {% set has_actions = true %}
                                        <li>
                                            <details>
                                                <summary class="cursor-pointer hover:text-blue-700">
                                                    üåê HTTP –∑–∞–ø—Ä–æ—Å—ã ({{ call_data.http_requests|length }})
                                                </summary>
                                                <div class="mt-2 ml-6">
                                                    {% for http in call_data.http_requests %}
                                                    <div class="mb-2 p-2 bg-white rounded border border-gray-200">
                                                        <details>
                                                            <summary class="cursor-pointer text-sm">
                                                                {{ http.method }} {{ http.url }}
                                                                <span class="{% if http.status_code == 200 %}text-green-600{% else %}text-red-600{% endif %}">
                                                                    ({{ http.status_code }})
                                                                </span>
                                                            </summary>
                                                            <div class="mt-2 text-sm">
                                                                <p class="text-gray-600">–ó–∞–ø—Ä–æ—Å: {{ http.request|tojson }}</p>
                                                                <p class="text-gray-800 mt-1">–û—Ç–≤–µ—Ç: {{ http.response|tojson }}</p>
                                                            </div>
                                                        </details>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </details>
                                        </li>
                                    {% endif %}
                                </ul>
                            </div>
                            
                        </div>
                    </div>
                    {% if not loop.last %}
                    <div class="timeline-connector"></div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <p style="color: var(--pf-gray); text-align: center; padding: var(--pf-spacing-xxl) 0; font-size: 26px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ–±—ã—Ç–∏—è—Ö</p>
                {% endif %}
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {{ now().strftime('%d.%m.%Y %H:%M:%S') }}</p>
                <p style="margin-top: 8px;">ü§ñ Call Viewer Service v1.0</p>
            </div>

    </div>

    <script>
        function toggleAccordion(id) {
            const content = document.getElementById(id + '-content');
            const icon = document.getElementById(id + '-icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('active');
                icon.textContent = '‚ñ≤';
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º Timeline –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            // Timeline –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–∫—Ä—ã—Ç—ã
        });
    </script>
</body>
</html>

