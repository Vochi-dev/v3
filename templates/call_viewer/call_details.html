<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –∑–≤–æ–Ω–∫–∞ #{{ unique_id }}</title>
    <style>
        /* ============================================
           PLANFIX UI KIT - CSS VARIABLES
           ============================================ */
        :root {
            /* –¶–≤–µ—Ç–∞ */
            --pf-primary: #6fa92e;
            --pf-primary-dark: #5b951a;
            --pf-blue: #3377C3;
            --pf-success: #30AB50;
            --pf-danger: #d9534f;
            --pf-warning: #f59e0b;
            --pf-gray-darkest: #343434;
            --pf-gray-dark: #666666;
            --pf-gray: #999999;
            --pf-gray-light: #b3b3b3;
            --pf-gray-lighter: #d0d0d0;
            --pf-gray-lightest: #f5f5f5;
            --pf-white: #ffffff;
            
            /* –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
            --pf-font-family: -apple-system, "system-ui", "Segoe UI", roboto, "Helvetica Neue", helvetica, arial, sans-serif;
            --pf-font-size-base: 26px;
            --pf-font-size-large: 30px;
            --pf-font-size-h3: 30px;
            --pf-font-size-h2: 36px;
            --pf-font-size-h1: 48px;
            
            /* –û—Ç—Å—Ç—É–ø—ã */
            --pf-spacing-sm: 8px;
            --pf-spacing-md: 12px;
            --pf-spacing-lg: 16px;
            --pf-spacing-xl: 20px;
            --pf-spacing-xxl: 24px;
            
            /* –¢–µ–Ω–∏ */
            --pf-shadow-md: 0 1px 3px rgba(0, 0, 0, 0.1);
            
            /* –ü–µ—Ä–µ—Ö–æ–¥—ã */
            --pf-transition-base: 0.2s ease;
        }
        
        /* ============================================
           –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò
           ============================================ */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--pf-font-family);
            font-size: var(--pf-font-size-base);
            color: var(--pf-gray-darkest);
            line-height: 1.5;
            margin: 0;
            padding: 0;
            background-color: var(--pf-gray-lightest);
        }
        
        /* ============================================
           –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê
           ============================================ */
        h1 {
            font-size: var(--pf-font-size-h1);
            font-weight: 600;
            color: var(--pf-gray-darkest);
            margin: 0 0 var(--pf-spacing-md) 0;
        }
        
        h2 {
            font-size: var(--pf-font-size-h2);
            font-weight: 600;
            color: var(--pf-gray-darkest);
            margin: 0 0 var(--pf-spacing-lg) 0;
            padding-bottom: var(--pf-spacing-md);
            border-bottom: 2px solid var(--pf-primary);
        }
        
        /* ============================================
           –ö–ê–†–¢–û–ß–ö–ò
           ============================================ */
        .pf-card {
            background-color: var(--pf-white);
            border-radius: 4px;
            padding: var(--pf-spacing-xxl);
            box-shadow: var(--pf-shadow-md);
            margin-bottom: var(--pf-spacing-xxl);
        }
        
        /* ============================================
           –ö–ù–û–ü–ö–ò
           ============================================ */
        .pf-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            font-size: var(--pf-font-size-base);
            font-weight: 400;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all var(--pf-transition-base);
            text-decoration: none;
        }
        
        .pf-btn-primary {
            background-color: var(--pf-primary);
            color: var(--pf-white);
        }
        
        .pf-btn-primary:hover {
            background-color: var(--pf-primary-dark);
        }
        
        /* ============================================
           –°–¢–ê–¢–£–°–´
           ============================================ */
        .status-success { color: var(--pf-success); }
        .status-error { color: var(--pf-danger); }
        .status-warning { color: var(--pf-warning); }
        .status-info { color: var(--pf-blue); }
        
        /* ============================================
           GRID & LAYOUT
           ============================================ */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: var(--pf-spacing-xxl);
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--pf-spacing-lg);
        }
        
        .info-box {
            background-color: var(--pf-gray-lightest);
            padding: var(--pf-spacing-lg);
            border-radius: 4px;
        }
        
        .info-box-label {
            font-size: 24px;
            color: var(--pf-gray-dark);
            margin-bottom: 4px;
        }
        
        .info-box-value {
            font-size: 36px;
            font-weight: 600;
            color: var(--pf-gray-darkest);
        }
        
        /* ============================================
           –£–ß–ê–°–¢–ù–ò–ö–ò
           ============================================ */
        .participant {
            display: flex;
            align-items: center;
            gap: var(--pf-spacing-lg);
            padding: var(--pf-spacing-lg);
            border-radius: 4px;
            margin-bottom: var(--pf-spacing-md);
        }
        
        .participant-manager {
            background-color: #fef2f2;
        }
        
        .participant-client {
            background-color: #f0fdf4;
        }
        
        .participant-icon {
            font-size: 64px;
        }
        
        .participant-label {
            font-size: 24px;
            color: var(--pf-gray-dark);
        }
        
        .participant-value {
            font-size: 36px;
            font-weight: 600;
            color: var(--pf-gray-darkest);
        }
        
        .arrow-down {
            text-align: center;
            font-size: 48px;
            margin: var(--pf-spacing-md) 0;
        }
        
        /* ============================================
           TIMELINE
           ============================================ */
        .timeline {
            position: relative;
        }
        
        .timeline-item {
            display: flex;
            gap: var(--pf-spacing-lg);
            margin-bottom: var(--pf-spacing-xl);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .timeline-time {
            flex-shrink: 0;
            width: 160px;
            font-size: 30px;
            font-weight: 600;
            color: var(--pf-gray-darkest);
        }
        
        .timeline-badge {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            background-color: var(--pf-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--pf-white);
            font-weight: 600;
            font-size: 30px;
            box-shadow: var(--pf-shadow-md);
        }
        
        .timeline-content {
            flex: 1;
            background-color: var(--pf-gray-lightest);
            padding: var(--pf-spacing-lg);
            border-radius: 4px;
        }
        
        .timeline-title {
            font-size: var(--pf-font-size-large);
            font-weight: 600;
            margin-bottom: var(--pf-spacing-sm);
        }
        
        .timeline-subtitle {
            font-size: var(--pf-font-size-large);
            font-weight: 600;
            color: var(--pf-gray-darkest);
            margin-bottom: var(--pf-spacing-sm);
        }
        
        .timeline-actions {
            margin-top: var(--pf-spacing-lg);
            padding-left: var(--pf-spacing-lg);
            border-left: 4px solid var(--pf-primary);
            background-color: rgba(111, 169, 46, 0.05);
            padding: var(--pf-spacing-md);
            border-radius: 4px;
        }
        
        .timeline-actions-title {
            font-size: var(--pf-font-size-large);
            font-weight: 600;
            color: var(--pf-primary-dark);
            margin-bottom: var(--pf-spacing-sm);
        }
        
        .timeline-connector {
            margin-left: 220px;
            border-left: 2px solid var(--pf-gray-lighter);
            height: 48px;
        }
        
        /* ============================================
           ACCORDION
           ============================================ */
        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--pf-spacing-lg);
        }
        
        .accordion-toggle {
            color: var(--pf-blue);
            cursor: pointer;
            font-size: var(--pf-font-size-base);
            background: none;
            border: none;
            padding: 4px 8px;
        }
        
        .accordion-toggle:hover {
            text-decoration: underline;
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .accordion-content.active {
            max-height: 5000px;
        }
        
        /* ============================================
           DETAILS & CODE
           ============================================ */
        details {
            margin-top: var(--pf-spacing-sm);
        }
        
        summary {
            cursor: pointer;
            font-size: var(--pf-font-size-base);
            color: var(--pf-blue);
            padding: 4px 0;
        }
        
        summary:hover {
            text-decoration: underline;
        }
        
        pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: var(--pf-spacing-md);
            border-radius: 4px;
            overflow-x: auto;
            font-size: 24px;
            margin: var(--pf-spacing-sm) 0;
        }
        
        /* ============================================
           LISTS
           ============================================ */
        .action-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .action-list li {
            font-size: var(--pf-font-size-large);
            font-weight: 600;
            color: var(--pf-gray-darkest);
            margin-bottom: var(--pf-spacing-sm);
        }
        
        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .timeline-time {
                width: 120px;
                font-size: 26px;
            }
            
            .timeline-badge {
                width: 64px;
                height: 64px;
                font-size: 26px;
            }
            
            .container {
                padding: var(--pf-spacing-md);
            }
        }
        
        /* ============================================
           HEADER
           ============================================ */
        .header-flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-subtitle {
            color: var(--pf-gray-dark);
            font-size: var(--pf-font-size-base);
        }
        
        /* ============================================
           FOOTER
           ============================================ */
        .footer {
            text-align: center;
            color: var(--pf-gray);
            font-size: 24px;
            margin-top: var(--pf-spacing-xxl);
        }
    </style>
</head>
<body>
    <div class="container">
            
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="pf-card">
                <div class="header-flex">
                    <div>
                        <h1>üìû –î–µ—Ç–∞–ª–∏ –∑–≤–æ–Ω–∫–∞</h1>
                        <p class="header-subtitle">
                            –ó–≤–æ–Ω–æ–∫ #{{ unique_id[:15] }}... 
                            {% if enterprise_info %}
                            | üè¢ {{ enterprise_info.name }} ({{ enterprise_number }})
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <button onclick="window.print()" class="pf-btn pf-btn-primary">
                            üñ®Ô∏è –ü–µ—á–∞—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ë–ª–æ–∫ 1: –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="pf-card">
                <h2>üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                <div class="grid-2">
                    <div class="info-box">
                        <p class="info-box-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (GMT+3)</p>
                        <p class="info-box-value">
                            {% if call_start_time %}
                            {{ to_gmt3(call_start_time).strftime('%d.%m.%Y %H:%M:%S') }}
                            {% elif call_data.start_time %}
                            {{ to_gmt3(call_data.start_time).strftime('%d.%m.%Y %H:%M:%S') }}
                            {% else %}
                            –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ
                            {% endif %}
                        </p>
                    </div>
                    <div class="info-box">
                        <p class="info-box-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</p>
                        <p class="info-box-value">
                            {% if duration_seconds %}
                            {{ '%02d:%02d' % (duration_seconds // 60, duration_seconds % 60) }}
                            {% else %}
                            00:00
                            {% endif %}
                        </p>
                    </div>
                    <div class="info-box">
                        <p class="info-box-label">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</p>
                        <p class="info-box-value">
                            {% if call_direction == 'incoming' %}
                            üìû‚û°Ô∏è –í—Ö–æ–¥—è—â–∏–π (–∫ –Ω–∞–º)
                            {% elif call_direction == 'outgoing' %}
                            ‚òéÔ∏è‚û°Ô∏èüì± –ò—Å—Ö–æ–¥—è—â–∏–π (–æ—Ç –Ω–∞—Å)
                            {% elif call_direction == 'internal' %}
                            üîÑ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π
                            {% else %}
                            ‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
                            {% endif %}
                        </p>
                    </div>
                    <div class="info-box">
                        <p class="info-box-label">–°—Ç–∞—Ç—É—Å</p>
                        <p class="info-box-value">
                            {% if call_data.call_status == 'ANSWERED' or call_data.call_status == '1' or call_data.call_status == 1 %}
                            <span class="status-success">‚úÖ –û—Ç–≤–µ—á–µ–Ω</span>
                            {% elif call_data.call_status == 'completed' or call_data.call_status == '2' or call_data.call_status == 2 %}
                            <span class="status-success">‚úÖ –£—Å–ø–µ—à–Ω—ã–π –∏—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</span>
                            {% elif call_data.call_status == 'NO ANSWER' or call_data.call_status == '0' or call_data.call_status == 0 %}
                            <span class="status-error">‚ùå –ù–µ –æ—Ç–≤–µ—á–µ–Ω</span>
                            {% else %}
                            <span class="status-warning">‚ö†Ô∏è {{ call_data.call_status }}</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- –ë–ª–æ–∫ 2: –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
            <div class="pf-card">
                <h2>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–≤–æ–Ω–∫–∞</h2>
                <div>
                    <!-- –ú–µ–Ω–µ–¥–∂–µ—Ä (—Å–≤–µ—Ä—Ö—É –¥–ª—è –∏—Å—Ö–æ–¥—è—â–µ–≥–æ) -->
                    <div class="participant participant-manager">
                        <div class="participant-icon">‚òéÔ∏è</div>
                        <div>
                            <p class="participant-label">–ú–µ–Ω–µ–¥–∂–µ—Ä</p>
                            <p class="participant-value">
                                {% if manager_info.extension %}
                                {{ manager_info.extension }}
                                {% else %}
                                –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                                {% endif %}
                                {% if manager_info.name and manager_info.name != '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' %}
                                {{ manager_info.name }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <!-- –°—Ç—Ä–µ–ª–∫–∞ –≤–Ω–∏–∑ (–æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫ –∫–ª–∏–µ–Ω—Ç—É) -->
                    <div class="arrow-down">‚¨áÔ∏è</div>
                    <!-- –ö–ª–∏–µ–Ω—Ç (—Å–Ω–∏–∑—É) -->
                    <div class="participant participant-client">
                        <div class="participant-icon">üí∞</div>
                        <div>
                            <p class="participant-label">–ö–ª–∏–µ–Ω—Ç</p>
                            <p class="participant-value">
                                {% if client_info.phone %}
                                {{ format_phone(client_info.phone) }}
                                {% endif %}
                                {% if client_info.name and client_info.name != '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' %}
                                {{ client_info.name }}
                                {% else %}
                                –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ë–ª–æ–∫ 3: Timeline —Å–æ–±—ã—Ç–∏–π -->
            <div class="pf-card">
                <h2>‚è±Ô∏è –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–æ–±—ã—Ç–∏–π –æ—Ç —Ö–æ—Å—Ç–∞</h2>
                <p style="font-size: 30px; color: var(--pf-gray-darkest); margin-bottom: var(--pf-spacing-lg); font-weight: 500;">–ü–æ–∫–∞–∑–∞–Ω—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç Asterisk</p>
                
                {% if call_data.unique_events %}
                <div class="timeline">
                    {% for event in call_data.unique_events %}
                    <div class="timeline-item">
                        <div class="timeline-time">
                            {% if event.event_timestamp_dt %}
                            {{ to_gmt3(event.event_timestamp_dt).strftime('%H:%M:%S') }}
                            {% elif event.event_timestamp %}
                            {{ event.event_timestamp.split('T')[1][:8] if 'T' in event.event_timestamp else event.event_timestamp[-8:] }}
                            {% endif %}
                        </div>
                        <div class="timeline-badge">
                            {{ loop.index }}
                        </div>
                        <div class="timeline-content">
                            <p class="timeline-title">
                                {% if event.event_type == 'start' %}
                                üöÄ –ó–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω
                                {% elif event.event_type == 'dial' %}
                                üìû –ù–∞–±–æ—Ä –Ω–æ–º–µ—Ä–∞
                                {% elif event.event_type == 'bridge' %}
                                üîó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                                {% elif event.event_type == 'bridge_create' %}
                                üåâ –°–æ–∑–¥–∞–Ω –º–æ—Å—Ç –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                                {% elif event.event_type == 'bridge_leave' %}
                                üëã –£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –º–æ—Å—Ç
                                {% elif event.event_type == 'bridge_destroy' %}
                                üí• –ú–æ—Å—Ç —Ä–∞–∑—Ä—É—à–µ–Ω
                                {% elif event.event_type == 'new_callerid' %}
                                üÜî –û–±–Ω–æ–≤–ª–µ–Ω CallerID
                                {% elif event.event_type == 'hangup' %}
                                ‚ùå –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω
                                {% else %}
                                {{ event.event_type|upper }}
                                {% endif %}
                            </p>
                            {% if event.event_data %}
                            <p class="timeline-subtitle">
                                {% if event.event_type == 'dial' and event.event_data.Phone %}
                                    {% if event.event_data.CallType == 1 %}
                                    {# –ò—Å—Ö–æ–¥—è—â–∏–π: –º–µ–Ω–µ–¥–∂–µ—Ä ‚Üí –∫–ª–∏–µ–Ω—Ç #}
                                    ‚òéÔ∏è {{ event.event_data.Extensions|join(', ') if event.event_data.Extensions else '–ú–µ–Ω–µ–¥–∂–µ—Ä' }} ‚Üí üí∞ {{ format_phone(event.event_data.Phone) }}
                                    {% else %}
                                    {# –í—Ö–æ–¥—è—â–∏–π: –∫–ª–∏–µ–Ω—Ç ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä #}
                                    üí∞ {{ format_phone(event.event_data.Phone) }} ‚Üí ‚òéÔ∏è {{ event.event_data.Extensions|join(', ') if event.event_data.Extensions else '–ú–µ–Ω–µ–¥–∂–µ—Ä' }}
                                    {% endif %}
                                {% elif event.event_type == 'bridge' and event.event_data.CallerIDNum %}
                                –£—á–∞—Å—Ç–Ω–∏–∫: {{ event.event_data.CallerIDName or event.event_data.CallerIDNum }} ({{ format_phone(event.event_data.CallerIDNum) if event.event_data.CallerIDNum|length > 4 else event.event_data.CallerIDNum }})
                                {% elif event.event_type == 'hangup' and event.event_data.CallStatus %}
                                –°—Ç–∞—Ç—É—Å: {{ event.event_data.CallStatus }}
                                {% elif event.event_type == 'new_callerid' and event.event_data.CallerIDNum %}
                                CallerID: {{ format_phone(event.event_data.CallerIDNum) }}
                                {% endif %}
                            </p>
                            {% endif %}
                            
                            <!-- –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏ —Å —ç—Ç–∏–º —Å–æ–±—ã—Ç–∏–µ–º -->
                            <div class="timeline-actions">
                                <p class="timeline-actions-title">üìã –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏:</p>
                                <ul class="action-list">
                                    <li>
                                        <details>
                                            <summary class="cursor-pointer hover:text-blue-700">‚úÖ –°–æ–±—ã—Ç–∏–µ –ø–æ–ª—É—á–µ–Ω–æ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</summary>
                                            {% if event.event_data %}
                                            <div class="mt-2 ml-6 bg-white p-3 rounded border border-gray-300">
                                                <p class="text-xl font-bold text-gray-900 mb-2">–ó–∞–ø—Ä–æ—Å –æ—Ç —Ö–æ—Å—Ç–∞:</p>
                                                <pre class="text-xl font-bold text-gray-900 bg-gray-100 p-3 rounded overflow-x-auto">{{ event.event_data|tojson(indent=2) }}</pre>
                                            </div>
                                            {% endif %}
                                        </details>
                                    </li>
                                    
                                    {% set event_timestamp = event.event_timestamp %}
                                    {% set has_actions = false %}
                                    
                                    {# –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTP –∑–∞–ø—Ä–æ—Å—ã - –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ #}
                                    {% if call_data.http_requests %}
                                        {% set seen_http = {} %}
                                        {% for req in call_data.http_requests %}
                                            {% if req.timestamp and event_timestamp and 
                                                 (req.timestamp[:19] == event_timestamp[:19] or 
                                                  (req.timestamp[:16] == event_timestamp[:16])) %}
                                                {% set req_key = req.method ~ '|' ~ req.url %}
                                                {% if req_key not in seen_http %}
                                                    {% set _ = seen_http.update({req_key: req}) %}
                                                    {% set has_actions = true %}
                                                    <li>
                                                        <details>
                                                            <summary class="cursor-pointer hover:text-blue-700">
                                                                üåê HTTP: {{ req.method }} ‚Üí {{ req.url }}
                                                                {% if req.status_code %}
                                                                <span class="{% if req.status_code == 200 %}text-green-600{% else %}text-red-600{% endif %}">
                                                                    ({{ req.status_code }})
                                                                </span>
                                                                {% endif %}
                                                            </summary>
                                                            <div class="mt-2 ml-6 bg-white p-3 rounded border border-gray-300">
                                                                {% if req.request_body %}
                                                                <p class="text-xl font-bold text-gray-900 mb-1">–ó–∞–ø—Ä–æ—Å:</p>
                                                                <pre class="text-xl font-bold text-gray-900 bg-gray-100 p-2 rounded overflow-x-auto mb-3">{{ req.request_body|tojson(indent=2) if req.request_body is not string else req.request_body }}</pre>
                                                                {% endif %}
                                                                {% if req.response_data %}
                                                                <p class="text-xl font-bold text-gray-900 mb-1">–û—Ç–≤–µ—Ç:</p>
                                                                <pre class="text-xl font-bold text-gray-900 bg-gray-100 p-2 rounded overflow-x-auto">{{ req.response_data|tojson(indent=2) if req.response_data is not string else req.response_data }}</pre>
                                                                {% endif %}
                                                            </div>
                                                        </details>
                                                    </li>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {# –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram —Å–æ–æ–±—â–µ–Ω–∏—è - –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ chat_id #}
                                    {% if call_data.telegram_messages %}
                                        {% set seen_tg_chats = [] %}
                                        {% for msg in call_data.telegram_messages %}
                                            {% if msg.timestamp and event_timestamp and 
                                                 (msg.timestamp[:19] == event_timestamp[:19] or 
                                                  (msg.timestamp[:16] == event_timestamp[:16])) %}
                                                {% if msg.chat_id not in seen_tg_chats %}
                                                    {% set _ = seen_tg_chats.append(msg.chat_id) %}
                                                    {% set has_actions = true %}
                                                    <li>üì± Telegram: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (chat_id: {{ msg.chat_id }})</li>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {# –ü—Ä–æ–≤–µ—Ä—è–µ–º SQL –∑–∞–ø—Ä–æ—Å—ã #}
                                    {% if call_data.sql_queries %}
                                        {% for sql in call_data.sql_queries %}
                                            {% if sql.timestamp and event_timestamp and 
                                                 (sql.timestamp[:19] == event_timestamp[:19] or 
                                                  (sql.timestamp[:16] == event_timestamp[:16])) %}
                                                {% set has_actions = true %}
                                                <li>üíæ SQL: {{ sql.query[:50] }}...</li>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ #}
                                    {% if call_data.integration_responses %}
                                        {% for integ in call_data.integration_responses %}
                                            {% if integ.timestamp and event_timestamp and 
                                                 (integ.timestamp[:19] == event_timestamp[:19] or 
                                                  (integ.timestamp[:16] == event_timestamp[:16])) %}
                                                {% set has_actions = true %}
                                                <li>üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: {{ integ.integration_name }}</li>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </ul>
                            </div>
                            
                            {% if event.event_data %}
                            <details class="mt-2">
                                <summary class="cursor-pointer text-sm text-blue-600 hover:text-blue-800">
                                    –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è
                                </summary>
                                <pre class="mt-2 text-xs bg-gray-100 p-2 rounded">{{ event.event_data|tojson(indent=2) }}</pre>
                            </details>
                            {% endif %}
                        </div>
                    </div>
                    {% if not loop.last %}
                    <div class="timeline-connector"></div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <p style="color: var(--pf-gray); text-align: center; padding: var(--pf-spacing-xxl) 0; font-size: 26px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ–±—ã—Ç–∏—è—Ö</p>
                {% endif %}
            </div>

            <!-- –ë–ª–æ–∫ 4: Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
            <div class="pf-card">
                <div class="accordion-header">
                    <h2>üì± Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                    <button onclick="toggleAccordion('telegram')" class="accordion-toggle">
                        <span id="telegram-icon">‚ñº</span> –ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å
                    </button>
                </div>
                
                <div id="telegram-content" class="accordion-content">
                    {% if call_data.telegram_messages %}
                    <div class="space-y-4">
                        {% for msg in call_data.telegram_messages %}
                        <div class="border-l-4 border-blue-500 pl-4 py-2 bg-blue-50 rounded">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-600">
                                    Chat ID: {{ msg.chat_id }} | Message ID: {{ msg.message_id }}
                                </span>
                                <span class="text-xs text-gray-500">{{ msg.sent_at }}</span>
                            </div>
                            <p class="text-gray-800">{{ msg.message_text }}</p>
                            {% if msg.has_buttons %}
                            <p class="text-xs text-gray-600 mt-2">üîò –° –∫–Ω–æ–ø–∫–∞–º–∏</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <p class="mt-4 text-sm text-gray-600">
                        –í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: <strong>{{ call_data.telegram_messages|length }}</strong> —Å–æ–æ–±—â–µ–Ω–∏–π
                    </p>
                    {% else %}
                    <p class="text-gray-500 text-center py-4">–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                    {% endif %}
                </div>
            </div>

            <!-- –ë–ª–æ–∫ 5: SQL –∑–∞–ø—Ä–æ—Å—ã -->
            <div class="pf-card">
                <div class="accordion-header">
                    <h2>üíæ –ó–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</h2>
                    <button onclick="toggleAccordion('sql')" class="accordion-toggle">
                        <span id="sql-icon">‚ñº</span> –ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å
                    </button>
                </div>
                
                <div id="sql-content" class="accordion-content">
                    {% if call_data.sql_queries %}
                    <div class="space-y-4">
                        {% for query in call_data.sql_queries %}
                        <div class="border-l-4 border-purple-500 pl-4 py-2 bg-purple-50 rounded">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold">{{ query.query_type or 'SQL' }}</span>
                                <span class="text-xs">
                                    ‚è±Ô∏è {{ query.execution_time_ms }}ms
                                    {% if query.success %}
                                    <span class="status-success">‚úÖ</span>
                                    {% else %}
                                    <span class="status-error">‚ùå</span>
                                    {% endif %}
                                </span>
                            </div>
                            <details>
                                <summary class="cursor-pointer text-sm text-purple-600 hover:text-purple-800">
                                    –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–ø—Ä–æ—Å
                                </summary>
                                <pre class="mt-2 text-xs">{{ query.query_text }}</pre>
                            </details>
                        </div>
                        {% endfor %}
                    </div>
                    <p class="mt-4 text-sm text-gray-600">
                        –í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: <strong>{{ call_data.sql_queries|length }}</strong> –∑–∞–ø—Ä–æ—Å–æ–≤
                    </p>
                    {% else %}
                    <p class="text-gray-500 text-center py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö</p>
                    {% endif %}
                </div>
            </div>

            <!-- –ë–ª–æ–∫ 6: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ -->
            <div class="pf-card">
                <div class="accordion-header">
                    <h2>üîó –ó–∞–ø—Ä–æ—Å—ã –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º</h2>
                    <button onclick="toggleAccordion('integrations')" class="accordion-toggle">
                        <span id="integrations-icon">‚ñº</span> –ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å
                    </button>
                </div>
                
                <div id="integrations-content" class="accordion-content">
                    {% if call_data.integration_responses %}
                    <div class="space-y-4">
                        {% for integration in call_data.integration_responses %}
                        <div class="border-l-4 border-green-500 pl-4 py-2 bg-green-50 rounded">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold">
                                    {{ integration.integration_name or '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è' }}
                                </span>
                                <span class="text-xs">
                                    ‚è±Ô∏è {{ integration.response_time_ms }}ms
                                    {% if integration.status_code == 200 %}
                                    <span class="status-success">‚úÖ {{ integration.status_code }}</span>
                                    {% else %}
                                    <span class="status-error">‚ùå {{ integration.status_code }}</span>
                                    {% endif %}
                                </span>
                            </div>
                            <p class="text-sm text-gray-700 mb-2">
                                {{ integration.method }} {{ integration.url }}
                            </p>
                            <details>
                                <summary class="cursor-pointer text-sm text-green-600 hover:text-green-800">
                                    –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç
                                </summary>
                                <div class="mt-2 space-y-2">
                                    <div>
                                        <p class="text-xs font-semibold mb-1">–ó–∞–ø—Ä–æ—Å:</p>
                                        <pre class="text-xs">{{ integration.request_body|default('N/A')|tojson(indent=2) if integration.request_body else 'N/A' }}</pre>
                                    </div>
                                    <div>
                                        <p class="text-xs font-semibold mb-1">–û—Ç–≤–µ—Ç:</p>
                                        <pre class="text-xs">{{ integration.response_body|default('N/A')|tojson(indent=2) if integration.response_body else 'N/A' }}</pre>
                                    </div>
                                </div>
                            </details>
                        </div>
                        {% endfor %}
                    </div>
                    <p class="mt-4 text-sm text-gray-600">
                        –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: <strong>{{ call_data.integration_responses|length }}</strong>
                    </p>
                    {% else %}
                    <p class="text-gray-500 text-center py-4">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º</p>
                    {% endif %}
                </div>
            </div>

            <!-- –ë–ª–æ–∫ 7: HTTP –∑–∞–ø—Ä–æ—Å—ã -->
            <div class="pf-card">
                <div class="accordion-header">
                    <h2>üåê HTTP –∑–∞–ø—Ä–æ—Å—ã</h2>
                    <button onclick="toggleAccordion('http')" class="accordion-toggle">
                        <span id="http-icon">‚ñº</span> –ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å
                    </button>
                </div>
                
                <div id="http-content" class="accordion-content">
                    {% if call_data.http_requests %}
                    <div class="space-y-4">
                        {% for req in call_data.http_requests %}
                        <div class="border-l-4 border-orange-500 pl-4 py-2 bg-orange-50 rounded">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold">{{ req.method }} {{ req.url }}</span>
                                <span class="text-xs">
                                    ‚è±Ô∏è {{ req.duration_ms|default('N/A') }}ms
                                    {% if req.status_code is defined and req.status_code is number %}
                                        {% if req.status_code >= 200 and req.status_code < 300 %}
                                        <span class="status-success">‚úÖ {{ req.status_code }}</span>
                                        {% else %}
                                        <span class="status-error">‚ùå {{ req.status_code }}</span>
                                        {% endif %}
                                    {% elif req.status_code is defined %}
                                        <span class="text-gray-500">{{ req.status_code }}</span>
                                    {% endif %}
                                </span>
                            </div>
                            <details>
                                <summary class="cursor-pointer text-sm text-orange-600 hover:text-orange-800">
                                    –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏
                                </summary>
                                <pre class="mt-2 text-xs">{{ req|tojson(indent=2) }}</pre>
                            </details>
                        </div>
                        {% endfor %}
                    </div>
                    <p class="mt-4 text-sm text-gray-600">
                        –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: <strong>{{ call_data.http_requests|length }}</strong>
                    </p>
                    {% else %}
                    <p class="text-gray-500 text-center py-4">–ù–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å–æ–≤</p>
                    {% endif %}
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {{ now().strftime('%d.%m.%Y %H:%M:%S') }}</p>
                <p style="margin-top: 8px;">ü§ñ Call Viewer Service v1.0</p>
            </div>

    </div>

    <script>
        function toggleAccordion(id) {
            const content = document.getElementById(id + '-content');
            const icon = document.getElementById(id + '-icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('active');
                icon.textContent = '‚ñ≤';
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º Timeline –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            // Timeline –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–∫—Ä—ã—Ç—ã
        });
    </script>
</body>
</html>

