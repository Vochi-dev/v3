<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ enterprise.name }} admin</title>
  <!-- Favicon and App Icons -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/static/apple-touch-icon.png">
  <link rel="manifest" href="/static/site.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <meta name="msapplication-TileColor" content="#2563eb">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/20.3.0/css/intlTelInput.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 0; }
        .header { display: flex; align-items: center; background-color: #343a40; color: white; padding: 0.5rem 1rem; border-bottom: 1px solid #ddd; }
        .header img { height: 32px; margin-right: 15px; }
        .header h1 { font-size: 1.1rem; margin: 0; font-weight: 400; color: rgba(255, 255, 255, 0.85); }
        .container { padding: 2rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 1200px; border-radius: 8px; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; margin-left: 25px; }
        .table-container { margin-top: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
        th { background-color: #f2f2f2; }
        .gsm-table td a { color: blue; text-decoration: none; }
        .gsm-table td a:hover { text-decoration: underline; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #dee2e6; margin-bottom: 1rem; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; }
        .btn { background-color: #007bff; color: white; border: none; padding: 10px 20px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin-bottom: 1rem; cursor: pointer; border-radius: 5px; }
        .btn:hover { background-color: #0056b3; }
        .btn-primary { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .btn-secondary { background-color: #6c757d; padding: 10px 20px; }
        .btn-danger { background-color: #dc3545; padding: 10px 20px; }
        .btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 4px; margin-bottom: 0; }
        .password-wrapper { position: relative; display: flex; }
        .password-wrapper input { flex-grow: 1; padding-right: 40px; }
        .password-wrapper .copy-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); cursor: pointer; border: none; background: transparent; font-size: 1.2rem; padding: 5px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: .5rem; }
        .form-group input, .form-group select { width: 100%; padding: .5rem; box-sizing: border-box; }
        .form-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; }
        .modal-content.modal-narrow { max-width: 400px; }
        /* --- Стили для таблицы GSM-линий в модалке --- */
        .gsm-table-container { max-height: 70vh; overflow-y: auto; }
        .gsm-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .gsm-table th, .gsm-table td { border: 1px solid #ddd; padding: 6px; text-align: left; white-space: nowrap; }
        .gsm-table th { background-color: #f2f2f2; position: sticky; top: 0; z-index: 1; }
        .edit-trigger { color: #007bff; text-decoration: none; cursor: pointer; }
        .edit-trigger:hover { text-decoration: underline; }
        .table-secondary { background: #f8f9fa; font-weight: bold; }

        .mobile-number-row td {
            background-color: #e7f5fe; /* Светло-голубой */
        }

        .user-group-end td {
            border-bottom: 2px solid #495057; /* Темная, толстая линия */
        }

        .user-group-end-cell {
            border-bottom: 2px solid #495057; /* Темная, толстая линия для ячеек с rowspan */
        }

        .no-schema-row {
            background-color: #f0f0f0; /* Светло-серый фон */
        }

        /* --- Стили для таблицы аудиофайлов --- */
        .audio-files-container { display: flex; flex-direction: column; }
        .audio-files-header, .audio-file-row {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 5px;
            align-items: center;
            padding: 5px;
        }
        .audio-files-header {
            font-weight: 500;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 5px;
        }
        .audio-file-row {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 4px;
        }
        .audio-file-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .audio-player-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .audio-player-container audio {
            height: 32px;
            max-width: 250px;
        }
        .file-type-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
            text-align: center;
            display: inline-block;
        }
        .file-type-start { background-color: #007bff; }
        .file-type-hold { background-color: #fd7e14; }
        .used-in-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            text-align: center;
            display: inline-block;
        }
        .audio-actions .dropdown { position: relative; display: inline-block; }
        .audio-actions .menu-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d; }
        .audio-actions .dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 120px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 4px; right: 0; border: 1px solid #ddd; }
        .audio-actions .dropdown-content a { color: black; padding: 10px 14px; text-decoration: none; display: block; font-size: 0.9em; }
        .audio-actions .dropdown-content a:hover { background-color: #f1f1f1; }
        .audio-actions .dropdown:hover .dropdown-content { display: block; }

        /* Стили для мониторинга GSM линий */
        .gsm-table th:nth-child(1),
        .gsm-table td:nth-child(1) {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        
        /* Стили для столбца IP */
        .gsm-table th:nth-child(2),
        .gsm-table td:nth-child(2) {
            width: 130px;
            min-width: 130px;
            max-width: 130px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        
        /* Стили для столбца ID2 */
        .gsm-table th:nth-child(3),
        .gsm-table td:nth-child(3) {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        
        /* Стили для столбца Номер */
        .gsm-table th:nth-child(4),
        .gsm-table td:nth-child(4) {
            width: 150px;
            min-width: 150px;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        
        /* Стили для столбца Пр (Префикс) */
        .gsm-table th:nth-child(6),
        .gsm-table td:nth-child(6) {
            width: 40px;
            min-width: 40px;
            max-width: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        
        /* Стили для столбца Оператор */
        .gsm-table th:nth-child(9),
        .gsm-table td:nth-child(9) {
            width: 100px;
            min-width: 100px;
            max-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        
        /* Стили для столбца Ур (Уровень) */
        .gsm-table th:nth-child(10),
        .gsm-table td:nth-child(10) {
            width: 40px;
            min-width: 40px;
            max-width: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        
        /* Стили для столбца Сл (Слот) */
        .gsm-table th:nth-child(11),
        .gsm-table td:nth-child(11) {
            width: 40px;
            min-width: 40px;
            max-width: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        
        /* Стили для столбца Переадресация */
        .gsm-table th:nth-child(12),
        .gsm-table td:nth-child(12) {
            width: 180px;
            min-width: 180px;
            max-width: 180px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }
        
        .ip-online {
            color: #28a745;
            font-weight: 500;
        }
        
        .ip-offline {
            color: #6c757d;
            font-style: italic;
        }
        
        .slot-loading {
            animation: slot-pulse 1.5s ease-in-out infinite;
            color: #6c757d;
        }
        
        @keyframes slot-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Стили для модального окна схем */
        .schema-modal-content {
            background-color: #fefefe;
            margin: 2% auto; /* Более высокое расположение */
            padding: 0; /* Убираем паддинг, чтобы iframe прилегал к краям */
            border: 1px solid #888;
            width: 95%; /* Шире */
            max-width: 1400px;
            height: 90vh; /* Высокое */
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }
        .schema-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #f1f1f1;
            border-bottom: 1px solid #ddd;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .schema-modal-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        .schema-modal-body {
            flex-grow: 1;
            overflow: hidden; /* Убираем скролл с тела модалки */
        }
        .schema-modal-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="/static/logo.jpg" alt="Логотип">
        <h1>{{ enterprise.number }}-{{ enterprise.name }} Панель администратора
        {% if user and user.first_name and user.last_name %}
        | {{ user.last_name }} {{ user.first_name }}
        {% endif %}
        </h1>
    </div>
    <div class="container">
        <a href="/dial/?enterprise={{ enterprise.number }}" class="btn btn-primary">Входящие схемы</a>
        <a href="/dial/?enterprise={{ enterprise.number }}&type=outgoing" class="btn btn-primary">Исходящие схемы</a>
        <button class="btn btn-primary" type="button" data-action="show-users">Пользователи</button>
        <button class="btn btn-success" type="button" id="btn-gsm-lines">GSM-линии</button>
        <button class="btn btn-warning" type="button" data-action="show-audiofiles">Аудиофайлы</button>
        <button class="btn btn-primary" type="button" data-action="show-sip-lines">SIP-линии</button>
        <button class="btn btn-primary" type="button" data-action="show-departments">Отделы</button>
        <button class="btn btn-primary" type="button" id="btn-shops">Магазины</button>
        <button class="btn btn-primary" type="button" onclick="alert('Раздел в разработке')">API</button>
        <button class="btn btn-primary" type="button" onclick="alert('Раздел в разработке')">Статистика</button>
        <button class="btn btn-primary" type="button" onclick="openIntegrationsModal()">Интеграции</button>
        <button class="btn btn-primary" type="button" onclick="alert('Раздел в разработке')">Прочие настройки</button>
        <p>Здесь будет содержимое админки для предприятия.</p>
    </div>

    <!-- Модальное окно Магазины -->
    <div id="shopsModal" class="modal">
        <div class="schema-modal-content" style="max-width: 1100px;">
            <div class="schema-modal-header">
                <h2 style="font-size: 1.6rem;">Магазины</h2>
                <span data-action="close-modal" class="close-button" data-target="#shopsModal">&times;</span>
            </div>
            <div class="schema-modal-body">
                <div class="d-flex justify-content-start align-items-center mb-3">
                    <button class="btn btn-success" id="btn-create-shop">Создать магазин</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead class="table-light">
                            <tr>
                                <th style="width:50%">Наименование</th>
                                <th style="width:50%">Линии магазина</th>
                            </tr>
                        </thead>
                        <tbody id="shops-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Модалка создания/редактирования магазина -->
    <div id="createShopModal" class="modal">
        <div class="schema-modal-content" style="max-width: 1000px;">
            <div class="schema-modal-header">
                <h2>Создание магазина</h2>
                <span data-action="close-modal" class="close-button" data-target="#createShopModal">&times;</span>
            </div>
            <div class="schema-modal-body">
                <div class="mb-3">
                    <label class="form-label" style="font-size:1.05rem;">Наименование</label>
                    <input type="text" id="shopNameInput" class="form-control form-control-lg" placeholder="Например: UT" />
                </div>
                <div class="text-center fw-bold" style="margin: 10px 0;">Линии магазина</div>
                <div class="table-responsive" style="max-height: 55vh; overflow:auto;">
                    <table class="table table-sm table-bordered" style="margin-bottom:0;">
                        <tbody id="shopLinesList"></tbody>
                    </table>
                </div>
                <div id="shopCreateError" class="text-danger mt-2" style="display:none;"></div>
            </div>
            <div class="schema-modal-footer" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <button class="btn btn-danger" id="deleteShopBtn">Удалить</button>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="btn btn-light" id="cancelShopBtn">ОТМЕНА</button>
                    <button class="btn btn-primary" id="saveShopBtn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для СХЕМ (DIALPLAN) -->
    <div id="schema-modal" class="modal">
        <div class="schema-modal-content">
            <div class="schema-modal-header">
                <h2>Редактор схем</h2>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="schema-modal-body">
                <iframe id="schema-iframe" class="schema-modal-iframe" src="about:blank"></iframe>
            </div>
        </div>
    </div>

    <!-- Модальное окно для SIP-линий (основное) -->
    <div id="sip-lines-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SIP-линии</h2>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <button class="btn btn-primary" type="button" data-action="open-sip-line-form">Добавить SIP-линию</button>
                <div class="table-container" style="margin-top: 20px;">
                    <table id="sip-lines-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Номер</th>
                                <th>Оператор</th>
                                <th>Оператор</th>
                                <th>Вх. схема</th>
                                <th>Исх. схемы</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Сюда будут загружаться созданные SIP-линии -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для ФОРМЫ добавления SIP-линии -->
    <div id="sip-line-form-modal" class="modal">
        <div class="modal-content modal-narrow">
            <div class="modal-header">
                <h2 id="sip-line-modal-title">Добавить SIP-линию</h2>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <form id="sip-line-form">
                    <input type="hidden" id="sip-line-id" name="id">
                    <div class="form-group">
                        <label for="sip-provider">Оператор</label>
                        <select id="sip-provider" name="provider_id" required>
                            <option value="">-- Выберите оператора --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="line_name">Имя линии (логин)</label>
                        <input type="text" id="line_name" name="line_name" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Пароль</label>
                        <input type="text" id="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="prefix">Префикс</label>
                        <input type="text" id="prefix" name="prefix">
                    </div>
                    <div class="form-group">
                        <label for="incoming_transform">Входящее преобразование</label>
                        <input type="text" id="incoming_transform" name="incoming_transform" placeholder="например: +375{9}">
                        <small>Правило: приставить префикс к последним N цифрам. Пример: +375{9}</small>
                    </div>
                    <hr style="margin:1rem 0;" />
                    <div style="font-weight:600;margin-bottom:0.5rem;">Умная переадресация</div>
                    <div class="form-group" style="display:flex;align-items:center;gap:10px;margin-bottom:0.5rem;">
                        <input type="checkbox" id="sip_sr_enabled" />
                        <label for="sip_sr_enabled" style="margin:0;">Включить для этой линии</label>
                    </div>
                    <div class="form-group" style="margin-bottom:0.5rem;">
                        <label for="sip_sr_algorithm" style="display:block;margin-bottom:4px;">Алгоритм</label>
                        <select id="sip_sr_algorithm" class="form-group" style="width:100%;">
                            <option value="">— выбрать —</option>
                            <option value="retailcrm">RetailCRM</option>
                            <option value="uon">U-ON.Travel</option>
                            <option value="first_call">Первый звонок</option>
                            <option value="last_call">Последний звонок</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div id="sip_sr_options" style="display:grid;grid-template-columns:24px 160px 60px;row-gap:8px;column-gap:8px;align-items:center;">
                            <input type="checkbox" id="sip_sr_do_routing"/><span style="white-space:nowrap;">Маршрутизация</span><span></span>
                            <input type="checkbox" id="sip_sr_send_line_name"/><span style="white-space:nowrap;">Имя линии</span>
                            <select id="sip_sr_line_name_order" style="width:60px;">
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            </select>
                            <input type="checkbox" id="sip_sr_send_customer_name"/><span style="white-space:nowrap;">Имя клиента</span>
                            <select id="sip_sr_customer_name_order" style="width:60px;">
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            </select>
                            <input type="checkbox" id="sip_sr_send_shop_name"/><span style="white-space:nowrap;">Название магазина</span>
                            <select id="sip_sr_shop_name_order" style="width:60px;">
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно для ПОДТВЕРЖДЕНИЯ УДАЛЕНИЯ SIP-линии -->
    <div id="delete-sip-line-modal" class="modal">
        <div class="modal-content modal-narrow">
            <div class="modal-header">
                <h2 id="delete-sip-line-modal-title">Подтверждение удаления</h2>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <p id="delete-sip-line-warning-text"></p>
                <input type="hidden" id="sip-line-to-delete-id">
            </div>
            <div class="form-actions" style="padding: 1rem 20px;">
                <button type="button" class="btn btn-secondary" data-action="close-modal">Отмена</button>
                <button type="button" id="confirm-delete-sip-line-btn" class="btn btn-danger">Удалить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для управления пользователями -->
    <div id="user-management-modal" class="modal">
        <div class="modal-content" style="max-width: 90%;">
            <div class="modal-header">
                <h2>Пользователи и внутренние линии</h2>
                <div>
                    <button data-action="open-create-user" class="btn btn-primary">Создать пользователя</button>
                    <button data-action="open-create-line" class="btn btn-primary">Создать линию</button>
                </div>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Номер</th><th>IP регистр.</th><th>Вх. схема</th><th>Исх. схемы</th><th>Имя Фамилия</th><th>Логин</th><th>Роли</th><th>Отделы</th><th>F.Me</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="userModalTitle">Создание пользователя</h2>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="form-group"><label for="userEmail">Логин/Email</label><input type="email" id="userEmail" name="email" required></div>
                            <div class="form-group">
                                <label>Роли</label>
                                <div style="margin-top: 5px; display: grid; grid-template-columns: auto auto; gap: 5px; align-items: center; max-width: 150px;">
                                    <span>Администратор</span>
                                    <input type="checkbox" id="roleAdmin" name="is_admin" value="true">
                                    
                                    <span>Сотрудник</span>
                                    <input type="checkbox" id="roleEmployee" name="is_employee" value="true" checked>
                                    
                                    <span>Маркетолог</span>
                                    <input type="checkbox" id="roleMarketer" name="is_marketer" value="true">
                                    
                                    <span>Spec1</span>
                                    <input type="checkbox" id="roleSpec1" name="is_spec1" value="true">
                                    
                                    <span>Spec2</span>
                                    <input type="checkbox" id="roleSpec2" name="is_spec2" value="true">
                                </div>
                            </div>
                            <div class="form-group"><label for="userLastName">Фамилия</label><input type="text" id="userLastName" name="last_name" required></div>
                            <div class="form-group"><label for="userFirstName">Имя</label><input type="text" id="userFirstName" name="first_name" required></div>
                            <div class="form-group"><label for="userPatronymic">Отчество</label><input type="text" id="userPatronymic" name="patronymic"></div>
                        </div>
                        <div>
                            <div class="form-group"><label for="userPersonalPhone">Внешний номер</label><input type="tel" id="userPersonalPhone" name="personal_phone"></div><hr>
                            <p>Внутренние номера <button type="button" data-action="add-internal-line" style="cursor: pointer; border-radius: 50%; border: 1px solid #ccc; background-color: #f8f8f8;">+</button></p>
                            <div id="internalNumbersList"></div><hr>
                            <p>Отделы</p>
                            <div id="userDepartmentsList" style="min-height: 56px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px; background: #fff;"></div>
                        </div>
                    </div>
                    <hr><h4>Права</h4><hr>
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
                        <h4 style="margin:0;">Схема дозвона (Умная переадресация и Follow Me)</h4>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="number" id="followMeNumber" min="100" max="899" style="width:56px; font-size:16px; text-align:center;" />
                            <label style="display:flex; align-items:center; gap:6px; white-space:nowrap;">
                                <input type="checkbox" id="followMeEnabled" /> Включить
                            </label>
                        </div>
                    </div>

                    <!-- Follow Me steps table -->
                    <div id="followMeStepsSection" style="margin-top:10px;">
                        <div class="table-container" style="border:1px solid #e5e5e5; border-radius:4px;">
                            <table style="width:100%; border-collapse:collapse;">
                                <thead>
                                    <tr style="background:#f7f7f7;">
                                        <th style="text-align:left; padding:8px; border-right:1px solid #eee; width:160px;">Шаг</th>
                                        <th style="text-align:left; padding:8px; border-right:1px solid #eee; width:140px;">Гудки</th>
                                        <th style="text-align:left; padding:8px;">Номера</th>
                                    </tr>
                                </thead>
                                <tbody id="followMeStepsBody">
                                    <!-- строки шагов будут добавляться позже -->
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top:6px;">
                            <button type="button" id="addFollowMeStepBtn" data-action="add-followme-step" style="background:none; border:none; color:#1a73e8; cursor:pointer; padding:0;">+ Добавить шаг</button>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" data-action="delete-user" id="deleteUserBtn" class="btn btn-danger" style="display: none;">Удалить</button>
                        <div>
                            <button type="submit" id="saveUserBtn" class="btn btn-primary">Сохранить</button>
                            <button type="button" data-action="close-modal" class="btn btn-secondary">Отмена</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Create Line Modal -->
    <div id="createLineModal" class="modal">
        <div class="modal-content modal-narrow">
            <div class="modal-header"><h2>Внутренняя линия</h2><span data-action="close-modal" class="close-button">&times;</span></div>
            <div class="modal-body">
                <form id="createLineForm">
                    <div class="form-group"><label for="lineNumberInput">Номер</label><input type="text" id="lineNumberInput" name="phone_number" required><small>Интервал 100-899 (301, 302, 555 недоступны)</small></div>
                    <div class="form-group"><label for="linePasswordInput">Пароль</label><div class="password-wrapper"><input type="text" id="linePasswordInput" name="password" readonly><button type="button" class="copy-btn" onclick="copyToClipboard('linePasswordInput')">❐</button></div></div>
                    <div class="form-actions"><button type="submit" class="btn btn-primary">Сохранить</button></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Select Lines Modal -->
    <div id="selectLinesModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header"><h2>Внутренние линии</h2><span data-action="close-modal" class="close-button">&times;</span></div>
            <div class="modal-body">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;"><input type="text" id="filterLineNumber" placeholder="Внутренний номер" style="flex: 1;"><input type="text" id="filterLineManager" placeholder="Менеджер" style="flex: 1;"></div>
                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table><thead><tr><th style="width: 50px;"></th><th>Внутренний номер</th><th>Менеджер</th></tr></thead><tbody id="selectLinesTableBody"></tbody></table>
                </div>
            </div>
            <div class="form-actions">
                <button data-action="go-to-create-line" class="btn btn-primary" style="background-color: #28a745;">Создать</button>
                <div><button data-action="confirm-line-selection" class="btn btn-primary">OK</button><button type="button" data-action="close-modal" class="btn btn-secondary">Отмена</button></div>
            </div>
        </div>
    </div>

    <!-- GSM Lines Modal (кастомная, как у пользователей, с разметкой как у шлюза) -->
    <div id="gsmLinesModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>GSM Линии предприятия</h2>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <div class="gsm-table-container" id="gsmLinesTableContainer">
                    <!-- Таблицы по шлюзам будут вставляться сюда через JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Контейнер для модалки редактирования линии -->
    <div id="editLineModalContainer"></div>
    <!-- Контейнер для модалки редактирования ВНУТРЕННИХ линий -->
    <div id="editInternalLineModalContainer"></div>

    <!-- Audiofiles Modal -->
    <div id="audiofilesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Аудиофайлы</h2>
                <div>
                    <button class="btn btn-primary" type="button" data-action="add-greeting-file">+ Файл приветствия</button>
                    <button class="btn btn-primary" type="button" data-action="add-waiting-file">+ Файл ожидания</button>
                </div>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <div class="audio-files-container">
                    <div class="audio-files-header">
                        <div>Наименование</div>
                        <div>Используется в схемах</div>
                    </div>
                    <div id="audioFilesList">
                        <!-- Аудиофайлы будут загружены сюда -->
                    </div>
                </div>
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" data-action="refresh-audio-files" class="btn btn-primary">Обновить</button>
                <button type="button" data-action="close-modal" class="btn btn-secondary">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для добавления/редактирования аудиофайла -->
    <div id="uploadAudioModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h5 class="modal-title">Аудиофайл</h5>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <form id="uploadAudioForm">
                    <input type="hidden" id="uploadFileType" name="file_type">
                    <div class="form-group">
                        <label for="audioDisplayName">Название</label>
                        <input type="text" id="audioDisplayName" name="display_name" required>
                    </div>
                    <div class="form-group">
                        <label>Выбрать файл</label>
                        <input type="file" id="audioFile" name="file" accept=".mp3,.wav" required style="border: 1px solid #ccc; padding: 5px; width: 100%;">
                        <small style="display: block; margin-top: 5px;">
                           <strong style="font-weight: 600; color: #495057;">Файл должен быть формата .mp3 (любой битрейт) или .wav (16bit 8kHz) и не более 1.9 мб</strong>
                        </small>
                    </div>
                    <div class="form-actions" style="margin-top: 1.5rem;">
                         <button type="button" data-action="close-modal" class="btn btn-secondary">ОТМЕНА</button>
                         <button type="submit" class="btn btn-primary">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно для Отделов (основное) -->
    <div id="departments-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Отделы</h2>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table id="departments-table">
                        <thead>
                            <tr>
                                <th>Номер</th>
                                <th>Наименование</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Сюда будут загружаться отделы -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="form-actions" style="padding: 1rem 20px; justify-content: space-between;">
                 <button class="btn btn-primary" type="button" data-action="open-department-form">Создать новый</button>
                 <button type="button" data-action="close-modal" class="btn btn-secondary">Закрыть</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/20.3.0/js/intlTelInput.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/admin_controls.js" defer></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- State and Constants ---
        const enterpriseNumber = '{{ enterprise.number }}';
        let currentEditingUser = null;
        let usersDataCache = null;
        let allLinesCache = null;
        let internalPhonesIpCache = null; // Кэш для IP адресов внутренних линий
        let iti = null;
        let returnToSelectLinesModalAfterCreation = false;

        // --- DOM Elements ---
        const usersModal = document.getElementById('user-management-modal');
        const createUserModal = document.getElementById('createUserModal');
        const createLineModal = document.getElementById('createLineModal');
        const selectLinesModal = document.getElementById('selectLinesModal');
        const gsmLinesModal = document.getElementById('gsmLinesModal');
        const audioFilesModal = document.getElementById('audiofilesModal');
        const uploadAudioModal = document.getElementById('uploadAudioModal');
        const userModalTitle = document.getElementById('userModalTitle');
        const createUserForm = document.getElementById('createUserForm');
        const createLineForm = document.getElementById('createLineForm');
        const usersTableBody = document.getElementById('usersTableBody');
        const selectLinesTableBody = document.getElementById('selectLinesTableBody');
        const internalNumbersList = document.getElementById('internalNumbersList');
        const deleteUserBtn = document.getElementById('deleteUserBtn');
        const editLineModalContainer = document.getElementById('editLineModalContainer');
        const editInternalLineModalContainer = document.getElementById('editInternalLineModalContainer');
        const sipLinesModal = document.getElementById('sip-lines-modal');
        const sipLineFormModal = document.getElementById('sip-line-form-modal');
        const departmentsModal = document.getElementById('departments-modal');
        const departmentFormModal = document.getElementById('department-form-modal');
        const schemaModal = document.getElementById('schema-modal');

        // --- Role Management Logic ---
        const setupRoleLogic = () => {
            const adminRole = document.getElementById('roleAdmin');
            const otherRoles = ['roleEmployee', 'roleMarketer', 'roleSpec1', 'roleSpec2'];
            
            adminRole.addEventListener('change', function() {
                if (this.checked) {
                    // Если выбран Администратор - отключаем и снимаем остальные роли
                    otherRoles.forEach(roleId => {
                        const roleElement = document.getElementById(roleId);
                        roleElement.checked = false;
                        roleElement.disabled = true;
                    });
                } else {
                    // Если Администратор не выбран - включаем остальные роли
                    otherRoles.forEach(roleId => {
                        document.getElementById(roleId).disabled = false;
                    });
                    // Автоматически ставим Сотрудника если ничего не выбрано
                    const anyChecked = otherRoles.some(roleId => document.getElementById(roleId).checked);
                    if (!anyChecked) {
                        document.getElementById('roleEmployee').checked = true;
                    }
                }
            });
        };

        // Инициализируем логику ролей
        setupRoleLogic();

        // --- Event Delegation ---
        document.body.addEventListener('click', async (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.getAttribute('data-action');
            
            if (action === 'show-users') {
                usersModal.style.display = 'block';
                fetchUsers(); // Всегда запрашиваем свежие данные
            } else if (action === 'show-audiofiles') {
                document.getElementById('audiofilesModal').style.display = 'block';
                loadAudioFiles();
            } else if (action === 'show-sip-lines') {
                sipLinesModal.style.display = 'block';
                loadSipLines();
            } else if (action === 'show-departments') {
                departmentsModal.style.display = 'block';
                loadDepartments();
            } else if (action === 'show-outgoing-schemas') {
                outgoingSchemasPlaceholderModal.style.display = 'block';
            } else if (action === 'open-department-form') {
                openDepartmentForm();
            } else if (action === 'edit-department') {
                const deptId = e.target.closest('tr').dataset.departmentId;
                openDepartmentForm(deptId);
            } else if (action === 'add-department-member') {
                addDepartmentMember();
            } else if (action === 'remove-department-member') {
                e.target.closest('li').remove();
            } else if (action === 'add-followme-step') {
                addFollowMeStepRow();
            } else if (action === 'open-sip-line-form') {
                document.getElementById('sip-line-form-modal').style.display = 'block';
                // Опционально: сбросить форму при открытии
                document.getElementById('sip-line-form').reset();
                document.getElementById('sip-line-id').value = '';
                document.getElementById('sip-line-modal-title').textContent = 'Добавить SIP-линию';
                loadSipProviders();
            } else if (action === 'add-outgoing-schema') {
                const enterpriseNumber = '{{ enterprise.number }}';
                window.location.href = `/dial/?enterprise=${enterpriseNumber}&type=outgoing`;
            } else if (action === 'edit-sip-line') {
                const lineId = e.target.dataset.lineId;
                openSipLineForEdit(lineId);
            } else if (action === 'delete-sip-line') {
                const lineId = target.dataset.lineId;
                const lineName = target.dataset.lineName;
                const modal = document.getElementById('delete-sip-line-modal');
                const warningText = document.getElementById('delete-sip-line-warning-text');
                const lineIdInput = document.getElementById('sip-line-to-delete-id');
                
                warningText.textContent = `Вы уверены, что хотите удалить SIP-линию "${lineName}"? Это действие необратимо.`;
                lineIdInput.value = lineId;

                modal.style.display = 'block';
            } else if (action === 'add-greeting-file' || action === 'add-waiting-file') {
                const fileType = action === 'add-greeting-file' ? 'start' : 'hold';
                const uploadForm = document.getElementById('uploadAudioForm');
                if(uploadForm) uploadForm.reset();
                
                const fileTypeInput = document.getElementById('uploadFileType');
                if(fileTypeInput) fileTypeInput.value = fileType;
                
                const uploadModal = document.getElementById('uploadAudioModal');
                if(uploadModal) uploadModal.style.display = 'block';
            } else if (action === 'open-create-user') {
                openCreateUserModal();
            } else if (action === 'open-create-line') {
                returnToSelectLinesModalAfterCreation = false;
                openCreateLineModal();
            } else if (action === 'edit-user') {
                const userId = target.getAttribute('data-user-id');
                if (userId) {
                    openUserModalForEdit(userId);
                }
            } else if (action === 'edit-internal-line') {
                const phoneNumber = target.getAttribute('data-phone-number');
                if (phoneNumber) {
                    // Создаем искусственный event объект для совместимости
                    const fakeEvent = {
                        preventDefault: () => {},
                        target: { textContent: phoneNumber.trim() }
                    };
                    openEditInternalLineModal(fakeEvent);
                }
            } else if (action === 'delete-user') {
                deleteUser();
            } else if (action === 'add-internal-line') {
                openSelectLinesModal();
            } else if (action === 'close-modal') {
                const modal = e.target.closest('.modal');
                if (modal) modal.style.display = 'none';

            } else if (action === 'confirm-line-selection') {
                confirmLineSelection();
            } else if (action === 'go-to-create-line') {
                returnToSelectLinesModalAfterCreation = true;
                closeModal(selectLinesModal);
                openCreateLineModal();
            } else if (action === 'refresh-audio-files') {
                try {
                    const response = await fetch(`/enterprise/${enterpriseNumber}/regenerate-musiconhold-conf`, {
                        method: 'POST',
                    });
                    const responseData = await response.json();
                    if (!response.ok) {
                        throw new Error(responseData.detail || 'Не удалось выполнить перегенерацию.');
                    }
                    alert('Файл musiconhold.conf успешно обновлен.');
                } catch (error) {
                    alert(`Ошибка: ${error.message}`);
                }
            } else if (action === 'delete-audio-file') {
                const fileId = target.dataset.fileId;
                const fileName = target.dataset.fileName;

                if (!confirm(`Вы уверены, что хотите удалить аудиофайл "${fileName}"? Это действие необратимо.`)) {
                    return;
                }

                try {
                    const response = await fetch(`/enterprise/${enterpriseNumber}/audiofiles/${fileId}`, {
                        method: 'DELETE',
                    });
                    const responseData = await response.json();
                    if (!response.ok) {
                        throw new Error(responseData.detail || 'Не удалось удалить файл.');
                    }
                    alert('Аудиофайл успешно удален.');
                    loadAudioFiles(); // Перезагружаем список файлов
                } catch (error) {
                    alert(`Ошибка: ${error.message}`);
                }
            } else if (action === 'open-schema-modal') {
                const schemaIframe = document.getElementById('schema-iframe');
                const dialplanServiceUrl = `http://${window.location.hostname}:8005/?enterprise=${enterpriseNumber}`;
                schemaIframe.src = dialplanServiceUrl;
                schemaModal.style.display = 'block';
            }

            // Закрываем все модалки, если клик вне их контента
            [usersModal, createUserModal, gsmLinesModal, audioFilesModal, departmentsModal, departmentFormModal, schemaModal].forEach(modal => {
                if (modal && e.target === modal) {
                    modal.style.display = 'none';
                    if (modal.id === 'schema-modal') {
                        document.getElementById('schema-iframe').src = 'about:blank'; // Сбрасываем iframe при закрытии
                    }
                }
            });
        });

        // ---- Магазины ----
        const shopsTableBody = document.getElementById('shops-table-body');
        let shopsCache = [];
        let editingShopId = null;
        document.getElementById('btn-shops').addEventListener('click', async () => {
            document.getElementById('shopsModal').style.display = 'block';
            await loadShops();
        });
        document.getElementById('btn-create-shop').addEventListener('click', async () => {
            editingShopId = null;
            const titleEl = document.querySelector('#createShopModal .schema-modal-header h2');
            if (titleEl) titleEl.textContent = 'Создание магазина';
            document.getElementById('shopNameInput').value = '';
            document.getElementById('shopCreateError').style.display = 'none';
            await renderShopLinesForSelect(new Set());
            document.getElementById('deleteShopBtn').style.display = 'none';
            document.getElementById('createShopModal').style.display = 'block';
        });
        document.getElementById('saveShopBtn').addEventListener('click', async () => {
            const name = document.getElementById('shopNameInput').value.trim();
            const checked = Array.from(document.querySelectorAll('.shop-line-checkbox:checked'))
                .filter(ch => (ch.dataset.type || 'gsm') === 'gsm')
                .map(ch => parseInt(ch.value));
            if (!name) {
                const err = document.getElementById('shopCreateError');
                err.textContent = 'Введите наименование магазина';
                err.style.display = 'block';
                return;
            }
            if (!editingShopId) {
                // создаём магазин и сразу сохраняем и SIP привязки
                const resp = await fetch(`/enterprise/${enterpriseNumber}/shops`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, line_ids: checked })
                });
                if (!resp.ok) {
                    const t = await resp.text();
                    alert(`Ошибка создания магазина: ${t}`);
                    return;
                }
                const created = await resp.json();
                const newShopId = created && created.id;
                const sipChecked = Array.from(document.querySelectorAll('.shop-line-checkbox:checked'))
                    .filter(ch => (ch.dataset.type || 'gsm') === 'sip')
                    .map(ch => parseInt(ch.value));
                if (newShopId) {
                    const sipResp = await fetch(`/enterprise/${enterpriseNumber}/shops/${newShopId}/sip-lines`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sip_line_ids: sipChecked })
                    });
                    if (!sipResp.ok) {
                        const t = await sipResp.text();
                        alert(`Ошибка сохранения SIP-линий: ${t}`);
                    }
                }
            } else {
                await fetch(`/enterprise/${enterpriseNumber}/shops/${editingShopId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                await fetch(`/enterprise/${enterpriseNumber}/shops/${editingShopId}/lines`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ line_ids: checked })
                });
                const sipChecked = Array.from(document.querySelectorAll('.shop-line-checkbox:checked'))
                    .filter(ch => (ch.dataset.type || 'gsm') === 'sip')
                    .map(ch => parseInt(ch.value));
                const sipResp = await fetch(`/enterprise/${enterpriseNumber}/shops/${editingShopId}/sip-lines`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sip_line_ids: sipChecked })
                });
                if (sipResp.ok) {
                    const data = await sipResp.json().catch(()=>({}));
                    console.log('SIP saved:', data);
                } else {
                    const t = await sipResp.text();
                    alert(`Ошибка сохранения SIP-линий: ${t}`);
                }
            }
            document.getElementById('createShopModal').style.display = 'none';
            await loadShops();
        });

        document.getElementById('cancelShopBtn').addEventListener('click', () => {
            document.getElementById('createShopModal').style.display = 'none';
        });

        document.getElementById('deleteShopBtn').addEventListener('click', async () => {
            if (!editingShopId) return;
            if (!confirm('Удалить магазин?')) return;
            await fetch(`/enterprise/${enterpriseNumber}/shops/${editingShopId}`, { method: 'DELETE' });
            document.getElementById('createShopModal').style.display = 'none';
            await loadShops();
        });

        async function loadShops() {
            shopsTableBody.innerHTML = '<tr><td colspan="2" class="text-center">Загрузка...</td></tr>';
            const res = await fetch(`/enterprise/${enterpriseNumber}/shops`);
            const shops = await res.json();
            shopsCache = Array.isArray(shops) ? shops : [];
            if (!Array.isArray(shops) || shops.length === 0) {
                shopsTableBody.innerHTML = '<tr><td colspan="2" class="text-muted">Магазинов нет</td></tr>';
                return;
            }
            shopsTableBody.innerHTML = shops.map(s => {
                const gsmUsed = (s.lines || []).map(l => `<span class=\"badge bg-secondary me-1\">${l.phone_number || l.line_id}</span>`).join(' ');
                const sipUsed = (s.sip_lines || []).map(l => `<span class=\"badge bg-secondary me-1\">${l.line_name || ''}</span>`).join(' ');
                const used = [gsmUsed, sipUsed].filter(Boolean).join(' ');
                return `<tr data-shop-id='${s.id}'><td><a href=\"#\" class=\"shop-name-link text-primary\" data-shop-id='${s.id}'>${s.name || ''}</a></td><td>${used}</td></tr>`;
            }).join('');
        }

        async function renderShopLinesForSelect(precheckedSet = new Set()) {
            const res = await fetch(`/enterprise/${enterpriseNumber}/gsm-lines/all`);
            const gateways = await res.json();
            // карта принадлежности линий: line.id -> shop name
            const ownersMap = new Map();
            try {
                const shopsRes = await fetch(`/enterprise/${enterpriseNumber}/shops`);
                const shopsData = await shopsRes.json();
                if (Array.isArray(shopsData)) {
                    shopsData.forEach(s => {
                        (s.lines || []).forEach(l => ownersMap.set(l.id, s.name || 'N/A'));
                    });
                }
            } catch (e) { /* ignore */ }

            const container = document.getElementById('shopLinesList');
            container.innerHTML = '';
            gateways.forEach(gw => {
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `<td colspan="3" class="fw-bold" style="background:#f8f9fa;">${gw.gateway_name}</td>`;
                container.appendChild(headerRow);
                gw.lines.forEach(line => {
                    const tr = document.createElement('tr');
                    const isChecked = precheckedSet.has(line.id) ? 'checked' : '';
                    const left = `${line.phone_number || ''}${line.line_name ? ' — ' + line.line_name : ''}`.trim();
                    const right = ownersMap.get(line.id) || 'N/A';
                    tr.innerHTML = `
                        <td style=\"width:40px; text-align:center; vertical-align:middle;\">
                            <input class='form-check-input shop-line-checkbox' data-type='gsm' type='checkbox' value='${line.id}' id='line_${line.id}' ${isChecked}>
                        </td>
                        <td style=\"vertical-align:middle;\">
                            <label class='form-check-label' for='line_${line.id}'>${left}</label>
                        </td>
                        <td style=\"vertical-align:middle;\">${right}</td>
                    `;
                    container.appendChild(tr);
                });
            });

            // Добавляем SIP-линии в конце списка и даём возможность привязки к магазину
            try {
                const sipRes = await fetch(`/enterprise/${enterpriseNumber}/sip-lines`);
                if (sipRes.ok) {
                    const sipLines = await sipRes.json();
                    if (Array.isArray(sipLines) && sipLines.length) {
                        const headerRow = document.createElement('tr');
                        headerRow.innerHTML = `<td colspan=\"3\" class=\"fw-bold\" style=\"background:#f1f1f1;\">SIP-линии</td>`;
                        container.appendChild(headerRow);
                        // Узнаём владельца каждой SIP-линии и заранее отметим чекбоксы, если линия уже принадлежит текущему магазину
                        const owners = new Map();
                        try {
                            const shopsResp = await fetch(`/enterprise/${enterpriseNumber}/shops`);
                            const shopsData = shopsResp.ok ? await shopsResp.json() : [];
                            (shopsData || []).forEach(sh => {
                                (sh.sip_lines || []).forEach(l => owners.set(l.id, sh.name || 'N/A'));
                            });
                        } catch(_) {}
                        // Установим значения порядка (если есть) и заблокируем селекты, если чекбокс выключен
                        try {
                            const s = (line && line.smart) ? line.smart : {};
                            const ln = document.getElementById('sr_line_name_order');
                            const cn = document.getElementById('sr_customer_name_order');
                            const sn = document.getElementById('sr_shop_name_order');
                            if (ln) { ln.value = (s && s.line_name_order) ? String(s.line_name_order) : '1'; ln.disabled = !document.getElementById('sr_send_line_name').checked; }
                            if (cn) { cn.value = (s && s.customer_name_order) ? String(s.customer_name_order) : '2'; cn.disabled = !document.getElementById('sr_send_customer_name').checked; }
                            if (sn) { sn.value = (s && s.shop_name_order) ? String(s.shop_name_order) : '3'; sn.disabled = !document.getElementById('sr_send_shop_name').checked; }
                        } catch(_) {}
                        // Тогглы для селектов порядка
                        const _toggleGsmOrders = () => {
                            const ln = document.getElementById('sr_line_name_order');
                            const cn = document.getElementById('sr_customer_name_order');
                            const sn = document.getElementById('sr_shop_name_order');
                            if (ln) { ln.disabled = !document.getElementById('sr_send_line_name').checked; }
                            if (cn) { cn.disabled = !document.getElementById('sr_send_customer_name').checked; }
                            if (sn) { sn.disabled = !document.getElementById('sr_send_shop_name').checked; }
                        };
                        ['sr_send_line_name','sr_send_customer_name','sr_send_shop_name'].forEach(id=>{
                            const el = document.getElementById(id);
                            if (el) el.addEventListener('change', _toggleGsmOrders);
                        });
                        _toggleGsmOrders();

                        // Уникальность позиций (1-3) для GSM — удалено из глобальной области, будет объявлено в модалке

                        // Уникальность позиций (1-3) для GSM (дублирующее объявление удалено) — используется enforceGsmOrders выше

                        sipLines.forEach(line => {
                            const tr = document.createElement('tr');
                            const left = `${line.line_name || ''}`.trim();
                            const right = owners.get(line.id) || 'N/A';
                            const prechecked = precheckedSet.has(line.id) ? 'checked' : '';
                            tr.innerHTML = `
                                <td style=\"width:40px; text-align:center; vertical-align:middle;\">
                                    <input class='form-check-input shop-line-checkbox' data-type='sip' type='checkbox' value='${line.id}' id='sip_${line.id}' ${prechecked}>
                                </td>
                                <td style=\"vertical-align:middle;\">
                                    <label class='form-check-label' for='sip_${line.id}'>${left}</label>
                                </td>
                                <td style=\"vertical-align:middle;\">${right}</td>
                            `;
                            container.appendChild(tr);
                        });
                    }
                }
            } catch (_) { /* ignore */ }
        }

        // Открытие редактирования по клику на названии
        document.addEventListener('click', async (e) => {
            const link = e.target.closest('.shop-name-link');
            if (!link) return;
            e.preventDefault();
            const shopId = parseInt(link.getAttribute('data-shop-id'));
            const shop = (shopsCache || []).find(s => s.id === shopId);
            if (!shop) return;
            editingShopId = shopId;
            const titleEl = document.querySelector('#createShopModal .schema-modal-header h2');
            if (titleEl) titleEl.textContent = 'Редактирование магазина';
            document.getElementById('shopNameInput').value = shop.name || '';
            const prechecked = new Set([...(shop.lines || []).map(l => l.id), ...((shop.sip_lines || []).map(l => l.id))]);
            await renderShopLinesForSelect(prechecked);
            document.getElementById('shopCreateError').style.display = 'none';
            document.getElementById('deleteShopBtn').style.display = 'inline-block';
            document.getElementById('createShopModal').style.display = 'block';
        });

        // Таблица пока только с шапкой; редактирование и предпросмотр добавим следующим шагом

        // Helper: сформировать опции номеров (внутренние + персональный)
        function buildUserNumbersOptions(exclude, includePlaceholder=false) {
            const listContainer = document.getElementById('internalNumbersList');
            const internal = Array.from(listContainer.querySelectorAll('input[name="internal_phones"]')).map(i => i.value).sort((a,b)=>parseInt(a)-parseInt(b));
            const personal = (typeof iti !== 'undefined') ? iti.getNumber() : '';
            const all = [...internal];
            if (personal) all.push(personal);
            let options = includePlaceholder ? '<option value=""></option>' : '';
            options += all
                .filter(n => n && n !== exclude)
                .map(n => `<option value="${n}">${n}</option>`)
                .join('');
            return options;
        }

        // Helper: добавить строку шага Follow Me
        function addFollowMeStepRow() {
            const tbody = document.getElementById('followMeStepsBody');
            if (!tbody) return;
            if (tbody.children.length >= 2) return; // максимум 2 шага
            const idx = tbody.children.length + 1;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding:8px; border-top:1px solid #eee; display:flex; align-items:center; gap:8px;">
                    <span style="width:16px; display:inline-block;">${idx}</span>
                    <a href="#" data-action="remove-followme-step" title="Удалить">✕</a>
                </td>
                <td style="padding:8px; border-top:1px solid #eee;">
                    <input type="number" class="fm-rings" value="3" min="1" max="20" style="width:56px; text-align:center;" />
                </td>
                <td style="padding:8px; border-top:1px solid #eee;">
                    <div class="fm-numbers" style="display:flex; align-items:center; gap:6px;">
                        <select class="fm-select" style="min-width:80px;">${buildUserNumbersOptions('', true)}</select>
                        <button type="button" class="btn btn-light fm-add" disabled>+</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);

            // скрыть кнопку добавления шага если достигнут лимит
            const addStepBtn = document.getElementById('addFollowMeStepBtn');
            if (addStepBtn) addStepBtn.style.display = (tbody.children.length >= 2) ? 'none' : 'inline';

            const select = tr.querySelector('select.fm-select');
            const addBtn = tr.querySelector('button.fm-add');
            const ringsInput = tr.querySelector('input.fm-rings');

            select.addEventListener('change', () => {
                addBtn.disabled = !select.value;
                if (select.value && select.value.startsWith('+')) {
                    const val = parseInt(ringsInput.value || '0', 10);
                    if (val < 6) ringsInput.value = 6;
                }
            });

            addBtn.addEventListener('click', () => {
                const container = tr.querySelector('.fm-numbers');
                const selects = Array.from(container.querySelectorAll('select.fm-select'));
                const exclude = selects.length ? selects[selects.length-1].value : '';
                const newSel = document.createElement('select');
                newSel.className = 'fm-select';
                newSel.innerHTML = buildUserNumbersOptions(exclude, true);
                container.insertBefore(newSel, addBtn);
                addBtn.disabled = true;
                newSel.addEventListener('change', () => {
                    addBtn.disabled = !newSel.value;
                    if (newSel.value && newSel.value.startsWith('+')) {
                        const val = parseInt(ringsInput.value || '0', 10);
                        if (val < 6) ringsInput.value = 6;
                    }
                });
            });
        }

        // Удаление шага и перенумерация
        document.body.addEventListener('click', (e) => {
            const a = e.target.closest('[data-action="remove-followme-step"]');
            if (!a) return;
            e.preventDefault();
            const row = a.closest('tr');
            const tbody = document.getElementById('followMeStepsBody');
            if (row && tbody) {
                row.remove();
                Array.from(tbody.children).forEach((tr, i) => {
                    const span = tr.querySelector('td:first-child span');
                    if (span) span.textContent = String(i+1);
                });
                const addStepBtn = document.getElementById('addFollowMeStepBtn');
                if (addStepBtn) addStepBtn.style.display = (tbody.children.length >= 2) ? 'none' : 'inline';
            }
        });

        // --- Modal Management ---
        const openModal = (modalElement) => modalElement && (modalElement.style.display = 'block');
        const closeModal = (modalElement) => modalElement && (modalElement.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) closeModal(event.target);
        });

        // --- Data Fetching and Rendering ---
        const fetchUsers = async () => {
            usersTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center">Загрузка...</td></tr>`;
            try {
                // Загружаем пользователей и IP адреса внутренних линий параллельно
                const [usersResponse, ipResponse] = await Promise.all([
                    fetch(`/enterprise/${enterpriseNumber}/users`),
                    fetch(`/admin/check-internal-phones-ip/${enterpriseNumber}`)
                ]);
                
                if (!usersResponse.ok) throw new Error(`HTTP ${usersResponse.status}`);
                usersDataCache = await usersResponse.json();
                
                // Загружаем IP адреса (не критично, если не получится)
                if (ipResponse.ok) {
                    const ipData = await ipResponse.json();
                    if (ipData.success) {
                        internalPhonesIpCache = ipData.internal_phones;
                    }
                } else {
                    console.warn('Failed to load internal phones IP data:', ipResponse.status);
                    internalPhonesIpCache = null;
                }
                
                renderUsersTable();
            } catch (error) {
                usersTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center">Ошибка загрузки: ${error.message}</td></tr>`;
            }
        };
        
        const customSort = (data) => {
            const usersWithInternal = [];
            const unassignedInternal = [];
            const usersWithoutInternal = []; // <-- Новая категория
            const others = [];

            data.forEach(item => {
                const isUser = !!item.user_id;
                const internalLines = (item.lines || [])
                    .filter(l => l.phone_number && !String(l.phone_number).startsWith('+'))
                    .map(l => ({ ...l, phone_number_int: parseInt(l.phone_number, 10) }));

                if (isUser) { // Если это запись пользователя
                    if (internalLines.length > 0) {
                        // Пользователь с внутренними номерами
                        usersWithInternal.push({
                            data: item,
                            minPhone: Math.min(...internalLines.map(l => l.phone_number_int))
                        });
                    } else {
                        // Пользователь БЕЗ внутренних номеров
                        usersWithoutInternal.push({ data: item });
                    }
                } else if (!isUser && internalLines.length > 0) {
                    // Непривязанная внутренняя линия
                    unassignedInternal.push({
                        data: item,
                        minPhone: Math.min(...internalLines.map(l => l.phone_number_int))
                    });
                } else {
                    // Все остальное (например, непривязанные внешние линии)
                    others.push({ data: item });
                }
            });

            const sortedUsers = [];
            if (usersWithInternal.length > 0) {
                usersWithInternal.sort((a, b) => a.minPhone - b.minPhone);
                let lastUser = usersWithInternal.shift();
                sortedUsers.push(lastUser);

                while (usersWithInternal.length > 0) {
                    const lastPhone = lastUser.minPhone;
                    usersWithInternal.sort((a, b) => {
                        const diffA = Math.abs(a.minPhone - lastPhone);
                        const diffB = Math.abs(b.minPhone - lastPhone);
                        if (diffA !== diffB) return diffA - diffB;
                        return a.minPhone - b.minPhone;
                    });
                    lastUser = usersWithInternal.shift();
                    sortedUsers.push(lastUser);
                }
            }

            unassignedInternal.sort((a, b) => a.minPhone - b.minPhone);

            // Сортируем пользователей без номеров по их ID
            usersWithoutInternal.sort((a, b) => a.data.user_id - b.data.user_id);

            // На этом шаге намеренно не меняем порядок возврата, чтобы следовать протоколу.
            // usersWithoutInternal пока не используются.
            return [
                ...sortedUsers.map(item => item.data),
                ...unassignedInternal.map(item => item.data),
                ...usersWithoutInternal.map(item => item.data),
                ...others.map(item => item.data)
            ];
        };

        const renderUsersTable = () => {
            usersTableBody.innerHTML = '';
            const data = usersDataCache || [];
 
            if (data.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Пользователи и линии не найдены.</td></tr>';
                return;
            }
            
            const sortedData = customSort(data);
 
            function formatSchemaCount(schemas) {
                if (!schemas || schemas.length === 0) return '';
                const validSchemas = schemas.filter(s => s);
                const count = validSchemas.length;

                if (count === 0) return '';
                if (count === 1) return validSchemas[0];

                const lastDigit = count % 10;
                const lastTwoDigits = count % 100;

                if (lastTwoDigits >= 11 && lastTwoDigits <= 19) {
                    return `${count} схем`;
                }
                if (lastDigit === 1) {
                    return `${count} схема`;
                }
                if ([2, 3, 4].includes(lastDigit)) {
                    return `${count} схемы`;
                }
                return `${count} схем`;
             }
 
            sortedData.forEach(user => {
                const hasLines = user.lines && user.lines.length > 0;
                const lineCount = hasLines ? user.lines.length : 1;
                const linesToRender = hasLines ? user.lines : [{}];
 
                linesToRender.forEach((line, index) => {
                    const row = document.createElement('tr');
                    
                    const phoneNumber = line.phone_number || '';

                    // Определяем, является ли пользователь группой с внутренними номерами
                    const isUserWithInternalLines = user.user_id && hasLines;

                    if (phoneNumber.startsWith('+')) {
                        row.classList.add('mobile-number-row');
                    }

                    // Подсветка номеров без схем
                    const hasIncoming = line.incoming_schema_names && line.incoming_schema_names.filter(s => s).length > 0;
                    const hasOutgoing = !!line.outgoing_schema_name;
                    if (phoneNumber && !hasIncoming && !hasOutgoing) {
                        row.classList.add('no-schema-row');
                    }

                    // Если это последняя строка в группе пользователя с внутренними линиями, добавляем класс
                    if (isUserWithInternalLines && index === linesToRender.length - 1) {
                        row.classList.add('user-group-end');
                    }

                    const formattedNumber = formatDisplayNumber(phoneNumber);
                    const isInternal = phoneNumber && !phoneNumber.startsWith('+');
                    const numberCellHtml = isInternal
                        ? `<a href="#" data-action="edit-internal-line" data-phone-number="${phoneNumber}">${formattedNumber}</a>`
                        : formattedNumber;

                    // Получаем IP адрес для внутренней линии
                    let ipRegisterCell = '';
                    if (isInternal && internalPhonesIpCache && internalPhonesIpCache[phoneNumber]) {
                        const phoneData = internalPhonesIpCache[phoneNumber];
                        const ipAddress = phoneData.ip_address || '';
                        const status = phoneData.status;
                        
                        if (ipAddress) {
                            // Раскрашиваем IP в зависимости от статуса
                            const ipColor = status === 'online' ? '#28a745' : '#dc3545';
                            ipRegisterCell = `<span style="color: ${ipColor}; font-weight: 500;">${ipAddress}</span>`;
                        } else {
                            ipRegisterCell = '<span style="color: #6c757d;">—</span>';
                        }
                    }

                    // Колонки линии
                    row.innerHTML = `
                        <td>${numberCellHtml}</td>
                        <td>${ipRegisterCell}</td>
                        <td>${formatSchemaCount(line.incoming_schema_names)}</td>
                        <td>${line.outgoing_schema_name || ''}</td>
                    `;
 
                    // Колонки пользователя (добавляются только для первой строки)
                    if (index === 0) {
                        const fullName = user.full_name || '';
                        const email = user.email || '';
                        const editLink = user.user_id ? `<a href="#" data-action="edit-user" data-user-id="${user.user_id}">${fullName}</a>` : fullName;
                        
                        const userCellsHtml = `
                            <td rowspan="${lineCount}">${editLink}</td>
                            <td rowspan="${lineCount}">${email}</td>
                            <td rowspan="${lineCount}"></td>
                            <td rowspan="${lineCount}"></td>
                            <td rowspan="${lineCount}"></td>
                        `;
                        
                        row.insertAdjacentHTML('beforeend', userCellsHtml);

                        // Если это группа с внутренними номерами, применяем стиль к ячейкам с rowspan
                        if (isUserWithInternalLines) {
                            row.querySelectorAll('td[rowspan]').forEach(cell => {
                                cell.classList.add('user-group-end-cell');
                            });
                        }
                    }
                     
                    usersTableBody.appendChild(row);
                });
            });
        };
        
        const formatDisplayNumber = (number) => {
            const numStr = String(number || '');
            if (!numStr.startsWith('+') || numStr.length < 11) {
                return numStr; // Не форматируем короткие или не международные номера
            }

            // Универсальное правило: +КодСтраны КодОператора Остальное...
            // Определяем код страны (1-3 цифры) и код оператора (2-3 цифры)
            let countryCode, operatorCode, rest;

            if (numStr.startsWith('+375') && numStr.length === 13) {
                countryCode = numStr.slice(0, 4); // +375
                operatorCode = numStr.slice(4, 6); // 29
                rest = numStr.slice(6);
            } else if (numStr.startsWith('+7') && numStr.length === 12) {
                countryCode = numStr.slice(0, 2); // +7
                operatorCode = numStr.slice(2, 5); // 495
                rest = numStr.slice(5);
            } else {
                // Общая эвристика для других стран
                const len = numStr.length;
                if (len >= 13) {
                    countryCode = numStr.slice(0, 4); // Предполагаем длинный код страны
                    operatorCode = numStr.slice(4, 7);
                    rest = numStr.slice(7);
                } else {
                    countryCode = numStr.slice(0, 2); // Предполагаем короткий код страны
                    operatorCode = numStr.slice(2, 5);
                    rest = numStr.slice(5);
                }
            }

            // Форматируем оставшуюся часть номера в группы через дефис
            const restFormatted = [];
            for (let i = 0; i < rest.length; i += 2) {
                 if (i === 0 && rest.length % 2 !== 0) {
                     restFormatted.push(rest.slice(i, i + 3));
                     i++;
                 } else {
                    restFormatted.push(rest.slice(i, i + 2));
                 }
            }
            
            return `${countryCode} (${operatorCode}) ${restFormatted.join('-')}`;
        };
        
        const formatPhoneNumber = (e164) => {
            if (!e164 || !e164.startsWith('+') || e164.length < 10) return e164;
            if (e164.startsWith('+375')) {
                return `${e164.slice(0, 4)} (${e164.slice(4, 6)}) ${e164.slice(6, 9)}-${e164.slice(9, 11)}-${e164.slice(11, 13)}`;
            }
            return e164;
        };
        
        // --- User Modal Logic ---
        const initIti = () => {
            if (iti) return;
            const phoneInput = document.getElementById('userPersonalPhone');
            iti = window.intlTelInput(phoneInput, {
                // --- Обязательно для форматирования и плейсхолдеров ---
                utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/20.3.0/js/utils.js",

                // --- Форматирование ---
                nationalMode: false,      // Номер всегда в международном формате
                separateDialCode: true,   // Код страны (+375) будет отдельно от номера
                
                // --- Улучшение UX ---
                initialCountry: "auto",   // Автоматически определять страну
                geoIpLookup: callback => {
                  fetch("https://ipapi.co/json")
                    .then(res => res.json())
                    .then(data => callback(data.country_code))
                    .catch(() => callback("by")); // Беларусь как запасной вариант
                }
            });
        };

        const openCreateUserModal = () => {
            currentEditingUser = null;
            document.getElementById('userModalTitle').textContent = 'Создание пользователя';
            createUserForm.reset();
            document.getElementById('deleteUserBtn').style.display = 'none';
            document.getElementById('internalNumbersList').innerHTML = '';
            
            // Устанавливаем роли по умолчанию для нового пользователя
            document.getElementById('roleAdmin').checked = false;
            document.getElementById('roleEmployee').checked = true; // По умолчанию Сотрудник
            document.getElementById('roleMarketer').checked = false;
            document.getElementById('roleSpec1').checked = false;
            document.getElementById('roleSpec2').checked = false;
            
            // Включаем все роли (не заблокированы администратором)
            const otherRoles = ['roleEmployee', 'roleMarketer', 'roleSpec1', 'roleSpec2'];
            otherRoles.forEach(roleId => {
                document.getElementById(roleId).disabled = false;
            });
            
            openModal(createUserModal);
            initIti();
            iti.setNumber("+");
        };

        const openUserModalForEdit = async (userId) => {
            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/users/${userId}/details_for_edit`);
                if (!response.ok) {
                    const errData = await response.json().catch(()=>null);
                    throw new Error(errData?.detail || 'Не удалось загрузить данные пользователя.');
                }
                const user = await response.json();
                
                currentEditingUser = user; // Сохраняем полные данные пользователя
                
                document.getElementById('userModalTitle').textContent = 'Редактирование пользователя';
                createUserForm.reset();
                initIti();
                
                // Заполняем все поля формы
                document.getElementById('userEmail').value = user.email || '';
                document.getElementById('userFirstName').value = user.first_name || '';
                document.getElementById('userLastName').value = user.last_name || '';
                document.getElementById('userPatronymic').value = user.patronymic || '';
                iti.setNumber(user.personal_phone || '');

                // Заполняем внутренние номера
                const listContainer = document.getElementById('internalNumbersList');
                listContainer.innerHTML = '';
                if (user.internal_phones && user.internal_phones.length > 0) {
                    user.internal_phones.forEach(phone => {
                        // Создаем структуру, которую форма поймет при отправке
                        listContainer.innerHTML += `<div><input type="hidden" name="internal_phones" value="${phone}">${phone}</div>`;
                    });
                }

                // Заполняем список отделов, где участвуют внутренние номера пользователя
                const deptBox = document.getElementById('userDepartmentsList');
                if (deptBox) {
                    deptBox.innerHTML = '';
                    const departments = Array.isArray(user.departments) ? user.departments : [];
                    if (departments.length === 0) {
                        deptBox.innerHTML = '<span style="color:#888">Нет</span>';
                    } else {
                        const rows = departments.map(d => `<div>${d.name} — ${d.number}</div>`).join('');
                        deptBox.innerHTML = rows;
                    }
                }

                // Follow Me поля
                const fmNum = document.getElementById('followMeNumber');
                const fmEnabled = document.getElementById('followMeEnabled');
                if (fmNum) fmNum.value = (user.follow_me_number !== null && user.follow_me_number !== undefined) ? user.follow_me_number : '';
                if (fmEnabled) fmEnabled.checked = !!user.follow_me_enabled;
                const followMeStepsBody = document.getElementById('followMeStepsBody');
                if (followMeStepsBody) {
                    followMeStepsBody.innerHTML = '';
                    // отрисуем сохранённые шаги если есть
                    let savedSteps = user.follow_me_steps;
                    if (typeof savedSteps === 'string') {
                        try { savedSteps = JSON.parse(savedSteps); } catch(e) { savedSteps = []; }
                    }
                    if (Array.isArray(savedSteps) && savedSteps.length) {
                        savedSteps.forEach((s) => {
                            addFollowMeStepRow();
                            const lastRow = followMeStepsBody.lastElementChild;
                            if (!lastRow) return;
                            const ringsInput = lastRow.querySelector('.fm-rings');
                            if (ringsInput && s.rings) ringsInput.value = Math.max(1, Math.min(20, parseInt(s.rings, 10)));
                            const container = lastRow.querySelector('.fm-numbers');
                            const addBtn = lastRow.querySelector('.fm-add');
                            // первый селект
                            const firstSel = container.querySelector('select.fm-select');
                            if (firstSel) {
                                firstSel.value = s.numbers?.[0] || '';
                                addBtn.disabled = !firstSel.value;
                            }
                            // остальные селекты
                            if (Array.isArray(s.numbers)) {
                                for (let i = 1; i < s.numbers.length; i++) {
                                    const selects = Array.from(container.querySelectorAll('select.fm-select'));
                                    const exclude = selects.length ? selects[selects.length-1].value : '';
                                    const newSel = document.createElement('select');
                                    newSel.className = 'fm-select';
                                    newSel.innerHTML = buildUserNumbersOptions(exclude, true);
                                    container.insertBefore(newSel, addBtn);
                                    newSel.value = s.numbers[i];
                                    addBtn.disabled = !newSel.value;
                                }
                            }
                        });
                        const addStepBtn = document.getElementById('addFollowMeStepBtn');
                        if (addStepBtn) addStepBtn.style.display = (followMeStepsBody.children.length >= 2) ? 'none' : 'inline';
                    } else {
                        const addStepBtn = document.getElementById('addFollowMeStepBtn');
                        if (addStepBtn) addStepBtn.style.display = 'inline';
                    }
                }
                
                // Заполняем чекбоксы ролей
                document.getElementById('roleAdmin').checked = user.is_admin || false;
                document.getElementById('roleEmployee').checked = user.is_employee || false;
                document.getElementById('roleMarketer').checked = user.is_marketer || false;
                document.getElementById('roleSpec1').checked = user.is_spec1 || false;
                document.getElementById('roleSpec2').checked = user.is_spec2 || false;
                
                // Применяем логику ролей после заполнения
                if (user.is_admin) {
                    const otherRoles = ['roleEmployee', 'roleMarketer', 'roleSpec1', 'roleSpec2'];
                    otherRoles.forEach(roleId => {
                        document.getElementById(roleId).disabled = true;
                    });
                } else {
                    const otherRoles = ['roleEmployee', 'roleMarketer', 'roleSpec1', 'roleSpec2'];
                    otherRoles.forEach(roleId => {
                        document.getElementById(roleId).disabled = false;
                    });
                }
                
                document.getElementById('deleteUserBtn').style.display = 'inline-block';
                openModal(createUserModal);

             } catch (error) {
                 alert(error.message);
                 console.error("Ошибка при открытии модального окна для редактирования:", error);
             }
         };
         
         createUserForm.onsubmit = async (e) => {
            e.preventDefault();

            // --- Валидация номеров ---
            const personalPhoneInput = document.getElementById('userPersonalPhone');
            const personalPhoneNumber = iti.getNumber();
            
            if (personalPhoneNumber && !validatePhoneNumber(personalPhoneNumber)) {
                alert(`Ошибка: Внешний номер телефона "${personalPhoneNumber}" введен некорректно. Пожалуйста, проверьте формат.`);
                personalPhoneInput.focus();
                return;
            }

            const internalPhoneInputs = Array.from(document.querySelectorAll('#internalNumbersList input[name=\"internal_phones\"]'));
            for (const input of internalPhoneInputs) {
                if (input.value && !validatePhoneNumber(input.value)) {
                    alert(`Ошибка: Один из внутренних номеров "${input.value}" введен некорректно. Пожалуйста, проверьте формат.`);
                    return; // Прерываем сохранение
                }
            }
            // --- Конец валидации ---

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.personal_phone = iti.getNumber();
            data.internal_phones = formData.getAll('internal_phones');
            
            // Добавляем значения чекбоксов ролей (так как unchecked checkbox не попадает в FormData)
            data.is_admin = document.getElementById('roleAdmin').checked;
            data.is_employee = document.getElementById('roleEmployee').checked;
            data.is_marketer = document.getElementById('roleMarketer').checked;
            data.is_spec1 = document.getElementById('roleSpec1').checked;
            data.is_spec2 = document.getElementById('roleSpec2').checked;

            // Follow Me
            const fmNum = document.getElementById('followMeNumber');
            const fmEnabled = document.getElementById('followMeEnabled');
            data.follow_me_number = fmNum && fmNum.value ? parseInt(fmNum.value, 10) : null;
            data.follow_me_enabled = fmEnabled ? fmEnabled.checked : false;

            // Follow Me steps -> собираем JSON
            const stepsTbody = document.getElementById('followMeStepsBody');
            if (stepsTbody && stepsTbody.children.length > 0) {
                const steps = [];
                Array.from(stepsTbody.children).forEach((tr, idx) => {
                    const rings = parseInt(tr.querySelector('.fm-rings')?.value || '3', 10);
                    const numbers = Array.from(tr.querySelectorAll('.fm-select')).map(s => s.value).filter(Boolean);
                    if (numbers.length > 0) {
                        steps.push({ step: idx + 1, rings: Math.max(1, Math.min(20, rings)), numbers });
                    }
                });
                data.follow_me_steps = steps.length ? steps : null;
            } else {
                data.follow_me_steps = null;
            }
            // Авто-отключение Follow Me при отсутствии шагов
            if (!data.follow_me_steps) {
                data.follow_me_enabled = false;
                if (fmEnabled) fmEnabled.checked = false;
            }
            
            const url = currentEditingUser ? `/enterprise/${enterpriseNumber}/users/${currentEditingUser.id}` : `/enterprise/${enterpriseNumber}/users`;
            const method = currentEditingUser ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Ошибка HTTP ${response.status}`);
                }
                closeModal(createUserModal);
                await fetchUsers();
            } catch (error) {
                alert(`Не удалось сохранить пользователя: ${error.message}`);
            }
        };

        // Удалён альтернативный обработчик на кнопку "Сохранить".
        // Оставляем единственный источник отправки — onsubmit формы.

        // Удалён делегированный обработчик, чтобы не дублировать отправку.

        const deleteUser = async () => {
            if (!currentEditingUser) return;

            const lastName = document.getElementById('userLastName').value;
            const firstName = document.getElementById('userFirstName').value;
            const displayName = `${lastName} ${firstName}`.trim() || 'этого пользователя';

            if (!confirm(`Вы уверены, что хотите удалить ${displayName}?`)) return;

            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/users/${currentEditingUser.id}`, { method: 'DELETE' });
                
                if (response.ok) { // Status 204 No Content
                    closeModal(createUserModal);
                    await fetchUsers();
                    alert('Пользователь успешно удален.');
                } else {
                    const errorData = await response.json().catch(() => null);
                    const errorMessage = errorData?.detail || `Произошла ошибка (HTTP ${response.status})`;
                    alert(errorMessage);
                }
            } catch(e) { 
                console.error("Ошибка при удалении пользователя:", e);
                alert(`Не удалось выполнить операцию: ${e.message}`); 
            }
        };

        // --- Line Modal Logic ---
        const openCreateLineModal = async () => {
            createLineForm.reset();
            openModal(createLineModal);
            try {
                const res = await fetch(`/enterprise/${enterpriseNumber}/internal-phones/next-available`);
                if(!res.ok) throw new Error();
                createLineForm.elements.phone_number.value = (await res.json()).next_number;
            } catch (e) { createLineForm.elements.phone_number.value = 'Ошибка'; }
            createLineForm.elements.password.value = Math.random().toString(36).slice(-8);
        };
        
        createLineForm.onsubmit = async(e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            try {
                const res = await fetch(`/enterprise/${enterpriseNumber}/internal-phones`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if(!res.ok) throw new Error(await res.text());

                // Invalidate cache to force refetch of all lines
                allLinesCache = null; 
                
                // Close current "Create Line" modal
                closeModal(createLineModal);

                // Conditionally reopen the select lines modal
                if (returnToSelectLinesModalAfterCreation) {
                    await openSelectLinesModal();
                }
                
                // Refresh the main user table in the background as well, so it shows the new unassigned line
                fetchUsers(); 

            } catch(e) { alert(`Ошибка создания линии: ${e.message}`); }
        };

        const openSelectLinesModal = async () => {
            openModal(selectLinesModal);
            selectLinesTableBody.innerHTML = '<tr><td colspan="3">Загрузка...</td></tr>';
            try {
                if (!allLinesCache) {
                    const response = await fetch(`/enterprise/${enterpriseNumber}/internal-phones/all`);
                    if(!response.ok) throw new Error('Failed to fetch');
                    allLinesCache = await response.json();
                }
                renderSelectLinesTable();
            } catch (e) {
                selectLinesTableBody.innerHTML = '<tr><td colspan="3">Ошибка загрузки.</td></tr>';
            }
        };

        const renderSelectLinesTable = () => {
            const numFilter = document.getElementById('filterLineNumber').value.toLowerCase();
            const managerFilter = document.getElementById('filterLineManager').value.toLowerCase();
            const selectedPhones = new Set(Array.from(createUserForm.querySelectorAll('[name="internal_phones"]') || []).map(i => i.value));
            
            selectLinesTableBody.innerHTML = '';
            (allLinesCache || [])
                .filter(line => line.phone_number.toLowerCase().includes(numFilter) && (line.manager_name || '').toLowerCase().includes(managerFilter))
                .forEach(line => {
                    const isChecked = selectedPhones.has(line.phone_number);
                    selectLinesTableBody.insertRow().innerHTML = `<td><input type="checkbox" value="${line.phone_number}" ${isChecked ? 'checked' : ''}></td><td>${line.phone_number}</td><td>${line.manager_name || ''}</td>`;
                });
        };
        document.getElementById('filterLineNumber').addEventListener('input', renderSelectLinesTable);
        document.getElementById('filterLineManager').addEventListener('input', renderSelectLinesTable);

        const confirmLineSelection = () => {
            const listContainer = document.getElementById('internalNumbersList');
            listContainer.innerHTML = '';
            selectLinesTableBody.querySelectorAll('input:checked').forEach(checkbox => {
                listContainer.innerHTML += `<div><input type="hidden" name="internal_phones" value="${checkbox.value}">${checkbox.value}</div>`;
            });
            closeModal(selectLinesModal);
        };

        // --- Функция для проверки статуса GSM линий (IP адреса) ---
        const fetchGsmLinesStatus = async () => {
            try {
                console.log('🔍 [IP] Начинаем проверку статуса GSM линий...');
                const statusUrl = `/enterprise/${enterpriseNumber}/gsm-lines/status`;
                console.log('🌐 [IP] Отправляем запрос к:', statusUrl);
                
                const response = await fetch(statusUrl);
                console.log('📡 [IP] Статус ответа:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`Ошибка получения статуса: ${response.status}`);
                }
                const statusData = await response.json();
                console.log('📊 [IP] Получен статус GSM линий:', statusData);
                console.log('📈 [IP] Количество линий в ответе:', Object.keys(statusData).length);
                
                // Обновляем IP адреса в таблице
                let onlineCount = 0;
                let offlineCount = 0;
                
                Object.values(statusData).forEach(lineStatus => {
                    const row = document.querySelector(`tr[data-line-gsm-id="${lineStatus.line_id}"]`);
                    console.log(`🔎 [IP] Обрабатываем линию ${lineStatus.line_id}, статус: ${lineStatus.status}, IP: ${lineStatus.ip_address}`);
                    
                    if (row) {
                        const ipCell = row.cells[1]; // Столбец IP (индекс 1)
                        if (lineStatus.status === 'online' && lineStatus.ip_address) {
                            ipCell.innerHTML = `<span class="ip-online">${lineStatus.ip_address}</span>`;
                            console.log(`✅ [IP] Линия ${lineStatus.line_id} онлайн: ${lineStatus.ip_address}`);
                            onlineCount++;
                        } else {
                            ipCell.innerHTML = `<span class="ip-offline">Офлайн</span>`;
                            console.log(`❌ [IP] Линия ${lineStatus.line_id} офлайн`);
                            offlineCount++;
                        }
                    } else {
                        console.warn(`⚠️ [IP] Не найдена строка для линии ${lineStatus.line_id}`);
                    }
                });
                
                console.log(`📊 [IP] Итого: онлайн ${onlineCount}, офлайн ${offlineCount}`);
                console.log('✅ [IP] Проверка IP статуса завершена');
                
            } catch (error) {
                console.error('💥 [IP] Критическая ошибка при получении статуса GSM линий:', error);
                console.error('💥 [IP] Stack trace:', error.stack);
                // Показываем "Проверка..." для всех линий при ошибке
                document.querySelectorAll('tr[data-line-gsm-id] td:nth-child(2)').forEach(cell => {
                    cell.innerHTML = '<span class="ip-offline">Ошибка</span>';
                });
            }
        };

        // --- Функция для проверки GoIP слотов ---
        const fetchGoipSlots = async () => {
            try {
                console.log('🔍 [GoIP] Начинаем запрос данных GoIP слотов...');
                
                // Сначала получаем список активных устройств предприятия
                const devicesUrl = `/goip/enterprise/${enterpriseNumber}/devices`;
                console.log('🌐 [GoIP] Запрашиваем устройства предприятия:', devicesUrl);
                
                const devicesResponse = await fetch(devicesUrl);
                if (!devicesResponse.ok) {
                    console.error('❌ [GoIP] Ошибка получения устройств:', devicesResponse.status, devicesResponse.statusText);
                    throw new Error(`Ошибка получения устройств: ${devicesResponse.status}`);
                }
                
                const devicesData = await devicesResponse.json();
                const devices = devicesData.devices || [];
                console.log('📱 [GoIP] Найдено устройств:', devices.length, devices.map(d => d.gateway_name));
                
                if (devices.length === 0) {
                    console.warn('⚠️ [GoIP] Нет активных устройств для предприятия');
                    throw new Error('Нет активных устройств');
                }
                
                // Получаем данные линий со всех устройств
                const allLinesPromises = devices.map(device => {
                    const linesUrl = `/goip/devices/${device.gateway_name}/lines`;
                    console.log(`🌐 [GoIP] Запрашиваем линии устройства ${device.gateway_name}:`, linesUrl);
                    return fetch(linesUrl).then(response => {
                        if (!response.ok) {
                            console.error(`❌ [GoIP] Ошибка для устройства ${device.gateway_name}:`, response.status);
                            return [];
                        }
                        return response.json().then(lines => {
                            console.log(`📊 [GoIP] Устройство ${device.gateway_name}: получено ${lines.length} линий`);
                            return lines;
                        });
                    }).catch(error => {
                        console.error(`💥 [GoIP] Ошибка запроса к ${device.gateway_name}:`, error);
                        return [];
                    });
                });
                
                const allLinesArrays = await Promise.all(allLinesPromises);
                const goipLines = allLinesArrays.flat();
                console.log('📊 [GoIP] Получены данные GoIP со всех устройств:', goipLines.length, 'линий');
                console.log('📈 [GoIP] Количество линий в ответе:', goipLines.length);
                
                // Получаем все строки таблицы с GSM линиями
                const rows = document.querySelectorAll('tr[data-line-gsm-id]');
                console.log('📋 [GoIP] Найдено строк в таблице:', rows.length);
                
                // Обрабатываем каждую строку
                let foundCount = 0;
                let notFoundCount = 0;
                
                rows.forEach((row, index) => {
                    const lineGsmId = row.getAttribute('data-line-gsm-id');
                    const carrierCell = row.cells[8]; // Столбец "Оператор" (индекс 8)
                    const levelCell = row.cells[9]; // Столбец "Уровень" (индекс 9)
                    const slotCell = row.cells[10]; // Столбец "Слот" (индекс 10)
                    const forwardCell = row.cells[11]; // Столбец "Переадр." (индекс 11)
                    
                    console.log(`🔎 [GoIP] Обрабатываем строку ${index + 1}: lineGsmId="${lineGsmId}"`);
                    
                    // Ищем линию по auth_id (который соответствует line_gsm_id)
                    const goipLine = goipLines.find(line => line.auth_id === lineGsmId);
                    
                    if (goipLine) {
                        // Обновляем информацию об операторе
                        if (goipLine.carrier && goipLine.carrier.trim() !== '') {
                            carrierCell.innerHTML = `<span style="color: #007bff; font-weight: bold;">${goipLine.carrier}</span>`;
                            console.log(`📡 [GoIP] Оператор для линии ${lineGsmId}: ${goipLine.carrier}`);
                        } else {
                            carrierCell.innerHTML = `<span style="color: #6c757d;">—</span>`;
                        }
                        // Обновляем уровень сигнала RSSI
                        if (goipLine.rssi && goipLine.rssi.trim() !== '' && goipLine.rssi !== 'null') {
                            const rssiValue = parseInt(goipLine.rssi);
                            let rssiColor = '#6c757d'; // По умолчанию серый
                            let rssiText = goipLine.rssi;
                            
                            if (!isNaN(rssiValue)) {
                                if (rssiValue >= 19 && rssiValue <= 31) {
                                    rssiColor = '#28a745'; // Зеленый для отличного сигнала (19-31)
                                } else if (rssiValue >= 14 && rssiValue <= 18) {
                                    rssiColor = '#ffc107'; // Желтый для среднего сигнала (14-18)
                                } else if (rssiValue >= 1 && rssiValue <= 13) {
                                    rssiColor = '#dc3545'; // Красный для слабого сигнала (1-13)
                                }
                                rssiText = rssiValue.toString();
                            }
                            
                            levelCell.innerHTML = `<span style="color: ${rssiColor}; font-weight: bold;">${rssiText}</span>`;
                            console.log(`📶 [GoIP] RSSI для линии ${lineGsmId}: ${rssiText} (цвет: ${rssiColor})`);
                        } else {
                            levelCell.innerHTML = `<span style="color: #6c757d;">—</span>`;
                        }
                        
                        // Заменяем песочные часы на номер линии из GoIP
                        slotCell.innerHTML = `<span style="color: #28a745; font-weight: bold;">${goipLine.line}</span>`;
                        
                        // Обновляем переадресацию
                        if (goipLine.call_forward_busy && goipLine.call_forward_busy.trim() !== '') {
                            // Очищаем номер от лишних символов
                            let forwardNumber = goipLine.call_forward_busy.replace(/&nbsp;/g, '').trim();
                            if (forwardNumber && forwardNumber !== 'OFF' && forwardNumber !== 'Not Set') {
                                // Добавляем + если его нет для корректного форматирования
                                if (!forwardNumber.startsWith('+')) {
                                    forwardNumber = '+' + forwardNumber;
                                }
                                // Форматируем номер согласно международному стандарту
                                const formattedNumber = formatPhoneNumber(forwardNumber);
                                forwardCell.innerHTML = `<span style="color: #007bff; font-weight: bold;">${formattedNumber}</span>`;
                                console.log(`📞 [GoIP] Переадресация для линии ${lineGsmId}: ${formattedNumber}`);
                            } else {
                                forwardCell.innerHTML = `<span style="color: #6c757d;">—</span>`;
                            }
                        } else {
                            forwardCell.innerHTML = `<span style="color: #6c757d;">—</span>`;
                        }
                        
                        console.log(`✅ [GoIP] Найдена линия ${lineGsmId} в слоте ${goipLine.line}`);
                        foundCount++;
                    } else {
                        // Заменяем песочные часы на "—" если линия не найдена
                        carrierCell.innerHTML = `<span style="color: #dc3545;">—</span>`;
                        levelCell.innerHTML = `<span style="color: #dc3545;">—</span>`;
                        slotCell.innerHTML = `<span style="color: #dc3545;">—</span>`;
                        forwardCell.innerHTML = `<span style="color: #dc3545;">—</span>`;
                        console.log(`❌ [GoIP] Линия ${lineGsmId} НЕ найдена в GoIP`);
                        notFoundCount++;
                    }
                });
                
                console.log(`📊 [GoIP] Итого: найдено ${foundCount}, не найдено ${notFoundCount}`);
                console.log('✅ [GoIP] Обработка GoIP слотов завершена');
                
            } catch (error) {
                console.error('💥 [GoIP] Критическая ошибка при получении данных GoIP:', error);
                console.error('💥 [GoIP] Stack trace:', error.stack);
                // Заменяем песочные часы на "?" для всех операторов, уровней, слотов и переадресации при ошибке
                document.querySelectorAll('tr[data-line-gsm-id] td:nth-child(9)').forEach(cell => {
                    cell.innerHTML = '<span style="color: #ffc107;">?</span>';
                });
                document.querySelectorAll('tr[data-line-gsm-id] td:nth-child(10)').forEach(cell => {
                    cell.innerHTML = '<span style="color: #ffc107;">?</span>';
                });
                document.querySelectorAll('tr[data-line-gsm-id] td:nth-child(11)').forEach(cell => {
                    cell.innerHTML = '<span style="color: #ffc107;">?</span>';
                });
                document.querySelectorAll('tr[data-line-gsm-id] td:nth-child(12)').forEach(cell => {
                    cell.innerHTML = '<span style="color: #ffc107;">?</span>';
                });
            }
        };

        // --- Функция для обновления GoIP данных конкретного устройства ---
        const refreshDeviceGoipData = async (deviceName) => {
            try {
                console.log(`🔄 [REFRESH-GOIP] Обновляем GoIP данные для устройства ${deviceName}`);
                
                // Получаем данные линий для конкретного устройства
                const linesUrl = `/goip/devices/${deviceName}/lines`;
                console.log(`🌐 [REFRESH-GOIP] Запрашиваем линии устройства ${deviceName}:`, linesUrl);
                
                const response = await fetch(linesUrl, {
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                if (!response.ok) {
                    console.error(`❌ [REFRESH-GOIP] Ошибка для устройства ${deviceName}:`, response.status);
                    throw new Error(`Ошибка получения данных устройства: ${response.status}`);
                }
                
                const goipLines = await response.json();
                console.log(`📊 [REFRESH-GOIP] Устройство ${deviceName}: получено ${goipLines.length} линий`);
                
                // Находим все строки таблицы, принадлежащие этому устройству
                const deviceSection = document.querySelector(`#device-info-${deviceName}`).closest('div').nextElementSibling;
                const rows = deviceSection.querySelectorAll('tr[data-line-gsm-id]');
                
                console.log(`📋 [REFRESH-GOIP] Найдено строк для устройства ${deviceName}:`, rows.length);
                
                // Обрабатываем каждую строку этого устройства
                let foundCount = 0;
                let notFoundCount = 0;
                
                rows.forEach((row, index) => {
                    const lineGsmId = row.getAttribute('data-line-gsm-id');
                    const carrierCell = row.cells[8]; // Столбец "Оператор" (индекс 8)
                    const levelCell = row.cells[9]; // Столбец "Уровень" (индекс 9)
                    const slotCell = row.cells[10]; // Столбец "Слот" (индекс 10)
                    const forwardCell = row.cells[11]; // Столбец "Переадр." (индекс 11)
                    
                    console.log(`🔎 [REFRESH-GOIP] Обрабатываем строку ${index + 1} устройства ${deviceName}: lineGsmId="${lineGsmId}"`);
                    
                    // Ищем линию по auth_id (который соответствует line_gsm_id)
                    const goipLine = goipLines.find(line => line.auth_id === lineGsmId);
                    
                    if (goipLine) {
                        // Обновляем информацию об операторе
                        if (goipLine.carrier && goipLine.carrier.trim() !== '') {
                            carrierCell.innerHTML = `<span style="color: #007bff; font-weight: bold;">${goipLine.carrier}</span>`;
                            console.log(`📡 [REFRESH-GOIP] Оператор для линии ${lineGsmId}: ${goipLine.carrier}`);
                        } else {
                            carrierCell.innerHTML = `<span style="color: #6c757d;">—</span>`;
                        }
                        // Обновляем уровень сигнала RSSI
                        if (goipLine.rssi && goipLine.rssi.trim() !== '' && goipLine.rssi !== 'null') {
                            const rssiValue = parseInt(goipLine.rssi);
                            let rssiColor = '#6c757d'; // По умолчанию серый
                            let rssiText = goipLine.rssi;
                            
                            if (!isNaN(rssiValue)) {
                                if (rssiValue >= 19 && rssiValue <= 31) {
                                    rssiColor = '#28a745'; // Зеленый для отличного сигнала (19-31)
                                } else if (rssiValue >= 14 && rssiValue <= 18) {
                                    rssiColor = '#ffc107'; // Желтый для среднего сигнала (14-18)
                                } else if (rssiValue >= 1 && rssiValue <= 13) {
                                    rssiColor = '#dc3545'; // Красный для слабого сигнала (1-13)
                                }
                                rssiText = rssiValue.toString();
                            }
                            
                            levelCell.innerHTML = `<span style="color: ${rssiColor}; font-weight: bold;">${rssiText}</span>`;
                            console.log(`📶 [REFRESH-GOIP] RSSI для линии ${lineGsmId}: ${rssiText} (цвет: ${rssiColor})`);
                        } else {
                            levelCell.innerHTML = `<span style="color: #6c757d;">—</span>`;
                        }
                        
                        // Обновляем номер слота
                        slotCell.innerHTML = `<span style="color: #28a745; font-weight: bold;">${goipLine.line}</span>`;
                        
                        // Обновляем переадресацию
                        if (goipLine.call_forward_busy && goipLine.call_forward_busy.trim() !== '') {
                            // Очищаем номер от лишних символов
                            let forwardNumber = goipLine.call_forward_busy.replace(/&nbsp;/g, '').trim();
                            if (forwardNumber && forwardNumber !== 'OFF' && forwardNumber !== 'Not Set') {
                                // Добавляем + если его нет для корректного форматирования
                                if (!forwardNumber.startsWith('+')) {
                                    forwardNumber = '+' + forwardNumber;
                                }
                                // Форматируем номер согласно международному стандарту
                                const formattedNumber = formatPhoneNumber(forwardNumber);
                                forwardCell.innerHTML = `<span style="color: #007bff; font-weight: bold;">${formattedNumber}</span>`;
                                console.log(`📞 [REFRESH-GOIP] Переадресация для линии ${lineGsmId}: ${formattedNumber}`);
                            } else {
                                forwardCell.innerHTML = `<span style="color: #6c757d;">—</span>`;
                            }
                        } else {
                            forwardCell.innerHTML = `<span style="color: #6c757d;">—</span>`;
                        }
                        
                        console.log(`✅ [REFRESH-GOIP] Найдена линия ${lineGsmId} в слоте ${goipLine.line}`);
                        foundCount++;
                    } else {
                        // Заменяем на "—" если линия не найдена
                        carrierCell.innerHTML = `<span style="color: #dc3545;">—</span>`;
                        levelCell.innerHTML = `<span style="color: #dc3545;">—</span>`;
                        slotCell.innerHTML = `<span style="color: #dc3545;">—</span>`;
                        forwardCell.innerHTML = `<span style="color: #dc3545;">—</span>`;
                        console.log(`❌ [REFRESH-GOIP] Линия ${lineGsmId} НЕ найдена в GoIP`);
                        notFoundCount++;
                    }
                });
                
                console.log(`📊 [REFRESH-GOIP] Устройство ${deviceName}: найдено ${foundCount}, не найдено ${notFoundCount}`);
                console.log(`✅ [REFRESH-GOIP] Обновление GoIP данных для устройства ${deviceName} завершено`);
                
            } catch (error) {
                console.error(`💥 [REFRESH-GOIP] Критическая ошибка при обновлении GoIP данных для устройства ${deviceName}:`, error);
                throw error; // Пробрасываем ошибку дальше для обработки в основном обработчике
            }
        };

        // --- Функция для получения информации об устройствах ---
        const updateDeviceInfo = async () => {
            try {
                console.log('🔍 [INFO] Начинаем получение информации об устройствах...');
                console.log('🌍 [INFO] Текущий URL:', window.location.href);
                console.log('🏢 [INFO] Enterprise Number:', enterpriseNumber);
                
                // Получаем список активных устройств предприятия
                const devicesUrl = `/goip/enterprise/${enterpriseNumber}/devices`;
                console.log('🌐 [INFO] Запрашиваем устройства предприятия:', devicesUrl);
                
                const devicesResponse = await fetch(devicesUrl);
                if (!devicesResponse.ok) {
                    console.error('❌ [INFO] Ошибка получения устройств:', devicesResponse.status);
                    throw new Error(`Ошибка получения устройств: ${devicesResponse.status}`);
                }
                
                const devicesData = await devicesResponse.json();
                const devices = devicesData.devices || [];
                console.log('📱 [INFO] Найдено устройств:', devices.length, devices.map(d => d.gateway_name));
                
                if (devices.length === 0) {
                    console.warn('⚠️ [INFO] Нет активных устройств для предприятия');
                    return;
                }
                
                // Получаем информацию о каждом устройстве
                const deviceInfoPromises = devices.map(async device => {
                    try {
                        const infoUrl = `/goip/devices/${device.gateway_name}/info`;
                        console.log(`🌐 [INFO] Запрашиваем информацию об устройстве ${device.gateway_name}:`, infoUrl);
                        
                        const response = await fetch(infoUrl, {
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                        console.log(`📡 [INFO] Ответ для ${device.gateway_name}: status=${response.status}, ok=${response.ok}`);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`❌ [INFO] Ошибка для устройства ${device.gateway_name}:`, response.status, errorText);
                            return { device: device.gateway_name, error: true, status: response.status, errorText };
                        }
                        
                        const info = await response.json();
                        console.log(`📊 [INFO] Устройство ${device.gateway_name}:`, info);
                        return { device: device.gateway_name, info };
                        
                    } catch (error) {
                        console.error(`💥 [INFO] Ошибка запроса к ${device.gateway_name}:`, error);
                        return { device: device.gateway_name, error: true, errorMessage: error.message };
                    }
                });
                
                const deviceInfoResults = await Promise.all(deviceInfoPromises);
                console.log('📊 [INFO] Получены данные об устройствах:', deviceInfoResults.length);
                
                // Обновляем информацию в заголовках таблиц
                deviceInfoResults.forEach(result => {
                    console.log(`🔧 [INFO] Обрабатываем результат для ${result.device}:`, result);
                    const elementId = `device-info-${result.device}`;
                    const infoElement = document.getElementById(elementId);
                    console.log(`🎯 [INFO] Ищем элемент с ID "${elementId}":`, infoElement ? 'найден' : 'НЕ НАЙДЕН');
                    
                    // Дополнительная диагностика - проверим все элементы с device-info
                    const allDeviceInfoElements = document.querySelectorAll('[id^="device-info-"]');
                    console.log(`🔍 [INFO] Всего элементов device-info найдено:`, allDeviceInfoElements.length);
                    allDeviceInfoElements.forEach(el => console.log(`  - ${el.id}`));
                    
                    if (infoElement) {
                        if (result.error) {
                            let errorText = 'Ошибка получения данных';
                            if (result.status) errorText += ` (${result.status})`;
                            if (result.errorText) errorText += `: ${result.errorText}`;
                            if (result.errorMessage) errorText += `: ${result.errorMessage}`;
                            infoElement.innerHTML = `<span style="color: #dc3545;">${errorText}</span>`;
                            console.log(`❌ [INFO] Установлена ошибка для ${result.device}: ${errorText}`);
                        } else if (result.info) {
                            let infoText = '';
                            if (result.info.serial_number) {
                                infoText += `SN: ${result.info.serial_number}`;
                            }
                            if (result.info.uptime) {
                                if (infoText) infoText += ' | ';
                                infoText += `Uptime: ${result.info.uptime}`;
                            }
                            
                            if (infoText) {
                                infoElement.innerHTML = infoText;
                                console.log(`✅ [INFO] Обновлена информация для ${result.device}: ${infoText}`);
                            } else {
                                infoElement.innerHTML = '<span style="color: #6c757d;">Нет данных</span>';
                                console.log(`⚠️ [INFO] Нет данных для отображения для ${result.device}`);
                            }
                        } else {
                            console.log(`⚠️ [INFO] Нет info и нет error для ${result.device}`);
                        }
                    }
                });
                
                console.log('✅ [INFO] Обновление информации об устройствах завершено');
                
                // Тест прямого запроса для диагностики
                console.log('🧪 [INFO] Тестируем прямой запрос к Vochi-Main...');
                try {
                    const testResponse = await fetch('/goip/devices/Vochi-Main/info', {
                        headers: { 'Cache-Control': 'no-cache' }
                    });
                    console.log('🧪 [TEST] Прямой запрос к Vochi-Main:', testResponse.status, testResponse.ok);
                    if (testResponse.ok) {
                        const testData = await testResponse.json();
                        console.log('🧪 [TEST] Данные Vochi-Main:', testData);
                    } else {
                        const testError = await testResponse.text();
                        console.log('🧪 [TEST] Ошибка Vochi-Main:', testError);
                    }
                } catch (testErr) {
                    console.log('🧪 [TEST] Исключение при тесте Vochi-Main:', testErr);
                }
                
            } catch (error) {
                console.error('💥 [INFO] Критическая ошибка при получении информации об устройствах:', error);
                // Обновляем все элементы информации об устройствах на "Ошибка"
                document.querySelectorAll('[id^="device-info-"]').forEach(element => {
                    element.innerHTML = '<span style="color: #dc3545;">Ошибка</span>';
                });
            }
        };

        // --- GSM Lines Logic ---
        document.getElementById('btn-gsm-lines').addEventListener('click', async () => {
            const modal = document.getElementById('gsmLinesModal');
            const container = document.getElementById('gsmLinesTableContainer');
            container.innerHTML = '<div style="text-align:center;padding:2em;">Загрузка...</div>';
            modal.style.display = 'block';

            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/gsm-lines/all`);
                if (!response.ok) throw new Error('Ошибка загрузки данных');
                const gateways = await response.json();
                if (!Array.isArray(gateways) || gateways.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:2em;">Линии не найдены.</div>';
                    return;
                }
                // Сортировка шлюзов по минимальному line_id
                gateways.sort((a, b) => {
                    const minA = Math.min(...(a.lines || []).map(l => l.line_id || Infinity));
                    const minB = Math.min(...(b.lines || []).map(l => l.line_id || Infinity));
                    return minA - minB;
                });
                let html = '';
                gateways.forEach(gateway => {
                    if (!gateway.lines || gateway.lines.length === 0) return;
                    html += `<div style="margin-bottom:2em;">
                        <div class="table-secondary" style="padding:8px 0 8px 8px;font-size:1.1em; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span>${gateway.gateway_name}</span>
                                ${gateway.is_main ? '<span style="color: #dc3545; font-weight: bold; margin-left: 8px; font-size: 0.9em;">Main</span>' : ''}
                                <span id="device-info-${gateway.gateway_name}" style="font-size: 0.85em; color: #6c757d; font-weight: normal; margin-left: 15px;">
                                    Загрузка информации...
                                </span>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="refresh-device-btn" data-device-name="${gateway.gateway_name}" 
                                        style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
                                    🔄 Обновить
                                </button>
                                <button class="reboot-device-btn" data-device-name="${gateway.gateway_name}" 
                                        style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
                                    ⚡ Reboot
                                </button>
                            </div>
                        </div>
                        <table class="gsm-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Ip</th>
                                    <th>ID2</th>
                                    <th>Номер</th>
                                    <th>Наименование</th>
                                    <th>Пр</th>
                                    <th>Вх.сх</th>
                                    <th>Исх.схемы</th>
                                    <th>Оператор</th>
                                    <th>Ур</th>
                                    <th>Сл</th>
                                    <th>Переадресация</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    gateway.lines.forEach(line => {
                        const formattedPhoneNumber = formatDisplayNumber(line.phone_number || '');
                        const srEnabled = (line.smart && (line.smart.enabled === true || line.smart.enabled === 'true' || line.smart.enabled === 1 || line.smart.enabled === '1'));
                        const idStyle = srEnabled ? 'style="color:#28a745;font-weight:700;"' : '';
                        html += `<tr data-line-id="${line.id}" data-line-gsm-id="${line.line_id}">
                            <td class="edit-trigger" data-line-id="${line.id}" ${idStyle}>${line.line_id || ''}</td>
                            <td><span class="ip-offline">Проверка...</span></td>
                            <td>${line.internal_id || ''}</td>
                            <td>${formattedPhoneNumber}</td>
                            <td>${line.line_name || ''}</td>
                            <td>${line.prefix || ''}</td>
                            <td>${line.incoming_schema_name || ''}</td>
                            <td>${displayOutgoingSchemas(line.outgoing_schema_names)}</td>
                            <td>${line.shop || ''}</td>
                            <td><span class="slot-loading">⏳</span></td>
                            <td><span class="slot-loading">⏳</span></td>
                            <td><span class="slot-loading">⏳</span></td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                });
                container.innerHTML = html;
                
                // Добавляем обработчики для кнопок Обновить
                document.querySelectorAll('.refresh-device-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const deviceName = button.dataset.deviceName;
                        
                        console.log(`🔄 [REFRESH] Начинаем обновление информации для устройства ${deviceName}`);
                        
                        // Отключаем кнопку и показываем процесс
                        button.disabled = true;
                        button.innerHTML = '⏳ Обновляем...';
                        
                        try {
                            // Обновляем информацию об устройстве (серийник и uptime)
                            const infoElement = document.getElementById(`device-info-${deviceName}`);
                            if (infoElement) {
                                infoElement.innerHTML = 'Обновляем информацию...';
                                
                                const infoUrl = `/goip/devices/${deviceName}/info`;
                                const infoResponse = await fetch(infoUrl, {
                                    headers: { 'Cache-Control': 'no-cache' }
                                });
                                
                                if (infoResponse.ok) {
                                    const info = await infoResponse.json();
                                    let infoText = '';
                                    if (info.serial_number) {
                                        infoText += `SN: ${info.serial_number}`;
                                    }
                                    if (info.uptime) {
                                        if (infoText) infoText += ' | ';
                                        infoText += `Uptime: ${info.uptime}`;
                                    }
                                    infoElement.innerHTML = infoText || 'Нет данных';
                                    console.log(`✅ [REFRESH] Информация об устройстве ${deviceName} обновлена`);
                                } else {
                                    infoElement.innerHTML = '<span style="color: #dc3545;">Ошибка получения данных</span>';
                                    console.error(`❌ [REFRESH] Ошибка получения информации об устройстве ${deviceName}`);
                                }
                            }
                            
                            // Обновляем GoIP слоты (уровень, слот, переадресация) только для этого устройства
                            await refreshDeviceGoipData(deviceName);
                            
                            button.innerHTML = '✅ Обновлено';
                            button.style.background = '#28a745';
                            
                            // Через 2 секунды возвращаем кнопку в исходное состояние
                            setTimeout(() => {
                                button.disabled = false;
                                button.innerHTML = '🔄 Обновить';
                                button.style.background = '#28a745';
                            }, 2000);
                            
                        } catch (error) {
                            console.error(`💥 [REFRESH] Критическая ошибка при обновлении ${deviceName}:`, error);
                            
                            button.innerHTML = '❌ Ошибка';
                            button.style.background = '#6c757d';
                            
                            // Через 3 секунды возвращаем кнопку в исходное состояние
                            setTimeout(() => {
                                button.disabled = false;
                                button.innerHTML = '🔄 Обновить';
                                button.style.background = '#28a745';
                            }, 3000);
                        }
                    });
                });
                
                // Добавляем обработчики для кнопок Reboot
                document.querySelectorAll('.reboot-device-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const deviceName = button.dataset.deviceName;
                        
                        // Для безопасности тестирования разработчиком
                        if (deviceName !== 'Vochi-Main') {
                            console.warn(`🚨 [REBOOT] Попытка перезагрузки ${deviceName} (разрешено только для Vochi-Main в режиме разработки)`);
                        }
                        
                        // Подтверждение перезагрузки
                        const confirmReboot = confirm(`Вы уверены, что хотите перезагрузить устройство ${deviceName}?\n\nЭто приведет к временной недоступности всех линий устройства.`);
                        if (!confirmReboot) {
                            return;
                        }
                        
                        // Отключаем кнопку и показываем процесс
                        button.disabled = true;
                        button.innerHTML = '⏳ Перезагрузка...';
                        
                        try {
                            console.log(`🔄 [REBOOT] Запуск перезагрузки устройства ${deviceName}`);
                            
                            const rebootUrl = `/goip/devices/${deviceName}/reboot`;
                            const response = await fetch(rebootUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Cache-Control': 'no-cache'
                                }
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                console.log(`✅ [REBOOT] Успешная перезагрузка ${deviceName}:`, result);
                                
                                button.innerHTML = '✅ Перезагружен';
                                button.style.background = '#28a745';
                                
                                // Показываем уведомление
                                alert(`Устройство ${deviceName} успешно перезагружено!\n\nПожалуйста, подождите 1-2 минуты для полного восстановления работы.`);
                                
                                // Через 5 секунд возвращаем кнопку в исходное состояние
                                setTimeout(() => {
                                    button.disabled = false;
                                    button.innerHTML = '🔄 Reboot';
                                    button.style.background = '#dc3545';
                                }, 5000);
                                
                            } else {
                                const errorText = await response.text();
                                console.error(`❌ [REBOOT] Ошибка перезагрузки ${deviceName}:`, response.status, errorText);
                                
                                button.innerHTML = '❌ Ошибка';
                                button.style.background = '#6c757d';
                                
                                alert(`Ошибка при перезагрузке устройства ${deviceName}!\n\nСтатус: ${response.status}\nДетали: ${errorText}`);
                                
                                // Через 3 секунды возвращаем кнопку в исходное состояние
                                setTimeout(() => {
                                    button.disabled = false;
                                    button.innerHTML = '🔄 Reboot';
                                    button.style.background = '#dc3545';
                                }, 3000);
                            }
                            
                        } catch (error) {
                            console.error(`💥 [REBOOT] Критическая ошибка при перезагрузке ${deviceName}:`, error);
                            
                            button.innerHTML = '💥 Ошибка';
                            button.style.background = '#6c757d';
                            
                            alert(`Критическая ошибка при перезагрузке устройства ${deviceName}!\n\nОшибка: ${error.message}`);
                            
                            // Через 3 секунды возвращаем кнопку в исходное состояние
                            setTimeout(() => {
                                button.disabled = false;
                                button.innerHTML = '🔄 Reboot';
                                button.style.background = '#dc3545';
                            }, 3000);
                        }
                    });
                });
                
                // После загрузки данных запрашиваем статус линий и GoIP слоты
                console.log('🚀 [MAIN] Данные таблицы загружены, запрашиваем статус и GoIP слоты...');
                console.log('🔄 [MAIN] Запускаем параллельные запросы...');
                
                const startTime = performance.now();
                await Promise.all([
                    fetchGsmLinesStatus(),  // Проверка IP адресов через sip show peers
                    fetchGoipSlots(),       // Проверка слотов через GoIP сервис
                    updateDeviceInfo()      // Получение информации об устройствах
                ]);
                const endTime = performance.now();
                
                console.log(`⏱️ [MAIN] Все запросы завершены за ${Math.round(endTime - startTime)}ms`);
                
            } catch (e) {
                container.innerHTML = `<div style="text-align:center;padding:2em;color:red;">Ошибка: ${e.message}</div>`;
            }
        });

        // --- Открытие модалки редактирования линии ---
        document.getElementById('gsmLinesTableContainer').addEventListener('click', async function(event) {
            const trigger = event.target.closest('.edit-trigger');
            if (trigger) {
                event.preventDefault();
                const lineId = trigger.dataset.lineId;
                // Открываем модалку редактирования
                const container = document.getElementById('editLineModalContainer');
                container.innerHTML = '<div class="modal" id="editLineModal" style="display:block;z-index:2000;"><div class="modal-content" style="max-width:500px;margin:5% auto;padding:0;position:relative;">'+
                    '<div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;background:#e9ecef;border-bottom:1px solid #dee2e6;">'+
                    '<h2 id="editLineModalTitle" style="margin:0;font-size:1.25rem;font-weight:500;color:#343a40;">Редактирование линии <span id="editLineNumber"></span></h2>'+
                    '<span class="close-button" id="closeEditLineModal" style="color:#6c757d;font-size:1.75rem;font-weight:700;line-height:1;cursor:pointer;opacity:0.7;">&times;</span>'+
                    '</div>'+
                    '<div class="modal-body" style="padding:1.5rem;">'+
                    '<div id="editLineError" class="error-message" style="display:none;color:#721c24;background:#f8d7da;border:1px solid #f5c6cb;padding:0.75rem 1.25rem;margin-bottom:1rem;border-radius:0.25rem;"></div>'+
                    '<form id="editLineForm">'+
                    '<input type="hidden" id="editLineIdInput" name="id" value="'+lineId+'">'+
                    '<div class="form-group"><label for="editLineName">Наименование линии:</label><input type="text" id="editLineName" name="line_name" class="form-group" disabled></div>'+
                    '<div class="form-group"><label for="editLinePhone">Номер телефона:</label><input type="tel" id="editLinePhone" name="phone_number" class="form-group"></div>'+
                    '</form>'+
                    '<div class="form-group" style="margin-top:1rem;"><label>Префикс (prefix):</label> <span id="editLinePrefix" style="font-weight:500;"></span></div>'+
                    '<hr style="margin:1rem 0;" />'+
                    '<div style="font-weight:600;margin-bottom:0.5rem;">Умная переадресация</div>'+
                    '<div class="form-group" style="display:flex;align-items:center;gap:10px;margin-bottom:0.5rem;">'+
                        '<input type="checkbox" id="sr_enabled" />'+
                        '<label for="sr_enabled" style="margin:0;">Включить для этой линии</label>'+
                    '</div>'+
                    '<div class="form-group" style="margin-bottom:0.5rem;">'+
                        '<label for="sr_algorithm" style="display:block;margin-bottom:4px;">Алгоритм</label>'+
                        '<select id="sr_algorithm" class="form-group" style="width:100%;">'+
                            '<option value="">— выбрать —</option>'+
                            '<option value="retailcrm">RetailCRM</option>'+
                            '<option value="uon">U-ON.Travel</option>'+
                            '<option value="first_call">Первый звонок</option>'+
                            '<option value="last_call">Последний звонок</option>'+
                        '</select>'+
                    '</div>'+
                    '<div class="form-group">'+
                        '<div id="gsm_sr_options" style="display:grid;grid-template-columns:24px 160px 60px;row-gap:8px;column-gap:8px;align-items:center;">'+
                            '<input type="checkbox" id="sr_do_routing"/><span style="white-space:nowrap;">Маршрутизация</span><span></span>'+
                            '<input type="checkbox" id="sr_send_line_name"/><span style="white-space:nowrap;">Имя линии</span><select id="sr_line_name_order" style="width:60px;"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>'+
                            '<input type="checkbox" id="sr_send_customer_name"/><span style="white-space:nowrap;">Имя клиента</span><select id="sr_customer_name_order" style="width:60px;"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>'+
                            '<input type="checkbox" id="sr_send_shop_name"/><span style="white-space:nowrap;">Название магазина</span><select id="sr_shop_name_order" style="width:60px;"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>'+
                        '</div>'+
                    '</div>'+
                    '<div class="button-bar" style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:1.5rem;">'+
                    '<button type="submit" class="button btn btn-primary" form="editLineForm">Сохранить</button>'+
                    '<button type="button" class="button button-secondary btn btn-secondary" id="cancelEditLineModal">Отмена</button>'+
                    '</div></div></div></div>';
                // Инициализируем intlTelInput для поля номера GSM-линии
                let gsmIti = null;
                let mobilesData = null; // Кэш данных операторов
                
                // Загружаем данные операторов
                const loadMobilesData = async () => {
                    if (mobilesData) return mobilesData;
                    try {
                        // Используем эндпоинт основного сервиса
                        const response = await fetch('/admin/mobile/operators');
                        if (response.ok) {
                            mobilesData = await response.json();
                        } else {
                            console.error('Ошибка загрузки операторов:', response.status);
                        }
                    } catch (e) {
                        console.warn('Не удалось загрузить данные операторов:', e);
                    }
                    return mobilesData;
                };
                
                // Определение оператора по номеру телефона
                const determineOperator = (phoneNumber) => {
                    console.log('determineOperator called with:', phoneNumber);
                    console.log('mobilesData:', mobilesData);
                    
                    if (!mobilesData || !phoneNumber) {
                        console.log('No mobilesData or phoneNumber');
                        return '';
                    }
                    
                    // Убираем + и пробелы из номера
                    const cleanNumber = phoneNumber.replace(/[\s\+\-\(\)]/g, '');
                    console.log('cleanNumber:', cleanNumber);
                    
                    // Проверяем минимальную длину (6 символов)
                    if (cleanNumber.length < 6) {
                        console.log('Number too short, need at least 6 digits');
                        return '';
                    }
                    
                    // Сортируем операторов по длине шаблона (от более специфичных к менее специфичным)
                    const sortedMobiles = [...mobilesData].sort((a, b) => {
                        const aLength = a.shablon ? a.shablon.replace(/[\^\(\)\|]/g, '').length : 0;
                        const bLength = b.shablon ? b.shablon.replace(/[\^\(\)\|]/g, '').length : 0;
                        return bLength - aLength; // Сортировка по убыванию длины
                    });
                    
                    console.log('Sorted operators by specificity:', sortedMobiles.map(m => `${m.name}: ${m.shablon}`));
                    
                    for (const mobile of sortedMobiles) {
                        if (mobile.shablon) {
                            try {
                                const regex = new RegExp(mobile.shablon);
                                console.log(`Testing ${mobile.name} (${mobile.shablon}) against ${cleanNumber}:`, regex.test(cleanNumber));
                                if (regex.test(cleanNumber)) {
                                    console.log('Found operator:', mobile.name);
                                    return mobile.name;
                                }
                            } catch (e) {
                                console.warn('Ошибка в регулярном выражении:', mobile.shablon, e);
                            }
                        }
                    }
                    console.log('No operator found');
                    return '';
                };
                
                const initGsmIti = () => {
                    const phoneInput = document.getElementById('editLinePhone');
                    if (phoneInput && !gsmIti) {
                        gsmIti = window.intlTelInput(phoneInput, {
                            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/20.3.0/js/utils.js",
                            nationalMode: false,
                            separateDialCode: true,
                            initialCountry: "auto",
                            geoIpLookup: callback => {
                                fetch("https://ipapi.co/json")
                                    .then(res => res.json())
                                    .then(data => callback(data.country_code))
                                    .catch(() => callback("by"));
                            }
                        });
                        
                        // Обработчик изменения номера для автоматического определения оператора
                        phoneInput.addEventListener('input', () => {
                            setTimeout(() => {
                                const currentNumber = gsmIti.getNumber();
                                const operator = determineOperator(currentNumber);
                                const lineNameField = document.getElementById('editLineName');
                                const cleanNumber = currentNumber.replace(/[\s\+\-\(\)]/g, '');
                                
                                if (lineNameField) {
                                    if (operator) {
                                        // Всегда обновляем название оператора при изменении номера с пробелом в конце
                                        lineNameField.value = operator + ' ';
                                        lineNameField.disabled = false; // Активируем поле для редактирования
                                        console.log('Updated line name to:', operator + ' ');
                                    } else if (cleanNumber.length < 6) {
                                        // Очищаем поле и деактивируем, если номер слишком короткий
                                        lineNameField.value = '';
                                        lineNameField.disabled = true;
                                        console.log('Cleared line name - number too short');
                                    } else if (cleanNumber.length >= 6) {
                                        // Если номер достаточно длинный, но оператор не определен, активируем поле
                                        lineNameField.disabled = false;
                                        console.log('Enabled line name field - number long enough');
                                    }
                                }
                            }, 100);
                        });
                    }
                };
                
                // Загружаем данные операторов
                await loadMobilesData();
                
                    // Подгружаем данные линии
                try {
                    const resp = await fetch(`/enterprise/${enterpriseNumber}/gsm-lines/${lineId}`);
                    if (!resp.ok) throw new Error('Ошибка загрузки данных линии');
                    const line = await resp.json();
                    document.getElementById('editLineName').value = line.line_name || '';
                    document.getElementById('editLinePhone').value = line.phone_number || '';
                    document.getElementById('editLinePrefix').textContent = line.prefix || '';
                    document.getElementById('editLineNumber').textContent = formatDisplayNumber(line.phone_number || '');

                        // Smart Redirect настройки, если приходят из БД (из поля smart в enterprises.integrations_config или аналогичного места)
                        try {
                            if (line.smart && typeof line.smart === 'object') {
                                const s = line.smart;
                                const getBool = (v) => v === true || v === 'true' || v === 1 || v === '1';
                                document.getElementById('sr_enabled').checked = getBool(s.enabled);
                                document.getElementById('sr_algorithm').value = s.algorithm || '';
                                document.getElementById('sr_do_routing').checked = getBool(s.do_routing);
                                document.getElementById('sr_send_line_name').checked = getBool(s.send_line_name);
                                document.getElementById('sr_send_customer_name').checked = getBool(s.send_customer_name);
                                document.getElementById('sr_send_shop_name').checked = getBool(s.send_shop_name);
                            }
                        } catch(_) {}
                        // Функция для управления уникальностью позиций и состоянием селектов GSM
                        const enforceGsmOrders = () => {
                            const chkLine = document.getElementById('sr_send_line_name');
                            const chkCust = document.getElementById('sr_send_customer_name');
                            const chkShop = document.getElementById('sr_send_shop_name');
                            const selLine = document.getElementById('sr_line_name_order');
                            const selCust = document.getElementById('sr_customer_name_order');
                            const selShop = document.getElementById('sr_shop_name_order');

                            // Показываем/скрываем и включаем/выключаем селекты
                            if (selLine) {
                                selLine.style.visibility = chkLine && chkLine.checked ? 'visible' : 'hidden';
                                selLine.disabled = !chkLine || !chkLine.checked;
                            }
                            if (selCust) {
                                selCust.style.visibility = chkCust && chkCust.checked ? 'visible' : 'hidden';
                                selCust.disabled = !chkCust || !chkCust.checked;
                            }
                            if (selShop) {
                                selShop.style.visibility = chkShop && chkShop.checked ? 'visible' : 'hidden';
                                selShop.disabled = !chkShop || !chkShop.checked;
                            }

                            // Собираем активные селекты
                            const activeSelects = [];
                            if (chkLine && chkLine.checked && selLine) activeSelects.push(selLine);
                            if (chkCust && chkCust.checked && selCust) activeSelects.push(selCust);
                            if (chkShop && chkShop.checked && selShop) activeSelects.push(selShop);

                            // Сбрасываем блокировки
                            [selLine, selCust, selShop].forEach(s => {
                                if (!s) return;
                                Array.from(s.options).forEach(o => o.disabled = false);
                            });

                            // Применяем уникальность
                            activeSelects.forEach((currentSelect) => {
                                const usedValues = new Set(
                                    activeSelects.filter(s => s !== currentSelect).map(s => s.value)
                                );
                                Array.from(currentSelect.options).forEach(option => {
                                    option.disabled = usedValues.has(option.value);
                                });

                                // Если текущее значение уже занято, найдем свободное
                                if (usedValues.has(currentSelect.value)) {
                                    const availableValue = ['1', '2', '3'].find(v => !usedValues.has(v));
                                    if (availableValue) {
                                        currentSelect.value = availableValue;
                                    }
                                }
                            });
                        };

                        // Заполним порядок из сохраненных данных
                        const applyGsmOrdersFromData = () => {
                            const s = (line && line.smart) ? line.smart : {};
                            const ln = document.getElementById('sr_line_name_order');
                            const cn = document.getElementById('sr_customer_name_order');
                            const sn = document.getElementById('sr_shop_name_order');
                            if (ln && s && s.line_name_order) ln.value = String(s.line_name_order);
                            if (cn && s && s.customer_name_order) cn.value = String(s.customer_name_order);
                            if (sn && s && s.shop_name_order) sn.value = String(s.shop_name_order);
                        };

                        applyGsmOrdersFromData();
                        enforceGsmOrders();

                        // Добавляем обработчики событий
                        ['sr_send_line_name','sr_send_customer_name','sr_send_shop_name','sr_line_name_order','sr_customer_name_order','sr_shop_name_order'].forEach(id=>{
                            const el = document.getElementById(id);
                            if (el) el.addEventListener('change', enforceGsmOrders);
                        });
                    
                    // Инициализируем intlTelInput после заполнения данных
                    initGsmIti();
                    if (gsmIti && line.phone_number) {
                        gsmIti.setNumber(line.phone_number.startsWith('+') ? line.phone_number : '+' + line.phone_number);
                        // Активируем поле названия, если номер уже есть
                        const lineNameField = document.getElementById('editLineName');
                        if (lineNameField && line.phone_number) {
                            lineNameField.disabled = false;
                        }
                    } else if (gsmIti) {
                        gsmIti.setNumber('+');
                    }
                } catch (e) {
                    document.getElementById('editLineError').textContent = e.message;
                    document.getElementById('editLineError').style.display = 'block';
                }
                // Закрытие модалки
                document.getElementById('closeEditLineModal').onclick = closeEditLineModal;
                document.getElementById('cancelEditLineModal').onclick = closeEditLineModal;
                function closeEditLineModal() {
                    // Очищаем intlTelInput если он был инициализирован
                    if (gsmIti) {
                        gsmIti.destroy();
                        gsmIti = null;
                    }
                    container.innerHTML = '';
                }

                // --- Сохранение изменений (назначаем в конце) ---
                setTimeout(() => {
                    const editLineForm = document.getElementById('editLineForm');
                    if (editLineForm) {
                        editLineForm.onsubmit = async function(e) {
                            e.preventDefault();
                            const errorDiv = document.getElementById('editLineError');
                            errorDiv.style.display = 'none';
                            
                            // --- Валидация номера телефона ---
                            const phoneNumber = gsmIti ? gsmIti.getNumber() : document.getElementById('editLinePhone').value;
                            // Временно убираем валидацию, так как функция определена позже
                            // if (phoneNumber && !validatePhoneNumber(phoneNumber)) {
                            //     alert(`Ошибка: Номер телефона "${phoneNumber}" введен некорректно. Пожалуйста, проверьте формат.`);
                            //     document.getElementById('editLinePhone').focus();
                            //     return;
                            // }
                            
                            const data = {
                                line_name: document.getElementById('editLineName').value,
                                phone_number: phoneNumber,
                                prefix: document.getElementById('editLinePrefix').textContent,
                                smart: {
                                    enabled: document.getElementById('sr_enabled').checked,
                                    algorithm: (function(){ const el = document.getElementById('sr_algorithm'); return el && 'value' in el ? el.value : ''; })(),
                                    do_routing: document.getElementById('sr_do_routing').checked,
                                    send_line_name: document.getElementById('sr_send_line_name').checked,
                                    line_name_order: (function(){ const el = document.getElementById('sr_line_name_order'); return document.getElementById('sr_send_line_name').checked ? Number(el.value) : null; })(),
                                    send_customer_name: document.getElementById('sr_send_customer_name').checked,
                                    customer_name_order: (function(){ const el = document.getElementById('sr_customer_name_order'); return document.getElementById('sr_send_customer_name').checked ? Number(el.value) : null; })(),
                                    send_shop_name: document.getElementById('sr_send_shop_name').checked,
                                    shop_name_order: (function(){ const el = document.getElementById('sr_shop_name_order'); return document.getElementById('sr_send_shop_name').checked ? Number(el.value) : null; })(),
                                }
                            };
                            try {
                                const resp = await fetch(`/enterprise/${enterpriseNumber}/gsm-lines/${lineId}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(data),
                                    credentials: 'same-origin'
                                });
                                const result = await resp.json();
                                if (!resp.ok) {
                                    throw new Error(result.detail || 'Ошибка сохранения');
                                }
                                // Обновляем строку в таблице (если есть)
                                const row = document.querySelector(`tr[data-line-id="${lineId}"]`);
                                if (row) {
                                    row.querySelector('td:nth-child(5)').textContent = result.line_name || '';
                                    row.querySelector('td:nth-child(4)').textContent = formatDisplayNumber(result.phone_number || '');
                                    row.querySelector('td:nth-child(6)').textContent = result.prefix || '';
                                    // Мгновенно обновим подсветку ID согласно текущему состоянию чекбокса
                                    try {
                                        const srEnabledNow = document.getElementById('sr_enabled').checked;
                                        const idCell = row.querySelector('td:nth-child(1)');
                                        if (idCell) {
                                            if (srEnabledNow) {
                                                idCell.style.color = '#28a745';
                                                idCell.style.fontWeight = '700';
                                            } else {
                                                idCell.style.color = '';
                                                idCell.style.fontWeight = '';
                                            }
                                        }
                                    } catch (_) {}
                                }
                                // Запускаем регенерацию диалплана (не блокируем UI)
                                try {
                                    fetch(`/enterprise/${enterpriseNumber}/regenerate-config`, { method: 'POST' })
                                        .then(r => r.ok ? null : r.text().then(t => console.warn('Plan regen failed', t)))
                                        .catch(err => console.warn('Plan regen error', err));
                                } catch(_) {}
                                alert('GSM-линия успешно обновлена!');
                                closeEditLineModal();
                                // Лёгкий рефреш списка, чтобы подтянуть все изменения с сервера
                                try { setTimeout(() => { document.getElementById('btn-gsm-lines').click(); }, 150); } catch(_) {}
                            } catch (err) {
                                errorDiv.textContent = err.message;
                                errorDiv.style.display = 'block';
                            }
                        };
                    }
                }, 100);
            }
        });

        // --- File Upload Logic ---
        document.getElementById('uploadAudioForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const fileInput = document.getElementById('audioFile');
            const submitButton = form.querySelector('button[type="submit"]');

            if (fileInput.files.length === 0) {
                alert('Пожалуйста, выберите файл.');
                return;
            }
            const file = fileInput.files[0];

            if (file.size > 1.9 * 1024 * 1024) {
                alert('Размер файла не должен превышать 1.9 мб.');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Сохранение...';

            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/audiofiles`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Не удалось обработать ошибку сервера.' }));
                    throw new Error(errorData.detail || 'Произошла ошибка при загрузке файла.');
                }
                
                alert('Файл успешно загружен!');
                document.getElementById('uploadAudioModal').style.display = 'none';
                loadAudioFiles(); // Refresh list
            } catch (error) {
                alert(error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Сохранить';
            }
        });

        const loadAudioFiles = async () => {
            const listContainer = document.getElementById('audioFilesList');
            listContainer.innerHTML = '<p style="text-align: center;">Загрузка...</p>';
            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/audiofiles`);
                if (!response.ok) throw new Error('Ошибка загрузки');
                const files = await response.json();

                console.log("JS_LOG: Получен список файлов с сервера:", files);

                if (files.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center;">Аудиофайлы не найдены.</p>';
                    return;
                }

                listContainer.innerHTML = ''; // Clear container
                files.forEach(file => {
                    const fileTypeDisplay = file.file_type === 'start' ? 'Приветствие' : 'Ожидание';
                    const fileTypeClass = file.file_type === 'start' ? 'file-type-start' : 'file-type-hold';
                    const downloadName = file.original_filename || `${file.display_name}.wav`;
                    const audioSrc = `/audiofile/${file.id}`;

                    console.log(`JS_LOG: Обработка файла: ${file.display_name}, ID: ${file.id}. Сгенерирован SRC для плеера: ${audioSrc}`);

                    const row = document.createElement('div');
                    row.className = 'audio-file-row';
                    row.innerHTML = `
                        <div class="audio-file-details">
                            <div><strong>${file.display_name}</strong></div>
                            <div class="audio-player-container">
                                <audio controls src="/audiofile/${file.id}" preload="none"></audio>
                                <span class="file-type-badge ${file.file_type === 'hold' ? 'file-type-hold' : 'file-type-start'}">
                                    ${file.file_type === 'hold' ? 'Ожидание' : 'Приветствие'}
                                </span>
                            </div>
                        </div>
                        <div class="used-in-schemas">
                            ${file.used_in_schemas && file.used_in_schemas.length > 0
                                ? file.used_in_schemas.map(schema => `<span class="used-in-badge">${schema}</span>`).join('')
                                : `<button class="btn btn-danger btn-sm" data-action="delete-audio-file" data-file-id="${file.id}" data-file-name="${file.display_name}">Удалить</button>`
                            }
                        </div>`;
                    listContainer.appendChild(row);
                });

            } catch (error) {
                listContainer.innerHTML = `<p style="text-align: center; color: red;">${error.message}</p>`;
            }
        };

        // --- SIP Line Logic ---
        const getSchemaCountText = (schemas) => {
            if (!schemas || schemas.length === 0) {
                return '—';
            }
            if (schemas.length === 1) {
                // Если в массиве есть пустая строка или null, считаем, что схем нет
                return schemas[0] ? schemas[0] : '—';
            }
            
            const n = schemas.length;
            const lastDigit = n % 10;
            const lastTwoDigits = n % 100;

            if (lastTwoDigits >= 11 && lastTwoDigits <= 19) {
                return `${n} схем`;
            }
            if (lastDigit === 1) {
                return `${n} схема`;
            }
            if ([2, 3, 4].includes(lastDigit)) {
                return `${n} схемы`;
            }
            return `${n} схем`;
        };

        const loadSipLines = async () => {
            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/sip-lines`);
                if (!response.ok) {
                    throw new Error(`Ошибка загрузки SIP-линий: ${response.statusText}`);
                }
                const lines = await response.json();
                const tbody = document.getElementById('sip-lines-table').querySelector('tbody');
                tbody.innerHTML = ''; // Очищаем таблицу

                lines.forEach(line => {
                    const outSchemesText = getSchemaCountText(line.outgoing_schema_names || []);
                    const inSchemaText = line.incoming_schema_name || '—';

                    const row = `
                        <tr>
                            <td>
                                <a href="#" data-action="edit-sip-line" data-line-id="${line.id}" class="edit-trigger" style="margin-right: 10px;">✏️</a>
                                <a href="#" data-action="delete-sip-line" data-line-id="${line.id}" data-line-name="${line.line_name}" class="delete-trigger">🗑️</a>
                            </td>
                            <td style="${(line.smart && (line.smart.enabled === true || line.smart === true)) ? 'color:#28a745;font-weight:700;' : ''}">${line.line_name}</td>
                            <td>${line.provider_name}</td>
                            <td>${line.shop || '—'}</td>
                            <td>${inSchemaText}</td>
                            <td>${outSchemesText}</td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            } catch (error) {
                console.error("Не удалось загрузить SIP-линии:", error);
                alert("Произошла ошибка при загрузке SIP-линий.");
            }
        };

        const loadSipProviders = async () => {
            const select = document.getElementById('sip-provider');
            select.innerHTML = '<option value="">Загрузка...</option>';
            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/sip-providers`);
                if (!response.ok) throw new Error('Ошибка загрузки провайдеров');
                const providers = await response.json();
                
                select.innerHTML = '<option value="">-- Выберите оператора --</option>';
                providers.forEach(provider => {
                    const option = new Option(provider.name, provider.id);
                    select.add(option);
                });
            } catch (error) {
                select.innerHTML = `<option value="">${error.message}</option>`;
            }
        };

        const openSipLineForEdit = async (lineId) => {
            document.getElementById('sip-line-form').reset();
            document.getElementById('sip-line-modal-title').textContent = 'Редактирование SIP-линии';
            document.getElementById('sip-line-id').value = lineId;

            try {
                await loadSipProviders();
                const response = await fetch(`/enterprise/${enterpriseNumber}/sip-lines/${lineId}`);
                if (!response.ok) throw new Error('Не удалось загрузить данные линии.');
                
                const lineDetails = await response.json();
                
                document.getElementById('sip-provider').value = lineDetails.provider_id;
                document.getElementById('line_name').value = lineDetails.line_name;
                document.getElementById('password').value = lineDetails.password;
                document.getElementById('prefix').value = lineDetails.prefix || '';
                document.getElementById('incoming_transform').value = lineDetails.incoming_transform || '';
                // УП настройки
                try {
                    const s = lineDetails.smart || {};
                    const getBool = (v) => v === true || v === 'true' || v === 1 || v === '1';
                    document.getElementById('sip_sr_enabled').checked = getBool(s.enabled);
                    document.getElementById('sip_sr_algorithm').value = s.algorithm || '';
                    document.getElementById('sip_sr_do_routing').checked = getBool(s.do_routing);
                    document.getElementById('sip_sr_send_line_name').checked = getBool(s.send_line_name);
                    document.getElementById('sip_sr_send_customer_name').checked = getBool(s.send_customer_name);
                    document.getElementById('sip_sr_send_shop_name').checked = getBool(s.send_shop_name);
                    // Порядок отображения
                    const ln = document.getElementById('sip_sr_line_name_order');
                    const cn = document.getElementById('sip_sr_customer_name_order');
                    const sn = document.getElementById('sip_sr_shop_name_order');
                    if (ln) { ln.value = (s.line_name_order && [1,2,3].includes(Number(s.line_name_order))) ? String(s.line_name_order) : '1'; ln.disabled = !document.getElementById('sip_sr_send_line_name').checked; }
                    if (cn) { cn.value = (s.customer_name_order && [1,2,3].includes(Number(s.customer_name_order))) ? String(s.customer_name_order) : '2'; cn.disabled = !document.getElementById('sip_sr_send_customer_name').checked; }
                    if (sn) { sn.value = (s.shop_name_order && [1,2,3].includes(Number(s.shop_name_order))) ? String(s.shop_name_order) : '3'; sn.disabled = !document.getElementById('sip_sr_send_shop_name').checked; }
                } catch(_) {}

                const toggleSipOrders = () => {
                    const ln = document.getElementById('sip_sr_line_name_order');
                    const cn = document.getElementById('sip_sr_customer_name_order');
                    const sn = document.getElementById('sip_sr_shop_name_order');
                    if (ln) { ln.disabled = !document.getElementById('sip_sr_send_line_name').checked; }
                    if (cn) { cn.disabled = !document.getElementById('sip_sr_send_customer_name').checked; }
                    if (sn) { sn.disabled = !document.getElementById('sip_sr_send_shop_name').checked; }
                };
                ['sip_sr_send_line_name','sip_sr_send_customer_name','sip_sr_send_shop_name'].forEach(id=>{
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', toggleSipOrders);
                });
                toggleSipOrders();

                // Уникальность позиций (1-3) для SIP
                const enforceSipOrders = () => {
                    const chkLine = document.getElementById('sip_sr_send_line_name');
                    const chkCust = document.getElementById('sip_sr_send_customer_name');
                    const chkShop = document.getElementById('sip_sr_send_shop_name');
                    const selLine = document.getElementById('sip_sr_line_name_order');
                    const selCust = document.getElementById('sip_sr_customer_name_order');
                    const selShop = document.getElementById('sip_sr_shop_name_order');
                    const active = [];
                    if (chkLine && chkLine.checked && selLine) active.push(selLine);
                    if (chkCust && chkCust.checked && selCust) active.push(selCust);
                    if (chkShop && chkShop.checked && selShop) active.push(selShop);
                    // Снимем все disable
                    [selLine, selCust, selShop].forEach(s => { if (!s) return; Array.from(s.options).forEach(o=>o.disabled=false); });
                    // Запретим дубликаты
                    active.forEach((s, idx) => {
                        const used = new Set(active.filter(x=>x!==s).map(x=>x.value));
                        Array.from(s.options).forEach(o => { o.disabled = used.has(o.value); });
                        if (used.has(s.value)) {
                            // автоисправление на первую свободную
                            const cand = ['1','2','3'].find(v=>!used.has(v));
                            if (cand) s.value = cand;
                        }
                    });
                };
                ['sip_sr_send_line_name','sip_sr_send_customer_name','sip_sr_send_shop_name',
                 'sip_sr_line_name_order','sip_sr_customer_name_order','sip_sr_shop_name_order']
                .forEach(id=>{
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', enforceSipOrders);
                });
                enforceSipOrders();

                sipLineFormModal.style.display = 'block';
            } catch (error) {
                alert(error.message);
            }
        };

        document.getElementById('sip-line-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const lineId = form.elements['id'].value;
            const formData = new FormData(form);
            const data = {
                provider_id: parseInt(formData.get('provider_id')),
                line_name: formData.get('line_name'),
                password: formData.get('password'),
                prefix: formData.get('prefix'),
                incoming_transform: formData.get('incoming_transform') || null,
                smart: {
                    enabled: document.getElementById('sip_sr_enabled').checked,
                    algorithm: (function(){ const el = document.getElementById('sip_sr_algorithm'); return el && 'value' in el ? el.value : ''; })(),
                    do_routing: document.getElementById('sip_sr_do_routing').checked,
                    send_line_name: document.getElementById('sip_sr_send_line_name').checked,
                    line_name_order: (function(){ const el = document.getElementById('sip_sr_line_name_order'); return document.getElementById('sip_sr_send_line_name').checked && el ? Number(el.value) : null; })(),
                    send_customer_name: document.getElementById('sip_sr_send_customer_name').checked,
                    customer_name_order: (function(){ const el = document.getElementById('sip_sr_customer_name_order'); return document.getElementById('sip_sr_send_customer_name').checked && el ? Number(el.value) : null; })(),
                    send_shop_name: document.getElementById('sip_sr_send_shop_name').checked,
                    shop_name_order: (function(){ const el = document.getElementById('sip_sr_shop_name_order'); return document.getElementById('sip_sr_send_shop_name').checked && el ? Number(el.value) : null; })(),
                }
            };

            const url = lineId 
                ? `/enterprise/${enterpriseNumber}/sip-lines/${lineId}`
                : `/enterprise/${enterpriseNumber}/sip-lines`;
            
            const method = lineId ? 'PUT' : 'POST';

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Сохранение...';

                try {
                    const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Не удалось сохранить линию.');
                }
                
                alert(lineId ? 'SIP-линия успешно обновлена!' : 'SIP-линия успешно создана!');
                // Инициируем полную регенерацию диалплана (не блокируем UI)
                try {
                    fetch(`/enterprise/${enterpriseNumber}/regenerate-config`, { method: 'POST' })
                        .then(r => r.ok ? null : r.text().then(t => console.warn('Plan regen failed', t)))
                        .catch(err => console.warn('Plan regen error', err));
                } catch(_) {}
                sipLineFormModal.style.display = 'none';
                loadSipLines(); 
            } catch (error) {
                alert(`Ошибка: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Сохранить';
            }
        });

        // После сохранения GSM-линии (форма editLineForm) обновляем таблицу без закрытия модалки
        document.addEventListener('submit', async (e) => {
            const formEl = e.target;
            if (formEl && formEl.id === 'editLineForm') {
                // Мгновенно обновим цвет ID в текущей строке
                try {
                    const srEnabled = document.getElementById('sr_enabled').checked;
                    const row = document.querySelector(`tr[data-line-id="${lineId}"] td:nth-child(1)`);
                    if (row) {
                        if (srEnabled) {
                            row.style.color = '#28a745';
                            row.style.fontWeight = '700';
                        } else {
                            row.style.color = '';
                            row.style.fontWeight = '';
                        }
                    }
                } catch(_) {}
                // Параллельно прожимаем обновление всей таблицы (не мешает UX)
                setTimeout(() => { try { document.getElementById('btn-gsm-lines').click(); } catch(_) {} }, 200);
            }
        }, true);

        // --- Department Logic ---
        const loadDepartments = async () => {
            const tableBody = document.getElementById('departments-table').querySelector('tbody');
            tableBody.innerHTML = '<tr><td colspan="2" style="text-align: center;">Загрузка...</td></tr>';
            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/departments`);
                if (!response.ok) throw new Error('Ошибка загрузки отделов');
                const departments = await response.json();
                
                tableBody.innerHTML = '';
                if (departments.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="2" style="text-align: center;">Отделы еще не созданы.</td></tr>';
                    return;
                }

                departments.forEach(dept => {
                    const row = tableBody.insertRow();
                    row.dataset.departmentId = dept.id;
                    row.innerHTML = `
                        <td><a href="#" class="edit-trigger" data-action="edit-department" data-id="${dept.id}">${dept.number}</a></td>
                        <td><a href="#" class="edit-trigger" data-action="edit-department" data-id="${dept.id}">${dept.name}</a></td>
                    `;
                });
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="2" style="text-align: center; color: red;">${error.message}</td></tr>`;
            }
        };

        const openDepartmentForm = async (departmentId = null) => {
            const form = document.getElementById('department-form');
            form.reset();
            document.getElementById('department-id').value = '';
            document.getElementById('department-members-container').style.display = 'none';
            document.getElementById('department-members-list').innerHTML = '';
            
            const title = document.getElementById('department-modal-title');
            const deleteBtn = document.getElementById('deleteDepartmentBtn');
            
            if (departmentId) {
                // Logic for editing
                title.textContent = 'Редактирование отдела';
                deleteBtn.style.display = 'block';
                deleteBtn.dataset.id = departmentId;
                try {
                    const response = await fetch(`/enterprise/${enterpriseNumber}/departments/${departmentId}`);
                    if (!response.ok) throw new Error('Не удалось загрузить данные отдела');
                    const dept = await response.json();

                    document.getElementById('department-id').value = dept.id;
                    document.getElementById('department-name').value = dept.name;
                    document.getElementById('department-number').value = dept.number;
                    
                    const membersList = document.getElementById('department-members-list');
                    membersList.innerHTML = '';
                    if(dept.members) {
                        dept.members.forEach(member => {
                            const displayName = member.user_name 
                                ? `${member.user_name} (${member.phone_number})`
                                : `Линия ${member.phone_number}`;
                            const li = document.createElement('li');
                            li.dataset.memberId = member.id;
                            li.innerHTML = `<span>${displayName}</span><button type="button" data-action="remove-department-member" class="btn-link">Удалить</button>`;
                            membersList.appendChild(li);
                        });
                    }

                    document.getElementById('department-members-container').style.display = 'block';
                    populateDepartmentUserSelect();

                } catch(e) {
                    alert(e.message);
                    return;
                }
            } else {
                // Logic for creating
                title.textContent = 'Создание отдела';
                deleteBtn.style.display = 'none';
                try {
                    const res = await fetch(`/enterprise/${enterpriseNumber}/departments/next-available-number`);
                    if (res.ok) {
                        const data = await res.json();
                        document.getElementById('department-number').value = data.next_number;
                    } else {
                         document.getElementById('department-number').value = 901;
                    }
                } catch (e) {
                     document.getElementById('department-number').value = 901;
                }
            }
            departmentFormModal.style.display = 'block';
        };

        const populateDepartmentUserSelect = async () => {
            const select = document.getElementById('department-user-select');
            select.innerHTML = '<option>Загрузка...</option>';
            try {
                if (!allLinesCache) {
                     const response = await fetch(`/enterprise/${enterpriseNumber}/internal-phones/all`);
                     if(!response.ok) throw new Error('Failed to fetch lines');
                     allLinesCache = await response.json();
                }
                select.innerHTML = '<option value="">-- Выберите сотрудника --</option>';
                allLinesCache.forEach(line => {
                    const displayName = line.manager_name 
                        ? `${line.manager_name} (${line.phone_number})`
                        : `Линия ${line.phone_number}`;
                    const option = new Option(displayName, line.id);
                    select.add(option);
                });
            } catch (e) {
                select.innerHTML = '<option>Ошибка</option>';
            }
        };

        const addDepartmentMember = () => {
            const select = document.getElementById('department-user-select');
            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption || !selectedOption.value) return;

            const memberId = selectedOption.value;
            const memberName = selectedOption.text;

            const membersList = document.getElementById('department-members-list');
            // Проверка, что такой участник еще не добавлен
            if (membersList.querySelector(`li[data-member-id="${memberId}"]`)) {
                alert('Этот сотрудник уже в отделе.');
                return;
            }

            const li = document.createElement('li');
            li.dataset.memberId = memberId;
            li.innerHTML = `<span>${memberName}</span><button type="button" data-action="remove-department-member" class="btn-link">Удалить</button>`;
            membersList.appendChild(li);
        };

        const _deptForm = document.getElementById('department-form');
        if (_deptForm) _deptForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const departmentId = form.elements['id'].value;
            
            const members = Array.from(document.querySelectorAll('#department-members-list li')).map(li => parseInt(li.dataset.memberId, 10));

            const data = {
                name: form.elements['name'].value,
                number: parseInt(form.elements['number'].value, 10),
                members: members
            };

            const url = departmentId
                ? `/enterprise/${enterpriseNumber}/departments/${departmentId}`
                : `/enterprise/${enterpriseNumber}/departments`;
            const method = departmentId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = 'Не удалось сохранить отдел';
                    if (errorData.detail) {
                        if (Array.isArray(errorData.detail)) {
                            // FastAPI validation error
                            errorMessage = errorData.detail.map(err => `Поле "${err.loc[err.loc.length - 1]}": ${err.msg}`).join('\\n');
                        } else {
                            // Custom HTTPException
                            errorMessage = errorData.detail;
                        }
                    }
                    throw new Error(errorMessage);
                }
                departmentFormModal.style.display = 'none';
                loadDepartments();
            } catch (error) {
                alert(`Ошибка:\\n${error.message}`);
            }
        });

        function formatSchemaCount(count) {
            if (!count || count === 0) return '';
            const lastDigit = count % 10;
            const lastTwoDigits = count % 100;

            if (lastTwoDigits >= 11 && lastTwoDigits <= 19) {
                return `${count} схем`;
            }
            if (lastDigit === 1) {
                return `${count} схема`;
            }
            if ([2, 3, 4].includes(lastDigit)) {
                return `${count} схемы`;
            }
            return `${count} схем`;
        }

        function displayOutgoingSchemas(schemas) {
            const schemaNames = schemas || [];
            const count = schemaNames.length;

            if (count === 0) {
                return '';
            }
            if (count === 1) {
                return schemaNames[0];
            }
            return formatSchemaCount(count);
        }

        // --- Initial Load ---
        fetchUsers();

        // --- Internal Line Edit Modal --- (удалена старая версия)
        
        const deleteInternalLine = async (phoneNumber) => {
            // Показываем подтверждение удаления
            if (!confirm(`Вы уверены, что хотите удалить внутренний номер ${phoneNumber}?\n\nЭто действие необратимо.`)) {
                return;
            }

            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/internal-phones/${phoneNumber}`, { method: 'DELETE' });

                if (response.ok) {
                    alert(`Номер ${phoneNumber} успешно удален.`);
                    // Закрываем все модальные окна
                    closeAllModals();
                    // Обновляем список пользователей
                    fetchUsers();
                } else if (response.status === 409) {
                    // Обрабатываем ошибки зависимостей (409 Conflict)
                    try {
                        const errorData = await response.json();
                        const errorMessage = errorData.detail || `Номер ${phoneNumber} не может быть удален.`;
                        
                        // Показываем предупреждение с информацией о зависимостях
                        alert(`Удаление невозможно!\n\n${errorMessage}`);
                    } catch (jsonError) {
                        const errorText = await response.text();
                        alert(`Удаление невозможно!\n\n${errorText}`);
                    }
                } else {
                    // Обрабатываем другие ошибки
                    let errorMessage;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail;
                    } catch (jsonError) {
                        errorMessage = await response.text();
                    }
                    alert(errorMessage || `Произошла ошибка: ${response.statusText}`);
                }
            } catch (error) {
                console.error("Критическая ошибка при удалении:", error);
                alert(`Не удалось выполнить запрос: ${error.message}`);
            }
        };

        document.getElementById('confirm-delete-sip-line-btn').addEventListener('click', async (e) => {
            const button = e.target;
            const lineId = document.getElementById('sip-line-to-delete-id').value;
            
            button.disabled = true;
            button.textContent = 'Удаление...';

            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/sip-lines/${lineId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('SIP-линия успешно удалена.');
                    document.getElementById('delete-sip-line-modal').style.display = 'none';
                    loadSipLines();
                } else {
                    const errorData = await response.json();
                    let errorMessage = 'Не удалось удалить линию.';
                    if (errorData.detail) {
                       // Преобразуем список зависимостей в читаемую строку
                       if (Array.isArray(errorData.detail.dependencies) && errorData.detail.dependencies.length > 0) {
                           const depString = errorData.detail.dependencies.join(', ');
                           errorMessage = `Линию нельзя удалить, т.к. она используется в схемах: ${depString}`;
                       } else if (typeof errorData.detail === 'string') {
                           errorMessage = errorData.detail;
                       }
                    }
                    alert(`Ошибка: ${errorMessage}`);
                }
            } catch (error) {
                alert(`Критическая ошибка: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Удалить';
            }
        });

        function validatePhoneNumber(number) {
            try {
                if (!number.startsWith('+')) return true; // Проверяем только международные номера
                const phoneNumber = libphonenumber.parsePhoneNumberFromString(number);
                return phoneNumber ? phoneNumber.isValid() : false;
            } catch (error) {
                console.error(`Ошибка валидации номера ${number}:`, error);
                return false; // Считаем невалидным при ошибке
            }
        }

        const _delDeptBtn = document.getElementById('deleteDepartmentBtn');
        if (_delDeptBtn) _delDeptBtn.addEventListener('click', async (e) => {
            const departmentId = e.target.dataset.id;
            if (!departmentId) return;

            const departmentName = document.getElementById('department-name').value || `отдел с ID ${departmentId}`;
            if (!confirm(`Вы уверены, что хотите удалить отдел "${departmentName}"? Это действие необратимо.`)) {
                return;
            }

            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/departments/${departmentId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    departmentFormModal.style.display = 'none';
                    loadDepartments();
                } else {
                    const errorData = await response.json();
                    alert(`Ошибка удаления: ${errorData.detail || 'Неизвестная ошибка'}`);
                }
            } catch (error) {
                alert(`Критическая ошибка: ${error.message}`);
            }
        });

        // ============================================
        // ФУНКЦИИ ДЛЯ РАБОТЫ С МОДАЛКОЙ ВНУТРЕННИХ ЛИНИЙ
        // ============================================
        
        // Универсальная функция закрытия модальных окон (hoisted)
        function closeAllModals() {
            // Закрываем все модальные окна с классом .modal
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (modal && modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            });
            
            // Дополнительно очищаем все элементы с display: block, которые являются модальными окнами
            const openModals = document.querySelectorAll('[style*="display: block"]');
            openModals.forEach(element => {
                if (element.classList && element.classList.contains('modal')) {
                    if (element.parentNode) {
                        element.parentNode.removeChild(element);
                    }
                }
            });
            
            // Убираем возможные блокировки скролла
            document.body.style.overflow = '';
        }
        
        // Функция копирования в буфер обмена с уведомлением
        const copyToClipboardWithNotification = async (text, message = "Данные скопированы в буфер обмена") => {
            try {
                await navigator.clipboard.writeText(text);
                
                // Создаем уведомление
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 5px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    z-index: 10000;
                    font-size: 14px;
                    font-family: Arial, sans-serif;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // Удаляем уведомление через 3 секунды
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
                
            } catch (err) {
                console.error('Ошибка копирования:', err);
                // Fallback для старых браузеров
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                alert(message);
            }
        };

        // Функция получения конфигурационных данных с хоста (hoisted)
        async function getPhoneConfigData(enterpriseNumber) {
            try {
                // Используем прямой endpoint для получения конфигурационных данных
                const response = await fetch(`/enterprise/${enterpriseNumber}/phone-config-data`);
                if (!response.ok) {
                    console.warn('Config endpoint not available, using fallback');
                    // Fallback - возвращаем базовые данные
                    return {
                        externip: null,
                        bindport: '5060',
                        localIp: null,
                        hasExternip: false
                    };
                }
                
                return await response.json();
                
            } catch (error) {
                console.error('Error fetching config data:', error);
                // Fallback для случаев когда endpoint недоступен
                return {
                    externip: null,
                    bindport: '5060', 
                    localIp: null,
                    hasExternip: false
                };
            }
        }

        // Функция создания кнопки копирования для ячеек таблицы (hoisted)
        function createCopyButton(text) {
            const button = document.createElement('button');
            button.innerHTML = '📋';
            button.style.cssText = `
                padding: 2px 4px;
                border: 1px solid #ccc;
                background: #f8f9fa;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                vertical-align: middle;
                min-width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            `;
            button.title = 'Скопировать';
            button.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                copyToClipboardWithNotification(text);
            };
            return button;
        }

        // Функция создания таблицы конфигурации (hoisted)
        function createConfigTable(lineData, configData) {
            const { phone_number, password } = lineData;
            const { externip, bindport, localIp, hasExternip } = configData;
            
            const table = document.createElement('table');
            table.style.cssText = `
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
                font-size: 14px;
            `;
            
            // Создаем заголовок
            const header = document.createElement('tr');
            header.innerHTML = `
                <th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5; text-align: center;">Параметр</th>
                <th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5; text-align: center;">Телефон в офисе</th>
                ${hasExternip ? '<th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5; text-align: center;">Телефон вне офиса</th>' : ''}
            `;
            table.appendChild(header);
            
            // Параметры для строк
            const rows = [
                { 
                    param: '1', 
                    office: phone_number, 
                    external: phone_number 
                },
                { 
                    param: '2', 
                    office: password, 
                    external: password 
                },
                { 
                    param: '3', 
                    office: localIp || 'н/д', 
                    external: externip || 'н/д' 
                },
                { 
                    param: '4', 
                    office: localIp ? `${localIp}:${bindport}` : 'н/д', 
                    external: externip ? `${externip}:${bindport}` : 'н/д' 
                },
                { 
                    param: '5', 
                    office: bindport, 
                    external: bindport 
                },
                { 
                    param: '6', 
                    office: localIp ? `${phone_number}@${localIp}:${bindport}` : 'н/д', 
                    external: externip ? `${phone_number}@${externip}:${bindport}` : 'н/д' 
                }
            ];
            
            // Создаем строки таблицы
            rows.forEach(row => {
                const tr = document.createElement('tr');
                
                // Колонка параметра
                const paramCell = document.createElement('td');
                paramCell.style.cssText = 'border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold;';
                paramCell.textContent = row.param;
                tr.appendChild(paramCell);
                
                // Колонка "Телефон в офисе"
                const officeCell = document.createElement('td');
                officeCell.style.cssText = 'border: 1px solid #ddd; padding: 8px; text-align: left; position: relative;';
                
                // Создаем контейнер для текста и кнопки
                const officeContainer = document.createElement('div');
                officeContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';
                
                const officeText = document.createElement('span');
                officeText.textContent = row.office;
                officeContainer.appendChild(officeText);
                
                // Добавляем кнопку копирования для параметров 2-6
                if (parseInt(row.param) >= 2 && row.office !== 'н/д') {
                    officeContainer.appendChild(createCopyButton(row.office));
                }
                
                officeCell.appendChild(officeContainer);
                tr.appendChild(officeCell);
                
                // Колонка "Телефон вне офиса" (только если есть externip)
                if (hasExternip) {
                    const externalCell = document.createElement('td');
                    externalCell.style.cssText = 'border: 1px solid #ddd; padding: 8px; text-align: left; position: relative;';
                    
                    // Создаем контейнер для текста и кнопки
                    const externalContainer = document.createElement('div');
                    externalContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';
                    
                    const externalText = document.createElement('span');
                    externalText.textContent = row.external;
                    externalContainer.appendChild(externalText);
                    
                    // Добавляем кнопку копирования для параметров 2-6
                    if (parseInt(row.param) >= 2 && row.external !== 'н/д') {
                        externalContainer.appendChild(createCopyButton(row.external));
                    }
                    
                    externalCell.appendChild(externalContainer);
                    tr.appendChild(externalCell);
                }
                
                table.appendChild(tr);
            });
            
            return table;
        }

        // Функция показа индикатора загрузки (hoisted)
        function showLoadingIndicator(buttonElement) {
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = '⏳ Загрузка...';
            buttonElement.disabled = true;
            buttonElement.style.opacity = '0.7';
            return () => {
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
                buttonElement.style.opacity = '1';
            };
        }

        // Открытие модального окна редактирования внутренней линии
        async function openEditInternalLineModal(event) {
            event.preventDefault();
            
            // Получаем номер линии
            const lineNumber = event.target.textContent.trim();
            
            // Показываем индикатор загрузки для всех случаев
            let hideLoading = () => {};
            
            // Если есть реальный DOM элемент - показываем индикатор на нем
            if (event.target && event.target.style !== undefined) {
                hideLoading = showLoadingIndicator(event.target);
            } else {
                // Для искусственных событий - находим кнопку по номеру и показываем индикатор
                const realButton = document.querySelector(`[data-phone-number="${lineNumber}"]`);
                if (realButton && realButton.style !== undefined) {
                    hideLoading = showLoadingIndicator(realButton);
                }
            }
            
            try {
                // Параллельно загружаем данные линии и конфигурации
                const [lineResponse, configData] = await Promise.all([
                    fetch(`/enterprise/${enterpriseNumber}/internal-phones/${lineNumber}/details`),
                    getPhoneConfigData(enterpriseNumber)
                ]);
                
                if (!lineResponse.ok) {
                    throw new Error(`HTTP ${lineResponse.status}`);
                }
                
                const lineData = await lineResponse.json();
                
                // Скрываем индикатор загрузки
                hideLoading();
                
                // Создаем модальное окно
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; width: 90%;">
                        <span class="close">&times;</span>
                        <h2>Линия ${lineData.phone_number}</h2>
                        
                        <form id="editInternalLineForm">
                            <div class="form-group">
                                <label for="editNumber">Номер</label>
                                <input type="text" id="editNumber" value="${lineData.phone_number}" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="editPassword">Пароль</label>
                                <div style="position: relative;">
                                    <input type="text" id="editPassword" value="${lineData.password}" readonly style="padding-right: 40px;">
                                    <button type="button" id="copyPasswordBtn"
                                            style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); border: none; background: transparent; cursor: pointer; font-size: 16px;" 
                                            title="Скопировать пароль">📋</button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Параметры настройки телефона:</label>
                                <div id="configTableContainer"></div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-danger" id="deleteLineBtn">Удалить</button>
                                <button type="button" class="btn btn-secondary" id="closeModalBtn">Закрыть</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Добавляем таблицу конфигурации
                const tableContainer = document.getElementById('configTableContainer');
                const configTable = createConfigTable(lineData, configData);
                tableContainer.appendChild(configTable);
                
                // Добавляем обработчик для кнопки копирования пароля
                const copyPasswordBtn = document.getElementById('copyPasswordBtn');
                if (copyPasswordBtn) {
                    copyPasswordBtn.onclick = () => {
                        copyToClipboardWithNotification(lineData.password, 'Пароль скопирован в буфер обмена');
                    };
                }
                
                // Добавляем обработчик для кнопки удаления
                const deleteLineBtn = document.getElementById('deleteLineBtn');
                if (deleteLineBtn) {
                    deleteLineBtn.onclick = () => {
                        deleteInternalLine(lineData.phone_number);
                    };
                }
                
                // Добавляем обработчик для кнопки закрытия
                const closeModalBtn = document.getElementById('closeModalBtn');
                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', (ev) => {
                        ev.preventDefault();
                        ev.stopPropagation();
                        if (modal && modal.parentNode) {
                            modal.parentNode.removeChild(modal);
                        }
                        document.body.style.overflow = '';
                    });
                }
                
                // Обработчик закрытия модального окна (крестик)
                modal.querySelector('.close').addEventListener('click', (ev) => {
                    ev.preventDefault();
                    ev.stopPropagation();
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                    document.body.style.overflow = '';
                });
                
                // Обработчик закрытия модального окна (клик вне области)
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        if (modal && modal.parentNode) {
                            modal.parentNode.removeChild(modal);
                        }
                        document.body.style.overflow = '';
                    }
                });
                

                
            } catch (error) {
                hideLoading();
                console.error('Ошибка загрузки данных:', error);
                alert('Ошибка загрузки данных линии');
            }
        }
    });
    </script>
    <script src="https://unpkg.com/libphonenumber-js@1.11.1/bundle/libphonenumber-js.min.js"></script>

    <!-- Модалка Интеграции -->
    <div id="integrationsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:9999;">
      <div style="background:#fff; color:#111; width:560px; margin:60px auto; border-radius:10px; overflow:hidden;">
        <div style="padding:14px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
          <strong>Интеграции</strong>
          <button type="button" onclick="closeIntegrationsModal()" class="btn btn-secondary">×</button>
        </div>
        <div style="padding:16px;">
          <p>Доступные интеграции:</p>
          <div style="display:grid; grid-template-columns: 1fr 1fr; column-gap:24px; align-items:start;">
            <div style="min-width:0;">
              <ul style="list-style:none; padding:0; margin:0; line-height:1.8;">
                <li style="margin:8px 0;">
                  <a href="#" onclick="openRetailCRMAdmin(); return false;">RetailCRM</a>
                </li>
                <li style="margin:8px 0;">
                  <a href="#" onclick="openUONAdmin(); return false;">U-ON.Travel</a>
                </li>
              </ul>
            </div>
            <div style="min-width:0;">
              <div id="primaryBlock" style="display:none; border:1px solid #eee; border-radius:8px; padding:12px;">
                <div style="display:grid; grid-template-rows:auto 1fr auto; row-gap:10px;">
                  <div>
                    <button type="button" class="btn btn-primary" id="btnSavePrimary" style="width:140px;">Сохранить</button>
                  </div>
                  <div style="display:grid; row-gap:6px;">
                    <label style="display:flex; align-items:center; gap:8px;">
                      <input type="radio" name="primaryIntegration" value="retailcrm">
                      <span>RetailCRM</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                      <input type="radio" name="primaryIntegration" value="uon">
                      <span>U-ON.Travel</span>
                    </label>
                  </div>
                  <div id="primaryMsg" style="font-size:13px; color:#059669; display:none;">Сохранено</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      const integrationsModal = document.getElementById('integrationsModal');
      function openIntegrationsModal(){ integrationsModal.style.display='block'; }
      function closeIntegrationsModal(){ integrationsModal.style.display='none'; }
      function openRetailCRMAdmin(){
        const enterpriseNumber = '{{ enterprise.number }}';
        const url = `/retailcrm-admin/?enterprise_number=${enterpriseNumber}`;
        window.open(url, '_blank');
        closeIntegrationsModal();
      }
      function openUONAdmin(){
        const enterpriseNumber = '{{ enterprise.number }}';
        const url = `/uon-admin/?enterprise_number=${enterpriseNumber}`;
        window.open(url, '_blank');
        closeIntegrationsModal();
      }

      // Primary integration UI logic
      (function(){
        try {
          const enterpriseNumber = '{{ enterprise.number }}';
          const primaryBlock = document.getElementById('primaryBlock');
          const btnSavePrimary = document.getElementById('btnSavePrimary');
          const msg = document.getElementById('primaryMsg');

          async function refreshPrimaryUI(){
            try {
              const r = await fetch(`/enterprise/${enterpriseNumber}/integrations/summary`);
              if (!r.ok) { primaryBlock.style.display = 'none'; return; }
              const data = await r.json();
              const enabled = data.enabled || {retailcrm:false, uon:false};
              const enabledCount = (enabled.retailcrm?1:0) + (enabled.uon?1:0);
              if (enabledCount > 1){
                primaryBlock.style.display = 'block';
                const val = data.primary || 'retailcrm';
                const radios = document.getElementsByName('primaryIntegration');
                radios.forEach(r => { r.checked = (r.value === val); r.disabled = false; });
                btnSavePrimary.disabled = false;
              } else {
                primaryBlock.style.display = 'none';
              }
            } catch(e){ primaryBlock.style.display = 'none'; }
          }

          if (btnSavePrimary){
            btnSavePrimary.addEventListener('click', async () => {
              try {
                const radios = document.getElementsByName('primaryIntegration');
                let chosen = null;
                radios.forEach(r => { if (r.checked) chosen = r.value; });
                if (!chosen) return;
                btnSavePrimary.textContent = 'Сохранение...';
                btnSavePrimary.disabled = true;
                const rs = await fetch(`/enterprise/${enterpriseNumber}/smart/primary`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ primary: chosen })
                });
                if (rs.ok){
                  msg.style.display = 'block';
                  setTimeout(()=>{ msg.style.display = 'none'; }, 1500);
                }
              } catch(e){}
              finally {
                btnSavePrimary.textContent = 'Сохранить';
                btnSavePrimary.disabled = false;
              }
            });
          }

          refreshPrimaryUI();
        } catch(e){}
      })();
    </script>
  </body>
</html>