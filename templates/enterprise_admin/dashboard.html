<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{ enterprise.name }} admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/20.3.0/css/intlTelInput.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 0; }
        .header { display: flex; align-items: center; background-color: #343a40; color: white; padding: 0.5rem 1rem; border-bottom: 1px solid #ddd; }
        .header img { height: 32px; margin-right: 15px; }
        .header h1 { font-size: 1.1rem; margin: 0; font-weight: 400; color: rgba(255, 255, 255, 0.85); }
        .container { padding: 2rem; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 1200px; border-radius: 8px; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; margin-left: 25px; }
        .table-container { margin-top: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
        th { background-color: #f2f2f2; }
        .gsm-table td a { color: blue; text-decoration: none; }
        .gsm-table td a:hover { text-decoration: underline; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #dee2e6; margin-bottom: 1rem; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; }
        .btn { background-color: #007bff; color: white; border: none; padding: 10px 20px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin-bottom: 1rem; cursor: pointer; border-radius: 5px; }
        .btn:hover { background-color: #0056b3; }
        .btn-primary { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .btn-secondary { background-color: #6c757d; padding: 10px 20px; }
        .btn-danger { background-color: #dc3545; padding: 10px 20px; }
        .password-wrapper { position: relative; display: flex; }
        .password-wrapper input { flex-grow: 1; padding-right: 40px; }
        .password-wrapper .copy-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); cursor: pointer; border: none; background: transparent; font-size: 1.2rem; padding: 5px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: .5rem; }
        .form-group input, .form-group select { width: 100%; padding: .5rem; box-sizing: border-box; }
        .form-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; }
        .modal-content.modal-narrow { max-width: 400px; }
        /* --- Стили для таблицы GSM-линий в модалке --- */
        .gsm-table-container { max-height: 70vh; overflow-y: auto; }
        .gsm-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .gsm-table th, .gsm-table td { border: 1px solid #ddd; padding: 6px; text-align: left; white-space: nowrap; }
        .gsm-table th { background-color: #f2f2f2; position: sticky; top: 0; z-index: 1; }
        .edit-trigger { color: #007bff; text-decoration: none; cursor: pointer; }
        .edit-trigger:hover { text-decoration: underline; }
        .table-secondary { background: #f8f9fa; font-weight: bold; }

        /* --- Стили для таблицы аудиофайлов --- */
        .audio-files-container { display: flex; flex-direction: column; }
        .audio-files-header, .audio-file-row {
            display: grid;
            grid-template-columns: 3fr 1fr 2fr;
            gap: 10px;
            align-items: center;
            padding: 10px;
        }
        .audio-files-header {
            font-weight: 500;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 5px;
        }
        .audio-file-row {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .audio-file-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .audio-player-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .audio-player-container audio {
            height: 40px;
            max-width: 250px;
        }
        .file-type-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
            text-align: center;
            display: inline-block;
        }
        .file-type-start { background-color: #007bff; }
        .file-type-hold { background-color: #fd7e14; }
        .used-in-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            text-align: center;
            display: inline-block;
        }
        .audio-actions .dropdown { position: relative; display: inline-block; }
        .audio-actions .menu-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d; }
        .audio-actions .dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 120px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 4px; right: 0; border: 1px solid #ddd; }
        .audio-actions .dropdown-content a { color: black; padding: 10px 14px; text-decoration: none; display: block; font-size: 0.9em; }
        .audio-actions .dropdown-content a:hover { background-color: #f1f1f1; }
        .audio-actions .dropdown:hover .dropdown-content { display: block; }
    </style>
</head>
<body>
    <div class="header">
        <img src="/static/logo.jpg" alt="Логотип">
        <h1>{{ enterprise.number }}-{{ enterprise.name }} Панель администратора</h1>
    </div>
    <div class="container">
        <button class="btn btn-primary" type="button" data-action="show-users">Пользователи</button>
        <button class="btn btn-success" type="button" id="btn-gsm-lines">GSM-линии</button>
        <button class="btn btn-warning" type="button" data-action="show-audiofiles">Аудиофайлы</button>
        <button class="btn btn-primary" type="button" data-action="show-sip-lines">SIP-линии</button>
        <button class="btn btn-primary" type="button" onclick="alert('Раздел в разработке')">Call-Tracking</button>
        <button class="btn btn-primary" type="button" onclick="alert('Раздел в разработке')">CallBack</button>
        <button class="btn btn-primary" type="button" onclick="alert('Раздел в разработке')">Отделы</button>
        <button class="btn btn-primary" type="button" onclick="alert('Раздел в разработке')">Магазины</button>
        <button class="btn btn-primary" type="button" onclick="alert('Раздел в разработке')">API</button>
        <button class="btn btn-primary" type="button" onclick="alert('Раздел в разработке')">Статистика</button>
        <button class="btn btn-primary" type="button" onclick="alert('Раздел в разработке')">Интеграции</button>
        <button class="btn btn-primary" type="button" onclick="alert('Раздел в разработке')">Прочие настройки</button>
        <p>Здесь будет содержимое админки для предприятия.</p>
    </div>

    <!-- Модальное окно для SIP-линий (основное) -->
    <div id="sip-lines-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SIP-линии</h2>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <button class="btn btn-primary" type="button" data-action="open-sip-line-form">Добавить SIP-линию</button>
                <div class="table-container" style="margin-top: 20px;">
                    <table id="sip-lines-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Номер</th>
                                <th>Оператор</th>
                                <th>Магазин</th>
                                <th>Вх. схема</th>
                                <th>Исх. схемы</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Сюда будут загружаться созданные SIP-линии -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для ФОРМЫ добавления SIP-линии -->
    <div id="sip-line-form-modal" class="modal">
        <div class="modal-content modal-narrow">
            <div class="modal-header">
                <h2 id="sip-line-modal-title">Добавить SIP-линию</h2>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <form id="sip-line-form">
                    <input type="hidden" id="sip-line-id" name="id">
                    <div class="form-group">
                        <label for="sip-provider">Оператор</label>
                        <select id="sip-provider" name="provider_id" required>
                            <option value="">-- Выберите оператора --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="line_name">Имя линии (логин)</label>
                        <input type="text" id="line_name" name="line_name" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Пароль</label>
                        <input type="text" id="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="prefix">Префикс</label>
                        <input type="text" id="prefix" name="prefix">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно для управления пользователями -->
    <div id="user-management-modal" class="modal">
        <div class="modal-content" style="max-width: 90%;">
            <div class="modal-header">
                <h2>Пользователи и внутренние линии</h2>
                <div>
                    <button data-action="open-create-user" class="btn btn-primary">Создать пользователя</button>
                    <button data-action="open-create-line" class="btn btn-primary">Создать линию</button>
                </div>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Номер</th><th>IP регистр.</th><th>Вх. схема</th><th>Исх. схемы</th><th>Имя Фамилия</th><th>Логин</th><th>Роли</th><th>Отделы</th><th>F.Me</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="userModalTitle">Создание пользователя</h2>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="form-group"><label for="userEmail">Логин/Email</label><input type="email" id="userEmail" name="email" required></div>
                            <div class="form-group"><label>Роли</label><div><input type="checkbox" id="roleAdmin" name="is_admin" value="true"><label for="roleAdmin">Администратор</label><input type="checkbox" id="roleEmployee" name="is_employee" value="true" checked><label for="roleEmployee">Сотрудник</label></div></div>
                            <div class="form-group"><label for="userLastName">Фамилия</label><input type="text" id="userLastName" name="last_name" required></div>
                            <div class="form-group"><label for="userFirstName">Имя</label><input type="text" id="userFirstName" name="first_name" required></div>
                            <div class="form-group"><label for="userPatronymic">Отчество</label><input type="text" id="userPatronymic" name="patronymic"></div>
                        </div>
                        <div>
                            <div class="form-group"><label for="userPersonalPhone">Внешний номер</label><input type="tel" id="userPersonalPhone" name="personal_phone"></div><hr>
                            <p>Внутренние номера <button type="button" data-action="add-internal-line" style="cursor: pointer; border-radius: 50%; border: 1px solid #ccc; background-color: #f8f8f8;">+</button></p>
                            <div id="internalNumbersList"></div><hr>
                            <p>Отделы</p>
                        </div>
                    </div>
                    <hr><h4>Права</h4><hr><h4>Схема дозвона (Умная переадресация и Follow Me)</h4>
                    <div class="form-actions">
                        <button type="button" data-action="delete-user" id="deleteUserBtn" class="btn btn-danger" style="display: none;">Удалить</button>
                        <div>
                            <button type="submit" class="btn btn-primary">Сохранить</button>
                            <button type="button" data-action="close-modal" class="btn btn-secondary">Отмена</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Create Line Modal -->
    <div id="createLineModal" class="modal">
        <div class="modal-content modal-narrow">
            <div class="modal-header"><h2>Внутренняя линия</h2><span data-action="close-modal" class="close-button">&times;</span></div>
            <div class="modal-body">
                <form id="createLineForm">
                    <div class="form-group"><label for="lineNumberInput">Номер</label><input type="text" id="lineNumberInput" name="phone_number" required><small>Интервал 100-899 (301, 302, 555 недоступны)</small></div>
                    <div class="form-group"><label for="linePasswordInput">Пароль</label><div class="password-wrapper"><input type="text" id="linePasswordInput" name="password" readonly><button type="button" class="copy-btn" onclick="copyToClipboard('linePasswordInput')">❐</button></div></div>
                    <div class="form-actions"><button type="submit" class="btn btn-primary">Сохранить</button></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Select Lines Modal -->
    <div id="selectLinesModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header"><h2>Внутренние линии</h2><span data-action="close-modal" class="close-button">&times;</span></div>
            <div class="modal-body">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;"><input type="text" id="filterLineNumber" placeholder="Внутренний номер" style="flex: 1;"><input type="text" id="filterLineManager" placeholder="Менеджер" style="flex: 1;"></div>
                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table><thead><tr><th style="width: 50px;"></th><th>Внутренний номер</th><th>Менеджер</th></tr></thead><tbody id="selectLinesTableBody"></tbody></table>
                </div>
            </div>
            <div class="form-actions">
                <button data-action="go-to-create-line" class="btn btn-primary" style="background-color: #28a745;">Создать</button>
                <div><button data-action="confirm-line-selection" class="btn btn-primary">OK</button><button type="button" data-action="close-modal" class="btn btn-secondary">Отмена</button></div>
            </div>
        </div>
    </div>

    <!-- GSM Lines Modal (кастомная, как у пользователей, с разметкой как у шлюза) -->
    <div id="gsmLinesModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>GSM Линии предприятия</h2>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <div class="gsm-table-container" id="gsmLinesTableContainer">
                    <!-- Таблицы по шлюзам будут вставляться сюда через JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Контейнер для модалки редактирования линии -->
    <div id="editLineModalContainer"></div>

    <!-- Audiofiles Modal -->
    <div id="audiofilesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Аудиофайлы</h2>
                <div>
                    <button class="btn btn-primary" type="button" data-action="add-greeting-file">+ Файл приветствия</button>
                    <button class="btn btn-primary" type="button" data-action="add-waiting-file">+ Файл ожидания</button>
                </div>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <div class="audio-files-container">
                    <div class="audio-files-header">
                        <div>Наименование</div>
                        <div>Тип</div>
                        <div>Используется в схемах</div>
                    </div>
                    <div id="audioFilesList">
                        <!-- Аудиофайлы будут загружены сюда -->
                    </div>
                </div>
            </div>
            <div class="form-actions" style="justify-content: flex-end;">
                <button type="button" data-action="refresh-audio-files" class="btn btn-primary">Обновить</button>
                <button type="button" data-action="close-modal" class="btn btn-secondary">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для добавления/редактирования аудиофайла -->
    <div id="uploadAudioModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h5 class="modal-title">Аудиофайл</h5>
                <span data-action="close-modal" class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <form id="uploadAudioForm">
                    <input type="hidden" id="uploadFileType" name="file_type">
                    <div class="form-group">
                        <label for="audioDisplayName">Название</label>
                        <input type="text" id="audioDisplayName" name="display_name" required>
                    </div>
                    <div class="form-group">
                        <label>Выбрать файл</label>
                        <input type="file" id="audioFile" name="file" accept=".mp3,.wav" required style="border: 1px solid #ccc; padding: 5px; width: 100%;">
                        <small style="display: block; margin-top: 5px;">
                           <strong style="font-weight: 600; color: #495057;">Файл должен быть формата .mp3 (любой битрейт) или .wav (16bit 8kHz) и не более 1.9 мб</strong>
                        </small>
                    </div>
                    <div class="form-actions" style="margin-top: 1.5rem;">
                         <button type="button" data-action="close-modal" class="btn btn-secondary">ОТМЕНА</button>
                         <button type="submit" class="btn btn-primary">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/20.3.0/js/intlTelInput.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- State and Constants ---
        const enterpriseNumber = '{{ enterprise.number }}';
        let currentEditingUser = null;
        let usersDataCache = null;
        let allLinesCache = null;

        // --- DOM Elements ---
        const usersModal = document.getElementById('user-management-modal');
        const createUserModal = document.getElementById('createUserModal');
        const createLineModal = document.getElementById('createLineModal');
        const selectLinesModal = document.getElementById('selectLinesModal');
        const gsmLinesModal = document.getElementById('gsmLinesModal');
        const audiofilesModal = document.getElementById('audiofilesModal');
        const uploadAudioModal = document.getElementById('uploadAudioModal');
        const userModalTitle = document.getElementById('userModalTitle');
        const createUserForm = document.getElementById('createUserForm');
        const createLineForm = document.getElementById('createLineForm');
        const usersTableBody = document.getElementById('usersTableBody');
        const selectLinesTableBody = document.getElementById('selectLinesTableBody');
        const internalNumbersList = document.getElementById('internalNumbersList');
        const deleteUserBtn = document.getElementById('deleteUserBtn');
        const editLineModalContainer = document.getElementById('editLineModalContainer');
        const sipLinesModal = document.getElementById('sip-lines-modal');
        const sipLineFormModal = document.getElementById('sip-line-form-modal');

        // --- Event Delegation ---
        document.body.addEventListener('click', async (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.getAttribute('data-action');
            
            if (action === 'show-users') {
                usersModal.style.display = 'block';
                if (!usersDataCache) fetchUsers();
            } else if (action === 'show-audiofiles') {
                document.getElementById('audiofilesModal').style.display = 'block';
                loadAudioFiles();
            } else if (action === 'show-sip-lines') {
                sipLinesModal.style.display = 'block';
                loadSipLines();
            } else if (action === 'open-sip-line-form') {
                document.getElementById('sip-line-form').reset();
                document.getElementById('sip-line-modal-title').textContent = 'Добавить SIP-линию';
                document.getElementById('sip-line-id').value = ''; // Очищаем ID
                loadSipProviders();
                sipLineFormModal.style.display = 'block';
            } else if (action === 'edit-sip-line') {
                const lineId = e.target.dataset.lineId;
                openSipLineForEdit(lineId);
            } else if (action === 'add-greeting-file' || action === 'add-waiting-file') {
                const fileType = action === 'add-greeting-file' ? 'start' : 'hold';
                const uploadForm = document.getElementById('uploadAudioForm');
                if(uploadForm) uploadForm.reset();
                
                const fileTypeInput = document.getElementById('uploadFileType');
                if(fileTypeInput) fileTypeInput.value = fileType;
                
                const uploadModal = document.getElementById('uploadAudioModal');
                if(uploadModal) uploadModal.style.display = 'block';
            } else if (action === 'open-create-user') {
                openCreateUserModal();
            } else if (action === 'open-create-line') {
                openCreateLineModal();
            } else if (action === 'edit-user') {
                openUserModalForEdit(target.dataset.userId);
            } else if (action === 'delete-user') {
                deleteUser();
            } else if (action === 'add-internal-line') {
                openSelectLinesModal();
            } else if (action === 'close-modal') {
                closeModal(target.closest('.modal'));
            } else if (action === 'confirm-line-selection') {
                confirmLineSelection();
            } else if (action === 'go-to-create-line') {
                closeModal(selectLinesModal);
                openCreateLineModal();
            } else if (action === 'refresh-audio-files') {
                loadAudioFiles();
            }
        });

        // --- Modal Management ---
        const openModal = (modalElement) => modalElement && (modalElement.style.display = 'block');
        const closeModal = (modalElement) => modalElement && (modalElement.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) closeModal(event.target);
        });

        // --- Data Fetching and Rendering ---
        const fetchUsers = async () => {
            usersTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center">Загрузка...</td></tr>`;
            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/users`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                usersDataCache = await response.json();
                renderUsersTable();
            } catch (error) {
                usersTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center">Ошибка загрузки: ${error.message}</td></tr>`;
            }
        };
        
        const renderUsersTable = () => {
            usersTableBody.innerHTML = '';
            const { users = [], unassigned_phones = [] } = usersDataCache || {};
            const combinedList = [
                ...users.map(u => ({...u, type: 'user'})),
                ...unassigned_phones.map(p => ({ phone_number: p, type: 'unassigned' }))
            ].sort((a,b) => (getSortKey(a) - getSortKey(b)));

            if (combinedList.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Пользователи и линии не найдены.</td></tr>';
                return;
            }
            
            combinedList.forEach(item => {
                if (item.type === 'user') {
                    const displayPhones = [...(item.internal_phones || []), ...(item.personal_phone ? [formatPhoneNumber(item.personal_phone)] : [])];
                    if (displayPhones.length === 0) displayPhones.push('');
                    const numRows = displayPhones.length;

                    displayPhones.forEach((phone, index) => {
                        const row = usersTableBody.insertRow();
                        
                        row.insertCell(0).textContent = phone;
                        row.insertCell(1).textContent = (index === 0) ? (item.ip_address || '') : '';
                        row.insertCell(2).textContent = (index === 0) ? (item.in_schema || '') : '';
                        row.insertCell(3).textContent = (index === 0) ? (item.out_schema || '') : '';

                        if (index === 0) {
                            const addCellWithRowspan = (content, isHtml = false) => {
                                const cell = row.insertCell();
                                if(isHtml) cell.innerHTML = content; else cell.textContent = content;
                                cell.rowSpan = numRows;
                            };
                            addCellWithRowspan(`<a href="#" data-action="edit-user" data-user-id="${item.id}">${item.full_name || ''}</a>`, true);
                            addCellWithRowspan(item.email || '');
                            addCellWithRowspan(item.roles || '');
                            addCellWithRowspan(item.departments || '');
                            addCellWithRowspan(item.f_me || '');
                        }
                    });
                } else {
                    const row = usersTableBody.insertRow();
                    row.insertCell(0).textContent = item.phone_number;
                    for (let i = 0; i < 8; i++) row.insertCell();
                }
            });
        };

        const getSortKey = (item) => {
            const num = parseInt(item.type === 'user' ? (item.internal_phones || [])[0] : item.phone_number, 10);
            return isNaN(num) ? Infinity : num;
        };
        
        const formatPhoneNumber = (e164) => {
            if (!e164 || !e164.startsWith('+') || e164.length < 10) return e164;
            if (e164.startsWith('+375')) {
                return `${e164.slice(0, 4)} (${e164.slice(4, 6)}) ${e164.slice(6, 9)}-${e164.slice(9, 11)}-${e164.slice(11, 13)}`;
            }
            return e164;
        };
        
        // --- User Modal Logic ---
        const openCreateUserModal = () => {
            currentEditingUser = null;
            document.getElementById('userModalTitle').textContent = 'Создание пользователя';
            createUserForm.reset();
            document.getElementById('deleteUserBtn').style.display = 'none';
            document.getElementById('internalNumbersList').innerHTML = '';
            iti.setNumber("+");
            openModal(createUserModal);
        };

        const openUserModalForEdit = (userId) => {
            const user = usersDataCache?.users.find(u => u.id == userId);
            if (!user) { alert("Не удалось найти данные пользователя."); return; }
            currentEditingUser = user;
            
            document.getElementById('userModalTitle').textContent = 'Редактирование пользователя';
            createUserForm.reset();
            Object.keys(user).forEach(key => {
                const el = createUserForm.elements[key];
                if (el && typeof el.value !== 'undefined') el.value = user[key];
            });
            iti.setNumber(user.personal_phone || '+');

            const listContainer = document.getElementById('internalNumbersList');
            listContainer.innerHTML = '';
            (user.internal_phones || []).forEach(phone => {
                listContainer.innerHTML += `<div><input type="hidden" name="internal_phones" value="${phone}">${phone}</div>`;
            });
            
            document.getElementById('deleteUserBtn').style.display = 'inline-block';
            openModal(createUserModal);
        };
        
        createUserForm.onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.personal_phone = iti.getNumber();
            data.internal_phones = formData.getAll('internal_phones');
            
            const url = currentEditingUser ? `/enterprise/${enterpriseNumber}/users/${currentEditingUser.id}` : `/enterprise/${enterpriseNumber}/users`;
            const method = currentEditingUser ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Ошибка HTTP ${response.status}`);
                }

                closeModal(createUserModal);
                await fetchUsers();
            } catch (error) {
                alert(`Не удалось сохранить пользователя: ${error.message}`);
            }
        };

        const deleteUser = async () => {
            if (!currentEditingUser) return;
            if (!confirm(`Удалить ${currentEditingUser.full_name}? Номера останутся в системе.`)) return;
            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/users/${currentEditingUser.id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                closeModal(createUserModal);
                await fetchUsers();
            } catch(e) { alert(`Не удалось удалить: ${e.message}`); }
        };

        // --- Line Modal Logic ---
        const openCreateLineModal = async () => {
            createLineForm.reset();
            openModal(createLineModal);
            try {
                const res = await fetch(`/enterprise/${enterpriseNumber}/internal-phones/next-available`);
                if(!res.ok) throw new Error();
                createLineForm.elements.phone_number.value = (await res.json()).next_number;
            } catch (e) { createLineForm.elements.phone_number.value = 'Ошибка'; }
            createLineForm.elements.password.value = Math.random().toString(36).slice(-8);
        };
        
        createLineForm.onsubmit = async(e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            try {
                const res = await fetch(`/enterprise/${enterpriseNumber}/internal-phones`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if(!res.ok) throw new Error(await res.text());

                // Invalidate cache to force refetch of all lines
                allLinesCache = null; 
                
                // Close current "Create Line" modal
                closeModal(createLineModal);

                // Re-open "Select Lines" modal, which will now fetch the updated list
                await openSelectLinesModal();
                
                // Refresh the main user table in the background as well, so it shows the new unassigned line
                fetchUsers(); 

            } catch(e) { alert(`Ошибка создания линии: ${e.message}`); }
        };

        const openSelectLinesModal = async () => {
            openModal(selectLinesModal);
            selectLinesTableBody.innerHTML = '<tr><td colspan="3">Загрузка...</td></tr>';
            try {
                if (!allLinesCache) {
                    const response = await fetch(`/enterprise/${enterpriseNumber}/internal-phones/all`);
                    if(!response.ok) throw new Error('Failed to fetch');
                    allLinesCache = await response.json();
                }
                renderSelectLinesTable();
            } catch (e) {
                selectLinesTableBody.innerHTML = '<tr><td colspan="3">Ошибка загрузки.</td></tr>';
            }
        };

        const renderSelectLinesTable = () => {
            const numFilter = document.getElementById('filterLineNumber').value.toLowerCase();
            const managerFilter = document.getElementById('filterLineManager').value.toLowerCase();
            const selectedPhones = new Set(Array.from(createUserForm.querySelectorAll('[name="internal_phones"]') || []).map(i => i.value));
            
            selectLinesTableBody.innerHTML = '';
            (allLinesCache || [])
                .filter(line => line.phone_number.toLowerCase().includes(numFilter) && (line.manager_name || '').toLowerCase().includes(managerFilter))
                .forEach(line => {
                    const isChecked = selectedPhones.has(line.phone_number);
                    selectLinesTableBody.insertRow().innerHTML = `<td><input type="checkbox" value="${line.phone_number}" ${isChecked ? 'checked' : ''}></td><td>${line.phone_number}</td><td>${line.manager_name || ''}</td>`;
                });
        };
        document.getElementById('filterLineNumber').addEventListener('input', renderSelectLinesTable);
        document.getElementById('filterLineManager').addEventListener('input', renderSelectLinesTable);

        const confirmLineSelection = () => {
            const listContainer = document.getElementById('internalNumbersList');
            listContainer.innerHTML = '';
            selectLinesTableBody.querySelectorAll('input:checked').forEach(checkbox => {
                listContainer.innerHTML += `<div><input type="hidden" name="internal_phones" value="${checkbox.value}">${checkbox.value}</div>`;
            });
            closeModal(selectLinesModal);
        };

        // --- GSM Lines Logic ---
        document.getElementById('btn-gsm-lines').addEventListener('click', async () => {
            const modal = document.getElementById('gsmLinesModal');
            const container = document.getElementById('gsmLinesTableContainer');
            container.innerHTML = '<div style="text-align:center;padding:2em;">Загрузка...</div>';
            modal.style.display = 'block';

            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/gsm-lines/all`);
                if (!response.ok) throw new Error('Ошибка загрузки данных');
                const gateways = await response.json();
                if (!Array.isArray(gateways) || gateways.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:2em;">Линии не найдены.</div>';
                    return;
                }
                // Сортировка шлюзов по минимальному line_id
                gateways.sort((a, b) => {
                    const minA = Math.min(...(a.lines || []).map(l => l.line_id || Infinity));
                    const minB = Math.min(...(b.lines || []).map(l => l.line_id || Infinity));
                    return minA - minB;
                });
                let html = '';
                gateways.forEach(gateway => {
                    if (!gateway.lines || gateway.lines.length === 0) return;
                    html += `<div style="margin-bottom:2em;">
                        <div class="table-secondary" style="padding:8px 0 8px 8px;font-size:1.1em;">${gateway.gateway_name}</div>
                        <table class="gsm-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Ip</th>
                                    <th>ID2</th>
                                    <th>Номер</th>
                                    <th>Наименование</th>
                                    <th>Префикс</th>
                                    <th>Вх.сх</th>
                                    <th>Исх.схемы</th>
                                    <th>Магазин</th>
                                    <th>Goip</th>
                                    <th>Слот</th>
                                    <th>Переадр.</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    gateway.lines.forEach(line => {
                        html += `<tr data-line-id="${line.id}">
                            <td class="edit-trigger" data-line-id="${line.id}">${line.line_id || ''}</td>
                            <td></td>
                            <td>${line.internal_id || ''}</td>
                            <td>${line.phone_number || ''}</td>
                            <td>${line.line_name || ''}</td>
                            <td>${line.prefix || ''}</td>
                            <td>${line.in_schema || ''}</td>
                            <td>${line.out_schema || ''}</td>
                            <td>${line.shop || ''}</td>
                            <td>${gateway.gateway_name || ''}</td>
                            <td>${line.slot || ''}</td>
                            <td>${line.redirect || ''}</td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                });
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<div style="text-align:center;padding:2em;color:red;">Ошибка: ${e.message}</div>`;
            }
        });

        // --- Открытие модалки редактирования линии ---
        document.getElementById('gsmLinesTableContainer').addEventListener('click', async function(event) {
            const trigger = event.target.closest('.edit-trigger');
            if (trigger) {
                event.preventDefault();
                const lineId = trigger.dataset.lineId;
                // Открываем модалку редактирования
                const container = document.getElementById('editLineModalContainer');
                container.innerHTML = '<div class="modal" id="editLineModal" style="display:block;z-index:2000;"><div class="modal-content" style="max-width:500px;margin:5% auto;padding:0;position:relative;">'+
                    '<div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;background:#e9ecef;border-bottom:1px solid #dee2e6;">'+
                    '<h2 id="editLineModalTitle" style="margin:0;font-size:1.25rem;font-weight:500;color:#343a40;">Редактирование линии <span id="editLineNumber"></span></h2>'+
                    '<span class="close-button" id="closeEditLineModal" style="color:#6c757d;font-size:1.75rem;font-weight:700;line-height:1;cursor:pointer;opacity:0.7;">&times;</span>'+
                    '</div>'+
                    '<div class="modal-body" style="padding:1.5rem;">'+
                    '<div id="editLineError" class="error-message" style="display:none;color:#721c24;background:#f8d7da;border:1px solid #f5c6cb;padding:0.75rem 1.25rem;margin-bottom:1rem;border-radius:0.25rem;"></div>'+
                    '<form id="editLineForm">'+
                    '<input type="hidden" id="editLineIdInput" name="id" value="'+lineId+'">'+
                    '<div class="form-group"><label for="editLineName">Наименование (line_name):</label><input type="text" id="editLineName" name="line_name" class="form-group"></div>'+
                    '<div class="form-group"><label for="editLinePhone">Номер (phone_number):</label><input type="tel" id="editLinePhone" name="phone_number" class="form-group"></div>'+
                    '</form>'+
                    '<div class="form-group" style="margin-top:1rem;"><label>Префикс (prefix):</label> <span id="editLinePrefix" style="font-weight:500;"></span></div>'+
                    '<div class="button-bar" style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:1.5rem;">'+
                    '<button type="submit" class="button btn btn-primary" form="editLineForm">Сохранить</button>'+
                    '<button type="button" class="button button-secondary btn btn-secondary" id="cancelEditLineModal">Отмена</button>'+
                    '</div></div></div></div>';
                // Подгружаем данные линии
                try {
                    const resp = await fetch(`/enterprise/${enterpriseNumber}/gsm-lines/${lineId}`);
                    if (!resp.ok) throw new Error('Ошибка загрузки данных линии');
                    const line = await resp.json();
                    document.getElementById('editLineName').value = line.line_name || '';
                    document.getElementById('editLinePhone').value = line.phone_number || '';
                    document.getElementById('editLinePrefix').textContent = line.prefix || '';
                    document.getElementById('editLineNumber').textContent = line.phone_number || '';
                } catch (e) {
                    document.getElementById('editLineError').textContent = e.message;
                    document.getElementById('editLineError').style.display = 'block';
                }
                // Закрытие модалки
                document.getElementById('closeEditLineModal').onclick = closeEditLineModal;
                document.getElementById('cancelEditLineModal').onclick = closeEditLineModal;
                function closeEditLineModal() {
                    container.innerHTML = '';
                }
                // --- Сохранение изменений ---
                document.getElementById('editLineForm').onsubmit = async function(e) {
                    e.preventDefault();
                    const errorDiv = document.getElementById('editLineError');
                    errorDiv.style.display = 'none';
                    const data = {
                        line_name: document.getElementById('editLineName').value,
                        phone_number: document.getElementById('editLinePhone').value,
                        prefix: document.getElementById('editLinePrefix').textContent
                    };
                    try {
                        const resp = await fetch(`/enterprise/${enterpriseNumber}/gsm-lines/${lineId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data),
                            credentials: 'same-origin'
                        });
                        const result = await resp.json();
                        if (!resp.ok) {
                            throw new Error(result.detail || 'Ошибка сохранения');
                        }
                        // Обновляем строку в таблице (если есть)
                        const row = document.querySelector(`tr[data-line-id="${lineId}"]`);
                        if (row) {
                            row.querySelector('td:nth-child(5)').textContent = result.line_name || '';
                            row.querySelector('td:nth-child(4)').textContent = result.phone_number || '';
                            row.querySelector('td:nth-child(6)').textContent = result.prefix || '';
                        }
                        closeEditLineModal();
                    } catch (err) {
                        errorDiv.textContent = err.message;
                        errorDiv.style.display = 'block';
                    }
                };
            }
        });

        // --- File Upload Logic ---
        document.getElementById('uploadAudioForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const fileInput = document.getElementById('audioFile');
            const submitButton = form.querySelector('button[type="submit"]');

            if (fileInput.files.length === 0) {
                alert('Пожалуйста, выберите файл.');
                return;
            }
            const file = fileInput.files[0];

            if (file.size > 1.9 * 1024 * 1024) {
                alert('Размер файла не должен превышать 1.9 мб.');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Сохранение...';

            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/audiofiles`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Не удалось обработать ошибку сервера.' }));
                    throw new Error(errorData.detail || 'Произошла ошибка при загрузке файла.');
                }
                
                alert('Файл успешно загружен!');
                document.getElementById('uploadAudioModal').style.display = 'none';
                loadAudioFiles(); // Refresh list
            } catch (error) {
                alert(error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Сохранить';
            }
        });

        const loadAudioFiles = async () => {
            const listContainer = document.getElementById('audioFilesList');
            listContainer.innerHTML = '<p style="text-align: center;">Загрузка...</p>';
            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/audiofiles`);
                if (!response.ok) throw new Error('Ошибка загрузки');
                const files = await response.json();

                console.log("JS_LOG: Получен список файлов с сервера:", files);

                if (files.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center;">Аудиофайлы не найдены.</p>';
                    return;
                }

                listContainer.innerHTML = ''; // Clear container
                files.forEach(file => {
                    const fileTypeDisplay = file.file_type === 'start' ? 'Приветствие' : 'Ожидание';
                    const fileTypeClass = file.file_type === 'start' ? 'file-type-start' : 'file-type-hold';
                    const downloadName = file.original_filename || `${file.display_name}.wav`;
                    const audioSrc = `/audiofile/${file.id}`;

                    console.log(`JS_LOG: Обработка файла: ${file.display_name}, ID: ${file.id}. Сгенерирован SRC для плеера: ${audioSrc}`);

                    const row = document.createElement('div');
                    row.className = 'audio-file-row';
                    row.innerHTML = `
                        <div class="audio-file-details">
                            <span>${file.display_name}</span>
                            <div class="audio-player-container">
                                <audio controls controlsList="nodownload" src="${audioSrc}"></audio>
                                <div class="audio-actions">
                                    <div class="dropdown">
                                        <button class="menu-btn">&vellip;</button>
                                        <div class="dropdown-content">
                                            <a href="${audioSrc}" download="${downloadName}">Скачать</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div><span class="file-type-badge ${fileTypeClass}">${fileTypeDisplay}</span></div>
                        <div><span class="used-in-badge"></span></div>
                    `;
                    listContainer.appendChild(row);
                });

            } catch (error) {
                listContainer.innerHTML = `<p style="text-align: center; color: red;">${error.message}</p>`;
            }
        };

        // --- SIP Line Logic ---
        const loadSipProviders = async () => {
            const select = document.getElementById('sip-provider');
            select.innerHTML = '<option value="">Загрузка...</option>';
            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/sip-providers`);
                if (!response.ok) throw new Error('Ошибка загрузки провайдеров');
                const providers = await response.json();
                
                select.innerHTML = '<option value="">-- Выберите оператора --</option>';
                providers.forEach(provider => {
                    const option = new Option(provider.name, provider.id);
                    select.add(option);
                });
            } catch (error) {
                select.innerHTML = `<option value="">${error.message}</option>`;
            }
        };

        const loadSipLines = async () => {
            const tableBody = document.getElementById('sip-lines-table').querySelector('tbody');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Загрузка...</td></tr>';
            try {
                const response = await fetch(`/enterprise/${enterpriseNumber}/sip-lines`);
                if (!response.ok) throw new Error('Ошибка загрузки SIP-линий');
                const lines = await response.json();
                
                tableBody.innerHTML = '';
                if (lines.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">SIP-линии еще не созданы.</td></tr>';
                    return;
                }

                lines.forEach(line => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td></td>
                        <td><a href="#" class="edit-trigger" data-action="edit-sip-line" data-line-id="${line.id}">${line.line_name}</a></td>
                        <td>${line.provider_name}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    `;
                });
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: red;">${error.message}</td></tr>`;
            }
        };

        const openSipLineForEdit = async (lineId) => {
            document.getElementById('sip-line-form').reset();
            document.getElementById('sip-line-modal-title').textContent = 'Редактирование SIP-линии';
            document.getElementById('sip-line-id').value = lineId;

            try {
                await loadSipProviders();
                const response = await fetch(`/enterprise/${enterpriseNumber}/sip-lines/${lineId}`);
                if (!response.ok) throw new Error('Не удалось загрузить данные линии.');
                
                const lineDetails = await response.json();
                
                document.getElementById('sip-provider').value = lineDetails.provider_id;
                document.getElementById('line_name').value = lineDetails.line_name;
                document.getElementById('password').value = lineDetails.password;
                document.getElementById('prefix').value = lineDetails.prefix || '';

                sipLineFormModal.style.display = 'block';
            } catch (error) {
                alert(error.message);
            }
        };

        document.getElementById('sip-line-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const lineId = form.elements['id'].value;
            const formData = new FormData(form);
            const data = {
                provider_id: parseInt(formData.get('provider_id')),
                line_name: formData.get('line_name'),
                password: formData.get('password'),
                prefix: formData.get('prefix')
            };

            const url = lineId 
                ? `/enterprise/${enterpriseNumber}/sip-lines/${lineId}`
                : `/enterprise/${enterpriseNumber}/sip-lines`;
            
            const method = lineId ? 'PUT' : 'POST';

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Сохранение...';

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Не удалось сохранить линию.');
                }
                
                alert(lineId ? 'SIP-линия успешно обновлена!' : 'SIP-линия успешно создана!');
                sipLineFormModal.style.display = 'none';
                loadSipLines(); 
            } catch (error) {
                alert(`Ошибка: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Сохранить';
            }
        });

        // --- Initial Load ---
        fetchUsers();
    });
    </script>
</body>
</html> 