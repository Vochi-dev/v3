# üîÑ –°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Asterisk

–°–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å —É–¥–∞–ª–µ–Ω–Ω—ã—Ö Asterisk —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ PostgreSQL.

## üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç download.sh

```bash
# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
./download.sh start

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞  
./download.sh stop

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
./download.sh restart

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
./download.sh status
```

### –ü–æ—Ä—Ç –∏ –¥–æ—Å—Ç—É–ø
- **–ü–æ—Ä—Ç:** 8007
- **API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** http://localhost:8007/docs
- **–°—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è:** http://localhost:8007/health

## üìã API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### üè† –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
```http
GET /
```
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–∏—Å–µ –∏ —Å–ø–∏—Å–∫–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π.

### üíö –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
```http
GET /health
```
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

### üìä –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
```http
GET /sync/status
```
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π.

### üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
```http
POST /sync/{enterprise_id}
Content-Type: application/json

{
  "enterprise_id": "0327",
  "force_all": false,
  "date_from": "2025-07-01",
  "date_to": "2025-07-03"
}
```

### üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
```http
POST /sync/all
```

### üè¢ –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
```http
GET /enterprises
```

## üõ† –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å
```bash
curl -X POST "http://localhost:8007/sync/0327" \
  -H "Content-Type: application/json" \
  -d '{
    "enterprise_id": "0327",
    "date_from": "2025-07-03",
    "date_to": "2025-07-03"
  }'
```

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
```bash
curl -X POST "http://localhost:8007/sync/0327" \
  -H "Content-Type: application/json" \
  -d '{
    "enterprise_id": "0327",
    "date_from": "2025-07-01",
    "date_to": "2025-07-03"
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
curl http://localhost:8007/sync/status | jq
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
```bash
curl http://localhost:8007/health | jq
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
–í —Ñ–∞–π–ª–µ `download.py` –≤ —Å–µ–∫—Ü–∏–∏ `ENTERPRISE_CONFIGS`:

```python
ENTERPRISE_CONFIGS = {
    "0327": {
        "token": "375296211113",
        "host": "10.88.10.25",
        "ssh_port": "5059",
        "ssh_password": "5atx9Ate@pbx"
    }
    # –î–æ–±–∞–≤–ª—è–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –∑–¥–µ—Å—å
}
```

### PostgreSQL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```python
PG_CONFIG = {
    "host": "localhost",
    "port": "5432",
    "database": "postgres", 
    "user": "postgres",
    "password": "r/Yskqh/ZbZuvjb2b3ahfg=="
}
```

## üîß –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã

### –õ–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤** —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ Asterisk —Å–µ—Ä–≤–µ—Ä–∞
2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º** (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã date_from/date_to)
3. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π hangup** –∏–∑ –∫–∞–∂–¥–æ–≥–æ SQLite —Ñ–∞–π–ª–∞
4. **–ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è** –¥–∞–Ω–Ω—ã—Ö
5. **–ó–∞–ø–∏—Å—å –≤ PostgreSQL** —Å —Ñ–ª–∞–≥–æ–º `data_source = 'downloaded'`
6. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** –≤ —Ç–∞–±–ª–∏—Ü–µ `download_sync`

### –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ON CONFLICT (unique_id) DO NOTHING` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ó–∞–ø—Ä–µ—â–∞–µ—Ç –∑–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –µ—Å–ª–∏ –æ–Ω–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- Graceful handling –æ—à–∏–±–æ–∫ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è
- Rollback —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞
–õ–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤—ã–≤–æ–¥ —Å —É—Ä–æ–≤–Ω–µ–º INFO:
```
2025-07-03 11:39:20,050 - download - INFO - –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0327
2025-07-03 11:39:22,773 - download - INFO - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0327 –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ 83, –Ω–æ–≤—ã—Ö 3, –æ—à–∏–±–æ–∫ 0
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –ë–î
–¢–∞–±–ª–∏—Ü–∞ `download_sync` —Å–æ–¥–µ—Ä–∂–∏—Ç:
- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫–∞—á–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
```bash
# –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞
./download.sh status

# HTTP health check
curl http://localhost:8007/health

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
curl http://localhost:8007/sync/status
```

## üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
asterisk-webhook/
‚îú‚îÄ‚îÄ download.py           # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
‚îú‚îÄ‚îÄ download.sh           # –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
‚îú‚îÄ‚îÄ .uvicorn_download.pid # PID —Ñ–∞–π–ª (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
‚îî‚îÄ‚îÄ logs.txt              # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –ë–î
```

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π

### –†–∞–∑–ª–∏—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–º–µ—á–∞—é—Ç—Å—è –ø–æ–ª–µ–º `data_source = 'downloaded'`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –û—Ç–ª–∏—á–∞—Ç—å –æ—Ç live —Å–æ–±—ã—Ç–∏–π (`data_source = 'live'`)
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ Telegram

### –°–≤—è–∑—å —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏
- **calls** - –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∑–≤–æ–Ω–∫–æ–≤
- **call_participants** - –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏
- **download_sync** - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º SSH
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é
sshpass -p '5atx9Ate@pbx' ssh -p 5059 root@10.88.10.25 'ls /var/log/asterisk/'
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
PGPASSWORD='r/Yskqh/ZbZuvjb2b3ahfg==' psql -U postgres -d postgres -c "SELECT 1;"
```

### –°–µ—Ä–≤–∏—Å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
```bash
# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
./download.sh stop

# –û—á–∏—Å—Ç–∫–∞ –ø–æ—Ä—Ç–∞ –≤—Ä—É—á–Ω—É—é
fuser -k 8007/tcp

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
./download.sh start
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f /var/log/syslog | grep download

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
ps aux | grep uvicorn | grep download
``` 