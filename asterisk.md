# Asterisk Call Management API

–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞–º–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–∞—Ö Asterisk —á–µ—Ä–µ–∑ SSH CLI –∫–æ–º–∞–Ω–¥—ã.

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

**Asterisk Call Management API** - —ç—Ç–æ FastAPI —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∑–≤–æ–Ω–∫–∏ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö Asterisk —Ö–æ—Å—Ç–∞—Ö —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç REST API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω—É–∂–Ω—ã–π Asterisk —Ö–æ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –∑–≤–æ–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ REST API
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–≤–æ–Ω–∫–æ–≤ (–ø–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏–µ, —Å—É—Ñ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Asterisk —Ö–æ—Å—Ç–∞ –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
- ‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–∞—Ö
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–í–Ω–µ—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å ‚Üí Nginx ‚Üí asterisk.py (8018) ‚Üí SSH CLI ‚Üí Asterisk ‚Üí –ó–≤–æ–Ω–æ–∫
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
1. **asterisk.py** - FastAPI —Å–µ—Ä–≤–∏—Å –Ω–∞ –ø–æ—Ä—Ç—É 8018
2. **asterisk.sh** - —Å–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–º
3. **Nginx** - —Ä–æ—É—Ç–∏–Ω–≥ `/api/` –Ω–∞ –ø–æ—Ä—Ç 8018
4. **PostgreSQL** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
5. **SSH** - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Asterisk —Ö–æ—Å—Ç–∞–º

---

## üåê API Endpoints

### `GET /api/makecallexternal`

–ò–Ω–∏—Ü–∏–∞—Ü–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –∑–≤–æ–Ω–∫–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `code` (string, required) - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä (–æ—Ç–∫—É–¥–∞ –∑–≤–æ–Ω–∏—Ç—å)
- `phone` (string, required) - –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–∫—É–¥–∞ –∑–≤–æ–Ω–∏—Ç—å)
- `clientId` (string, required) - secret –∏–∑ —Ç–∞–±–ª–∏—Ü—ã enterprises

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```
GET https://bot.vochi.by/api/makecallexternal?code=150&phone=%2B375296254070&clientId=d68409d67e3b4b87a6675e76dae74a85
```

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç (200):**
```json
{
    "success": true,
    "message": "Call initiated successfully: 150 -> +375296254070",
    "enterprise": "june",
    "enterprise_number": "0367",
    "from_ext": "150",
    "to_phone": "+375296254070",
    "host_ip": "10.88.10.19",
    "response_time_ms": 1399.39
}
```

### `GET /api/monitor`

–ò–Ω–∏—Ü–∏–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ (–ø–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏–µ, —Å—É—Ñ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ).

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `action` (string, required) - —Ç–∏–ø –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
  - `"09"` - –ø–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏–µ (spy) - —Ç–æ–ª—å–∫–æ —Å–ª—É—à–∞—Ç—å
  - `"01"` - —Å—É—Ñ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (whisper) - –≥–æ–≤–æ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ü–µ–ª–µ–≤–æ–º—É –Ω–æ–º–µ—Ä—É
  - `"02"` - –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ (barge) - –ø–æ–ª–Ω–æ–ø—Ä–∞–≤–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
- `target` (string, required) - –Ω–æ–º–µ—Ä –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 150)
- `monitor_from` (string, required) - –Ω–æ–º–µ—Ä –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: 151)
- `clientId` (string, required) - secret –∏–∑ —Ç–∞–±–ª–∏—Ü—ã enterprises

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏–µ):**
```
GET https://bot.vochi.by/api/monitor?action=09&target=150&monitor_from=151&clientId=d68409d67e3b4b87a6675e76dae74a85
```

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç (200):**
```json
{
    "success": true,
    "message": "Monitoring initiated successfully: –ø–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏–µ for SIP/150",
    "action": "09",
    "action_name": "–ø–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏–µ",
    "target": "150",
    "monitor_from": "151",
    "target_channel": "SIP/150",
    "enterprise": "june",
    "enterprise_number": "0367",
    "host_ip": "10.88.10.19",
    "response_time_ms": 3160.66
}
```

**–¢–∏–ø—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
- **–ü–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏–µ (09)**: –ú–æ–Ω–∏—Ç–æ—Ä—è—â–∏–π –Ω–æ–º–µ—Ä –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —Å–ª—É—à–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä, –Ω–µ –º–æ–∂–µ—Ç –≤–º–µ—à–∏–≤–∞—Ç—å—Å—è
- **–°—É—Ñ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (01)**: –ú–æ–Ω–∏—Ç–æ—Ä—è—â–∏–π –Ω–æ–º–µ—Ä –º–æ–∂–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ü–µ–ª–µ–≤–æ–º—É –Ω–æ–º–µ—Ä—É (–≤–Ω–µ—à–Ω–∏–π –∞–±–æ–Ω–µ–Ω—Ç –Ω–µ —Å–ª—ã—à–∏—Ç)
- **–í–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ (02)**: –ú–æ–Ω–∏—Ç–æ—Ä—è—â–∏–π –Ω–æ–º–µ—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø–æ–ª–Ω–æ–ø—Ä–∞–≤–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏

**–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (401):**
```json
{
    "detail": "Invalid clientId"
}
```

**–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞ (500):**
```json
{
    "detail": "Call initiation failed: SSH command failed: Connection timeout"
}
```

### `GET /health`

Health check endpoint.

**–û—Ç–≤–µ—Ç:**
```json
{
    "status": "healthy",
    "service": "asterisk-call-management",
    "port": 8018
}
```

### `GET /api/status`

–°—Ç–∞—Ç—É—Å API –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.

**–û—Ç–≤–µ—Ç:**
```json
{
    "service": "asterisk-call-management",
    "version": "1.0.0",
    "database": "connected",
    "asterisk_config": {
        "method": "SSH CLI",
        "ssh_port": 5059,
        "ssh_user": "root"
    }
}
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### SSH CLI –ø–æ–¥—Ö–æ–¥

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Asterisk CLI –∫–æ–º–∞–Ω–¥ –≤–º–µ—Å—Ç–æ AMI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

**–ö–æ–º–∞–Ω–¥–∞ –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞:**
```bash
asterisk -rx "channel originate LOCAL/150@inoffice application Dial LOCAL/+375296254070@inoffice"
```

**–ö–æ–º–∞–Ω–¥—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–≤–æ–Ω–∫–æ–≤:**
```bash
# –ü–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏–µ (action=09)
asterisk -rx "channel originate LOCAL/151@inoffice application ChanSpy SIP/150,bq"

# –°—É—Ñ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (action=01) 
asterisk -rx "channel originate LOCAL/151@inoffice application ChanSpy SIP/150,bqw"

# –í–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ (action=02)
asterisk -rx "channel originate LOCAL/151@inoffice application ChanSpy SIP/150,Bbqw"
```

**–ü–æ–ª–Ω–∞—è SSH –∫–æ–º–∞–Ω–¥–∞:**
```bash
sshpass -p '5atx9Ate@pbx' ssh -p 5059 -o StrictHostKeyChecking=no root@10.88.10.19 'asterisk -rx "channel originate LOCAL/150@inoffice application Dial LOCAL/+375296254070@inoffice"'
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ SSH –ø–æ–¥—Ö–æ–¥–∞:
- ‚úÖ **–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–∞—Ö**
- ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é SSH –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É**
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ SSH**
- ‚úÖ **–ù–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ AMI –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```python
DB_CONFIG = {
    "user": POSTGRES_USER,
    "password": POSTGRES_PASSWORD,
    "database": POSTGRES_DB,
    "host": POSTGRES_HOST,
    "port": POSTGRES_PORT,
}
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ SSH
```python
ASTERISK_CONFIG = {
    "ssh_port": 5059,
    "ssh_user": "root",
    "ssh_password": "5atx9Ate@pbx"
}
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–∏—Å—Ç–µ–º–µ
- Python 3.8+
- `sshpass` (–¥–ª—è SSH –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ –ø–∞—Ä–æ–ª—é)
- PostgreSQL –∫–ª–∏–µ–Ω—Ç
- –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ç–∏ 10.88.10.x

---

## üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–º

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ asterisk.sh

```bash
# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
./asterisk.sh start

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
./asterisk.sh stop

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
./asterisk.sh restart

# –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
./asterisk.sh status

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
./asterisk.sh logs

# –¢–µ—Å—Ç —Å–µ—Ä–≤–∏—Å–∞
./asterisk.sh test
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å all.sh

–°–µ—Ä–≤–∏—Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –æ–±—â—É—é —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (–≤–∫–ª—é—á–∞—è asterisk)
./all.sh start

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
./all.sh stop

# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
./all.sh status
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `asterisk_service.log`:

```
2025-08-03 08:00:20,000 - asterisk - INFO - üöÄ –ó–∞–ø—Ä–æ—Å –Ω–∞ –∑–≤–æ–Ω–æ–∫: 150 -> +375296254070, clientId: d68409d6...
2025-08-03 08:00:20,084 - asterisk - INFO - ‚úÖ –ö–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: june (0367)
2025-08-03 08:00:20,084 - asterisk - INFO - üîó SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ 10.88.10.19: 150 -> +375296254070
2025-08-03 08:00:21,396 - asterisk - INFO - ‚úÖ CLI –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ 10.88.10.19: 150 -> +375296254070
```

### –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å

–°–µ—Ä–≤–∏—Å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –º–æ–¥–∞–ª–∫—É "Services" –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- üü¢ –°—Ç–∞—Ç—É—Å –ø–æ—Ä—Ç–∞ 8018
- üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
- üîÑ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π

–ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ —Ç–∞–±–ª–∏—Ü–µ `enterprises`:

```sql
SELECT number, name, ip 
FROM enterprises 
WHERE secret = $1 AND active = true
```

### SSH –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ SSH –∫—Ä–µ–¥–∏—Ç—ã
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `StrictHostKeyChecking=no` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
- –¢–∞–π–º–∞—É—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (10 —Å–µ–∫—É–Ω–¥)

### –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç

```bash
curl -s "http://localhost:8018/health"
```

### –¢–µ—Å—Ç —á–µ—Ä–µ–∑ Nginx

```bash
curl -s "https://bot.vochi.by/api/makecallexternal?code=150&phone=%2B375296254070&clientId=YOUR_SECRET"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
tail -f asterisk_service.log
```

---

## üõ†Ô∏è Troubleshooting

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**1. SSH Connection Timeout**
```
–ü—Ä–æ–±–ª–µ–º–∞: SSH timeout to 10.88.10.19
–†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ö–æ—Å—Ç–∞
```

**2. sshpass not found**
```
–ü—Ä–æ–±–ª–µ–º–∞: SSH client (sshpass) not available
–†–µ—à–µ–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å sshpass: apt-get install sshpass
```

**3. Invalid clientId**
```
–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π clientId
–†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É enterprises, –ø–æ–ª–µ secret –∏ active = true
```

**4. Database connection error**
```
–ü—Ä–æ–±–ª–µ–º–∞: –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
–†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î –≤ app/config.py
```

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
./asterisk.sh status

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
./asterisk.sh logs

# –¢–µ—Å—Ç API
./asterisk.sh test

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞
netstat -tuln | grep 8018

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
ps aux | grep asterisk
```

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –¢–∏–ø–∏—á–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

- **Response time**: 1000-2000ms (–≤–∫–ª—é—á–∞—è SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ)
- **Timeout SSH**: 10 —Å–µ–∫—É–Ω–¥
- **Timeout –∫–æ–º–∞–Ω–¥—ã**: 15 —Å–µ–∫—É–Ω–¥
- **Concurrent requests**: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

- SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å `ConnectTimeout=10`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è connection pooling –¥–ª—è PostgreSQL
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

---

## üîÑ –†–∞–∑–≤–∏—Ç–∏–µ

### –ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è

1. **Connection pooling –¥–ª—è SSH** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
2. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö Asterisk –∫–æ–º–∞–Ω–¥** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞, –∏—Å—Ç–æ—Ä–∏—è –∑–≤–æ–Ω–∫–æ–≤
3. **WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - real-time —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–æ–≤
4. **–ú–µ—Ç—Ä–∏–∫–∏ Prometheus** - –¥–µ—Ç–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
5. **Rate limiting** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–°–µ—Ä–≤–∏—Å –≥–æ—Ç–æ–≤ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å:
- CRM —Å–∏—Å—Ç–µ–º–∞–º–∏
- Telegram –±–æ—Ç–∞–º–∏
- –í–Ω–µ—à–Ω–∏–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏
- –°–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

## üìû –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ CRM

```javascript
// JavaScript –ø—Ä–∏–º–µ—Ä - –∏–Ω–∏—Ü–∏–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞
async function initiateCall(extension, phone) {
    const response = await fetch(`https://bot.vochi.by/api/makecallexternal?code=${extension}&phone=${encodeURIComponent(phone)}&clientId=${CLIENT_SECRET}`);
    const result = await response.json();
    
    if (result.success) {
        console.log(`–ó–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω: ${result.message}`);
    } else {
        console.error(`–û—à–∏–±–∫–∞: ${result.detail}`);
    }
}

// JavaScript –ø—Ä–∏–º–µ—Ä - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–≤–æ–Ω–∫–∞
async function monitorCall(action, target, monitorFrom) {
    const response = await fetch(`https://bot.vochi.by/api/monitor?action=${action}&target=${target}&monitor_from=${monitorFrom}&clientId=${CLIENT_SECRET}`);
    const result = await response.json();
    
    if (result.success) {
        console.log(`–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω: ${result.action_name} –¥–ª—è –Ω–æ–º–µ—Ä–∞ ${result.target}`);
    } else {
        console.error(`–û—à–∏–±–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: ${result.detail}`);
    }
}

// –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
// monitorCall("09", "150", "151"); // –ü–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏–µ 150-–≥–æ —Å –Ω–æ–º–µ—Ä–∞ 151
// monitorCall("01", "150", "151"); // –°—É—Ñ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ 150-–º—É —Å –Ω–æ–º–µ—Ä–∞ 151  
// monitorCall("02", "150", "151"); // –í–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä 150-–≥–æ
```

### Telegram –±–æ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

```python
# Python –ø—Ä–∏–º–µ—Ä
import httpx

async def make_call_from_bot(extension: str, phone: str, client_secret: str):
    async with httpx.AsyncClient() as client:
        response = await client.get(
            "https://bot.vochi.by/api/makecallexternal",
            params={
                "code": extension,
                "phone": phone,
                "clientId": client_secret
            }
        )
        return response.json()
```

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π

### v1.1.0 (2025-08-03)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω API –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–≤–æ–Ω–∫–æ–≤ `/api/monitor`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–¥—Å–ª—É—à–∏–≤–∞–Ω–∏—è (action=09)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—É—Ñ–ª–∏—Ä–æ–≤–∞–Ω–∏—è (action=01)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (action=02)
- ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### v1.0.0 (2025-08-03)
- ‚úÖ –ü–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑
- ‚úÖ SSH CLI —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ REST API —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π `/api/makecallexternal`
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å—é
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

**–°–µ—Ä–≤–∏—Å –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ**