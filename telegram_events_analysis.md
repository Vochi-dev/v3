# üìä –õ–û–ì–ò–†–û–í–ê–ù–ò–ï TELEGRAM –°–û–ë–´–¢–ò–ô

**–î–∞—Ç–∞:** 30.11.2025  
**–°—Ç–∞—Ç—É—Å:** –í –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

---

## üéØ –¶–ï–õ–¨

–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö Telegram –æ–ø–µ—Ä–∞—Ü–∏–π (send/edit/delete) –≤ –µ–¥–∏–Ω—ã–π —Ñ–∞–π–ª `call_tracer/{enterprise_number}/events.log` —Å —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π –∑–∞–ø–∏—Å–µ–π.

---

## üìê –§–û–†–ú–ê–¢ –ó–ê–ü–ò–°–ï–ô

### Asterisk —Å–æ–±—ã—Ç–∏—è (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):
```
2025-11-30 12:00:01,100|dial|1764500001.5|{"Phone":"375296254070","Exten":"151",...}
```

### Telegram —Å–æ–±—ã—Ç–∏—è (–Ω–æ–≤–æ–µ) - –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å `TG`:
```
TIMESTAMP|TG|ACTION|CHAT_ID|MSG_TYPE|MSG_ID|UNIQUE_ID|TEXT
```

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|----------|--------|
| TIMESTAMP | –í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è | `2025-11-30 12:00:01,250` |
| TG | –ú–∞—Ä–∫–µ—Ä Telegram —Å–æ–±—ã—Ç–∏—è | `TG` |
| ACTION | –î–µ–π—Å—Ç–≤–∏–µ | `send`, `edit`, `delete` |
| CHAT_ID | ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤ Telegram | `374573193` |
| MSG_TYPE | –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è | `start`, `dial`, `bridge`, `hangup` |
| MSG_ID | ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram | `45001` |
| UNIQUE_ID | Asterisk UniqueId –∑–≤–æ–Ω–∫–∞ | `1764500001.5` |
| TEXT | –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤) | `üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...` |

### –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ –ª–æ–≥–∞ –∑–≤–æ–Ω–∫–∞:
```
# Asterisk: –Ω–∞—á–∞–ª–æ –∑–≤–æ–Ω–∫–∞
2025-11-30 12:00:01,100|dial|1764500001.5|{"Phone":"375296254070","Exten":"151",...}

# Telegram: –æ—Ç–ø—Ä–∞–≤–∫–∞ dial –∫–∞–∂–¥–æ–º—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é
2025-11-30 12:00:01,250|TG|send|374573193|dial|45001|1764500001.5|üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ ‚òéÔ∏è151 ‚û°Ô∏è üí∞+375296254070
2025-11-30 12:00:01,280|TG|send|7889254605|dial|45002|1764500001.5|üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ ‚òéÔ∏è151 ‚û°Ô∏è üí∞+375296254070
2025-11-30 12:00:01,310|TG|send|7055556176|dial|45003|1764500001.5|üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ ‚òéÔ∏è151 ‚û°Ô∏è üí∞+375296254070

# Asterisk: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
2025-11-30 12:00:15,500|bridge|1764500001.5|{"Phone":"375296254070","BridgeUniqueid":"...",...}

# Telegram: —É–¥–∞–ª–µ–Ω–∏–µ dial + –æ—Ç–ø—Ä–∞–≤–∫–∞ bridge
2025-11-30 12:00:15,600|TG|delete|374573193|dial|45001|1764500001.5|
2025-11-30 12:00:15,650|TG|send|374573193|bridge|45010|1764500001.5|‚òéÔ∏è151 üìû‚û°Ô∏è üí∞+375296254070 –ö–ª–∏–µ–Ω—Ç: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤
2025-11-30 12:00:15,700|TG|delete|7889254605|dial|45002|1764500001.5|
2025-11-30 12:00:15,750|TG|send|7889254605|bridge|45011|1764500001.5|‚òéÔ∏è151 üìû‚û°Ô∏è üí∞+375296254070 –ö–ª–∏–µ–Ω—Ç: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤
2025-11-30 12:00:15,800|TG|delete|7055556176|dial|45003|1764500001.5|
2025-11-30 12:00:15,850|TG|send|7055556176|bridge|45012|1764500001.5|‚òéÔ∏è151 üìû‚û°Ô∏è üí∞+375296254070 –ö–ª–∏–µ–Ω—Ç: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤

# Asterisk: –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
2025-11-30 12:02:30,000|hangup|1764500001.5|{"Phone":"375296254070","Cause":"16",...}

# Telegram: —É–¥–∞–ª–µ–Ω–∏–µ bridge + —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ hangup
2025-11-30 12:02:30,100|TG|delete|374573193|bridge|45010|1764500001.5|
2025-11-30 12:02:30,150|TG|send|374573193|hangup|45020|1764500001.5|‚úÖ–£—Å–ø–µ—à–Ω—ã–π –∑–≤–æ–Ω–æ–∫ üí∞+375296254070 ‚è±02:15
2025-11-30 12:02:30,200|TG|delete|7889254605|bridge|45011|1764500001.5|
2025-11-30 12:02:30,250|TG|send|7889254605|hangup|45021|1764500001.5|‚úÖ–£—Å–ø–µ—à–Ω—ã–π –∑–≤–æ–Ω–æ–∫ üí∞+375296254070 ‚è±02:15
2025-11-30 12:02:30,300|TG|delete|7055556176|bridge|45012|1764500001.5|
2025-11-30 12:02:30,350|TG|send|7055556176|hangup|45022|1764500001.5|‚úÖ–£—Å–ø–µ—à–Ω—ã–π –∑–≤–æ–Ω–æ–∫ üí∞+375296254070 ‚è±02:15
```

---

## üë§ –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô

**–†–µ—à–µ–Ω–∏–µ:** –í –ª–æ–≥–∞—Ö —Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ `chat_id`. –ò–º—è –∏ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏–∑ –ë–î –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—ã.

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞
2. –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å—Å—è
3. –ü—Ä–∏ —Å–±–æ—Ä–∫–µ –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î

**–ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```sql
SELECT first_name, last_name, email 
FROM telegram_users 
WHERE tg_id = $1
```

---

## üìÅ –§–ê–ô–õ–´ –î–õ–Ø –ú–û–î–ò–§–ò–ö–ê–¶–ò–ò

| –§–∞–π–ª | –ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å |
|------|--------------|
| `main.py` | –§—É–Ω–∫—Ü–∏—è `log_telegram_event()` + –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç AST —Å–æ–±—ã—Ç–∏–π |
| `app/services/calls/start.py` | –í—ã–∑–æ–≤ `log_telegram_event()` –ø–æ—Å–ª–µ `send_message` |
| `app/services/calls/dial.py` | –í—ã–∑–æ–≤ –ø–æ—Å–ª–µ `send_message`, `delete_message` |
| `app/services/calls/bridge.py` | –í—ã–∑–æ–≤ –ø–æ—Å–ª–µ `send_message`, `edit_message`, `delete_message` |
| `app/services/calls/hangup.py` | –í—ã–∑–æ–≤ –ø–æ—Å–ª–µ `send_message`, `delete_message` |
| `app/services/calls/internal.py` | –í—ã–∑–æ–≤ –ø–æ—Å–ª–µ `send_message`, `edit_message`, `delete_message` |

---

## ‚úÖ TO-DO –°–ü–ò–°–û–ö

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (main.py)

- [x] **1.1** –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç Asterisk —Å–æ–±—ã—Ç–∏–π - –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å `AST|`
  ```python
  # –ë—ã–ª–æ:
  tracer.info(f"{event_type}|{unique_id}|{json.dumps(body)}")
  # –°—Ç–∞–Ω–µ—Ç:
  tracer.info(f"AST|{event_type}|{unique_id}|{json.dumps(body)}")
  ```

- [x] **1.2** –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `log_telegram_event()` –≤ `app/utils/call_tracer.py`
  ```python
  async def log_telegram_event(
      enterprise_number: str,
      action: str,           # send, edit, delete
      chat_id: int,
      message_type: str,     # start, dial, bridge, hangup
      message_id: int,
      unique_id: str,
      text: str = ""
  ):
      tracer = get_call_tracer_logger(enterprise_number)
      text_truncated = text[:200].replace('\n', ' ') if text else ""
      tracer.info(f"TG|{action}|{chat_id}|{message_type}|{message_id}|{unique_id}|{text_truncated}")
  ```

- [x] **1.3** –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö

### –≠—Ç–∞–ø 2: start.py

- [x] **2.1** –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `log_telegram_event`
- [x] **2.2** –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ `bot.send_message()` –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- [x] **2.3** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### –≠—Ç–∞–ø 3: dial.py

- [x] **3.1** –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `log_telegram_event`
- [x] **3.2** –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ `bot.send_message()` –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `send`
- [x] **3.3** –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ `bot.delete_message()` –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `delete`

### –≠—Ç–∞–ø 4: bridge.py

- [x] **4.1** –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `log_telegram_event`
- [x] **4.2** –ü–æ—Å–ª–µ `bot.send_message()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `send`
- [ ] **4.3** –ü–æ—Å–ª–µ `bot.edit_message_text()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `edit` (–Ω–µ—Ç edit –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ)
- [x] **4.4** –ü–æ—Å–ª–µ `bot.delete_message()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `delete`

### –≠—Ç–∞–ø 5: hangup.py

- [x] **5.1** –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `log_telegram_event`
- [x] **5.2** –ü–æ—Å–ª–µ `bot.send_message()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `send`
- [x] **5.3** –ü–æ—Å–ª–µ `bot.delete_message()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `delete`

### –≠—Ç–∞–ø 6: internal.py

- [x] **6.1** –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `log_telegram_event`
- [x] **6.2** –ü–æ—Å–ª–µ `bot.send_message()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `send`
- [ ] **6.3** –ü–æ—Å–ª–µ `bot.edit_message_text()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `edit` (–Ω–µ—Ç edit –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ)
- [x] **6.4** –ü–æ—Å–ª–µ `bot.delete_message()` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `delete`

### –≠—Ç–∞–ø 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [x] **7.1** –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å main
- [ ] **7.2** –°–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ –Ω–∞ 0367
- [ ] **7.3** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `call_tracer/0367/events.log`
- [ ] **7.4** –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –µ—Å—Ç—å AST –∏ TG –∑–∞–ø–∏—Å–∏
- [ ] **7.5** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ chat_id –∑–∞–ø–∏—Å–∞–Ω—ã

### –≠—Ç–∞–ø 8: –ö–æ–º–º–∏—Ç

- [ ] **8.1** –°–¥–µ–ª–∞—Ç—å –∫–æ–º–º–∏—Ç —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
- [ ] **8.2** Push –Ω–∞ GitHub

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ü–æ–ª—É—á–µ–Ω–∏–µ enterprise_number –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö

–í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö (start.py, dial.py –∏ —Ç.–¥.) –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å `enterprise_number` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è. 

**–í–∞—Ä–∏–∞–Ω—Ç 1:** –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏–∑ `main.py` —á–µ—Ä–µ–∑ `data`:
```python
# main.py –≤ _dispatch_to_all:
body["_enterprise_number"] = enterprise_number

# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ:
enterprise_number = data.get("_enterprise_number", "")
```

**–í–∞—Ä–∏–∞–Ω—Ç 2:** –ü–æ–ª—É—á–∞—Ç—å –ø–æ token –≤ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ:
```python
enterprise_number = await _get_enterprise_number_by_token(data.get("Token", ""))
```

**–í—ã–±–æ—Ä:** –í–∞—Ä–∏–∞–Ω—Ç 1 - –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —á–µ—Ä–µ–∑ data (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ, –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ –ë–î).

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–ü—Ä–∏ –æ—à–∏–±–∫–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è - –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é —Ä–∞–±–æ—Ç—É:
```python
try:
    await log_telegram_event(...)
except Exception as e:
    logger.warning(f"Failed to log telegram event: {e}")
```

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** Claude (Cursor AI)  
**–î–ª—è:** –ï–≤–≥–µ–Ω–∏–π  
**–î–∞—Ç–∞:** 30.11.2025
