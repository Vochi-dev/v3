# üìä –ê–ù–ê–õ–ò–ó TELEGRAM –°–û–ë–´–¢–ò–ô

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 29.11.2025  
**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –∫:** 10:00 GMT+3 30.11.2025

---

## üéØ –ó–ê–î–ê–ß–ê

–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑:
1. –ì–¥–µ –∏ –∫–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è Telegram —Å–æ–±—ã—Ç–∏—è
2. –ü–æ–ª–Ω—ã–π flow –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
3. –í—Å–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –≤ —Ä–∞–∑—Ä–µ–∑–µ –∫–∞–∂–¥–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–±–æ—Ç–∞)
4. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—é –≤ call_tracer

---

## üìÅ –°–¢–†–£–ö–¢–£–†–ê –ö–û–î–ê

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π:

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | Telegram –æ–ø–µ—Ä–∞—Ü–∏–∏ | –°—Ç–∞—Ç—É—Å |
|------|------------|-------------------|--------|
| `app/services/calls/start.py` | –°–æ–±—ã—Ç–∏–µ START | send_message | ‚úÖ **–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø** |
| `app/services/calls/dial.py` | –°–æ–±—ã—Ç–∏–µ DIAL | send_message, delete_message | ‚úÖ **–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø** |
| `app/services/calls/bridge.py` | –°–æ–±—ã—Ç–∏–µ BRIDGE | send_message, edit_message, delete_message | ‚úÖ **–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø** |
| `app/services/calls/hangup.py` | –°–æ–±—ã—Ç–∏–µ HANGUP | send_message, delete_message | ‚úÖ **–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø** |
| `app/services/calls/internal.py` | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–≤–æ–Ω–∫–∏ | send_message, edit_message, delete_message | ‚úÖ **–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø** |

### –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ–∞–π–ª—ã (–ù–ï –ò–°–ü–û–õ–¨–ó–£–Æ–¢–°–Ø):

| –§–∞–π–ª | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|--------|------------|
| `app/services/calls/start_v2.py` | ‚ùå **–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø** | –ù–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `__init__.py` |
| `app/services/calls/dial_v2.py` | ‚ùå **–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø** | –ù–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `__init__.py` |
| `app/services/calls/bridge_v2.py` | ‚ùå **–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø** | –ù–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `__init__.py` |
| `app/services/calls/hangup_v2.py` | ‚ùå **–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø** | –ù–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `__init__.py` |

> ‚ö†Ô∏è **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –§–∞–π–ª—ã `*_v2.py` –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `app/utils/logger_client.py` | –ö–ª–∏–µ–Ω—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Logger Service (8026) |
| `app/services/events.py` | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ –ë–î (call_events, telegram_messages) |
| `app/services/calls/utils.py` | In-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π |

---

## üîÑ FLOW –û–¢–ü–†–ê–í–ö–ò TELEGRAM –°–û–û–ë–©–ï–ù–ò–ô

### 1. –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: `main.py`

```
–•–æ—Å—Ç Asterisk ‚Üí POST /dial, /bridge, /hangup, etc. ‚Üí main.py
                                                        ‚Üì
                                            _dispatch_to_all(handler, body)
                                                        ‚Üì
                                            –î–ª—è –∫–∞–∂–¥–æ–≥–æ chat_id:
                                                handler(bot, chat_id, data)
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π

```python
# main.py: _get_bot_and_recipients(asterisk_token)
1. –ü–æ Token (name2) –Ω–∞—Ö–æ–¥–∏–º bot_token –∏–∑ —Ç–∞–±–ª–∏—Ü—ã enterprises
2. –ü–æ bot_token –Ω–∞—Ö–æ–¥–∏–º –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã telegram_users
3. –î–æ–±–∞–≤–ª—è–µ–º SUPERUSER_TG_ID (374573193) –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º (bot_token, [chat_id1, chat_id2, ...])
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è (–ø—Ä–∏–º–µ—Ä: hangup.py)

```python
async def process_hangup(bot: Bot, chat_id: int, data: dict):
    # 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–æ–±—ã—Ç–∏—è
    uid = data.get("UniqueId", "")
    token = data.get("Token", "")
    
    # 2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ enterprise_number –ø–æ token
    enterprise_number = await _get_enterprise_number_by_token(token)
    
    # 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ Call Logger (—Ñ–æ–Ω–æ–≤–æ)
    await call_logger.log_call_event(
        enterprise_number=enterprise_number,
        unique_id=uid,
        event_type="hangup",
        event_data=data,
        chat_id=chat_id,
        background=True
    )
    
    # 4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    text = "‚úÖ–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫\nüí∞+375..."
    
    # 5. –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (start, dial, bridge)
    await bot.delete_message(chat_id, prev_msg_id)
    
    # 6. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    sent = await bot.send_message(chat_id, text, parse_mode="HTML")
    
    # 7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    await save_telegram_message(sent.message_id, "hangup", token, ...)
    
    # 8. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —Å–æ–æ–±—â–µ–Ω–∏—è
    await call_logger.log_telegram_message(
        enterprise_number=enterprise_number,
        unique_id=uid,
        chat_id=chat_id,
        message_type="hangup",
        action="send",
        message_id=sent.message_id,
        message_text=text,
        background=True
    )
```

---

## üì® –¢–ò–ü–´ TELEGRAM –û–ü–ï–†–ê–¶–ò–ô

### 1. SEND (–æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)

| –°–æ–±—ã—Ç–∏–µ | –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è | –°–æ–¥–µ—Ä–∂–∏–º–æ–µ |
|---------|-------------------|------------|
| START | –ù–∞—á–∞–ª–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ | "üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫\nüí∞+375..." |
| DIAL | –ù–∞—á–∞–ª–æ –∏—Å—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ | "üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫\n‚òéÔ∏è151 ‚û°Ô∏è üí∞+375..." |
| BRIDGE | –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ | "‚òéÔ∏è151 üìû‚û°Ô∏è üí∞+375..." |
| HANGUP | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ | "‚úÖ–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫\nüí∞+375..." |

### 2. EDIT (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)

| –°–æ–±—ã—Ç–∏–µ | –ö–æ–≥–¥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è | –ß—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è |
|---------|---------------------|--------------|
| BRIDGE | –ü—Ä–∏ –¥–æ–æ–±–æ–≥–∞—â–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã–º–∏ | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –§–ò–û –∫–ª–∏–µ–Ω—Ç–∞, –º–µ–Ω–µ–¥–∂–µ—Ä–∞ |
| HANGUP_V2 | –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–ø–∏—Å—å |

### 3. DELETE (—É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)

| –°–æ–±—ã—Ç–∏–µ | –ö–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–¥–∞–ª—è–µ—Ç |
|---------|------------------------|
| DIAL | –£–¥–∞–ª—è–µ—Ç START |
| BRIDGE | –£–¥–∞–ª—è–µ—Ç DIAL |
| HANGUP | –£–¥–∞–ª—è–µ—Ç START, DIAL, BRIDGE |

---

## üë• –†–ê–ó–†–ï–ó –ü–û –ú–ï–ù–ï–î–ñ–ï–†–ê–ú (CHAT_ID)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:

```python
# app/services/calls/utils.py

# –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ chat_id:
dial_cache_by_chat = defaultdict(dict)       # {chat_id: {uid: data}}
bridge_store_by_chat = defaultdict(dict)     # {chat_id: {uid: message_id}}
active_bridges_by_chat = defaultdict(dict)   # {chat_id: {uid: data}}
phone_message_tracker_by_chat = defaultdict(dict)  # {chat_id: {phone: tracker_data}}
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ö–∞–∂–¥—ã–π chat_id –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ**
   - –ü—Ä–∏ –∑–≤–æ–Ω–∫–µ –Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ 0367 –≤—Å–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ —ç—Ç–æ–≥–æ –±–æ—Ç–∞ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - –ö–∞–∂–¥—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫ –∏–º–µ–µ—Ç —Å–≤–æ–π chat_id
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ chat_id –≤–µ–¥—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç—Ä–µ–∫–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π

2. **–ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ bot_token:**
   ```sql
   SELECT tg_id FROM telegram_users WHERE bot_token = $1
   ```

3. **–ü—Ä–∏–º–µ—Ä –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0367:**
   - bot_token: `7467098350:AAH...`
   - –ü–æ–¥–ø–∏—Å—á–∏–∫–∏: `[374573193, 7889254605, 7055556176]`
   - –ö–∞–∂–¥—ã–π –∏–∑ –Ω–∏—Ö –ø–æ–ª—É—á–∏—Ç: START ‚Üí DIAL ‚Üí BRIDGE ‚Üí HANGUP

---

## üìù –¢–ï–ö–£–©–ï–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï TELEGRAM

### 1. Logger Client (`app/utils/logger_client.py`)

```python
await call_logger.log_telegram_message(
    enterprise_number="0367",
    unique_id="1764429992.120",
    chat_id=374573193,
    message_type="hangup",      # start, dial, bridge, hangup
    action="send",              # send, edit, delete
    message_id=12345,
    message_text="‚úÖ–£—Å–ø–µ—à–Ω—ã–π...",
    background=True
)
```

### 2. –ö—É–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è:

- **Logger Service (8026)** ‚Üí `call_traces.telegram_messages` (JSONB)
- **events.py** ‚Üí `save_telegram_message()` - –ø–æ–∫–∞ –ø—É—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è

### 3. –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **–ù–µ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:**
   - DELETE –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
   - EDIT –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –≤—Å–µ–≥–¥–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
   
2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ call_traces –ø—Ä–æ–±–ª–µ–º–Ω–æ–µ:**
   - Race condition –ø—Ä–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π
   - –ó–∞–ø–∏—Å–∏ –º–æ–≥—É—Ç —Ç–µ—Ä—è—Ç—å—Å—è

3. **–ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –¥–ª—è –≤—Å–µ—Ö Telegram —Å–æ–±—ã—Ç–∏–π:**
   - –î–∞–Ω–Ω—ã–µ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –ø–æ —Ä–∞–∑–Ω—ã–º –º–µ—Å—Ç–∞–º
   - –°–ª–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É

---

## üí° –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ü–û –õ–û–ì–ò–†–û–í–ê–ù–ò–Æ

### –í–∞—Ä–∏–∞–Ω—Ç A: –î–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π call_tracer

**–§–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–∏ –≤ `call_tracer/{enterprise_number}/events.log`:**

```
2025-11-29 15:26:49,551|telegram_send|1764429992.120|{"chat_id": 374573193, "message_type": "hangup", "message_id": 12345, "text": "‚úÖ–£—Å–ø–µ—à–Ω—ã–π..."}
2025-11-29 15:26:49,600|telegram_delete|1764429992.120|{"chat_id": 374573193, "message_type": "bridge", "message_id": 12340}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ (Asterisk —Å–æ–±—ã—Ç–∏—è + Telegram)
- –ï–¥–∏–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è 14 –¥–Ω–µ–π
- –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –°–º–µ—à–∏–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
- –°–ª–æ–∂–Ω–µ–µ –ø–∞—Ä—Å–∏—Ç—å –ø—Ä–∏ —Å–±–æ—Ä–∫–µ

### –í–∞—Ä–∏–∞–Ω—Ç B: –û—Ç–¥–µ–ª—å–Ω–∞—è –ø–∞–ø–∫–∞ –¥–ª—è Telegram

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
call_tracer/
‚îú‚îÄ‚îÄ 0367/
‚îÇ   ‚îú‚îÄ‚îÄ events.log          # Asterisk —Å–æ–±—ã—Ç–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ telegram.log        # Telegram –æ–ø–µ—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ 0368/
‚îÇ   ‚îú‚îÄ‚îÄ events.log
‚îÇ   ‚îî‚îÄ‚îÄ telegram.log
```

**–§–æ—Ä–º–∞—Ç `telegram.log`:**
```
2025-11-29 15:26:49,551|send|374573193|hangup|12345|1764429992.120|‚úÖ–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...
2025-11-29 15:26:49,600|delete|374573193|bridge|12340|1764429992.120|
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –õ–µ–≥—á–µ –ø–∞—Ä—Å–∏—Ç—å
- –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —Ä–∞–∑–Ω—É—é —Ä–æ—Ç–∞—Ü–∏—é

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –î–≤–∞ —Ñ–∞–π–ª–∞ –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ
- –ù—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ —Å–±–æ—Ä–∫–µ

### –í–∞—Ä–∏–∞–Ω—Ç C: –ï–¥–∏–Ω—ã–π —Ñ–∞–π–ª —Å —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π

**–§–æ—Ä–º–∞—Ç:**
```
2025-11-29 15:26:33,859|AST|dial|1764429992.120|{"Phone": "375296254070"...}
2025-11-29 15:26:49,551|TG|send|374573193|hangup|12345|1764429992.120|‚úÖ–£—Å–ø–µ—à–Ω—ã–π...
2025-11-29 15:26:49,600|TG|delete|374573193|bridge|12340|1764429992.120|
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –û–¥–∏–Ω —Ñ–∞–π–ª —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –•—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫
- –õ–µ–≥–∫–æ –≤–∏–¥–µ—Ç—å —Å–≤—è–∑—å –º–µ–∂–¥—É —Å–æ–±—ã—Ç–∏—è–º–∏

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- –ù—É–∂–µ–Ω –ø–∞—Ä—Å–µ—Ä –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø–∏—Å–µ–π

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

**–†–µ–∫–æ–º–µ–Ω–¥—É—é –í–∞—Ä–∏–∞–Ω—Ç C** - –µ–¥–∏–Ω—ã–π —Ñ–∞–π–ª —Å —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π.

### –ü–æ—á–µ–º—É:

1. **–•—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫** - –≤–∏–¥–Ω–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 
   - AST dial ‚Üí TG send dial ‚Üí AST bridge ‚Üí TG delete dial ‚Üí TG send bridge ‚Üí ...

2. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —Å–±–æ—Ä–∫–∏** - –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ "–î–µ—Ç–∞–ª–∏ –∑–≤–æ–Ω–∫–∞":
   - –ë–µ—Ä—ë–º UniqueId –∏–∑ hangup
   - grep –ø–æ —ç—Ç–æ–º—É UniqueId –≤ —Ñ–∞–π–ª–µ
   - –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Å–æ–±—ã—Ç–∏—è (–∏ Asterisk, –∏ Telegram)

3. **–û–¥–∏–Ω —Ñ–∞–π–ª = –æ–¥–Ω–∞ —Ä–æ—Ç–∞—Ü–∏—è** - –ø—Ä–æ—â–µ —É–ø—Ä–∞–≤–ª—è—Ç—å

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:

1. **–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –≤ `main.py`:**
   ```python
   # Asterisk —Å–æ–±—ã—Ç–∏–µ
   tracer.info(f"AST|{event_type}|{unique_id}|{json.dumps(body)}")
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:**
   ```python
   # –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
   tracer.info(f"TG|send|{chat_id}|{message_type}|{message_id}|{unique_id}|{text[:100]}")
   
   # –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
   tracer.info(f"TG|delete|{chat_id}|{message_type}|{message_id}|{unique_id}|")
   
   # –ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   tracer.info(f"TG|edit|{chat_id}|{message_type}|{message_id}|{unique_id}|{new_text[:100]}")
   ```

---

## üìã –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –≠—Ç–∞–ø 1: –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Ç–µ–∫—É—â–µ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (30 –º–∏–Ω)

1. –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –≤ `main.py`:
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å `AST|` –∫ —Å–æ–±—ã—Ç–∏—è–º Asterisk

### –≠—Ç–∞–ø 2: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram (2-3 —á–∞—Å–∞)

1. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `log_telegram_event(enterprise_number, chat_id, action, message_type, message_id, unique_id, text)`
2. –í—ã–∑—ã–≤–∞—Ç—å –µ—ë –≤–æ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö:
   - `start.py` - –ø–æ—Å–ª–µ send_message
   - `dial.py` - –ø–æ—Å–ª–µ send_message, delete_message
   - `bridge.py` - –ø–æ—Å–ª–µ send_message, edit_message, delete_message
   - `hangup.py` - –ø–æ—Å–ª–µ send_message, delete_message
   - `internal.py` - –ø–æ—Å–ª–µ send_message, edit_message, delete_message

### –≠—Ç–∞–ø 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1 —á–∞—Å)

1. –°–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∑–∞–ø–∏—Å–∞–ª–∏—Å—å
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –∏ –ø–æ–ª–Ω–æ—Ç—É –¥–∞–Ω–Ω—ã—Ö

### –≠—Ç–∞–ø 4: –°–µ—Ä–≤–∏—Å —Å–±–æ—Ä–∫–∏ (–æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞)

1. –≠–Ω–¥–ø–æ–∏–Ω—Ç `/call/details/{unique_id}`
2. –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞ –ª–æ–≥–æ–≤
3. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –¥–µ—Ç–∞–ª—è–º–∏

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. **–§–∞–π–ª—ã `*_v2.py` –ù–ï –ò–°–ü–û–õ–¨–ó–£–Æ–¢–°–Ø:**
   - `start_v2.py`, `dial_v2.py`, `bridge_v2.py`, `hangup_v2.py` - —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –≤–µ—Ä—Å–∏–∏
   - –ù–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ `__init__.py`, –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ `main.py`
   - –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã

2. **DELETE –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:**
   - –í —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ `bot.delete_message()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è

3. **EDIT –æ–ø–µ—Ä–∞—Ü–∏–∏:**
   - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `hangup.py` (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞)
   - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ `bridge.py` (–æ–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏)
   - –ù–µ –≤—Å–µ–≥–¥–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è

4. **–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π:**
   - –ú–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º (>1000 —Å–∏–º–≤–æ–ª–æ–≤)
   - –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–µ–∑–∞—Ç—å –¥–æ 200-300 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –ª–æ–≥–∞—Ö

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ö–û–î–£

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –§–∞–π–ª–æ–≤ —Å Telegram –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ (–∞–∫—Ç–∏–≤–Ω—ã—Ö) | 5 |
| –§–∞–π–ª–æ–≤ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö (*_v2.py) | 4 |
| –í—ã–∑–æ–≤–æ–≤ `bot.send_message` | ~20 |
| –í—ã–∑–æ–≤–æ–≤ `bot.delete_message` | ~12 |
| –í—ã–∑–æ–≤–æ–≤ `bot.edit_message` | ~5 |
| –í—ã–∑–æ–≤–æ–≤ `call_logger.log_telegram_message` | 4 |

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** Claude (Cursor AI)  
**–î–ª—è:** –ï–≤–≥–µ–Ω–∏–π  
**–î–∞—Ç–∞:** 29.11.2025

