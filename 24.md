# Интеграция Битрикс24 с Asterisk Webhook

## Обзор документации API Битрикс24

На основе тщательного изучения документации https://apidocs.bitrix24.ru/ был проведен анализ возможностей интеграции телефонии с Битрикс24.

### Ключевые разделы изученной документации:

1. **Телефония API** - https://apidocs.bitrix24.ru/api-reference/telephony/index.html
2. **OAuth 2.0 авторизация** - https://apidocs.bitrix24.ru/api-reference/oauth/index.html  
3. **CRM методы** - https://apidocs.bitrix24.ru/api-reference/crm/index.html
4. **Установка приложений** - https://apidocs.bitrix24.ru/api-reference/app-installation/index.html
5. **Обработка событий** - https://apidocs.bitrix24.ru/api-reference/events/index.html

## Архитектурное видение интеграции

### Модель интеграции: Взаимные Webhook'и

**Рекомендуемый подход**: Двусторонняя интеграция через вебхуки

**Принцип работы**:
- Битрикс24 отправляет события на наш endpoint (исходящие звонки из CRM)
- Мы отправляем события телефонии в Битрикс24 через их webhook (входящие звонки, hangup)
- Пользователь самостоятельно настраивает webhook в Битрикс24 для приема наших событий
- Мы предоставляем endpoint для приема событий от Битрикс24

**Преимущества**:
- Простота настройки без OAuth
- Прямая интеграция без промежуточных серверов
- Полный контроль над процессом авторизации
- Возможность работы с локальными вебхуками Битрикс24
- Быстрое развертывание

### Основные компоненты архитектуры

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Битрикс24     │    │   Наш Сервис    │    │   Asterisk      │
│   Портал        │    │   (FastAPI)     │    │   Webhook       │
│                 │◄───┤                 │◄──►│   System        │
│ Webhook генератор│    │ /bitrix24/      │    │                 │
│                 ├───►│ webhook         │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
        │                        │                        │
        ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ События:        │    │ Webhook токены  │    │ Call events:    │
│ - OnExternalCall│    │ - incoming_url  │    │ - dial          │
│ - исходящие     │    │ - outgoing_url  │    │ - hangup        │
│ - обратные      │    │ - auth_tokens   │    │ - bridge        │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Ключевые API методы для интеграции

### Телефония (Scope: telephony)

1. **telephony.externalcall.register** - Регистрация звонка
   - Параметры: USER_ID/USER_PHONE_INNER, PHONE_NUMBER, TYPE (1-исходящий, 2-входящий)
   - Опции: CRM_CREATE, CRM_SOURCE, SHOW (popup), LINE_NUMBER
   - Возврат: CALL_ID, CRM_ENTITY_ID, CRM_ENTITY_TYPE

2. **telephony.externalcall.finish** - Завершение звонка  
   - Параметры: CALL_ID, USER_ID, DURATION, STATUS_CODE
   - Опции: COST, RECORD_URL, VOTE, ADD_TO_CHAT

3. **telephony.externalcall.show** - Показ карточки звонка
4. **telephony.externalcall.hide** - Скрытие карточки звонка
5. **telephony.externalCall.attachRecord** - Прикрепление записи звонка
6. **telephony.externalLine.add** - Добавление внешней линии

### События телефонии

1. **OnExternalCallStart** - Исходящий звонок из CRM
   - Поля: USER_ID, PHONE_NUMBER, CRM_ENTITY_TYPE, CRM_ENTITY_ID, CALL_ID
   - Триггер: клик по номеру в CRM объекте

2. **OnExternalCallBackStart** - Обратный звонок из CRM формы

### CRM интеграция (Scope: crm)

1. **crm.contact.list/get** - Поиск контактов по телефону
2. **crm.contact.add** - Создание нового контакта
3. **crm.lead.add** - Создание лида
4. **crm.deal.add** - Создание сделки
5. **telephony.externalCall.searchCrmEntities** - Поиск CRM объектов по номеру

## Детальный план реализации

### Phase 1: Базовая инфраструктура (1-2 недели)

#### 1.1 Настройка Webhook интеграции
- [ ] Создание endpoint'а для приема событий от Битрикс24: `/bitrix24/webhook/{enterprise_number}`
- [ ] Создание системы аутентификации webhook'ов (токены, подписи)
- [ ] Настройка логирования всех входящих webhook'ов от Битрикс24
- [ ] Документация для пользователей по настройке вебхуков в Битрикс24

#### 1.2 Локальные вебхуки Битрикс24
- [ ] Изучение системы локальных вебхуков в Битрикс24
- [ ] Создание механизма для отправки событий в Битрикс24 webhook'и
- [ ] Настройка HTTP клиента для отправки POST запросов
- [ ] Обработка ошибок и retry логика для отправки

#### 1.3 Система конфигурации
- [ ] Создание интерфейса для настройки Битрикс24 интеграции в админке
- [ ] Поля для ввода:
  - URL исходящего вебхука Битрикс24 (куда мы отправляем события)
  - Токен аутентификации исходящего вебхука
  - Токен для входящих событий (проверка подлинности)
  - Настройки маппинга пользователей
- [ ] Валидация URL'ов и токенов

#### 1.4 Интеграция с существующей системой
- [ ] Создание таблицы `bitrix24_integrations` в БД:
  ```sql
  CREATE TABLE bitrix24_integrations (
    id SERIAL PRIMARY KEY,
    enterprise_number VARCHAR(50) NOT NULL,
    webhook_incoming_url VARCHAR(512),  -- куда Битрикс24 отправляет события
    webhook_outgoing_url VARCHAR(512),  -- куда мы отправляем события
    webhook_incoming_token VARCHAR(255), -- токен для проверки входящих
    webhook_outgoing_token VARCHAR(255), -- токен для исходящих
    portal_domain VARCHAR(255),
    user_mapping JSONB DEFAULT '{}',    -- маппинг extensions -> user_id
    settings JSONB DEFAULT '{}',
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(enterprise_number)
  );
  ```
- [ ] Интеграция с integration_cache.py для кеширования конфигураций
- [ ] Расширение существующих моделей для поддержки Битрикс24

### Phase 2: Телефонная интеграция (2-3 недели)

#### 2.1 Прием событий от Битрикс24
- [ ] Реализация endpoint `/bitrix24/webhook/{enterprise_number}` для приема событий
- [ ] Парсинг события `OnExternalCallStart` (исходящий звонок из CRM)
- [ ] Парсинг события `OnExternalCallBackStart` (обратный звонок)
- [ ] Аутентификация входящих webhook'ов по токену
- [ ] Маппинг USER_ID из Битрикс24 → extension в Asterisk

#### 2.2 Обработка входящих звонков (отправка в Битрикс24)
- [ ] Модификация существующих Asterisk webhook handlers
- [ ] Формирование webhook payload для отправки в Битрикс24:
  ```json
  {
    "event": "CALL_START",
    "phone_number": "+375291234567",
    "user_extension": "150", 
    "direction": "incoming",
    "unique_id": "asterisk_unique_id",
    "timestamp": "2024-01-01T12:00:00Z"
  }
  ```
- [ ] Отправка события в webhook_outgoing_url с аутентификацией

#### 2.3 Завершение звонков (отправка в Битрикс24)
- [ ] Обновление метода обработки hangup событий
- [ ] Формирование webhook payload для завершения звонка:
  ```json
  {
    "event": "CALL_END",
    "phone_number": "+375291234567",
    "user_extension": "150",
    "direction": "incoming",
    "unique_id": "asterisk_unique_id", 
    "duration": 120,
    "status": "answered",
    "record_url": "https://example.com/records/file.mp3",
    "timestamp": "2024-01-01T12:02:00Z"
  }
  ```
- [ ] Retry логика при неудачной отправке

#### 2.4 Обработка исходящих звонков из Битрикс24
- [ ] Обработка события `OnExternalCallStart` от Битрикс24
- [ ] Извлечение данных: USER_ID, PHONE_NUMBER, CRM_ENTITY_ID, CALL_ID
- [ ] Маппинг USER_ID → Asterisk extension
- [ ] Вызов Asterisk API для инициации звонка: `http://localhost:8018/api/makecallexternal`
- [ ] Отправка подтверждения обратно в Битрикс24

### Phase 3: Расширенная функциональность (2-3 недели)

#### 3.1 Админка для настройки интеграции
- [ ] Создание страницы настройки Битрикс24 в админке предприятия
- [ ] Поля для конфигурации:
  - Включение/отключение интеграции
  - URL исходящего webhook'а Битрикс24
  - Токены аутентификации
  - Таблица маппинга пользователей: extension ↔ USER_ID
- [ ] Тестирование соединения с Битрикс24
- [ ] Валидация настроек

#### 3.2 Обработка различных типов событий
- [ ] Расширение обработки событий Битрикс24:
  - `OnExternalCallStart` - исходящий звонок
  - `OnExternalCallBackStart` - обратный звонок
  - Дополнительные события CRM (по необходимости)
- [ ] Обработка контекста CRM в событиях (CRM_ENTITY_TYPE, CRM_ENTITY_ID)
- [ ] Передача дополнительной информации в Asterisk

#### 3.3 Улучшенная отправка данных в Битрикс24
- [ ] Расширенные payload'ы для webhook'ов:
  - Информация о клиенте из CRM
  - Контекст звонка (откуда звонят, тип звонка)
  - Метаданные о записи разговора
- [ ] Настраиваемые форматы сообщений
- [ ] Поддержка batch отправки событий

#### 3.4 Мониторинг и диагностика
- [ ] Логирование всех webhook взаимодействий
- [ ] Статистика успешности отправки/получения
- [ ] Dashboard интеграции в админке
- [ ] Алерты при сбоях интеграции

### Phase 4: Тестирование и оптимизация (2-3 недели)

#### 4.1 Тестирование интеграции
- [ ] Unit тесты для всех webhook handlers
- [ ] Интеграционные тесты с тестовым Битрикс24
- [ ] Тестирование обработки ошибок и edge cases
- [ ] Тестирование различных сценариев звонков
- [ ] Проверка retry логики и отказоустойчивости

#### 4.2 Оптимизация производительности
- [ ] Асинхронная отправка webhook'ов
- [ ] Очереди для обработки событий при высокой нагрузке
- [ ] Кеширование часто используемых данных
- [ ] Оптимизация маппинга пользователей

#### 4.3 Security и надежность
- [ ] Валидация подписей webhook'ов
- [ ] Rate limiting для входящих webhook'ов
- [ ] Защита от replay атак
- [ ] Шифрование токенов в БД

#### 4.4 Документация пользователя
- [ ] Руководство по настройке webhook'ов в Битрикс24
- [ ] Пошаговая инструкция настройки интеграции
- [ ] Troubleshooting guide
- [ ] FAQ по интеграции

### Phase 5: Деплой и поддержка (1-2 недели)

#### 5.1 Подготовка к production
- [ ] Настройка production окружения
- [ ] Миграция данных и конфигураций
- [ ] Резервное копирование и восстановление
- [ ] Security аудит webhook endpoints

#### 5.2 Развертывание
- [ ] Поэтапный rollout для тестовых предприятий
- [ ] Мониторинг webhook'ов после деплоя
- [ ] Оперативное исправление критических багов
- [ ] Обучение пользователей настройке вебхуков

#### 5.3 Поддержка и сопровождение
- [ ] Создание системы технической поддержки
- [ ] Процедуры диагностики проблем интеграции
- [ ] Регулярные health checks webhook endpoints
- [ ] Планирование развития функциональности

## Технические детали реализации

### Структура кода

```
bitrix24/
├── __init__.py
├── webhook_handler.py    # Обработка входящих webhook'ов от Битрикс24
├── webhook_sender.py     # Отправка событий в Битрикс24 webhook'и  
├── auth.py              # Аутентификация webhook'ов (токены, подписи)
├── events.py            # Парсинг и обработка событий
├── models.py            # SQLAlchemy модели для БД
├── config.py            # Конфигурация интеграции
├── exceptions.py        # Исключения
└── utils.py             # Вспомогательные функции
```

### Ключевые классы

```python
class Bitrix24WebhookHandler:
    """Обработчик входящих webhook'ов от Битрикс24"""
    
    def __init__(self, enterprise_number: str)
    async def handle_external_call_start(self, event_data: dict)
    async def handle_callback_start(self, event_data: dict)
    async def authenticate_webhook(self, token: str, payload: dict)
    
class Bitrix24WebhookSender:
    """Отправка событий в webhook Битрикс24"""
    
    def __init__(self, webhook_url: str, auth_token: str)
    async def send_call_start(self, phone: str, extension: str, direction: str)
    async def send_call_end(self, phone: str, extension: str, duration: int, status: str)
    async def send_with_retry(self, payload: dict, max_retries: int = 3)

class Bitrix24ConfigManager:
    """Управление конфигурацией интеграции"""
    
    async def get_config(self, enterprise_number: str)
    async def update_config(self, enterprise_number: str, config: dict)
    async def get_user_mapping(self, enterprise_number: str)
```

### Интеграция с существующей системой

#### Новый файл bitrix24.py

```python
# Создание нового сервиса для Битрикс24 интеграции
@app.post("/bitrix24/webhook/{enterprise_number}")
async def bitrix24_webhook(enterprise_number: str, request: Request):
    """Обработка входящих webhook'ов от Битрикс24"""
    
    # Получение конфигурации
    b24_config = await get_bitrix24_config_from_cache(enterprise_number)
    if not b24_config or not b24_config.get('enabled'):
        raise HTTPException(status_code=404, detail="Битрикс24 integration not found")
    
    # Аутентификация webhook'а
    body = await request.json()
    if not await authenticate_bitrix24_webhook(b24_config, body, request.headers):
        raise HTTPException(status_code=401, detail="Unauthorized webhook")
    
    # Обработка события
    event_type = body.get('event')
    if event_type == 'OnExternalCallStart':
        await handle_external_call_start(enterprise_number, body)
    elif event_type == 'OnExternalCallBackStart':
        await handle_callback_start(enterprise_number, body)
    
    return {"status": "success"}

async def send_call_event_to_bitrix24(enterprise_number: str, event_data: dict):
    """Отправка события звонка в Битрикс24"""
    
    b24_config = await get_bitrix24_config_from_cache(enterprise_number)
    if not b24_config or not b24_config.get('webhook_outgoing_url'):
        return
    
    # Отправка webhook'а в Битрикс24
    sender = Bitrix24WebhookSender(
        webhook_url=b24_config['webhook_outgoing_url'],
        auth_token=b24_config.get('webhook_outgoing_token')
    )
    
    await sender.send_call_event(event_data)

# Интеграция с существующими обработчиками
async def process_incoming_call_bitrix24(phone: str, extension: str, enterprise_number: str):
    """Обработка входящего звонка - отправка в Битрикс24"""
    
    event_data = {
        "event": "CALL_START",
        "phone_number": phone,
        "user_extension": extension,
        "direction": "incoming",
        "unique_id": f"{enterprise_number}_{phone}_{extension}_{int(time.time())}",
        "timestamp": datetime.now().isoformat()
    }
    
    await send_call_event_to_bitrix24(enterprise_number, event_data)

async def update_bitrix24_call_with_recording(phone: str, extension: str, enterprise_number: str, 
                                           duration: int, record_url: str, status: str):
    """Завершение звонка - отправка в Битрикс24"""
    
    event_data = {
        "event": "CALL_END",
        "phone_number": phone,
        "user_extension": extension,
        "direction": "incoming",
        "duration": duration,
        "status": status,
        "record_url": record_url,
        "timestamp": datetime.now().isoformat()
    }
    
    await send_call_event_to_bitrix24(enterprise_number, event_data)
```

### База данных

#### Новые таблицы

```sql
-- Конфигурации интеграций Битрикс24
CREATE TABLE bitrix24_integrations (
    id SERIAL PRIMARY KEY,
    enterprise_number VARCHAR(50) NOT NULL,
    portal_domain VARCHAR(255) NOT NULL,
    access_token TEXT,
    refresh_token TEXT,
    expires_at TIMESTAMP,
    client_endpoint TEXT,
    member_id VARCHAR(255),
    scope TEXT,
    settings JSONB DEFAULT '{}',
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(enterprise_number, portal_domain)
);

-- Логи webhook взаимодействий
CREATE TABLE bitrix24_webhook_logs (
    id SERIAL PRIMARY KEY,
    enterprise_number VARCHAR(50) NOT NULL,
    direction VARCHAR(20) NOT NULL, -- 'incoming' | 'outgoing'
    webhook_url VARCHAR(512),
    event_type VARCHAR(100),
    payload JSONB,
    response_status INTEGER,
    response_body TEXT,
    error_message TEXT,
    processing_time_ms INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX(enterprise_number, direction, created_at),
    INDEX(event_type, created_at)
);

-- Статистика работы интеграции
CREATE TABLE bitrix24_integration_stats (
    id SERIAL PRIMARY KEY,
    enterprise_number VARCHAR(50) NOT NULL,
    date DATE NOT NULL,
    webhooks_sent INTEGER DEFAULT 0,
    webhooks_received INTEGER DEFAULT 0,
    webhooks_failed INTEGER DEFAULT 0,
    calls_processed INTEGER DEFAULT 0,
    avg_response_time_ms INTEGER DEFAULT 0,
    last_error_at TIMESTAMP,
    last_error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(enterprise_number, date)
);
```

### Конфигурация

#### Настройки в integration_cache.py

```python
# Расширение конфигурации предприятий для webhook модели
{
    "enterprise_number": "example123",
    "integrations": {
        "moysklad": { ... },
        "bitrix24": {
            "enabled": true,
            "portal_domain": "example.bitrix24.ru",
            "webhook_incoming_url": "https://our-service.com/bitrix24/webhook/example123",
            "webhook_outgoing_url": "https://example.bitrix24.ru/rest/123/abc123/call/", 
            "webhook_incoming_token": "our_verification_token",
            "webhook_outgoing_token": "bitrix24_webhook_token",
            "user_mapping": {
                "150": 25,  # extension -> bitrix24_user_id
                "151": 26,
                "152": 27
            },
            "settings": {
                "send_call_start": true,
                "send_call_end": true,
                "attach_recordings": true,
                "retry_attempts": 3,
                "timeout_seconds": 10
            }
        }
    }
}
```

## Риски и ограничения

### Технические риски

1. **Надежность webhook соединений**
   - Битрикс24 может не получить наши webhook'и при сбоях сети
   - Необходимость robust retry логики с экспоненциальной задержкой
   - Таймауты и обработка ошибок HTTP
   - Мониторинг статуса доставки

2. **Безопасность webhook'ов**
   - Отсутствие стандартной подписи webhook'ов в Битрикс24
   - Аутентификация только по токенам
   - Возможность replay атак
   - Необходимость дополнительной валидации

3. **Конфигурация пользователями**
   - Сложность настройки webhook'ов в Битрикс24 для пользователей
   - Ошибки в URL'ах и токенах
   - Отсутствие автоматической проверки настроек
   - Необходимость детальной документации

### Бизнес риски

1. **Сложность настройки для пользователей**
   - Необходимость ручной настройки webhook'ов в Битрикс24
   - Потребность в технических знаниях у пользователей
   - Возможность ошибок конфигурации

2. **Поддержка и диагностика**
   - Сложность диагностики проблем webhook'ов
   - Необходимость инструментов мониторинга
   - Потребность в квалифицированной технической поддержке

3. **Производительность**
   - Дополнительные HTTP запросы для каждого звонка
   - Зависимость от скорости ответа Битрикс24
   - Необходимость асинхронной обработки

## Метрики успеха

### Технические метрики

- [ ] 99.5% успешности доставки webhook'ов в Битрикс24
- [ ] < 3 секунды задержки обработки входящих звонков  
- [ ] 100% успешности приема webhook'ов от Битрикс24
- [ ] < 5% потерь записей разговоров при передаче URL'ов
- [ ] 95%+ uptime webhook endpoints

### Бизнес метрики

- [ ] Успешная настройка интеграции в 90%+ случаев
- [ ] Корректная передача 98%+ событий звонков
- [ ] Сокращение времени настройки интеграции до 30 минут
- [ ] Уменьшение количества обращений в поддержку по интеграции на 50%

## Заключение

Интеграция с Битрикс24 через взаимные webhook'и представляет собой эффективное расширение функциональности нашей телефонной системы. Основываясь на изученной документации API Битрикс24, можно реализовать надежную интеграцию, которая будет:

1. **Получать события исходящих звонков** из CRM Битрикс24 через webhook'и
2. **Отправлять события телефонии** в Битрикс24 через их локальные webhook'и
3. **Обеспечивать двустороннюю синхронизацию** событий звонков
4. **Предоставлять простую настройку** без сложной OAuth авторизации
5. **Масштабироваться** на множество предприятий с индивидуальными настройками

### Ключевые преимущества webhook подхода:

- ✅ **Простота настройки**: Пользователь настраивает webhook'и в Битрикс24 самостоятельно
- ✅ **Прямая интеграция**: Никаких промежуточных серверов авторизации
- ✅ **Гибкость**: Полный контроль над форматом и содержимым сообщений
- ✅ **Быстрое развертывание**: Не требует регистрации в маркетплейсе
- ✅ **Надежность**: Retry логика и мониторинг доставки

Реализация потребует 10-12 недель разработки с учетом тестирования и документации. Архитектура построена на простых HTTP webhook'ах, что обеспечивает надежность, простоту отладки и легкость поддержки решения.


