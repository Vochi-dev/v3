# Интеграция Битрикс24 с Asterisk Webhook

## Обзор документации API Битрикс24

На основе тщательного изучения документации https://apidocs.bitrix24.ru/ был проведен анализ возможностей интеграции телефонии с Битрикс24.

### Ключевые разделы изученной документации:

1. **Телефония API** - https://apidocs.bitrix24.ru/api-reference/telephony/index.html
2. **OAuth 2.0 авторизация** - https://apidocs.bitrix24.ru/api-reference/oauth/index.html  
3. **CRM методы** - https://apidocs.bitrix24.ru/api-reference/crm/index.html
4. **Установка приложений** - https://apidocs.bitrix24.ru/api-reference/app-installation/index.html
5. **Обработка событий** - https://apidocs.bitrix24.ru/api-reference/events/index.html

## Архитектурное видение интеграции

### Модель интеграции: Marketplace приложение vs Локальная интеграция

**Рекомендуемый подход**: Разработка приложения для Marketplace Битрикс24

**Преимущества**:
- Централизованная авторизация через OAuth 2.0
- Автоматическое управление токенами
- Возможность масштабирования на множество порталов
- Поддержка событийной модели
- Интеграция с UI Битрикс24

### Основные компоненты архитектуры

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Битрикс24     │    │   Наше          │    │   Asterisk      │
│   Портал        │◄──►│   Приложение    │◄──►│   Webhook       │
│                 │    │   (FastAPI)     │    │   System        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
        │                        │                        │
        ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ CRM объекты:    │    │ OAuth токены    │    │ Call events:    │
│ - Лиды          │    │ - access_token  │    │ - dial          │
│ - Контакты      │    │ - refresh_token │    │ - hangup        │
│ - Сделки        │    │ - endpoints     │    │ - bridge        │
│ - Компании      │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Ключевые API методы для интеграции

### Телефония (Scope: telephony)

1. **telephony.externalcall.register** - Регистрация звонка
   - Параметры: USER_ID/USER_PHONE_INNER, PHONE_NUMBER, TYPE (1-исходящий, 2-входящий)
   - Опции: CRM_CREATE, CRM_SOURCE, SHOW (popup), LINE_NUMBER
   - Возврат: CALL_ID, CRM_ENTITY_ID, CRM_ENTITY_TYPE

2. **telephony.externalcall.finish** - Завершение звонка  
   - Параметры: CALL_ID, USER_ID, DURATION, STATUS_CODE
   - Опции: COST, RECORD_URL, VOTE, ADD_TO_CHAT

3. **telephony.externalcall.show** - Показ карточки звонка
4. **telephony.externalcall.hide** - Скрытие карточки звонка
5. **telephony.externalCall.attachRecord** - Прикрепление записи звонка
6. **telephony.externalLine.add** - Добавление внешней линии

### События телефонии

1. **OnExternalCallStart** - Исходящий звонок из CRM
   - Поля: USER_ID, PHONE_NUMBER, CRM_ENTITY_TYPE, CRM_ENTITY_ID, CALL_ID
   - Триггер: клик по номеру в CRM объекте

2. **OnExternalCallBackStart** - Обратный звонок из CRM формы

### CRM интеграция (Scope: crm)

1. **crm.contact.list/get** - Поиск контактов по телефону
2. **crm.contact.add** - Создание нового контакта
3. **crm.lead.add** - Создание лида
4. **crm.deal.add** - Создание сделки
5. **telephony.externalCall.searchCrmEntities** - Поиск CRM объектов по номеру

## Детальный план реализации

### Phase 1: Базовая инфраструктура (1-2 недели)

#### 1.1 Создание приложения Битрикс24
- [ ] Регистрация в партнерском кабинете developers.bitrix24.ru
- [ ] Создание приложения в Marketplace
- [ ] Настройка OAuth параметров (client_id, client_secret, redirect_uri)
- [ ] Определение необходимых scope: `telephony`, `crm`

#### 1.2 OAuth авторизация  
- [ ] Реализация полного цикла OAuth 2.0
  - Редирект пользователя на авторизацию: `{domain}/oauth/authorize/?client_id={}&state={}`
  - Получение authorization code
  - Обмен кода на access_token через `oauth.bitrix24.tech/oauth/token/`
  - Автообновление токенов через refresh_token
- [ ] Хранение токенов в БД с привязкой к portal domain
- [ ] Middleware для автоматической авторизации запросов

#### 1.3 Базовые API методы
- [ ] Класс Bitrix24Client для работы с REST API
- [ ] Методы для работы с токенами и их обновления
- [ ] Обработка ошибок авторизации и лимитов API
- [ ] Логирование всех API вызовов

#### 1.4 Интеграция с существующей системой
- [ ] Создание таблицы `bitrix24_integrations` в БД:
  ```sql
  CREATE TABLE bitrix24_integrations (
    id SERIAL PRIMARY KEY,
    enterprise_number VARCHAR(50) NOT NULL,
    portal_domain VARCHAR(255) NOT NULL,
    access_token TEXT,
    refresh_token TEXT,
    expires_at TIMESTAMP,
    client_endpoint TEXT,
    member_id VARCHAR(255),
    scope TEXT,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
  );
  ```
- [ ] Интеграция с integration_cache.py для кеширования конфигураций
- [ ] Расширение существующих моделей для поддержки Битрикс24

### Phase 2: Телефонная интеграция (2-3 недели)

#### 2.1 Регистрация внешних линий
- [ ] Автоматическая регистрация телефонных линий через `telephony.externalLine.add`
- [ ] Синхронизация списка внутренних номеров сотрудников
- [ ] Настройка маппинга Asterisk extensions ↔ Битрикс24 USER_ID

#### 2.2 Обработка входящих звонков
- [ ] Модификация существующих Asterisk webhook handlers
- [ ] Интеграция с `telephony.externalcall.register`:
  - Автоматический поиск CRM объектов по номеру
  - Создание лидов для новых номеров (CRM_CREATE=1)
  - Показ popup карточки сотруднику (SHOW=1)
- [ ] Отправка уведомлений в реальном времени

#### 2.3 Завершение звонков
- [ ] Обновление метода обработки hangup событий
- [ ] Интеграция с `telephony.externalcall.finish`:
  - Передача длительности разговора
  - Статус звонка (200-успешный, 304-пропущенный, и т.д.)
  - Прикрепление записи разговора через RECORD_URL
- [ ] Создание дел "Звонок" в CRM

#### 2.4 Обработка исходящих звонков
- [ ] Подписка на событие `OnExternalCallStart`
- [ ] Webhook endpoint для обработки исходящих звонков из CRM
- [ ] Интеграция с Asterisk API для инициации звонков
- [ ] Автоматическое завершение звонков в Битрикс24

### Phase 3: CRM интеграция (2-3 недели)

#### 3.1 Поиск и создание контактов
- [ ] Реализация поиска существующих CRM объектов:
  - `telephony.externalCall.searchCrmEntities` по номеру телефона
  - Поиск в контактах, лидах, компаниях
- [ ] Автоматическое создание лидов для новых номеров
- [ ] Связывание звонков с найденными CRM объектами

#### 3.2 Обогащение данных клиентов
- [ ] Синхронизация данных между нашей БД customers и Битрикс24
- [ ] Автоматическое обновление информации о клиентах
- [ ] Двусторонняя синхронизация изменений

#### 3.3 Управление ответственными
- [ ] Автоматическое назначение ответственных за лиды
- [ ] Маппинг Asterisk extensions → Битрикс24 пользователи
- [ ] Логика распределения звонков между менеджерами

### Phase 4: Расширенная функциональность (3-4 недели)

#### 4.1 Записи разговоров
- [ ] Интеграция `telephony.externalCall.attachRecord`
- [ ] Автоматическая загрузка записей в Битрикс24
- [ ] Поддержка различных форматов (mp3, flac)
- [ ] Резервные попытки загрузки

#### 4.2 Аналитика и отчетность
- [ ] Интеграция с `voximplant.statistic.get`
- [ ] Синхронизация статистики звонков
- [ ] Дашборды и метрики в админке

#### 4.3 Дополнительные функции
- [ ] Оценка качества звонков (VOTE параметр)
- [ ] Уведомления в чаты Битрикс24 (ADD_TO_CHAT)
- [ ] Поддержка списков обзвона (CALL_LIST_ID)
- [ ] Работа с источниками лидов (CRM_SOURCE)

#### 4.4 Мобильная поддержка
- [ ] Обработка флага IS_MOBILE для мобильных звонков
- [ ] Адаптация под мобильное приложение Битрикс24

### Phase 5: Тестирование и оптимизация (2-3 недели)

#### 5.1 Тестирование интеграции
- [ ] Unit тесты для всех API методов
- [ ] Интеграционные тесты с Битрикс24 sandbox
- [ ] Тестирование обработки ошибок и edge cases
- [ ] Нагрузочное тестирование

#### 5.2 Мониторинг и логирование
- [ ] Детальное логирование всех API вызовов
- [ ] Мониторинг лимитов API и производительности
- [ ] Алерты при ошибках интеграции
- [ ] Дашборд статуса интеграции

#### 5.3 Документация
- [ ] Техническая документация по архитектуре
- [ ] Руководство пользователя
- [ ] API документация для внутреннего использования
- [ ] Troubleshooting guide

### Phase 6: Деплой и поддержка (1-2 недели)

#### 6.1 Подготовка к production
- [ ] Настройка production окружения
- [ ] Миграция данных и конфигураций
- [ ] Резервное копирование и восстановление
- [ ] Security аудит

#### 6.2 Развертывание
- [ ] Поэтапный rollout для тестовых предприятий
- [ ] Мониторинг после деплоя
- [ ] Оперативное исправление критических багов
- [ ] Обучение пользователей

## Технические детали реализации

### Структура кода

```
bitrix24/
├── __init__.py
├── client.py          # Основной клиент для работы с API
├── auth.py           # OAuth авторизация и управление токенами
├── telephony.py      # Методы телефонии
├── crm.py           # Методы CRM
├── events.py        # Обработка событий
├── models.py        # SQLAlchemy модели
├── exceptions.py    # Исключения
└── utils.py         # Вспомогательные функции
```

### Ключевые классы

```python
class Bitrix24Client:
    """Основной клиент для работы с Битрикс24 API"""
    
    def __init__(self, portal_domain: str, access_token: str = None)
    async def call_method(self, method: str, params: dict = None)
    async def refresh_token(self)
    
class TelephonyManager:
    """Управление телефонными звонками"""
    
    async def register_call(self, phone: str, user_id: int, call_type: int)
    async def finish_call(self, call_id: str, duration: int, status: str)
    async def attach_record(self, call_id: str, record_url: str)

class CRMManager:
    """Управление CRM объектами"""
    
    async def search_by_phone(self, phone: str)
    async def create_lead(self, phone: str, name: str)
    async def create_contact(self, phone: str, name: str)
```

### Интеграция с существующей системой

#### Расширение ms.py

```python
# Добавление поддержки Битрикс24 в существующие функции
async def process_incoming_call_bitrix24(phone: str, extension: str, enterprise_number: str):
    """Обработка входящего звонка для Битрикс24"""
    
    # Получение конфигурации Битрикс24
    b24_config = await get_bitrix24_config(enterprise_number)
    if not b24_config:
        return
    
    # Создание клиента
    client = Bitrix24Client(
        portal_domain=b24_config['portal_domain'],
        access_token=b24_config['access_token']
    )
    
    # Регистрация звонка
    call_result = await client.telephony.register_call(
        phone_number=phone,
        user_phone_inner=extension,
        type=2,  # входящий
        crm_create=1,  # создавать лида если не найден
        show=1  # показывать popup
    )
    
    # Сохранение CALL_ID для последующего завершения
    await store_bitrix24_call_id(phone, extension, call_result['CALL_ID'])

async def update_bitrix24_call_with_recording(call_id: str, duration: int, record_url: str):
    """Завершение звонка в Битрикс24 с записью"""
    
    await client.telephony.finish_call(
        call_id=call_id,
        duration=duration,
        status_code="200",  # успешный
        record_url=record_url
    )
```

### База данных

#### Новые таблицы

```sql
-- Конфигурации интеграций Битрикс24
CREATE TABLE bitrix24_integrations (
    id SERIAL PRIMARY KEY,
    enterprise_number VARCHAR(50) NOT NULL,
    portal_domain VARCHAR(255) NOT NULL,
    access_token TEXT,
    refresh_token TEXT,
    expires_at TIMESTAMP,
    client_endpoint TEXT,
    member_id VARCHAR(255),
    scope TEXT,
    settings JSONB DEFAULT '{}',
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(enterprise_number, portal_domain)
);

-- Связи звонков с Битрикс24
CREATE TABLE bitrix24_calls (
    id SERIAL PRIMARY KEY,
    enterprise_number VARCHAR(50) NOT NULL,
    asterisk_unique_id VARCHAR(255),
    phone VARCHAR(50),
    extension VARCHAR(20),
    bitrix24_call_id VARCHAR(255),
    crm_entity_type VARCHAR(50),
    crm_entity_id INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    finished_at TIMESTAMP,
    INDEX(enterprise_number, asterisk_unique_id),
    INDEX(bitrix24_call_id)
);

-- Пользователи Битрикс24 и их маппинг на внутренние номера
CREATE TABLE bitrix24_users (
    id SERIAL PRIMARY KEY,
    enterprise_number VARCHAR(50) NOT NULL,
    bitrix24_user_id INTEGER NOT NULL,
    phone_inner VARCHAR(20),
    name VARCHAR(255),
    email VARCHAR(255),
    department VARCHAR(255),
    active BOOLEAN DEFAULT true,
    last_sync_at TIMESTAMP DEFAULT NOW(),
    INDEX(enterprise_number, phone_inner),
    INDEX(enterprise_number, bitrix24_user_id)
);
```

### Конфигурация

#### Настройки в integration_cache.py

```python
# Расширение конфигурации предприятий
{
    "enterprise_number": "example123",
    "integrations": {
        "moysklad": { ... },
        "bitrix24": {
            "enabled": true,
            "portal_domain": "example.bitrix24.ru",
            "client_id": "app.xxx",
            "client_secret": "secret",
            "access_token": "token",
            "refresh_token": "refresh",
            "expires_at": "2024-01-01T00:00:00Z",
            "settings": {
                "auto_create_leads": true,
                "show_popups": true,
                "attach_recordings": true,
                "default_source": "CALL",
                "department_mapping": {
                    "150": 1,  # extension -> bitrix24_user_id
                    "151": 2
                }
            }
        }
    }
}
```

## Риски и ограничения

### Технические риски

1. **Лимиты API Битрикс24**
   - 2 запроса в секунду для базовых планов
   - Необходимость очередей и ретраев
   - Мониторинг лимитов

2. **Время жизни токенов**
   - access_token истекает через 3600 секунд
   - Необходимость автообновления через refresh_token
   - Обработка случаев истечения refresh_token

3. **Надежность webhooks**
   - Битрикс24 может не получить наши webhooks
   - Необходимость retry логики
   - Таймауты и обработка ошибок

### Бизнес риски

1. **Совместимость версий**
   - Битрикс24 может изменить API
   - Необходимость версионирования и миграций

2. **Производительность**
   - Дополнительные API вызовы замедляют обработку звонков
   - Необходимость оптимизации и кеширования

3. **Сложность настройки**
   - OAuth авторизация может быть сложной для пользователей
   - Необходимость подробной документации

## Метрики успеха

### Технические метрики

- [ ] 99.9% успешности регистрации звонков
- [ ] < 2 секунды задержки обработки входящих звонков  
- [ ] 100% автообновление истекших токенов
- [ ] < 1% потерь записей разговоров при загрузке

### Бизнес метрики

- [ ] Автоматическое создание 95%+ лидов для новых номеров
- [ ] Корректная привязка 98%+ звонков к CRM объектам
- [ ] Сокращение времени обработки звонков на 30%
- [ ] Повышение конверсии лидов на 15%

## Заключение

Интеграция с Битрикс24 представляет собой значительное расширение функциональности нашей телефонной системы. Основываясь на изученной документации, можно реализовать полноценную интеграцию, которая будет:

1. **Автоматически создавать CRM объекты** для всех входящих звонков
2. **Показывать popup карточки** сотрудникам при звонках
3. **Обрабатывать исходящие звонки** из CRM интерфейса
4. **Прикреплять записи разговоров** к звонкам в CRM
5. **Синхронизировать данные клиентов** между системами

Реализация потребует 12-16 недель разработки с учетом тестирования и документации. Архитектура построена на проверенных паттернах OAuth 2.0 и REST API, что обеспечивает надежность и масштабируемость решения.


