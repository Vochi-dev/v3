# –¢–µ—Å—Ç–æ–≤—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π Asterisk

–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
tests/
‚îú‚îÄ‚îÄ call_emulator/          # –≠–º—É–ª—è—Ç–æ—Ä—ã –∑–≤–æ–Ω–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ api_server.py      # REST API –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ emulator.py        # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —ç–º—É–ª—è—Ç–æ—Ä –∑–≤–æ–Ω–∫–æ–≤
‚îú‚îÄ‚îÄ event_templates/        # –®–∞–±–ª–æ–Ω—ã —Å–æ–±—ã—Ç–∏–π –≤ JSON
‚îÇ   ‚îú‚îÄ‚îÄ simple_incoming_call.json
‚îÇ   ‚îú‚îÄ‚îÄ simple_outgoing_call.json
‚îÇ   ‚îú‚îÄ‚îÄ transfer_call.json
‚îÇ   ‚îú‚îÄ‚îÄ followme_call.json
‚îÇ   ‚îî‚îÄ‚îÄ busy_manager_call.json
‚îî‚îÄ‚îÄ test_reports/          # –û—Ç—á–µ—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. API –°–µ—Ä–≤–µ—Ä –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π

```bash
# –ó–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–µ—Ä–∞
cd tests/call_emulator
python api_server.py

# –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
curl -X POST http://localhost:5000/send_event \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "start",
    "data": {"UniqueId": "123", "Phone": "375296254070"},
    "endpoint": "/start"
  }'

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
curl -X POST http://localhost:5000/execute_pattern/simple_incoming
```

### 2. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —ç–º—É–ª—è—Ç–æ—Ä

```bash
cd tests/call_emulator
python emulator.py
```

–ú–µ–Ω—é –æ–ø—Ü–∏–π:
- 1. –ü—Ä–æ—Å—Ç–æ–π –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
- 2. –ü—Ä–æ—Å—Ç–æ–π –∏—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫  
- 3. –ü–µ—Ä–µ–≤–æ–¥ –∑–≤–æ–Ω–∫–∞
- 4. FollowMe –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è
- 5. –ó–≤–æ–Ω–æ–∫ –∑–∞–Ω—è—Ç–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É
- 6. –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤
- 7. –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤

–®–∞–±–ª–æ–Ω—ã –≤ `event_templates/` —Å–æ–¥–µ—Ä–∂–∞—Ç:
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π
- –ó–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É —Å–æ–±—ã—Ç–∏—è–º–∏
- –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

```python
import json

# –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞
with open('tests/event_templates/simple_incoming_call.json') as f:
    template = json.load(f)

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
for event in template['sequence']:
    await send_event(event['endpoint'], event['data'])
    await asyncio.sleep(event['delay'])
```

## –¢–∏–ø—ã —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã—Ö –∑–≤–æ–Ω–∫–æ–≤

### –ü—Ä–æ—Å—Ç—ã–µ –∑–≤–æ–Ω–∫–∏
- **simple_incoming**: –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ (start ‚Üí dial ‚Üí bridge ‚Üí hangup)
- **simple_outgoing**: –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ (dial ‚Üí bridge ‚Üí hangup)

### –°–ª–æ–∂–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- **transfer**: –ü–µ—Ä–µ–≤–æ–¥ –∑–≤–æ–Ω–∫–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –º–æ—Å—Ç–∞–º–∏
- **followme**: FollowMe –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä–æ–≤
- **busy_manager**: –ó–≤–æ–Ω–æ–∫ –∑–∞–Ω—è—Ç–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `call_emulator/emulator.py`:

```python
config = CallEmulatorConfig(
    target_host="localhost",      # –•–æ—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
    target_port=8001,            # –ü–æ—Ä—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
    enterprise_token="375293332255",  # –¢–æ–∫–µ–Ω –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
    delay_between_events=0.5,    # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–±—ã—Ç–∏—è–º–∏
    delay_between_calls=2.0      # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–≤–æ–Ω–∫–∞–º–∏
)
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ö–∞–∂–¥—ã–π —à–∞–±–ª–æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç `expected_results` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```json
"expected_results": {
  "bitrix24_events": 3,    # –û–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –¥–ª—è Bitrix24
  "telegram_events": 2,    # –û–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –¥–ª—è Telegram
  "complexity": "SIMPLE",  # –û–∂–∏–¥–∞–µ–º—ã–π —Ç–∏–ø —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
  "primary_uid": "1757772742.60"  # –û—Å–Ω–æ–≤–Ω–æ–π UniqueId
}
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–≠–º—É–ª—è—Ç–æ—Ä –≤—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏:
- üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- ‚úÖ –£—Å–ø–µ—à–Ω—ã–µ —Ç–µ—Å—Ç—ã
- ‚ùå –û—à–∏–±–∫–∏
- üìã –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º

–≠–º—É–ª—è—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞:
- `/start` - –Ω–∞—á–∞–ª–æ –∑–≤–æ–Ω–∫–∞
- `/dial` - –Ω–∞–±–æ—Ä –Ω–æ–º–µ—Ä–∞
- `/bridge` - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- `/hangup` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ö–æ—Å—Ç–µ –∏ –ø–æ—Ä—Ç—É.


