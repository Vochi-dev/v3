# üìä Call Logger Service - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞.

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- **–ü–æ—Ä—Ç**: 8026
- **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: FastAPI, Pydantic, PostgreSQL, asyncpg
- **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö**: JSON
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤ PostgreSQL —Å JSONB
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: LIST –ø–æ –Ω–æ–º–µ—Ä–∞–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π

## üìã –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤
- **Dial —Å–æ–±—ã—Ç–∏—è** - –Ω–∞—á–∞–ª–æ –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤
- **Bridge —Å–æ–±—ã—Ç–∏—è** - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- **Hangup —Å–æ–±—ã—Ç–∏—è** - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤
- **–î—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è** - –Ω–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã, –ø–µ—Ä–µ–≤–æ–¥—ã –∏ —Ç.–¥.

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- –ó–∞–ø—Ä–æ—Å—ã –∫ —Å–µ—Ä–≤–∏—Å—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (8020)
- –ó–∞–ø—Ä–æ—Å—ã –∫ –≤–Ω–µ—à–Ω–∏–º API (MoySklad, RetailCRM)
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Å—Ç–∞—Ç—É—Å –∫–æ–¥—ã
- –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–π
- –ó–∞–ø—Ä–æ—Å—ã –∫ PostgreSQL
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –æ–ø–µ—Ä–∞—Ü–∏–π
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- ID —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —á–∞—Ç–æ–≤

## üåê API Endpoints

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### `GET /`
–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Ä–≤–∏—Å–µ

#### `POST /log/event`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "event_type": "dial",
  "event_data": {
    "Phone": "375296254070",
    "Extensions": ["150"],
    "Trunk": "0001363",
    "CallType": 1
  }
}
```

#### `POST /log/http`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "method": "GET",
  "url": "http://localhost:8020/metadata/0367/manager/150",
  "response_data": {
    "full_name": "–î–∂—É–Ω–æ–≤—ã–π –î–∂—É–ª–∞–π",
    "internal_phone": "150"
  },
  "status_code": 200,
  "duration_ms": 245.3
}
```

#### `POST /log/sql`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "query": "SELECT raw_data->'ConnectedLineNum' FROM call_events WHERE raw_data->>'Token' = $1",
  "parameters": ["375293332255"],
  "result": {"internal_num": "150"},
  "duration_ms": 12.5
}
```

#### `POST /log/telegram`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –æ–ø–µ—Ä–∞—Ü–∏–∏
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "chat_id": 7055556176,
  "message_type": "dial",
  "message_id": 13165,
  "message_text": "üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...",
  "action": "send"
}
```

#### `GET /trace/{unique_id}`
–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–∞ –∑–≤–æ–Ω–∫–∞
```json
{
  "unique_id": "1759490248.0",
  "enterprise_number": "0367",
  "created_at": "2025-10-03T11:29:13",
  "updated_at": "2025-10-03T11:29:47",
  "timeline": [
    {
      "type": "call_event",
      "timestamp": "2025-10-03T11:29:13",
      "data": {
        "event_type": "dial",
        "event_data": {...}
      }
    },
    {
      "type": "http_request",
      "timestamp": "2025-10-03T11:29:14",
      "data": {
        "method": "GET",
        "url": "...",
        "duration_ms": 245.3
      }
    }
  ],
  "summary": {
    "total_events": 3,
    "http_requests": 5,
    "sql_queries": 2,
    "telegram_messages": 2
  }
}
```

#### `GET /search`
–ü–æ–∏—Å–∫ —Ç—Ä–µ–π—Å–æ–≤ –∑–≤–æ–Ω–∫–æ–≤
```
GET /search?enterprise=0367&phone=375296254070&limit=10
```

#### `GET /health`
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞

## üóÑÔ∏è –î–∏–∑–∞–π–Ω –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `call_traces`

–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞ —Å JSONB –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ:

```sql
CREATE TABLE call_traces (
    id BIGSERIAL,
    unique_id VARCHAR(50) NOT NULL,
    enterprise_number VARCHAR(10) NOT NULL,
    phone_number VARCHAR(20),
    call_direction VARCHAR(10),
    call_status VARCHAR(20) DEFAULT 'active',
    start_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    end_time TIMESTAMP WITH TIME ZONE,
    call_events JSONB DEFAULT '[]'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
) PARTITION BY LIST (enterprise_number);
```

### –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**LIST –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –Ω–æ–º–µ—Ä–∞–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π** - –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –≤ —Å–≤–æ–µ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏:

```sql
-- –ü–∞—Ä—Ç–∏—Ü–∏–∏ —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ (—Ç–æ–ª—å–∫–æ 4 —Ü–∏—Ñ—Ä—ã)
CREATE TABLE "0367" PARTITION OF call_traces FOR VALUES IN ('0367');
CREATE TABLE "0280" PARTITION OF call_traces FOR VALUES IN ('0280');
CREATE TABLE "0368" PARTITION OF call_traces FOR VALUES IN ('0368');
CREATE TABLE "0286" PARTITION OF call_traces FOR VALUES IN ('0286');
-- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è...
```

### –ò–Ω–¥–µ–∫—Å—ã

```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_call_traces_unique_id ON call_traces (unique_id);
CREATE INDEX idx_call_traces_enterprise ON call_traces (enterprise_number);
CREATE INDEX idx_call_traces_start_time ON call_traces (start_time);
CREATE INDEX idx_call_traces_call_events ON call_traces USING GIN (call_events);
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

```sql
-- UNIQUE constraint –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏
ALTER TABLE "0367" ADD CONSTRAINT unique_call_trace_0367 UNIQUE (unique_id, enterprise_number);
ALTER TABLE "0280" ADD CONSTRAINT unique_call_trace_0280 UNIQUE (unique_id, enterprise_number);
-- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...
```

### –§—É–Ω–∫—Ü–∏–∏ –ë–î

#### `add_call_event` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è

```sql
CREATE OR REPLACE FUNCTION add_call_event(
    p_unique_id VARCHAR(50),
    p_enterprise_number VARCHAR(10),
    p_event_type VARCHAR(30),
    p_event_data JSONB,
    p_phone_number VARCHAR(20) DEFAULT NULL
)
RETURNS BIGINT AS $$
DECLARE
    v_trace_id BIGINT;
    v_call_direction VARCHAR(10);
    v_call_status VARCHAR(20);
BEGIN
    -- –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞
    IF p_event_type IN ('start', 'dial') THEN
        v_call_direction := 'outgoing';
        v_call_status := 'active';
    ELSIF p_event_type = 'hangup' THEN
        v_call_status := 'completed';
    END IF;

    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
    SELECT id INTO v_trace_id 
    FROM call_traces 
    WHERE unique_id = p_unique_id AND enterprise_number = p_enterprise_number;
    
    IF v_trace_id IS NOT NULL THEN
        -- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        UPDATE call_traces SET
            call_events = call_events || jsonb_build_object(
                'event_sequence', jsonb_array_length(call_events) + 1,
                'event_type', p_event_type,
                'event_timestamp', NOW(),
                'event_data', p_event_data
            ),
            updated_at = NOW()
        WHERE id = v_trace_id;
    ELSE
        -- –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        INSERT INTO call_traces (unique_id, enterprise_number, phone_number, call_direction, call_status, call_events)
        VALUES (p_unique_id, p_enterprise_number, p_phone_number, v_call_direction, v_call_status, 
                jsonb_build_array(jsonb_build_object(
                    'event_sequence', 1,
                    'event_type', p_event_type,
                    'event_timestamp', NOW(),
                    'event_data', p_event_data
                )))
        RETURNING id INTO v_trace_id;
    END IF;

    RETURN v_trace_id;
END;
$$ LANGUAGE plpgsql;
```

#### `get_call_events` - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∏–∑ JSONB

```sql
CREATE OR REPLACE FUNCTION get_call_events(p_unique_id VARCHAR(50))
RETURNS TABLE (
    event_sequence INTEGER,
    event_type VARCHAR(30),
    event_timestamp TIMESTAMP WITH TIME ZONE,
    event_data JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        (event->>'event_sequence')::INTEGER,
        (event->>'event_type')::VARCHAR(30),
        (event->>'event_timestamp')::TIMESTAMP WITH TIME ZONE,
        event->'event_data'
    FROM call_traces,
         jsonb_array_elements(call_events) AS event
    WHERE unique_id = p_unique_id
    ORDER BY (event->>'event_sequence')::INTEGER;
END;
$$ LANGUAGE plpgsql;
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å—Ö–µ–º—ã

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –≤ —Å–≤–æ–µ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏
3. **–ì–∏–±–∫–æ—Å—Ç—å**: JSONB –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –ª—é–±—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–æ–±—ã—Ç–∏–π
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
5. **–ü–æ–Ω—è—Ç–Ω–æ—Å—Ç—å**: –ü–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω—ã –ø—Ä–æ—Å—Ç–æ - –Ω–æ–º–µ—Ä–æ–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### CallTrace (–æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ –ë–î)
```json
{
  "id": 123,
  "unique_id": "1759490248.0",
  "enterprise_number": "0367",
  "phone_number": "375296254070",
  "call_direction": "outgoing",
  "call_status": "active",
  "start_time": "2025-10-03T11:29:13",
  "end_time": null,
  "call_events": [
    {
      "event_sequence": 1,
      "event_type": "dial",
      "event_timestamp": "2025-10-03T11:29:13",
      "event_data": {
        "Phone": "375296254070",
        "Extensions": ["150"],
        "Trunk": "0001363"
      }
    }
  ],
  "created_at": "2025-10-03T11:29:13",
  "updated_at": "2025-10-03T11:29:47"
}
```

### Event (—Å–æ–±—ã—Ç–∏–µ –∑–≤–æ–Ω–∫–∞)
```json
{
  "event_type": "dial|bridge|hangup|new_channel|etc",
  "event_data": {...},       // –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
  "timestamp": "2025-10-03T11:29:13"
}
```

### HttpRequest (HTTP –∑–∞–ø—Ä–æ—Å)
```json
{
  "method": "GET|POST|PUT|DELETE",
  "url": "http://localhost:8020/...",
  "request_data": {...},     // –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞
  "response_data": {...},    // –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞
  "status_code": 200,
  "duration_ms": 245.3,
  "timestamp": "2025-10-03T11:29:14"
}
```

### SqlQuery (SQL –∑–∞–ø—Ä–æ—Å)
```json
{
  "query": "SELECT ...",
  "parameters": [...],       // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
  "result": {...},          // –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
  "duration_ms": 12.5,
  "timestamp": "2025-10-03T11:29:15"
}
```

### TelegramMessage (Telegram –æ–ø–µ—Ä–∞—Ü–∏—è)
```json
{
  "chat_id": 7055556176,
  "message_type": "dial|bridge|hangup",
  "message_id": 13165,
  "message_text": "...",
  "action": "send|edit|delete",
  "timestamp": "2025-10-03T11:29:16"
}
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–≤–æ–Ω–∫–∞

### 1. Dial —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç dial —Å–æ–±—ã—Ç–∏–µ –æ—Ç —Ö–æ—Å—Ç–∞
2. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/event
3. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ 8020
4. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
6. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
```

### 2. Bridge —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç bridge —Å–æ–±—ã—Ç–∏–µ
2. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/event
3. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è
4. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
6. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
```

### 3. Hangup —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç hangup —Å–æ–±—ã—Ç–∏–µ
2. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/event
3. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ internal_phone
4. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/sql
5. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è
6. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
7. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
8. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
9. –£–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
10. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
```

## üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º

### –í dial.py
```python
import httpx

async def log_call_event(enterprise, unique_id, event_type, data):
    async with httpx.AsyncClient() as client:
        await client.post("http://localhost:8026/log/event", json={
            "enterprise_number": enterprise,
            "unique_id": unique_id,
            "event_type": event_type,
            "event_data": data
        })

async def log_http_request(enterprise, unique_id, method, url, response_data, status_code, duration_ms):
    async with httpx.AsyncClient() as client:
        await client.post("http://localhost:8026/log/http", json={
            "enterprise_number": enterprise,
            "unique_id": unique_id,
            "method": method,
            "url": url,
            "response_data": response_data,
            "status_code": status_code,
            "duration_ms": duration_ms
        })
```

## üîÆ –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º

### –≠—Ç–∞–ø 1 (–ë–∞–∑–∞) ‚úÖ –ó–ê–í–ï–†–®–ï–ù
- ‚úÖ –ë–∞–∑–æ–≤—ã–π API
- ‚úÖ PostgreSQL —Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ 78 –ø–∞—Ä—Ç–∏—Ü–∏–π –¥–ª—è –≤—Å–µ—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
- ‚úÖ –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –≠—Ç–∞–ø 2 (–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ —Å–æ–±—ã—Ç–∏–π) üîÑ –í –†–ê–ë–û–¢–ï
- ‚úÖ **dial.py** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ dial —Å–æ–±—ã—Ç–∏–π + HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ + Telegram (–ì–û–¢–û–í–û)
- üîÑ **bridge.py** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ bridge —Å–æ–±—ã—Ç–∏–π + –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- üîÑ **hangup.py** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ hangup + SQL –∑–∞–ø—Ä–æ—Å—ã + —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### –≠—Ç–∞–ø 3 (–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) üìã –ó–ê–ü–õ–ê–ù–ò–†–û–í–ê–ù–û
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ 8020
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –≤–Ω–µ—à–Ω–∏–º API (MoySklad, RetailCRM)
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–π
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö Telegram –æ–ø–µ—Ä–∞—Ü–∏–π

### –≠—Ç–∞–ø 4 (–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å) üîÆ –ë–£–î–£–©–ï–ï
- üîÆ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—Ä–µ–π—Å–æ–≤
- üîÆ –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ —Å–æ–±—ã—Ç–∏–π
- üîÆ –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫
- üîÆ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏

## üìã TODO - –°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å dial.py
- ‚úÖ –°–æ–∑–¥–∞—Ç—å —É—Ç–∏–ª–∏—Ç—É –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ dial —Å–æ–±—ã—Ç–∏—è
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ 8020
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª dial —Å–æ–±—ã—Ç–∏—è

### üêõ –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –û–®–ò–ë–ö–ò - –ò–°–ü–†–ê–í–ò–¢–¨ –ó–ê–í–¢–†–ê
- [ ] **API /trace/ –æ—à–∏–±–∫–∞**: `column "duration_seconds" does not exist` - –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é get_call_trace –≤ logger.py
- [ ] **–ü–∞—Ä—Ç–∏—Ü–∏—è 0233 –æ—à–∏–±–∫–∞**: `invalid bound specification for a list partition` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0233
- [ ] **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ dial —Å–æ–±—ã—Ç–∏–π**: –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è 2 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö dial —Å–æ–±—ã—Ç–∏—è –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ - –Ω–∞–π—Ç–∏ –ø—Ä–∏—á–∏–Ω—É –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] **–û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é**: –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å dial.py —Å üîÑ –Ω–∞ ‚úÖ –≤ —Ä–∞–∑–¥–µ–ª–µ "–≠—Ç–∞–ø 2"

### üîÑ –°–õ–ï–î–£–Æ–©–ò–ï –ó–ê–î–ê–ß–ò –ù–ê –ó–ê–í–¢–†–ê:
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å bridge.py
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å hangup.py
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö API

### üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:
- **–°—Ç–∞—Ç—É—Å**: dial.py –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
- **–¢—Ä–µ–π—Å–æ–≤ –≤ –ª–æ–≥–≥–µ—Ä–µ**: 56 (–±—ã–ª–æ 44)
- **–ó–≤–æ–Ω–∫–æ–≤ –≤ 0367**: 2 –∑–≤–æ–Ω–∫–∞
- **–õ–æ–≥–∏—Ä—É–µ—Ç—Å—è**: dial —Å–æ–±—ã—Ç–∏—è, HTTP –∑–∞–ø—Ä–æ—Å—ã, Telegram —Å–æ–æ–±—â–µ–Ω–∏—è, dispatch –∑–∞–ø—Ä–æ—Å—ã

## üöÄ –ó–∞–ø—É—Å–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
```bash
# –ó–∞–ø—É—Å–∫
./logger.sh start

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
./logger.sh stop

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
./logger.sh restart

# –°—Ç–∞—Ç—É—Å
./logger.sh status
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
curl http://localhost:8026/health

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–∏—Å–µ
curl http://localhost:8026/
```

## üóÇÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π

### –°–∫—Ä–∏–ø—Ç `logger_partitions.sh`

–£–¥–æ–±–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏.

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

**–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π:**
```bash
./logger_partitions.sh list
```
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø–∏—Å–µ–π:
```
üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π:

üóÇÔ∏è –¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞: –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º
 enterprise_partition | size  | records | enterprise_number 
----------------------+-------+---------+-------------------
 0280                 | 48 kB |       1 | 0280
 0286                 | 48 kB |       0 | 0286
 0367                 | 48 kB |       1 | 0367
 0368                 | 48 kB |       0 | 0368
 0999                 | 48 kB |       1 | 0999
```

**–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è:**
```bash
./logger_partitions.sh add-enterprise 0369
```
–ü—Ä–æ—Å—Ç–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:
```
‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0369...
‚úÖ –ü–∞—Ä—Ç–∏—Ü–∏—è 0369 —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!
üìù –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: SELECT * FROM "0369";
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é:**
```bash
./logger_partitions.sh stats 0367
```
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0367:

 total_calls | completed_calls |  avg_events_per_call   | first_call | last_call | events_size 
-------------+-----------------+------------------------+------------+-----------+-------------
           5 |               2 | 2.40000000000000000000 | 2025-10-03 | 2025-10-03| 895 bytes
```

**–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è:**
```bash
./logger_partitions.sh cleanup 0367     # –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
./logger_partitions.sh cleanup-all      # –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)
```

**–ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π:**
```bash
./logger_partitions.sh rebuild-partitions
```
–ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏.

**–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤:**
```bash
./logger_partitions.sh sql "SELECT COUNT(*) FROM \"0367\";"
./logger_partitions.sh sql "SELECT * FROM \"0367\" LIMIT 5;"
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
```bash
./logger_partitions.sh test-event 0367
```
–°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞:**
```bash
./logger_partitions.sh health
```

#### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ**
```bash
# –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Ç–∏—Ü–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0375
./logger_partitions.sh add-enterprise 0375

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞—Ä—Ç–∏—Ü–∏—è —Å–æ–∑–¥–∞–ª–∞—Å—å
./logger_partitions.sh list

# –°–º–æ—Ç—Ä–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–ø–æ–∫–∞ –ø—É—Å—Ç–∞—è)
./logger_partitions.sh stats 0375
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è**
```bash
# –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ 0367
./logger_partitions.sh stats 0367

# –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ SQL (–æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∫–∞–≤—ã—á–∫–∏!)
./logger_partitions.sh sql "
SELECT 
    call_direction,
    COUNT(*) as calls_count,
    jsonb_array_length(call_events) as avg_events
FROM \"0367\" 
WHERE start_time >= NOW() - INTERVAL '7 days'
GROUP BY call_direction;
"

# –ü–æ–∏—Å–∫ –∑–≤–æ–Ω–∫–æ–≤ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
./logger_partitions.sh sql "
SELECT unique_id, phone_number, call_status, start_time 
FROM \"0367\" 
WHERE phone_number = '375296254070';
"
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
```bash
# –°–Ω–∞—á–∞–ª–∞ —Å–º–æ—Ç—Ä–∏–º —á—Ç–æ –≤ –ø–∞—Ä—Ç–∏—Ü–∏–∏
./logger_partitions.sh stats 0999

# –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ - –æ—á–∏—â–∞–µ–º
./logger_partitions.sh cleanup 0999
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
```bash
# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
./logger_partitions.sh test-event 0367

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –∑–∞–ø–∏—Å–∞–ª–æ—Å—å
./logger_partitions.sh stats 0367

# –°–º–æ—Ç—Ä–∏–º –¥–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è
./logger_partitions.sh sql "SELECT * FROM \"0367\" ORDER BY id DESC LIMIT 1;"
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π

–ü–∞—Ä—Ç–∏—Ü–∏–∏ **–ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏—Ö –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º:

```bash
# –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –ø–∞—Ä—Ç–∏—Ü–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
./logger_partitions.sh add-enterprise 0375

# –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
curl -X POST http://localhost:8026/log/event -H "Content-Type: application/json" -d '{
    "enterprise_number": "0375",
    "unique_id": "1759490248.0", 
    "event_type": "dial",
    "event_data": {...}
}'
```

#### –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

**–ö–∞–≤—ã—á–∫–∏ –≤ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö:**
–ü–æ—Å–∫–æ–ª—å–∫—É –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω—ã —Ü–∏—Ñ—Ä–∞–º–∏, –≤ SQL –Ω—É–∂–Ω—ã –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏:
```sql
-- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
SELECT * FROM "0367";

-- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ  
SELECT * FROM 0367;
```

**–ü—Ä–æ—Å—Ç—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π:**
- –ü–∞—Ä—Ç–∏—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0367 –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ `"0367"`
- –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ `call_traces_` –±–æ–ª—å—à–µ –Ω–µ—Ç
- –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

#### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞—Ä—Ç–∏—Ü–∏–π

**–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –†–∞–∑–º–µ—Ä—ã –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
./logger_partitions.sh list

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
for enterprise in 0367 0280 0368; do
    echo "=== –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ $enterprise ==="
    ./logger_partitions.sh stats $enterprise
    echo ""
done
```

**–ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π:**
```bash
# –ü–∞—Ä—Ç–∏—Ü–∏–∏ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö (–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–Ω—ã –æ—à–∏–±–æ—á–Ω–æ)
./logger_partitions.sh sql "
SELECT 
    tablename as partition_name,
    pg_size_pretty(pg_total_relation_size('public.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename ~ '^[0-9]{4}$'
ORDER BY pg_total_relation_size('public.'||tablename) DESC;
"

# –ü–æ–∏—Å–∫ –ø—É—Å—Ç—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
./logger_partitions.sh sql "
SELECT 
    tablename,
    (SELECT COUNT(*) FROM call_traces WHERE tableoid = ('public.'||tablename)::regclass) as records
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename ~ '^[0-9]{4}$'
HAVING (SELECT COUNT(*) FROM call_traces WHERE tableoid = ('public.'||tablename)::regclass) = 0;
"
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞
- –§–∞–π–ª: `logs/logger.log`
- –§–æ—Ä–º–∞—Ç: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Python logging
- –†–æ—Ç–∞—Ü–∏—è: –ü–æ —Ä–∞–∑–º–µ—Ä—É (10MB)

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–π—Å–æ–≤
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –°–µ—Ä–≤–∏—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç --reload –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ç–æ—Ä–º–æ–∑–æ–≤
2. **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL —Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ localhost –∏ —á–µ—Ä–µ–∑ Nginx –Ω–∞ `/logger/`
4. **–ü–∞—Ä—Ç–∏—Ü–∏–∏**: –ù–∞–∑–≤–∞–Ω—ã –ø—Ä–æ—Å—Ç–æ –Ω–æ–º–µ—Ä–∞–º–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π (0367, 0280, etc.) –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
5. **SQL –∑–∞–ø—Ä–æ—Å—ã**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø–∞—Ä—Ç–∏—Ü–∏–π
6. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π**: –ü–∞—Ä—Ç–∏—Ü–∏–∏ –ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
7. **JSONB**: –í—Å–µ —Å–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–¥–Ω–æ–º JSONB –ø–æ–ª–µ –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

- **8000** - –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏)
- **8020** - –°–µ—Ä–≤–∏—Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–∏—Å—Ç–æ—á–Ω–∏–∫ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤)
- **PostgreSQL** - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–±—É–¥—É—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 1.0.0  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 2025-10-03  
**–ê–≤—Ç–æ—Ä**: Call Logger Service Team
