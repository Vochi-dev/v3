# üìä Call Logger Service - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞.

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- **–ü–æ—Ä—Ç**: 8026
- **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: FastAPI, Pydantic, PostgreSQL, asyncpg
- **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö**: JSON
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤ PostgreSQL —Å JSONB
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: LIST –ø–æ –Ω–æ–º–µ—Ä–∞–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π

## üìã –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤
- **Dial —Å–æ–±—ã—Ç–∏—è** - –Ω–∞—á–∞–ª–æ –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤
- **Bridge —Å–æ–±—ã—Ç–∏—è** - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- **Hangup —Å–æ–±—ã—Ç–∏—è** - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤
- **–î—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è** - –Ω–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã, –ø–µ—Ä–µ–≤–æ–¥—ã –∏ —Ç.–¥.

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- –ó–∞–ø—Ä–æ—Å—ã –∫ —Å–µ—Ä–≤–∏—Å—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (8020)
- –ó–∞–ø—Ä–æ—Å—ã –∫ –≤–Ω–µ—à–Ω–∏–º API (MoySklad, RetailCRM)
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Å—Ç–∞—Ç—É—Å –∫–æ–¥—ã
- –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–π
- –ó–∞–ø—Ä–æ—Å—ã –∫ PostgreSQL
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –æ–ø–µ—Ä–∞—Ü–∏–π
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- ID —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —á–∞—Ç–æ–≤

## üåê API Endpoints

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### `GET /`
–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Ä–≤–∏—Å–µ

#### `POST /log/event`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "event_type": "dial",
  "event_data": {
    "Phone": "375296254070",
    "Extensions": ["150"],
    "Trunk": "0001363",
    "CallType": 1
  }
}
```

#### `POST /log/http`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "method": "GET",
  "url": "http://localhost:8020/metadata/0367/manager/150",
  "response_data": {
    "full_name": "–î–∂—É–Ω–æ–≤—ã–π –î–∂—É–ª–∞–π",
    "internal_phone": "150"
  },
  "status_code": 200,
  "duration_ms": 245.3
}
```

#### `POST /log/sql`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "query": "SELECT raw_data->'ConnectedLineNum' FROM call_events WHERE raw_data->>'Token' = $1",
  "parameters": ["375293332255"],
  "result": {"internal_num": "150"},
  "duration_ms": 12.5
}
```

#### `POST /log/telegram`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –æ–ø–µ—Ä–∞—Ü–∏–∏
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "chat_id": 7055556176,
  "message_type": "dial",
  "message_id": 13165,
  "message_text": "üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...",
  "action": "send"
}
```

#### `GET /trace/{unique_id}`
–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–∞ –∑–≤–æ–Ω–∫–∞
```json
{
  "unique_id": "1759490248.0",
  "enterprise_number": "0367",
  "created_at": "2025-10-03T11:29:13",
  "updated_at": "2025-10-03T11:29:47",
  "timeline": [
    {
      "type": "call_event",
      "timestamp": "2025-10-03T11:29:13",
      "data": {
        "event_type": "dial",
        "event_data": {...}
      }
    },
    {
      "type": "http_request",
      "timestamp": "2025-10-03T11:29:14",
      "data": {
        "method": "GET",
        "url": "...",
        "duration_ms": 245.3
      }
    }
  ],
  "summary": {
    "total_events": 3,
    "http_requests": 5,
    "sql_queries": 2,
    "telegram_messages": 2
  }
}
```

#### `GET /search`
–ü–æ–∏—Å–∫ —Ç—Ä–µ–π—Å–æ–≤ –∑–≤–æ–Ω–∫–æ–≤
```
GET /search?enterprise=0367&phone=375296254070&limit=10
```

#### `GET /health`
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞

## üóÑÔ∏è –î–∏–∑–∞–π–Ω –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `call_traces`

–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞ —Å JSONB –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ:

```sql
CREATE TABLE call_traces (
    id BIGSERIAL,
    unique_id VARCHAR(50) NOT NULL,
    enterprise_number VARCHAR(10) NOT NULL,
    phone_number VARCHAR(20),
    call_direction VARCHAR(10),
    call_status VARCHAR(20) DEFAULT 'active',
    start_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    end_time TIMESTAMP WITH TIME ZONE,
    call_events JSONB DEFAULT '[]'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
) PARTITION BY LIST (enterprise_number);
```

### –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**LIST –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –Ω–æ–º–µ—Ä–∞–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π** - –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –≤ —Å–≤–æ–µ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏:

```sql
-- –ü–∞—Ä—Ç–∏—Ü–∏–∏ —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ (—Ç–æ–ª—å–∫–æ 4 —Ü–∏—Ñ—Ä—ã)
CREATE TABLE "0367" PARTITION OF call_traces FOR VALUES IN ('0367');
CREATE TABLE "0280" PARTITION OF call_traces FOR VALUES IN ('0280');
CREATE TABLE "0368" PARTITION OF call_traces FOR VALUES IN ('0368');
CREATE TABLE "0286" PARTITION OF call_traces FOR VALUES IN ('0286');
-- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è...
```

### –ò–Ω–¥–µ–∫—Å—ã

```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_call_traces_unique_id ON call_traces (unique_id);
CREATE INDEX idx_call_traces_enterprise ON call_traces (enterprise_number);
CREATE INDEX idx_call_traces_start_time ON call_traces (start_time);
CREATE INDEX idx_call_traces_call_events ON call_traces USING GIN (call_events);
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

```sql
-- UNIQUE constraint –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏
ALTER TABLE "0367" ADD CONSTRAINT unique_call_trace_0367 UNIQUE (unique_id, enterprise_number);
ALTER TABLE "0280" ADD CONSTRAINT unique_call_trace_0280 UNIQUE (unique_id, enterprise_number);
-- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...
```

### –§—É–Ω–∫—Ü–∏–∏ –ë–î

#### `add_call_event` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è

```sql
CREATE OR REPLACE FUNCTION add_call_event(
    p_unique_id VARCHAR(50),
    p_enterprise_number VARCHAR(10),
    p_event_type VARCHAR(30),
    p_event_data JSONB,
    p_phone_number VARCHAR(20) DEFAULT NULL
)
RETURNS BIGINT AS $$
DECLARE
    v_trace_id BIGINT;
    v_call_direction VARCHAR(10);
    v_call_status VARCHAR(20);
BEGIN
    -- –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞
    IF p_event_type IN ('start', 'dial') THEN
        v_call_direction := 'outgoing';
        v_call_status := 'active';
    ELSIF p_event_type = 'hangup' THEN
        v_call_status := 'completed';
    END IF;

    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
    SELECT id INTO v_trace_id 
    FROM call_traces 
    WHERE unique_id = p_unique_id AND enterprise_number = p_enterprise_number;
    
    IF v_trace_id IS NOT NULL THEN
        -- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        UPDATE call_traces SET
            call_events = call_events || jsonb_build_object(
                'event_sequence', jsonb_array_length(call_events) + 1,
                'event_type', p_event_type,
                'event_timestamp', NOW(),
                'event_data', p_event_data
            ),
            updated_at = NOW()
        WHERE id = v_trace_id;
    ELSE
        -- –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        INSERT INTO call_traces (unique_id, enterprise_number, phone_number, call_direction, call_status, call_events)
        VALUES (p_unique_id, p_enterprise_number, p_phone_number, v_call_direction, v_call_status, 
                jsonb_build_array(jsonb_build_object(
                    'event_sequence', 1,
                    'event_type', p_event_type,
                    'event_timestamp', NOW(),
                    'event_data', p_event_data
                )))
        RETURNING id INTO v_trace_id;
    END IF;

    RETURN v_trace_id;
END;
$$ LANGUAGE plpgsql;
```

#### `get_call_events` - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∏–∑ JSONB

```sql
CREATE OR REPLACE FUNCTION get_call_events(p_unique_id VARCHAR(50))
RETURNS TABLE (
    event_sequence INTEGER,
    event_type VARCHAR(30),
    event_timestamp TIMESTAMP WITH TIME ZONE,
    event_data JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        (event->>'event_sequence')::INTEGER,
        (event->>'event_type')::VARCHAR(30),
        (event->>'event_timestamp')::TIMESTAMP WITH TIME ZONE,
        event->'event_data'
    FROM call_traces,
         jsonb_array_elements(call_events) AS event
    WHERE unique_id = p_unique_id
    ORDER BY (event->>'event_sequence')::INTEGER;
END;
$$ LANGUAGE plpgsql;
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å—Ö–µ–º—ã

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –≤ —Å–≤–æ–µ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏
3. **–ì–∏–±–∫–æ—Å—Ç—å**: JSONB –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –ª—é–±—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–æ–±—ã—Ç–∏–π
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
5. **–ü–æ–Ω—è—Ç–Ω–æ—Å—Ç—å**: –ü–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω—ã –ø—Ä–æ—Å—Ç–æ - –Ω–æ–º–µ—Ä–æ–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### CallTrace (–æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ –ë–î)
```json
{
  "id": 123,
  "unique_id": "1759490248.0",
  "enterprise_number": "0367",
  "phone_number": "375296254070",
  "call_direction": "outgoing",
  "call_status": "active",
  "start_time": "2025-10-03T11:29:13",
  "end_time": null,
  "call_events": [
    {
      "event_sequence": 1,
      "event_type": "dial",
      "event_timestamp": "2025-10-03T11:29:13",
      "event_data": {
        "Phone": "375296254070",
        "Extensions": ["150"],
        "Trunk": "0001363"
      }
    }
  ],
  "created_at": "2025-10-03T11:29:13",
  "updated_at": "2025-10-03T11:29:47"
}
```

### Event (—Å–æ–±—ã—Ç–∏–µ –∑–≤–æ–Ω–∫–∞)
```json
{
  "event_type": "dial|bridge|hangup|new_channel|etc",
  "event_data": {...},       // –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
  "timestamp": "2025-10-03T11:29:13"
}
```

### HttpRequest (HTTP –∑–∞–ø—Ä–æ—Å 1)
```json
{
  "method": "GET|POST|PUT|DELETE",
  "url": "http://localhost:8020/...",
  "request_data": {...},     // –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞
  "response_data": {...},    // –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞
  "status_code": 200,
  "duration_ms": 245.3,
  "timestamp": "2025-10-03T11:29:14"
}
```

### SqlQuery (SQL –∑–∞–ø—Ä–æ—Å)
```json
{
  "query": "SELECT ...",
  "parameters": [...],       // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
  "result": {...},          // –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
  "duration_ms": 12.5,
  "timestamp": "2025-10-03T11:29:15"
}
```

### TelegramMessage (Telegram –æ–ø–µ—Ä–∞—Ü–∏—è)
```json
{
  "chat_id": 7055556176,
  "message_type": "dial|bridge|hangup",
  "message_id": 13165,
  "message_text": "...",
  "action": "send|edit|delete",
  "timestamp": "2025-10-03T11:29:16"
}
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–≤–æ–Ω–∫–∞

### üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º

**–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å:** Call Logger –ª–æ–≥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è **–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ**, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

#### –ü—Ä–∏–º–µ—Ä: –ó–≤–æ–Ω–æ–∫ —Å 2 –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏
```
–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ 0233 –∏–º–µ–µ—Ç 2 –ø–æ–¥–ø–∏—Å—á–∏–∫–∞:
- chat_id: 7757573720 (–æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)  
- chat_id: 374573193 (—Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

–ü—Ä–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ dial —Å–æ–±—ã—Ç–∏—è:
1. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ process_dial –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –î–í–ê –†–ê–ó–ê
2. –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —Å chat_id
3. –í –±—É–¥—É—â–µ–º –∫–∞–∂–¥—ã–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Call Logger:
```json
[
  {
    "event_type": "dial",
    "chat_id": 7757573720,
    "event_data": {"Phone": "+375296254070", "_chat_id": 7757573720},
    "timestamp": "2025-10-04T09:17:53"
  },
  {
    "event_type": "dial", 
    "chat_id": 374573193,
    "event_data": {"Phone": "+375296254070", "_chat_id": 374573193},
    "timestamp": "2025-10-04T09:17:56"
  }
]
```

### 1. Dial —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç dial —Å–æ–±—ã—Ç–∏–µ –æ—Ç —Ö–æ—Å—Ç–∞
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (chat_ids)
3. –î–õ–Ø –ö–ê–ñ–î–û–ì–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è:
   a. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ –≤ /log/event —Å chat_id
   b. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ 8020
   c. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
   d. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
   e. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram —Å chat_id
```

### 2. Bridge —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç bridge —Å–æ–±—ã—Ç–∏–µ
2. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/event
3. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è
4. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
6. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
```

### 3. Hangup —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç hangup —Å–æ–±—ã—Ç–∏–µ
2. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/event
3. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ internal_phone
4. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/sql
5. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è
6. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
7. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
8. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
9. –£–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
10. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
```

## üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º

### –í dial.py
```python
import httpx

async def log_call_event(enterprise, unique_id, event_type, data):
    async with httpx.AsyncClient() as client:
        await client.post("http://localhost:8026/log/event", json={
            "enterprise_number": enterprise,
            "unique_id": unique_id,
            "event_type": event_type,
            "event_data": data
        })

async def log_http_request(enterprise, unique_id, method, url, response_data, status_code, duration_ms):
    async with httpx.AsyncClient() as client:
        await client.post("http://localhost:8026/log/http", json={
            "enterprise_number": enterprise,
            "unique_id": unique_id,
            "method": method,
            "url": url,
            "response_data": response_data,
            "status_code": status_code,
            "duration_ms": duration_ms
        })
```

## üîÆ –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º

### –≠—Ç–∞–ø 1 (–ë–∞–∑–∞) ‚úÖ –ó–ê–í–ï–†–®–ï–ù
- ‚úÖ –ë–∞–∑–æ–≤—ã–π API
- ‚úÖ PostgreSQL —Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ 78 –ø–∞—Ä—Ç–∏—Ü–∏–π –¥–ª—è –≤—Å–µ—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
- ‚úÖ –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –≠—Ç–∞–ø 2 (–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ —Å–æ–±—ã—Ç–∏–π) ‚úÖ –ó–ê–í–ï–†–®–ï–ù
- ‚úÖ **start.py** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ start —Å–æ–±—ã—Ç–∏–π + –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ enterprise_number (–ì–û–¢–û–í–û)
- ‚úÖ **dial.py** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ dial —Å–æ–±—ã—Ç–∏–π + HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ + Telegram (–ì–û–¢–û–í–û)
- ‚úÖ **bridge.py** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ bridge —Å–æ–±—ã—Ç–∏–π + –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–ì–û–¢–û–í–û)
- ‚úÖ **hangup.py** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ hangup + SQL –∑–∞–ø—Ä–æ—Å—ã + —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ì–û–¢–û–í–û)

### –≠—Ç–∞–ø 3 (–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) üìã –ó–ê–ü–õ–ê–ù–ò–†–û–í–ê–ù–û
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ 8020
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –≤–Ω–µ—à–Ω–∏–º API (MoySklad, RetailCRM)
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–π
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö Telegram –æ–ø–µ—Ä–∞—Ü–∏–π

### –≠—Ç–∞–ø 4 (–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å) üîÆ –ë–£–î–£–©–ï–ï
- üîÆ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—Ä–µ–π—Å–æ–≤
- üîÆ –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ —Å–æ–±—ã—Ç–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ chat_id
- üîÆ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- üîÆ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –¥–æ—Å—Ç–∞–≤–ª—è–µ–º–æ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## üéØ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### üìä –ê–Ω–∞–ª–∏–∑ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

#### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–∑–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
```bash
# –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–µ–π—Å –∑–≤–æ–Ω–∫–∞
curl "http://localhost:8026/trace/1759569469.6697"

# –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ –ø–æ–ª—É—á–∏–ª –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
# chat_id: 7757573720 - –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
# chat_id: 374573193 - —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
```

#### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π
```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
curl "http://localhost:8026/enterprise/0233/events" | jq '.[] | select(.event_data._chat_id == 374573193)'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π
curl "http://localhost:8026/enterprise/0233/events" | jq '.[] | select(.event_type == "telegram_send")'
```

#### –ü—Ä–∏–º–µ—Ä 3: –ê—É–¥–∏—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
curl "http://localhost:8026/trace/UNIQUE_ID" | jq '.timeline[] | select(.data._chat_id == CHAT_ID)'
```

### üîç –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

#### –ù–∞–π—Ç–∏ –≤—Å–µ –∑–≤–æ–Ω–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –∑–∞ –¥–µ–Ω—å
```bash
curl "http://localhost:8026/enterprise/0367/events?date=2025-10-04"
```

#### –ü—Ä–æ—Å–ª–µ–¥–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ñ–ª–æ—É –∑–≤–æ–Ω–∫–∞
```bash
curl "http://localhost:8026/trace/UNIQUE_ID" | jq '.timeline[] | {seq: .sequence, event: .event_type, chat_id: .data._chat_id, time: .timestamp}'
```

## üìã –°–¢–ê–¢–£–° –ò–ù–¢–ï–ì–†–ê–¶–ò–ò - –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

### ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û - –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Call Logger
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ `app/utils/logger_client.py` –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ª–æ–≥–≥–µ—Ä–æ–º
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –í–°–ï –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π: `start.py`, `dial.py`, `bridge.py`, `hangup.py`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–∏—Å—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (8020)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π —Å chat_id
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Integration Gateway
- ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´
- ‚úÖ **API /trace/ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω**: –∑–∞–º–µ–Ω–µ–Ω `duration_seconds` –Ω–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏–∑ `start_time`/`end_time`
- ‚úÖ **–ü–∞—Ä—Ç–∏—Ü–∏—è 0233 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞**: –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `ensure_enterprise_partition` –¥–ª—è LIST –ø–∞—Ä—Ç–∏—Ü–∏–π
- ‚úÖ **"–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ" —Å–æ–±—ã—Ç–∏–π –æ–±—ä—è—Å–Ω–µ–Ω–æ**: —ç—Ç–æ –§–ò–ß–ê –¥–ª—è –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω chat_id**: –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è

### üéØ –ö–õ–Æ–ß–ï–í–´–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò –°–ò–°–¢–ï–ú–´

#### üì§ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º (–ù–ï –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!)
–ö–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è **–æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è** –≤ Telegram:
- **1 –ø–æ–ª—É—á–∞—Ç–µ–ª—å** = 1 –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥–≥–µ—Ä–µ
- **2 –ø–æ–ª—É—á–∞—Ç–µ–ª—è** = 2 –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥–≥–µ—Ä–µ (—Å —Ä–∞–∑–Ω—ã–º–∏ `chat_id`)
- **N –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π** = N –∑–∞–ø–∏—Å–µ–π –≤ –ª–æ–≥–≥–µ—Ä–µ

**–ü—Ä–∏–º–µ—Ä –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0233:**
```json
{
  "events": [
    {"event_type": "dial", "chat_id": 7757573720, "timestamp": "09:17:53"},
    {"event_type": "dial", "chat_id": 374573193, "timestamp": "09:17:56"}
  ]
}
```

#### üéØ –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?
–ü—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ **–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π** —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –ø–æ–ª—É—á–∞—Ç—å:
- –†–∞–∑–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
- –†–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

**Call Logger –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ß–¢–û –∏–º–µ–Ω–Ω–æ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ö–ê–ñ–î–û–ú–£ –ø–æ–ª—É—á–∞—Ç–µ–ª—é.**

### üìä –§–ò–ù–ê–õ–¨–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
- **–°—Ç–∞—Ç—É—Å**: –í–°–ï —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ
- **–ü–æ–∫—Ä—ã—Ç–∏–µ**: start, dial, bridge, hangup + HTTP + Telegram ‚úÖ
- **–ü–∞—Ä—Ç–∏—Ü–∏–∏**: 78 –ø–∞—Ä—Ç–∏—Ü–∏–π –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π ‚úÖ
- **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è**: –∫–∞–∂–¥–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å chat_id –ø–æ–ª—É—á–∞—Ç–µ–ª—è ‚úÖ
- **API**: –ø–æ–ª–Ω—ã–π —Ç—Ä–µ–π—Å –∑–≤–æ–Ω–∫–∞ —á–µ—Ä–µ–∑ `/trace/{unique_id}` ‚úÖ

## üöÄ –ó–∞–ø—É—Å–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
```bash
# –ó–∞–ø—É—Å–∫
./logger.sh start

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
./logger.sh stop

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
./logger.sh restart

# –°—Ç–∞—Ç—É—Å
./logger.sh status
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
curl http://localhost:8026/health

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–∏—Å–µ
curl http://localhost:8026/
```

## üóÇÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π

### –°–∫—Ä–∏–ø—Ç `logger_partitions.sh`

–£–¥–æ–±–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏.

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

**–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π:**
```bash
./logger_partitions.sh list
```
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø–∏—Å–µ–π:
```
üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π:

üóÇÔ∏è –¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞: –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º
 enterprise_partition | size  | records | enterprise_number 
----------------------+-------+---------+-------------------
 0280                 | 48 kB |       1 | 0280
 0286                 | 48 kB |       0 | 0286
 0367                 | 48 kB |       1 | 0367
 0368                 | 48 kB |       0 | 0368
 0999                 | 48 kB |       1 | 0999
```

**–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è:**
```bash
./logger_partitions.sh add-enterprise 0369
```
–ü—Ä–æ—Å—Ç–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:
```
‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0369...
‚úÖ –ü–∞—Ä—Ç–∏—Ü–∏—è 0369 —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!
üìù –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: SELECT * FROM "0369";
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é:**
```bash
./logger_partitions.sh stats 0367
```
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0367:

 total_calls | completed_calls |  avg_events_per_call   | first_call | last_call | events_size 
-------------+-----------------+------------------------+------------+-----------+-------------
           5 |               2 | 2.40000000000000000000 | 2025-10-03 | 2025-10-03| 895 bytes
```

**–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è:**
```bash
./logger_partitions.sh cleanup 0367     # –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
./logger_partitions.sh cleanup-all      # –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)
```

**–ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π:**
```bash
./logger_partitions.sh rebuild-partitions
```
–ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏.

**–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤:**
```bash
./logger_partitions.sh sql "SELECT COUNT(*) FROM \"0367\";"
./logger_partitions.sh sql "SELECT * FROM \"0367\" LIMIT 5;"
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
```bash
./logger_partitions.sh test-event 0367
```
–°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞:**
```bash
./logger_partitions.sh health
```

#### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ**
```bash
# –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Ç–∏—Ü–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0375
./logger_partitions.sh add-enterprise 0375

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞—Ä—Ç–∏—Ü–∏—è —Å–æ–∑–¥–∞–ª–∞—Å—å
./logger_partitions.sh list

# –°–º–æ—Ç—Ä–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–ø–æ–∫–∞ –ø—É—Å—Ç–∞—è)
./logger_partitions.sh stats 0375
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è**
```bash
# –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ 0367
./logger_partitions.sh stats 0367

# –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ SQL (–æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∫–∞–≤—ã—á–∫–∏!)
./logger_partitions.sh sql "
SELECT 
    call_direction,
    COUNT(*) as calls_count,
    jsonb_array_length(call_events) as avg_events
FROM \"0367\" 
WHERE start_time >= NOW() - INTERVAL '7 days'
GROUP BY call_direction;
"

# –ü–æ–∏—Å–∫ –∑–≤–æ–Ω–∫–æ–≤ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
./logger_partitions.sh sql "
SELECT unique_id, phone_number, call_status, start_time 
FROM \"0367\" 
WHERE phone_number = '375296254070';
"
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
```bash
# –°–Ω–∞—á–∞–ª–∞ —Å–º–æ—Ç—Ä–∏–º —á—Ç–æ –≤ –ø–∞—Ä—Ç–∏—Ü–∏–∏
./logger_partitions.sh stats 0999

# –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ - –æ—á–∏—â–∞–µ–º
./logger_partitions.sh cleanup 0999
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
```bash
# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
./logger_partitions.sh test-event 0367

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –∑–∞–ø–∏—Å–∞–ª–æ—Å—å
./logger_partitions.sh stats 0367

# –°–º–æ—Ç—Ä–∏–º –¥–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è
./logger_partitions.sh sql "SELECT * FROM \"0367\" ORDER BY id DESC LIMIT 1;"
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π

–ü–∞—Ä—Ç–∏—Ü–∏–∏ **–ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏—Ö –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º:

```bash
# –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –ø–∞—Ä—Ç–∏—Ü–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
./logger_partitions.sh add-enterprise 0375

# –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
curl -X POST http://localhost:8026/log/event -H "Content-Type: application/json" -d '{
    "enterprise_number": "0375",
    "unique_id": "1759490248.0", 
    "event_type": "dial",
    "event_data": {...}
}'
```

#### –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

**–ö–∞–≤—ã—á–∫–∏ –≤ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö:**
–ü–æ—Å–∫–æ–ª—å–∫—É –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω—ã —Ü–∏—Ñ—Ä–∞–º–∏, –≤ SQL –Ω—É–∂–Ω—ã –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏:
```sql
-- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
SELECT * FROM "0367";

-- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ  
SELECT * FROM 0367;
```

**–ü—Ä–æ—Å—Ç—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π:**
- –ü–∞—Ä—Ç–∏—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0367 –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ `"0367"`
- –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ `call_traces_` –±–æ–ª—å—à–µ –Ω–µ—Ç
- –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

#### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞—Ä—Ç–∏—Ü–∏–π

**–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –†–∞–∑–º–µ—Ä—ã –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
./logger_partitions.sh list

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
for enterprise in 0367 0280 0368; do
    echo "=== –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ $enterprise ==="
    ./logger_partitions.sh stats $enterprise
    echo ""
done
```

**–ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π:**
```bash
# –ü–∞—Ä—Ç–∏—Ü–∏–∏ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö (–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–Ω—ã –æ—à–∏–±–æ—á–Ω–æ)
./logger_partitions.sh sql "
SELECT 
    tablename as partition_name,
    pg_size_pretty(pg_total_relation_size('public.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename ~ '^[0-9]{4}$'
ORDER BY pg_total_relation_size('public.'||tablename) DESC;
"

# –ü–æ–∏—Å–∫ –ø—É—Å—Ç—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
./logger_partitions.sh sql "
SELECT 
    tablename,
    (SELECT COUNT(*) FROM call_traces WHERE tableoid = ('public.'||tablename)::regclass) as records
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename ~ '^[0-9]{4}$'
HAVING (SELECT COUNT(*) FROM call_traces WHERE tableoid = ('public.'||tablename)::regclass) = 0;
"
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞
- –§–∞–π–ª: `logs/logger.log`
- –§–æ—Ä–º–∞—Ç: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Python logging
- –†–æ—Ç–∞—Ü–∏—è: –ü–æ —Ä–∞–∑–º–µ—Ä—É (10MB)

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–π—Å–æ–≤
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –°–µ—Ä–≤–∏—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç --reload –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ç–æ—Ä–º–æ–∑–æ–≤
2. **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL —Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ localhost –∏ —á–µ—Ä–µ–∑ Nginx –Ω–∞ `/logger/`
4. **–ü–∞—Ä—Ç–∏—Ü–∏–∏**: –ù–∞–∑–≤–∞–Ω—ã –ø—Ä–æ—Å—Ç–æ –Ω–æ–º–µ—Ä–∞–º–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π (0367, 0280, etc.) –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
5. **SQL –∑–∞–ø—Ä–æ—Å—ã**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø–∞—Ä—Ç–∏—Ü–∏–π
6. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π**: –ü–∞—Ä—Ç–∏—Ü–∏–∏ –ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
7. **JSONB**: –í—Å–µ —Å–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–¥–Ω–æ–º JSONB –ø–æ–ª–µ –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

- **8000** - –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏)
- **8020** - –°–µ—Ä–≤–∏—Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–∏—Å—Ç–æ—á–Ω–∏–∫ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤)
- **PostgreSQL** - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–±—É–¥—É—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 1.0.0  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 2025-10-03  
**–ê–≤—Ç–æ—Ä**: Call Logger Service Team

---

## üìã –°–¢–ê–¢–£–° –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê (2025-10-17) - ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

### ‚úÖ –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ (–ó–ê–í–ï–†–®–ï–ù–û)
- ‚úÖ –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–≤—ã—è–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º)
- ‚úÖ –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ –ë–î: 15 –ø–æ–ª–µ–π, 78 LIST –ø–∞—Ä—Ç–∏—Ü–∏–π –ø–æ —é–Ω–∏—Ç–∞–º
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ

### ‚úÖ –≠—Ç–∞–ø 2: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ë–î —Å—Ö–µ–º—ã (–ó–ê–í–ï–†–®–ï–ù–û)
**–î–æ–±–∞–≤–ª–µ–Ω—ã 4 –Ω–æ–≤—ã—Ö JSONB –ø–æ–ª—è:**
- ‚úÖ `http_requests` - –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ `sql_queries` - –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è SQL –æ–ø–µ—Ä–∞—Ü–∏–π  
- ‚úÖ `telegram_messages` - –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è Telegram –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ `integration_responses` - –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

**–°–æ–∑–¥–∞–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- ‚úÖ 4 GIN –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ JSONB –ø–æ–ª—è–º
- ‚úÖ 4 –Ω–æ–≤—ã–µ PL/pgSQL —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤:
  - `add_http_request()` - 8 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  - `add_sql_query()` - 7 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  - `add_telegram_message()` - 8 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  - `add_integration_response()` - 10 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### ‚úÖ –≠—Ç–∞–ø 3: –ü–µ—Ä–µ–ø–∏—Å–∞–Ω–∏–µ API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (–ó–ê–í–ï–†–®–ï–ù–û)
- ‚úÖ POST /log/event - —Å–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–æ–≤ (—Ä–∞–±–æ—Ç–∞–µ—Ç)
- ‚úÖ POST /log/http - –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ in-memory –≤ PostgreSQL
- ‚úÖ POST /log/sql - –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ in-memory –≤ PostgreSQL
- ‚úÖ POST /log/telegram - –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ in-memory –≤ PostgreSQL
- ‚úÖ POST /log/integration - –ù–û–í–´–ô —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –£–¥–∞–ª–µ–Ω–æ 93 —Å—Ç—Ä–æ–∫–∏ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–ö–†–ò–¢–ò–ß–ù–û–ï)
- –î–æ–±–∞–≤–ª–µ–Ω–æ 150+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQL

### ‚úÖ –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ GET —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (–ó–ê–í–ï–†–®–ï–ù–û)
- ‚úÖ GET /trace/{unique_id} - –ø–æ–ª–Ω—ã–π timeline —Å–æ –í–°–ï–ú–ò 5 —Ç–∏–ø–∞–º–∏ –ª–æ–≥–æ–≤:
  - call_event (—Å–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞)
  - http_request (HTTP –∑–∞–ø—Ä–æ—Å—ã)
  - sql_query (SQL –∑–∞–ø—Ä–æ—Å—ã)
  - telegram_message (Telegram –æ–ø–µ—Ä–∞—Ü–∏–∏)
  - integration_response (–æ—Ç–≤–µ—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π)
- ‚úÖ GET /search - –ø–æ–∏—Å–∫ –≤ –ë–î —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ (–¥–∞—Ç–∞, —Å—Ç–∞—Ç—É—Å, –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ)
- ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ timeline –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è summary —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### ‚úÖ –≠—Ç–∞–ø 6.1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ LoggerClient (–ó–ê–í–ï–†–®–ï–ù–û)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `log_integration_response()`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `log_integration_call()`
- ‚úÖ –í—Å–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã

### ‚úÖ –ü–æ–ª–Ω–æ–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ü–†–û–ô–î–ï–ù–û)
**–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
1. ‚úÖ Dial —Å–æ–±—ã—Ç–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
2. ‚úÖ HTTP –∑–∞–ø—Ä–æ—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
3. ‚úÖ SQL –∑–∞–ø—Ä–æ—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
4. ‚úÖ Telegram —Å–æ–æ–±—â–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
5. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
6. ‚úÖ /trace –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π timeline
7. ‚úÖ /search —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏

### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- **–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω**: logger.py (693 —Å—Ç—Ä–æ–∫), logger_client.py (+50 —Å—Ç—Ä–æ–∫)
- **–ë–î —Ñ—É–Ω–∫—Ü–∏–∏**: 4 –Ω–æ–≤—ã–µ PL/pgSQL —Ñ—É–Ω–∫—Ü–∏–∏
- **–ò–Ω–¥–µ–∫—Å—ã**: 4 GIN –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ JSONB –ø–æ–ª—è
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–ª–Ω—ã–π e2e —Ç–µ—Å—Ç ‚úÖ

### üîÑ –û—Å—Ç–∞—é—â–∏–µ—Å—è —ç—Ç–∞–ø—ã (1-2 –¥–Ω—è —Ä–∞–±–æ—Ç—ã)

#### –≠—Ç–∞–ø 6.2-6.4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º (–¢–†–ï–ë–£–ï–¢–°–Ø)
- üîÑ dial.py - –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –í–°–ï HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- üîÑ bridge.py - –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤  
- üîÑ hangup.py - –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤

#### –≠—Ç–∞–ø 7: –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–¢–†–ï–ë–£–ï–¢–°–Ø)
- üìã Unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- üìã –ü–æ–ª–Ω—ã–π e2e —Ç–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–≤–æ–Ω–∫–∞–º–∏
- üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –≠—Ç–∞–ø 8: –§–∏–Ω–∞–ª—å–Ω–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–¢–ï–ö–£–©–ê–Ø)
- üìã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ logger.md (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
- üìã –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- üìã –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### üéØ –ö–ª—é—á–µ–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**‚úÖ –û–î–ù–ê –∑–∞–ø–∏—Å—å –≤ PostgreSQL = –ü–û–õ–ù–´–ô timeline –∑–≤–æ–Ω–∫–∞ —Å–æ –í–°–ï–ú–ò –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏**

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç:
- ‚úÖ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å - –¥–∞–Ω–Ω—ã–µ –ù–ï —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
- ‚úÖ –ü–æ–ª–Ω–æ—Ç—É - –≤—Å–µ –ª–æ–≥–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ –ü–æ–∏—Å–∫ - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å - –≥–æ—Ç–æ–≤–æ –∫ production
- ‚úÖ –û—Ç–ª–∞–¥–∫—É - –ø–æ–ª–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∑–≤–æ–Ω–∫–∞

### üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production

**–°–¢–ê–¢–£–°: ‚úÖ PRODUCTION READY**
- ‚úÖ –Ø–¥—Ä–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç—Ç–∞–ø—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º (6.2-6.4)
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ–µ e2e —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 2.0 (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-10-17)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ PRODUCTION READY (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç—Ç–∞–ø—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã)  
**–ó–∞–≤–µ—Ä—à–µ–Ω–æ**: –≠—Ç–∞–ø—ã 1-6.1 (50% –ø–ª–∞–Ω–∞, 100% –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —ç—Ç–∞–ø–æ–≤)  
**–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: ~2 —á–∞—Å–∞  
**–ê–≤—Ç–æ—Ä**: Call Logger Service Team

---

## üîç –ê–ù–ê–õ–ò–¢–ò–ö–ê: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ "–û–î–ò–ù –ó–í–û–ù–û–ö = –û–î–ù–ê –ó–ê–ü–ò–°–¨" (2025-10-18)

### üéØ –ü—Ä–æ–±–ª–µ–º–∞ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- –û–¥–∏–Ω –∑–≤–æ–Ω–æ–∫ –≤ Asterisk = **–î–í–ê UniqueId** (–¥–≤–∞ –∫–∞–Ω–∞–ª–∞ –≤ bridge-–º–æ—Å—Ç—É)
- –ö–∞–∂–¥—ã–π UniqueId —Å–æ–∑–¥–∞–µ—Ç **–æ—Ç–¥–µ–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å** –≤ `call_traces`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: **2 –∑–∞–ø–∏—Å–∏ –≤ –ë–î** –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π

**–ü—Ä–∏–º–µ—Ä –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤:**
```
UniqueId: 1760709490.90 (–∫–∞–Ω–∞–ª 1) ‚Üí –∑–∞–ø–∏—Å—å 1 –≤ –ë–î
UniqueId: 1760709496.96 (–∫–∞–Ω–∞–ª 2) ‚Üí –∑–∞–ø–∏—Å—å 2 –≤ –ë–î
BridgeUniqueid: 9aee1b64-59fe-4da0-b11f-835ff1f22cf9 (–û–î–ò–ù –¥–ª—è –æ–±–æ–∏—Ö!)
```

### ‚úÖ –†–ï–®–ï–ù–ò–ï: BridgeUniqueid –∫–∞–∫ —Å–≤—è–∑—É—é—â–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:**
- **BridgeUniqueid** - —ç—Ç–æ UUID –º–æ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π **–û–î–ò–ù** –¥–ª—è –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤ –≤ –∑–≤–æ–Ω–∫–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `BridgeUniqueid` –∫–∞–∫ **PRIMARY KEY** –≤–º–µ—Å—Ç–æ `unique_id`
- –•—Ä–∞–Ω–∏—Ç—å –≤—Å–µ `UniqueId` –∫–∞–Ω–∞–ª–æ–≤ –≤ **JSONB –º–∞—Å—Å–∏–≤–µ** –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏

### üìä –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã

```sql
CREATE TABLE call_traces (
    id BIGSERIAL,
    bridge_unique_id VARCHAR(50) NOT NULL,      -- –û–°–ù–û–í–ù–û–ô –ö–õ–Æ–ß (BridgeUniqueid)
    enterprise_number VARCHAR(10) NOT NULL,
    channel_unique_ids JSONB DEFAULT '[]'::jsonb,  -- –ú–∞—Å—Å–∏–≤ –≤—Å–µ—Ö UniqueId –∫–∞–Ω–∞–ª–æ–≤
    phone_number VARCHAR(20),
    call_direction VARCHAR(10),
    call_status VARCHAR(20) DEFAULT 'active',
    start_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    end_time TIMESTAMP WITH TIME ZONE,
    
    -- JSONB –ø–æ–ª—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ª–æ–≥–æ–≤
    call_events JSONB DEFAULT '[]'::jsonb,
    http_requests JSONB DEFAULT '[]'::jsonb,
    sql_queries JSONB DEFAULT '[]'::jsonb,
    telegram_messages JSONB DEFAULT '[]'::jsonb,
    integration_responses JSONB DEFAULT '[]'::jsonb,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    PRIMARY KEY (bridge_unique_id, enterprise_number)
) PARTITION BY LIST (enterprise_number);
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
1. `bridge_unique_id` - –Ω–æ–≤—ã–π PRIMARY KEY (–≤–º–µ—Å—Ç–æ `unique_id`)
2. `channel_unique_ids` - JSONB –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö UniqueId –∫–∞–Ω–∞–ª–æ–≤
3. –í—Å–µ —Å–æ–±—ã—Ç–∏—è –æ–±–æ–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ ‚Üí **–û–î–ù–ê –∑–∞–ø–∏—Å—å**

### üîë –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è BridgeUniqueid

**–ê–ª–≥–æ—Ä–∏—Ç–º –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–≤—è–∑—É—é—â–µ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞:**

```python
def get_call_identifier(events):
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–≤—è–∑—É—é—â–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–∞
    
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
    1. BridgeUniqueid –∏–∑ –ø–µ—Ä–≤–æ–≥–æ bridge —Å–æ–±—ã—Ç–∏—è (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª—É—á–∞–π)
    2. UniqueId –∏–∑ –ø–µ—Ä–≤–æ–≥–æ start/dial —Å–æ–±—ã—Ç–∏—è (fallback)
    """
    # 1. –ò—â–µ–º –ø–µ—Ä–≤—ã–π bridge - –±–µ—Ä–µ–º –µ–≥–æ BridgeUniqueid
    first_bridge = next((e for e in events if e.event == 'bridge'), None)
    if first_bridge and first_bridge.data.get('BridgeUniqueid'):
        return first_bridge.data.get('BridgeUniqueid')
    
    # 2. Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º UniqueId –∏–∑ start/dial
    start_or_dial = next((e for e in events if e.event in ['start', 'dial']), None)
    if start_or_dial:
        return start_or_dial.uniqueid
    
    return None
```

**–ò—Å—Ç–æ—á–Ω–∏–∫ –ª–æ–≥–∏–∫–∏:**
- –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ `events.md` (—Å—Ç—Ä–æ–∫–∏ 508-521)
- –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫: –ø–µ—Ä–≤–æ–µ `start` —Å–æ–±—ã—Ç–∏–µ
- –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫: –ø–µ—Ä–≤–æ–µ `dial` —Å–æ–±—ã—Ç–∏–µ
- –°–≤—è–∑—å –∫–∞–Ω–∞–ª–æ–≤: `BridgeUniqueid` –∏–∑ –ø–µ—Ä–≤–æ–≥–æ `bridge` —Å–æ–±—ã—Ç–∏—è

### üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

#### 1. –§—É–Ω–∫—Ü–∏—è –ë–î `add_call_event()` - –¢–†–ï–ë–£–ï–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø

**–ù–æ–≤–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞:**
```sql
CREATE OR REPLACE FUNCTION add_call_event(
    p_bridge_unique_id VARCHAR(50),    -- –ù–û–í–´–ô: –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á
    p_channel_unique_id VARCHAR(50),   -- –ù–û–í–´–ô: UniqueId –∫–∞–Ω–∞–ª–∞
    p_enterprise_number VARCHAR(10),
    p_event_type VARCHAR(30),
    p_event_data JSONB,
    p_phone_number VARCHAR(20) DEFAULT NULL
)
RETURNS BIGINT AS $$
DECLARE
    v_trace_id BIGINT;
BEGIN
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å –ø–æ bridge_unique_id
    SELECT id INTO v_trace_id 
    FROM call_traces 
    WHERE bridge_unique_id = p_bridge_unique_id 
      AND enterprise_number = p_enterprise_number;
    
    IF v_trace_id IS NOT NULL THEN
        -- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        UPDATE call_traces SET
            -- –î–æ–±–∞–≤–ª—è–µ–º channel_unique_id –≤ –º–∞—Å—Å–∏–≤ (–µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç)
            channel_unique_ids = CASE 
                WHEN NOT channel_unique_ids @> jsonb_build_array(p_channel_unique_id)
                THEN channel_unique_ids || jsonb_build_array(p_channel_unique_id)
                ELSE channel_unique_ids
            END,
            -- –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ
            call_events = call_events || jsonb_build_object(
                'event_sequence', jsonb_array_length(call_events) + 1,
                'event_type', p_event_type,
                'event_timestamp', NOW(),
                'channel_unique_id', p_channel_unique_id,
                'event_data', p_event_data
            ),
            updated_at = NOW()
        WHERE id = v_trace_id;
    ELSE
        -- –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        INSERT INTO call_traces (
            bridge_unique_id, 
            enterprise_number, 
            channel_unique_ids,
            phone_number, 
            call_direction, 
            call_status, 
            call_events
        )
        VALUES (
            p_bridge_unique_id, 
            p_enterprise_number, 
            jsonb_build_array(p_channel_unique_id),
            p_phone_number, 
            CASE WHEN p_event_type IN ('start', 'dial') THEN 'outgoing' END,
            'active',
            jsonb_build_array(jsonb_build_object(
                'event_sequence', 1,
                'event_type', p_event_type,
                'event_timestamp', NOW(),
                'channel_unique_id', p_channel_unique_id,
                'event_data', p_event_data
            ))
        )
        RETURNING id INTO v_trace_id;
    END IF;

    RETURN v_trace_id;
END;
$$ LANGUAGE plpgsql;
```

#### 2. API —ç–Ω–¥–ø–æ–∏–Ω—Ç `/log/event` - –¢–†–ï–ë–£–ï–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø

```python
@app.post("/log/event")
async def log_call_event(event: CallEvent):
    try:
        conn = await asyncpg.connect(**DB_CONFIG)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º bridge_unique_id –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è
        bridge_uid = event.event_data.get('BridgeUniqueid') or event.unique_id
        channel_uid = event.unique_id
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Å –Ω–æ–≤–æ–π —Å–∏–≥–Ω–∞—Ç—É—Ä–æ–π
        await conn.fetchval(
            "SELECT add_call_event($1, $2, $3, $4, $5, $6)",
            bridge_uid,           # bridge_unique_id (–æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á)
            channel_uid,          # channel_unique_id (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –º–∞—Å—Å–∏–≤)
            event.enterprise_number,
            event.event_type,
            json.dumps(event.event_data),
            event.event_data.get('Phone')
        )
        
        await conn.close()
        return {"status": "success"}
    except Exception as e:
        logger.error(f"Error logging event: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

#### 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π - –¢–†–ï–ë–£–Æ–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø

**dial.py, bridge.py, hangup.py:**
- –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `log_call_event()` –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `BridgeUniqueid` –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- –î–ª—è —Å–æ–±—ã—Ç–∏–π –±–µ–∑ bridge –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `UniqueId` –∫–∞–∫ fallback

### üìà –†–µ–∑—É–ª—å—Ç–∞—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–ë–´–õ–û (—Ç–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞):**
```sql
-- –î–≤–∞ UniqueId ‚Üí –¥–≤–µ –∑–∞–ø–∏—Å–∏
SELECT * FROM "0367";

 id | unique_id        | events | telegram_messages
----+------------------+--------+------------------
  1 | 1760709490.90    | 6      | {...}
  2 | 1760709496.96    | 2      | {...}
```

**–°–¢–ê–ù–ï–¢ (–Ω–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞):**
```sql
-- –û–¥–∏–Ω BridgeUniqueid ‚Üí –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å
SELECT * FROM "0367";

 id | bridge_unique_id                      | channel_unique_ids              | events
----+---------------------------------------+---------------------------------+--------
  1 | 9aee1b64-59fe-4da0-b11f-835ff1f22cf9 | ["1760709490.90","1760709496.96"] | 8
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. ‚úÖ **–û–¥–∏–Ω –∑–≤–æ–Ω–æ–∫ = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å** (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
2. ‚úÖ **–í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ** (—Å–æ–±—ã—Ç–∏—è –æ–±–æ–∏—Ö –∫–∞–Ω–∞–ª–æ–≤)
3. ‚úÖ **–ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞** (–≤—Å–µ UniqueId —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –º–∞—Å—Å–∏–≤–µ)
4. ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞** (–Ω–µ –Ω—É–∂–Ω–æ JOIN-–∏—Ç—å –∑–∞–ø–∏—Å–∏)
5. ‚úÖ **Telegram —Å–æ–æ–±—â–µ–Ω–∏—è** (–≤—Å–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏)

### üöÄ –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

#### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î
1. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `bridge_unique_id` –≤ `call_traces`
2. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `channel_unique_ids` (JSONB)
3. –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –Ω–∞ `bridge_unique_id`
4. –û–±–Ω–æ–≤–∏—Ç—å UNIQUE constraint

#### –≠—Ç–∞–ø 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –ë–î
1. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å `add_call_event()` —Å –Ω–æ–≤–æ–π —Å–∏–≥–Ω–∞—Ç—É—Ä–æ–π
2. –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (add_http_request, add_telegram_message –∏ —Ç.–¥.)
3. –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

#### –≠—Ç–∞–ø 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API
1. –û–±–Ω–æ–≤–∏—Ç—å `/log/event` —ç–Ω–¥–ø–æ–∏–Ω—Ç
2. –û–±–Ω–æ–≤–∏—Ç—å `/trace/{id}` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ bridge_unique_id
3. –û–±–Ω–æ–≤–∏—Ç—å `/search` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ bridge_unique_id

#### –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
1. –û–±–Ω–æ–≤–∏—Ç—å `dial.py` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è BridgeUniqueid
2. –û–±–Ω–æ–≤–∏—Ç—å `bridge.py` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è BridgeUniqueid
3. –û–±–Ω–æ–≤–∏—Ç—å `hangup.py` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è BridgeUniqueid

#### –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –¢–µ—Å—Ç–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏ —Å —ç–º—É–ª—è—Ü–∏–µ–π
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è –û–î–ù–ê –∑–∞–ø–∏—Å—å
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ UniqueId –≤ –º–∞—Å—Å–∏–≤–µ
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ timeline –∏ –ø–æ–∏—Å–∫–∞

### üìã –°—Ç–∞—Ç—É—Å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

**–°–¢–ê–¢–£–°: üîÑ –ò–¢–ï–†–ê–¢–ò–í–ù–ê–Ø –†–ê–ó–†–ê–ë–û–¢–ö–ê**

**–ù–û–í–´–ô –ü–û–î–•–û–î (2025-10-18):**

–í–º–µ—Å—Ç–æ –ø–æ–ø—ã—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ "–≤ –ª–æ–±", –∏—Å–ø–æ–ª—å–∑—É–µ–º **–∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥**:

1. **–≠–º—É–ª—è—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤** –æ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –∫ —Å–ª–æ–∂–Ω–æ–º—É (1-1 ‚Üí 2-8 ‚Üí FollowMe)
2. **–ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞:**
   - –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
   - –ß—Ç–æ –∑–∞–ø–∏—Å–∞–ª–æ—Å—å –≤ –ë–î
   - –ö–∞–∫–∏–µ "—è–∫–æ—Ä—è" —Å–≤—è–∑—ã–≤–∞—é—Ç —Å–æ–±—ã—Ç–∏—è
3. **–í—ã—è–≤–ª–µ–Ω–∏–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–µ–π** –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
4. **–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ** –∞–ª–≥–æ—Ä–∏—Ç–º–∞

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º, –æ—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π –≤ —Å—Ç–∞—Ä—ã—Ö Asterisk.

**–ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø:** 
- ‚úÖ **–í–°–ï —Å–æ–±—ã—Ç–∏—è** –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞–¥–∞—Ç—å –≤ –ë–î (–Ω–∏ –æ–¥–Ω–æ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è!)
- ‚úÖ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ - –≤—Ç–æ—Ä–∏—á–Ω–∞—è –∑–∞–¥–∞—á–∞, –ø–µ—Ä–≤–∏—á–Ω–∞—è - **–ø–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö**

---

## üî¨ –ò–¢–ï–†–ê–¢–ò–í–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–ê–¢–¢–ï–†–ù–û–í (2025-10-18)

### üéØ –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è

**–†–∞–±–æ—á–∏–π —Ü–∏–∫–ª –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞:**

1. **–û—á–∏—Å—Ç–∫–∞:** `./deletelogs.sh 0367` + –æ—á–∏—Å—Ç–∫–∞ `call_tester_events.log`
2. **–≠–º—É–ª—è—Ü–∏—è:** –ó–∞–ø—É—Å–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —á–µ—Ä–µ–∑ —Ç–µ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
3. **–ê–Ω–∞–ª–∏–∑:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `call_tester_events.log` - —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î –ø–∞—Ä—Ç–∏—Ü–∏–∏ `0367` - —á—Ç–æ –∑–∞–ø–∏—Å–∞–ª–æ—Å—å
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –≤—Å–µ –ª–∏ —Å–æ–±—ã—Ç–∏—è –ø–æ–ø–∞–ª–∏ –≤ –ë–î?
4. **–í—ã—è–≤–ª–µ–Ω–∏–µ "—è–∫–æ—Ä–µ–π":**
   - –ö–∞–∫–∏–µ –ø–æ–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–∞?
   - –ö–∞–∫ —Å–≤—è–∑–∞–Ω—ã —Ä–∞–∑–Ω—ã–µ UniqueId?
   - –ö–∞–∫ —Å–≤—è–∑–∞–Ω—ã —Ä–∞–∑–Ω—ã–µ BridgeUniqueid?
5. **–ü—Ä–∞–≤–∏–ª–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:**
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–µ–π
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
6. **–ü—Ä–∞–≤–∫–∏ –∫–æ–¥–∞:** –í–Ω–µ—Å–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ logger.py –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
7. **–ü–æ–≤—Ç–æ—Ä:** –ù–æ–≤–∞—è —ç–º—É–ª—è—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ "—è–∫–æ—Ä—è" –¥–ª—è —Å–≤—è–∑–∏ —Å–æ–±—ã—Ç–∏–π:**
- `Phone` - –≤–Ω–µ—à–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- `Token` - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
- –ü–µ—Ä–≤—ã–π `UniqueId` –∏–∑ start/dial —Å–æ–±—ã—Ç–∏—è
- `BridgeUniqueid` - —Å–≤—è–∑—å —á–µ—Ä–µ–∑ –º–æ—Å—Ç—ã
- `CallerIDNum` / `ConnectedLineNum` - —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∫–∞–Ω–∞–ª–∞–º–∏
- –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ (—Å–æ–±—ã—Ç–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö N —Å–µ–∫—É–Ω–¥)
- `Extensions` - —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–≤–æ–Ω–∫–∞

### üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

| –ü–∞—Ç—Ç–µ—Ä–Ω | –°–æ–±—ã—Ç–∏—è | UniqueId | –ú–æ—Å—Ç—ã | Phone | –°—Ç–∞—Ç—É—Å | –ù–∞–π–¥–µ–Ω–Ω—ã–µ —è–∫–æ—Ä—è |
|---------|---------|----------|-------|-------|--------|-----------------|
| 1-1 | 9 | 2 | 1 | 1 | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω | Phone (1 —É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| 2-18 | 45 | 8 | 5 | 1 | üìã –ê–Ω–∞–ª–∏–∑ | Phone (1 —É–Ω–∏–∫–∞–ª—å–Ω—ã–π!) |
| 2-23 | 39 | 8 | 4 | 2 | üìã –ê–Ω–∞–ª–∏–∑ | Phone (2 —Ä–∞–∑–Ω—ã—Ö) |
| 2-8 | 37 | 9 | 3 | 3 | üìã –ê–Ω–∞–ª–∏–∑ | Phone (3 —Ä–∞–∑–Ω—ã—Ö!) |
| 2-25 | 34 | 9 | 3 | 2 | üìã –ê–Ω–∞–ª–∏–∑ | - |
| 2-7 | 31 | 9 | 3 | 3 | üìã –ê–Ω–∞–ª–∏–∑ | - |
| 2-28 | 30 | 6 | 3 | 2 | üìã –ê–Ω–∞–ª–∏–∑ | - |
| 2-9 | 27 | 8 | 2 | 3 | üìã –ê–Ω–∞–ª–∏–∑ | - |
| 2-24 | 27 | 6 | 4 | 2 | üìã –ê–Ω–∞–ª–∏–∑ | - |
| 2-20 | 27 | 6 | 3 | 1 | üìã –ê–Ω–∞–ª–∏–∑ | Phone (1 —É–Ω–∏–∫–∞–ª—å–Ω—ã–π!) |

### üîç –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ DB —Ñ–∞–π–ª–æ–≤

**–ê–Ω–∞–ª–∏–∑ —Ç–æ–ø-10 —Å–∞–º—ã—Ö —Å–ª–æ–∂–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–æ–∫–∞–∑–∞–ª:**

1. **Phone –ù–ï –≤—Å–µ–≥–¥–∞ —É–Ω–∏–∫–∞–ª–µ–Ω!**
   - –ü–∞—Ç—Ç–µ—Ä–Ω 2-18: 45 —Å–æ–±—ã—Ç–∏–π, 8 UniqueId, 5 –º–æ—Å—Ç–æ–≤, –Ω–æ **1 Phone** ‚úÖ
   - –ü–∞—Ç—Ç–µ—Ä–Ω 2-23: 39 —Å–æ–±—ã—Ç–∏–π, 8 UniqueId, 4 –º–æ—Å—Ç–∞, –Ω–æ **2 Phone** ‚ùå
   - –ü–∞—Ç—Ç–µ—Ä–Ω 2-8: 37 —Å–æ–±—ã—Ç–∏–π, 9 UniqueId, 3 –º–æ—Å—Ç–∞, –Ω–æ **3 Phone** ‚ùå

2. **BridgeUniqueid —Ç–æ–∂–µ –ù–ï —É–Ω–∏–∫–∞–ª–µ–Ω!**
   - –û–¥–∏–Ω –∑–≤–æ–Ω–æ–∫ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ—Å—Ç–æ–≤** (2-5 –º–æ—Å—Ç–æ–≤)
   - –ü–∞—Ç—Ç–µ—Ä–Ω 2-18: **5 —Ä–∞–∑–Ω—ã—Ö BridgeUniqueid** –≤ –æ–¥–Ω–æ–º –∑–≤–æ–Ω–∫–µ!

3. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ UniqueId –≤–∞—Ä—å–∏—Ä—É–µ—Ç—Å—è:**
   - –û—Ç 2 (–ø—Ä–æ—Å—Ç–æ–π –∑–≤–æ–Ω–æ–∫) –¥–æ 9 (—Å–ª–æ–∂–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥)
   - –°—Ä–µ–¥–Ω–µ–µ: 6-8 UniqueId –Ω–∞ —Å–ª–æ–∂–Ω—ã–π –∑–≤–æ–Ω–æ–∫

**–í–´–í–û–î:** –ù–∏ Phone, –Ω–∏ BridgeUniqueid, –Ω–∏ UniqueId **–ù–ï —è–≤–ª—è—é—Ç—Å—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º —è–∫–æ—Ä–µ–º!**

### üìä –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó 36 –ü–ê–¢–¢–ï–†–ù–û–í

**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ Phone:**
- **0 Phone** (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–≤–æ–Ω–∫–∏): 3 –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (8%) - 3-1, 3-2, 3-3
- **1 Phone** (–ø—Ä–æ—Å—Ç—ã–µ): 15 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (41%) - –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã 1-x, 2-1 –¥–æ 2-4, 2-12, 2-18
- **2 Phone** (—Å—Ä–µ–¥–Ω–∏–µ): 8 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (22%) - 1-2, 2-23 –¥–æ 2-29
- **3 Phone** (—Å–ª–æ–∂–Ω—ã–µ): 10 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (27%) - 2-5 –¥–æ 2-15

**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –º–æ—Å—Ç–∞–º:**
- **0 –º–æ—Å—Ç–æ–≤**: 6 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–Ω–µ—É—Å–ø–µ—à–Ω—ã–µ –∑–≤–æ–Ω–∫–∏)
- **1 –º–æ—Å—Ç**: 12 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–ø—Ä–æ—Å—Ç—ã–µ –∑–≤–æ–Ω–∫–∏)
- **2 –º–æ—Å—Ç–∞**: 8 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏)
- **3 –º–æ—Å—Ç–∞**: 7 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã)
- **4-5 –º–æ—Å—Ç–æ–≤**: 3 –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (—Å–ª–æ–∂–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤)

### üéØ –ê–õ–ì–û–†–ò–¢–ú –ì–†–£–ü–ü–ò–†–û–í–ö–ò –°–û–ë–´–¢–ò–ô

**–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ 36 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:**

#### **–£—Ä–æ–≤–µ–Ω—å 1: –ü—Ä–æ—Å—Ç—ã–µ –∑–≤–æ–Ω–∫–∏ (41% —Å–ª—É—á–∞–µ–≤ - 1 Phone)**

**–Ø–∫–æ—Ä—å:** `Phone` (–≤–Ω–µ—à–Ω–∏–π –Ω–æ–º–µ—Ä)

**–õ–æ–≥–∏–∫–∞:**
```python
if count(distinct Phone) == 1:
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Å —ç—Ç–∏–º Phone
    call_id = f"{enterprise_number}_{phone}_{first_unique_id}"
    # –í—Å–µ UniqueId, BridgeUniqueid —Å —ç—Ç–∏–º Phone ‚Üí –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å
```

**–ü—Ä–∏–º–µ–Ω–∏–º–æ –∫:** 1-1, 1-3 –¥–æ 1-10, 2-1 –¥–æ 2-4, 2-12, 2-18

#### **–£—Ä–æ–≤–µ–Ω—å 2: –°–ª–æ–∂–Ω—ã–µ –∑–≤–æ–Ω–∫–∏ (50% —Å–ª—É—á–∞–µ–≤ - –Ω–µ—Å–∫–æ–ª—å–∫–æ Phone)**

**–Ø–∫–æ—Ä—å:** –ì—Ä–∞—Ñ —Å–≤—è–∑–µ–π —á–µ—Ä–µ–∑ `BridgeUniqueid`

**–õ–æ–≥–∏–∫–∞:**
```python
# –°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ —Å–≤—è–∑–µ–π
graph = {}
for event in events:
    if 'BridgeUniqueid' in event:
        bridge_id = event['BridgeUniqueid']
        unique_id = event['UniqueId']
        # –°–≤—è–∑—ã–≤–∞–µ–º –≤—Å–µ UniqueId —á–µ—Ä–µ–∑ –æ–±—â–∏–π –º–æ—Å—Ç
        graph[unique_id] = bridge_id

# –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ UniqueId (—Ç—Ä–∞–Ω–∑–∏—Ç–∏–≤–Ω–æ–µ –∑–∞–º—ã–∫–∞–Ω–∏–µ)
def find_connected_uids(start_uid, graph):
    connected = set([start_uid])
    bridges = set()
    
    # –ò—â–µ–º –≤—Å–µ –º–æ—Å—Ç—ã –≥–¥–µ —É—á–∞—Å—Ç–≤—É–µ—Ç start_uid
    for uid, bridge in graph.items():
        if uid == start_uid or uid in connected:
            bridges.add(bridge)
    
    # –ò—â–µ–º –≤—Å–µ UniqueId –≤ —ç—Ç–∏—Ö –º–æ—Å—Ç–∞—Ö
    for uid, bridge in graph.items():
        if bridge in bridges:
            connected.add(uid)
    
    return connected

# –ü–µ—Ä–≤—ã–π UniqueId –∏–∑ start/dial = –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á
master_uid = first_unique_id_from_start_or_dial()
all_related_uids = find_connected_uids(master_uid, graph)

# –í—Å–µ —Å–æ–±—ã—Ç–∏—è —Å —ç—Ç–∏–º–∏ UniqueId ‚Üí –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å
call_id = f"{enterprise_number}_{master_uid}"
```

**–ü—Ä–∏–º–µ–Ω–∏–º–æ –∫:** 1-2, 2-5 –¥–æ 2-15, 2-23 –¥–æ 2-29

#### **–£—Ä–æ–≤–µ–Ω—å 3: –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–≤–æ–Ω–∫–∏ (8% —Å–ª—É—á–∞–µ–≤ - 0 Phone)**

**–Ø–∫–æ—Ä—å:** –ü–µ—Ä–≤—ã–π `UniqueId` –∏–∑ start/dial

**–õ–æ–≥–∏–∫–∞:**
```python
if count(distinct Phone) == 0:
    # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∑–≤–æ–Ω–æ–∫ –º–µ–∂–¥—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π UniqueId –∫–∞–∫ —è–∫–æ—Ä—å
    call_id = f"{enterprise_number}_internal_{first_unique_id}"
```

**–ü—Ä–∏–º–µ–Ω–∏–º–æ –∫:** 3-1, 3-2, 3-3

### üîÑ –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –í –ö–û–î–ï

**–≠—Ç–∞–ø 1:** –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ–º:
1. –ò–∑–≤–ª–µ–∫–∞–µ–º `Phone` –∏–∑ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ–ª–µ–π
2. –ò–∑–≤–ª–µ–∫–∞–µ–º `UniqueId` –∏ `BridgeUniqueid`
3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∞

**–≠—Ç–∞–ø 2:** –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ –ë–î:
1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–≤–æ–Ω–∫–∞ (–ø—Ä–æ—Å—Ç–æ–π/—Å–ª–æ–∂–Ω—ã–π/–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)
2. –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
3. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å —Å `call_id`

**–≠—Ç–∞–ø 3:** –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø–∏—Å–∏:
```sql
{
  "call_id": "0367_375296254070_1760786367.67",
  "enterprise_number": "0367",
  "phone": "375296254070",
  "master_unique_id": "1760786367.67",
  "related_unique_ids": ["1760786367.67", "1760786372.72"],
  "bridge_unique_ids": ["3554b644-10e5-4483-93c6-f501d192062c"],
  "call_events": [...],  // –í–°–ï —Å–æ–±—ã—Ç–∏—è
  "telegram_messages": {...}  // –ü–æ chat_id
}
```

---

## üîß –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ BridgeUniqueid (2025-10-18)

### –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

#### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (`migrations/update_call_traces_bridge_grouping.sql`)

**–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è:**
- `bridge_unique_id VARCHAR(50)` - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π
- `related_unique_ids JSONB` - –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö UniqueId –∫–∞–Ω–∞–ª–æ–≤ –≤ –∑–≤–æ–Ω–∫–µ
- –ò–Ω–¥–µ–∫—Å `idx_call_traces_bridge_unique_id` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

**–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `add_call_event`:**
```sql
CREATE OR REPLACE FUNCTION add_call_event(
    p_unique_id VARCHAR,
    p_enterprise_number VARCHAR,
    p_event_type VARCHAR,
    p_event_data JSONB,
    p_phone_number VARCHAR DEFAULT NULL,
    p_bridge_unique_id VARCHAR DEFAULT NULL  -- –ù–û–í–´–ô –ø–∞—Ä–∞–º–µ—Ç—Ä
) RETURNS BIGINT
```

**–õ–æ–≥–∏–∫–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:**
1. –ï—Å–ª–∏ –µ—Å—Ç—å `BridgeUniqueid` - –∏—â–µ–º –∑–∞–ø–∏—Å—å –ø–æ –Ω–µ–º—É (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª—É—á–∞–π)
2. –ï—Å–ª–∏ –Ω–µ—Ç `BridgeUniqueid` - –∏—â–µ–º –ø–æ `UniqueId` (fallback –¥–ª—è start/dial)
3. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏:
   - –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π `UniqueId` –≤ –º–∞—Å—Å–∏–≤ `related_unique_ids` (–µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç)
   - –û–±–Ω–æ–≤–ª—è–µ–º `bridge_unique_id` –µ—Å–ª–∏ –æ–Ω –ø—Ä–∏—à–µ–ª –≤–ø–µ—Ä–≤—ã–µ
   - –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ –º–∞—Å—Å–∏–≤ `call_events`

#### 2. API –∫–ª–∏–µ–Ω—Ç (`app/utils/logger_client.py`)

**–û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `log_call_event`:**
```python
async def log_call_event(
    self, 
    enterprise_number: str, 
    unique_id: str, 
    event_type: str, 
    event_data: Dict[str, Any],
    phone_number: Optional[str] = None,
    chat_id: Optional[int] = None,
    bridge_unique_id: Optional[str] = None  # –ù–û–í–´–ô –ø–∞—Ä–∞–º–µ—Ç—Ä
) -> bool
```

#### 3. API —Å–µ—Ä–≤–µ—Ä (`logger.py`)

**–û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `CallEvent`:**
```python
class CallEvent(BaseModel):
    enterprise_number: str
    unique_id: str
    event_type: str
    event_data: Dict[str, Any]
    chat_id: Optional[int] = None
    phone_number: Optional[str] = None  # –ù–û–í–û–ï
    bridge_unique_id: Optional[str] = None  # –ù–û–í–û–ï
    timestamp: Optional[datetime] = None
```

**–û–±–Ω–æ–≤–ª–µ–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç `/log/event`:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç `BridgeUniqueid` –∏–∑ `event_data` –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω —è–≤–Ω–æ
- –ü–µ—Ä–µ–¥–∞–µ—Ç `bridge_unique_id` –≤ —Ñ—É–Ω–∫—Ü–∏—é –ë–î –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

**–î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- 1 –∑–≤–æ–Ω–æ–∫ (–ø–∞—Ç—Ç–µ—Ä–Ω 1-1) ‚Üí 3 –∑–∞–ø–∏—Å–∏ –≤ –ë–î (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ –∫–∞–∂–¥—ã–π UniqueId/BridgeUniqueid)

**–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- 1 –∑–≤–æ–Ω–æ–∫ (–ø–∞—Ç—Ç–µ—Ä–Ω 1-1) ‚Üí **1 –∑–∞–ø–∏—Å—å –≤ –ë–î** —Å:
  - `bridge_unique_id`: "2d95c3b6-d1b4-4c88-8107-c2d407c21b8c"
  - `related_unique_ids`: ["1760789401.01", "1760789407.07"]
  - `call_events`: –º–∞—Å—Å–∏–≤ –∏–∑ 18 —Å–æ–±—ã—Ç–∏–π (9 —Ç–∏–ø–æ–≤ √ó 2 chat_id)

---

## üéØ –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï V5 (2025-10-18)

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:

**–ê–Ω–∞–ª–∏–∑ 36 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏–∑ DB —Ñ–∞–π–ª–æ–≤ –ø–æ–∫–∞–∑–∞–ª:**
- –°–æ–±—ã—Ç–∏—è `dial`, `new_callerid` –ø—Ä–∏—Ö–æ–¥—è—Ç **–î–û** –ø–æ—è–≤–ª–µ–Ω–∏—è `BridgeUniqueid`
- –°–æ–±—ã—Ç–∏–µ `bridge_create` –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å `BridgeUniqueid`, –Ω–æ **–ë–ï–ó** `UniqueId`
- –°–æ–±—ã—Ç–∏–µ `hangup` –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å `UniqueId`, –Ω–æ **–ë–ï–ó** `BridgeUniqueid`
- –ù—É–∂–Ω–æ **–æ–±—ä–µ–¥–∏–Ω—è—Ç—å** –∑–∞–ø–∏—Å–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏

**–ü—Ä–∏–º–µ—Ä –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ø–∞—Ç—Ç–µ—Ä–Ω 1-1):**
```
#1: dial           (UniqueId: 1757765248.0, BridgeUniqueid: –ù–ï–¢)  ‚Üê –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å #1
#2: new_callerid   (UniqueId: 1757765249.1, BridgeUniqueid: –ù–ï–¢)  ‚Üê –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å #2
#3: bridge_create  (UniqueId: –ù–ï–¢,          BridgeUniqueid: 6d2c...) ‚Üê –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å #3
#4: bridge         (UniqueId: 1757765249.1, BridgeUniqueid: 6d2c...) ‚Üê –ù—É–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å #2 –∏ #3!
#5: bridge         (UniqueId: 1757765248.0, BridgeUniqueid: 6d2c...) ‚Üê –ù—É–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å #1 –∏ #3!
#9: hangup         (UniqueId: 1757765248.0, BridgeUniqueid: –ù–ï–¢)  ‚Üê –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –ø–æ related_unique_ids!
```

### –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:

**–§–∞–π–ª:** `migrations/fix_add_call_event_v5.sql`

**–õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è:**

1. **–ò—â–µ–º "—Å–≤–æ—é" –∑–∞–ø–∏—Å—å –ø–æ UniqueId:**
   - –°–Ω–∞—á–∞–ª–∞ –≤ –ø–æ–ª–µ `unique_id`
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - –≤ –º–∞—Å—Å–∏–≤–µ `related_unique_ids` (–¥–ª—è hangup)

2. **–ò—â–µ–º –∑–∞–ø–∏—Å—å —Å BridgeUniqueid** (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ —Å–æ–±—ã—Ç–∏–∏)

3. **–ï—Å–ª–∏ –Ω–∞—à–ª–∏ –û–ë–ï –∑–∞–ø–∏—Å–∏ –∏ —ç—Ç–æ –†–ê–ó–ù–´–ï –∑–∞–ø–∏—Å–∏:**
   - –ü–µ—Ä–µ–Ω–æ—Å–∏–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ "—Å–≤–æ–µ–π" –∑–∞–ø–∏—Å–∏ –≤ –∑–∞–ø–∏—Å—å —Å BridgeUniqueid:
     - `call_events` (–≤—Å–µ —Å–æ–±—ã—Ç–∏—è)
     - `related_unique_ids` (–≤—Å–µ UniqueId)
     - `phone_number`
     - `call_direction`
   - **–£–¥–∞–ª—è–µ–º** "—Å–≤–æ—é" –∑–∞–ø–∏—Å—å
   - –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—É—é –∑–∞–ø–∏—Å—å

4. **–ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å** - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë

5. **–ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π** - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é

**–ö–ª—é—á–µ–≤–æ–π –∫–æ–¥:**
```sql
-- –ü–æ–∏—Å–∫ "—Å–≤–æ–µ–π" –∑–∞–ø–∏—Å–∏
SELECT id INTO v_my_record_id
FROM call_traces
WHERE unique_id = p_unique_id AND enterprise_number = p_enterprise_number;

IF v_my_record_id IS NULL THEN
    -- –ò—â–µ–º –≤ related_unique_ids
    SELECT id INTO v_my_record_id
    FROM call_traces
    WHERE related_unique_ids @> to_jsonb(p_unique_id)
      AND enterprise_number = p_enterprise_number;
END IF;

-- –ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–∏ —Å BridgeUniqueid
SELECT id INTO v_bridge_record_id
FROM call_traces
WHERE bridge_unique_id = p_bridge_unique_id AND enterprise_number = p_enterprise_number;

-- –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ
IF v_my_record_id IS NOT NULL AND v_bridge_record_id IS NOT NULL 
   AND v_my_record_id != v_bridge_record_id THEN
    -- –ü–µ—Ä–µ–Ω–æ—Å–∏–º –¥–∞–Ω–Ω—ã–µ
    SELECT call_events, related_unique_ids, phone_number, call_direction
    INTO v_my_events, v_my_related_uids, v_my_phone, v_my_direction
    FROM call_traces WHERE id = v_my_record_id;
    
    -- –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å —Å BridgeUniqueid
    UPDATE call_traces SET
        call_events = call_events || v_my_events,
        related_unique_ids = related_unique_ids || v_my_related_uids,
        phone_number = COALESCE(phone_number, v_my_phone),
        call_direction = COALESCE(call_direction, v_my_direction)
    WHERE id = v_bridge_record_id;
    
    -- –£–¥–∞–ª—è–µ–º "—Å–≤–æ—é" –∑–∞–ø–∏—Å—å
    DELETE FROM call_traces WHERE id = v_my_record_id;
END IF;
```

### ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–∞—Ç—Ç–µ—Ä–Ω 1-1):

**1 –∑–∞–ø–∏—Å—å** —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
- `unique_id`: `04a857e1-221e-476a-aa75-37601282b68c` (BridgeUniqueid)
- `bridge_unique_id`: `04a857e1-221e-476a-aa75-37601282b68c`
- `related_unique_ids`: `["04a857e1-...", "1760799526.26", "1760799521.21"]` (–≤—Å–µ 3 UniqueId)
- `phone_number`: `+81 (85-7742-5853)`
- `call_direction`: `outgoing`
- `call_status`: `completed`
- `call_events`: **18 —Å–æ–±—ã—Ç–∏–π** (9 —Ç–∏–ø–æ–≤ √ó 2 chat_id)

---

## üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –° TIMEOUT –ù–ê DIAL –°–û–ë–´–¢–ò–Ø–• (2025-11-06)

### –ü—Ä–æ–±–ª–µ–º–∞:
–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ DB —Ñ–∞–π–ª–∞ —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞ (10.88.10.19) –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è `dial` –Ω–µ –¥–æ—Ö–æ–¥—è—Ç –¥–æ –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç —Å –æ—à–∏–±–∫–∞–º–∏:

**AlternativeAPIlogs –Ω–∞ —Ö–æ—Å—Ç–µ:**
```
2025-11-06 14:09:15|dial|1762427351.0|Timeout||0
2025-11-06 14:09:15|dial|1762427351.0|''||0
```

–•–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–±—ã—Ç–∏–µ `dial` **–¥–≤–∞–∂–¥—ã** –≤ —Ç–µ—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π —Å–µ–∫—É–Ω–¥—ã, –Ω–æ:
- –ü–µ—Ä–≤—ã–π —Ä–∞–∑ –ø–æ–ª—É—á–∏–ª **Timeout** (responseTime=0)
- –í—Ç–æ—Ä–æ–π —Ä–∞–∑ –ø–æ–ª—É—á–∏–ª –ø—É—Å—Ç–æ–π —Å—Ç–∞—Ç—É—Å `''` (responseTime=0)

### –ü—Ä–∏—á–∏–Ω–∞:
–í `main.py` —ç–Ω–¥–ø–æ–∏–Ω—Ç `/dial` –∂–¥–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (`await _dispatch_to_all(process_dial, body)`), –∫–æ—Ç–æ—Ä–∞—è –≤–∫–ª—é—á–∞–µ—Ç:
1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ PostgreSQL
2. –û—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–µ—à–∞ –∏ –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

–≠—Ç–æ –∑–∞–Ω–∏–º–∞–ª–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –∏ —Ö–æ—Å—Ç –Ω–µ –¥–æ–∂–∏–¥–∞–ª—Å—è –æ—Ç–≤–µ—Ç–∞, –ø–æ–ª—É—á–∞—è —Ç–∞–π–º–∞—É—Ç.

### –†–µ—à–µ–Ω–∏–µ:
–°–¥–µ–ª–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É `dial` —Å–æ–±—ã—Ç–∏—è **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π**:
- –°—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `200 OK` —Å –æ—Ç–≤–µ—Ç–æ–º `{"status": "ok", "message": "Event queued for processing"}`
- –ó–∞–ø—É—Å–∫–∞—Ç—å –≤—Å—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Ñ–æ–Ω–µ —á–µ—Ä–µ–∑ `asyncio.create_task()`

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:

**main.py** (—ç–Ω–¥–ø–æ–∏–Ω—Ç `/dial`):
```python
@app.post("/dial")
async def asterisk_dial(body: dict = Body(...), request: Request = None):
    """
    –ü—Ä–∏ POST /dial –≤—ã–∑—ã–≤–∞–µ–º process_dial –∏–∑ app/services/calls/dial.py
    –ê–°–ò–ù–•–†–û–ù–ù–û - —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 200 OK, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ñ–æ–Ω–µ
    """
    client_ip = request.client.host if request and request.client else "Unknown"
    logger.info(f"DIAL REQUEST from {client_ip}: {json.dumps(body, ensure_ascii=False)}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Ñ–æ–Ω–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    asyncio.create_task(_dispatch_to_all(process_dial, body))
    
    return JSONResponse({"status": "ok", "message": "Event queued for processing"})
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –•–æ—Å—Ç –ø–æ–ª—É—á–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç `200 OK`
- –í AlternativeAPIlogs –Ω–∞ —Ö–æ—Å—Ç–µ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å `<Response [200]>` –≤–º–µ—Å—Ç–æ `Timeout`
- –í—Å–µ —Å–æ–±—ã—Ç–∏—è `dial` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ PostgreSQL
- –°–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Ñ–æ–Ω–µ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

### ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ö–æ—Å—Ç 0367):
**–£—Å–ø–µ—à–Ω–æ!** –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
2025-11-06 14:54:43|dial|1762430081.3|<Response [200]>|{"status":"ok","message":"Event queued for processing"}|0.565 —Å–µ–∫
```
- –°—Ç–∞—Ç—É—Å: `<Response [200]>` ‚úÖ
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 0.565 —Å–µ–∫—É–Ω–¥—ã ‚úÖ
- –í—Å–µ 9 —Å–æ–±—ã—Ç–∏–π –ø–æ–ø–∞–ª–∏ –≤ PostgreSQL ‚úÖ

### üîß –†–ê–°–®–ò–†–ï–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ù–ê –í–°–ï –°–û–ë–´–¢–ò–Ø (2025-11-06)

–ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ —Ö–æ—Å—Ç–∞ 0351 –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –Ω–∞ –¥—Ä—É–≥–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö (`bridge`, `hangup`, `start`, `bridge_create`, `bridge_leave`, `bridge_destroy`, `new_callerid`).

**–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∫–æ –í–°–ï–ú —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º –≤ `main.py`:**
- `/start`
- `/dial`
- `/bridge`
- `/hangup`
- `/bridge_create`
- `/bridge_leave`
- `/bridge_destroy`
- `/new_callerid`

–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å:
1. –°—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `200 OK` —Å `{"status": "ok", "message": "Event queued for processing"}`
2. –ó–∞–ø—É—Å–∫–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Ñ–æ–Ω–µ —á–µ—Ä–µ–∑ `asyncio.create_task()`

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –†–∞–∑–Ω–∏—Ü–∞ –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö `listen_AMI_python.py` –º–µ–∂–¥—É —Ö–æ—Å—Ç–∞–º–∏ 0367 (3928 —Å—Ç—Ä–æ–∫) –∏ 0351 (3089 —Å—Ç—Ä–æ–∫) –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–∞–π–º–∞—É—Ç—ã. –≠—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–≤–æ–Ω–∫–æ–≤.

---

## üìà –†–ê–°–®–ò–†–ï–ù–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï (2025-11-08)

### üéØ –¶–µ–ª—å
–ü–æ–º–∏–º–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π, –ø—Ä–∏—à–µ–¥—à–∏—Ö —Å —Ö–æ—Å—Ç–∞ Asterisk, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å **–≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–≤–æ–Ω–∫–∞:
1. **SQL –∑–∞–ø—Ä–æ—Å—ã** –∫ –∫—ç—à—É (gsm_lines, sip_lines, customers, managers)
2. **HTTP –∑–∞–ø—Ä–æ—Å—ã** –∫ —Å–µ—Ä–≤–∏—Å–∞–º (8020 - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, 8019 - RetailCRM)
3. **Telegram —Å–æ–æ–±—â–µ–Ω–∏—è** (–∫–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏–ª–∏, –∫–∞–∫–æ–π —Ç–µ–∫—Å—Ç, message_id)
4. **–ó–∞–ø—Ä–æ—Å—ã –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º** (RetailCRM, –ú–æ–π–°–∫–ª–∞–¥ –∏ –¥—Ä.)

### üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

–¢–∞–±–ª–∏—Ü–∞ `call_traces` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ JSONB –ø–æ–ª—è –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

```sql
-- –°–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞ (—É–∂–µ –±—ã–ª–æ)
call_events JSONB DEFAULT '[]'::jsonb

-- HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º
http_requests JSONB DEFAULT '[]'::jsonb

-- SQL –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
sql_queries JSONB DEFAULT '[]'::jsonb

-- –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ Telegram —Å–æ–æ–±—â–µ–Ω–∏—è
telegram_messages JSONB DEFAULT '{}'::jsonb

-- –û—Ç–≤–µ—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
integration_responses JSONB DEFAULT '[]'::jsonb
```

### üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π

–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π (`start.py`, `dial.py`, `hangup.py`):

```python
# –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
await call_logger.log_telegram_message(
    enterprise_number=enterprise_number,
    unique_id=uid,
    chat_id=chat_id,
    message_type="dial",  # start, dial, bridge, hangup
    action="send",  # send, edit, delete
    message_id=sent.message_id,
    message_text=safe_text
)
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏ –≤ –ë–î:**
```json
[
  {
    "sequence": 1,
    "chat_id": 374573193,
    "message_type": "dial",
    "action": "send",
    "message_id": 13165,
    "message_text": "üìû –ò—Å—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤ –Ω–∞ +375 (29) 625-40-70\nüë§ –ú–µ–Ω–µ–¥–∂–µ—Ä: –î–∂—É–Ω–æ–≤—ã–π –î–∂—É–ª–∞–π (–¥–æ–±. 151)\nüì± –õ–∏–Ω–∏—è: –ú–¢–° –ì–ª–∞–≤–Ω—ã–π –æ—Ñ–∏—Å",
    "timestamp": "2025-11-08T09:40:24.588832+00:00"
  },
  {
    "sequence": 2,
    "chat_id": 987654321,
    "message_type": "dial",
    "action": "send",
    "message_id": 13166,
    "message_text": "üìû –ò—Å—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤ –Ω–∞ +375 (29) 625-40-70\nüë§ –ú–µ–Ω–µ–¥–∂–µ—Ä: –î–∂—É–Ω–æ–≤—ã–π –î–∂—É–ª–∞–π",
    "timestamp": "2025-11-08T09:40:24.590000+00:00"
  }
]
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è **–æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞** —Å –µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º `chat_id` –∏ **—Ç–æ—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º**, –∫–æ—Ç–æ—Ä—ã–π –æ–Ω –ø–æ–ª—É—á–∏–ª. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤ –±—É–¥—É—â–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞–∑–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–∞–∑–Ω—ã–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª–Ω—ã–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, –∫—Ä–∞—Ç–∫–∏–µ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤).

#### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `dial.py` –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–∏—Å—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (8020):

```python
# –ü–æ—Å–ª–µ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
await call_logger.log_http_request(
    enterprise_number=enterprise_number,
    unique_id=uid,
    method="GET",
    url="http://localhost:8020/metadata/enrich",
    request_data={"line_id": "0001363", "internal_phone": "151"},
    response_data=enriched_data,
    status_code=200,
    duration_ms=enrichment_duration
)
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏ –≤ –ë–î:**
```json
[
  {
    "method": "GET",
    "url": "http://localhost:8020/metadata/0367/line/0001363",
    "status_code": 200,
    "duration_ms": 245.3,
    "response_data": {
      "line_name": "–ú–¢–° –ì–ª–∞–≤–Ω—ã–π –æ—Ñ–∏—Å",
      "phone_number": "+375296254070"
    },
    "timestamp": "2025-11-08T09:40:24.700000+00:00"
  }
]
```

#### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤

–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–µ—Å—Ç–∞, –≥–¥–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∑–∞–ø—Ä–æ—Å—ã –∫ –∫—ç—à—É:

```python
# –ü–æ—Å–ª–µ SQL –∑–∞–ø—Ä–æ—Å–∞ –∫ gsm_lines
await call_logger.log_sql_query(
    enterprise_number=enterprise_number,
    unique_id=uid,
    query="SELECT line_name, phone_number FROM gsm_lines WHERE line_id = $1",
    parameters=["0001363"],
    result={"line_name": "–ú–¢–° –ì–ª–∞–≤–Ω—ã–π –æ—Ñ–∏—Å", "phone_number": "+375296254070"},
    duration_ms=12.5
)
```

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏ –≤ –ë–î:**
```json
[
  {
    "query": "SELECT line_name, phone_number FROM gsm_lines WHERE line_id = $1",
    "parameters": ["0001363"],
    "result": {
      "line_name": "–ú–¢–° –ì–ª–∞–≤–Ω—ã–π –æ—Ñ–∏—Å",
      "phone_number": "+375296254070"
    },
    "duration_ms": 12.5,
    "timestamp": "2025-11-08T09:40:24.600000+00:00"
  }
]
```

#### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º

–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `dial.py` –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Integration Gateway (8020):

```python
# –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Gateway
await call_logger.log_http_request(
    enterprise_number=enterprise_number,
    unique_id=unique_id_for_gateway,
    method="POST",
    url="http://localhost:8020/dispatch/call-event",
    request_data=payload,
    status_code=resp.status,
    duration_ms=gateway_duration
)
```

### üìä –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤

#### –ß–µ—Ä–µ–∑ SQL:

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∑–≤–æ–Ω–∫—É
SELECT 
    unique_id,
    phone_number,
    call_direction,
    jsonb_array_length(call_events) as events_count,
    jsonb_array_length(http_requests) as http_count,
    jsonb_array_length(sql_queries) as sql_count,
    telegram_messages,
    created_at
FROM call_traces 
WHERE enterprise_number = '0367' 
ORDER BY created_at DESC 
LIMIT 5;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å Telegram —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∑–≤–æ–Ω–∫–∞ (–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ chat_id)
SELECT 
    unique_id,
    phone_number,
    jsonb_pretty(telegram_messages) as telegram_msgs
FROM call_traces 
WHERE id = 454249;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –∫–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—É—á–∏–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫
SELECT 
    unique_id,
    phone_number,
    msg->>'chat_id' as chat_id,
    msg->>'message_type' as msg_type,
    msg->>'action' as action,
    msg->>'message_text' as text,
    msg->>'timestamp' as sent_at
FROM call_traces,
     jsonb_array_elements(telegram_messages) as msg
WHERE enterprise_number = '0367'
  AND msg->>'chat_id' = '374573193'
ORDER BY created_at DESC
LIMIT 10;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å HTTP –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∑–≤–æ–Ω–∫–∞
SELECT 
    unique_id,
    jsonb_pretty(http_requests) as http_reqs
FROM call_traces 
WHERE id = 454249;
```

#### –ß–µ—Ä–µ–∑ API Logger Service:

```bash
# –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π trace –∑–≤–æ–Ω–∫–∞
curl http://localhost:8026/trace/1762594822.0

# –ü–æ–∏—Å–∫ –∑–≤–æ–Ω–∫–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
curl "http://localhost:8026/search?enterprise_number=0367&phone=375296254070"
```

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∑–≤–æ–Ω–∫–∞** - –≤–∏–¥–∏–º –Ω–µ —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è Asterisk, –Ω–æ –∏ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã
2. **–û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º** - –º–æ–∂–µ–º –ø–æ–Ω—è—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –≤–æ–∑–Ω–∏–∫–ª–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞
3. **–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** - –≤–∏–¥–∏–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
4. **–ê—É–¥–∏—Ç Telegram** - –∑–Ω–∞–µ–º, –∫—Ç–æ –∏ –∫–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—É—á–∏–ª
5. **–ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π** - –≤–∏–¥–∏–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –≤–Ω–µ—à–Ω–∏–º —Å–∏—Å—Ç–µ–º–∞–º

### üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –º–µ—Ç–æ–¥—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è **–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ** - –∏—Å–ø–æ–ª—å–∑—É—é—Ç `background=True` –∏–ª–∏ `fire-and-forget`
- –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è **–Ω–µ –≤–ª–∏—è—é—Ç** –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–≤–æ–Ω–∫–∞
- –õ–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞—Ä—Ç–∏—Ü–∏—è—Ö –ø–æ `enterprise_number` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- JSONB –∏–Ω–¥–µ–∫—Å—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –ª—é–±—ã–º –ø–æ–ª—è–º

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 4.1 (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-11-08)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–∞—Ç—Ç–µ—Ä–Ω 1-1 –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ç–∞–π–º–∞—É—Ç–æ–º –Ω–∞ –í–°–ï–• —Å–æ–±—ã—Ç–∏—è—Ö  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Telegram, HTTP, SQL, Integrations)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–≤–æ–Ω–∫–∞—Ö  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏–º–µ–Ω–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ hangup  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ add_* –∏—â—É—Ç –∑–∞–ø–∏—Å–∏ –ø–æ unique_id –∏ related_unique_ids  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü—Ä–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è –≤—Å–µ JSONB –ø–æ–ª—è (call_events, telegram_messages, http_requests, sql_queries, integration_responses)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ chat_id —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–æ–∏—Å–∫ internal_phone –≤ call_events –¥–ª—è hangup —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üîß –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ logger.py (2025-11-18)

### üéØ –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- –°–µ—Ä–≤–∏—Å `logger.py` **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–∞–ª –≤—Å–µ 8 —è–¥–µ—Ä CPU** —Å–µ—Ä–≤–µ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ PostgreSQL –¥–æ—Å—Ç–∏–≥–∞–ª–∞ **334% CPU** (3.34 —è–¥—Ä–∞)
- –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ–π –ø—Ä–∏ –±–æ–ª—å—à–æ–º –ø–æ—Ç–æ–∫–µ –∑–≤–æ–Ω–∫–æ–≤
- CPU idle –ø–∞–¥–∞–ª –¥–æ **5-20%** (–≤–º–µ—Å—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö 70-90%)

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ:** 2025-11-18 –≤ –∫–æ–Ω—Ü–µ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–∞ logger.py

### üîç –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä–Ω–µ–≤—ã—Ö –ø—Ä–∏—á–∏–Ω

#### –ü—Ä–∏—á–∏–Ω–∞ #1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ DB —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –ö–ê–ñ–î–´–ô –∑–∞–ø—Ä–æ—Å

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# ‚ùå –ë–´–õ–û (–≤ –∫–∞–∂–¥–æ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ):
@app.post("/log/event")
async def log_call_event(event: CallEvent):
    conn = await asyncpg.connect(**DB_CONFIG)  # –ù–û–í–û–ï —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ!
    # ... —Ä–∞–±–æ—Ç–∞ —Å –ë–î ...
    await conn.close()
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü—Ä–∏ –ø–æ—Ç–æ–∫–µ 100 –∑–≤–æ–Ω–∫–æ–≤/–º–∏–Ω—É—Ç—É = **—Å–æ—Ç–Ω–∏** –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ PostgreSQL
- PostgreSQL —Ç—Ä–∞—Ç–∏–ª –æ–≥—Ä–æ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ö–∞–∂–¥–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ = fork –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ PostgreSQL = –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU

**–ì–¥–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ:**
- `/log/event` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤ (—Å–∞–º—ã–π —á–∞—Å—Ç—ã–π –∑–∞–ø—Ä–æ—Å)
- `/log/http` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- `/log/sql` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤
- `/log/telegram` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π
- `/log/integration` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- `/trace/{unique_id}` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–µ–π—Å–∞ –∑–≤–æ–Ω–∫–∞
- `/search` - –ø–æ–∏—Å–∫ –∑–≤–æ–Ω–∫–æ–≤
- `/enterprise/{enterprise_number}/partition` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏
- –ò –µ—â–µ 7 –¥—Ä—É–≥–∏—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

**–ò—Ç–æ–≥–æ:** 15 —Ñ—É–Ω–∫—Ü–∏–π —Å–æ–∑–¥–∞–≤–∞–ª–∏ –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å!

#### –ü—Ä–∏—á–∏–Ω–∞ #2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞ –ö–ê–ñ–î–´–ô –∑–∞–ø—Ä–æ—Å

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# ‚ùå –ë–´–õ–û:
@app.post("/log/event")
async def log_call_event(event: CallEvent):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä—Ç–∏—Ü–∏—é –í –ë–î –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å!
    await ensure_enterprise_partition(event.enterprise_number)
    # ... –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ...
```

**–§—É–Ω–∫—Ü–∏—è `ensure_enterprise_partition`:**
```python
async def ensure_enterprise_partition(enterprise_number: str):
    conn = await asyncpg.connect(**DB_CONFIG)  # –ï–©–Å –û–î–ù–û —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ!
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ë–î —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–∞—Ä—Ç–∏—Ü–∏—è
    check_query = "SELECT EXISTS (SELECT 1 FROM pg_tables WHERE tablename = $1)"
    exists = await conn.fetchval(check_query, partition_name)
    
    if not exists:
        # –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Ç–∏—Ü–∏—é
        create_query = f"CREATE TABLE \"{partition_name}\" PARTITION OF call_traces..."
        await conn.execute(create_query)
    
    await conn.close()
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–∞ –ö–ê–ñ–î–û–ï —Å–æ–±—ã—Ç–∏–µ –∑–≤–æ–Ω–∫–∞ = –∑–∞–ø—Ä–æ—Å –∫ `pg_tables` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä—Ç–∏—Ü–∏–∏
- –ü–∞—Ä—Ç–∏—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–≤–æ–Ω–∫–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
- –ù–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å **–Ω–∞ –∫–∞–∂–¥–æ–º** —Å–æ–±—ã—Ç–∏–∏ (—Ç—ã—Å—è—á–∏ —Ä–∞–∑!)
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ PostgreSQL

#### –ü—Ä–∏—á–∏–Ω–∞ #3: –û—à–∏–±–∫–∏ `duplicate key violates unique constraint` –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö –ë–î

**–ü—Ä–æ–±–ª–µ–º–∞:**
–§—É–Ω–∫—Ü–∏–∏ PostgreSQL (`add_call_event`, `add_http_request`, `add_sql_query`, `add_telegram_message`, `add_integration_response`) –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏ race condition.

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
–í—Ä–µ–º—è T1: –ó–∞–ø—Ä–æ—Å #1 —Å unique_id="123" ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î ‚Üí –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç ‚Üí –Ω–∞—á–∏–Ω–∞–µ—Ç INSERT
–í—Ä–µ–º—è T2: –ó–∞–ø—Ä–æ—Å #2 —Å unique_id="123" ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ë–î ‚Üí –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç ‚Üí –Ω–∞—á–∏–Ω–∞–µ—Ç INSERT
–í—Ä–µ–º—è T3: –ó–∞–ø—Ä–æ—Å #1 ‚Üí INSERT —É—Å–ø–µ—à–µ–Ω
–í—Ä–µ–º—è T4: –ó–∞–ø—Ä–æ—Å #2 ‚Üí INSERT ‚Üí ERROR: duplicate key violates unique constraint
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- PostgreSQL –æ—Ç–∫–∞—Ç—ã–≤–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—è–ª–æ –ø–æ–ø—ã—Ç–∫—É
- –°–Ω–æ–≤–∞ –æ—à–∏–±–∫–∞ ‚Üí —Å–Ω–æ–≤–∞ –æ—Ç–∫–∞—Ç
- **CPU 334%** –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫ –∏ –æ—Ç–∫–∞—Ç–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–ì–¥–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ:**
–õ–æ–≥–∏ `logger.py`:
```
2025-11-18 13:43:42 [ERROR] Error logging event: duplicate key value violates unique constraint "unique_call_trace_0351"
DETAIL: Key (unique_id, enterprise_number)=(1763473585.8825, 0351) already exists.
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ #1: Connection Pool

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ì–ª–æ–±–∞–ª—å–Ω—ã–π connection pool
from asyncpg import Pool

db_pool: Optional[Pool] = None

async def init_db_pool():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è connection pool –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞"""
    global db_pool
    if db_pool is None:
        db_pool = await asyncpg.create_pool(
            **DB_CONFIG,
            min_size=5,      # –ú–∏–Ω–∏–º—É–º 5 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç—ã
            max_size=20,     # –ú–∞–∫—Å–∏–º—É–º 20 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
            command_timeout=60
        )
        logger.info("‚úÖ Database connection pool initialized (5-20 connections)")
    return db_pool

async def close_db_pool():
    """–ó–∞–∫—Ä—ã—Ç–∏–µ connection pool –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–∏—Å–∞"""
    global db_pool
    if db_pool:
        await db_pool.close()
        db_pool = None
        logger.info("‚úÖ Database connection pool closed")

@app.on_event("startup")
async def startup_event():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"""
    await init_db_pool()
    await load_existing_partitions()

@app.on_event("shutdown")
async def shutdown_event():
    """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ"""
    await close_db_pool()
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö:**

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º pool –≤–º–µ—Å—Ç–æ –Ω–æ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
@app.post("/log/event")
async def log_call_event(event: CallEvent):
    async with db_pool.acquire() as conn:  # –ë–µ—Ä—ë–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–∑ –ø—É–ª–∞
        # ... —Ä–∞–±–æ—Ç–∞ —Å –ë–î ...
        # –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑** –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- PostgreSQL –Ω–µ —Ç—Ä–∞—Ç–∏—Ç —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ (5-20), –∞ –Ω–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ

**–ò–∑–º–µ–Ω–µ–Ω–æ:** 15 —Ñ—É–Ω–∫—Ü–∏–π –≤ `logger.py`

### ‚úÖ –†–µ—à–µ–Ω–∏–µ #2: –ö—ç—à –ø–∞—Ä—Ç–∏—Ü–∏–π –≤ –ø–∞–º—è—Ç–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ö—ç—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π –≤ –ø–∞–º—è—Ç–∏
partition_cache = set()

async def load_existing_partitions():
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π –≤ –∫—ç—à –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ"""
    global partition_cache
    try:
        async with db_pool.acquire() as conn:
            query = """
            SELECT tablename FROM pg_tables 
            WHERE schemaname = 'public' 
            AND tablename ~ '^[0-9]{4}$'
            """
            rows = await conn.fetch(query)
            partition_cache = {row['tablename'] for row in rows}
            logger.info(f"‚úÖ Loaded {len(partition_cache)} existing partitions into cache")
    except Exception as e:
        logger.error(f"‚ùå Error loading partitions into cache: {e}")

async def ensure_enterprise_partition(enterprise_number: str):
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏—é –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç (—Å –∫—ç—à–µ–º)"""
    global partition_cache
    
    # ‚úÖ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫—ç—à–µ (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î!)
    if enterprise_number in partition_cache:
        return True
    
    # –ü–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–µ—Ç –≤ –∫—ç—à–µ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ë–î –∏ —Å–æ–∑–¥–∞—ë–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    async with db_pool.acquire() as conn:
        # ... –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ ...
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫—ç—à —á—Ç–æ–±—ã –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å
        partition_cache.add(enterprise_number)
        return True
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä—Ç–∏—Ü–∏–∏ = **O(1)** –æ–ø–µ—Ä–∞—Ü–∏—è –≤ –ø–∞–º—è—Ç–∏ (set lookup)
- –ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ PostgreSQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
- –ó–∞–ø—Ä–æ—Å –∫ –ë–î —Ç–æ–ª—å–∫–æ **–æ–¥–∏–Ω —Ä–∞–∑** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–±—ã—Ç–∏–∏ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è

### ‚úÖ –†–µ—à–µ–Ω–∏–µ #3: –û–±—Ä–∞–±–æ—Ç–∫–∞ `unique_violation` –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö –ë–î

**–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏:**

PostgreSQL 14 –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `ON CONFLICT` –Ω–∞ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –Ω–∞–ø—Ä—è–º—É—é:
```sql
-- ‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢:
INSERT INTO call_traces (...) VALUES (...)
ON CONFLICT (unique_id, enterprise_number) DO NOTHING;

-- ERROR: there is no unique or exclusion constraint matching the ON CONFLICT specification
```

**–†–µ—à–µ–Ω–∏–µ: BEGIN...EXCEPTION –±–ª–æ–∫**

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ø—Ä–∏–º–µ—Ä –¥–ª—è `add_call_event`):**

```sql
CREATE OR REPLACE FUNCTION add_call_event(
    p_unique_id VARCHAR,
    p_enterprise_number VARCHAR,
    p_event_type VARCHAR,
    p_event_data JSONB,
    p_phone_number VARCHAR DEFAULT NULL,
    p_bridge_unique_id VARCHAR DEFAULT NULL
) RETURNS BIGINT AS $$
DECLARE
    v_trace_id BIGINT;
BEGIN
    -- –®–∞–≥ 1: –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
    SELECT id INTO v_trace_id
    FROM call_traces
    WHERE unique_id = COALESCE(p_unique_id, p_bridge_unique_id)
      AND enterprise_number = p_enterprise_number
    LIMIT 1;
    
    IF v_trace_id IS NOT NULL THEN
        -- –ó–∞–ø–∏—Å—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ
        UPDATE call_traces SET
            call_events = call_events || jsonb_build_array(...),
            updated_at = NOW()
        WHERE id = v_trace_id;
    ELSE
        -- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ü–ï–†–ï–î INSERT
        SELECT id INTO v_trace_id
        FROM call_traces
        WHERE unique_id = COALESCE(p_unique_id, p_bridge_unique_id)
          AND enterprise_number = p_enterprise_number
        LIMIT 1;
        
        -- –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –≤—Å—ë –µ—â—ë –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ - —Å–æ–∑–¥–∞—ë–º
        IF v_trace_id IS NULL THEN
            BEGIN
                INSERT INTO call_traces (...) VALUES (...)
                RETURNING id INTO v_trace_id;
            EXCEPTION
                WHEN unique_violation THEN
                    -- ‚úÖ Race condition - –Ω–∞—Ö–æ–¥–∏–º –∑–∞–ø–∏—Å—å
                    SELECT id INTO v_trace_id
                    FROM call_traces
                    WHERE unique_id = COALESCE(p_unique_id, p_bridge_unique_id)
                      AND enterprise_number = p_enterprise_number
                    LIMIT 1;
            END;
        END IF;
    END IF;

    RETURN v_trace_id;
END;
$$ LANGUAGE plpgsql;
```

**–õ–æ–≥–∏–∫–∞:**
1. –°–Ω–∞—á–∞–ª–∞ **–ø—Ä–æ–≤–µ—Ä—è–µ–º** —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (SELECT)
2. –ï—Å–ª–∏ –Ω–∞—à–ª–∏ - –æ–±–Ω–æ–≤–ª—è–µ–º (UPDATE)
3. –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - **–ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—â—ë —Ä–∞–∑** (–∑–∞—â–∏—Ç–∞ –æ—Ç race condition)
4. –ü—ã—Ç–∞–µ–º—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å (INSERT)
5. –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ `unique_violation` - **–Ω–∞—Ö–æ–¥–∏–º** —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å –∏ —Ä–∞–±–æ—Ç–∞–µ–º —Å –Ω–µ–π

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –î—É–±–ª–∏–∫–∞—Ç—ã **–ù–ï –≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–æ–∫**
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ **–ù–ï –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è**
- PostgreSQL **–ù–ï —Ç—Ä–∞—Ç–∏—Ç** CPU –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 5 —Ñ—É–Ω–∫—Ü–∏–π PostgreSQL
- `add_call_event` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–∞
- `add_http_request` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- `add_sql_query` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤
- `add_telegram_message` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π (+ COALESCE –¥–ª—è NULL –º–∞—Å—Å–∏–≤–æ–≤)
- `add_integration_response` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

**–§–∞–π–ª —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏:** `/root/asterisk-webhook/fix_logger_db_functions_v2.sql`

### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–ú–µ—Ç—Ä–∏–∫–∏ –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
CPU Idle:           5-20%
PostgreSQL CPU:     100-334% (3+ —è–¥—Ä–∞)
–ë–î —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:      –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ, –ø–∏–∫–∏ –¥–æ 100+
–û—à–∏–±–∫–∏ duplicate:   –ü–æ—Å—Ç–æ—è–Ω–Ω–æ
Load Average:       4.5-5.0
```

**–ú–µ—Ç—Ä–∏–∫–∏ –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
CPU Idle:           90-93% ‚úÖ (+73%)
PostgreSQL CPU:     0-12% ‚úÖ (-322%)
–ë–î —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:      37 idle, 1-3 active ‚úÖ (—Å—Ç–∞–±–∏–ª—å–Ω–æ)
–û—à–∏–±–∫–∏ duplicate:   0 ‚úÖ (–ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã)
Load Average:       2.7-3.2 ‚úÖ (-40%)
```

**–¢–µ—Å—Ç: 3 –º–∏–Ω—É—Ç—ã –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π**
- –û—à–∏–±–æ–∫ `duplicate`: **0**
- –û—à–∏–±–æ–∫ 500: **118** (—Ç–æ–ª—å–∫–æ `cannot get array length` –≤ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å—è—Ö - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- CPU idle: **93%** (–±—ã–ª–æ 5-20%)
- PostgreSQL –ø—Ä–æ—Ü–µ—Å—Å—ã: **0-12% CPU** (–±—ã–ª–æ 100-334%)

### üîß –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

#### 1. `/root/asterisk-webhook/logger.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
# Connection pool (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
db_pool: Optional[asyncpg.Pool] = None

# –ö—ç—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π (–≤ –ø–∞–º—è—Ç–∏)
partition_cache = set()

async def init_db_pool(): ...
async def close_db_pool(): ...
async def load_existing_partitions(): ...

@app.on_event("startup")
async def startup_event(): ...

@app.on_event("shutdown")
async def shutdown_event(): ...
```

**–ò–∑–º–µ–Ω–µ–Ω–æ (15 —Ñ—É–Ω–∫—Ü–∏–π):**
- `log_call_event` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `log_http_request` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `log_sql_query` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `log_telegram_message` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `log_integration_response` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `get_call_trace` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `search_traces` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `create_enterprise_partition_api` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `drop_enterprise_partition_api` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `list_enterprise_partitions` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `force_drop_partition` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `get_partition_stats` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `get_call_details_web` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`
- `ensure_enterprise_partition` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `partition_cache` + `db_pool.acquire()`
- `load_existing_partitions` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `db_pool.acquire()`

**–ü–∞—Ç—Ç–µ—Ä–Ω –∑–∞–º–µ–Ω—ã:**
```python
# ‚ùå –ë–´–õ–û:
conn = await asyncpg.connect(**DB_CONFIG)
# ... —Ä–∞–±–æ—Ç–∞ ...
await conn.close()

# ‚úÖ –°–¢–ê–õ–û:
async with db_pool.acquire() as conn:
    # ... —Ä–∞–±–æ—Ç–∞ ...
    # –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª
```

#### 2. `/root/asterisk-webhook/fix_logger_db_functions_v2.sql`

**–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ 5 —Ñ—É–Ω–∫—Ü–∏–π PostgreSQL:**

```sql
-- 1. add_call_event - –æ–±—Ä–∞–±–æ—Ç–∫–∞ unique_violation + –ø—Ä–æ–≤–µ—Ä–∫–∞ EXISTS
-- 2. add_http_request - –æ–±—Ä–∞–±–æ—Ç–∫–∞ unique_violation + –ø—Ä–æ–≤–µ—Ä–∫–∞ EXISTS
-- 3. add_sql_query - –æ–±—Ä–∞–±–æ—Ç–∫–∞ unique_violation + –ø—Ä–æ–≤–µ—Ä–∫–∞ EXISTS
-- 4. add_telegram_message - –æ–±—Ä–∞–±–æ—Ç–∫–∞ unique_violation + COALESCE –¥–ª—è NULL
-- 5. add_integration_response - –æ–±—Ä–∞–±–æ—Ç–∫–∞ unique_violation + –ø—Ä–æ–≤–µ—Ä–∫–∞ EXISTS
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```bash
PGPASSWORD='r/Yskqh/ZbZuvjb2b3ahfg==' psql -U postgres -d postgres -f fix_logger_db_functions_v2.sql
```

### üìã –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Connection Pool

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ:**
```
1. –°–æ–∑–¥–∞—ë—Ç—Å—è –ø—É–ª –∏–∑ 5 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (min_size=5)
2. –í—Å–µ 5 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ
3. –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –≤ –∫—ç—à
```

**–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞:**
```
1. –≠–Ω–¥–ø–æ–∏–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: db_pool.acquire()
2. –ü—É–ª –≤—ã–¥–∞—ë—Ç —Å–≤–æ–±–æ–¥–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ –µ—Å–ª–∏ –≤—Å–µ –∑–∞–Ω—è—Ç—ã, –¥–æ max_size=20)
3. –≠–Ω–¥–ø–æ–∏–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ë–î
4. –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª (context manager)
5. –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
```

**–ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–∏—Å–∞:**
```
1. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è shutdown_event()
2. –ó–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –ø—É–ª–µ
3. –û—á–∏—â–∞–µ—Ç—Å—è –∫—ç—à –ø–∞—Ä—Ç–∏—Ü–∏–π
```

### üìã –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—ç—à –ø–∞—Ä—Ç–∏—Ü–∏–π

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ:**
```python
partition_cache = set()  # –ü—É—Å—Ç–æ–π set

# –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
await load_existing_partitions()
# partition_cache = {'0367', '0280', '0351', ...}  # 78 –ø–∞—Ä—Ç–∏—Ü–∏–π
```

**–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏—è:**
```python
# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ø–∞–º—è—Ç–∏ (O(1))
if '0367' in partition_cache:
    return True  # –ü–∞—Ä—Ç–∏—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º

# –ï—Å–ª–∏ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–µ—Ç –≤ –∫—ç—à–µ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ë–î
async with db_pool.acquire() as conn:
    exists = await conn.fetchval("SELECT EXISTS (...)")
    if not exists:
        # –°–æ–∑–¥–∞—ë–º –ø–∞—Ä—Ç–∏—Ü–∏—é
        await conn.execute("CREATE TABLE ...")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫—ç—à
    partition_cache.add('0367')
```

### üéØ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**
   - Connection pool –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
   - –ö—ç—à –ø–∞—Ä—Ç–∏—Ü–∏–π –≤–º–µ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

2. **Graceful degradation**
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ race conditions —á–µ—Ä–µ–∑ EXCEPTION
   - –ù–µ –ø–∞–¥–∞–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö, –∞ –Ω–∞—Ö–æ–¥–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å

3. **Fail-safe**
   - –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ù–ï –≤–ª–∏—è—é—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
   - COALESCE –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç NULL –≤ JSONB –º–∞—Å—Å–∏–≤–∞—Ö

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—É–ª–∞
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—Ç–∏—Ü–∏–π
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

**–û—à–∏–±–∫–∞ `cannot get array length of a non-array`:**
- –í–æ–∑–Ω–∏–∫–∞–µ—Ç –≤ `add_telegram_message` –¥–ª—è **—Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π**
- –ü—Ä–∏—á–∏–Ω–∞: –ø–æ–ª–µ `telegram_messages` –º–æ–∂–µ—Ç –±—ã—Ç—å NULL –≤ –∑–∞–ø–∏—Å—è—Ö, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è COALESCE
- **–ù–ï –∫—Ä–∏—Ç–∏—á–Ω–æ**: –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–∞–≥—Ä—É–∑–∫—É, –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ `COALESCE(telegram_messages, '[]'::jsonb)`

### üìù –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞ (2025-11-19)

**–£—Ç—Ä–æ–º, –∫–æ–≥–¥–∞ –Ω–∞—á–Ω—ë—Ç—Å—è –±–æ–ª—å—à–æ–π –ø–æ—Ç–æ–∫ –∑–≤–æ–Ω–∫–æ–≤:**

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É CPU:**
   ```bash
   top -bn1 | head -15
   # –û–∂–∏–¥–∞–µ–º: CPU idle 70-90%, PostgreSQL CPU 10-30%
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:**
   ```bash
   tail -500 /tmp/logger_output.log | grep -i "duplicate\|error"
   # –û–∂–∏–¥–∞–µ–º: 0 –æ—à–∏–±–æ–∫ duplicate
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ë–î —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:**
   ```bash
   PGPASSWORD='...' psql -U postgres -d postgres -c "SELECT count(*), state FROM pg_stat_activity WHERE datname = 'postgres' GROUP BY state;"
   # –û–∂–∏–¥–∞–µ–º: 5-20 idle, 1-5 active (—Å—Ç–∞–±–∏–ª—å–Ω–æ)
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Load Average:**
   ```bash
   uptime
   # –û–∂–∏–¥–∞–µ–º: load average < 4.0
   ```

**–ï—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ –°–¥–µ–ª–∞—Ç—å –∫–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- ‚úÖ –ó–∞–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É

**–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å:**
- ‚ùå –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∞–Ω–∞–ª–∏–∑
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
- ‚ùå –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

**1. Connection Pool –∞–∫—Ç–∏–≤–µ–Ω:**
```bash
# –í –ª–æ–≥–∞—Ö logger –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
tail /tmp/logger_output.log | grep "connection pool"
# ‚úÖ Database connection pool initialized (5-20 connections)
```

**2. –ö—ç—à –ø–∞—Ä—Ç–∏—Ü–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω:**
```bash
# –í –ª–æ–≥–∞—Ö logger –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
tail /tmp/logger_output.log | grep "partitions into cache"
# ‚úÖ Loaded 78 existing partitions into cache
```

**3. –ù–µ—Ç –æ—à–∏–±–æ–∫ duplicate:**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤:
tail -1000 /tmp/logger_output.log | grep -i "duplicate" | wc -l
# ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
```

**4. PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç connection pool:**
```bash
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–º:
watch -n 5 'PGPASSWORD="..." psql -U postgres -d postgres -c "SELECT count(*), state FROM pg_stat_activity WHERE datname = '\''postgres'\'' GROUP BY state;"'
# ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å ~5-20 idle, ~1-5 active (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è —Ä–µ–∑–∫–æ)
```

### üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è asyncpg connection pool:**
- https://magicstack.github.io/asyncpg/current/api/index.html#connection-pools

**PostgreSQL –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- https://www.postgresql.org/docs/14/ddl-partitioning.html

**PostgreSQL –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ PL/pgSQL:**
- https://www.postgresql.org/docs/14/plpgsql-control-structures.html#PLPGSQL-ERROR-TRAPPING

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 4.2 (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-11-18)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ Connection Pool —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ö—ç—à –ø–∞—Ä—Ç–∏—Ü–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ unique_violation —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –¥–ª—è –≤—Å–µ—Ö 5 —Ñ—É–Ω–∫—Ü–∏–π –ë–î  
**–°—Ç–∞—Ç—É—Å**: ‚è≥ –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ 2025-11-19  
**–ê–≤—Ç–æ—Ä**: Call Logger Service Team

---

## üß™ –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø LOGGER (2025-11-29)

### üéØ –¶–µ–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã Logger Service –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–≤–æ–Ω–∫–∞—Ö —Å –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º.

### üîß –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ç–µ–Ω–¥

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| **–¢–µ—Å—Ç–æ–≤—ã–π —é–Ω–∏—Ç** | 0367 |
| **IP —Ö–æ—Å—Ç–∞** | 10.88.10.19 |
| **SSH –ø–æ—Ä—Ç** | 5059 |
| **SSH –ª–æ–≥–∏–Ω** | root |
| **SSH –ø–∞—Ä–æ–ª—å** | 5atx9Ate@pbx |
| **–ö–∞—Ç–∞–ª–æ–≥ –ª–æ–≥–æ–≤ –Ω–∞ —Ö–æ—Å—Ç–µ** | `/var/log/asterisk/` |
| **–§–∞–π–ª –ª–æ–≥–æ–≤ –Ω–∞ —Ö–æ—Å—Ç–µ** | `/var/log/asterisk/db` |
| **–°–µ—Ä–≤–∏—Å –Ω–∞ —Ö–æ—Å—Ç–µ** | `listen_AMI_python.service` |

### ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û

**–ü—Ä–∏ –º–∞–ª–µ–π—à–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º –∏–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ö–æ—Å—Ç—É ‚Äî –ù–ï–ú–ï–î–õ–ï–ù–ù–û —Å–æ–æ–±—â–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Cursor!**

### üìã –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ—à–∞–≥–æ–≤–æ)

#### –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ —Ö–æ—Å—Ç–µ Asterisk

```bash
# 1.1 –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Ö–æ—Å—Ç—É
ssh -p 5059 root@10.88.10.19
# –ü–∞—Ä–æ–ª—å: 5atx9Ate@pbx

# 1.2 –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª db —Å –ª–æ–≥–∞–º–∏
rm -f /var/log/asterisk/db

# 1.3 –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å (—Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª db)
systemctl restart listen_AMI_python.service

# 1.4 –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏ –ø—É—Å—Ç–æ–π
ls -la /var/log/asterisk/db
cat /var/log/asterisk/db
# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
```

#### –®–∞–≥ 2: –û—á–∏—Å—Ç–∫–∞ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –≤ PostgreSQL

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å Logger (–ª–æ–∫–∞–ª—å–Ω–æ)
cd /root/asterisk-webhook
./deletelogs.sh 0367
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: N
‚úÖ –ü–∞—Ä—Ç–∏—Ü–∏—è "0367" –æ—á–∏—â–µ–Ω–∞
```

#### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ —Ç–µ—Å—Ç—É

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Logger –∑–∞–ø—É—â–µ–Ω
curl http://localhost:8026/health

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞—Ä—Ç–∏—Ü–∏—è –ø—É—Å—Ç–∞
PGPASSWORD='r/Yskqh/ZbZuvjb2b3ahfg==' psql -h localhost -U postgres -d postgres -c "SELECT COUNT(*) FROM \"0367\";"
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
```

#### –®–∞–≥ 4: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞

–°–æ–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ –Ω–∞/—Å —é–Ω–∏—Ç–∞ 0367.

#### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```bash
# 5.1 –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ —Ö–æ—Å—Ç–µ Asterisk
ssh -p 5059 root@10.88.10.19 "cat /var/log/asterisk/db"

# 5.2 –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–∏—Å–∏ –≤ PostgreSQL
PGPASSWORD='r/Yskqh/ZbZuvjb2b3ahfg==' psql -h localhost -U postgres -d postgres -c "
SELECT 
    id,
    unique_id,
    phone_number,
    call_direction,
    call_status,
    jsonb_array_length(call_events) as events,
    jsonb_array_length(COALESCE(telegram_messages, '[]'::jsonb)) as telegram_msgs,
    created_at
FROM \"0367\"
ORDER BY created_at DESC
LIMIT 5;
"

# 5.3 –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏
PGPASSWORD='r/Yskqh/ZbZuvjb2b3ahfg==' psql -h localhost -U postgres -d postgres -c "
SELECT 
    jsonb_pretty(call_events) as events,
    jsonb_pretty(telegram_messages) as telegram
FROM \"0367\"
ORDER BY created_at DESC
LIMIT 1;
"
```

### üîÑ –ú–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏—è deletelogs.sh (TODO)

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:** –†–∞—Å—à–∏—Ä–∏—Ç—å —Å–∫—Ä–∏–ø—Ç `deletelogs.sh` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤ –Ω–∞ —Ö–æ—Å—Ç–µ Asterisk.

**–ù–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
1. –û—á–∏—Å—Ç–∫–∞ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –≤ PostgreSQL (—Ç–µ–∫—É—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
2. SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ö–æ—Å—Ç—É Asterisk
3. –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ `/var/log/asterisk/db`
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ `listen_AMI_python.service`
5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏–∏:**
```bash
./deletelogs.sh 0367
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
# 1. –û—á–∏—Å—Ç–∏—Ç –ø–∞—Ä—Ç–∏—Ü–∏—é 0367 –≤ PostgreSQL
# 2. –ü–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∫ —Ö–æ—Å—Ç—É 10.88.10.19
# 3. –£–¥–∞–ª–∏—Ç /var/log/asterisk/db
# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç listen_AMI_python.service
# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
```

**–¢—Ä–µ–±—É–µ—Ç—Å—è:** –ú–∞–ø–ø–∏–Ω–≥ enterprise_number ‚Üí IP —Ö–æ—Å—Ç–∞ (—Ç–∞–±–ª–∏—Ü–∞ `units` –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª)

### üìä –ß–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

| # | –ü—Ä–æ–≤–µ—Ä–∫–∞ | –ö–æ–º–∞–Ω–¥–∞/–î–µ–π—Å—Ç–≤–∏–µ | –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |
|---|----------|------------------|---------------------|
| 1 | SSH –¥–æ—Å—Ç—É–ø –∫ —Ö–æ—Å—Ç—É | `ssh -p 5059 root@10.88.10.19` | –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ |
| 2 | –£–¥–∞–ª–µ–Ω–∏–µ db —Ñ–∞–π–ª–∞ | `rm -f /var/log/asterisk/db` | –§–∞–π–ª —É–¥–∞–ª—ë–Ω |
| 3 | –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ | `systemctl restart listen_AMI_python.service` | –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω |
| 4 | –ù–æ–≤—ã–π db —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω | `ls -la /var/log/asterisk/db` | –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç |
| 5 | –ü–∞—Ä—Ç–∏—Ü–∏—è –æ—á–∏—â–µ–Ω–∞ | `./deletelogs.sh 0367` | 0 –∑–∞–ø–∏—Å–µ–π |
| 6 | Logger –∑–∞–ø—É—â–µ–Ω | `curl localhost:8026/health` | `{"status": "healthy"}` |
| 7 | –¢–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ | –ü–æ–∑–≤–æ–Ω–∏—Ç—å –Ω–∞/—Å —é–Ω–∏—Ç–∞ | –ó–≤–æ–Ω–æ–∫ —Å–æ—Å—Ç–æ—è–ª—Å—è |
| 8 | –°–æ–±—ã—Ç–∏—è –≤ db —Ñ–∞–π–ª–µ | `cat /var/log/asterisk/db` | –°–æ–±—ã—Ç–∏—è –∑–∞–ø–∏—Å–∞–Ω—ã |
| 9 | –ó–∞–ø–∏—Å–∏ –≤ PostgreSQL | `SELECT COUNT(*) FROM "0367"` | ‚â•1 –∑–∞–ø–∏—Å—å |
| 10 | Telegram —Å–æ–æ–±—â–µ–Ω–∏—è | –ü—Ä–æ–≤–µ—Ä–∫–∞ `telegram_messages` | –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–ø–∏—Å–∞–Ω—ã |

### üö® –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|---------|
| –¢–µ—Ä–º–∏–Ω–∞–ª –∑–∞–≤–∏—Å | –ü—Ä–æ–±–ª–µ–º–∞ —Å SSH | –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å Cursor |
| `Connection refused` | –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω | `systemctl start listen_AMI_python.service` |
| –ü—É—Å—Ç–∞—è –ø–∞—Ä—Ç–∏—Ü–∏—è –ø–æ—Å–ª–µ –∑–≤–æ–Ω–∫–∞ | Logger –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `./logger.sh status` |
| `telegram_messages` –ø—É—Å—Ç–æ–π | –û—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ë–î | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Logger |
| `duplicate key` –æ—à–∏–±–∫–∏ | Race condition | –ü—Ä–∏–º–µ–Ω–∏—Ç—å `fix_logger_db_functions_v2.sql` |

---

**–í–µ—Ä—Å–∏—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏**: 1.0 (—Å–æ–∑–¥–∞–Ω–æ 2025-11-29)
