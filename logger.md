# üìä Call Logger Service - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞.

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- **–ü–æ—Ä—Ç**: 8026
- **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: FastAPI, Pydantic, PostgreSQL, asyncpg
- **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö**: JSON
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤ PostgreSQL —Å JSONB
- **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: LIST –ø–æ –Ω–æ–º–µ—Ä–∞–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π

## üìã –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤
- **Dial —Å–æ–±—ã—Ç–∏—è** - –Ω–∞—á–∞–ª–æ –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤
- **Bridge —Å–æ–±—ã—Ç–∏—è** - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- **Hangup —Å–æ–±—ã—Ç–∏—è** - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤
- **–î—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è** - –Ω–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã, –ø–µ—Ä–µ–≤–æ–¥—ã –∏ —Ç.–¥.

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- –ó–∞–ø—Ä–æ—Å—ã –∫ —Å–µ—Ä–≤–∏—Å—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (8020)
- –ó–∞–ø—Ä–æ—Å—ã –∫ –≤–Ω–µ—à–Ω–∏–º API (MoySklad, RetailCRM)
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Å—Ç–∞—Ç—É—Å –∫–æ–¥—ã
- –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–π
- –ó–∞–ø—Ä–æ—Å—ã –∫ PostgreSQL
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –æ–ø–µ—Ä–∞—Ü–∏–π
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- ID —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —á–∞—Ç–æ–≤

## üåê API Endpoints

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### `GET /`
–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Ä–≤–∏—Å–µ

#### `POST /log/event`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "event_type": "dial",
  "event_data": {
    "Phone": "375296254070",
    "Extensions": ["150"],
    "Trunk": "0001363",
    "CallType": 1
  }
}
```

#### `POST /log/http`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "method": "GET",
  "url": "http://localhost:8020/metadata/0367/manager/150",
  "response_data": {
    "full_name": "–î–∂—É–Ω–æ–≤—ã–π –î–∂—É–ª–∞–π",
    "internal_phone": "150"
  },
  "status_code": 200,
  "duration_ms": 245.3
}
```

#### `POST /log/sql`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "query": "SELECT raw_data->'ConnectedLineNum' FROM call_events WHERE raw_data->>'Token' = $1",
  "parameters": ["375293332255"],
  "result": {"internal_num": "150"},
  "duration_ms": 12.5
}
```

#### `POST /log/telegram`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –æ–ø–µ—Ä–∞—Ü–∏–∏
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "chat_id": 7055556176,
  "message_type": "dial",
  "message_id": 13165,
  "message_text": "üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...",
  "action": "send"
}
```

#### `GET /trace/{unique_id}`
–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–∞ –∑–≤–æ–Ω–∫–∞
```json
{
  "unique_id": "1759490248.0",
  "enterprise_number": "0367",
  "created_at": "2025-10-03T11:29:13",
  "updated_at": "2025-10-03T11:29:47",
  "timeline": [
    {
      "type": "call_event",
      "timestamp": "2025-10-03T11:29:13",
      "data": {
        "event_type": "dial",
        "event_data": {...}
      }
    },
    {
      "type": "http_request",
      "timestamp": "2025-10-03T11:29:14",
      "data": {
        "method": "GET",
        "url": "...",
        "duration_ms": 245.3
      }
    }
  ],
  "summary": {
    "total_events": 3,
    "http_requests": 5,
    "sql_queries": 2,
    "telegram_messages": 2
  }
}
```

#### `GET /search`
–ü–æ–∏—Å–∫ —Ç—Ä–µ–π—Å–æ–≤ –∑–≤–æ–Ω–∫–æ–≤
```
GET /search?enterprise=0367&phone=375296254070&limit=10
```

#### `GET /health`
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞

## üóÑÔ∏è –î–∏–∑–∞–π–Ω –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `call_traces`

–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞ —Å JSONB –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ:

```sql
CREATE TABLE call_traces (
    id BIGSERIAL,
    unique_id VARCHAR(50) NOT NULL,
    enterprise_number VARCHAR(10) NOT NULL,
    phone_number VARCHAR(20),
    call_direction VARCHAR(10),
    call_status VARCHAR(20) DEFAULT 'active',
    start_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    end_time TIMESTAMP WITH TIME ZONE,
    call_events JSONB DEFAULT '[]'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
) PARTITION BY LIST (enterprise_number);
```

### –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**LIST –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –Ω–æ–º–µ—Ä–∞–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π** - –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –≤ —Å–≤–æ–µ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏:

```sql
-- –ü–∞—Ä—Ç–∏—Ü–∏–∏ —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ (—Ç–æ–ª—å–∫–æ 4 —Ü–∏—Ñ—Ä—ã)
CREATE TABLE "0367" PARTITION OF call_traces FOR VALUES IN ('0367');
CREATE TABLE "0280" PARTITION OF call_traces FOR VALUES IN ('0280');
CREATE TABLE "0368" PARTITION OF call_traces FOR VALUES IN ('0368');
CREATE TABLE "0286" PARTITION OF call_traces FOR VALUES IN ('0286');
-- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è...
```

### –ò–Ω–¥–µ–∫—Å—ã

```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_call_traces_unique_id ON call_traces (unique_id);
CREATE INDEX idx_call_traces_enterprise ON call_traces (enterprise_number);
CREATE INDEX idx_call_traces_start_time ON call_traces (start_time);
CREATE INDEX idx_call_traces_call_events ON call_traces USING GIN (call_events);
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

```sql
-- UNIQUE constraint –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏
ALTER TABLE "0367" ADD CONSTRAINT unique_call_trace_0367 UNIQUE (unique_id, enterprise_number);
ALTER TABLE "0280" ADD CONSTRAINT unique_call_trace_0280 UNIQUE (unique_id, enterprise_number);
-- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...
```

### –§—É–Ω–∫—Ü–∏–∏ –ë–î

#### `add_call_event` - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è

```sql
CREATE OR REPLACE FUNCTION add_call_event(
    p_unique_id VARCHAR(50),
    p_enterprise_number VARCHAR(10),
    p_event_type VARCHAR(30),
    p_event_data JSONB,
    p_phone_number VARCHAR(20) DEFAULT NULL
)
RETURNS BIGINT AS $$
DECLARE
    v_trace_id BIGINT;
    v_call_direction VARCHAR(10);
    v_call_status VARCHAR(20);
BEGIN
    -- –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞
    IF p_event_type IN ('start', 'dial') THEN
        v_call_direction := 'outgoing';
        v_call_status := 'active';
    ELSIF p_event_type = 'hangup' THEN
        v_call_status := 'completed';
    END IF;

    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
    SELECT id INTO v_trace_id 
    FROM call_traces 
    WHERE unique_id = p_unique_id AND enterprise_number = p_enterprise_number;
    
    IF v_trace_id IS NOT NULL THEN
        -- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        UPDATE call_traces SET
            call_events = call_events || jsonb_build_object(
                'event_sequence', jsonb_array_length(call_events) + 1,
                'event_type', p_event_type,
                'event_timestamp', NOW(),
                'event_data', p_event_data
            ),
            updated_at = NOW()
        WHERE id = v_trace_id;
    ELSE
        -- –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        INSERT INTO call_traces (unique_id, enterprise_number, phone_number, call_direction, call_status, call_events)
        VALUES (p_unique_id, p_enterprise_number, p_phone_number, v_call_direction, v_call_status, 
                jsonb_build_array(jsonb_build_object(
                    'event_sequence', 1,
                    'event_type', p_event_type,
                    'event_timestamp', NOW(),
                    'event_data', p_event_data
                )))
        RETURNING id INTO v_trace_id;
    END IF;

    RETURN v_trace_id;
END;
$$ LANGUAGE plpgsql;
```

#### `get_call_events` - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∏–∑ JSONB

```sql
CREATE OR REPLACE FUNCTION get_call_events(p_unique_id VARCHAR(50))
RETURNS TABLE (
    event_sequence INTEGER,
    event_type VARCHAR(30),
    event_timestamp TIMESTAMP WITH TIME ZONE,
    event_data JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        (event->>'event_sequence')::INTEGER,
        (event->>'event_type')::VARCHAR(30),
        (event->>'event_timestamp')::TIMESTAMP WITH TIME ZONE,
        event->'event_data'
    FROM call_traces,
         jsonb_array_elements(call_events) AS event
    WHERE unique_id = p_unique_id
    ORDER BY (event->>'event_sequence')::INTEGER;
END;
$$ LANGUAGE plpgsql;
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å—Ö–µ–º—ã

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –≤ —Å–≤–æ–µ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏
3. **–ì–∏–±–∫–æ—Å—Ç—å**: JSONB –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –ª—é–±—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–æ–±—ã—Ç–∏–π
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏
5. **–ü–æ–Ω—è—Ç–Ω–æ—Å—Ç—å**: –ü–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω—ã –ø—Ä–æ—Å—Ç–æ - –Ω–æ–º–µ—Ä–æ–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### CallTrace (–æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ –ë–î)
```json
{
  "id": 123,
  "unique_id": "1759490248.0",
  "enterprise_number": "0367",
  "phone_number": "375296254070",
  "call_direction": "outgoing",
  "call_status": "active",
  "start_time": "2025-10-03T11:29:13",
  "end_time": null,
  "call_events": [
    {
      "event_sequence": 1,
      "event_type": "dial",
      "event_timestamp": "2025-10-03T11:29:13",
      "event_data": {
        "Phone": "375296254070",
        "Extensions": ["150"],
        "Trunk": "0001363"
      }
    }
  ],
  "created_at": "2025-10-03T11:29:13",
  "updated_at": "2025-10-03T11:29:47"
}
```

### Event (—Å–æ–±—ã—Ç–∏–µ –∑–≤–æ–Ω–∫–∞)
```json
{
  "event_type": "dial|bridge|hangup|new_channel|etc",
  "event_data": {...},       // –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
  "timestamp": "2025-10-03T11:29:13"
}
```

### HttpRequest (HTTP –∑–∞–ø—Ä–æ—Å)
```json
{
  "method": "GET|POST|PUT|DELETE",
  "url": "http://localhost:8020/...",
  "request_data": {...},     // –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞
  "response_data": {...},    // –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞
  "status_code": 200,
  "duration_ms": 245.3,
  "timestamp": "2025-10-03T11:29:14"
}
```

### SqlQuery (SQL –∑–∞–ø—Ä–æ—Å)
```json
{
  "query": "SELECT ...",
  "parameters": [...],       // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
  "result": {...},          // –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
  "duration_ms": 12.5,
  "timestamp": "2025-10-03T11:29:15"
}
```

### TelegramMessage (Telegram –æ–ø–µ—Ä–∞—Ü–∏—è)
```json
{
  "chat_id": 7055556176,
  "message_type": "dial|bridge|hangup",
  "message_id": 13165,
  "message_text": "...",
  "action": "send|edit|delete",
  "timestamp": "2025-10-03T11:29:16"
}
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–≤–æ–Ω–∫–∞

### üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º

**–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å:** Call Logger –ª–æ–≥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è **–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ**, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

#### –ü—Ä–∏–º–µ—Ä: –ó–≤–æ–Ω–æ–∫ —Å 2 –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏
```
–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ 0233 –∏–º–µ–µ—Ç 2 –ø–æ–¥–ø–∏—Å—á–∏–∫–∞:
- chat_id: 7757573720 (–æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)  
- chat_id: 374573193 (—Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

–ü—Ä–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ dial —Å–æ–±—ã—Ç–∏—è:
1. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ process_dial –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –î–í–ê –†–ê–ó–ê
2. –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —Å chat_id
3. –í –±—É–¥—É—â–µ–º –∫–∞–∂–¥—ã–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
```

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Call Logger:
```json
[
  {
    "event_type": "dial",
    "chat_id": 7757573720,
    "event_data": {"Phone": "+375296254070", "_chat_id": 7757573720},
    "timestamp": "2025-10-04T09:17:53"
  },
  {
    "event_type": "dial", 
    "chat_id": 374573193,
    "event_data": {"Phone": "+375296254070", "_chat_id": 374573193},
    "timestamp": "2025-10-04T09:17:56"
  }
]
```

### 1. Dial —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç dial —Å–æ–±—ã—Ç–∏–µ –æ—Ç —Ö–æ—Å—Ç–∞
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (chat_ids)
3. –î–õ–Ø –ö–ê–ñ–î–û–ì–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è:
   a. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ –≤ /log/event —Å chat_id
   b. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ 8020
   c. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
   d. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
   e. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram —Å chat_id
```

### 2. Bridge —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç bridge —Å–æ–±—ã—Ç–∏–µ
2. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/event
3. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è
4. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
6. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
```

### 3. Hangup —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç hangup —Å–æ–±—ã—Ç–∏–µ
2. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/event
3. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ internal_phone
4. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/sql
5. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è
6. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
7. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
8. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
9. –£–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
10. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
```

## üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º

### –í dial.py
```python
import httpx

async def log_call_event(enterprise, unique_id, event_type, data):
    async with httpx.AsyncClient() as client:
        await client.post("http://localhost:8026/log/event", json={
            "enterprise_number": enterprise,
            "unique_id": unique_id,
            "event_type": event_type,
            "event_data": data
        })

async def log_http_request(enterprise, unique_id, method, url, response_data, status_code, duration_ms):
    async with httpx.AsyncClient() as client:
        await client.post("http://localhost:8026/log/http", json={
            "enterprise_number": enterprise,
            "unique_id": unique_id,
            "method": method,
            "url": url,
            "response_data": response_data,
            "status_code": status_code,
            "duration_ms": duration_ms
        })
```

## üîÆ –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º

### –≠—Ç–∞–ø 1 (–ë–∞–∑–∞) ‚úÖ –ó–ê–í–ï–†–®–ï–ù
- ‚úÖ –ë–∞–∑–æ–≤—ã–π API
- ‚úÖ PostgreSQL —Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ 78 –ø–∞—Ä—Ç–∏—Ü–∏–π –¥–ª—è –≤—Å–µ—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
- ‚úÖ –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –≠—Ç–∞–ø 2 (–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ —Å–æ–±—ã—Ç–∏–π) ‚úÖ –ó–ê–í–ï–†–®–ï–ù
- ‚úÖ **start.py** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ start —Å–æ–±—ã—Ç–∏–π + –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ enterprise_number (–ì–û–¢–û–í–û)
- ‚úÖ **dial.py** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ dial —Å–æ–±—ã—Ç–∏–π + HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ + Telegram (–ì–û–¢–û–í–û)
- ‚úÖ **bridge.py** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ bridge —Å–æ–±—ã—Ç–∏–π + –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–ì–û–¢–û–í–û)
- ‚úÖ **hangup.py** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ hangup + SQL –∑–∞–ø—Ä–æ—Å—ã + —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ì–û–¢–û–í–û)

### –≠—Ç–∞–ø 3 (–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) üìã –ó–ê–ü–õ–ê–ù–ò–†–û–í–ê–ù–û
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ 8020
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –≤–Ω–µ—à–Ω–∏–º API (MoySklad, RetailCRM)
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–π
- üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö Telegram –æ–ø–µ—Ä–∞—Ü–∏–π

### –≠—Ç–∞–ø 4 (–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å) üîÆ –ë–£–î–£–©–ï–ï
- üîÆ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—Ä–µ–π—Å–æ–≤
- üîÆ –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ —Å–æ–±—ã—Ç–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ chat_id
- üîÆ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- üîÆ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –¥–æ—Å—Ç–∞–≤–ª—è–µ–º–æ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## üéØ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### üìä –ê–Ω–∞–ª–∏–∑ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

#### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–∑–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
```bash
# –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–µ–π—Å –∑–≤–æ–Ω–∫–∞
curl "http://localhost:8026/trace/1759569469.6697"

# –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ –ø–æ–ª—É—á–∏–ª –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
# chat_id: 7757573720 - –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
# chat_id: 374573193 - —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
```

#### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π
```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
curl "http://localhost:8026/enterprise/0233/events" | jq '.[] | select(.event_data._chat_id == 374573193)'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π
curl "http://localhost:8026/enterprise/0233/events" | jq '.[] | select(.event_type == "telegram_send")'
```

#### –ü—Ä–∏–º–µ—Ä 3: –ê—É–¥–∏—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
curl "http://localhost:8026/trace/UNIQUE_ID" | jq '.timeline[] | select(.data._chat_id == CHAT_ID)'
```

### üîç –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

#### –ù–∞–π—Ç–∏ –≤—Å–µ –∑–≤–æ–Ω–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –∑–∞ –¥–µ–Ω—å
```bash
curl "http://localhost:8026/enterprise/0367/events?date=2025-10-04"
```

#### –ü—Ä–æ—Å–ª–µ–¥–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ñ–ª–æ—É –∑–≤–æ–Ω–∫–∞
```bash
curl "http://localhost:8026/trace/UNIQUE_ID" | jq '.timeline[] | {seq: .sequence, event: .event_type, chat_id: .data._chat_id, time: .timestamp}'
```

## üìã –°–¢–ê–¢–£–° –ò–ù–¢–ï–ì–†–ê–¶–ò–ò - –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

### ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û - –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Call Logger
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ `app/utils/logger_client.py` –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ª–æ–≥–≥–µ—Ä–æ–º
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –í–°–ï –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π: `start.py`, `dial.py`, `bridge.py`, `hangup.py`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–∏—Å—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (8020)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π —Å chat_id
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Integration Gateway
- ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´
- ‚úÖ **API /trace/ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω**: –∑–∞–º–µ–Ω–µ–Ω `duration_seconds` –Ω–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏–∑ `start_time`/`end_time`
- ‚úÖ **–ü–∞—Ä—Ç–∏—Ü–∏—è 0233 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞**: –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `ensure_enterprise_partition` –¥–ª—è LIST –ø–∞—Ä—Ç–∏—Ü–∏–π
- ‚úÖ **"–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ" —Å–æ–±—ã—Ç–∏–π –æ–±—ä—è—Å–Ω–µ–Ω–æ**: —ç—Ç–æ –§–ò–ß–ê –¥–ª—è –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω chat_id**: –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è

### üéØ –ö–õ–Æ–ß–ï–í–´–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò –°–ò–°–¢–ï–ú–´

#### üì§ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º (–ù–ï –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!)
–ö–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è **–æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è** –≤ Telegram:
- **1 –ø–æ–ª—É—á–∞—Ç–µ–ª—å** = 1 –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥–≥–µ—Ä–µ
- **2 –ø–æ–ª—É—á–∞—Ç–µ–ª—è** = 2 –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥–≥–µ—Ä–µ (—Å —Ä–∞–∑–Ω—ã–º–∏ `chat_id`)
- **N –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π** = N –∑–∞–ø–∏—Å–µ–π –≤ –ª–æ–≥–≥–µ—Ä–µ

**–ü—Ä–∏–º–µ—Ä –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0233:**
```json
{
  "events": [
    {"event_type": "dial", "chat_id": 7757573720, "timestamp": "09:17:53"},
    {"event_type": "dial", "chat_id": 374573193, "timestamp": "09:17:56"}
  ]
}
```

#### üéØ –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?
–ü—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ **–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π** —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –ø–æ–ª—É—á–∞—Ç—å:
- –†–∞–∑–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
- –†–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

**Call Logger –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ß–¢–û –∏–º–µ–Ω–Ω–æ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ö–ê–ñ–î–û–ú–£ –ø–æ–ª—É—á–∞—Ç–µ–ª—é.**

### üìä –§–ò–ù–ê–õ–¨–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
- **–°—Ç–∞—Ç—É—Å**: –í–°–ï —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ
- **–ü–æ–∫—Ä—ã—Ç–∏–µ**: start, dial, bridge, hangup + HTTP + Telegram ‚úÖ
- **–ü–∞—Ä—Ç–∏—Ü–∏–∏**: 78 –ø–∞—Ä—Ç–∏—Ü–∏–π –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π ‚úÖ
- **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è**: –∫–∞–∂–¥–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å chat_id –ø–æ–ª—É—á–∞—Ç–µ–ª—è ‚úÖ
- **API**: –ø–æ–ª–Ω—ã–π —Ç—Ä–µ–π—Å –∑–≤–æ–Ω–∫–∞ —á–µ—Ä–µ–∑ `/trace/{unique_id}` ‚úÖ

## üöÄ –ó–∞–ø—É—Å–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
```bash
# –ó–∞–ø—É—Å–∫
./logger.sh start

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
./logger.sh stop

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
./logger.sh restart

# –°—Ç–∞—Ç—É—Å
./logger.sh status
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
curl http://localhost:8026/health

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–∏—Å–µ
curl http://localhost:8026/
```

## üóÇÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π

### –°–∫—Ä–∏–ø—Ç `logger_partitions.sh`

–£–¥–æ–±–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏.

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

**–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π:**
```bash
./logger_partitions.sh list
```
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø–∏—Å–µ–π:
```
üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π:

üóÇÔ∏è –¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞: –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º
 enterprise_partition | size  | records | enterprise_number 
----------------------+-------+---------+-------------------
 0280                 | 48 kB |       1 | 0280
 0286                 | 48 kB |       0 | 0286
 0367                 | 48 kB |       1 | 0367
 0368                 | 48 kB |       0 | 0368
 0999                 | 48 kB |       1 | 0999
```

**–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è:**
```bash
./logger_partitions.sh add-enterprise 0369
```
–ü—Ä–æ—Å—Ç–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:
```
‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0369...
‚úÖ –ü–∞—Ä—Ç–∏—Ü–∏—è 0369 —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!
üìù –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: SELECT * FROM "0369";
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é:**
```bash
./logger_partitions.sh stats 0367
```
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0367:

 total_calls | completed_calls |  avg_events_per_call   | first_call | last_call | events_size 
-------------+-----------------+------------------------+------------+-----------+-------------
           5 |               2 | 2.40000000000000000000 | 2025-10-03 | 2025-10-03| 895 bytes
```

**–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è:**
```bash
./logger_partitions.sh cleanup 0367     # –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
./logger_partitions.sh cleanup-all      # –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)
```

**–ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π:**
```bash
./logger_partitions.sh rebuild-partitions
```
–ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏.

**–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤:**
```bash
./logger_partitions.sh sql "SELECT COUNT(*) FROM \"0367\";"
./logger_partitions.sh sql "SELECT * FROM \"0367\" LIMIT 5;"
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
```bash
./logger_partitions.sh test-event 0367
```
–°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞:**
```bash
./logger_partitions.sh health
```

#### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ**
```bash
# –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Ç–∏—Ü–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0375
./logger_partitions.sh add-enterprise 0375

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞—Ä—Ç–∏—Ü–∏—è —Å–æ–∑–¥–∞–ª–∞—Å—å
./logger_partitions.sh list

# –°–º–æ—Ç—Ä–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–ø–æ–∫–∞ –ø—É—Å—Ç–∞—è)
./logger_partitions.sh stats 0375
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è**
```bash
# –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ 0367
./logger_partitions.sh stats 0367

# –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ SQL (–æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∫–∞–≤—ã—á–∫–∏!)
./logger_partitions.sh sql "
SELECT 
    call_direction,
    COUNT(*) as calls_count,
    jsonb_array_length(call_events) as avg_events
FROM \"0367\" 
WHERE start_time >= NOW() - INTERVAL '7 days'
GROUP BY call_direction;
"

# –ü–æ–∏—Å–∫ –∑–≤–æ–Ω–∫–æ–≤ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
./logger_partitions.sh sql "
SELECT unique_id, phone_number, call_status, start_time 
FROM \"0367\" 
WHERE phone_number = '375296254070';
"
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
```bash
# –°–Ω–∞—á–∞–ª–∞ —Å–º–æ—Ç—Ä–∏–º —á—Ç–æ –≤ –ø–∞—Ä—Ç–∏—Ü–∏–∏
./logger_partitions.sh stats 0999

# –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ - –æ—á–∏—â–∞–µ–º
./logger_partitions.sh cleanup 0999
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
```bash
# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
./logger_partitions.sh test-event 0367

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –∑–∞–ø–∏—Å–∞–ª–æ—Å—å
./logger_partitions.sh stats 0367

# –°–º–æ—Ç—Ä–∏–º –¥–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è
./logger_partitions.sh sql "SELECT * FROM \"0367\" ORDER BY id DESC LIMIT 1;"
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π

–ü–∞—Ä—Ç–∏—Ü–∏–∏ **–ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏—Ö –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º:

```bash
# –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –ø–∞—Ä—Ç–∏—Ü–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
./logger_partitions.sh add-enterprise 0375

# –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è
curl -X POST http://localhost:8026/log/event -H "Content-Type: application/json" -d '{
    "enterprise_number": "0375",
    "unique_id": "1759490248.0", 
    "event_type": "dial",
    "event_data": {...}
}'
```

#### –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

**–ö–∞–≤—ã—á–∫–∏ –≤ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö:**
–ü–æ—Å–∫–æ–ª—å–∫—É –ø–∞—Ä—Ç–∏—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω—ã —Ü–∏—Ñ—Ä–∞–º–∏, –≤ SQL –Ω—É–∂–Ω—ã –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏:
```sql
-- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
SELECT * FROM "0367";

-- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ  
SELECT * FROM 0367;
```

**–ü—Ä–æ—Å—Ç—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π:**
- –ü–∞—Ä—Ç–∏—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0367 –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ `"0367"`
- –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ `call_traces_` –±–æ–ª—å—à–µ –Ω–µ—Ç
- –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

#### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞—Ä—Ç–∏—Ü–∏–π

**–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –†–∞–∑–º–µ—Ä—ã –≤—Å–µ—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
./logger_partitions.sh list

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
for enterprise in 0367 0280 0368; do
    echo "=== –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ $enterprise ==="
    ./logger_partitions.sh stats $enterprise
    echo ""
done
```

**–ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π:**
```bash
# –ü–∞—Ä—Ç–∏—Ü–∏–∏ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö (–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–Ω—ã –æ—à–∏–±–æ—á–Ω–æ)
./logger_partitions.sh sql "
SELECT 
    tablename as partition_name,
    pg_size_pretty(pg_total_relation_size('public.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename ~ '^[0-9]{4}$'
ORDER BY pg_total_relation_size('public.'||tablename) DESC;
"

# –ü–æ–∏—Å–∫ –ø—É—Å—Ç—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π
./logger_partitions.sh sql "
SELECT 
    tablename,
    (SELECT COUNT(*) FROM call_traces WHERE tableoid = ('public.'||tablename)::regclass) as records
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename ~ '^[0-9]{4}$'
HAVING (SELECT COUNT(*) FROM call_traces WHERE tableoid = ('public.'||tablename)::regclass) = 0;
"
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞
- –§–∞–π–ª: `logs/logger.log`
- –§–æ—Ä–º–∞—Ç: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Python logging
- –†–æ—Ç–∞—Ü–∏—è: –ü–æ —Ä–∞–∑–º–µ—Ä—É (10MB)

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–π—Å–æ–≤
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –°–µ—Ä–≤–∏—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç --reload –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ç–æ—Ä–º–æ–∑–æ–≤
2. **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL —Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ localhost –∏ —á–µ—Ä–µ–∑ Nginx –Ω–∞ `/logger/`
4. **–ü–∞—Ä—Ç–∏—Ü–∏–∏**: –ù–∞–∑–≤–∞–Ω—ã –ø—Ä–æ—Å—Ç–æ –Ω–æ–º–µ—Ä–∞–º–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π (0367, 0280, etc.) –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
5. **SQL –∑–∞–ø—Ä–æ—Å—ã**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø–∞—Ä—Ç–∏—Ü–∏–π
6. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π**: –ü–∞—Ä—Ç–∏—Ü–∏–∏ –ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
7. **JSONB**: –í—Å–µ —Å–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–¥–Ω–æ–º JSONB –ø–æ–ª–µ –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

- **8000** - –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏)
- **8020** - –°–µ—Ä–≤–∏—Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–∏—Å—Ç–æ—á–Ω–∏–∫ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤)
- **PostgreSQL** - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–±—É–¥—É—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 1.0.0  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 2025-10-03  
**–ê–≤—Ç–æ—Ä**: Call Logger Service Team

---

## üìã –°–¢–ê–¢–£–° –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê (2025-10-17) - ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

### ‚úÖ –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ (–ó–ê–í–ï–†–®–ï–ù–û)
- ‚úÖ –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–≤—ã—è–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º)
- ‚úÖ –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ –ë–î: 15 –ø–æ–ª–µ–π, 78 LIST –ø–∞—Ä—Ç–∏—Ü–∏–π –ø–æ —é–Ω–∏—Ç–∞–º
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ

### ‚úÖ –≠—Ç–∞–ø 2: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ë–î —Å—Ö–µ–º—ã (–ó–ê–í–ï–†–®–ï–ù–û)
**–î–æ–±–∞–≤–ª–µ–Ω—ã 4 –Ω–æ–≤—ã—Ö JSONB –ø–æ–ª—è:**
- ‚úÖ `http_requests` - –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ `sql_queries` - –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è SQL –æ–ø–µ—Ä–∞—Ü–∏–π  
- ‚úÖ `telegram_messages` - –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è Telegram –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ `integration_responses` - –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

**–°–æ–∑–¥–∞–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- ‚úÖ 4 GIN –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ JSONB –ø–æ–ª—è–º
- ‚úÖ 4 –Ω–æ–≤—ã–µ PL/pgSQL —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤:
  - `add_http_request()` - 8 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  - `add_sql_query()` - 7 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  - `add_telegram_message()` - 8 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  - `add_integration_response()` - 10 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### ‚úÖ –≠—Ç–∞–ø 3: –ü–µ—Ä–µ–ø–∏—Å–∞–Ω–∏–µ API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (–ó–ê–í–ï–†–®–ï–ù–û)
- ‚úÖ POST /log/event - —Å–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–æ–≤ (—Ä–∞–±–æ—Ç–∞–µ—Ç)
- ‚úÖ POST /log/http - –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ in-memory –≤ PostgreSQL
- ‚úÖ POST /log/sql - –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ in-memory –≤ PostgreSQL
- ‚úÖ POST /log/telegram - –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ in-memory –≤ PostgreSQL
- ‚úÖ POST /log/integration - –ù–û–í–´–ô —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –£–¥–∞–ª–µ–Ω–æ 93 —Å—Ç—Ä–æ–∫–∏ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–ö–†–ò–¢–ò–ß–ù–û–ï)
- –î–æ–±–∞–≤–ª–µ–Ω–æ 150+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQL

### ‚úÖ –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ GET —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (–ó–ê–í–ï–†–®–ï–ù–û)
- ‚úÖ GET /trace/{unique_id} - –ø–æ–ª–Ω—ã–π timeline —Å–æ –í–°–ï–ú–ò 5 —Ç–∏–ø–∞–º–∏ –ª–æ–≥–æ–≤:
  - call_event (—Å–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞)
  - http_request (HTTP –∑–∞–ø—Ä–æ—Å—ã)
  - sql_query (SQL –∑–∞–ø—Ä–æ—Å—ã)
  - telegram_message (Telegram –æ–ø–µ—Ä–∞—Ü–∏–∏)
  - integration_response (–æ—Ç–≤–µ—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π)
- ‚úÖ GET /search - –ø–æ–∏—Å–∫ –≤ –ë–î —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ (–¥–∞—Ç–∞, —Å—Ç–∞—Ç—É—Å, –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ)
- ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ timeline –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è summary —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### ‚úÖ –≠—Ç–∞–ø 6.1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ LoggerClient (–ó–ê–í–ï–†–®–ï–ù–û)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `log_integration_response()`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `log_integration_call()`
- ‚úÖ –í—Å–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã

### ‚úÖ –ü–æ–ª–Ω–æ–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ü–†–û–ô–î–ï–ù–û)
**–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
1. ‚úÖ Dial —Å–æ–±—ã—Ç–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
2. ‚úÖ HTTP –∑–∞–ø—Ä–æ—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
3. ‚úÖ SQL –∑–∞–ø—Ä–æ—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
4. ‚úÖ Telegram —Å–æ–æ–±—â–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
5. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
6. ‚úÖ /trace –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π timeline
7. ‚úÖ /search —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏

### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- **–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω**: logger.py (693 —Å—Ç—Ä–æ–∫), logger_client.py (+50 —Å—Ç—Ä–æ–∫)
- **–ë–î —Ñ—É–Ω–∫—Ü–∏–∏**: 4 –Ω–æ–≤—ã–µ PL/pgSQL —Ñ—É–Ω–∫—Ü–∏–∏
- **–ò–Ω–¥–µ–∫—Å—ã**: 4 GIN –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ JSONB –ø–æ–ª—è
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–ª–Ω—ã–π e2e —Ç–µ—Å—Ç ‚úÖ

### üîÑ –û—Å—Ç–∞—é—â–∏–µ—Å—è —ç—Ç–∞–ø—ã (1-2 –¥–Ω—è —Ä–∞–±–æ—Ç—ã)

#### –≠—Ç–∞–ø 6.2-6.4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º (–¢–†–ï–ë–£–ï–¢–°–Ø)
- üîÑ dial.py - –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –í–°–ï HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- üîÑ bridge.py - –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤  
- üîÑ hangup.py - –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤

#### –≠—Ç–∞–ø 7: –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–¢–†–ï–ë–£–ï–¢–°–Ø)
- üìã Unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- üìã –ü–æ–ª–Ω—ã–π e2e —Ç–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–≤–æ–Ω–∫–∞–º–∏
- üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –≠—Ç–∞–ø 8: –§–∏–Ω–∞–ª—å–Ω–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–¢–ï–ö–£–©–ê–Ø)
- üìã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ logger.md (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
- üìã –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- üìã –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### üéØ –ö–ª—é—á–µ–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**‚úÖ –û–î–ù–ê –∑–∞–ø–∏—Å—å –≤ PostgreSQL = –ü–û–õ–ù–´–ô timeline –∑–≤–æ–Ω–∫–∞ —Å–æ –í–°–ï–ú–ò –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏**

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç:
- ‚úÖ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å - –¥–∞–Ω–Ω—ã–µ –ù–ï —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
- ‚úÖ –ü–æ–ª–Ω–æ—Ç—É - –≤—Å–µ –ª–æ–≥–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ –ü–æ–∏—Å–∫ - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å - –≥–æ—Ç–æ–≤–æ –∫ production
- ‚úÖ –û—Ç–ª–∞–¥–∫—É - –ø–æ–ª–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∑–≤–æ–Ω–∫–∞

### üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production

**–°–¢–ê–¢–£–°: ‚úÖ PRODUCTION READY**
- ‚úÖ –Ø–¥—Ä–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç—Ç–∞–ø—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º (6.2-6.4)
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ–µ e2e —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 2.0 (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-10-17)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ PRODUCTION READY (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç—Ç–∞–ø—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã)  
**–ó–∞–≤–µ—Ä—à–µ–Ω–æ**: –≠—Ç–∞–ø—ã 1-6.1 (50% –ø–ª–∞–Ω–∞, 100% –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —ç—Ç–∞–ø–æ–≤)  
**–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: ~2 —á–∞—Å–∞  
**–ê–≤—Ç–æ—Ä**: Call Logger Service Team

---

## üîç –ê–ù–ê–õ–ò–¢–ò–ö–ê: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ "–û–î–ò–ù –ó–í–û–ù–û–ö = –û–î–ù–ê –ó–ê–ü–ò–°–¨" (2025-10-18)

### üéØ –ü—Ä–æ–±–ª–µ–º–∞ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- –û–¥–∏–Ω –∑–≤–æ–Ω–æ–∫ –≤ Asterisk = **–î–í–ê UniqueId** (–¥–≤–∞ –∫–∞–Ω–∞–ª–∞ –≤ bridge-–º–æ—Å—Ç—É)
- –ö–∞–∂–¥—ã–π UniqueId —Å–æ–∑–¥–∞–µ—Ç **–æ—Ç–¥–µ–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å** –≤ `call_traces`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: **2 –∑–∞–ø–∏—Å–∏ –≤ –ë–î** –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π

**–ü—Ä–∏–º–µ—Ä –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤:**
```
UniqueId: 1760709490.90 (–∫–∞–Ω–∞–ª 1) ‚Üí –∑–∞–ø–∏—Å—å 1 –≤ –ë–î
UniqueId: 1760709496.96 (–∫–∞–Ω–∞–ª 2) ‚Üí –∑–∞–ø–∏—Å—å 2 –≤ –ë–î
BridgeUniqueid: 9aee1b64-59fe-4da0-b11f-835ff1f22cf9 (–û–î–ò–ù –¥–ª—è –æ–±–æ–∏—Ö!)
```

### ‚úÖ –†–ï–®–ï–ù–ò–ï: BridgeUniqueid –∫–∞–∫ —Å–≤—è–∑—É—é—â–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:**
- **BridgeUniqueid** - —ç—Ç–æ UUID –º–æ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π **–û–î–ò–ù** –¥–ª—è –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤ –≤ –∑–≤–æ–Ω–∫–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `BridgeUniqueid` –∫–∞–∫ **PRIMARY KEY** –≤–º–µ—Å—Ç–æ `unique_id`
- –•—Ä–∞–Ω–∏—Ç—å –≤—Å–µ `UniqueId` –∫–∞–Ω–∞–ª–æ–≤ –≤ **JSONB –º–∞—Å—Å–∏–≤–µ** –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏

### üìä –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã

```sql
CREATE TABLE call_traces (
    id BIGSERIAL,
    bridge_unique_id VARCHAR(50) NOT NULL,      -- –û–°–ù–û–í–ù–û–ô –ö–õ–Æ–ß (BridgeUniqueid)
    enterprise_number VARCHAR(10) NOT NULL,
    channel_unique_ids JSONB DEFAULT '[]'::jsonb,  -- –ú–∞—Å—Å–∏–≤ –≤—Å–µ—Ö UniqueId –∫–∞–Ω–∞–ª–æ–≤
    phone_number VARCHAR(20),
    call_direction VARCHAR(10),
    call_status VARCHAR(20) DEFAULT 'active',
    start_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    end_time TIMESTAMP WITH TIME ZONE,
    
    -- JSONB –ø–æ–ª—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ª–æ–≥–æ–≤
    call_events JSONB DEFAULT '[]'::jsonb,
    http_requests JSONB DEFAULT '[]'::jsonb,
    sql_queries JSONB DEFAULT '[]'::jsonb,
    telegram_messages JSONB DEFAULT '[]'::jsonb,
    integration_responses JSONB DEFAULT '[]'::jsonb,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    PRIMARY KEY (bridge_unique_id, enterprise_number)
) PARTITION BY LIST (enterprise_number);
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
1. `bridge_unique_id` - –Ω–æ–≤—ã–π PRIMARY KEY (–≤–º–µ—Å—Ç–æ `unique_id`)
2. `channel_unique_ids` - JSONB –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö UniqueId –∫–∞–Ω–∞–ª–æ–≤
3. –í—Å–µ —Å–æ–±—ã—Ç–∏—è –æ–±–æ–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ ‚Üí **–û–î–ù–ê –∑–∞–ø–∏—Å—å**

### üîë –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è BridgeUniqueid

**–ê–ª–≥–æ—Ä–∏—Ç–º –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–≤—è–∑—É—é—â–µ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞:**

```python
def get_call_identifier(events):
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–≤—è–∑—É—é—â–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–∞
    
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
    1. BridgeUniqueid –∏–∑ –ø–µ—Ä–≤–æ–≥–æ bridge —Å–æ–±—ã—Ç–∏—è (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª—É—á–∞–π)
    2. UniqueId –∏–∑ –ø–µ—Ä–≤–æ–≥–æ start/dial —Å–æ–±—ã—Ç–∏—è (fallback)
    """
    # 1. –ò—â–µ–º –ø–µ—Ä–≤—ã–π bridge - –±–µ—Ä–µ–º –µ–≥–æ BridgeUniqueid
    first_bridge = next((e for e in events if e.event == 'bridge'), None)
    if first_bridge and first_bridge.data.get('BridgeUniqueid'):
        return first_bridge.data.get('BridgeUniqueid')
    
    # 2. Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º UniqueId –∏–∑ start/dial
    start_or_dial = next((e for e in events if e.event in ['start', 'dial']), None)
    if start_or_dial:
        return start_or_dial.uniqueid
    
    return None
```

**–ò—Å—Ç–æ—á–Ω–∏–∫ –ª–æ–≥–∏–∫–∏:**
- –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ `events.md` (—Å—Ç—Ä–æ–∫–∏ 508-521)
- –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫: –ø–µ—Ä–≤–æ–µ `start` —Å–æ–±—ã—Ç–∏–µ
- –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫: –ø–µ—Ä–≤–æ–µ `dial` —Å–æ–±—ã—Ç–∏–µ
- –°–≤—è–∑—å –∫–∞–Ω–∞–ª–æ–≤: `BridgeUniqueid` –∏–∑ –ø–µ—Ä–≤–æ–≥–æ `bridge` —Å–æ–±—ã—Ç–∏—è

### üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

#### 1. –§—É–Ω–∫—Ü–∏—è –ë–î `add_call_event()` - –¢–†–ï–ë–£–ï–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø

**–ù–æ–≤–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞:**
```sql
CREATE OR REPLACE FUNCTION add_call_event(
    p_bridge_unique_id VARCHAR(50),    -- –ù–û–í–´–ô: –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á
    p_channel_unique_id VARCHAR(50),   -- –ù–û–í–´–ô: UniqueId –∫–∞–Ω–∞–ª–∞
    p_enterprise_number VARCHAR(10),
    p_event_type VARCHAR(30),
    p_event_data JSONB,
    p_phone_number VARCHAR(20) DEFAULT NULL
)
RETURNS BIGINT AS $$
DECLARE
    v_trace_id BIGINT;
BEGIN
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å –ø–æ bridge_unique_id
    SELECT id INTO v_trace_id 
    FROM call_traces 
    WHERE bridge_unique_id = p_bridge_unique_id 
      AND enterprise_number = p_enterprise_number;
    
    IF v_trace_id IS NOT NULL THEN
        -- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        UPDATE call_traces SET
            -- –î–æ–±–∞–≤–ª—è–µ–º channel_unique_id –≤ –º–∞—Å—Å–∏–≤ (–µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç)
            channel_unique_ids = CASE 
                WHEN NOT channel_unique_ids @> jsonb_build_array(p_channel_unique_id)
                THEN channel_unique_ids || jsonb_build_array(p_channel_unique_id)
                ELSE channel_unique_ids
            END,
            -- –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ
            call_events = call_events || jsonb_build_object(
                'event_sequence', jsonb_array_length(call_events) + 1,
                'event_type', p_event_type,
                'event_timestamp', NOW(),
                'channel_unique_id', p_channel_unique_id,
                'event_data', p_event_data
            ),
            updated_at = NOW()
        WHERE id = v_trace_id;
    ELSE
        -- –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        INSERT INTO call_traces (
            bridge_unique_id, 
            enterprise_number, 
            channel_unique_ids,
            phone_number, 
            call_direction, 
            call_status, 
            call_events
        )
        VALUES (
            p_bridge_unique_id, 
            p_enterprise_number, 
            jsonb_build_array(p_channel_unique_id),
            p_phone_number, 
            CASE WHEN p_event_type IN ('start', 'dial') THEN 'outgoing' END,
            'active',
            jsonb_build_array(jsonb_build_object(
                'event_sequence', 1,
                'event_type', p_event_type,
                'event_timestamp', NOW(),
                'channel_unique_id', p_channel_unique_id,
                'event_data', p_event_data
            ))
        )
        RETURNING id INTO v_trace_id;
    END IF;

    RETURN v_trace_id;
END;
$$ LANGUAGE plpgsql;
```

#### 2. API —ç–Ω–¥–ø–æ–∏–Ω—Ç `/log/event` - –¢–†–ï–ë–£–ï–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø

```python
@app.post("/log/event")
async def log_call_event(event: CallEvent):
    try:
        conn = await asyncpg.connect(**DB_CONFIG)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º bridge_unique_id –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è
        bridge_uid = event.event_data.get('BridgeUniqueid') or event.unique_id
        channel_uid = event.unique_id
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Å –Ω–æ–≤–æ–π —Å–∏–≥–Ω–∞—Ç—É—Ä–æ–π
        await conn.fetchval(
            "SELECT add_call_event($1, $2, $3, $4, $5, $6)",
            bridge_uid,           # bridge_unique_id (–æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á)
            channel_uid,          # channel_unique_id (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –º–∞—Å—Å–∏–≤)
            event.enterprise_number,
            event.event_type,
            json.dumps(event.event_data),
            event.event_data.get('Phone')
        )
        
        await conn.close()
        return {"status": "success"}
    except Exception as e:
        logger.error(f"Error logging event: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

#### 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π - –¢–†–ï–ë–£–Æ–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø

**dial.py, bridge.py, hangup.py:**
- –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `log_call_event()` –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `BridgeUniqueid` –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- –î–ª—è —Å–æ–±—ã—Ç–∏–π –±–µ–∑ bridge –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `UniqueId` –∫–∞–∫ fallback

### üìà –†–µ–∑—É–ª—å—Ç–∞—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–ë–´–õ–û (—Ç–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞):**
```sql
-- –î–≤–∞ UniqueId ‚Üí –¥–≤–µ –∑–∞–ø–∏—Å–∏
SELECT * FROM "0367";

 id | unique_id        | events | telegram_messages
----+------------------+--------+------------------
  1 | 1760709490.90    | 6      | {...}
  2 | 1760709496.96    | 2      | {...}
```

**–°–¢–ê–ù–ï–¢ (–Ω–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞):**
```sql
-- –û–¥–∏–Ω BridgeUniqueid ‚Üí –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å
SELECT * FROM "0367";

 id | bridge_unique_id                      | channel_unique_ids              | events
----+---------------------------------------+---------------------------------+--------
  1 | 9aee1b64-59fe-4da0-b11f-835ff1f22cf9 | ["1760709490.90","1760709496.96"] | 8
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. ‚úÖ **–û–¥–∏–Ω –∑–≤–æ–Ω–æ–∫ = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å** (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
2. ‚úÖ **–í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ** (—Å–æ–±—ã—Ç–∏—è –æ–±–æ–∏—Ö –∫–∞–Ω–∞–ª–æ–≤)
3. ‚úÖ **–ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞** (–≤—Å–µ UniqueId —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –º–∞—Å—Å–∏–≤–µ)
4. ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞** (–Ω–µ –Ω—É–∂–Ω–æ JOIN-–∏—Ç—å –∑–∞–ø–∏—Å–∏)
5. ‚úÖ **Telegram —Å–æ–æ–±—â–µ–Ω–∏—è** (–≤—Å–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏)

### üöÄ –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

#### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î
1. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `bridge_unique_id` –≤ `call_traces`
2. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `channel_unique_ids` (JSONB)
3. –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –Ω–∞ `bridge_unique_id`
4. –û–±–Ω–æ–≤–∏—Ç—å UNIQUE constraint

#### –≠—Ç–∞–ø 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –ë–î
1. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å `add_call_event()` —Å –Ω–æ–≤–æ–π —Å–∏–≥–Ω–∞—Ç—É—Ä–æ–π
2. –û–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (add_http_request, add_telegram_message –∏ —Ç.–¥.)
3. –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

#### –≠—Ç–∞–ø 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API
1. –û–±–Ω–æ–≤–∏—Ç—å `/log/event` —ç–Ω–¥–ø–æ–∏–Ω—Ç
2. –û–±–Ω–æ–≤–∏—Ç—å `/trace/{id}` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ bridge_unique_id
3. –û–±–Ω–æ–≤–∏—Ç—å `/search` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ bridge_unique_id

#### –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
1. –û–±–Ω–æ–≤–∏—Ç—å `dial.py` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è BridgeUniqueid
2. –û–±–Ω–æ–≤–∏—Ç—å `bridge.py` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è BridgeUniqueid
3. –û–±–Ω–æ–≤–∏—Ç—å `hangup.py` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è BridgeUniqueid

#### –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –¢–µ—Å—Ç–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏ —Å —ç–º—É–ª—è—Ü–∏–µ–π
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è –û–î–ù–ê –∑–∞–ø–∏—Å—å
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ UniqueId –≤ –º–∞—Å—Å–∏–≤–µ
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ timeline –∏ –ø–æ–∏—Å–∫–∞

### üìã –°—Ç–∞—Ç—É—Å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

**–°–¢–ê–¢–£–°: üìã –ó–ê–ü–õ–ê–ù–ò–†–û–í–ê–ù–û**

- üìã –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î (–Ω–µ –Ω–∞—á–∞—Ç–æ)
- üìã –≠—Ç–∞–ø 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –ë–î (–Ω–µ –Ω–∞—á–∞—Ç–æ)
- üìã –≠—Ç–∞–ø 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API (–Ω–µ –Ω–∞—á–∞—Ç–æ)
- üìã –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (–Ω–µ –Ω–∞—á–∞—Ç–æ)
- üìã –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–µ –Ω–∞—á–∞—Ç–æ)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í–´–°–û–ö–ò–ô (–∫—Ä–∏—Ç–∏—á–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 3-4 —á–∞—Å–∞ —Ä–∞–±–æ—Ç—ã

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 2.1 (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-10-18)  
**–î–æ–±–∞–≤–ª–µ–Ω–æ**: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã "–æ–¥–∏–Ω –∑–≤–æ–Ω–æ–∫ = –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å"  
**–ê–≤—Ç–æ—Ä**: Call Logger Service Team
