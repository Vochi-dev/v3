# üìä Call Logger Service - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 30.11.2025 16:00  
**–í–µ—Ä—Å–∏—è:** 2.1 (—Ñ–∞–π–ª–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + HTTP –ª–æ–≥–∏)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è:
1. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤** - –≤—Å–µ —Å–æ–±—ã—Ç–∏—è Asterisk –∏ Telegram –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ñ–∞–π–ª—ã
2. **–ü—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∑–≤–æ–Ω–∫–∞** - HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–≤–æ–Ω–∫–µ

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Asterisk Host  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    main.py       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  call_tracer/           ‚îÇ
‚îÇ  (10.88.10.xx)  ‚îÇ     ‚îÇ    (port 8000)   ‚îÇ     ‚îÇ  ‚îî‚îÄ‚îÄ {enterprise}/      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ      ‚îî‚îÄ‚îÄ events.log     ‚îÇ
                               ‚îÇ                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚ñº
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ  –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:    ‚îÇ
                        ‚îÇ  start.py        ‚îÇ
                        ‚îÇ  dial.py         ‚îÇ
                        ‚îÇ  bridge.py       ‚îÇ
                        ‚îÇ  hangup.py       ‚îÇ
                        ‚îÇ  internal.py     ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚ñº
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ  Telegram Bot    ‚îÇ
                        ‚îÇ  (–æ—Ç–ø—Ä–∞–≤–∫–∞ msg)  ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Telegram –∫–Ω–æ–ø–∫–∞‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    logger.py     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îÇ  "–î–µ—Ç–∞–ª–∏ –∑–≤–æ–Ω–∫–∞"‚îÇ     ‚îÇ    (port 8026)   ‚îÇ      (–∏–∑ —Ñ–∞–π–ª–æ–≤)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤

### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ
```
/root/asterisk-webhook/call_tracer/
‚îú‚îÄ‚îÄ 0103/
‚îÇ   ‚îú‚îÄ‚îÄ events.log           # –¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª
‚îÇ   ‚îî‚îÄ‚îÄ events.log.2025-11-29  # –†–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ 0113/
‚îÇ   ‚îú‚îÄ‚îÄ events.log
‚îÇ   ‚îî‚îÄ‚îÄ events.log.2025-11-29
‚îú‚îÄ‚îÄ 0367/
‚îÇ   ‚îú‚îÄ‚îÄ events.log
‚îÇ   ‚îî‚îÄ‚îÄ events.log.2025-11-29
‚îî‚îÄ‚îÄ ... (–ø–æ –ø–∞–ø–∫–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —é–Ω–∏—Ç–∞)
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ
- –ü–∞–ø–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–±—ã—Ç–∏–∏ –æ—Ç —é–Ω–∏—Ç–∞
- –§–∞–π–ª—ã `events.log` —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –†–æ—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
- **–ö–æ–≥–¥–∞:** –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–±—ã—Ç–∏–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏ (UTC)
- **–ò–º—è:** `events.log.YYYY-MM-DD` (–¥–∞—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è)
- **–•—Ä–∞–Ω–µ–Ω–∏–µ:** 14 –¥–Ω–µ–π (backupCount=14)
- **–ö–æ–¥–∏—Ä–æ–≤–∫–∞:** UTF-8

---

## üìê –§–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–µ–π

### Asterisk —Å–æ–±—ã—Ç–∏—è (AST)
```
TIMESTAMP|AST|EVENT_TYPE|UNIQUE_ID|JSON_BODY
```

**–ü—Ä–∏–º–µ—Ä:**
```
2025-11-30 09:08:42,025|AST|hangup|1764493655.61|{"CallStatus":"0","Phone":"375295305942",...}
```

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|----------|--------|
| TIMESTAMP | –í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è | `2025-11-30 09:08:42,025` |
| AST | –ú–∞—Ä–∫–µ—Ä Asterisk | `AST` |
| EVENT_TYPE | –¢–∏–ø —Å–æ–±—ã—Ç–∏—è | `start`, `dial`, `bridge`, `hangup`, `bridge_leave`, `bridge_create` |
| UNIQUE_ID | Asterisk UniqueId | `1764493655.61` |
| JSON_BODY | –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è | `{...}` |

### Telegram —Å–æ–±—ã—Ç–∏—è (TG)
```
TIMESTAMP|TG|ACTION|CHAT_ID|MSG_TYPE|MSG_ID|UNIQUE_ID|TEXT
```

**–ü—Ä–∏–º–µ—Ä:**
```
2025-11-30 09:08:44,283|TG|send|374573193|hangup|63157|1764493655.61|‚ùå –ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –ø–æ–¥–Ω—è–ª —Ç—Ä—É–±–∫—É...
```

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|----------|--------|
| TIMESTAMP | –í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è | `2025-11-30 09:08:44,283` |
| TG | –ú–∞—Ä–∫–µ—Ä Telegram | `TG` |
| ACTION | –î–µ–π—Å—Ç–≤–∏–µ | `send`, `edit`, `delete` |
| CHAT_ID | ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è | `374573193` |
| MSG_TYPE | –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è | `start`, `dial`, `bridge`, `hangup` |
| MSG_ID | ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ TG | `63157` |
| UNIQUE_ID | Asterisk UniqueId | `1764493655.61` |
| TEXT | –¢–µ–∫—Å—Ç (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤) | `‚ùå –ê–±–æ–Ω–µ–Ω—Ç –Ω–µ –ø–æ–¥–Ω—è–ª —Ç—Ä—É–±–∫—É...` |


### HTTP –∑–∞–ø—Ä–æ—Å—ã (HTTP)
```
TIMESTAMP|HTTP|UNIQUE_ID|METHOD|URL|STATUS_CODE|REQUEST_JSON|RESPONSE_JSON
```

**–ü—Ä–∏–º–µ—Ä:**
```
2025-11-30 12:00:01,300|HTTP|1764500001.5|GET|http://localhost:8020/customer-name/0367/375296254070|200|{"phone":"375296254070"}|{"name":"–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å"}
```

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|----------|--------|
| TIMESTAMP | –í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ | `2025-11-30 12:00:01,300` |
| HTTP | –ú–∞—Ä–∫–µ—Ä HTTP | `HTTP` |
| UNIQUE_ID | Asterisk UniqueId | `1764500001.5` |
| METHOD | HTTP –º–µ—Ç–æ–¥ | `GET`, `POST` |
| URL | URL –∑–∞–ø—Ä–æ—Å–∞ | `http://localhost:8020/customer-name/...` |
| STATUS_CODE | –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ | `200`, `404` |
| REQUEST_JSON | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ | `{"phone":"..."}` |
| RESPONSE_JSON | –û—Ç–≤–µ—Ç (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤) | `{"name":"..."}` |
---

## üìû –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∑–≤–æ–Ω–∫–∞

```
# 1. Asterisk: –Ω–∞—á–∞–ª–æ –∑–≤–æ–Ω–∫–∞ (dial)
2025-11-30 12:00:01,100|AST|dial|1764500001.5|{"Phone":"375296254070","Exten":"151","CallType":1,...}

# 2. Telegram: –æ—Ç–ø—Ä–∞–≤–∫–∞ dial –∫–∞–∂–¥–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É
2025-11-30 12:00:01,250|TG|send|374573193|dial|45001|1764500001.5|üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ ‚òéÔ∏è151 ‚û°Ô∏è üí∞+375296254070
2025-11-30 12:00:01,280|TG|send|7889254605|dial|45002|1764500001.5|üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ ‚òéÔ∏è151 ‚û°Ô∏è üí∞+375296254070

# 3. Asterisk: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (bridge)
2025-11-30 12:00:15,500|AST|bridge|1764500001.5|{"Phone":"375296254070","BridgeUniqueid":"...",...}

# 4. Telegram: —É–¥–∞–ª–µ–Ω–∏–µ dial + –æ—Ç–ø—Ä–∞–≤–∫–∞ bridge
2025-11-30 12:00:15,600|TG|delete|374573193|dial|45001|1764500001.5|
2025-11-30 12:00:15,650|TG|send|374573193|bridge|45010|1764500001.5|‚òéÔ∏è151 üìû‚û°Ô∏è üí∞+375296254070 –ö–ª–∏–µ–Ω—Ç: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤

# 5. Asterisk: –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (hangup)
2025-11-30 12:02:30,000|AST|hangup|1764500001.5|{"Phone":"375296254070","CallStatus":"2",...}

# 6. Telegram: —É–¥–∞–ª–µ–Ω–∏–µ bridge + —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
2025-11-30 12:02:30,100|TG|delete|374573193|bridge|45010|1764500001.5|
2025-11-30 12:02:30,150|TG|send|374573193|hangup|45020|1764500001.5|‚úÖ–£—Å–ø–µ—à–Ω—ã–π –∑–≤–æ–Ω–æ–∫ üí∞+375296254070 ‚è±02:15
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

### –°–µ—Ä–≤–∏—Å logger.py
- **–ü–æ—Ä—Ç:** 8026
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–≤–æ–Ω–∫–∞
- **–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:** –§–∞–π–ª—ã `call_tracer/{enterprise}/events.log*`
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:** –ü–æ secret —Ç–æ–∫–µ–Ω—É –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è

### –°–µ—Ä–≤–∏—Å main.py
- **–ü–æ—Ä—Ç:** 8000
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–∏—ë–º —Å–æ–±—ã—Ç–∏–π –æ—Ç Asterisk —Ö–æ—Å—Ç–æ–≤, –∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª—ã
- **Workers:** 2 (uvicorn)

---

## üåê API Endpoints

### `GET /call/{enterprise_number}/{unique_id}?token=SECRET`

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–≤–æ–Ω–∫–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `enterprise_number` - –Ω–æ–º–µ—Ä –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è (0367)
- `unique_id` - Asterisk UniqueId –∑–≤–æ–Ω–∫–∞
- `token` - secret —Ç–æ–∫–µ–Ω –∏–∑ —Ç–∞–±–ª–∏—Ü—ã enterprises

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ –ë–î
2. –ß–∏—Ç–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã `call_tracer/{enterprise}/events.log*`
3. –ò—â–µ—Ç —Å—Ç—Ä–æ–∫–∏ —Å `unique_id`
4. –ü–∞—Ä—Å–∏—Ç AST –∏ TG —Å–æ–±—ã—Ç–∏—è
5. –û–±–æ–≥–∞—â–∞–µ—Ç –∏–º–µ–Ω–∞ —á–µ—Ä–µ–∑ metadata —Å–µ—Ä–≤–∏—Å (8020)
6. –†–µ–Ω–¥–µ—Ä–∏—Ç HTML —à–∞–±–ª–æ–Ω `call_details.html`

**–ü—Ä–∏–º–µ—Ä:**
```
GET http://localhost:8026/call/0367/1764493655.61?token=698c81fe16124c2e805f3a3a2ddedae0
```

### `GET /health`

–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞.

---

## üìù –ö–æ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –ú–æ–¥—É–ª—å `app/utils/call_tracer.py`

```python
import logging
import os
import json
from logging.handlers import TimedRotatingFileHandler
from typing import Dict

_call_tracer_loggers: Dict[str, logging.Logger] = {}

def get_call_tracer_logger(enterprise_number: str) -> logging.Logger:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–æ–≥–≥–µ—Ä –¥–ª—è —é–Ω–∏—Ç–∞, —Å–æ–∑–¥–∞—ë—Ç –ø–∞–ø–∫—É –∏ —Ñ–∞–π–ª –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏."""
    if enterprise_number in _call_tracer_loggers:
        return _call_tracer_loggers[enterprise_number]
    
    log_dir = f"call_tracer/{enterprise_number}"
    os.makedirs(log_dir, exist_ok=True)
    
    handler = TimedRotatingFileHandler(
        f"{log_dir}/events.log",
        when="midnight",
        interval=1,
        backupCount=14,
        encoding="utf-8"
    )
    handler.setFormatter(logging.Formatter("%(asctime)s|%(message)s"))
    handler.suffix = "%Y-%m-%d"
    
    tracer_logger = logging.getLogger(f"call_tracer_{enterprise_number}")
    tracer_logger.addHandler(handler)
    tracer_logger.setLevel(logging.INFO)
    tracer_logger.propagate = False
    
    _call_tracer_loggers[enterprise_number] = tracer_logger
    return tracer_logger


def log_telegram_event(
    enterprise_number: str,
    action: str,           # send, edit, delete
    chat_id: int,
    message_type: str,     # start, dial, bridge, hangup
    message_id: int,
    unique_id: str,
    text: str = ""
):
    """–õ–æ–≥–∏—Ä—É–µ—Ç Telegram —Å–æ–±—ã—Ç–∏–µ."""
    try:
        if not enterprise_number:
            return
        tracer = get_call_tracer_logger(enterprise_number)
        text_truncated = text[:200].replace('\n', ' ').replace('\r', '') if text else ""
        tracer.info(f"TG|{action}|{chat_id}|{message_type}|{message_id}|{unique_id}|{text_truncated}")
    except Exception as e:
        logging.warning(f"Failed to log telegram event: {e}")


def log_asterisk_event(
    enterprise_number: str,
    event_type: str,
    unique_id: str,
    body: dict
):
    """–õ–æ–≥–∏—Ä—É–µ—Ç Asterisk —Å–æ–±—ã—Ç–∏–µ."""
    try:
        if not enterprise_number:
            return
        tracer = get_call_tracer_logger(enterprise_number)
        tracer.info(f"AST|{event_type}|{unique_id}|{json.dumps(body, ensure_ascii=False)}")
    except Exception as e:
        logging.warning(f"Failed to log Asterisk event: {e}")
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ main.py

```python
from app.utils.call_tracer import log_asterisk_event

async def _dispatch_to_all(token: str, event_type: str, unique_id: str, body: dict):
    enterprise_number = await _get_enterprise_number_by_token(token)
    if enterprise_number:
        await log_asterisk_event(enterprise_number, event_type, unique_id, body)
        body["_enterprise_number"] = enterprise_number  # –î–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    # ... –¥–∞–ª—å–Ω–µ–π—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö

```python
from app.utils.call_tracer import log_telegram_event

# –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:
sent = await bot.send_message(chat_id, text)
log_telegram_event(
    enterprise_number=data.get("_enterprise_number", ""),
    action="send",
    chat_id=chat_id,
    message_type="dial",
    message_id=sent.message_id,
    unique_id=uid,
    text=text
)

# –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:
await bot.delete_message(chat_id, message_id)
log_telegram_event(
    enterprise_number=data.get("_enterprise_number", ""),
    action="delete",
    chat_id=chat_id,
    message_type="dial",
    message_id=message_id,
    unique_id=uid
)
```

---

## üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–í –ª–æ–≥–∞—Ö —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ `chat_id`. –ò–º—è –∏ email –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ –ë–î –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ HTML:

```sql
SELECT first_name, last_name, email 
FROM telegram_users 
WHERE tg_id = $1
```

---

## üîÑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–º

### –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞
```bash
./logger.sh start
./logger.sh stop
./logger.sh restart
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
```bash
curl http://localhost:8026/health
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
```bash
tail -f logs/logger.log
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–±—ã—Ç–∏–π —é–Ω–∏—Ç–∞
```bash
tail -f call_tracer/0367/events.log
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **PostgreSQL –±–æ–ª—å—à–µ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤. –¢–∞–±–ª–∏—Ü–∞ `call_traces` —É—Å—Ç–∞—Ä–µ–ª–∞.

2. **–§–∞–π–ª—ã –ª–æ–≥–æ–≤** - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–µ—Ç–∞–ª–µ–π –∑–≤–æ–Ω–∫–∞.

3. **–†–æ—Ç–∞—Ü–∏—è** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ UTC –≤—Ä–µ–º–µ–Ω–∏, —Ñ–∞–π–ª—ã –∏–º–µ–Ω—É—é—Ç—Å—è –¥–∞—Ç–æ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è.

4. **–•—Ä–∞–Ω–µ–Ω–∏–µ 14 –¥–Ω–µ–π** - —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è.

5. **–û–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - –∏–º–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å metadata (8020).

---

**–ê–≤—Ç–æ—Ä:** Claude (Cursor AI)  
**–î–ª—è:** –ï–≤–≥–µ–Ω–∏–π  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 30.11.2025
