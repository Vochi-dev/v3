# üìä Call Logger Service - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞.

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- **–ü–æ—Ä—Ç**: 8026
- **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: FastAPI, Pydantic, PostgreSQL (–≤ –±—É–¥—É—â–µ–º)
- **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö**: JSON
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤ –ë–î + —Ñ–∞–π–ª–æ–≤—ã–µ –ª–æ–≥–∏

## üìã –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∑–≤–æ–Ω–∫–æ–≤
- **Dial —Å–æ–±—ã—Ç–∏—è** - –Ω–∞—á–∞–ª–æ –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤
- **Bridge —Å–æ–±—ã—Ç–∏—è** - —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- **Hangup —Å–æ–±—ã—Ç–∏—è** - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤
- **–î—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è** - –Ω–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã, –ø–µ—Ä–µ–≤–æ–¥—ã –∏ —Ç.–¥.

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- –ó–∞–ø—Ä–æ—Å—ã –∫ —Å–µ—Ä–≤–∏—Å—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (8020)
- –ó–∞–ø—Ä–æ—Å—ã –∫ –≤–Ω–µ—à–Ω–∏–º API (MoySklad, RetailCRM)
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ —Å—Ç–∞—Ç—É—Å –∫–æ–¥—ã
- –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–π
- –ó–∞–ø—Ä–æ—Å—ã –∫ PostgreSQL
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –æ–ø–µ—Ä–∞—Ü–∏–π
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- ID —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —á–∞—Ç–æ–≤

## üåê API Endpoints

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### `GET /`
–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Ä–≤–∏—Å–µ

#### `POST /log/event`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "event_type": "dial",
  "event_data": {
    "Phone": "375296254070",
    "Extensions": ["150"],
    "Trunk": "0001363",
    "CallType": 1
  }
}
```

#### `POST /log/http`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "method": "GET",
  "url": "http://localhost:8020/metadata/0367/manager/150",
  "response_data": {
    "full_name": "–î–∂—É–Ω–æ–≤—ã–π –î–∂—É–ª–∞–π",
    "internal_phone": "150"
  },
  "status_code": 200,
  "duration_ms": 245.3
}
```

#### `POST /log/sql`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–∞
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "query": "SELECT raw_data->'ConnectedLineNum' FROM call_events WHERE raw_data->>'Token' = $1",
  "parameters": ["375293332255"],
  "result": {"internal_num": "150"},
  "duration_ms": 12.5
}
```

#### `POST /log/telegram`
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –æ–ø–µ—Ä–∞—Ü–∏–∏
```json
{
  "enterprise_number": "0367",
  "unique_id": "1759490248.0",
  "chat_id": 7055556176,
  "message_type": "dial",
  "message_id": 13165,
  "message_text": "üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...",
  "action": "send"
}
```

#### `GET /trace/{unique_id}`
–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–∞ –∑–≤–æ–Ω–∫–∞
```json
{
  "unique_id": "1759490248.0",
  "enterprise_number": "0367",
  "created_at": "2025-10-03T11:29:13",
  "updated_at": "2025-10-03T11:29:47",
  "timeline": [
    {
      "type": "call_event",
      "timestamp": "2025-10-03T11:29:13",
      "data": {
        "event_type": "dial",
        "event_data": {...}
      }
    },
    {
      "type": "http_request",
      "timestamp": "2025-10-03T11:29:14",
      "data": {
        "method": "GET",
        "url": "...",
        "duration_ms": 245.3
      }
    }
  ],
  "summary": {
    "total_events": 3,
    "http_requests": 5,
    "sql_queries": 2,
    "telegram_messages": 2
  }
}
```

#### `GET /search`
–ü–æ–∏—Å–∫ —Ç—Ä–µ–π—Å–æ–≤ –∑–≤–æ–Ω–∫–æ–≤
```
GET /search?enterprise=0367&phone=375296254070&limit=10
```

#### `GET /health`
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### CallTrace (–æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
```json
{
  "unique_id": "1759490248.0",
  "enterprise_number": "0367",
  "events": [...],           // –°–æ–±—ã—Ç–∏—è –∑–≤–æ–Ω–∫–∞
  "http_requests": [...],    // HTTP –∑–∞–ø—Ä–æ—Å—ã
  "sql_queries": [...],      // SQL –æ–ø–µ—Ä–∞—Ü–∏–∏
  "telegram_messages": [...], // Telegram –æ–ø–µ—Ä–∞—Ü–∏–∏
  "created_at": "2025-10-03T11:29:13",
  "updated_at": "2025-10-03T11:29:47"
}
```

### Event (—Å–æ–±—ã—Ç–∏–µ –∑–≤–æ–Ω–∫–∞)
```json
{
  "event_type": "dial|bridge|hangup|new_channel|etc",
  "event_data": {...},       // –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
  "timestamp": "2025-10-03T11:29:13"
}
```

### HttpRequest (HTTP –∑–∞–ø—Ä–æ—Å)
```json
{
  "method": "GET|POST|PUT|DELETE",
  "url": "http://localhost:8020/...",
  "request_data": {...},     // –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞
  "response_data": {...},    // –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞
  "status_code": 200,
  "duration_ms": 245.3,
  "timestamp": "2025-10-03T11:29:14"
}
```

### SqlQuery (SQL –∑–∞–ø—Ä–æ—Å)
```json
{
  "query": "SELECT ...",
  "parameters": [...],       // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
  "result": {...},          // –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
  "duration_ms": 12.5,
  "timestamp": "2025-10-03T11:29:15"
}
```

### TelegramMessage (Telegram –æ–ø–µ—Ä–∞—Ü–∏—è)
```json
{
  "chat_id": 7055556176,
  "message_type": "dial|bridge|hangup",
  "message_id": 13165,
  "message_text": "...",
  "action": "send|edit|delete",
  "timestamp": "2025-10-03T11:29:16"
}
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–≤–æ–Ω–∫–∞

### 1. Dial —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç dial —Å–æ–±—ã—Ç–∏–µ –æ—Ç —Ö–æ—Å—Ç–∞
2. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/event
3. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ 8020
4. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
6. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
```

### 2. Bridge —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç bridge —Å–æ–±—ã—Ç–∏–µ
2. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/event
3. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è
4. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
6. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
```

### 3. Hangup —Å–æ–±—ã—Ç–∏–µ
```
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç hangup —Å–æ–±—ã—Ç–∏–µ
2. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/event
3. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ internal_phone
4. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/sql
5. –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è HTTP –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è
6. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ /log/http
7. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
8. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
9. –£–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
10. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ /log/telegram
```

## üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º

### –í dial.py
```python
import httpx

async def log_call_event(enterprise, unique_id, event_type, data):
    async with httpx.AsyncClient() as client:
        await client.post("http://localhost:8026/log/event", json={
            "enterprise_number": enterprise,
            "unique_id": unique_id,
            "event_type": event_type,
            "event_data": data
        })

async def log_http_request(enterprise, unique_id, method, url, response_data, status_code, duration_ms):
    async with httpx.AsyncClient() as client:
        await client.post("http://localhost:8026/log/http", json={
            "enterprise_number": enterprise,
            "unique_id": unique_id,
            "method": method,
            "url": url,
            "response_data": response_data,
            "status_code": status_code,
            "duration_ms": duration_ms
        })
```

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### –≠—Ç–∞–ø 1 (–¢–µ–∫—É—â–∏–π - –∑–∞–≥–ª—É—à–∫–∞)
- ‚úÖ –ë–∞–∑–æ–≤—ã–π API
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –ø–∞–º—è—Ç–∏
- ‚úÖ –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫

### –≠—Ç–∞–ø 2 (PostgreSQL)
- üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ PostgreSQL
- üîÑ –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- üîÑ –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º

### –≠—Ç–∞–ø 3 (–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
- üîÑ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—Ä–µ–π—Å–æ–≤
- üîÑ –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ —Å–æ–±—ã—Ç–∏–π
- üîÑ –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫

### –≠—Ç–∞–ø 4 (–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
- üîÑ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏
- üîÑ –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- üîÑ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
- üîÑ API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º

## üöÄ –ó–∞–ø—É—Å–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
```bash
# –ó–∞–ø—É—Å–∫
./logger.sh start

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
./logger.sh stop

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
./logger.sh restart

# –°—Ç–∞—Ç—É—Å
./logger.sh status
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
curl http://localhost:8026/health

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–∏—Å–µ
curl http://localhost:8026/
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞
- –§–∞–π–ª: `logs/logger.log`
- –§–æ—Ä–º–∞—Ç: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Python logging
- –†–æ—Ç–∞—Ü–∏—è: –ü–æ —Ä–∞–∑–º–µ—Ä—É (10MB)

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–π—Å–æ–≤
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –°–µ—Ä–≤–∏—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç --reload –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ç–æ—Ä–º–æ–∑–æ–≤
2. **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ (–±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ)
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ localhost
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

- **8000** - –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏)
- **8020** - –°–µ—Ä–≤–∏—Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–∏—Å—Ç–æ—á–Ω–∏–∫ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤)
- **PostgreSQL** - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–±—É–¥—É—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: 1.0.0  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: 2025-10-03  
**–ê–≤—Ç–æ—Ä**: Call Logger Service Team
