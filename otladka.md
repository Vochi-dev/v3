# üîß –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ—Ç–ª–∞–¥–∫–µ —Å–∏—Å—Ç–µ–º—ã —Å–æ–±—ã—Ç–∏–π Asterisk

## üìç –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤

### **–°–µ—Ä–≤–∏—Å 8025 (–≠–º—É–ª—è—Ç–æ—Ä —Å–æ–±—ã—Ç–∏–π)**
- **–û—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥ —Å–æ–±—ã—Ç–∏–π:** `/root/asterisk-webhook/logs/call_tester_events.log`
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- **–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
  - –í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (dial, bridge_create, bridge, bridge_leave, bridge_destroy, hangup, new_callerid)
  - –ü–æ–ª–Ω—ã–µ JSON –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
  - HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤
  - –°—Ç–∞—Ç—É—Å—ã –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ bot.vochi.by
  - –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö –¥–µ—Ç–∞–ª–∏
  - –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã:**
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ª–æ–≥–æ–≤ —ç–º—É–ª—è—Ç–æ—Ä–∞
cat logs/call_tester_events.log

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
tail -n 100 logs/call_tester_events.log

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f logs/call_tester_events.log

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞ –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
cat /dev/null > logs/call_tester_events.log

# –ü–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
grep -A 10 "üöÄ EMULATION" logs/call_tester_events.log

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
grep "ERROR" logs/call_tester_events.log
```

---

### **–°–µ—Ä–≤–∏—Å 8000 (–û—Å–Ω–æ–≤–Ω–æ–π webhook-—Å–µ—Ä–≤–µ—Ä) - –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ 0367/june**
- **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ª–æ–≥ –¥–ª—è 0367:** `/root/asterisk-webhook/logs/0367.log`
- **Token:** `375293332255`
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π —Ç–æ–ª—å–∫–æ –æ—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0367 (june)
- **–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
  - –¢–∏–ø —Å–æ–±—ã—Ç–∏—è (start, dial, bridge, hangup –∏ —Ç.–¥.)
  - Token –∏ UniqueId
  - –ü–æ–ª–Ω–æ–µ —Ç–µ–ª–æ —Å–æ–±—ã—Ç–∏—è –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
  - –≠–º–æ–¥–∑–∏-–º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã:**
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π 0367
cat logs/0367.log

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
tail -n 50 logs/0367.log

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f logs/0367.log

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞ –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
cat /dev/null > logs/0367.log

# –ü–æ–∏—Å–∫ –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
grep "hangup" logs/0367.log
grep "bridge" logs/0367.log

# –ü–æ–∏—Å–∫ –ø–æ UniqueId
grep "1759225684.16" logs/0367.log

# –ü–æ–¥—Å—á–µ—Ç —Å–æ–±—ã—Ç–∏–π –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
grep "üß™ TEST EVENT:" logs/0367.log | awk '{print $NF}' | sort | uniq -c
```

---

### **–°–µ—Ä–≤–∏—Å 8000 (–û—Å–Ω–æ–≤–Ω–æ–π webhook-—Å–µ—Ä–≤–µ—Ä) - –í—Å–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è**
- **–û—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥:** `/root/asterisk-webhook/logs/app.log`
- **Uvicorn –ª–æ–≥:** `/root/asterisk-webhook/logs/uvicorn.log`
- **–õ–æ–≥ –¥–æ—Å—Ç—É–ø–∞:** `/root/asterisk-webhook/logs/access.log`
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±—â–∏–µ –ª–æ–≥–∏ –æ—Ç –≤—Å–µ—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π (—Å–æ—Ç–Ω–∏ —Ö–æ—Å—Ç–æ–≤)
- **–§–æ—Ä–º–∞—Ç:** `%(asctime)s [%(levelname)s] %(name)s: %(message)s`
- **–†–æ—Ç–∞—Ü–∏—è:** 10MB –Ω–∞ —Ñ–∞–π–ª, 5 –±—ç–∫–∞–ø–æ–≤

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã:**
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–æ–≥–∞
tail -f logs/app.log

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ Token 0367
grep "375293332255" logs/app.log

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
grep "ERROR" logs/app.log
```

---

## üß™ –¢–∏–ø–∏—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–ª–∞–¥–∫–∏

### **–®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞**
```bash
# –û—á–∏—â–∞–µ–º –ª–æ–≥–∏ —ç–º—É–ª—è—Ç–æ—Ä–∞ –∏ 0367
cat /dev/null > logs/call_tester_events.log
cat /dev/null > logs/0367.log
```

### **–®–∞–≥ 2: –≠–º—É–ª—è—Ü–∏—è —Å–æ–±—ã—Ç–∏—è**
- –û—Ç–∫—Ä—ã—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: https://bot.vochi.by/test-interface
- –í—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
- –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É
- –ù–∞–∂–∞—Ç—å "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏—è"

### **–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Å–µ—Ä–≤–∏—Å 8025)**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å
tail -50 logs/call_tester_events.log | grep "üì• EMULATION RESPONSE"
```

### **–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è (—Å–µ—Ä–≤–∏—Å 8000)**
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –ø–æ–ª—É—á–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
tail -50 logs/0367.log
```

### **–®–∞–≥ 5: –ê–Ω–∞–ª–∏–∑**
- –°—Ä–∞–≤–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∏ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –í—ã—è–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥–æ–≤ 0367.log

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏:**
```
2025-10-01 14:23:45,123 [INFO] üß™ TEST EVENT: hangup
2025-10-01 14:23:45,124 [INFO] üìã Token: 375293332255, UniqueId: 1759230684.16
2025-10-01 14:23:45,125 [INFO] üì¶ Full Body: {
  "Token": "375293332255",
  "CallStatus": "2",
  "Phone": "152",
  "ExternalInitiated": true,
  "Trunk": "",
  "Extensions": ["150"],
  "UniqueId": "1759230684.16",
  "StartTime": "",
  "DateReceived": "2025-09-30 11:15:02",
  "EndTime": "2025-09-30 11:15:12",
  "CallType": 0
}
```

---

## üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤

**‚ùå –ù–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:**
```bash
./all.sh restart  # –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º —Å –∑–∞–ø—É—Å–∫–æ–º –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:**
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ 8000
./main.sh restart

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —ç–º—É–ª—è—Ç–æ—Ä–∞ 8025
./call_tester.sh restart
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ - —Å–æ–æ–±—â–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –æ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç `./all.sh restart` –≤—Ä—É—á–Ω—É—é.

---

## üéØ –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã

```bash
# –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç–º—É–ª—è—Ç–æ—Ä–∞ –∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
tail -f logs/call_tester_events.log logs/0367.log

# –û—á–∏—Å—Ç–∫–∞ –æ–±–æ–∏—Ö –ª–æ–≥–æ–≤
cat /dev/null > logs/call_tester_events.log && cat /dev/null > logs/0367.log && echo "‚úÖ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã"

# –ü–æ–¥—Å—á–µ—Ç —Å–æ–±—ã—Ç–∏–π –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
echo "–°–æ–±—ã—Ç–∏—è –æ—Ç —ç–º—É–ª—è—Ç–æ—Ä–∞:" && grep -c "üì• EMULATION RESPONSE" logs/call_tester_events.log
echo "–°–æ–±—ã—Ç–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ 0367:" && grep -c "üß™ TEST EVENT" logs/0367.log

# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–±—ã—Ç–∏—è
echo "=== –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ ===" && grep "üìä Event Data:" logs/call_tester_events.log | tail -1
echo "=== –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ ===" && grep "üß™ TEST EVENT" logs/0367.log | tail -1
```

---

---

## üîÑ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π

### **–û–±—â–∞—è —Å—Ö–µ–º–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        –í–•–û–î–Ø–©–ï–ï –°–û–ë–´–¢–ò–ï –û–¢ ASTERISK                         ‚îÇ
‚îÇ                      (—Ö–æ—Å—Ç 10.88.10.xxx –∏–ª–∏ —ç–º—É–ª—è—Ç–æ—Ä)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚îÇ
                                   ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ     main.py (–ø–æ—Ä—Ç 8000)      ‚îÇ
                    ‚îÇ  POST /start, /dial, /bridge ‚îÇ
                    ‚îÇ  /hangup, /bridge_create –∏ —Ç.–¥‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚ñº                ‚ñº                ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ  ‚îÇ ‚îÇ 2. –°–£–ë–î    ‚îÇ ‚îÇ 3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è  ‚îÇ
    ‚îÇ logs/0367.log   ‚îÇ ‚îÇ PostgreSQL ‚îÇ ‚îÇ –≤—Ö–æ–¥—è—â–∏—Ö –Ω–æ–º–µ—Ä–æ–≤ ‚îÇ
    ‚îÇ logs/app.log    ‚îÇ ‚îÇcall_events ‚îÇ ‚îÇ (–ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –ª–∏–Ω–∏–∏)‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   _dispatch_to_all(handler)  ‚îÇ
                    ‚îÇ - –ù–∞—Ö–æ–¥–∏—Ç bot_token –ø–æ Token ‚îÇ
                    ‚îÇ - –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ tg_ids     ‚îÇ
                    ‚îÇ - –í—ã–∑—ã–≤–∞–µ—Ç handler –¥–ª—è –∫–∞–∂–¥–æ–≥–æ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚ñº                ‚ñº                ‚ñº                 ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  TELEGRAM BOT   ‚îÇ ‚îÇ –°–µ—Ä–≤–∏—Å     ‚îÇ ‚îÇ RetailCRM    ‚îÇ ‚îÇ –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è  ‚îÇ
    ‚îÇ app/services/   ‚îÇ ‚îÇ 8020       ‚îÇ ‚îÇ –°–µ—Ä–≤–∏—Å 8019  ‚îÇ ‚îÇ CRM (TODO)   ‚îÇ
    ‚îÇ calls/*         ‚îÇ ‚îÇIntegration ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ
    ‚îÇ                 ‚îÇ ‚îÇ Gateway    ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üì® –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ Telegram

### **–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: `main.py`**

**–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —Å–æ–±—ã—Ç–∏–π Asterisk:**
- `POST /start` ‚Üí `_dispatch_to_all(process_start, body)`
- `POST /dial` ‚Üí `_dispatch_to_all(process_dial, body)`
- `POST /bridge` ‚Üí `_dispatch_to_all(process_bridge, body)`
- `POST /hangup` ‚Üí `_dispatch_to_all(process_hangup, body)`
- `POST /bridge_create` ‚Üí `_dispatch_to_all(process_bridge_create, body)`
- `POST /bridge_leave` ‚Üí `_dispatch_to_all(process_bridge_leave, body)`
- `POST /bridge_destroy` ‚Üí `_dispatch_to_all(process_bridge_destroy, body)`
- `POST /new_callerid` ‚Üí `_dispatch_to_all(process_new_callerid, body)`

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/root/asterisk-webhook/main.py`
- –°—Ç—Ä–æ–∫–∏ 434-517: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

### **–§—É–Ω–∫—Ü–∏—è `_dispatch_to_all` (main.py, —Å—Ç—Ä–æ–∫–∞ 651)**

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä —Å–æ–±—ã—Ç–∏–π

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç `Token` –∏ `UniqueId` –∏–∑ —Ç–µ–ª–∞ —Å–æ–±—ã—Ç–∏—è
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è (start, dial, bridge, hangup –∏ —Ç.–¥.)
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ 0367:** –ï—Å–ª–∏ `Token == "375293332255"` ‚Üí –ø–∏—à–µ—Ç –≤ `logs/0367.log`
4. –ü—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –Ω–æ–º–µ—Ä–æ–≤ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è)
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ PostgreSQL (`call_events` —Ç–∞–±–ª–∏—Ü–∞)
6. –ù–∞—Ö–æ–¥–∏—Ç `bot_token` –ø–æ `Token` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `enterprises`
7. –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ `tg_ids` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `telegram_users`
8. –î–ª—è –∫–∞–∂–¥–æ–≥–æ `chat_id` –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π `handler`
9. –î–ª—è `hangup` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—â–∏–π UUID —Ç–æ–∫–µ–Ω –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
10. –û—Ç–º–µ—á–∞–µ—Ç —É—Å–ø–µ—à–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –≤ –ë–î (`telegram_sent = true`)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/root/asterisk-webhook/main.py:651-745`

---

## ü§ñ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Telegram

### **–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** `/root/asterisk-webhook/app/services/calls/`

### **–û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (—Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è):**

#### **1. process_start** (`start.py`)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞
- **–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:** `"üìû –ó–≤–æ–Ω–æ–∫ –æ—Ç {–Ω–æ–º–µ—Ä} ‚Üí {–¥–æ–±–∞–≤–æ—á–Ω—ã–π}"`
- **–õ–æ–≥–∏–∫–∞:**
  - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –∑–∞–º–µ–Ω–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `asterisk_logs`
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ `bridge_store` –∏ `phone_message_tracker`
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/root/asterisk-webhook/app/services/calls/start.py`

#### **2. process_dial** (`dial.py`)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è –Ω–∞–±–æ—Ä–∞ –Ω–æ–º–µ—Ä–∞ (–¥–æ–∑–≤–æ–Ω)
- **–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:** `"üìû –î–æ–∑–≤–æ–Ω –æ—Ç {–Ω–æ–º–µ—Ä} ‚Üí {–¥–æ–±–∞–≤–æ—á–Ω—ã–µ}"`
- **–õ–æ–≥–∏–∫–∞:**
  - –ó–∞–º–µ–Ω—è–µ—Ç –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–µ `start` —Å–æ–æ–±—â–µ–Ω–∏–µ
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö Extensions (–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
  - –û–±–æ–≥–∞—â–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞, –§–ò–û –º–µ–Ω–µ–¥–∂–µ—Ä–∞)
  - **Fire-and-forget –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Integration Gateway (8020)**
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `asterisk_logs`
- **–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ 8020:**
  - URL: `http://localhost:8020/dispatch/call-event`
  - Payload: `{ token, uniqueId, event_type: "dial", raw: {...} }`
  - –¢–∞–π–º–∞—É—Ç: 2 —Å–µ–∫—É–Ω–¥—ã
  - –°—Ç—Ä–æ–∫–∏ 203-237
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/root/asterisk-webhook/app/services/calls/dial.py`

#### **3. process_bridge** (`bridge.py`)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∞–±–æ–Ω–µ–Ω—Ç–æ–≤
- **–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:** `"üîó –†–∞–∑–≥–æ–≤–æ—Ä: {–Ω–æ–º–µ—Ä} ‚Üî {–¥–æ–±–∞–≤–æ—á–Ω—ã–π}"`
- **–õ–æ–≥–∏–∫–∞:**
  - –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–π bridge (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥—É–±–ª–µ–π)
  - –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (–ë–ï–ó –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–∂–∏–¥–∞–Ω–∏—è 5 —Å–µ–∫—É–Ω–¥)
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ bridge –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ `bridge_store` –∏ `active_bridges`
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `asterisk_logs`
- **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ bridge.py:**
  - `process_bridge_create` - —Å–æ–∑–¥–∞–Ω–∏–µ –º–æ—Å—Ç–∞
  - `process_bridge_leave` - –≤—ã—Ö–æ–¥ –∏–∑ –º–æ—Å—Ç–∞
  - `process_bridge_destroy` - —Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ –º–æ—Å—Ç–∞
  - `process_new_callerid` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CallerID
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/root/asterisk-webhook/app/services/calls/bridge.py`

#### **4. process_hangup** (`hangup.py`)
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
- **–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:** 
  - `"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω: {–Ω–æ–º–µ—Ä} ‚Üî {–¥–æ–±–∞–≤–æ—á–Ω—ã–π}, {–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å}"`
  - `"‚ùå –ù–µ –æ—Ç–≤–µ—á–µ–Ω: {–Ω–æ–º–µ—Ä} ‚Üí {–¥–æ–±–∞–≤–æ—á–Ω—ã–π}"`
- **–õ–æ–≥–∏–∫–∞:**
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: –æ—Ç–≤–µ—Ç–∏–ª–∏ (CallStatus="2") –∏–ª–∏ –Ω–µ—Ç
  - –†–∞—Å—á–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–≤–æ–Ω–∫–∞
  - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `calls` (PostgreSQL)
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤ (`customers`)
  - **Fire-and-forget –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Integration Gateway (8020)**
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è `uuid_token` –¥–ª—è —Å–≤—è–∑–∏ —Å –∑–∞–ø–∏—Å—å—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö Extensions
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `asterisk_logs` –∏ `telegram_messages`
- **–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ 8020:**
  - URL: `http://localhost:8020/dispatch/call-event`
  - Payload: `{ token, uniqueId, event_type: "hangup", raw: {...} }`
  - –¢–∞–π–º–∞—É—Ç: 2 —Å–µ–∫—É–Ω–¥—ã
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/root/asterisk-webhook/app/services/calls/hangup.py`

### **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–≤–æ–Ω–∫–∏ (internal.py):**

#### **5. process_internal_start** (`internal.py`)
- **–¢–µ–∫—Å—Ç:** `"üõéÔ∏è –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∑–≤–æ–Ω–æ–∫\n{caller} ‚Üí {callee}"`
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** –û–±–æ–≥–∞—â–µ–Ω–∏–µ –§–ò–û –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

#### **6. process_internal_bridge** (`internal.py`)
- **–¢–µ–∫—Å—Ç:** `"üîó –†–∞–∑–≥–æ–≤–æ—Ä (–≤–Ω—É—Ç—Ä.): {caller} ‚Üî {callee}"`

#### **7. process_internal_hangup** (`internal.py`)
- **–¢–µ–∫—Å—Ç:** `"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω (–≤–Ω—É—Ç—Ä.): {caller} ‚Üî {callee}, {–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å}"`
- **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:** 
  - –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `calls` —Å `CallType=2`
  - –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Integration Gateway (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–≤–æ–Ω–∫–∏)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/root/asterisk-webhook/app/services/calls/internal.py`

---

## üîß –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏

### **utils.py** - –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- `format_phone_number()` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤
- `is_internal_number()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –Ω–æ–º–µ—Ä–∞
- `get_phone_for_grouping()` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π
- `should_send_as_comment()` - –ª–æ–≥–∏–∫–∞: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- `should_replace_previous_message()` - –ª–æ–≥–∏–∫–∞ –∑–∞–º–µ–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- In-memory –∫—ç—à–∏: `dial_cache`, `bridge_store`, `active_bridges`, `phone_message_tracker`
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/root/asterisk-webhook/app/services/calls/utils.py`

### **–í–µ—Ä—Å–∏—è v2 (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏):**
- `start_v2.py` - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è start
- `dial_v2.py` - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è dial
- `bridge_v2.py` - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è bridge (–ø—Ä–∞–≤–∏–ª–æ: "–æ–¥–∏–Ω bridge –Ω–∞ –∑–≤–æ–Ω–æ–∫")
- `hangup_v2.py` - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è hangup

**–°—Ç–∞—Ç—É—Å:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ (–±–µ–∑ v2), v2 - —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ

---

## üîå –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Integration Gateway (8020)

### **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π –≤–æ –≤–Ω–µ—à–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (RetailCRM, –ú–æ–π–°–∫–ª–∞–¥, U-ON –∏ —Ç.–¥.)

### **–°–µ—Ä–≤–∏—Å:** `integration_cache.py` (–ø–æ—Ä—Ç 8020)

### **–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `POST /dispatch/call-event`

**Payload:**
```json
{
  "token": "375293332255",
  "uniqueId": "1759310248.0",
  "event_type": "dial" | "hangup",
  "raw": { /* –ø–æ–ª–Ω–æ–µ —Ç–µ–ª–æ —Å–æ–±—ã—Ç–∏—è –æ—Ç Asterisk */ }
}
```

### **–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã 8020:**
1. –ù–∞—Ö–æ–¥–∏—Ç `enterprise_number` –ø–æ `token` –≤ –ë–î
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–∑ in-memory –∫—ç—à–∞ (TTL ~90 —Å–µ–∫)
3. –î–ª—è `retailcrm: true` ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ —Å–µ—Ä–≤–∏—Å 8019
4. –î–ª—è `hangup` –±–µ–∑ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–µ–≥–æ `dial` ‚Üí —Å–æ–∑–¥–∞–µ—Ç —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π dial
5. –õ–æ–≥–∏—Ä—É–µ—Ç –≤ `integration_logs` —Ç–∞–±–ª–∏—Ü—É

### **–û—Ç–∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
- **dial.py** (—Å—Ç—Ä–æ–∫–∏ 203-237): –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram, fire-and-forget
- **hangup.py**: –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ `calls`, fire-and-forget
- **–¢–∞–π–º–∞—É—Ç:** 2 —Å–µ–∫—É–Ω–¥—ã
- **–†–µ–∂–∏–º:** `asyncio.create_task()` - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç Asterisk

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞:** `/root/asterisk-webhook/integration_cache.py`

---

## üõí RetailCRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (8019)

### **–°–µ—Ä–≤–∏—Å:** `retailcrm.py` (–ø–æ—Ä—Ç 8019)

### **–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `POST /internal/retailcrm/call-event`

**–ü—Ä–∏–µ–º —Ç–æ–ª—å–∫–æ —Å localhost** (–∑–∞—â–∏—Ç–∞ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)

### **–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç payload –Ω–∞ –æ—Å–Ω–æ–≤–µ `raw` –¥–∞–Ω–Ω—ã—Ö
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ RetailCRM API:
   - **–†–µ–∞–ª—Ç–∞–π–º:** `POST /api/v5/telephony/call/event`
   - **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ (hangup):** `POST /api/v5/telephony/calls/upload`
3. –†–µ—Ç—Ä–∞–∏: 2-3 –ø–æ–ø—ã—Ç–∫–∏
4. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ `(enterprise, callExternalId, type)`
5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `integration_logs`

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞:** `/root/asterisk-webhook/retailcrm.py`

---

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (PostgreSQL)

### **–¢–∞–±–ª–∏—Ü–∞ `call_events`** - –°–æ–±—ã—Ç–∏—è –æ—Ç Asterisk
- `unique_id` - UniqueId –∑–≤–æ–Ω–∫–∞
- `event_type` - —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è (start, dial, bridge, hangup)
- `event_timestamp` - –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è
- `data_source` - –∏—Å—Ç–æ—á–Ω–∏–∫ ('live', 'recovery')
- `raw_data` - JSON —Å –ø–æ–ª–Ω—ã–º —Ç–µ–ª–æ–º —Å–æ–±—ã—Ç–∏—è
- `telegram_sent` - —Ñ–ª–∞–≥ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram

**–°–µ—Ä–≤–∏—Å –∑–∞–ø–∏—Å–∏:** `app/services/events.py` ‚Üí `save_asterisk_event()`

### **–¢–∞–±–ª–∏—Ü–∞ `calls`** - –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∏
- `uuid` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –∑–≤–æ–Ω–∫–∞
- `unique_id` - UniqueId –æ—Ç Asterisk
- `enterprise_number` - –Ω–æ–º–µ—Ä –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
- `phone` - –≤–Ω–µ—à–Ω–∏–π –Ω–æ–º–µ—Ä
- `extension` - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–æ–±–∞–≤–æ—á–Ω—ã–π
- `call_type` - —Ç–∏–ø (0=–≤–Ω–µ—à–Ω–∏–π, 1=–∏—Å—Ö–æ–¥—è—â–∏–π, 2=–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)
- `call_status` - —Å—Ç–∞—Ç—É—Å (0=–Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∏, 2=–æ—Ç–≤–µ—Ç–∏–ª–∏)
- `date_received` - –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
- `date_end` - –≤—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- `duration` - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
- `record_url` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–ø–∏—Å—å (–µ—Å–ª–∏ –µ—Å—Ç—å)

**–°–µ—Ä–≤–∏—Å –∑–∞–ø–∏—Å–∏:** `app/services/calls/hangup.py` ‚Üí `create_call_record()`

### **–¢–∞–±–ª–∏—Ü–∞ `enterprises`** - –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
- `name` - –Ω–æ–º–µ—Ä –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è (0367, 0270, –∏ —Ç.–¥.)
- `name2` - Token –¥–ª—è Asterisk (375293332255 –¥–ª—è 0367/june)
- `bot_token` - —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
- `integrations_config` - JSON —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

### **–¢–∞–±–ª–∏—Ü–∞ `telegram_users`** - –ü–æ–¥–ø–∏—Å—á–∏–∫–∏
- `tg_id` - Telegram chat_id
- `bot_token` - –∫ –∫–∞–∫–æ–º—É –±–æ—Ç—É –ø—Ä–∏–≤—è–∑–∞–Ω
- `enterprise_number` - –Ω–æ–º–µ—Ä –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è

---

## üéØ –ü–ª–∞–Ω –æ—Ç–ª–∞–¥–∫–∏ Telegram-–æ—Ç–ø—Ä–∞–≤–∫–∏

### **–§–∞–∑–∞ 1: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è** ‚úÖ
- ‚úÖ –ò–∑—É—á–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ù–∞–π–¥–µ–Ω—ã –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ç–æ—á–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª otladka.md

### **–§–∞–∑–∞ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram** (TODO)
**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∏ —Ñ–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –≤ Telegram

**–ó–∞–¥–∞—á–∏:**
1. –≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∑–≤–æ–Ω–∫–∞ (start ‚Üí dial ‚Üí bridge ‚Üí hangup)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ `0367.log` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram –±–æ—Ç–µ
4. –°—Ä–∞–≤–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –æ–∂–∏–¥–∞–µ–º—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
5. –í—ã—è–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏

**–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–µ—Å–∫–æ–ª—å–∫–æ bridge)
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ –Ω–æ–º–µ—Ä—É
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞/–º–µ–Ω–µ–¥–∂–µ—Ä–∞)
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–ø–∏—Å–µ–π —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤

### **–§–∞–∑–∞ 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º** (TODO)

### **–§–∞–∑–∞ 4: –û—Ç–ª–∞–¥–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Integration Gateway (8020)** (TODO)

### **–§–∞–∑–∞ 5: –û—Ç–ª–∞–¥–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é CRM** (TODO)

---

---

## üîó –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏ 8000 ‚Üî 8020

### **–ü—Ä–æ–±–ª–µ–º–∞:**
–í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—ã–ª–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ —Å–≤—è–∑—å –º–µ–∂–¥—É –æ—Å–Ω–æ–≤–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º 8000 –∏ Integration Cache 8020. –°–µ—Ä–≤–∏—Å 8020 –¥–µ—Ä–∂–∏—Ç –≤ –ø–∞–º—è—Ç–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –≤ Telegram:
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
- –ò–º–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ CRM
- –ü—Ä–æ—Ñ–∏–ª–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
- –ù–∞–∑–≤–∞–Ω–∏—è –ª–∏–Ω–∏–π –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤

### **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (2025-10-01 09:13):**

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ 8020:**
```json
{
  "hits": 0,
  "misses": 696,
  "cache_size": 0,           // ‚ùå –ö–†–ò–¢–ò–ß–ù–û: –ü—É—Å—Ç–æ–π –∫—ç—à —Å—Ç–∞—Ç—É—Å–æ–≤
  "config_cache_size": 1,    // ‚úÖ OK: –ï—Å—Ç—å 1 –∫–æ–Ω—Ñ–∏–≥
  "hit_rate_percent": 0.0,   // ‚ùå –ö–†–ò–¢–ò–ß–ù–û: 0% –ø–æ–ø–∞–¥–∞–Ω–∏–π
  "last_full_refresh": "2025-10-01T09:36:31"
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ endpoints:**
```bash
# ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è number=0367
curl http://127.0.0.1:8020/integrations/0367
‚Üí {"integrations": {"ms": true, "uon": true, "retailcrm": true, ...}}

# ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è name=june
curl http://127.0.0.1:8020/integrations/june  
‚Üí {"detail": "Enterprise not found"}

# ‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
curl http://127.0.0.1:8020/customer-name/0367/37052628760
‚Üí {"name": null}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. **–ö—ç—à —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—É—Å—Ç–æ–π** (`cache_size: 0`) - –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
2. **100% –ø—Ä–æ–º–∞—Ö–æ–≤** - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –≤ –ë–î, –Ω–µ—Ç benefit –æ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
3. **–ü–æ–∏—Å–∫ –ø–æ name –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** - —Å–µ—Ä–≤–∏—Å –∏—â–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ `number`, –∞ –Ω–µ –ø–æ `name`
4. **–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤** - –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã primary –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CRM

### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    main.py (8000)                            ‚îÇ
‚îÇ  - process_dial, process_bridge, process_hangup             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚îÇ httpx.AsyncClient
                      ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  metadata_client.py            ‚îÇ
         ‚îÇ  - get_customer_name()         ‚îÇ
         ‚îÇ  - get_customer_profile()      ‚îÇ
         ‚îÇ  - get_manager_name()          ‚îÇ
         ‚îÇ  - enrich_message_data()       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚îÇ GET http://localhost:8020/...
                  ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   integration_cache.py (8020)            ‚îÇ
    ‚îÇ                                          ‚îÇ
    ‚îÇ  Endpoints:                              ‚îÇ
    ‚îÇ  - /integrations/{enterprise_number}     ‚îÇ
    ‚îÇ  - /config/{enterprise_number}           ‚îÇ
    ‚îÇ  - /customer-name/{ent}/{phone}          ‚îÇ
    ‚îÇ  - /customer-profile/{ent}/{phone}       ‚îÇ
    ‚îÇ  - /metadata/{ent}/manager/{ext}         ‚îÇ
    ‚îÇ  - /metadata/{ent}/line/{line_id}        ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚îÇ 1. Check in-memory cache
               ‚îÇ 2. If miss ‚Üí PostgreSQL
               ‚îÇ 3. If still no data ‚Üí call CRM services
               ‚îÇ
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚ñº        ‚ñº        ‚ñº          ‚ñº         ‚ñº
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ DB ‚îÇ  ‚îÇ8019‚îÇ  ‚îÇ 8023 ‚îÇ  ‚îÇ 8022 ‚îÇ  ‚îÇ  8024  ‚îÇ
   ‚îÇ    ‚îÇ  ‚îÇRCR ‚îÇ  ‚îÇ  MS  ‚îÇ  ‚îÇ UON  ‚îÇ  ‚îÇBitrix  ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **–†–µ—à–µ–Ω–∏–µ:**

#### **–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ 8020**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω
./integration_cache.sh status

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -50 logs/integration_cache.log | grep -E "(ERROR|WARNING|üìä|üîÑ)"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
curl http://127.0.0.1:8020/stats | jq
```

#### **–®–∞–≥ 2: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞**
```bash
# –û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Å—å –∫—ç—à –∏–∑ –ë–î
curl -X POST http://127.0.0.1:8020/cache/refresh

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
curl http://127.0.0.1:8020/stats | jq '.cache_size, .hit_rate_percent'
```

#### **–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –æ–±–æ–≥–∞—â–µ–Ω–∏—è**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞
curl http://127.0.0.1:8020/customer-name/0367/375296254070

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞  
curl http://127.0.0.1:8020/customer-profile/0367/375296254070

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
curl http://127.0.0.1:8020/metadata/0367/manager/151
```

#### **–®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ primary –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
SELECT number, integrations_config->'smart' as smart_config 
FROM enterprises 
WHERE number = '0367';

-- –ï—Å–ª–∏ –Ω–µ—Ç primary –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
UPDATE enterprises 
SET integrations_config = jsonb_set(
    COALESCE(integrations_config, '{}'::jsonb),
    '{smart,primary}',
    '"retailcrm"'
)
WHERE number = '0367';

-- –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
curl -X POST http://127.0.0.1:8020/cache/invalidate/0367
```

#### **–®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞**
```bash
# 1. –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
cat /dev/null > logs/0367.log

# 2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ —á–µ—Ä–µ–∑ —ç–º—É–ª—è—Ç–æ—Ä (dial —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º)

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
grep "customer_name\|full_name" logs/0367.log

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –§–ò–û –∫–ª–∏–µ–Ω—Ç–∞
```

### **–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏:**

‚úÖ **–°–µ—Ä–≤–∏—Å 8020 —Ä–∞–±–æ—Ç–∞–µ—Ç** - `./integration_cache.sh status`  
‚úÖ **–ö—ç—à –Ω–µ –ø—É—Å—Ç–æ–π** - `cache_size > 0`  
‚úÖ **Hit rate > 50%** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è  
‚úÖ **Endpoint /integrations/0367 —Ä–∞–±–æ—Ç–∞–µ—Ç** - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç integrations  
‚úÖ **Endpoint /customer-name —Ä–∞–±–æ—Ç–∞–µ—Ç** - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è –∏–ª–∏ null  
‚úÖ **–û–±–æ–≥–∞—â–µ–Ω–∏–µ –≤ Telegram** - —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç –§–ò–û –∫–ª–∏–µ–Ω—Ç–æ–≤  

### **–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**

1. **–ü–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –ø–æ number** - —Å–µ—Ä–≤–∏—Å 8020 –Ω–µ –∏—â–µ—Ç –ø–æ `name` (june), —Ç–æ–ª—å–∫–æ –ø–æ `number` (0367)
2. **TTL –∫—ç—à–∞ 90 —Å–µ–∫** - –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Ç—É—Ö–∞—é—Ç —á–µ—Ä–µ–∑ 1.5 –º–∏–Ω—É—Ç—ã
3. **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 4-5 –º–∏–Ω** - –ø–æ–ª–Ω—ã–π refresh –∫—ç—à–∞ –∫–∞–∂–¥—ã–µ 4-5 –º–∏–Ω—É—Ç
4. **–ù–µ—Ç fallback –¥–ª—è –∏–º–µ–Ω** - –µ—Å–ª–∏ –≤ CRM –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `null`

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è —Å–≤—è–∑–∏ 8000 ‚Üî 8020:**

```bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
watch -n 30 'curl -s http://127.0.0.1:8020/stats | jq "{cache_size, hit_rate_percent, config_cache_size, last_refresh: .last_full_refresh}"'

# –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç–æ–π
if [ $(curl -s http://127.0.0.1:8020/stats | jq '.cache_size') -eq 0 ]; then
    echo "‚ùå ALERT: Integration cache is empty!"
    curl -X POST http://127.0.0.1:8020/cache/refresh
fi
```

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 2025-10-01 - –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –ª–æ–≥ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è 0367 (`logs/0367.log`)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –æ—Ç Token `375293332255`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —ç–º–æ–¥–∑–∏-–º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- ‚úÖ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `otladka.md` —Å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –ø–æ –æ—Ç–ª–∞–¥–∫–µ
- ‚úÖ –ò–∑—É—á–µ–Ω–∞ –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –ù–∞–π–¥–µ–Ω—ã –∏ –æ–ø–∏—Å–∞–Ω—ã –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Telegram
- ‚úÖ –û–ø–∏—Å–∞–Ω—ã —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–∏—Å–æ–º 8020 –∏ RetailCRM 8019
- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ —Å–≤—è–∑—å—é 8000 ‚Üî 8020
- ‚úÖ –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –ø–ª–∞–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤—è–∑–∏ –∏ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

### 2025-10-01 - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
- ‚úÖ **–ù–ê–ô–î–ï–ù–ê –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:** `enterprise_number = token[:4]` –¥–∞–≤–∞–ª–æ `"3752"` –≤–º–µ—Å—Ç–æ `"0367"`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–∞–π–ª `app/services/calls/dial.py`: –¥–æ–±–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –∫ –ë–î `SELECT number FROM enterprises WHERE name2 = $1`
- ‚úÖ –û—á–∏—â–µ–Ω debug.log (–±—ã–ª 510MB, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ app.log –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ)
- üîÑ –û–∂–∏–¥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–æ–≥–∞—â–µ–Ω–∏—è


