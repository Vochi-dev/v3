# –°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –¥–ª—è Asterisk Webhook

## –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –ø–æ CRM

- –ö–∞–∂–¥–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å —Å–æ —Å–≤–æ–∏–º UI, API, –ª–æ–≥–∏–∫–æ–π –∏ –ë–î‚Äë–¥–æ—Å—Ç—É–ø–æ–º.
- –ù–∞—á–∏–Ω–∞–µ–º —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ `retailcrm.py` (–ø–æ—Ä—Ç 8019): —Ä–∞–∑–≤–∏–≤–∞–µ–º –¥–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –º—É–ª—å—Ç–∏—é–Ω–∏—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.
- –ù–∏–∫–∞–∫–æ–≥–æ –æ–±—â–µ–≥–æ –∞–≥—Ä–µ–≥–∏—Ä—É—é—â–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –Ω–∞ –∫–∞–∂–¥—É—é CRM)

- main.py:8000 ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π API –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (–±–µ–∑ –ª–æ–≥–∏–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π)
- enterprise_admin_service.py:8004 ‚Äî –∞–¥–º–∏–Ω–∫–∞ —é–Ω–∏—Ç–∞ (–∫–Ω–æ–ø–∫–∞ "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏" –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç UI –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π CRM)
- retailcrm.py:8019 ‚Äî —Å–µ—Ä–≤–∏—Å RetailCRM: UI –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–∏—ë–º —Å–æ–±—ã—Ç–∏–π, –≤—ã–∑–æ–≤—ã API RetailCRM, –ª–æ–≥–∏
- dial.py/bridge.py/hangup.py/download.py ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–æ–±—ã—Ç–∏—è –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ CRM‚Äë—Å–µ—Ä–≤–∏—Å—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ

## –ï–¥–∏–Ω—ã–π —Ñ–ª–æ—É –∑–≤–æ–Ω–∫–∞ (start/dial/bridge/hangup ‚Üí –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

–ù–∏–∂–µ ‚Äî —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π, –∫–æ–Ω–µ—á–Ω—ã–π ¬´—Å–∫–≤–æ–∑–Ω–æ–π¬ª –ø—É—Ç—å —Å–æ–±—ã—Ç–∏—è –æ—Ç Asterisk –¥–æ CRM (–ø—Ä–∏–º–µ—Ä: RetailCRM).

- –í—Ö–æ–¥ —Å–æ–±—ã—Ç–∏–π (–æ–±—â–∏–π)
  - Asterisk —Ö–æ—Å—Ç—ã ‚Üí `main.py`:
    - `POST /start`, `POST /dial`, `POST /bridge`, `POST /hangup` —Å —Ç–µ–ª–æ–º: `{ Token, UniqueId, CallerIDNum, Extensions[], ConnectedLineNum, CallType, CallStatus, StartTime, EndTime, Trunk, ... }`.
  - `main.py` ‚Üí `_dispatch_to_all(...)`:
    - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ PostgreSQL: `call_events (unique_id, event_type, raw_data, data_source='live')`.
    - –†–∞—Å—Å—ã–ª–∞–µ—Ç –≤ Telegram —á–µ—Ä–µ–∑ `app/services/calls/*` (—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –∏ UI-–ª–æ–≥–∏–∫–∞).

- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (—Ü–µ–ª–µ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞)
  - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞: `integration_cache.py` –Ω–∞ 8020 (Integration Gateway).
    - –≠–Ω–¥–ø–æ–∏–Ω—Ç: `POST /dispatch/call-event` —Å —Ç–µ–ª–æ–º: `{ token, uniqueId, event_type: 'dial'|'hangup', raw, record_url? }`.
    - –î–µ–π—Å—Ç–≤–∏—è 8020:
      1) –ù–∞—Ö–æ–¥–∏—Ç `enterprise_number` –ø–æ `token`.
      2) –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–∑ in‚Äëmemory –∫—ç—à–∞ (`/integrations/{enterprise}`), TTL‚âà90s.
      3) –î–ª—è `retailcrm: true` ‚Äî —Ñ–æ—Ä–≤–∞—Ä–¥–∏—Ç –≤ 8019.
      4) –ï—Å–ª–∏ –ø—Ä–∏—à—ë–ª `hangup` –±–µ–∑ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–µ–≥–æ `dial` –ø–æ —ç—Ç–æ–º—É `uniqueId` ‚Äî –¥–µ–ª–∞–µ—Ç —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π `dial` (–ø—Ä–∞–≤–∏–ª–æ: –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–Ω—è—Ç—å –ø–æ–ø‚Äë–∞–ø).

  - RetailCRM —Å–µ—Ä–≤–∏—Å: `retailcrm.py` –Ω–∞ 8019
    - –≠–Ω–¥–ø–æ–∏–Ω—Ç –ø—Ä–∏—ë–º–∞ —Ç–æ–ª—å–∫–æ —Å localhost: `POST /internal/retailcrm/call-event`.
    - –õ–æ–≥–∏–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è payload (–Ω–∞ –æ—Å–Ω–æ–≤–µ `raw`):
      - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è: `CallType 0‚Üíin, 1‚Üíout; 2 ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`. –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ ‚Äî —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ (CallerIDNum/Extensions/ConnectedLineNum).
      - `phone`: –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤ E.164 –¥–ª—è `call/event`, –±–µ–∑ `+` –¥–ª—è `calls/upload`.
      - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ `codes`/`userIds`: –ø–æ `enterprises.integrations_config->retailcrm.user_extensions` (–¥–æ–±–∞–≤–æ—á–Ω—ã–µ ‚Üî RetailCRM userId). –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç `codes`.
      - `callExternalId`: = `UniqueId` (–¥–ª—è –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ–≤ RetailCRM).
    - –í—ã–∑–æ–≤—ã RetailCRM:
      - –†–µ–∞–ª—Ç–∞–π–º –ø–æ–ø‚Äë–∞–ø: `POST /api/v5/telephony/call/event` —Å `clientId=<enterprise_number>`, `event={ phone, type: in|out|hangup, codes|userIds, callExternalId, externalPhone? }`.
      - –ñ—É—Ä–Ω–∞–ª/–∑–∞–ø–∏—Å—å: `POST /api/v5/telephony/calls/upload` (—Ç–æ–ª—å–∫–æ –Ω–∞ `hangup`) —Å `calls=[{ date, type, phone(without +), duration, result (answered|missed), externalId, userId, recordUrl? }]`.
    - –¢–∞–π–º–∞—É—Ç—ã: 2‚Äì3s, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ `(enterprise_number, callExternalId, type)`.

- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π:
  - `start`: Telegram/–ª–æ–≥; –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.
  - `dial`: –∫–ª—é—á–µ–≤–æ–µ –¥–ª—è –ø–æ–ø‚Äë–∞–ø–æ–≤ –≤ RetailCRM (type in|out). –î–æ–ª–∂–Ω–æ —É—Ö–æ–¥–∏—Ç—å –≤ 8020 —Å—Ä–∞–∑—É (fire‚Äëand‚Äëforget) –∏–∑ —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏—ë–º–∞ –∑–≤–æ–Ω–∫–æ–≤.
  - `bridge`: –¥–ª—è RetailCRM –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ Telegram‚ÄëUI).
  - `hangup`: —Ñ–∏–∫—Å–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≤ RetailCRM, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `duration` –∏ `recordUrl`; –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `dial` –ø–æ `uniqueId` ‚Äî —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π `dial`.

- –ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
  - Fire‚Äëand‚Äëforget –≤ —Å—Ç–æ—Ä–æ–Ω—É 8020 (–Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç Asterisk).
  - –ñ—ë—Å—Ç–∫–∏–µ —Ç–∞–π–º–∞—É—Ç—ã, —Ä–µ—Ç—Ä–∞–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ 8020/8019.
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: `logs/integration_cache.log` –∏ `logs/retailcrm.log` —Å –∫—Ä–∞—Ç–∫–∏–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ —Å—Ç–∞—Ç—É—Å–∞.

### ¬´–ö–∞–∫ –µ—Å—Ç—å¬ª (–Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç)
- `main.py` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è, –ø–∏—à–µ—Ç –≤ `call_events`, —à–ª—ë—Ç –≤ Telegram.
- 8020 (Integration Gateway) –∏ 8019 (RetailCRM) –≥–æ—Ç–æ–≤—ã: –ø—Ä–∏–Ω–∏–º–∞—é—Ç `dispatch/call-event` ‚Üí `internal/retailcrm/call-event`, —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≤ RetailCRM (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ success –≤ –ª–æ–≥–∞—Ö –∏ –≤—Å–ø–ª—ã–≤–∞—à–∫–∞–º–∏ –ø—Ä–∏ —ç–º—É–ª—è—Ü–∏–∏).
- –°–≤—è–∑–∫–∞ ¬´—Å–µ—Ä–≤–∏—Å –ø—Ä–∏—ë–º–∞ –∑–≤–æ–Ω–∫–æ–≤ ‚Üí 8020¬ª –¥–æ–ª–∂–Ω–∞ —Å–ª–∞—Ç—å –∫–∞–∫ –º–∏–Ω–∏–º—É–º `dial` –∏ `hangup` (fire‚Äëand‚Äëforget). –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–≤–µ–Ω–æ, –∫–æ—Ç–æ—Ä–æ–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–ø‚Äë–∞–ø—ã –≤–æ –≤—Ä–µ–º—è –∂–∏–≤—ã—Ö –∑–≤–æ–Ω–∫–æ–≤.

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞/—á–µ–∫‚Äë–ª–∏—Å—Ç
- –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ø‚Äë–∞–ø–∞ –ø—Ä–∏ –∂–∏–≤–æ–º –∑–≤–æ–Ω–∫–µ:
  1) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —É—Ö–æ–¥–∏—Ç –ª–∏ `dial` –≤ 8020 (`tail -f logs/integration_cache.log`).
  2) –ù–∞ 8019 ‚Äî `tail -f logs/retailcrm.log` (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 200 –Ω–∞ `call/event`).
  3) `integration_cache.log` –ø—Ä–∏ `hangup` –±–µ–∑ `dial` ‚Äî —É–≤–∏–¥–µ—Ç—å ¬´synthetic dial¬ª.
  4) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ `user_extensions` –≤ –ë–î (codes/userIds), `clientId`, –¥–æ–º–µ–Ω –∏ –∫–ª—é—á.

## Nginx –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è)

```nginx
# UI –∏ API RetailCRM
location /retailcrm-admin/ {
    proxy_pass http://127.0.0.1:8019/retailcrm-admin/;
}
location /retailcrm/api/ {
    proxy_pass http://127.0.0.1:8019/api/;
}
```

- –í UI –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è: –∫–∞—Ä—Ç–æ—á–∫–∞ RetailCRM –≤–µ–¥—ë—Ç –≤ –Ω–æ–≤—É—é –≤–∫–ª–∞–¥–∫—É –Ω–∞ `/retailcrm-admin/`.
- –í—Å–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –≤—ã–∑–æ–≤—ã ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ nginx –∫ 127.0.0.1, –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ–º–µ–Ω–∞.

## –î–∞–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

- –ö–æ–Ω—Ñ–∏–≥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `enterprises.integrations_config` (JSONB) –ø–æ–¥ –∫–ª—é—á–æ–º `retailcrm`.
- –õ–æ–≥–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ `integration_logs` (–æ–±—â–∞—è –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π).

–ü—Ä–∏–º–µ—Ä `integrations_config` –¥–ª—è –æ–¥–Ω–æ–≥–æ —é–Ω–∏—Ç–∞:
```json
{
  "retailcrm": {
    "enabled": true,
    "domain": "https://example.retailcrm.ru",
    "api_key": "<secret>",
    "user_extensions": {
      "19": "150",    
      "18": "151",    
      "22": null      
    },
    "last_sync": "2025-01-09T19:20:00Z"
  }
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –¥–æ–±–∞–≤–æ—á–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤

–í –ø–æ–ª–µ `user_extensions` —Ö—Ä–∞–Ω—è—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–µ–∂–¥—É ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π RetailCRM –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏:

**–§–æ—Ä–º–∞—Ç:** `{"retailcrm_user_id": "internal_number"}`

- **–ö–ª—é—á**: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ RetailCRM (—Å—Ç—Ä–æ–∫–∞)
- **–ó–Ω–∞—á–µ–Ω–∏–µ**: –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `user_internal_phones` –∏–ª–∏ `null` –¥–ª—è —Å–Ω—è—Ç–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä—ã:**
- `"19": "150"` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å RetailCRM —Å ID=19 –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –Ω–æ–º–µ—Ä 150
- `"18": "151"` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å RetailCRM —Å ID=18 –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –Ω–æ–º–µ—Ä 151  
- `"22": null` - –Ω–æ–º–µ—Ä —Å–Ω—è—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å)

**–õ–æ–≥–∏–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏:**
- –û–¥–∏–Ω –Ω–æ–º–µ—Ä –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É
- –ü—Ä–∏ –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è
- –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–æ–º–µ—Ä–æ–≤

**–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å RetailCRM:**
- –î–∞–Ω–Ω—ã–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –≤ RetailCRM —á–µ—Ä–µ–∑ `integrations.telephony.additionalCodes`
- –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –Ω–∞—à–∞ –ë–î, —Ç–∞–∫ –∏ RetailCRM
- RetailCRM —Ñ–æ—Ä–º–∞—Ç: `[{"userId": "19", "code": "150"}, {"userId": "18", "code": "151"}]`

## –†–æ–ª–∏ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å retailcrm.py (8019)

- UI –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è (`/retailcrm-admin/`):
  - –§–æ—Ä–º—ã: –¥–æ–º–µ–Ω, API‚Äë–∫–ª—é—á, —Ñ–ª–∞–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π, —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–æ–≤ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `integrations_config`
- API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (`/api/config/...`): –∑–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –≤–∞–ª–∏–¥–∞—Ü–∏—è, —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ü—Ä–∏—ë–º —Å–æ–±—ã—Ç–∏–π (`/api/events`): `dial`, `bridge`, `hangup` –∏ –ø–æ—Ç–æ–∫ `download` (–±–µ–∑ –∫–∞—Ä—Ç–æ—á–∫–∏)
  - –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞: –æ—Ç–≤–µ—Ç Asterisk –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, CRM –≤—ã–∑–æ–≤—ã –≤ —Ñ–æ–Ω–µ
  - –†–µ—Ç—Ä–∞–∏/—Ç–∞–π–º–∞—É—Ç—ã/–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ `call_unique_id`
- Smart Redirect (`/api/smart-redirect`):
  - –ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤ RetailCRM –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –Ω–æ–º–µ—Ä–∞
  - –í—ã–∑–æ–≤ `asterisk.py` (SSH CLI) –¥–ª—è `channel redirect` ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (`integration_logs`): —Å—Ç–∞—Ç—É—Å, –æ—à–∏–±–∫–∞, –ø—ç–π–ª–æ–∞–¥—ã –∑–∞–ø—Ä–æ—Å/–æ—Ç–≤–µ—Ç
- –ö—ç—à –∫–æ–Ω—Ñ–∏–≥–æ–≤ –≤ –ø–∞–º—è—Ç–∏ —Å TTL –∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
- –ü—É–ª `asyncpg`, –ª–∏–º–∏—Ç—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏, rate‚Äëlimit per enterprise

## –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏ –∑–≤–æ–Ω–∫–æ–≤

- `dial.py`, `bridge.py`, `hangup.py`, `download.py`:
  - –û–ø—Ä–µ–¥–µ–ª—è—é—Ç –ø–æ `enterprise_number` –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–∏–∑ –ë–î/–∫—ç—à–∞)
  - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —à–ª—é—Ç —Å–æ–±—ã—Ç–∏—è –≤–æ –≤—Å–µ –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ CRM‚Äë—Å–µ—Ä–≤–∏—Å—ã
  - –ù–µ –∂–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö HTTP –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ Asterisk

---

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ 8020: Integration Cache ‚Üí Integration Gateway

–¶–µ–ª—å: –≤—ã–Ω–µ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫—É —Å–æ–±—ã—Ç–∏–π –≤ CRM‚Äë–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–∑ call‚Äë—Å–µ—Ä–≤–∏—Å–æ–≤ –≤ —Å–µ—Ä–≤–∏—Å 8020, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑—Ä–∞—Å—Ç–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –∏ —Ö—ç–Ω–¥–ª–µ—Ä—ã.

### –ù–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã 8020
- `POST /dispatch/call-event`
  - –í—Ö–æ–¥: `{ token, uniqueId, event_type: "dial"|"hangup", raw: {...}, record_url?: string }`
  - –ü–æ–≤–µ–¥–µ–Ω–∏–µ:
    - –ù–∞—Ö–æ–¥–∏—Ç `enterprise_number` –ø–æ `token` –≤ –ë–î
    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–æ in‚Äëmemory –∫—ç—à—É (`/integrations/{enterprise}`)
    - –î–ª—è `retailcrm` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:
      - –†–µ–∞–ª—Ç–∞–π–º: `POST /api/v5/telephony/call/event` (`clientId`, `event={phone, type: in|out|hangup, codes|userIds, callExternalId}`)
      - –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ (–¥–ª—è `hangup`): `POST /api/v5/telephony/calls/upload` (`date, type, phone, code|userId, duration, result, externalId, recordUrl, externalPhone`)
    - –¢–∞–π–º–∞—É—Ç 2‚Äì3s, —Ä–µ—Ç—Ä–∞–∏ 2‚Äì3, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ `(enterprise, callExternalId, type)`
    - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `integration_logs`

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –≤ call‚Äë—Å–µ—Ä–≤–∏—Å–∞—Ö
- `dial.py`: –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram ‚Äî fire‚Äëand‚Äëforget POST –Ω–∞ `http://localhost:8020/dispatch/call-event` (—Ç–∏–ø in|out)
- `hangup.py`: –ø–æ—Å–ª–µ `create_call_record` ‚Äî fire‚Äëand‚Äëforget POST –Ω–∞ `.../dispatch/call-event` (—Ç–∏–ø hangup, —Å `record_url`)

### –ü—Ä–∞–≤–∏–ª–∞ –º–∞–ø–ø–∏–Ω–≥–∞ –ø–æ–ª–µ–π RetailCRM
- `type`: 0‚Üíin, 1‚Üíout, 2‚Üí–ø—Ä–æ–ø—É—Å–∫
- `codes`: –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–æ–±–∞–≤–æ—á–Ω—ã–π (—Å—Ç—Ä–æ–∫–∞) –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ `userIds`
- `userIds`: —Ñ–æ–ª–±—ç–∫ –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö `additionalCodes`
- `phone`: E.164 (–¥–ª—è upload ‚Äî –±–µ–∑ `+`)
- `result`: `CallStatus` ‚Üí `answered|missed|busy`
- `externalId`: `UniqueId`
- `recordUrl`: `https://bot.vochi.by/recordings/file/{uuid}`


–ü—Ä–∏–º–µ—Ä –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤ (–ª–æ–≥–∏–∫–∞):
- `POST /retailcrm/api/events` —Å —Ç–µ–ª–æ–º: `{ enterprise_number, event_type, payload }`
- `POST /retailcrm/api/smart-redirect` –¥–ª—è –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –î–æ—Å—Ç—É–ø –∫ UI ‚Äî —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
- API‚Äë–∫–ª—é—á–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ UI; —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î –≤–æ–∑–º–æ–∂–Ω–æ –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ HTTP ‚Äî —á–µ—Ä–µ–∑ nginx –∫ 127.0.0.1, –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –æ–±—Ö–æ–¥–æ–≤

## –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å

- `/health`, `/stats` –≤ –∫–∞–∂–¥–æ–º CRM‚Äë—Å–µ—Ä–≤–∏—Å–µ
- –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: –ø–æ—Å–ª–µ–¥–Ω–∏–µ —É—Å–ø–µ—Ö–∏/–æ—à–∏–±–∫–∏

## –ü–ª–∞–Ω —Ä–∞–±–æ—Ç (RetailCRM ‚Üí –º—É–ª—å—Ç–∏—é–Ω–∏—Ç)

1) –ë—ç–∫–µ–Ω–¥ retailcrm.py
- [x] –í–≤–µ—Å—Ç–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤: `/retailcrm-admin/` (UI), `/api/...` (REST)
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CRUD –∫–æ–Ω—Ñ–∏–≥–æ–≤ –ø–æ `enterprise_number` (JSONB + –≤–∞–ª–∏–¥–∞—Ü–∏—è)
- [x] –ú–µ—Ç—Ä–∏–∫–∏ `/health`, `/stats`
- [x] –ö—ç—à –∫–æ–Ω—Ñ–∏–≥–æ–≤, –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏, TTL
- [x] –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—ç—à–µ–º: `/api/config-cache/refresh/{enterprise_number}`, `/api/config-cache/refresh-all`, `/api/config-cache/active-enterprises`
- [ ] –≠–Ω–¥–ø–æ–∏–Ω—Ç `/api/events` (dial/bridge/hangup/download): –æ—á–µ—Ä–µ–¥—å/—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
- [ ] –≠–Ω–¥–ø–æ–∏–Ω—Ç `/api/smart-redirect` —Å –≤—ã–∑–æ–≤–æ–º RetailCRM –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å `asterisk.py`
- [ ] –õ–æ–≥–∏ –≤ `integration_logs` (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞, –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—ç–π–ª–æ–∞–¥—ã)

2) UI retailcrm-admin
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü—ã: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –ù–∞—Å—Ç—Ä–æ–π–∫–∏, –õ–æ–≥–∏, –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚Üí –∑–∞–ø–∏—Å—å –≤ `integrations_config`

3) –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏ –∑–≤–æ–Ω–∫–æ–≤
- [ ] –í —Å–µ—Ä–≤–µ—Ä–∞—Ö —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ POST –Ω–∞ `/retailcrm/api/events`
- [ ] –ù–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç Asterisk (fire‚Äëand‚Äëforget / —Ñ–æ–Ω–æ–≤—ã–µ tasks)

4) –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å
- [ ] –†–µ—Ç—Ä–∞–∏ + —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –±—ç–∫–æ—Ñ—Ñ
- [ ] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞ `call_unique_id`
- [ ] Rate‚Äëlimit –∏ —Å–µ–º–∞—Ñ–æ—Ä—ã –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã per enterprise

5) –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç—ã
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API `/api/...`
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã (–ø–∏–∫–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏)
- [ ] –ù–∞–±–æ—Ä unit/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

## To-Do Tracker (–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ)

- [ ] –ö—ç—à "–º–∞—Ç—Ä–∏—Ü—ã –≤–∫–ª—é—á—ë–Ω–Ω–æ—Å—Ç–∏" –≤ call‚Äë—Å–µ—Ä–≤–∏—Å–∞—Ö (dial/bridge/hangup/download)
  - [ ] –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `enterprise_number -> {retailcrm: bool, amocrm: bool, ...}`
  - [ ] –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Ä–µ—Ñ—Ä–µ—à –∫–∞–∂–¥—ã–µ 180‚Äì300 —Å–µ–∫ (–¥–∂–∏—Ç—Ç–µ—Ä 10‚Äì20%)
  - [ ] TTL –Ω–∞ –∑–∞–ø–∏—Å—å 60‚Äì120 —Å–µ–∫ (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞)
  - [ ] –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ `LISTEN/NOTIFY` (payload: `enterprise_number`, `integration_type`)
  - [ ] Anti‚Äëstampede (single‚Äëflight) –ø—Ä–∏ –ø—Ä–æ–º–∞—Ö–∞—Ö –∫—ç—à–∞
  - [ ] –ú–µ—Ç—Ä–∏–∫–∏ hit/miss, –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –ë–î

- [x] –ö—ç—à –ø–æ–ª–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤ –≤ `retailcrm.py`
  - [x] –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `enterprise_number -> {api_url, api_key, enabled, –æ–ø—Ü–∏–∏, –º–∞–ø–ø–∏–Ω–≥–∏, ...}`
  - [x] –õ–µ–Ω–∏–≤—ã–π –ø—Ä–æ–≥—Ä–µ–≤ –ø–æ –ø–µ—Ä–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É + —Ñ–æ–Ω–æ–≤—ã–π —Ñ—É–ª–ª‚Äërefresh –∫–∞–∂–¥—ã–µ 180‚Äì300 —Å–µ–∫
  - [ ] –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ `LISTEN/NOTIFY` –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  - [x] TTL 60‚Äì120 —Å–µ–∫ (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞), –∞—Ç–æ–º–∞—Ä–Ω—ã–π swap –∫—ç—à–∞, —á—Ç–µ–Ω–∏—è –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
  - [ ] –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ / –≤–Ω–µ—à–Ω–∏—Ö –≤—ã–∑–æ–≤–∞—Ö (—Å–µ–º–∞—Ñ–æ—Ä—ã per enterprise)
  - [x] –ú–µ—Ç—Ä–∏–∫–∏ hit/miss, —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞, expiring
  - [x] –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã `/api/config-cache/*` –∏ `/api/active-enterprises`

- [ ] –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ call‚Äë—Å–µ—Ä–≤–∏—Å–∞—Ö
  - [ ] –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç 200 —É–¥–∞–ª—ë–Ω–Ω–æ–º—É —Ö–æ—Å—Ç—É –ø–æ—Å–ª–µ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞
  - [ ] –û—Ç–ø—Ä–∞–≤–∫–∏ –≤ CRM —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ–Ω–µ (`asyncio.create_task()`/–æ—á–µ—Ä–µ–¥—å)
  - [ ] –ñ—ë—Å—Ç–∫–∏–µ —Ç–∞–π–º–∞—É—Ç—ã 2‚Äì3 —Å–µ–∫, —Ä–µ—Ç—Ä–∞–∏ 2‚Äì3, —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –±—ç–∫–æ—Ñ—Ñ
  - [ ] Circuit breaker –Ω–∞ —é–Ω–∏—Ç/CRM –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö (–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞—É–∑–∞)

- [ ] –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏
  - [ ] –ü–æ–¥–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ `LISTEN` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∫–∞–Ω–∞–ª–æ–≤
  - [ ] –û—Ç–ø—Ä–∞–≤–∫–∞ `NOTIFY` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
  - [ ] –õ–æ–≥–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–π, –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–º —Å–µ—Ä–≤–∏—Å–æ–º

- [ ] –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
  - [ ] –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ/–Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã; —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ –û–ó–£ –ø—Ä–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–∏
  - [ ] –î–æ—Å—Ç—É–ø –∫ UI —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
  - [ ] –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ HTTP —á–µ—Ä–µ–∑ nginx –∫ 127.0.0.1

- [ ] –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å
  - [ ] `/health`, `/stats` –≤ `retailcrm.py` –∏ –≤ call‚Äë—Å–µ—Ä–≤–∏—Å–∞—Ö
  - [ ] –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: –ø–æ—Å–ª–µ–¥–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã–µ/–æ—à–∏–±–æ—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
  - [ ] –ê–ª–µ—Ä—Ç—ã –Ω–∞ –ø–∞–¥–µ–Ω–∏–µ hit_ratio –∏ —Ä–æ—Å—Ç –æ—à–∏–±–æ–∫ –∫ CRM

- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é)
  - [ ] (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) GIN‚Äë–∏–Ω–¥–µ–∫—Å –ø–æ `enterprises.integrations_config` –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö JSONB —Ñ–∏–ª—å—Ç—Ä–æ–≤
  - [ ] (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) Stale‚Äëwhile‚Äërevalidate –≤ CRM‚Äë—Å–µ—Ä–≤–∏—Å–µ

## –ò—Ç–æ–≥–∏

- –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É: –æ–¥–∏–Ω –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –Ω–∞ –∫–∞–∂–¥—É—é CRM.
- `retailcrm.py` (8019) —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —ç—Ç–∞–ª–æ–Ω–Ω—ã–º –º—É–ª—å—Ç–∏—é–Ω–∏—Ç–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º —Å UI –∏ –ø–æ–ª–Ω—ã–º —Ü–∏–∫–ª–æ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –ø–æ –º–µ—Å—Ç—É: –º–∞—Ç—Ä–∏—Ü–∞ –≤–∫–ª—é—á—ë–Ω–Ω–æ—Å—Ç–∏ –≤ call‚Äë—Å–µ—Ä–≤–∏—Å–∞—Ö, –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –≤ CRM‚Äë—Å–µ—Ä–≤–∏—Å–µ.
- –û–±—â–∏–π –∞–≥—Ä–µ–≥–∏—Ä—É—é—â–∏–π —Å–µ—Ä–≤–∏—Å –Ω–µ –Ω—É–∂–µ–Ω; –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö CRM‚Äë—Å–µ—Ä–≤–∏—Å–æ–≤.

---

## –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å (–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ)

- UI `retailcrm-admin` —Ä–∞–±–æ—Ç–∞–µ—Ç: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ `enterprises.name`, –ø–æ–¥–∫–ª—é—á—ë–Ω favicon.
- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –ø–æ–¥ —Ç–µ–º –∂–µ –ø—Ä–µ—Ñ–∏–∫—Å–æ–º:
  - `PUT /retailcrm-admin/api/config/{enterprise_number}` ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ –≤ `enterprises.integrations_config`.
  - `POST /retailcrm-admin/api/register/{enterprise_number}` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è "Vochi‚ÄëCRM" –≤ RetailCRM —á–µ—Ä–µ–∑ `/integration-modules/{code}/edit`.
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–æ –∫ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Å—Ö–µ–º–µ `integration_logs` (–æ–±—â–∞—è —Ç–∞–±–ª–∏—Ü–∞):
  - –ü–æ–ª—è: `enterprise_number`, `integration_type`, `event_type`, `request_data`, `response_data`, `status` (success|error), `error_message`, `created_at`.
  - –ü–∏—à–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ `event_type=register_module` –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
- –ö—ç—à: —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫—ç—à –∫–æ–Ω—Ñ–∏–≥–æ–≤ —Å TTL –∏ —Ñ–æ–Ω–æ–≤—ã–º full‚Äërefresh. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSONB (–≤–æ–∑–≤—Ä–∞—Ç –∑–Ω–∞—á–µ–Ω–∏—è –±–µ–∑ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ `dict(...)`).

### Troubleshooting: –∫–Ω–æ–ø–∫–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª –¥–∞—ë—Ç 400/422

–°–∏–º–ø—Ç–æ–º—ã:
- –í –±—Ä–∞—É–∑–µ—Ä–µ –ø—Ä–∏ POST `/retailcrm-admin/api/register/{enterprise}` –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞: 400 –∏–ª–∏ 422.
- –í `logs/retailcrm.log` –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –∑–∞–ø–∏—Å–∏:
  - `Input value "integrationModule" contains a non-scalar value` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è –æ–±—ä–µ–∫—Ç –≤–º–µ—Å—Ç–æ JSON‚Äë—Å—Ç—Ä–æ–∫–∏ –≤ –ø–æ–ª–µ `integrationModule`.
  - `logo: Logo image must be svg` ‚Äî –ª–æ–≥–æ—Ç–∏–ø –Ω–µ –≤ SVG.
  - `baseUrl: This value should not be blank` ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `baseUrl`.
- –õ–∏–±–æ 422 –æ—Ç —Å–∞–º–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞: `JSON decode error` (—Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª–æ—Å—å).

–ü—Ä–∏—á–∏–Ω—ã:
- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞–ª–∏ –¥–≤–µ –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞ 8019. –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –æ—Ç–≤–µ—á–∞–ª–∞ —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º payload (JPG‚Äë–ª–æ–≥–æ—Ç–∏–ø, –±–µ–∑ `baseUrl`, —Å `actions`).
- –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ UI/–±—ç–∫–µ–Ω–¥–∞ –º–æ–≥–ª–∞ –ø–æ–ø–∞—Å—Ç—å—Å—è —Å–∏—Ç—É–∞—Ü–∏—è —Å –ø—É—Å—Ç—ã–º/–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º JSON‚Äë—Ç–µ–ª–æ–º (422) ‚Äî —Å–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Ö–æ–¥–∏–ª –¥–æ –≤—ã–∑–æ–≤–∞ RetailCRM.

–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±—ã—Å—Ç—Ä–æ:
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å —Å–ª—É—à–∞–µ—Ç 8019: `ss -ltnp '( sport = :8019 )'`.
- –°–Ω—è—Ç—å —Ö–≤–æ—Å—Ç `logs/retailcrm.log` –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ–ø—ã—Ç–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: —Å—Ç–∞—Ç—É—Å 200/201 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ payload –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (SVG + `baseUrl`, –±–µ–∑ `actions`, `integrationModule` ‚Äî JSON‚Äë—Å—Ç—Ä–æ–∫–∞).

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –≤ —Å–µ—Ä–≤–∏—Å–µ:
- Payload —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∏–≤–µ–¥—ë–Ω –∫ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º RetailCRM: SVG‚Äë–ª–æ–≥–æ—Ç–∏–ø, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π `baseUrl`, –ø–æ–ª–µ `actions` —É–¥–∞–ª–µ–Ω–æ, `integrationModule` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ JSON‚Äë—Å—Ç—Ä–æ–∫–∞ –≤–Ω—É—Ç—Ä–∏ form‚Äëdata.
- –≠–Ω–¥–ø–æ–∏–Ω—Ç –∞–¥–º–∏–Ω–∫–∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–∞–∫ JSON, —Ç–∞–∫ –∏ form‚Äëdata; –∑–∞—â–∏—â—ë–Ω –æ—Ç 422 –ø—Ä–∏ –ø—É—Å—Ç–æ–º/–±–∏—Ç–æ–º —Ç–µ–ª–µ.

–ß–µ–∫‚Äë–ª–∏—Å—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:
1) –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã `./all.sh restart` –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–∞ 8019 –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å.
2) –û—Ç–∫—Ä—ã—Ç—å `/retailcrm-admin/?enterprise_number=XXXX` –∏ –Ω–∞–∂–∞—Ç—å ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª.
3) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - `enterprises.integrations_config->retailcrm` –æ–±–Ω–æ–≤–∏–ª—Å—è (–¥–æ–º–µ–Ω, –∫–ª—é—á, enabled).
   - –í `integration_logs` –ø–æ—è–≤–∏–ª–∞—Å—å –∑–∞–ø–∏—Å—å `event_type=register_module` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –∏ –æ—Ç–≤–µ—Ç–æ–º RetailCRM.
   - –í `logs/retailcrm.log` –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –¥–∞—ë—Ç 200/201.

---

## JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" ‚úÖ

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
–ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JWT —Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `accountUrl`. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º RetailCRM –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –≤ –Ω–∞—à—É –∞–¥–º–∏–Ω–∫—É –±–µ–∑ –≤–≤–æ–¥–∞ –ª–æ–≥–∏–Ω–∞/–ø–∞—Ä–æ–ª—è.

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `generate_retailcrm_access_token()` - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω —Å TTL=1 –≥–æ–¥
- `verify_retailcrm_access_token()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
- `AuthMiddleware` - –æ–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –í `accountUrl` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä `token=JWT`

**–ü—Ä–∏–º–µ—Ä accountUrl:**
```
https://bot.vochi.by/retailcrm-admin/?enterprise_number=0367&token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:**
‚úÖ JWT —Ç–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è
‚úÖ –¢–æ–∫–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ accountUrl  
‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ —Ç–æ–∫–µ–Ω—É —Ä–∞–±–æ—Ç–∞–µ—Ç (middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT)
‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: —Ç–æ–∫–µ–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é

–ß—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ —Å–µ–π—á–∞—Å –ø–æ —Å—Ä–µ–¥–µ:

- –í –ë–î —É —é–Ω–∏—Ç–∞ `0367` –≤ `integrations_config->retailcrm` –≤—Å—ë –µ—â—ë —Å—Ç–∞—Ä—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥ (`test.com/test123`) ‚Äî —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –∫–ª–∏–∫ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å" –Ω–µ –¥–æ—à—ë–ª –¥–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
- –í `integration_logs` –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∑–∞–ø–∏—Å–∏ –ø–æ `integration_type='retailcrm'` –∏ `event_type='register_module'` ‚Äî —Ç.–µ. –≤—ã–∑–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è.
- –í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–∏—Å–∞ —Ä–∞–Ω–µ–µ –±—ã–ª 500 –Ω–∞ `/retailcrm-admin/` –∏–∑‚Äë–∑–∞ `.format()` –∏ —Ñ–∏–≥—É—Ä–Ω—ã—Ö —Å–∫–æ–±–æ–∫; —ç—Ç–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ. –¢–∞–∫–∂–µ –Ω–∞–±–ª—é–¥–∞–ª–∞—Å—å –æ—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ —Ä–µ—Ñ—Ä–µ—à–∞ –∫—ç—à–∞ (—Å–æ–æ–±—â–µ–Ω–∏–µ –≤–∏–¥–∞ `dictionary update sequence...`) ‚Äî –ø—Ä–∏—á–∏–Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ–¥–µ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫, —á—Ç–æ–±—ã –æ—à–∏–±–∫–∞ –∏—Å—á–µ–∑–ª–∞ –∏–∑ –ª–æ–≥–æ–≤.

–ë–ª–æ–∫–∏—Ä—É—é—â–∏–π –º–æ–º–µ–Ω—Ç:

- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ (`./all.sh restart`) –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (`/retailcrm-admin/api/*`, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ `integration_logs`, —Ñ–∏–∫—Å –∫—ç—à–∞). –ë–µ–∑ —ç—Ç–æ–≥–æ UI —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ POST‚Äë–º–∞—Ä—à—Ä—É—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≤ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –ø–æ—ç—Ç–æ–º—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –∏ –≤ –ë–î/–ª–æ–≥–∞—Ö –Ω–µ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è.

–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:

1) –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `retailcrm-admin` —Å–Ω–æ–≤–∞ –Ω–∞–∂–∞—Ç—å ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª.
2) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - `enterprises.integrations_config->retailcrm` –æ–±–Ω–æ–≤–∏–ª—Å—è –¥–æ–º–µ–Ω+–∫–ª—é—á.
   - –í `integration_logs` –ø–æ—è–≤–∏–ª–∞—Å—å –∑–∞–ø–∏—Å—å `event_type=register_module` —Å–æ `status=success|error` –∏ –¥–µ—Ç–∞–ª—è–º–∏ –æ—Ç–≤–µ—Ç–∞ RetailCRM.
3) –ü—Ä–∏ `success=true` –º–æ–¥—É–ª—å "Vochi‚ÄëCRM" –¥–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è –≤ –∫–∞–±–∏–Ω–µ—Ç–µ RetailCRM; –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –≤–∏–¥–µ–Ω –≤ `error_message` –∏ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–∏—Å–∞.

---

## –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" –∏–∑ RetailCRM

### –ü—Ä–æ–±–ª–µ–º–∞
- –í RetailCRM –≤ –º–æ–¥—É–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" (`accountUrl`)
- URL –≤–µ–¥—ë—Ç –Ω–∞ `https://bot.vochi.by/retailcrm-admin/?enterprise_number=0367`
- –ù–∞—à —Å–µ—Ä–≤–∏—Å –∑–∞—â–∏—â—ë–Ω `AuthMiddleware` ‚Äî –º–∞—Ä—à—Ä—É—Ç `/retailcrm-admin/` –ù–ï –≤—Ö–æ–¥–∏—Ç –≤ `PUBLIC_ROUTES`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å RetailCRM –Ω–µ –∏–º–µ–µ—Ç `session_token` cookie –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è

#### 1Ô∏è‚É£ –ü—Ä–æ—Å—Ç–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ PUBLIC_ROUTES
```python
PUBLIC_ROUTES = {"/retailcrm-admin", ...}  # –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
```
**–ü–ª—é—Å—ã:** –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ  
**–ú–∏–Ω—É—Å—ã:** –ù–µ—Ç –∑–∞—â–∏—Ç—ã ‚Äî –ª—é–±–æ–π –º–æ–∂–µ—Ç –∑–∞–π—Ç–∏

#### 2Ô∏è‚É£ JWT —Ç–æ–∫–µ–Ω—ã –≤ URL (–í–´–ë–†–ê–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï)
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ JWT —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è
- –û–±–Ω–æ–≤–ª—è—Ç—å `accountUrl`: `.../?enterprise_number=0367&token=<jwt_token>`
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å middleware –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ RetailCRM —Ç–æ–∫–µ–Ω–æ–≤
- –°–æ–∑–¥–∞–≤–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ admin-—Å–µ—Å—Å–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º

**–ü–ª—é—Å—ã:**
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ (—Ç–æ–∫–µ–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º
- ‚úÖ –ú–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å middleware (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
- ‚ö†Ô∏è –¢–æ–∫–µ–Ω –≤–∏–¥–Ω–æ –≤ URL (–Ω–æ —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞)

#### 3Ô∏è‚É£ API –∫–ª—é—á–∏ RetailCRM –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –æ–±—Ä–∞—Ç–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∫ API RetailCRM
- –°–æ–∑–¥–∞–≤–∞—Ç—å verification_code –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

**–ü–ª—é—Å—ã:** –í—ã—Å–æ–∫–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å  
**–ú–∏–Ω—É—Å—ã:** –°–ª–æ–∂–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç RetailCRM API

#### 4Ô∏è‚É£ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
- –û—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
- –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö admin-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ü–ª—é—Å—ã:** –ì–∏–±–∫–æ—Å—Ç—å  
**–ú–∏–Ω—É—Å—ã:** –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è (JWT —Ç–æ–∫–µ–Ω—ã)

1. **–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è AuthMiddleware** –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ RetailCRM —Ç–æ–∫–µ–Ω–æ–≤:
   ```python
   if path.startswith("/retailcrm-admin/"):
       return await handle_retailcrm_admin_auth(request, call_next)
   ```

2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤** –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è:
   ```python
   def generate_retailcrm_access_token(enterprise_number: str) -> str:
       payload = {
           "enterprise_number": enterprise_number,
           "source": "retailcrm",
           "exp": datetime.utcnow() + timedelta(days=365),
           "iat": datetime.utcnow()
       }
       return jwt.encode(payload, JWT_SECRET_KEY, algorithm="HS256")
   ```

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ accountUrl** —Å —Ç–æ–∫–µ–Ω–æ–º –≤ –º–æ–¥—É–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
   - –¢–æ–∫–µ–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é
   - –ò–º–µ–µ—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (1 –≥–æ–¥, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
   - –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ RetailCRM

5. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:**
   - –û–¥–∏–Ω –∫–ª–∏–∫ –∏–∑ RetailCRM ‚Üí —Å—Ä–∞–∑—É –≤ –∞–¥–º–∏–Ω–∫—É
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
   - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –ì–∞—Ä–∞–Ω—Ç–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –¢–æ–∫–µ–Ω—ã –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ –∞–¥–º–∏–Ω–∫–µ RetailCRM –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∑—ã–≤–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–æ—á–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

### –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏–∑ RetailCRM –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –∏—Ö –∏–º–µ–Ω–∞, –Ω–æ –∏ —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –¥–æ–±–∞–≤–æ—á–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –∏–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏.

### –†–µ—à–µ–Ω–∏–µ
1. **API –º–µ—Ç–æ–¥ `get_integration_module`**: –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
2. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ `additionalCodes`**: –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–∞—Ä—Å—è—Ç—Å—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –¥–æ–±–∞–≤–æ—á–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
3. **–ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: –∫–∞–∂–¥–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –µ–≥–æ –¥–æ–±–∞–≤–æ—á–Ω—ã–π –Ω–æ–º–µ—Ä (–µ—Å–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω)
4. **UI –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ**: –≤ —Å–ø–∏—Å–∫–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:
   - **üìû 150** - –µ—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω
   - **üìû –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω** - –µ—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
- **Endpoint**: `GET /integration-modules/{code}` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö**: `integrations.telephony.additionalCodes[]` —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Å—Å–∏–≤ `{userId, code}`
- **UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å –¥–æ–±–∞–≤–æ—á–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –∑–µ–ª–µ–Ω—ã–º —Ü–≤–µ—Ç–æ–º –ø–æ–¥ –∏–º–µ–Ω–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## ‚úÖ –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–æ–±–∞–≤–æ—á–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞
–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–±–∞–≤–æ—á–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º RetailCRM —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤—ã–±–æ—Ä–∞ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –Ω–æ–º–µ—Ä–æ–≤ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è.

### –†–µ—à–µ–Ω–∏–µ
1. **API endpoint –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –Ω–æ–º–µ—Ä–æ–≤**: `GET /api/internal-phones/{enterprise_number}` –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –Ω–æ–º–µ—Ä–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `user_internal_phones` —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–ª–∞–¥–µ–ª—å—Ü–∞—Ö
2. **–í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏**: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω `<select>` —Å –æ–ø—Ü–∏—è–º–∏:
   - `150 (–î–∂—É–ª–∞–π –î–∂—É–Ω–æ–≤—ã–π)` - –µ—Å–ª–∏ –Ω–æ–º–µ—Ä –∑–∞–Ω—è—Ç
   - `151 (—Å–≤–æ–±–æ–¥–µ–Ω)` - –µ—Å–ª–∏ –Ω–æ–º–µ—Ä —Å–≤–æ–±–æ–¥–µ–Ω
3. **–ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"**: –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–æ–º–µ—Ä–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤ RetailCRM
4. **API endpoint –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è**: `POST /api/save-extensions/{enterprise_number}` –æ–±–Ω–æ–≤–ª—è–µ—Ç `additionalCodes` –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ RetailCRM

### Workflow
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ ‚Üí —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å –Ω–æ–º–µ—Ä–∞–º–∏
3. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–æ–º–µ—Ä–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
4. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏:
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –≤ RetailCRM –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `additionalCodes`
   - –°–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è–º–∏
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –∑–∞–ø—Ä–æ—Å —Å `LEFT JOIN` –º–µ–∂–¥—É `user_internal_phones` –∏ `users`
- **UI**: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ —Å `onchange` –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
- **RetailCRM API**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `upsert_integration_module` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `integrations.telephony.additionalCodes`
- **–ö—ç—à –±—Ä–∞—É–∑–µ—Ä–∞**: –≤–µ—Ä—Å–∏—è JS –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ `app.js?v=202508091830`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## ‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –≤ –ë–î

### –ü—Ä–æ–±–ª–µ–º–∞
–ù—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –º–µ–∂–¥—É ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π RetailCRM –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è:
- –ë—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ UI
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–±–æ—è—Ö RetailCRM

### –í—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: JSONB –≤ `enterprises.integrations_config`

–•—Ä–∞–Ω–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤ —Ç–æ–º –∂–µ JSONB –ø–æ–ª–µ –≥–¥–µ —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è RetailCRM:

```json
{
  "retailcrm": {
    "domain": "https://evgenybaevski.retailcrm.ru",
    "api_key": "NsX6ZE1W6C8vOkkcNm2NBNLzwVJxLNvl",
    "enabled": true,
    "user_extensions": {
      "19": "150",    
      "18": "151",    
      "22": "152"
    },
    "last_sync": "2025-01-09T19:20:00Z"
  }
}
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

‚úÖ **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å**: –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –ù–µ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ JOIN'—ã
‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –î–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
‚úÖ **Backup/Restore**: –õ–µ–≥–∫–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å/–∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
‚úÖ **JSONB –∏–Ω–¥–µ–∫—Å—ã**: PostgreSQL –ø–æ–∑–≤–æ–ª—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–∫–∞—Ç—å –ø–æ –∫–ª—é—á–∞–º
‚úÖ **–°—Ö–µ–º–∞ —É–∂–µ –≥–æ—Ç–æ–≤–∞**: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏

1. **–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π**:
   ```python
   # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—à JSONB
   config['user_extensions']['19'] = '150'
   
   # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å RetailCRM
   additional_codes = [{"userId": "19", "code": "150"}]
   await client.upsert_integration_module(code, {"integrations": {"telephony": {"additionalCodes": additional_codes}}})
   ```

2. **–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤**:
   ```python
   # –ß–∏—Ç–∞–µ–º –∏–∑ –Ω–∞—à–µ–π –ë–î
   local_extensions = config.get('user_extensions', {})
   
   # –ß–∏—Ç–∞–µ–º –∏–∑ RetailCRM –¥–ª—è —Å–≤–µ—Ä–∫–∏
   retailcrm_extensions = await get_additional_codes_from_retailcrm()
   
   # –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
   ```

3. **–ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞—Ö**:
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º (–Ω–∞—à–∞ –ë–î)
   - RetailCRM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é
   - –ü—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è—Ö –ª–æ–≥–∏—Ä—É–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º RetailCRM

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

```sql
-- –í —Ç–∞–±–ª–∏—Ü–µ enterprises
integrations_config JSONB DEFAULT '{}'

-- –ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
{
  "retailcrm": {
    "domain": "https://evgenybaevski.retailcrm.ru",
    "api_key": "secret",
    "enabled": true,
    "user_extensions": {
      "19": "150",      -- RetailCRM user_id ‚Üí internal_number
      "18": "151",
      "22": null        -- null = –Ω–æ–º–µ—Ä —Å–Ω—è—Ç
    },
    "last_sync": "2025-01-09T19:20:00Z",
    "version": "1.0"
  }
}
```

### API –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è–º–∏

1. **–ß—Ç–µ–Ω–∏–µ**: `GET /api/user-extensions/{enterprise_number}`
2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: `POST /api/save-extensions/{enterprise_number}`
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: `POST /api/sync-extensions/{enterprise_number}`

### –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–î–∞–Ω–Ω—ã–µ –∏–∑ RetailCRM `additionalCodes` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## Playwright: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ RetailCRM

### –ú–∞—Ä—à—Ä—É—Ç –≤—Ö–æ–¥–∞ –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ Playwright

```python
# 1. –õ–æ–≥–∏–Ω –≤ RetailCRM
await page.goto("https://retailcrm.ru")
await page.fill('input[name="username"]', "evgeny.baevski@gmail.com")
await page.fill('input[name="password"]', "47916565+")
await page.click('button[type="submit"]')

# 2. –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
await page.goto("https://evgenybaevski.retailcrm.ru")

# 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
await page.click('a[href="/admin/settings"]')
await page.click('a[href="/admin/marketplace"]')

# 4. –ü–æ–∏—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Vochi-CRM
await page.click('text="–ü—Ä–æ—á–µ–µ"')  # –†–∞–∑–¥–µ–ª "–ü—Ä–æ—á–µ–µ"
await page.click('.marketplace-card:has-text("Vochi-CRM")')

# 5. –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
await page.goto("https://evgenybaevski.retailcrm.ru/admin/integration/vochi-telephony/edit")

# 6. –¢–µ—Å—Ç –∫–Ω–æ–ø–∫–∏ "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"
await page.click('button:has-text("–ü–µ—Ä–µ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç")')
# –î–æ–ª–∂–Ω–∞ –æ—Ç–∫—Ä—ã—Ç—å—Å—è –Ω–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞: https://bot.vochi.by/retailcrm-admin/?enterprise_number=0367&token=...
```

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ:
1. ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º URL
2. ‚úÖ JWT —Ç–æ–∫–µ–Ω –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
3. ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∞–¥–º–∏–Ω–∫–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º
5. ‚úÖ –ö–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å" –∏ "–£–¥–∞–ª–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é" —Ä–∞–±–æ—Ç–∞—é—Ç

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è:
- **405 Method Not Allowed**: –î–æ–±–∞–≤–ª–µ–Ω POST –º–∞—Ä—à—Ä—É—Ç –∫ GET `/retailcrm-admin/`
- **–û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**: JWT —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –≤ AuthMiddleware
- **–ü—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è
- **–°—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω –≤ –∫—ç—à–µ**: –ü–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üî• Click-to-Call –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è RetailCRM ‚Üî Asterisk

### –ü—Ä–æ–±–ª–µ–º–∞
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–æ–≤ –∏–∑ RetailCRM: –º–µ–Ω–µ–¥–∂–µ—Ä –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ RetailCRM ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è –∑–≤–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ Asterisk –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```mermaid
graph LR
    A[–ú–µ–Ω–µ–¥–∂–µ—Ä –≤ RetailCRM] --> B[–ö–ª–∏–∫ –Ω–∞ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞]
    B --> C[RetailCRM webhook]
    C --> D[retailcrm.py:8019]
    D --> E[–ü–æ–∏—Å–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è user_id]
    E --> F[asterisk.py:8018]
    F --> G[SSH CLI –∫–æ–º–∞–Ω–¥–∞]
    G --> H[Asterisk —Ö–æ—Å—Ç]
    H --> I[–ó–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω]
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

#### 1. **RetailCRM —Å—Ç–æ—Ä–æ–Ω–∞**
- **–¢–µ–ª–µ—Ñ–æ–Ω–∏—è –º–æ–¥—É–ª—å**: —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ `vochi-telephony`
- **Webhook URL**: –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –Ω–∞—à —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞—Ç–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
- **Click-to-Call**: —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ RetailCRM

#### 2. **retailcrm.py (–ø–æ—Ä—Ç 8019)**
- **Webhook endpoint**: –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç RetailCRM
- **–ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π RetailCRM user_id ‚Üî internal extensions
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å asterisk.py**: –≤—ã–∑–æ–≤—ã API –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–æ–≤

#### 3. **asterisk.py (–ø–æ—Ä—Ç 8018)**
- **API `/api/makecallexternal`**: —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–æ–≤
- **SSH CLI**: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Asterisk —Ö–æ—Å—Ç–∞–º
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**: —á–µ—Ä–µ–∑ clientId (secret –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π)

#### 4. **PostgreSQL**
- **enterprises.integrations_config**: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **user_internal_phones**: –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
- **enterprises**: —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ asterisk.py

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

#### –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
```json
{
  "retailcrm": {
    "domain": "https://evgenybaevski.retailcrm.ru",
    "api_key": "secret",
    "enabled": true,
    "user_extensions": {
      "19": "150",    // RetailCRM user_id ‚Üí internal_number
      "18": "151",
      "16": "152"
    }
  }
}
```

### API Endpoints

#### 1. **RetailCRM ‚Üí retailcrm.py**
```
POST /retailcrm/make-call
Parameters:
- clientId: string (RetailCRM integration token)
- userId: int (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ RetailCRM)
- phone: string (–Ω–æ–º–µ—Ä –¥–ª—è –∑–≤–æ–Ω–∫–∞)
- code: string (–¥–æ–±–∞–≤–æ—á–Ω—ã–π –Ω–æ–º–µ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

#### 2. **retailcrm.py ‚Üí asterisk.py**
```
GET /api/makecallexternal
Parameters:
- code: string (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä)
- phone: string (–Ω–æ–º–µ—Ä –¥–ª—è –∑–≤–æ–Ω–∫–∞)
- clientId: string (secret –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è)
```

### Workflow –ø—Ä–æ—Ü–µ—Å—Å–∞

#### 1. **–ò–Ω–∏—Ü–∏–∞—Ü–∏—è –∏–∑ RetailCRM**
```javascript
// –ú–µ–Ω–µ–¥–∂–µ—Ä –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ RetailCRM
// RetailCRM –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook:
POST https://bot.vochi.by/retailcrm/make-call
{
  "clientId": "integration-token-from-retailcrm",
  "userId": 19,
  "phone": "+375296254070",
  "code": "150"  // –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
}
```

#### 2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ retailcrm.py**
```python
async def handle_retailcrm_call_request(userId: int, phone: str, clientId: str):
    # 1. –ù–∞—Ö–æ–¥–∏–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –ø–æ clientId/token
    enterprise = await find_enterprise_by_integration_token(clientId)
    
    # 2. –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    user_extensions = await load_user_extensions_from_db(enterprise.number)
    
    # 3. –ù–∞—Ö–æ–¥–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä –ø–æ userId
    internal_extension = user_extensions.get(str(userId))
    
    # 4. –í—ã–∑—ã–≤–∞–µ–º asterisk.py –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞
    response = await call_asterisk_api(
        code=internal_extension,
        phone=phone,
        clientId=enterprise.secret
    )
    
    return response
```

#### 3. **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ asterisk.py**
```python
# asterisk.py –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç SSH –∫–æ–º–∞–Ω–¥—É:
async def makecallexternal(code: str, phone: str, clientId: str):
    # 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ clientId
    enterprise = await validate_client_secret(clientId)
    
    # 2. SSH –∫–æ–º–∞–Ω–¥–∞ –∫ Asterisk
    result = ssh_originate_call(
        host_ip=enterprise.ip,
        from_ext=code,  # "150"
        to_phone=phone  # "+375296254070"
    )
    
    # SSH –∫–æ–º–∞–Ω–¥–∞:
    # asterisk -rx "channel originate LOCAL/150@inoffice application Dial LOCAL/+375296254070@inoffice"
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### ‚úÖ **–£–∂–µ –≥–æ—Ç–æ–≤–æ**
- ‚úÖ asterisk.py API –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–æ–≤
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π user_extensions –≤ –ë–î
- ‚úÖ UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- ‚úÖ RetailCRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω

#### üî® **–ù—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å**
- ‚ùå Webhook endpoint –≤ retailcrm.py
- ‚ùå –ü–æ–∏—Å–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –ø–æ integration token
- ‚ùå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è retailcrm.py ‚Üî asterisk.py
- ‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook URL –≤ RetailCRM
- ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚ùå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ñ–ª–æ—É

### –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### **–≠—Ç–∞–ø 1: Webhook endpoint**
```python
@app.post("/retailcrm/make-call")
async def retailcrm_make_call_webhook(
    clientId: str,
    userId: int,
    phone: str,
    code: str = None
):
    """Webhook –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞ –∏–∑ RetailCRM"""
    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ –≤—ã–∑–æ–≤–∞ asterisk.py
```

#### **–≠—Ç–∞–ø 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å asterisk.py**
```python
async def initiate_call_via_asterisk(
    enterprise_number: str,
    internal_extension: str,
    target_phone: str
) -> Dict[str, Any]:
    """–í—ã–∑–æ–≤ asterisk.py API –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞"""
    # HTTP –∑–∞–ø—Ä–æ—Å –∫ localhost:8018/api/makecallexternal
```

#### **–≠—Ç–∞–ø 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ RetailCRM**
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ integration module —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º webhook URL
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –¥–ª—è Click-to-Call
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ RetailCRM

#### **–≠—Ç–∞–ø 4: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
- –õ–æ–≥–∏ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ Click-to-Call
- –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–æ–≤
- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω—è—Ö**
1. **RetailCRM ‚Üí retailcrm.py**: integration token/clientId
2. **retailcrm.py ‚Üí asterisk.py**: enterprise secret
3. **asterisk.py ‚Üí Asterisk**: SSH –∫–ª—é—á–∏

#### **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è userId –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π
- –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–∞—Ö–æ–¥–∏—Ç –≤ RetailCRM
2. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–µ–Ω—Ç–∞
3. –ö–ª–∏–∫–∞–µ—Ç –Ω–∞ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
4. –ù–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è –∑–≤–æ–Ω–æ–∫
5. –¢–µ–ª–µ—Ñ–æ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∑–≤–æ–Ω–∏—Ç ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥–Ω–∏–º–∞–µ—Ç —Ç—Ä—É–±–∫—É ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ñ–ª–æ—É:**
```
RetailCRM UI ‚Üí webhook ‚Üí retailcrm.py ‚Üí asterisk.py ‚Üí SSH ‚Üí Asterisk ‚Üí –∑–≤–æ–Ω–æ–∫
```

### –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á

- [x] **–ò–∑—É—á–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã**: asterisk.py –∏ RetailCRM API
- [x] **Webhook endpoint**: `/retailcrm/make-call`
- [x] **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è**: –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
- [x] **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: retailcrm.py ‚Üî asterisk.py
- [x] **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ RetailCRM webhook
- [x] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ø–æ–ª–Ω—ã–π —Ñ–ª–æ—É Click-to-Call

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### ‚úÖ **–¢–µ—Å—Ç 1: –ü–æ–∏—Å–∫ –ø–æ userId**
```bash
curl "http://localhost:8019/retailcrm/make-call?clientId=d68409d67e3b4b87a6675e76dae74a85&userId=19&phone=%2B375296254070"
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: 
- ‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ: june (0367)
- ‚úÖ –ù–∞–π–¥–µ–Ω extension –ø–æ userId 19: 150
- ‚úÖ Asterisk API —É—Å–ø–µ—à–Ω–æ: –∑–≤–æ–Ω–æ–∫ 150 ‚Üí +375296254070
- ‚úÖ –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 1200ms

#### ‚úÖ **–¢–µ—Å—Ç 2: –Ø–≤–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∫–æ–¥**
```bash
curl "http://localhost:8019/retailcrm/make-call?clientId=d68409d67e3b4b87a6675e76dae74a85&userId=99&phone=%2B375296254070&code=151"
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —É–∫–∞–∑–∞–Ω–Ω—ã–π –∫–æ–¥: 151 (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ userId)
- ‚úÖ Asterisk API —É—Å–ø–µ—à–Ω–æ: –∑–≤–æ–Ω–æ–∫ 151 ‚Üí +375296254070
- ‚úÖ –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 1240ms

#### ‚úÖ **–¢–µ—Å—Ç 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
```bash
curl "http://localhost:8019/retailcrm/make-call?clientId=d68409d67e3b4b87a6675e76dae74a85&userId=999&phone=%2B375296254070"
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ HTTP 400: "No extension configured for user 999"
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ñ–ª–æ—É (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)

```
1. RetailCRM UI ‚Üí –∫–ª–∏–∫ –Ω–∞ –Ω–æ–º–µ—Ä
2. POST /retailcrm/make-call (clientId, userId, phone)
3. retailcrm.py: –ø–æ–∏—Å–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –ø–æ clientId
4. retailcrm.py: –ø–æ–∏—Å–∫ extension –ø–æ userId –≤ user_extensions 
5. HTTP GET localhost:8018/api/makecallexternal (code, phone, clientId)
6. asterisk.py: SSH –∫–æ–º–∞–Ω–¥–∞ –∫ Asterisk —Ö–æ—Å—Ç—É
7. Asterisk: –∏–Ω–∏—Ü–∏–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞ LOCAL/150@inoffice ‚Üí LOCAL/phone@inoffice
8. –†–µ–∑—É–ª—å—Ç–∞—Ç: —Ç–µ–ª–µ—Ñ–æ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∑–≤–æ–Ω–∏—Ç ‚Üí –∞–≤—Ç–æ—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º
```

### ‚ùå **–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**

**–ü—Ä–æ–±–ª–µ–º–∞**: –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö RetailCRM –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è "–ù–µ—Ç" –¥–ª—è "–°—Å—ã–ª–∫–∞ –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞", —Ö–æ—Ç—è webhook —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.

**–ü—Ä–∏—á–∏–Ω–∞**: –°–æ–≥–ª–∞—Å–Ω–æ [–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ RetailCRM](https://docs.retailcrm.ru/Developers/API/APIFeatures/TelephonyApiV4#Registration), –ø–æ–ª—è `makeCallUrl`, `changeUserStatusUrl` –∏ `additionalCodes` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **–≤ –∫–æ—Ä–Ω–µ** –æ–±—ä–µ–∫—Ç–∞ `integrationModule`, –∞ –ù–ï –≤ `configuration`.

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–±—ã–ª–æ):**
```json
{
  "code": "vochi-telephony",
  "active": true,
  "name": "Vochi-CRM",
  "configuration": {
    "makeCallUrl": "https://bot.vochi.by/retailcrm/make-call",
    "changeUserStatusUrl": "https://bot.vochi.by/retailcrm/status"
  }
}
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—Å—Ç–∞–ª–æ):**
```json
{
  "code": "vochi-telephony", 
  "active": true,
  "name": "Vochi-CRM",
  "makeCallUrl": "https://bot.vochi.by/retailcrm/make-call",
  "changeUserStatusUrl": "https://bot.vochi.by/retailcrm/status",
  "additionalCodes": [],
  "externalPhones": []
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ `retailcrm.py`:**
- ‚úÖ –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã `makeCallUrl` –∏ `changeUserStatusUrl` –≤ –∫–æ—Ä–µ–Ω—å –æ–±—ä–µ–∫—Ç–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã `additionalCodes` –∏ `externalPhones` –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —á—Ç–µ–Ω–∏–µ `additionalCodes` (–∫–æ—Ä–µ–Ω—å ‚Üí –≤–ª–æ–∂–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–æ–¥—É–ª—è

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –ü–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ RetailCRM –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.

### ‚úÖ **–ó–ê–î–ê–ß–ê –ü–û–õ–ù–û–°–¢–¨–Æ –í–´–ü–û–õ–ù–ï–ù–ê**

#### **–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:**

1. **‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å "June" –Ω–∞ "June RetailCRM"
2. **‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**: `makeCallUrl` –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ `integrations.telephony`
3. **‚úÖ –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `clientId = enterprise_number`
4. **‚úÖ User extensions**: –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
5. **‚úÖ Webhook endpoint**: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

#### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

```bash
# Manual test - ‚úÖ –£–°–ü–ï–®–ù–û
curl "http://localhost:8019/retailcrm/make-call?clientId=0367&userId=18&phone=%2B375296254070"
# ‚Üí HTTP 200, –∑–≤–æ–Ω–æ–∫ 151 ‚Üí +375296254070

# RetailCRM integration status - ‚úÖ –£–°–ü–ï–®–ù–û  
makeCallUrl: https://bot.vochi.by/retailcrm/make-call
active: True
```

#### **–¢–µ–∫—É—â–∞—è —Ä–∞–±–æ—á–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```json
{
  "integrations": {
    "telephony": {
      "makeCallUrl": "https://bot.vochi.by/retailcrm/make-call",
      "additionalCodes": [
        {"userId": 16, "code": "152"},
        {"userId": 18, "code": "151"}, 
        {"userId": 19, "code": "150"}
      ]
    }
  }
}
```

**–°—Ç–∞—Ç—É—Å:** üéâ **–ì–û–¢–û–í–û –ö PRODUCTION**

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í–æ–∑–º–æ–∂–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ Click-to-Call –≤ UI RetailCRM –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª—è. –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞.

---

## üîÑ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

–í —Å–∏—Å—Ç–µ–º–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

#### **1. –ö—ç—à –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –≤ `retailcrm.py` (–ø–æ—Ä—Ç 8019)**
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π RetailCRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **–î–∞–Ω–Ω—ã–µ**: API –∫–ª—é—á–∏, –¥–æ–º–µ–Ω—ã, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å**: –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ + —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

#### **2. –ö—ç—à –º–∞—Ç—Ä–∏—Ü—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –≤ `integration_cache.py` (–ø–æ—Ä—Ç 8020)**
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ë—ã—Å—Ç—Ä–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
- **–î–∞–Ω–Ω—ã–µ**: –ú–∞—Ç—Ä–∏—Ü–∞ `enterprise_number ‚Üí {retailcrm: bool, amocrm: bool, ...}`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: Call-—Å–µ—Ä–≤–∏—Å—ã (dial.py, bridge.py, hangup.py, download.py)

### üìä –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏ `integration_cache.py`

#### **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫—ç—à–∞:**
```python
# –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∑–∞–ø–∏—Å–∏ –≤ –∫—ç—à–µ
CACHE_TTL_SECONDS = 90  # 1.5 –º–∏–Ω—É—Ç—ã

# –ò–Ω—Ç–µ—Ä–≤–∞–ª —Ñ–æ–Ω–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è  
FULL_REFRESH_INTERVAL = 240  # 4 –º–∏–Ω—É—Ç—ã –±–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
FULL_REFRESH_JITTER = 60     # ¬±60 —Å–µ–∫—É–Ω–¥ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è

# –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
CACHE_CLEANUP_INTERVAL = 30  # 30 —Å–µ–∫—É–Ω–¥
```

#### **–†–µ–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã —Ä–∞–±–æ—Ç—ã:**
- **TTL –∑–∞–ø–∏—Å–∏**: `90 —Å–µ–∫—É–Ω–¥` (–∑–∞–ø–∏—Å—å —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–µ–π —á–µ—Ä–µ–∑ 1.5 –º–∏–Ω—É—Ç—ã)
- **–§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –∫–∞–∂–¥—ã–µ `180-300 —Å–µ–∫—É–Ω–¥` (3-5 –º–∏–Ω—É—Ç —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º)
- **–û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö**: –∫–∞–∂–¥—ã–µ `30 —Å–µ–∫—É–Ω–¥`

#### **–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –∫—ç—à–∞:**
1. **–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API** (`/integrations/{enterprise_number}`):
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–æ–∑—Ä–∞—Å—Ç –∑–∞–ø–∏—Å–∏ –≤ –∫—ç—à–µ
   - –ï—Å–ª–∏ `age > 90 —Å–µ–∫` ‚Üí **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î**
   - –ï—Å–ª–∏ `age ‚â§ 90 —Å–µ–∫` ‚Üí **–≤–æ–∑–≤—Ä–∞—Ç –∏–∑ –∫—ç—à–∞**

2. **–§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å** (`periodic_full_refresh`):
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 3-5 –º–∏–Ω—É—Ç —Å —Å–ª—É—á–∞–π–Ω—ã–º –¥–∂–∏—Ç—Ç–µ—Ä–æ–º
   - –û–±–Ω–æ–≤–ª—è–µ—Ç **–≤—Å–µ** –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –ë–î
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (anti-stampede)

3. **–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞** (`cleanup_expired_entries`):
   - –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ `CACHE_TTL_SECONDS`
   - –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–∞–º—è—Ç—å –æ—Ç –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞

#### **–ü—Ä–æ–±–ª–µ–º–∞:**
–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å TTL –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ 3-5 –º–∏–Ω—É—Ç (–ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ–Ω–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏).

#### **–†–µ—à–µ–Ω–∏–µ: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è**
–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ `retailcrm.py` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ `integration_cache.py`.

#### **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏:**

**1. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –¥–æ–±–∞–≤–æ—á–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤:**
```python
# –í —Ñ—É–Ω–∫—Ü–∏–∏ save_user_extensions_to_db()
async with aiohttp.ClientSession() as session:
    async with session.post(f"http://localhost:8020/cache/invalidate/{enterprise_number}") as cache_response:
        if cache_response.status == 200:
            logger.info(f"‚úÖ Integration cache invalidated for {enterprise_number}")
```

**2. –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**
```python  
# –í —Ñ—É–Ω–∫—Ü–∏–∏ upsert_retailcrm_config()
async with aiohttp.ClientSession() as session:
    async with session.post(f"http://localhost:8020/cache/invalidate/{enterprise_number}") as cache_response:
        if cache_response.status == 200:
            logger.info(f"‚úÖ Integration cache invalidated for {enterprise_number}")
```

#### **API —ç–Ω–¥–ø–æ–∏–Ω—Ç –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
```http
POST /cache/invalidate/{enterprise_number}
```
**–î–µ–π—Å—Ç–≤–∏–µ**: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –∏–∑ –∫—ç—à–∞, –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –ë–î.

### üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

#### **‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- Call-—Å–µ—Ä–≤–∏—Å—ã –ø–æ–ª—É—á–∞—é—Ç –æ—Ç–≤–µ—Ç –æ —Å—Ç–∞—Ç—É—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∑–∞ `< 1ms` (–∏–∑ –ø–∞–º—è—Ç–∏)
- –ü–æ–ª–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ PostgreSQL

#### **‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:**
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏) –≤–∏–¥–Ω—ã **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ**
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–±–∞–≤–æ—á–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ**
- –§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤—ã–≤–∞–µ—Ç –æ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–π

#### **‚úÖ –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:**
- –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ `integration_cache.py` call-—Å–µ—Ä–≤–∏—Å—ã –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ –ë–î
- TTL –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–∑–∞–≤–∏—Å–∞–Ω–∏–µ" —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –î–∂–∏—Ç—Ç–µ—Ä –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î

### üõ†Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

#### **–ú–µ—Ç—Ä–∏–∫–∏ –∫—ç—à–∞ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑:**
```http
GET /stats
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "cache_stats": {
    "total_entries": 15,
    "hits": 342,
    "misses": 18,
    "hit_ratio": 0.95,
    "last_full_refresh": "2025-01-09T15:30:45Z"
  },
  "uptime_seconds": 7265,
  "database_queries": 133
}
```

#### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è:**
```http
GET /integrations/{enterprise_number}
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "enterprise_number": "0367",
  "integrations": {
    "retailcrm": true,
    "amocrm": false
  },
  "cached_at": "2025-01-09T15:28:30Z",
  "age_seconds": 45
}
```

### üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

#### **–î–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º:**
- –£–≤–µ–ª–∏—á–∏—Ç—å `CACHE_TTL_SECONDS` –¥–æ `300` (5 –º–∏–Ω—É—Ç)
- –£–º–µ–Ω—å—à–∏—Ç—å `FULL_REFRESH_INTERVAL` –¥–æ `180` (3 –º–∏–Ω—É—Ç—ã)
- –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–∏–π –¥–∂–∏—Ç—Ç–µ—Ä –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏

#### **–î–ª—è —Å–∏—Å—Ç–µ–º —Å —á–∞—Å—Ç—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏:**
- –£–º–µ–Ω—å—à–∏—Ç—å `CACHE_TTL_SECONDS` –¥–æ `60` (1 –º–∏–Ω—É—Ç–∞)
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å NOTIFY –º–µ—Ö–∞–Ω–∏–∑–º PostgreSQL –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –î–æ–±–∞–≤–∏—Ç—å webhook'–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

### ‚ö° –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

#### **‚ùì –ù—É–∂–Ω–æ –ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫—ç—à –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö?**

**‚úÖ –û–¢–í–ï–¢: –ù–ï–¢** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞!

**–°—Ü–µ–Ω–∞—Ä–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

**1. –ò–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ –Ω–∞—à—É –∞–¥–º–∏–Ω–∫—É RetailCRM:**
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- ‚úÖ **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î

**2. –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î:**
- ‚ö†Ô∏è **–†—É—á–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è** - —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–∑–æ–≤ `POST /cache/invalidate/{enterprise_number}`
- üîÑ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - —á–µ—Ä–µ–∑ 3-5 –º–∏–Ω—É—Ç –ø—Ä–∏ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ—Ñ—Ä–µ—à–µ

**3. –ò–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã:**
- üõ†Ô∏è **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ integration_client.py** - –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏
- üì° **NOTIFY –º–µ—Ö–∞–Ω–∏–∑–º** - –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### üìã –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—ç—à–∞

**–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**

1. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é:**
   ```bash
   curl -s "http://localhost:8020/stats" | grep last_invalidation
   ```

2. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:**
   ```bash
   curl -s "http://localhost:8020/integrations/0367" | python3 -m json.tool
   ```

3. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ `integration_cache`:**
   ```bash
   tail -f logs/integration_cache.log | grep "invalidated\|refreshed"
   ```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û**