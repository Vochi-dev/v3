# Hangup Events - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Ä–µ—à–µ–Ω–∏—è

## –ù–µ—É–¥–∞—á–Ω—ã–µ live hangup

### –ü—Ä–æ–±–ª–µ–º–∞

–ö–æ–≥–¥–∞ hangup –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, –Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–±—ã—Ç–∏—è (dial, bridge) –±—ã–ª–∏ –ø–æ—Ç–µ—Ä—è–Ω—ã –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ç—å—é, –º—ã –Ω–µ –º–æ–∂–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–ª:

```
–í—Ä–µ–º—è T1: dial –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚Üí —Ö–æ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí dial –ø–æ—Ç–µ—Ä—è–Ω
–í—Ä–µ–º—è T2: bridge –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚Üí —Ö–æ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí bridge –ø–æ—Ç–µ—Ä—è–Ω  
–í—Ä–µ–º—è T3: hangup –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚Üí —Ö–æ—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí hangup –¥–æ—à—ë–ª —Å Extensions=[""]
```

### –†–µ—à–µ–Ω–∏–µ: Fallback Extension

–ü–æ—Å–∫–æ–ª—å–∫—É —Ç–∞–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π –∏—Å—á–µ–∑–∞—é—â–µ –º–∞–ª–æ, –ø—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥:

#### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (—Å–µ–π—á–∞—Å)

–ï—Å–ª–∏ hangup –ø—Ä–∏—à—ë–ª —Å Extensions=[""] –∏ –∫—ç—à (dial_cache, bridge_store) –ø—É—Å—Ç–æ–π:
1. –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –Ω–æ–º–µ—Ä–æ–≤ —é–Ω–∏—Ç–∞
2. –í–∑—è—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –∫–∞–∫ internal_phone

**–ü—Ä–∏–º–µ—Ä:**
- –Æ–Ω–∏—Ç –∏–º–µ–µ—Ç –Ω–æ–º–µ—Ä–∞: 150, 151, 154, 155
- –ü—Ä–∏–ª–µ—Ç–∞–µ—Ç hangup –±–µ–∑ Extensions
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä–∞ —é–Ω–∏—Ç–∞ ‚Üí [150, 151, 154, 155]
- –ë–µ—Ä—ë–º min() ‚Üí 150
- –ò—Å–ø–æ–ª—å–∑—É–µ–º 150 –∫–∞–∫ –Ω–æ–º–µ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞

#### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π)

–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —é–Ω–∏—Ç–∞ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ù–æ–º–µ—Ä –¥–ª—è –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤:    ‚îÇ
‚îÇ [   150   ] ‚Üê –Ω–æ–º–µ—Ä —Å–µ–∫—Ä–µ—Ç–∞—Ä—è        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ü—Ä–∏ –Ω–µ–ø–æ–ª–Ω–æ–º hangup ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä.

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (–∫–æ–Ω—Ü–µ–ø—Ç)

```python
# –í hangup.py, –∫–æ–≥–¥–∞ Extensions –ø—É—Å—Ç—ã–µ –∏ –∫—ç—à –ø—É—Å—Ç–æ–π:

async def get_fallback_extension(enterprise_id: int) -> str | None:
    """–ü–æ–ª—É—á–∏—Ç—å fallback –Ω–æ–º–µ—Ä (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π extension —é–Ω–∏—Ç–∞)"""
    try:
        # –ó–∞–ø—Ä–æ—Å –∫ metadata_client –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –∫ –ë–î
        extensions = await metadata_client.get_unit_extensions(enterprise_id)
        if extensions:
            return min(extensions)  # –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä
    except Exception as e:
        logger.error(f"Failed to get fallback extension: {e}")
    return None
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** ‚Äî –Ω–µ –Ω—É–∂–Ω—ã —Å–ª–æ–∂–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏ –∏ –æ–∂–∏–¥–∞–Ω–∏—è —Ö–æ—Å—Ç–∞
2. **–ó–≤–æ–Ω–æ–∫ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è** ‚Äî –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É
3. **CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç** ‚Äî –∑–≤–æ–Ω–æ–∫ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
4. **–†–µ–¥–∫–æ—Å—Ç—å —Å–∏—Ç—É–∞—Ü–∏–∏** ‚Äî –µ—Å–ª–∏ —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞–µ–≤ –º–∞–ª–æ, —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞
5. **–≠–≤–æ–ª—é—Ü–∏—è —Ä–µ—à–µ–Ω–∏—è** ‚Äî —Å–Ω–∞—á–∞–ª–∞ min(), –ø–æ—Ç–æ–º –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –Ω–æ–º–µ—Ä

---

## –ú–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏—è download.py - Recovery hangup —Å–æ–±—ã—Ç–∏—è

### –¶–µ–ª—å

–°–æ–æ–±—â–µ–Ω–∏—è –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–∞—Ö (recovery) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **–ê–ë–°–û–õ–Æ–¢–ù–û –ò–î–ï–ù–¢–ò–ß–ù–´** —É—Å–ø–µ—à–Ω—ã–º (live) —Å–æ–æ–±—â–µ–Ω–∏—è–º, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –∑–Ω–∞—á–∫–∞ ‚ôªÔ∏è –≤ —à–∞–ø–∫–µ.

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ download.py

#### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–µ–π—á–∞—Å:
```
1. SQL –∑–∞–ø—Ä–æ—Å: SELECT ... FROM AlternativeAPIlogs WHERE event = "hangup" AND status != 200
2. –ü–∞—Ä—Å–∏—Ç –¢–û–õ–¨–ö–û hangup —Å–æ–±—ã—Ç–∏–µ
3. –§–æ—Ä–º–∏—Ä—É–µ—Ç Telegram —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π..."
```

#### –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

| –ü—Ä–æ–±–ª–µ–º–∞ | Live (hangup.py) | Recovery (download.py) |
|----------|------------------|------------------------|
| –ó–∞–≥–æ–ª–æ–≤–æ–∫ | `‚úÖ–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫` | `üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫` |
| –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ | `üí∞+375291234567 (–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω)` | `üí∞+375291234567` |
| –§–ò–û –º–µ–Ω–µ–¥–∂–µ—Ä–∞ | `‚òéÔ∏è–ü–µ—Ç—Ä–æ–≤ –ü—ë—Ç—Ä (151)` | `‚òéÔ∏è151` |
| –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏ | `üì°–û—Å–Ω–æ–≤–Ω–∞—è –ª–∏–Ω–∏—è` | `–õ–∏–Ω–∏—è: SIP/trunk` |
| Extensions | –ë–µ—Ä—ë—Ç –∏–∑ dial_cache/bridge_store | –¢–æ–ª—å–∫–æ –∏–∑ hangup (–º–æ–∂–µ—Ç –±—ã—Ç—å [""]) |
| –ö–Ω–æ–ø–∫–∏ | –î–µ—Ç–∞–ª–∏ –∑–≤–æ–Ω–∫–∞, –ü–æ–∑–≤–æ–Ω–∏—Ç—å | –ù–µ—Ç |

#### –î–∞–Ω–Ω—ã–µ –≤ AlternativeAPIlogs –ø–æ UniqueId:

```sql
SELECT event, request FROM AlternativeAPIlogs WHERE Uniqueid = '1765125893.159';
```

| event | –ö–ª—é—á–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ |
|-------|-----------------|
| dial | `Extensions: ["151"]` ‚Üê internal_phone! |
| bridge | `CallerIDNum: "151"` ‚Üê internal_phone! |
| bridge_leave | `CallerIDNum: "151"` ‚Üê internal_phone! |
| hangup | `Extensions: [""]` ‚Üê –ü–£–°–¢–û! |

**–í—ã–≤–æ–¥:** –î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ recovery –Ω—É–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ hangup, –Ω–æ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è dial/bridge.

### –¶–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

#### –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π (live):
```
‚úÖ–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
üí∞+375291234567 (–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω)
‚òéÔ∏è–ü–µ—Ç—Ä–æ–≤ –ü—ë—Ç—Ä (151)
üì°–û—Å–Ω–æ–≤–Ω–∞—è –ª–∏–Ω–∏—è
‚è∞–ù–∞—á–∞–ª–æ –∑–≤–æ–Ω–∫–∞ 14:35
‚åõ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 03:24
üîâ–ó–∞–ø–∏—Å—å —Ä–∞–∑–≥–æ–≤–æ—Ä–∞  ‚Üê –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
```

#### –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π (recovery) - –¶–ï–õ–ï–í–û–ô:
```
‚úÖüîÑ–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
üí∞+375291234567 (–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω)
‚òéÔ∏è–ü–µ—Ç—Ä–æ–≤ –ü—ë—Ç—Ä (151)
üì°–û—Å–Ω–æ–≤–Ω–∞—è –ª–∏–Ω–∏—è
‚è∞–ù–∞—á–∞–ª–æ –∑–≤–æ–Ω–∫–∞ 14:35
‚åõ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 03:24
üîâ–ó–∞–ø–∏—Å—å —Ä–∞–∑–≥–æ–≤–æ—Ä–∞  ‚Üê –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞
```

**–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Ç–ª–∏—á–∏–µ:** –∑–Ω–∞—á–æ–∫ ‚ôªÔ∏è –ø–æ—Å–ª–µ ‚úÖ –∏–ª–∏ ‚ùå

---

## TODO –¢—Ä–µ–∫–µ—Ä - –ú–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏—è download.py

### –≠—Ç–∞–ø 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

- [ ] **1.1** –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `get_related_events_by_uniqueid(enterprise_id, db_file, uniqueid)`
  - SSH –∑–∞–ø—Ä–æ—Å –∫ —Ö–æ—Å—Ç—É
  - SQL: `SELECT event, request FROM AlternativeAPIlogs WHERE Uniqueid = '{uniqueid}' AND event IN ('dial', 'bridge', 'bridge_leave')`
  - –ü–∞—Ä—Å–∏–Ω–≥ JSON —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

- [ ] **1.2** –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `extract_internal_phone_from_related_events(events)`
  - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: dial.Extensions[0] ‚Üí bridge.CallerIDNum ‚Üí bridge_leave.CallerIDNum
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç internal_phone –∏–ª–∏ None

- [ ] **1.3** –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `sync_live_events()`:
  - –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è hangup ‚Üí –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
  - –ï—Å–ª–∏ hangup.Extensions –ø—É—Å—Ç–æ ‚Üí –≤–∑—è—Ç—å –∏–∑ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö
  - –û–±–Ω–æ–≤–∏—Ç—å call_data —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º internal_phone

### –≠—Ç–∞–ø 2: –û–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (enrichment)

- [ ] **2.1** –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ enrichment API (–ø–æ—Ä—Ç 8020):
  ```python
  async def enrich_recovery_data(enterprise_number, internal_phone, external_phone, trunk):
      # HTTP –∑–∞–ø—Ä–æ—Å –∫ http://127.0.0.1:8020/...
      # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: customer_name, manager_name, line_name
  ```

- [ ] **2.2** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `metadata_client` –∏–ª–∏ HTTP –≤—ã–∑–æ–≤ –∫ 8020:
  - `GET http://127.0.0.1:8020/customer-profile/{enterprise}/{phone}` ‚Üí –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
  - `GET http://127.0.0.1:8020/manager/{enterprise}/{extension}` ‚Üí –§–ò–û –º–µ–Ω–µ–¥–∂–µ—Ä–∞  
  - `GET http://127.0.0.1:8020/line/{enterprise}/{trunk}` ‚Üí –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏

### –≠—Ç–∞–ø 3: –§–æ—Ä–º–∞—Ç Telegram —Å–æ–æ–±—â–µ–Ω–∏—è

- [ ] **3.1** –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å `send_recovery_telegram_message()`:
  - –ó–∞–º–µ–Ω–∏—Ç—å `üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π...` –Ω–∞ `‚úÖüîÑ–£—Å–ø–µ—à–Ω—ã–π...` / `‚ùåüîÑ–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π...`
  - –î–æ–±–∞–≤–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞: `üí∞{phone} ({customer_name})`
  - –î–æ–±–∞–≤–∏—Ç—å –§–ò–û –º–µ–Ω–µ–¥–∂–µ—Ä–∞: `‚òéÔ∏è{manager_name} ({extension})`
  - –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏: `üì°{line_name}`

- [ ] **3.2** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å hangup.py:
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ `format_phone_number()`
  - –¢–µ –∂–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–ª–µ–π
  - –¢–æ—Ç –∂–µ –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫

### –≠—Ç–∞–ø 4: –ö–Ω–æ–ø–∫–∏ –∏ –¥–µ—Ç–∞–ª–∏

- [ ] **4.1** –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–î–µ—Ç–∞–ª–∏ –∑–≤–æ–Ω–∫–∞" (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
  - –¢–æ–ª—å–∫–æ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–≤–æ–Ω–∫–æ–≤ (–Ω–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö)
  - –¢—Ä–µ–±—É–µ—Ç enterprise_secret

- [ ] **4.2** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∫–Ω–æ–ø–∫—É "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):
  - –¢—Ä–µ–±—É–µ—Ç –∑–Ω–∞—Ç—å chat_id –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
  - –î–ª—è recovery –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ

### –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] **5.1** –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
  - –ó–∞–ø—É—Å—Ç–∏—Ç—å sync –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —é–Ω–∏—Ç–∞
  - –°—Ä–∞–≤–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç recovery vs live —Å–æ–æ–±—â–µ–Ω–∏–π
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ç–∏–ø—ã: –≤—Ö–æ–¥—è—â–∏–π —É—Å–ø–µ—à–Ω—ã–π, –≤—Ö–æ–¥—è—â–∏–π –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π, –∏—Å—Ö–æ–¥—è—â–∏–π —É—Å–ø–µ—à–Ω—ã–π, –∏—Å—Ö–æ–¥—è—â–∏–π –Ω–µ—É—Å–ø–µ—à–Ω—ã–π

- [ ] **5.2** –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤ Telegram:
  - Live –∏ recovery —Å–æ–æ–±—â–µ–Ω–∏—è —Ä—è–¥–æ–º
  - –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Ç–ª–∏—á–∏–µ - –∑–Ω–∞—á–æ–∫ ‚ôªÔ∏è

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ó–∞–¥–∞—á–∞ | –í–ª–∏—è–Ω–∏–µ |
|-----------|--------|---------|
| üî¥ HIGH | 1.1-1.3 –ü–æ–ª—É—á–µ–Ω–∏–µ internal_phone | –ë–µ–∑ —ç—Ç–æ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∏—á–µ–≥–æ |
| üî¥ HIGH | 3.1 –§–æ—Ä–º–∞—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ (‚úÖüîÑ –≤–º–µ—Å—Ç–æ üîÑ) | UX - –Ω–µ –ø—É–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| üü° MEDIUM | 2.1-2.2 Enrichment | –ò–º–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ |
| üü° MEDIUM | 3.2 –ü–æ–ª–Ω–∞—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è | –ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π |
| üü¢ LOW | 4.1-4.2 –ö–Ω–æ–ø–∫–∏ | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª |

---

### –ö–æ–Ω—Ü–µ–ø—Ç –∫–æ–¥–∞: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

```python
def get_related_events_by_uniqueid(enterprise_id: str, db_file: str, uniqueid: str) -> List[Dict]:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (dial, bridge) –ø–æ UniqueId –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è internal_phone"""
    enterprises = get_active_enterprises()
    config = enterprises.get(enterprise_id)
    if not config:
        return []
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º dial, bridge, bridge_leave —Å–æ–±—ã—Ç–∏—è –ø–æ —Ç–æ–º—É –∂–µ UniqueId
    cmd = f'''sshpass -p "{config["ssh_password"]}" ssh -p {config["ssh_port"]} -o StrictHostKeyChecking=no root@{config["ip"]} 'sqlite3 {db_file} "SELECT event, request FROM AlternativeAPIlogs WHERE Uniqueid = \\"{uniqueid}\\" AND event IN (\\"dial\\", \\"bridge\\", \\"bridge_leave\\")"' '''
    
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=30)
        if result.returncode != 0:
            return []
        
        events = []
        for line in result.stdout.strip().split('\n'):
            if line and '|' in line:
                event_type, request_json = line.split('|', 1)
                try:
                    data = json.loads(request_json)
                    events.append({'event': event_type, 'data': data})
                except json.JSONDecodeError:
                    pass
        return events
    except Exception as e:
        logger.error(f"Error getting related events: {e}")
        return []


def extract_internal_phone_from_related(related_events: List[Dict]) -> Optional[str]:
    """–ò–∑–≤–ª–µ—á—å internal_phone –∏–∑ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π"""
    for event in related_events:
        event_type = event.get('event')
        data = event.get('data', {})
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: dial.Extensions[0]
        if event_type == 'dial':
            extensions = data.get('Extensions', [])
            if extensions and extensions[0]:
                return extensions[0]
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: bridge.CallerIDNum (–µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)
        if event_type == 'bridge':
            caller_id = data.get('CallerIDNum')
            if caller_id and len(caller_id) <= 4:  # –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä
                return caller_id
    
    return None
```

