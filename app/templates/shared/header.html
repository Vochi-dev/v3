<style>
  .main-header {
    background-color: #2c3e50; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π/—Å–∏–Ω–∏–π —Ñ–æ–Ω, –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ */
    color: #ffffff;
    padding: 8px 15px;
    display: flex;
    align-items: center;
    border-bottom: 2px solid #34495e; /* –ß—É—Ç—å –±–æ–ª–µ–µ —Ç–µ–º–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ —Å–Ω–∏–∑—É */
  }
  .main-header .logo-container {
    margin-right: 20px;
  }
  .main-header .logo-container img {
    height: 38px; /* –†–∞–∑–º–µ—Ä –ª–æ–≥–æ—Ç–∏–ø–∞ */
    width: 38px;
    display: block; /* –£–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–π –æ—Ç—Å—Ç—É–ø –ø–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫–æ–π */
    border-radius: 3px; /* –ù–µ–±–æ–ª—å—à–æ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∫—Ä–∞–µ–≤, –∫–∞–∫ —É –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ */
  }
  .main-header .search-bar {
    flex-grow: 0; /* –ù–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ —Å–∏–ª—å–Ω–æ */
    margin-right: 25px;
    display: flex; /* –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –≤–Ω—É—Ç—Ä–∏ */
    align-items: center;
  }
  .main-header .search-bar input[type="search"] {
    padding: 8px 12px 8px 35px; /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –¥–ª—è –∏–∫–æ–Ω–∫–∏ */
    border-radius: 4px;
    border: 1px solid #cccccc;    /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
    background-color: #ffffff; /* –ë–µ–ª—ã–π —Ñ–æ–Ω */
    color: #333333;           /* –¢–µ–º–Ω—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
    min-width: 220px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ */
    font-size: 0.9rem;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23555555' class='bi bi-search' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 10px center; /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ */
  }
  .main-header .search-bar input[type="search"]::placeholder {
    color: #777777; /* –°—Ä–µ–¥–Ω–µ-—Å–µ—Ä—ã–π —Ü–≤–µ—Ç –¥–ª—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ */
  }
  .main-header nav {
    display: flex;
    align-items: center;
    flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
  }
  .main-header nav a {
    color: #ecf0f1; /* –°–≤–µ—Ç–ª—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å—Å—ã–ª–æ–∫ */
    text-decoration: none;
    margin-left: 12px;
    padding: 8px 12px;
    font-size: 0.95rem;
    border-radius: 4px;
    transition: background-color 0.2s ease;
    line-height: 1; /* –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ */
  }
  .main-header nav a:hover,
  .main-header nav a.active { /* –°—Ç–∏–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
    background-color: #3498db; /* –°–∏–Ω–∏–π —Ñ–æ–Ω –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏/–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
    color: #ffffff;
  }
  /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å–ø–∏—Å–∫–∞, –µ—Å–ª–∏ nav –æ–±–µ—Ä–Ω—É—Ç –≤ ul/li */
  .main-header nav ul {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    align-items: center; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ —Ü–µ–Ω—Ç—Ä—É */
  }
  .main-header nav li {
    margin: 0;
  }
  .modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
  }
  .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 800px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    max-height: 80vh;
  }
  .modal-header {
    padding: 10px 15px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
  }
  .modal-body {
      padding: 15px;
      overflow-y: auto;
  }
  .modal-footer {
    padding: 15px;
    border-top: 1px solid #dee2e6;
    text-align: right;
  }

  .close-btn {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  .close-btn:hover,
  .close-btn:focus {
    color: black;
    text-decoration: none;
  }
  .table {
      width: 100%;
      border-collapse: collapse;
  }
  .table th, .table td {
      border: 1px solid #dee2e6;
      padding: 8px;
      text-align: left;
  }
  .table th {
      background-color: #f2f2f2;
  }
  .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
  }
  .btn-primary {
      background-color: #007bff;
      color: white;
  }
  .btn-sm {
      padding: 5px 10px;
      font-size: 0.875em;
  }
  .form-group {
      margin-bottom: 1rem;
  }
  .form-group label {
      display: block;
      margin-bottom: .5rem;
  }
  .form-group input[type="text"], .form-group textarea {
      width: 100%;
      padding: .375rem .75rem;
      border: 1px solid #ced4da;
      border-radius: .25rem;
      box-sizing: border-box;
  }
</style>

<header class="main-header">
  <div class="logo-container">
    <a href="/admin/dashboard"> <!-- –õ–æ–≥–æ—Ç–∏–ø —Ç–æ–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –¥–∞—à–±–æ—Ä–¥ -->
      <img src="/tmpl_static/img/IMG_0486.jpg" alt="–õ–æ–≥–æ—Ç–∏–ø">
    </a>
  </div>
  <div class="search-bar">
    <input type="search" placeholder="–ü–æ–∏—Å–∫...">
  </div>
  <nav>
    <ul style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
      <div style="display: flex; align-items: center;">
        <li><a href="/admin/dashboard">–ú–æ–Ω–∏—Ç–æ—Ä</a></li>
        <li><a href="/admin/enterprises">–ö–æ–º–ø–∞–Ω–∏–∏</a></li>
        <li><a href="#" id="openSipModalBtn">SIP</a></li>
        <li><a href="#" id="openMobileModalBtn">Mobile</a></li>
        <li><a href="#" id="openServiceModalBtn">Service</a></li>
      </div>
      <div style="display: flex; align-items: center;">
        <li><span id="total-reboots" style="color: darkorange; font-weight: bold; margin-left: 12px; padding: 8px 12px; border-radius: 4px; font-size: 0.95rem; vertical-align: middle; display: inline-block;">R: 0</span></li>
      </div>
    </ul>
  </nav>
</header> 

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è Mobile –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ -->
<div id="mobileOperatorsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="closeMobileModalBtn">&times;</span>
        <h2>–ú–æ–±–∏–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</h2>
        <div class="modal-body">
            <table id="mobile-operators-table" class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ò–º—è</th>
                        <th>–®–∞–±–ª–æ–Ω</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="mobile-operators-list">
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button id="addMobileOperatorBtn" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Mobile –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ -->
<div id="mobileOperatorFormModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="closeMobileFormModalBtn">&times;</span>
        <h2 id="mobile-form-title">–î–æ–±–∞–≤–∏—Ç—å –º–æ–±–∏–ª—å–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</h2>
        <form id="mobile-operator-form">
            <input type="hidden" id="mobile-operator-id">
            <div class="form-group">
                <label for="mobile-operator-name">–ò–º—è:</label>
                <input type="text" id="mobile-operator-name" required>
            </div>
            <div class="form-group">
                <label for="mobile-operator-shablon">–®–∞–±–ª–æ–Ω:</label>
                <input type="text" id="mobile-operator-shablon">
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è SIP –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ -->
<div id="sipOperatorsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="closeSipModalBtn">&times;</span>
        <h2>SIP –û–ø–µ—Ä–∞—Ç–æ—Ä—ã</h2>
        <div class="modal-body">
            <table id="sip-operators-table" class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ò–º—è</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="sip-operators-list">
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button id="addSipOperatorBtn" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è SIP –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ -->
<div id="sipOperatorFormModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="closeSipFormModalBtn">&times;</span>
        <h2 id="sip-form-title">–î–æ–±–∞–≤–∏—Ç—å SIP –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</h2>
        <form id="sip-operator-form">
            <input type="hidden" id="sip-operator-id">
            <div class="form-group">
                <label for="sip-operator-name">–ò–º—è:</label>
                <input type="text" id="sip-operator-name" required>
            </div>
            <div class="form-group">
                <label for="sip-operator-shablon">–®–∞–±–ª–æ–Ω:</label>
                <textarea id="sip-operator-shablon" rows="20"></textarea>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è Service -->
<div id="serviceModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="closeServiceModalBtn">&times;</span>
        <h2>üöß –°–µ—Ä–≤–∏—Å—ã —Å–∏—Å—Ç–µ–º—ã</h2>
        <div class="modal-body">
            <!-- –ë–ª–æ–∫ –±–∞–ª–∞–Ω—Å–∞ WebSMS -->
            <div style="background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 0.5rem 0; color: #495057; display: flex; align-items: center;">
                    <span style="margin-right: 0.5rem;">üí∞</span>
                    <span id="websmsBalanceTitle">–ë–∞–ª–∞–Ω—Å WebSMS.by</span>
                </h4>
                <div id="websmsBalanceContent" style="font-size: 1.1rem;">
                    <span style="color: #6c757d;">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
            </div>
            
            <!-- –¢–∞–±–ª–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏ -->
            <div style="background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <h4 style="margin: 0 0 1rem 0; color: #495057; display: flex; align-items: center;">
                    <span style="margin-right: 0.5rem;">‚öôÔ∏è</span>
                    <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏</span>
                    <button id="refreshServicesBtn" style="margin-left: auto; padding: 0.25rem 0.5rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </h4>
                <div id="servicesTableContainer">
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è Mobile –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ ---
    const openMobileModalBtn = document.getElementById('openMobileModalBtn');
    if (openMobileModalBtn) {
        const mobileOperatorsModal = document.getElementById('mobileOperatorsModal');
        const closeMobileModalBtn = document.getElementById('closeMobileModalBtn');
        const mobileOperatorsList = document.getElementById('mobile-operators-list');
        const addMobileOperatorBtn = document.getElementById('addMobileOperatorBtn');
        const mobileOperatorFormModal = document.getElementById('mobileOperatorFormModal');
        const closeMobileFormModalBtn = document.getElementById('closeMobileFormModalBtn');
        const mobileOperatorForm = document.getElementById('mobile-operator-form');
        const mobileFormTitle = document.getElementById('mobile-form-title');
        const mobileOperatorId = document.getElementById('mobile-operator-id');
        const mobileOperatorName = document.getElementById('mobile-operator-name');
        const mobileOperatorShablon = document.getElementById('mobile-operator-shablon');

        function renderMobileOperators(operators) {
            mobileOperatorsList.innerHTML = '';
            operators.forEach(op => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${op.id}</td>
                    <td>${op.name}</td>
                    <td>${op.shablon || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-edit-mobile" data-id="${op.id}" data-name="${op.name}" data-shablon="${op.shablon || ''}">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-delete-mobile" data-id="${op.id}">üóëÔ∏è</button>
                    </td>
                `;
                mobileOperatorsList.appendChild(tr);
            });
        }

        openMobileModalBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/admin/mobile/operators');
                if (!response.ok) throw new Error('Network response was not ok');
                const operators = await response.json();
                renderMobileOperators(operators);
                mobileOperatorsModal.style.display = 'block';
            } catch (error) {
                console.error("Error loading mobile operators:", error);
                alert("Error loading mobile operators.");
            }
        });

        closeMobileModalBtn.addEventListener('click', () => mobileOperatorsModal.style.display = 'none');
        closeMobileFormModalBtn.addEventListener('click', () => mobileOperatorFormModal.style.display = 'none');
        
        addMobileOperatorBtn.addEventListener('click', () => {
            mobileOperatorForm.reset();
            mobileOperatorId.value = '';
            mobileFormTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –º–æ–±–∏–ª—å–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞';
            mobileOperatorFormModal.style.display = 'block';
        });

        mobileOperatorsList.addEventListener('click', async (event) => {
            const target = event.target.closest('button');
            if (!target) return;

            if (target.classList.contains('btn-edit-mobile')) {
                mobileOperatorId.value = target.dataset.id;
                mobileOperatorName.value = target.dataset.name;
                mobileOperatorShablon.value = target.dataset.shablon;
                mobileFormTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–±–∏–ª—å–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞';
                mobileOperatorFormModal.style.display = 'block';
            }

            if (target.classList.contains('btn-delete-mobile')) {
                const id = target.dataset.id;
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
                    try {
                        const response = await fetch(`/admin/mobile/operators/${id}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to delete');
                        const operatorsResponse = await fetch('/admin/mobile/operators');
                        const operators = await operatorsResponse.json();
                        renderMobileOperators(operators);
                    } catch (error) {
                        alert("Failed to delete operator.");
                    }
                }
            }
        });

        mobileOperatorForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const id = mobileOperatorId.value;
            const name = mobileOperatorName.value;
            const shablon = mobileOperatorShablon.value;
            const url = id ? `/admin/mobile/operators/${id}` : '/admin/mobile/operators';
            const method = id ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, shablon })
                });
                if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.detail || 'Failed to save');
                }
                mobileOperatorFormModal.style.display = 'none';
                const operatorsResponse = await fetch('/admin/mobile/operators');
                const operators = await operatorsResponse.json();
                renderMobileOperators(operators);
            } catch (error) {
                alert(`Could not save operator: ${error.message}`);
            }
        });
    }

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è SIP –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ ---
    const openSipModalBtn = document.getElementById('openSipModalBtn');
    if (openSipModalBtn) {
        const sipOperatorsModal = document.getElementById('sipOperatorsModal');
        const closeSipModalBtn = document.getElementById('closeSipModalBtn');
        const sipOperatorsList = document.getElementById('sip-operators-list');
        const addSipOperatorBtn = document.getElementById('addSipOperatorBtn');
        const sipOperatorFormModal = document.getElementById('sipOperatorFormModal');
        const closeSipFormModalBtn = document.getElementById('closeSipFormModalBtn');
        const sipOperatorForm = document.getElementById('sip-operator-form');
        const sipFormTitle = document.getElementById('sip-form-title');
        const sipOperatorId = document.getElementById('sip-operator-id');
        const sipOperatorName = document.getElementById('sip-operator-name');
        const sipOperatorShablon = document.getElementById('sip-operator-shablon');

        function renderSipOperators(operators) {
            sipOperatorsList.innerHTML = '';
            operators.forEach(op => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${op.id}</td>
                    <td>${op.name}</td>
                    <td>
                        <button class="btn btn-sm btn-edit-sip" data-id="${op.id}" data-name="${op.name}" data-shablon="${op.shablon || ''}">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-delete-sip" data-id="${op.id}">üóëÔ∏è</button>
                    </td>
                `;
                sipOperatorsList.appendChild(tr);
            });
        }

        openSipModalBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/admin/sip/operators');
                if (!response.ok) throw new Error('Network response was not ok');
                const operators = await response.json();
                renderSipOperators(operators);
                sipOperatorsModal.style.display = 'block';
            } catch (error) {
                console.error("Error loading SIP operators:", error);
                alert("Error loading SIP operators.");
            }
        });

        closeSipModalBtn.addEventListener('click', () => sipOperatorsModal.style.display = 'none');
        closeSipFormModalBtn.addEventListener('click', () => sipOperatorFormModal.style.display = 'none');
        
        addSipOperatorBtn.addEventListener('click', () => {
            sipOperatorForm.reset();
            sipOperatorId.value = '';
            sipFormTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å SIP –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞';
            sipOperatorFormModal.style.display = 'block';
        });

        sipOperatorsList.addEventListener('click', async (event) => {
            const target = event.target.closest('button');
            if (!target) return;

            if (target.classList.contains('btn-edit-sip')) {
                sipOperatorId.value = target.dataset.id;
                sipOperatorName.value = target.dataset.name;
                sipOperatorShablon.value = target.dataset.shablon;
                sipFormTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å SIP –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞';
                sipOperatorFormModal.style.display = 'block';
            }

            if (target.classList.contains('btn-delete-sip')) {
                const id = target.dataset.id;
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
                    try {
                        const response = await fetch(`/admin/sip/operators/${id}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to delete');
                        const operatorsResponse = await fetch('/admin/sip/operators');
                        const operators = await operatorsResponse.json();
                        renderSipOperators(operators);
                    } catch (error) {
                        alert("Failed to delete operator.");
                    }
                }
            }
        });

        sipOperatorForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const id = sipOperatorId.value;
            const name = sipOperatorName.value;
            const shablon = sipOperatorShablon.value;
            const url = id ? `/admin/sip/operators/${id}` : '/admin/sip/operators';
            const method = id ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, shablon })
                });
                if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.detail || 'Failed to save');
                }
                sipOperatorFormModal.style.display = 'none';
                const operatorsResponse = await fetch('/admin/sip/operators');
                const operators = await operatorsResponse.json();
                renderSipOperators(operators);
            } catch (error) {
                alert(`Could not save operator: ${error.message}`);
            }
        });
    }

    // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è Service –º–æ–¥–∞–ª–∫–∏ ---
    const openServiceModalBtn = document.getElementById('openServiceModalBtn');
    if (openServiceModalBtn) {
        const serviceModal = document.getElementById('serviceModal');
        const closeServiceModalBtn = document.getElementById('closeServiceModalBtn');

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞ WebSMS
        async function loadWebSMSBalance() {
            const balanceContent = document.getElementById('websmsBalanceContent');
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                balanceContent.innerHTML = '<span style="color: #6c757d;">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</span>';
                
                // –ó–∞–ø—Ä–æ—Å –∫ SMS —Å–µ—Ä–≤–∏—Å—É –Ω–∞ –ø–æ—Ä—Ç—É 8013
                const response = await fetch('/admin/proxy-balance', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.balance && typeof data.balance.sms === 'number') {
                    const smsBalance = data.balance.sms.toFixed(2);
                    balanceContent.innerHTML = `
                        <span style="color: #28a745; font-weight: 600; font-size: 1.2rem;">${smsBalance} BYN</span>
                        <span style="color: #6c757d; margin-left: 0.5rem; font-size: 0.9rem;">(SMS)</span>
                    `;
                } else {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞ WebSMS:', error);
                balanceContent.innerHTML = `
                    <span style="color: #dc3545;">‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>
                    <span style="color: #6c757d; margin-left: 0.5rem; font-size: 0.9rem;">(—Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)</span>
                `;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
        async function loadServicesList() {
            const container = document.getElementById('servicesTableContainer');
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6c757d;">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...</div>';
                
                // –ó–∞–ø—Ä–æ—Å –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É —Å–µ—Ä–≤–∏—Å–æ–≤
                const response = await fetch('/admin/services', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.services) {
                    container.innerHTML = renderServicesTable(data.services);
                    attachServiceButtons();
                } else {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc3545;">
                        ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü—ã —Å–µ—Ä–≤–∏—Å–æ–≤
        function renderServicesTable(services) {
            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left;">–°–µ—Ä–≤–∏—Å</th>
                                <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: left;">–°–∫—Ä–∏–ø—Ç</th>
                                <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: center;">–ü–æ—Ä—Ç</th>
                                <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: center;">–°—Ç–∞—Ç—É—Å</th>
                                <th style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            services.forEach(service => {
                const statusIcon = getStatusIcon(service.status);
                const statusColor = getStatusColor(service.status);
                const portDisplay = service.port ? service.port : '-';
                
                tableHTML += `
                    <tr>
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6;">
                            <strong>${service.name}</strong><br>
                            <small style="color: #6c757d;">${service.app}</small>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; font-family: monospace;">
                            ${service.script}
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: center; font-family: monospace;">
                            ${portDisplay}
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: center;">
                            <span style="color: ${statusColor};">${statusIcon}</span>
                        </td>
                        <td style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: center;">
                            ${renderActionButtons(service)}
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return tableHTML;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
        function getStatusIcon(status) {
            switch (status) {
                case 'running': return '‚úÖ';
                case 'stopped': return '‚ùå';
                case 'error': return '‚ö†Ô∏è';
                default: return '‚ùì';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
        function getStatusColor(status) {
            switch (status) {
                case 'running': return '#28a745';
                case 'stopped': return '#dc3545';
                case 'error': return '#ffc107';
                default: return '#6c757d';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        function renderActionButtons(service) {
            // –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ç–µ–ø–µ—Ä—å –∏–º–µ—é—Ç –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            return `
                <button 
                    class="service-btn stop-btn" 
                    data-service="${service.name}" 
                    data-action="stop"
                    style="padding: 0.25rem 0.5rem; margin: 0.1rem; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">
                    ‚èπ Stop
                </button>
                <button 
                    class="service-btn restart-btn" 
                    data-service="${service.name}" 
                    data-action="restart"
                    style="padding: 0.25rem 0.5rem; margin: 0.1rem; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">
                    üîÑ Restart
                </button>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –∫ –∫–Ω–æ–ø–∫–∞–º
        function attachServiceButtons() {
            const serviceButtons = document.querySelectorAll('.service-btn');
            
            serviceButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    const serviceName = e.target.dataset.service;
                    const action = e.target.dataset.action;
                    
                    await controlService(serviceName, action, e.target);
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–º
        async function controlService(serviceName, action, buttonElement) {
            try {
                // –ü—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
                const response = await fetch(`/admin/services/${serviceName}/action`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ action: action })
                });
                
                const data = await response.json();
                
                // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                setTimeout(() => {
                    loadServicesList();
                }, 1000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–º:', error);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                setTimeout(() => {
                    loadServicesList();
                }, 1000);
            }
        }

        openServiceModalBtn.addEventListener('click', (e) => {
            e.preventDefault();
            serviceModal.style.display = 'block';
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å –∏ —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
            loadWebSMSBalance();
            loadServicesList();
        });

        closeServiceModalBtn.addEventListener('click', () => {
            serviceModal.style.display = 'none';
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
        const refreshServicesBtn = document.getElementById('refreshServicesBtn');
        if (refreshServicesBtn) {
            refreshServicesBtn.addEventListener('click', () => {
                loadServicesList();
            });
        }
    }

    window.addEventListener('click', (event) => {
        const mobileOperatorsModal = document.getElementById('mobileOperatorsModal');
        const mobileOperatorFormModal = document.getElementById('mobileOperatorFormModal');
        const sipOperatorsModal = document.getElementById('sipOperatorsModal');
        const sipOperatorFormModal = document.getElementById('sipOperatorFormModal');
        const serviceModal = document.getElementById('serviceModal');
        if (event.target == mobileOperatorsModal) mobileOperatorsModal.style.display = 'none';
        if (event.target == mobileOperatorFormModal) mobileOperatorFormModal.style.display = 'none';
        if (event.target == sipOperatorsModal) sipOperatorsModal.style.display = 'none';
        if (event.target == sipOperatorFormModal) sipOperatorFormModal.style.display = 'none';
        if (event.target == serviceModal) serviceModal.style.display = 'none';
    });
});
</script> 