<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Панель администратора</title>
  <style>
    body { font-family: sans-serif; padding: 0; margin:0; background-color: #f4f6f9; }
    .content-wrapper {
      padding: 10px; /* Общий отступ для контейнера карточек, как margin у карточек */
    }
    .enterprise-grid {
      display: flex; /* Используем flex для расположения в ряд */
      flex-wrap: wrap; /* Разрешаем перенос карточек */
      /* gap уже не нужен, так как у карточек есть margin-right и margin-bottom */
      /* margin-top: 1rem; убираем, так как content-wrapper дает отступ */
    }
    .enterprise-card {
      background-color: #d4edda; /* Светло-зеленый по умолчанию */
      border-radius: 5px;
      width: 150px;
      height: 81px;
      margin-right: 10px;
      margin-bottom: 10px;
      padding: 0; /* Убираем внутренние отступы, так как позиционирование текста будет через margin */
      box-sizing: border-box; /* Чтобы padding и border не влияли на заданные width/height */
      display: flex; /* Используем flex для позиционирования внутреннего блока с текстом */
      flex-direction: column; /* Чтобы элементы внутри шли друг под другом (на будущее) */
      transition: background-color 0.5s ease; /* Плавный переход цветов */
      /* justify-content: flex-start; по умолчанию */
      /* text-align: left; -- будет у дочернего элемента */
    }

    /* Статусы мониторинга */
    .enterprise-card.status-online {
      background-color: #d4edda !important; /* Светло-зеленый - онлайн */
    }
    .enterprise-card.status-offline {
      background-color: #f2dede !important; /* Красный - офлайн */
    }
    .enterprise-card.status-unknown {
      background-color: #e2e3e5 !important; /* Серый - неизвестно */
    }
    .enterprise-card .name-container {
        /* color: #2196f3;  rgb(33, 150, 243) - это синий, не подходит для красной карточки */
        margin-left: 15px;
        margin-top: 4px; /* Отступ сверху для блока с названием */
        /* Остальные стили для этого блока (если он нужен) могут быть здесь */
    }
    .enterprise-card .name {
      font-size: 16px;
      color: #2196f3; /* Синий цвет для названий предприятий */
      margin: 0; /* Убираем стандартные отступы у <p> */
      padding: 0; /* Убедимся, что нет лишних отступов */
      line-height: 1.2; /* Для лучшего контроля высоты строки, если имя длинное */
      /* font-weight: 500; -- убрал, так как в примере его нет для этого элемента */
      /* cursor: pointer; -- если не кликабельно, то не нужно */
    }
    .enterprise-card .line-stats {
      font-size: 12px;
      color: #666;
      margin-left: 15px;
      margin-top: 2px;
      font-family: sans-serif; /* Тот же шрифт что и у названий */
      line-height: 1.1;
    }
    /* Старые стили кнопки, если они еще где-то используются */
    .button {
      display: inline-block;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0.5rem 0 0;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
    }

    /* Стили для модального окна */
    .modal {
        display: none; /* Скрыто по умолчанию */
        position: fixed; /* Оставаться на месте при скролле */
        z-index: 1000; /* Поверх всего */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* Прокрутка, если содержимое не помещается */
        background-color: rgba(0,0,0,0.4); /* Черный полупрозрачный фон */
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% от верха и по центру */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Ширина модального окна */
        max-width: 500px; /* Максимальная ширина */
        border-radius: 5px;
        position: relative;
    }

    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
  </style>
</head>
<body>
  {% include 'shared/header.html' %}
  <div class="content-wrapper">
    <!-- <h1>Добро пожаловать!</h1> -->

    {% include 'control_buttons.html' %} <!-- Этот файл уже содержит только комментарии -->

    <!-- Удаляем старую навигацию -->
    <!-- <nav>
      <ul>
        <li><a href="/admin/enterprises" class="button">Управление предприятиями</a></li>
        
      </ul>
    </nav> -->

    <!-- <p>Общее количество предприятий: <strong>{{ enterprise_count }}</strong></p> -->

    {% if error %}
        <div class="error-message" style="color: red; background: #ffebee; border: 1px solid #e57373; padding: 10px; border-radius: 4px; margin-bottom: 1rem;">
            <strong>Ошибка при загрузке дашборда:</strong> {{ error }}
        </div>
    {% endif %}

    <div class="enterprise-grid">
      {% if enterprises %}
        {% for enterprise in enterprises %}
          <div class="enterprise-card" data-name="{{ enterprise.name }}" data-number="{{ enterprise.number }}" data-ip="{{ enterprise.ip }}" data-name2="{{ enterprise.name2 }}" style="cursor: pointer;">
            <div class="name-container">
                <p class="name">{{ enterprise.name }}</p>
                <div class="line-stats" id="stats-{{ enterprise.number }}">—/— —/— —/—</div>
            </div>
            <!-- Другая информация будет здесь -->
          </div>
        {% endfor %}
      {% else %}
        <p>Нет активных предприятий для отображения.</p>
      {% endif %}
    </div>
  </div>

  <!-- HTML для модального окна -->
  <div id="enterpriseModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2 id="modalTitle"></h2>
      <p>Номер: <span id="modalNumber"></span></p>
      <p>IP: <span id="modalIp"></span></p>
      <p>Второе имя: <span id="modalName2"></span></p>
      <button class="button" id="adminLoginButton" style="margin-top: 15px;">Войти в админку</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('enterpriseModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalNumber = document.getElementById('modalNumber');
        const modalIp = document.getElementById('modalIp');
        const modalName2 = document.getElementById('modalName2');
        const adminLoginButton = document.getElementById('adminLoginButton');
        const closeButton = document.querySelector('.close-button');

        // Открываем модальное окно при клике на карточку
        document.querySelectorAll('.enterprise-card').forEach(card => {
            card.addEventListener('click', function() {
                const name = this.dataset.name;
                const number = this.dataset.number;
                const ip = this.dataset.ip;
                const name2 = this.dataset.name2;

                modalTitle.textContent = name;
                modalNumber.textContent = number;
                modalIp.textContent = ip;
                modalName2.textContent = name2 || '—'; // Если name2 пустое, ставим прочерк

                // Логика для кнопки "Войти в админку"
                adminLoginButton.onclick = function() {
                    // Асинхронно получаем токен
                    fetch(`/admin/generate-auth-token/${number}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Ошибка сети или сервера при получении токена.');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.token) {
                                // Окончательное исправление: используем конкатенацию строк, чтобы избежать конфликтов
                                window.open('https://' + window.location.hostname + '/auth/' + data.token, '_blank');
                            } else {
                                alert('Не удалось получить токен для входа.');
                            }
                        })
                        .catch(error => {
                            console.error('Ошибка при получении токена:', error);
                            alert('Произошла ошибка при попытке входа. См. консоль для деталей.');
                        });
                };

                modal.style.display = 'block';
            });
        });

        // Закрываем модальное окно при клике на крестик
        closeButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        // Закрываем модальное окно при клике вне его
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });

        // ============================================
        // СИСТЕМА МОНИТОРИНГА ХОСТОВ
        // ============================================
        
        let hostStatuses = {}; // Хранилище статусов хостов
        let failureCounters = {}; // Счетчики неудачных попыток
        let hostLineStats = {}; // Хранилище последней статистики линий для каждого хоста
        let monitoringInterval = null; // Интервал для мониторинга
        
        // Инициализация состояний хостов
        function initializeHostStates() {
            const cards = document.querySelectorAll('.enterprise-card[data-number]');
            cards.forEach(card => {
                const enterpriseNumber = card.dataset.number;
                if (!hostStatuses[enterpriseNumber]) {
                    hostStatuses[enterpriseNumber] = 'online'; // По умолчанию онлайн
                    failureCounters[enterpriseNumber] = 0;
                }
                // Устанавливаем начальный статус
                card.classList.add('status-online');
            });
        }
        
                 // Обновление визуального состояния карточки
         function updateCardStatus(enterpriseNumber, status, responseTime = null, sipPeers = null, lineStats = null, errorMessage = null) {
             const card = document.querySelector(`.enterprise-card[data-number="${enterpriseNumber}"]`);
             if (!card) return;
             
             // Убираем все классы статуса
             card.classList.remove('status-online', 'status-offline', 'status-unknown');
             
             // Добавляем нужный класс
             card.classList.add(`status-${status}`);
             
             // Обновляем статистику линий
             const statsElement = document.getElementById(`stats-${enterpriseNumber}`);
             if (statsElement) {
                 if (lineStats) {
                     // Отображаем детальную статистику: GSM/SIP/Внутренние
                     const gsmStats = `${lineStats.gsm_online}/${lineStats.gsm_total}`;
                     const sipStats = `${lineStats.sip_online}/${lineStats.sip_total}`;
                     const internalStats = `${lineStats.internal_online}/${lineStats.internal_total}`;
                     statsElement.textContent = `${gsmStats} ${sipStats} ${internalStats}`;
                 } else if (status === 'offline') {
                     // При офлайн (после 3+ неудач) показываем нули с последними известными общими количествами
                     // Используем сохраненные данные или значения по умолчанию
                     const savedStats = hostLineStats[enterpriseNumber];
                     if (savedStats) {
                         statsElement.textContent = `0/${savedStats.gsm_total} 0/${savedStats.sip_total} 0/${savedStats.internal_total}`;
                     } else {
                         // Если нет сохраненных данных, показываем типичные значения
                         statsElement.textContent = '0/8 0/1 0/3';
                     }
                 }
                 // При 1-2 неудачах (status='online' но нет lineStats) - НЕ ТРОГАЕМ статистику вообще
             }
             
             // Обновляем title для подсказки
             let title = `Предприятие ${enterpriseNumber}`;
             if (status === 'online') {
                 if (responseTime !== null && lineStats) {
                     // Полностью онлайн с детальной статистикой
                     title += `\nСтатус: Онлайн\nВремя отклика: ${responseTime}мс`;
                     title += `\nGSM линии: ${lineStats.gsm_online}/${lineStats.gsm_total}`;
                     title += `\nSIP линии: ${lineStats.sip_online}/${lineStats.sip_total}`;
                     title += `\nВнутренние: ${lineStats.internal_online}/${lineStats.internal_total}`;
                     if (sipPeers !== null) {
                         title += `\nВсего peers: ${sipPeers}`;
                     }
                 } else if (failureCounters[enterpriseNumber] > 0) {
                     // Онлайн, но есть неудачные попытки
                     title += `\nСтатус: Онлайн (проблемы)\nНеудачных попыток: ${failureCounters[enterpriseNumber]}/3`;
                     if (errorMessage) {
                         title += `\nПоследняя ошибка: ${errorMessage}`;
                     }
                 } else {
                     // Просто онлайн
                     title += `\nСтатус: Онлайн`;
                 }
             } else if (status === 'offline') {
                 title += `\nСтатус: Офлайн\nНеудачных попыток: ${failureCounters[enterpriseNumber]}`;
                 if (errorMessage) {
                     title += `\nОшибка: ${errorMessage}`;
                 }
             }
             card.title = title;
             
             console.log(`[Мониторинг] ${enterpriseNumber}: ${status}, неудач: ${failureCounters[enterpriseNumber]}`);
         }
        
        // Проверка всех хостов
        async function checkAllHosts() {
            try {
                console.log('[Мониторинг] Начинаю проверку хостов...');
                const response = await fetch('/admin/check-hosts');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('[Мониторинг] Получен ответ:', data);
                
                                 if (data.success && data.hosts) {
                     data.hosts.forEach(host => {
                         const enterpriseNumber = host.enterprise_number;
                         
                         if (host.status === 'online') {
                             // Хост онлайн - сбрасываем счетчик неудач и сразу зеленым
                             failureCounters[enterpriseNumber] = 0;
                             hostStatuses[enterpriseNumber] = 'online';
                             // Сохраняем статистику линий для использования при офлайн
                             if (host.line_stats) {
                                 hostLineStats[enterpriseNumber] = host.line_stats;
                             }
                             updateCardStatus(enterpriseNumber, 'online', host.response_time_ms, host.sip_peers, host.line_stats);
                         } else {
                             // Хост офлайн - увеличиваем счетчик
                             failureCounters[enterpriseNumber]++;
                             
                             if (failureCounters[enterpriseNumber] >= 3) {
                                 // После 3-х неудач помечаем как офлайн (красным)
                                 hostStatuses[enterpriseNumber] = 'offline';
                                 updateCardStatus(enterpriseNumber, 'offline', null, null, null, host.error_message);
                             } else {
                                 // До 3-х неудач остается зеленым
                                 hostStatuses[enterpriseNumber] = 'online';
                                 updateCardStatus(enterpriseNumber, 'online', null, null, null, `Попытка ${failureCounters[enterpriseNumber]}/3: ${host.error_message}`);
                             }
                         }
                     });
                    
                    // Сохраняем состояния в localStorage
                    localStorage.setItem('hostStatuses', JSON.stringify(hostStatuses));
                    localStorage.setItem('failureCounters', JSON.stringify(failureCounters));
                    localStorage.setItem('hostLineStats', JSON.stringify(hostLineStats));
                }
                
            } catch (error) {
                console.error('[Мониторинг] Ошибка при проверке хостов:', error);
            }
        }
        
        // Загрузка сохраненных состояний
        function loadSavedStates() {
            try {
                const savedStatuses = localStorage.getItem('hostStatuses');
                const savedCounters = localStorage.getItem('failureCounters');
                const savedLineStats = localStorage.getItem('hostLineStats');
                
                if (savedStatuses) {
                    hostStatuses = JSON.parse(savedStatuses);
                }
                if (savedCounters) {
                    failureCounters = JSON.parse(savedCounters);
                }
                if (savedLineStats) {
                    hostLineStats = JSON.parse(savedLineStats);
                }
                
                                 // Применяем сохраненные состояния к карточкам (только online/offline)
                 Object.keys(hostStatuses).forEach(enterpriseNumber => {
                     let status = hostStatuses[enterpriseNumber];
                     // Преобразуем старые unknown состояния в online
                     if (status === 'unknown') {
                         status = 'online';
                         hostStatuses[enterpriseNumber] = 'online';
                     }
                     updateCardStatus(enterpriseNumber, status);
                 });
                
                console.log('[Мониторинг] Загружены сохраненные состояния:', hostStatuses);
            } catch (error) {
                console.error('[Мониторинг] Ошибка загрузки сохраненных состояний:', error);
            }
        }
        
        // Запуск мониторинга
        function startMonitoring() {
            console.log('[Мониторинг] Запуск системы мониторинга...');
            
            // Инициализация
            initializeHostStates();
            loadSavedStates();
            
            // Первая проверка сразу
            checkAllHosts();
            
            // Проверка каждые 60 секунд
            monitoringInterval = setInterval(checkAllHosts, 60000);
            
            console.log('[Мониторинг] Система мониторинга запущена');
        }
        
        // Остановка мониторинга
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                console.log('[Мониторинг] Система мониторинга остановлена');
            }
        }
        
        // API для управления мониторингом (для отладки)
        window.hostMonitoring = {
            start: startMonitoring,
            stop: stopMonitoring,
            check: checkAllHosts,
            getStatuses: () => hostStatuses,
            getCounters: () => failureCounters,
            clearStates: () => {
                localStorage.removeItem('hostStatuses');
                localStorage.removeItem('failureCounters');
                localStorage.removeItem('hostLineStats');
                hostStatuses = {};
                failureCounters = {};
                hostLineStats = {};
                console.log('[Мониторинг] Состояния очищены');
            }
        };
        
        // Автоматический запуск мониторинга при загрузке страницы
        startMonitoring();
    });
  </script>

</body>
</html>
