<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
  
  <!-- Favicon and App Icons -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/static/apple-touch-icon.png">
  <link rel="manifest" href="/static/site.webmanifest">
  <meta name="theme-color" content="#2563eb">
  <meta name="msapplication-TileColor" content="#2563eb">
  
  <style>
    body { font-family: sans-serif; padding: 0; margin:0; background-color: #f4f6f9; }
    .content-wrapper {
      padding: 10px; /* –û–±—â–∏–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞—Ä—Ç–æ—á–µ–∫, –∫–∞–∫ margin —É –∫–∞—Ä—Ç–æ—á–µ–∫ */
    }
    .enterprise-grid {
      display: flex; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º flex –¥–ª—è —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤ —Ä—è–¥ */
      flex-wrap: wrap; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –∫–∞—Ä—Ç–æ—á–µ–∫ */
      /* gap —É–∂–µ –Ω–µ –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ —É –∫–∞—Ä—Ç–æ—á–µ–∫ –µ—Å—Ç—å margin-right –∏ margin-bottom */
      /* margin-top: 1rem; —É–±–∏—Ä–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ content-wrapper –¥–∞–µ—Ç –æ—Ç—Å—Ç—É–ø */
    }
    .enterprise-card {
      background-color: #d4edda; /* –°–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
      border-radius: 5px;
      width: 150px;
      height: 81px;
      margin-right: 10px;
      margin-bottom: 10px;
      padding: 0; /* –£–±–∏—Ä–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã, —Ç–∞–∫ –∫–∞–∫ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ margin */
      box-sizing: border-box; /* –ß—Ç–æ–±—ã padding –∏ border –Ω–µ –≤–ª–∏—è–ª–∏ –Ω–∞ –∑–∞–¥–∞–Ω–Ω—ã–µ width/height */
      display: flex; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º flex –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–ª–æ–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º */
      flex-direction: column; /* –ß—Ç–æ–±—ã —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ —à–ª–∏ –¥—Ä—É–≥ –ø–æ–¥ –¥—Ä—É–≥–æ–º (–Ω–∞ –±—É–¥—É—â–µ–µ) */
      transition: background-color 0.5s ease; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ —Ü–≤–µ—Ç–æ–≤ */
      position: relative; /* –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è live —Å—á–µ—Ç—á–∏–∫–∞ */
      /* justify-content: flex-start; –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
      /* text-align: left; -- –±—É–¥–µ—Ç —É –¥–æ—á–µ—Ä–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
    }

    /* –°—Ç–∞—Ç—É—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ */
    .enterprise-card.status-online {
      background-color: #d4edda !important; /* –°–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π - –æ–Ω–ª–∞–π–Ω */
    }
    .enterprise-card.status-offline {
      background-color: #f2dede !important; /* –ö—Ä–∞—Å–Ω—ã–π - –æ—Ñ–ª–∞–π–Ω */
    }
    .enterprise-card.status-unknown {
      background-color: #e2e3e5 !important; /* –°–µ—Ä—ã–π - –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ */
    }
    .enterprise-card .name-container {
        /* color: #2196f3;  rgb(33, 150, 243) - —ç—Ç–æ —Å–∏–Ω–∏–π, –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∫—Ä–∞—Å–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ */
        margin-left: 15px;
        margin-top: 4px; /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è –±–ª–æ–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º */
        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ (–µ—Å–ª–∏ –æ–Ω –Ω—É–∂–µ–Ω) –º–æ–≥—É—Ç –±—ã—Ç—å –∑–¥–µ—Å—å */
    }
    .enterprise-card .name {
      font-size: 16px;
      color: #2196f3; /* –°–∏–Ω–∏–π —Ü–≤–µ—Ç –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π */
      margin: 0; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã —É <p> */
      padding: 0; /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤ */
      line-height: 1.2; /* –î–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –≤—ã—Å–æ—Ç—ã —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –∏–º—è –¥–ª–∏–Ω–Ω–æ–µ */
      /* font-weight: 500; -- —É–±—Ä–∞–ª, —Ç–∞–∫ –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ –µ–≥–æ –Ω–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
      /* cursor: pointer; -- –µ—Å–ª–∏ –Ω–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ, —Ç–æ –Ω–µ –Ω—É–∂–Ω–æ */
    }
    .enterprise-card .line-stats {
      font-size: 12px;
      color: #666;
      margin-left: 15px;
      margin-top: 2px;
      font-family: sans-serif; /* –¢–æ—Ç –∂–µ —à—Ä–∏—Ñ—Ç —á—Ç–æ –∏ —É –Ω–∞–∑–≤–∞–Ω–∏–π */
      line-height: 1.1;
    }
    .enterprise-card .live-events {
      font-size: 16px;
      color: #dc3545; /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç */
      font-family: sans-serif;
      font-weight: normal;
      line-height: 1.1;
      position: absolute;
      bottom: 4px;
      right: 8px;
      display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
    }
    .enterprise-card .disk-usage {
      font-size: 16px;
      color: #28a745; /* –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –¥–∏—Å–∫–∞ */
      font-family: sans-serif;
      font-weight: normal;
      line-height: 1.1;
      position: absolute;
      bottom: 4px;
      left: 8px;
      display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
    }
    .enterprise-card .reboot-events {
      font-size: 16px;
      color: #ff8c00; /* –¢–µ–º–Ω–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è —Å—á–µ—Ç—á–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫ */
      font-family: sans-serif;
      font-weight: normal;
      line-height: 1.1;
      position: absolute;
      bottom: 4px;
      left: 60px; /* –†–∞–∑–º–µ—â–∞–µ–º —Å–ø—Ä–∞–≤–∞ –æ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –¥–∏—Å–∫–∞ */
      display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
    }
    .enterprise-card .goip-status {
      font-size: 16px;
      font-family: sans-serif;
      font-weight: normal;
      line-height: 1.1;
      position: absolute;
      top: 4px;
      right: 8px;
      display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
    }
    .enterprise-card .goip-status.online {
      color: #28a745; /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –æ–Ω–ª–∞–π–Ω */
    }
    .enterprise-card .goip-status.offline {
      color: #dc3545; /* –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –æ—Ñ–ª–∞–π–Ω */
    }
    /* –°—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –≥–¥–µ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è */
    .button {
      display: inline-block;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0.5rem 0 0;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal {
        display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        position: fixed; /* –û—Å—Ç–∞–≤–∞—Ç—å—Å—è –Ω–∞ –º–µ—Å—Ç–µ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
        z-index: 1000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞, –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è */
        background-color: rgba(0,0,0,0.4); /* –ß–µ—Ä–Ω—ã–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% –æ—Ç –≤–µ—Ä—Ö–∞ –∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* –®–∏—Ä–∏–Ω–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        max-width: 500px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
        border-radius: 5px;
        position: relative;
    }

    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
  </style>
</head>
<body>
  {% include 'shared/header.html' %}
  <div class="content-wrapper">
    <!-- <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1> -->

    {% include 'control_buttons.html' %} <!-- –≠—Ç–æ—Ç —Ñ–∞–π–ª —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->

    <!-- –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é -->
    <!-- <nav>
      <ul>
        <li><a href="/admin/enterprises" class="button">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º–∏</a></li>
        
      </ul>
    </nav> -->

    <!-- <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π: <strong>{{ enterprise_count }}</strong></p> -->

    {% if error %}
        <div class="error-message" style="color: red; background: #ffebee; border: 1px solid #e57373; padding: 10px; border-radius: 4px; margin-bottom: 1rem;">
            <strong>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞—à–±–æ—Ä–¥–∞:</strong> {{ error }}
        </div>
    {% endif %}

    <div class="enterprise-grid">
      {% if enterprises %}
        {% for enterprise in enterprises %}
          <div class="enterprise-card" data-name="{{ enterprise.name }}" data-number="{{ enterprise.number }}" data-ip="{{ enterprise.ip }}" data-name2="{{ enterprise.name2 }}" style="cursor: pointer;">
            <div class="name-container">
                <p class="name">{{ enterprise.name }}</p>
                <div class="line-stats" id="stats-{{ enterprise.number }}">‚Äî/‚Äî ‚Äî/‚Äî ‚Äî/‚Äî</div>
                <div class="live-events" id="live-{{ enterprise.number }}"></div>
                <div class="disk-usage" id="disk-{{ enterprise.number }}"></div>
                <div class="reboot-events" id="reboot-{{ enterprise.number }}"></div>
                <div class="goip-status" id="goip-{{ enterprise.number }}"></div>
            </div>
            <!-- –î—Ä—É–≥–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
          </div>
        {% endfor %}
      {% else %}
        <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>
      {% endif %}
    </div>
  </div>

  <!-- HTML –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
  <div id="enterpriseModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
        <h2 id="modalTitle" style="margin: 0;"></h2>
        <span id="configButton" style="padding: 3px 8px; font-size: 12px; background: #007bff; color: white; border-radius: 3px; cursor: pointer;">Config</span>
      </div>
      <p>–ù–æ–º–µ—Ä: <span id="modalNumber"></span></p>
      <p>IP: <span id="modalIp"></span></p>
      <p>–í—Ç–æ—Ä–æ–µ –∏–º—è: <span id="modalName2"></span></p>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="button" id="adminLoginButton" style="flex: 1;">–í–æ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω–∫—É</button>
        <button class="button" id="deskButton" style="flex: 1; background: #28a745;">–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª</button>
        <button class="button" id="downloadButton" style="flex: 1; background: #ff6b35;">Download</button>
        <button class="button" id="telegramUsersButton" style="flex: 1; background: #0088cc;">üì± Telegram</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
  <div id="telegramModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
        <h2 id="telegramModalTitle">Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
        <div>
          <button onclick="refreshTelegramUsers()" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 10px;">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
          </button>
          <span class="close-button" onclick="closeTelegramModal()">&times;</span>
        </div>
      </div>
      
      <div id="telegramUsersContainer">
        <div style="text-align: center; padding: 20px;">
          <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('enterpriseModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalNumber = document.getElementById('modalNumber');
        const modalIp = document.getElementById('modalIp');
        const modalName2 = document.getElementById('modalName2');
        const adminLoginButton = document.getElementById('adminLoginButton');
        const configButton = document.getElementById('configButton');
        const closeButton = document.querySelector('.close-button');

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É
        document.querySelectorAll('.enterprise-card').forEach(card => {
            card.addEventListener('click', function() {
                const name = this.dataset.name;
                const number = this.dataset.number;
                const ip = this.dataset.ip;
                const name2 = this.dataset.name2;

                modalTitle.textContent = name;
                modalNumber.textContent = number;
                modalIp.textContent = ip;
                modalName2.textContent = name2 || '‚Äî'; // –ï—Å–ª–∏ name2 –ø—É—Å—Ç–æ–µ, —Å—Ç–∞–≤–∏–º –ø—Ä–æ—á–µ—Ä–∫

                // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "Config"
                configButton.onclick = function() {
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ —Ç–æ–≥–æ –∂–µ –±—Ä–∞—É–∑–µ—Ä–∞
                    window.open(`/admin/config/${number}`, '_blank');
                };

                // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í–æ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω–∫—É"
                adminLoginButton.onclick = function() {
                    // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
                    fetch(`/admin/generate-auth-token/${number}`, {
                        credentials: 'include'  // –í–∫–ª—é—á–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∫—É–∫–∏
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞.');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.token) {
                                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø—É—Ç—å /auth/{token}
                                window.open('https://' + window.location.hostname + '/auth/' + data.token, '_blank');
                            } else {
                                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–ª—è –≤—Ö–æ–¥–∞.');
                            }
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞:', error);
                            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—Ö–æ–¥–∞. –°–º. –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
                        });
                };

                // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª"
                const deskButton = document.getElementById('deskButton');
                deskButton.onclick = function() {
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—à –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å desk —á–µ—Ä–µ–∑ HTTPS –∏ nginx proxy
                    const enterpriseName = encodeURIComponent(name);
                    const enterpriseNumber = encodeURIComponent(number);
                    window.open('https://' + window.location.hostname + '/desk/?enterprise=' + enterpriseName + '&number=' + enterpriseNumber, '_blank');
                };

                // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "Download"
                const downloadButton = document.getElementById('downloadButton');
                downloadButton.onclick = function() {
                    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
                    if (!confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∫–∞—á–∞—Ç—å –í–°–ï –∑–∞–ø–∏—Å–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ —Å —Ö–æ—Å—Ç–∞ ${name} (${number})?\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ä–µ—Å—É—Ä—Å–æ–≤!`)) {
                        return;
                    }

                    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
                    downloadButton.disabled = true;
                    downloadButton.style.background = '#999';
                    downloadButton.textContent = '–°–∫–∞—á–∏–≤–∞—é...';

                    // –í—ã–∑—ã–≤–∞–µ–º API download —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    fetch(`https://${window.location.hostname}/recordings/force-download/${number}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Download started:', data);
                        alert(`‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∑–∞–ø—É—â–µ–Ω–æ –¥–ª—è ${name}!\n\n–ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.\n–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–æ–∂–Ω–æ –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–∏—Å–∞.`);
                        
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        downloadButton.disabled = false;
                        downloadButton.style.background = '#ff6b35';
                        downloadButton.textContent = 'Download';
                    })
                    .catch(error => {
                        console.error('Download error:', error);
                        alert(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ${error.message}\\n\\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–∏—Å–∞ call_download.py –Ω–∞ –ø–æ—Ä—Ç—É 8012.`);
                        
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                        downloadButton.disabled = false;
                        downloadButton.style.background = '#ff6b35';
                        downloadButton.textContent = 'Download';
                    });
                };

                // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "üì± Telegram"
                const telegramUsersButton = document.getElementById('telegramUsersButton');
                telegramUsersButton.onclick = function() {
                    openTelegramUsersModal(number, name);
                };

                modal.style.display = 'block';
            });
        });

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
        closeButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });

        // ============================================
        // –§–£–ù–ö–¶–ò–û–ù–ê–õ –ü–û–ò–°–ö–ê –ü–†–ï–î–ü–†–ò–Ø–¢–ò–ô
        // ============================================
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
        const searchInput = document.querySelector('.search-bar input[type="search"]');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const enterpriseCards = document.querySelectorAll('.enterprise-card');
                
                console.log(`[–ü–æ–∏—Å–∫] –ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${searchTerm}"`);
                
                enterpriseCards.forEach(card => {
                    const enterpriseName = (card.dataset.name || '').toLowerCase();
                    const enterpriseName2 = (card.dataset.name2 || '').toLowerCase();
                    const enterpriseNumber = (card.dataset.number || '').toLowerCase();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –Ω–∞–∑–≤–∞–Ω–∏–∏, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–º –∏–º–µ–Ω–∏ –∏–ª–∏ –Ω–æ–º–µ—Ä–µ
                    const matches = enterpriseName.includes(searchTerm) || 
                                  enterpriseName2.includes(searchTerm) ||
                                  enterpriseNumber.includes(searchTerm);
                    
                    if (searchTerm === '' || matches) {
                        card.style.display = 'flex';
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –ª–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                const visibleCards = document.querySelectorAll('.enterprise-card[style*="flex"], .enterprise-card:not([style*="none"])');
                const totalCards = enterpriseCards.length;
                console.log(`[–ü–æ–∏—Å–∫] –ü–æ–∫–∞–∑–∞–Ω–æ ${visibleCards.length} –∏–∑ ${totalCards} –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π`);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            searchInput.placeholder = '–ü–æ–∏—Å–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π...';
        }

        // ============================================
        // –°–ò–°–¢–ï–ú–ê –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê –•–û–°–¢–û–í
        // ============================================
        
        let hostStatuses = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å—Ç–∞—Ç—É—Å–æ–≤ —Ö–æ—Å—Ç–æ–≤
        let failureCounters = {}; // –°—á–µ—Ç—á–∏–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
        let hostLineStats = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ª–∏–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ—Å—Ç–∞
        let monitoringInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        
        // ============================================
        // –§–£–ù–ö–¶–ò–Ø –°–û–†–¢–ò–†–û–í–ö–ò –ö–ê–†–¢–û–ß–ï–ö –ü–†–ï–î–ü–†–ò–Ø–¢–ò–ô
        // ============================================
        
        function sortEnterpriseCards() {
            const grid = document.querySelector('.enterprise-grid');
            if (!grid) return;
            
            const cards = Array.from(grid.querySelectorAll('.enterprise-card'));
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏: —Å–Ω–∞—á–∞–ª–∞ offline (–∫—Ä–∞—Å–Ω—ã–µ), –ø–æ—Ç–æ–º online (–∑–µ–ª–µ–Ω—ã–µ)
            // –í–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–æ–º–µ—Ä—É –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
            cards.sort((a, b) => {
                const aNumber = parseInt(a.getAttribute('data-number')) || 0;
                const bNumber = parseInt(b.getAttribute('data-number')) || 0;
                const aStatus = a.classList.contains('status-offline') ? 'offline' : 'online';
                const bStatus = b.classList.contains('status-offline') ? 'offline' : 'online';
                
                // –ü–µ—Ä–≤—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π: —Å—Ç–∞—Ç—É—Å (offline –ø–µ—Ä–≤—ã–º–∏)
                if (aStatus !== bStatus) {
                    return aStatus === 'offline' ? -1 : 1;
                }
                
                // –í—Ç–æ—Ä–æ–π –∫—Ä–∏—Ç–µ—Ä–∏–π: –Ω–æ–º–µ—Ä –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
                return aNumber - bNumber;
            });
            
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            cards.forEach(card => {
                const wasHidden = card.style.display === 'none';
                grid.appendChild(card);
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –±—ã–ª–∞ —Å–∫—Ä—ã—Ç–∞ –ø–æ–∏—Å–∫–æ–º
                if (wasHidden) {
                    card.style.display = 'none';
                }
            });
            
            console.log('[–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞] –ö–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π —Ö–æ—Å—Ç–æ–≤
        function initializeHostStates() {
            const cards = document.querySelectorAll('.enterprise-card[data-number]');
            cards.forEach(card => {
                const enterpriseNumber = card.dataset.number;
                if (!hostStatuses[enterpriseNumber]) {
                    hostStatuses[enterpriseNumber] = 'online'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–Ω–ª–∞–π–Ω
                    failureCounters[enterpriseNumber] = 0;
                }
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                card.classList.add('status-online');
            });
        }
        
                 // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
         function updateCardStatus(enterpriseNumber, status, responseTime = null, sipPeers = null, lineStats = null, errorMessage = null, diskUsage = null) {
             const card = document.querySelector(`.enterprise-card[data-number="${enterpriseNumber}"]`);
             if (!card) return;
             
             // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —Å—Ç–∞—Ç—É—Å–∞
             card.classList.remove('status-online', 'status-offline', 'status-unknown');
             
             // –î–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π –∫–ª–∞—Å—Å
             card.classList.add(`status-${status}`);
             
             // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ª–∏–Ω–∏–π
             const statsElement = document.getElementById(`stats-${enterpriseNumber}`);
             if (statsElement) {
                 if (lineStats) {
                     // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: GSM/SIP/–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ
                     const gsmStats = `${lineStats.gsm_online}/${lineStats.gsm_total}`;
                     const sipStats = `${lineStats.sip_online}/${lineStats.sip_total}`;
                     const internalStats = `${lineStats.internal_online}/${lineStats.internal_total}`;
                     statsElement.textContent = `${gsmStats} ${sipStats} ${internalStats}`;
                 } else if (status === 'offline') {
                     // –ü—Ä–∏ –æ—Ñ–ª–∞–π–Ω (–ø–æ—Å–ª–µ 3+ –Ω–µ—É–¥–∞—á) –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–ª–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ –æ–±—â–∏–º–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞–º–∏
                     // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                     const savedStats = hostLineStats[enterpriseNumber];
                     if (savedStats) {
                         statsElement.textContent = `0/${savedStats.gsm_total} 0/${savedStats.sip_total} 0/${savedStats.internal_total}`;
                     } else {
                         // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∏–ø–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                         statsElement.textContent = '0/8 0/1 0/3';
                     }
                 }
                 // –ü—Ä–∏ 1-2 –Ω–µ—É–¥–∞—á–∞—Ö (status='online' –Ω–æ –Ω–µ—Ç lineStats) - –ù–ï –¢–†–û–ì–ê–ï–ú —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–æ–æ–±—â–µ
             }
             
             // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∏—Å–∫–µ
             const diskElement = document.getElementById(`disk-${enterpriseNumber}`);
             if (diskElement) {
                 if (diskUsage !== null && status === 'online') {
                     // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–Ω—è—Ç–æ–≥–æ –º–µ—Å—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ –µ—Å—Ç—å)
                     diskElement.textContent = `${diskUsage}%`;
                     diskElement.style.display = 'block';
                     
                     // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–Ω—è—Ç–æ–≥–æ –º–µ—Å—Ç–∞
                     if (diskUsage >= 90) {
                         diskElement.style.color = '#dc3545'; // –ö—Ä–∞—Å–Ω—ã–π - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–Ω–æ–≥–æ –∑–∞–Ω—è—Ç–æ (‚â•90%)
                     } else {
                         diskElement.style.color = '#28a745'; // –ó–µ–ª–µ–Ω—ã–π - –Ω–æ—Ä–º–∞–ª—å–Ω–æ (<90%)
                     }
                 } else {
                     // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∏—Å–∫–µ –µ—Å–ª–∏ —Ö–æ—Å—Ç –æ—Ñ–ª–∞–π–Ω –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                     diskElement.style.display = 'none';
                 }
             }
             
             // –û–±–Ω–æ–≤–ª—è–µ–º title –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
             let title = `–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ ${enterpriseNumber}`;
             if (status === 'online') {
                 if (responseTime !== null && lineStats) {
                     // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–Ω–ª–∞–π–Ω —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
                     title += `\n–°—Ç–∞—Ç—É—Å: –û–Ω–ª–∞–π–Ω\n–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞: ${responseTime}–º—Å`;
                     title += `\nGSM –ª–∏–Ω–∏–∏: ${lineStats.gsm_online}/${lineStats.gsm_total}`;
                     title += `\nSIP –ª–∏–Ω–∏–∏: ${lineStats.sip_online}/${lineStats.sip_total}`;
                     title += `\n–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ: ${lineStats.internal_online}/${lineStats.internal_total}`;
                     if (sipPeers !== null) {
                         title += `\n–í—Å–µ–≥–æ peers: ${sipPeers}`;
                     }
                     if (diskUsage !== null) {
                         title += `\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –¥–∏—Å–∫–∞: ${diskUsage}%`;
                     }
                 } else if (failureCounters[enterpriseNumber] > 0) {
                     // –û–Ω–ª–∞–π–Ω, –Ω–æ –µ—Å—Ç—å –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
                     title += `\n–°—Ç–∞—Ç—É—Å: –û–Ω–ª–∞–π–Ω (–ø—Ä–æ–±–ª–µ–º—ã)\n–ù–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫: ${failureCounters[enterpriseNumber]}/3`;
                     if (errorMessage) {
                         title += `\n–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: ${errorMessage}`;
                     }
                 } else {
                     // –ü—Ä–æ—Å—Ç–æ –æ–Ω–ª–∞–π–Ω
                     title += `\n–°—Ç–∞—Ç—É—Å: –û–Ω–ª–∞–π–Ω`;
                 }
             } else if (status === 'offline') {
                 title += `\n–°—Ç–∞—Ç—É—Å: –û—Ñ–ª–∞–π–Ω\n–ù–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫: ${failureCounters[enterpriseNumber]}`;
                 if (errorMessage) {
                     title += `\n–û—à–∏–±–∫–∞: ${errorMessage}`;
                 }
             }
             card.title = title;
             
             console.log(`[–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥] ${enterpriseNumber}: ${status}, –Ω–µ—É–¥–∞—á: ${failureCounters[enterpriseNumber]}, –¥–∏—Å–∫: ${diskUsage !== null ? diskUsage + '% –∑–∞–Ω—è—Ç–æ' : '–Ω/–¥'}`);
         }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ö–æ—Å—Ç–æ–≤
        async function checkAllHosts() {
            try {
                console.log('[–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥] –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ö–æ—Å—Ç–æ–≤...');
                const response = await fetch('/admin/check-hosts');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('[–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥] –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', data);
                
                                 if (data.success && data.hosts) {
                     data.hosts.forEach(host => {
                         const enterpriseNumber = host.enterprise_number;
                         
                         if (host.status === 'online') {
                             // –•–æ—Å—Ç –æ–Ω–ª–∞–π–Ω - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ—É–¥–∞—á –∏ —Å—Ä–∞–∑—É –∑–µ–ª–µ–Ω—ã–º
                             failureCounters[enterpriseNumber] = 0;
                             hostStatuses[enterpriseNumber] = 'online';
                             // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ª–∏–Ω–∏–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ñ–ª–∞–π–Ω
                             if (host.line_stats) {
                                 hostLineStats[enterpriseNumber] = host.line_stats;
                             }
                             updateCardStatus(enterpriseNumber, 'online', host.response_time_ms, host.sip_peers, host.line_stats, null, host.disk_usage_percent);
                         } else {
                             // –•–æ—Å—Ç –æ—Ñ–ª–∞–π–Ω - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                             failureCounters[enterpriseNumber]++;
                             
                             if (failureCounters[enterpriseNumber] >= 3) {
                                 // –ü–æ—Å–ª–µ 3-—Ö –Ω–µ—É–¥–∞—á –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ—Ñ–ª–∞–π–Ω (–∫—Ä–∞—Å–Ω—ã–º)
                                 hostStatuses[enterpriseNumber] = 'offline';
                                 updateCardStatus(enterpriseNumber, 'offline', null, null, null, host.error_message, null);
                             } else {
                                 // –î–æ 3-—Ö –Ω–µ—É–¥–∞—á –æ—Å—Ç–∞–µ—Ç—Å—è –∑–µ–ª–µ–Ω—ã–º
                                 hostStatuses[enterpriseNumber] = 'online';
                                 updateCardStatus(enterpriseNumber, 'online', null, null, null, `–ü–æ–ø—ã—Ç–∫–∞ ${failureCounters[enterpriseNumber]}/3: ${host.error_message}`, null);
                             }
                         }
                     });
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ localStorage
                    localStorage.setItem('hostStatuses', JSON.stringify(hostStatuses));
                    localStorage.setItem('failureCounters', JSON.stringify(failureCounters));
                    localStorage.setItem('hostLineStats', JSON.stringify(hostLineStats));
                    
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
                    sortEnterpriseCards();
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ GoIP —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                if (data.goip_devices && data.goip_devices.success) {
                    updateGoipStatuses(data.goip_devices.goip_devices);
                }
                
            } catch (error) {
                console.error('[–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ö–æ—Å—Ç–æ–≤:', error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ GoIP —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        function updateGoipStatuses(goipDevices) {
            console.log('[GoIP] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ GoIP —É—Å—Ç—Ä–æ–π—Å—Ç–≤:', goipDevices);
            
            // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ GoIP —Å—Ç–∞—Ç—É—Å—ã
            document.querySelectorAll('[id^="goip-"]').forEach(element => {
                element.style.display = 'none';
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö GoIP —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            goipDevices.forEach(device => {
                const goipElement = document.getElementById(`goip-${device.enterprise_number}`);
                if (goipElement) {
                    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã
                    goipElement.classList.remove('online', 'offline');
                    
                    if (device.status === 'online') {
                        // –ó–µ–ª–µ–Ω–∞—è –≥–∞–ª–æ—á–∫–∞ –¥–ª—è –æ–Ω–ª–∞–π–Ω
                        goipElement.innerHTML = '‚úì';
                        goipElement.classList.add('online');
                        goipElement.style.display = 'block';
                        console.log(`[GoIP] ${device.gateway_name} (${device.enterprise_number}) - –æ–Ω–ª–∞–π–Ω`);
                    } else {
                        // –ö—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –æ—Ñ–ª–∞–π–Ω
                        goipElement.innerHTML = '‚úó';
                        goipElement.classList.add('offline');
                        goipElement.style.display = 'block';
                        console.log(`[GoIP] ${device.gateway_name} (${device.enterprise_number}) - –æ—Ñ–ª–∞–π–Ω: ${device.error_message}`);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ title –∫–∞—Ä—Ç–æ—á–∫–∏
                    const card = document.querySelector(`.enterprise-card[data-number="${device.enterprise_number}"]`);
                    if (card) {
                        let currentTitle = card.title || `–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ ${device.enterprise_number}`;
                        // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ GoIP, –µ—Å–ª–∏ –µ—Å—Ç—å
                        currentTitle = currentTitle.replace(/\nGoIP.*$/m, '');
                        
                        if (device.status === 'online') {
                            currentTitle += `\nGoIP ${device.gateway_name}: –û–Ω–ª–∞–π–Ω (${device.response_time_ms}–º—Å)`;
                        } else {
                            currentTitle += `\nGoIP ${device.gateway_name}: –û—Ñ–ª–∞–π–Ω (${device.error_message})`;
                        }
                        card.title = currentTitle;
                    }
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
        function loadSavedStates() {
            try {
                const savedStatuses = localStorage.getItem('hostStatuses');
                const savedCounters = localStorage.getItem('failureCounters');
                const savedLineStats = localStorage.getItem('hostLineStats');
                
                if (savedStatuses) {
                    hostStatuses = JSON.parse(savedStatuses);
                }
                if (savedCounters) {
                    failureCounters = JSON.parse(savedCounters);
                }
                if (savedLineStats) {
                    hostLineStats = JSON.parse(savedLineStats);
                }
                
                                 // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫ –∫–∞—Ä—Ç–æ—á–∫–∞–º (—Ç–æ–ª—å–∫–æ online/offline)
                 Object.keys(hostStatuses).forEach(enterpriseNumber => {
                     let status = hostStatuses[enterpriseNumber];
                     // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç–∞—Ä—ã–µ unknown —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ online
                     if (status === 'unknown') {
                         status = 'online';
                         hostStatuses[enterpriseNumber] = 'online';
                     }
                     updateCardStatus(enterpriseNumber, status);
                 });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
                sortEnterpriseCards();
                
                console.log('[–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥] –ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:', hostStatuses);
            } catch (error) {
                console.error('[–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π:', error);
            }
        }
        
        // ============================================
        // –°–ò–°–¢–ï–ú–ê –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê LIVE –°–û–ë–´–¢–ò–ô
        // ============================================
        
        let liveEventsInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ live —Å–æ–±—ã—Ç–∏–π
        let rebootEventsInterval = null; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è live —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateLiveEventsDisplay(data) {
            console.log('[Live Events] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', data);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
            Object.keys(data.by_enterprise).forEach(enterpriseNumber => {
                const liveElement = document.getElementById(`live-${enterpriseNumber}`);
                if (liveElement) {
                    const count = data.by_enterprise[enterpriseNumber];
                    
                    if (count > 0) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–π –±–æ–ª—å—à–µ 0
                        liveElement.textContent = count;
                        liveElement.style.display = 'block';
                    } else {
                        // –°–∫—Ä—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–π 0
                        liveElement.style.display = 'none';
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ title –∫–∞—Ä—Ç–æ—á–∫–∏
                    const card = document.querySelector(`.enterprise-card[data-number="${enterpriseNumber}"]`);
                    if (card && count > 0) {
                        let currentTitle = card.title || `–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ ${enterpriseNumber}`;
                        // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ live —Å–æ–±—ã—Ç–∏—è—Ö, –µ—Å–ª–∏ –µ—Å—Ç—å
                        currentTitle = currentTitle.replace(/\nLive —Å–æ–±—ã—Ç–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è: \d+/g, '');
                        currentTitle += `\nLive —Å–æ–±—ã—Ç–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è: ${count}`;
                        card.title = currentTitle;
                    }
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ live —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadLiveEventsStats() {
            try {
                console.log('[Live Events] –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
                const response = await fetch('/admin/live-events-today');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateLiveEventsDisplay(data);
                
            } catch (error) {
                console.error('[Live Events] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—á–µ—Ç—á–∏–∫–∏
                document.querySelectorAll('[id^="live-"]').forEach(element => {
                    element.style.display = 'none';
                });
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ live —Å–æ–±—ã—Ç–∏–π
        function startLiveEventsMonitoring() {
            console.log('[Live Events] –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ live —Å–æ–±—ã—Ç–∏–π...');
            
            // –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ä–∞–∑—É
            loadLiveEventsStats();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
            liveEventsInterval = setInterval(loadLiveEventsStats, 120000);
            
            console.log('[Live Events] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ live —Å–æ–±—ã—Ç–∏–π –∑–∞–ø—É—â–µ–Ω');
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ live —Å–æ–±—ã—Ç–∏–π
        function stopLiveEventsMonitoring() {
            if (liveEventsInterval) {
                clearInterval(liveEventsInterval);
                liveEventsInterval = null;
                console.log('[Live Events] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ live —Å–æ–±—ã—Ç–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç—á–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        async function loadRebootEventsStats() {
            try {
                console.log('[Reboot Events] –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
                const response = await fetch('/admin/reboot-events-today');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateRebootEventsDisplay(data);  // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞—é, —á—Ç–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö
                
                // –ù–æ–≤—ã–π –∫–æ–¥: —Ä–∞—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                if (data.reboot_counts) {
                    let total = Object.values(data.reboot_counts).reduce((sum, count) => sum + count, 0);
                    const totalElement = document.getElementById('total-reboots');
                    if (totalElement) {
                        totalElement.textContent = `R: ${total}`;
                        totalElement.style.display = total > 0 ? 'inline-block' : 'none';
                    }
                }
                
            } catch (error) {
                console.error('[Reboot Events] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫
                const totalElement = document.getElementById('total-reboots');
                if (totalElement) {
                    totalElement.textContent = 'R: 0';
                    totalElement.style.display = 'none';
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫
        function updateRebootEventsDisplay(data) {
            if (!data || !data.success) {
                console.error('[Reboot Events] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
                return;
            }
            
            const rebootCounts = data.reboot_counts || {};
            console.log('[Reboot Events] –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', rebootCounts);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            document.querySelectorAll('[id^="reboot-"]').forEach(element => {
                const enterpriseNumber = element.id.replace('reboot-', '');
                const count = rebootCounts[enterpriseNumber] || 0;
                
                if (count > 0) {
                    element.textContent = 'R' + count;
                    element.style.display = 'block';
                } else {
                    element.style.display = 'none';
                }
            });
        }

        // –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        function startRebootEventsMonitoring() {
            console.log('[Reboot Events] –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...');
            loadRebootEventsStats();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
            rebootEventsInterval = setInterval(loadRebootEventsStats, 120000);
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        function stopRebootEventsMonitoring() {
            if (rebootEventsInterval) {
                clearInterval(rebootEventsInterval);
                rebootEventsInterval = null;
                console.log('[Reboot Events] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–±—ã—Ç–∏–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        function startMonitoring() {
            console.log('[–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥] –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            initializeHostStates();
            loadSavedStates();
            
            // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–∑—É
            checkAllHosts();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
            monitoringInterval = setInterval(checkAllHosts, 60000);
            
            console.log('[–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥] –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–ø—É—â–µ–Ω–∞');
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                console.log('[–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥] –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            }
        }
        
        // API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        window.hostMonitoring = {
            start: startMonitoring,
            stop: stopMonitoring,
            check: checkAllHosts,
            getStatuses: () => hostStatuses,
            getCounters: () => failureCounters,
            clearStates: () => {
                localStorage.removeItem('hostStatuses');
                localStorage.removeItem('failureCounters');
                localStorage.removeItem('hostLineStats');
                hostStatuses = {};
                failureCounters = {};
                hostLineStats = {};
                console.log('[–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥] –°–æ—Å—Ç–æ—è–Ω–∏—è –æ—á–∏—â–µ–Ω—ã');
            },
            liveEvents: {
                start: startLiveEventsMonitoring,
                stop: stopLiveEventsMonitoring,
                check: loadLiveEventsStats
            }
        };
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        startMonitoring();
        startLiveEventsMonitoring();
        startRebootEventsMonitoring();
    });

    // ============================================
    // TELEGRAM USERS MODAL
    // ============================================
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π –º–æ–¥–∞–ª–∫–∏
    let currentEnterpriseNumber = null;
    let currentEnterpriseName = null;

    function openTelegramUsersModal(enterpriseNumber, enterpriseName) {
        currentEnterpriseNumber = enterpriseNumber;
        currentEnterpriseName = enterpriseName;
        
        const telegramModal = document.getElementById('telegramModal');
        const telegramModalTitle = document.getElementById('telegramModalTitle');
        
        telegramModalTitle.textContent = `Telegram-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${enterpriseName}`;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å –∑–∞–≥—Ä—É–∑–∫–æ–π
        telegramModal.style.display = 'block';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        loadTelegramUsersData(enterpriseNumber);
    }
    
    function loadTelegramUsersData(enterpriseNumber) {
        const telegramUsersContainer = document.getElementById('telegramUsersContainer');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        telegramUsersContainer.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        `;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        fetch(`/admin/telegram-users-by-enterprise/${enterpriseNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderTelegramUsers(data.users, enterpriseNumber);
                } else {
                    telegramUsersContainer.innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>`;
                }
            })
            .catch(error => {
                console.error('Telegram users error:', error);
                telegramUsersContainer.innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞: ${error.message}</p>`;
            });
    }
    
    function refreshTelegramUsers() {
        if (currentEnterpriseNumber) {
            loadTelegramUsersData(currentEnterpriseNumber);
        }
    }
    
    function renderTelegramUsers(users, enterpriseNumber) {
        const container = document.getElementById('telegramUsersContainer');
        
        if (users.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
            return;
        }
        
        let html = `
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: left;">–§–ò–û</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: left;">Email</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">–°—Ç–∞—Ç—É—Å</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">–î–∞—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        users.forEach(user => {
            const fullName = `${user.last_name || ''} ${user.first_name || ''}`.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const isAuthorized = user.telegram_authorized;
            const isBlocked = user.telegram_auth_blocked;
            const authDate = user.telegram_auth_date ? new Date(user.telegram_auth_date).toLocaleDateString() : '‚Äî';
            
            html += `
                <tr>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">${fullName}</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px;">${user.email}</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">
                        <span style="color: ${isAuthorized ? '#28a745' : '#dc3545'};">
                            ${isAuthorized ? '‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' : '‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}
                        </span>
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">${authDate}</td>
                    <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">
                        <input type="checkbox" ${isBlocked ? 'checked' : ''} 
                               onchange="toggleTelegramAuthBlock(${user.id}, this.checked)"
                               title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å Telegram-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é">
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">
                        ${isAuthorized ? 
                            `<button onclick="revokeTelegramAuth(${user.id})" 
                                     style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">
                                –û—Ç–æ–∑–≤–∞—Ç—å
                             </button>` : 
                            '<span style="color: #6c757d;">‚Äî</span>'
                        }
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }
    
    function closeTelegramModal() {
        document.getElementById('telegramModal').style.display = 'none';
    }
    
    function revokeTelegramAuth(userId) {
        if (!confirm('–û—Ç–æ–∑–≤–∞—Ç—å Telegram-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
        
        fetch(`/admin/revoke-telegram-auth/${userId}`, {
            method: 'POST',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Telegram-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–æ–∑–≤–∞–Ω–∞');
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –≤ –º–æ–¥–∞–ª–∫–µ
                refreshTelegramUsers();
            } else {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Revoke error:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∑—ã–≤–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
        });
    }
    
    function toggleTelegramAuthBlock(userId, blocked) {
        const formData = new FormData();
        formData.append('blocked', blocked);
        
        fetch(`/admin/block-telegram-auth/${userId}`, {
            method: 'POST',
            credentials: 'include',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const action = blocked ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞';
                alert(`‚úÖ Telegram-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ${action}`);
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –º–æ–¥–∞–ª–∫–µ
                refreshTelegramUsers();
            } else {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–µ–∫–±–æ–∫—Å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                event.target.checked = !blocked;
            }
        })
        .catch(error => {
            console.error('Block error:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏');
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–µ–∫–±–æ–∫—Å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            event.target.checked = !blocked;
        });
    }
  </script>

</body>
</html>
