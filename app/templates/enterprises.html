<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    .button {
      display: inline-block;
      padding: 0.3rem 0.6rem;
      margin: 0 0.3rem 1rem 0;
      background: #007bff;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .button.red {
      background: #dc3545;
    }
    .button.green {
      background: #28a745;
    }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; vertical-align: top; }
    th { background: #f0f0f0; }
    .status-active { color: green; font-weight: bold; }
    .status-inactive { color: red; font-weight: bold; }
    .action-icon {
      margin-right: 8px;
      cursor: pointer;
      font-size: 1.2rem;
      vertical-align: middle;
      color: #007bff;
    }
    .action-icon:hover {
      color: #0056b3;
    }
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —à–∞–ø–∫–∏ –∫–Ω–æ–ø–æ–∫ */
    #service-buttons {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <h1>–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π</h1>

  <!-- –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏ -->
  <div id="service-buttons">
    <button class="button" onclick="serviceAction('/service/restart_main', '–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω')">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å</button>
    <button class="button" onclick="serviceAction('/service/restart_all', '–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã')">üîÅ –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞</button>
    <button class="button" onclick="serviceAction('/service/restart_bots', '–°–µ—Ä–≤–∏—Å—ã –±–æ—Ç–æ–≤ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã')">ü§ñ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–æ–≤</button>
    <button
      id="toggle-bots-btn"
      class="button"
      onclick="toggleBots()"
    >
      ‚öôÔ∏è –í–∫–ª—é—á–∏—Ç—å/–í—ã–∫–ª—é—á–∏—Ç—å –±–æ—Ç–æ–≤
    </button>
  </div>

  <div>
    <a href="/admin/enterprises/add" class="button">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</a>
    <a href="/admin" class="button">–ù–∞–∑–∞–¥</a>
  </div>

  <table>
    <thead>
      <tr>
        <th>–ù–æ–º–µ—Ä</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>Secret</th>
        <th>Bot Token</th>
        <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
        <th>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±–æ—Ç–∞</th>
        <th>Chat ID</th>
        <th>IP</th>
        <th>–î–æ–ø. –∏–º—è</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for ent in enterprises|sort(attribute='number', reverse=false) %}
      <tr>
        <td>{{ ent.number }}</td>
        <td>{{ ent.name }}</td>
        <td>
          <button class="button" onclick="navigator.clipboard.writeText('{{ ent.secret }}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </td>
        <td>
          <button class="button" onclick="navigator.clipboard.writeText('{{ ent.bot_token }}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </td>
        <td>
          {% if ent.bot_available %}
            <form method="post" action="/admin/enterprises/{{ ent.number }}/toggle" style="display:inline;">
              <button
                type="submit"
                class="button {% if not ent.active %}red{% else %}green{% endif %}"
              >
                {% if ent.active %}–û—Ç–∫–ª—é—á–∏—Ç—å{% else %}–í–∫–ª—é—á–∏—Ç—å{% endif %}
              </button>
            </form>
          {% else %}
            <!-- –ù–µ—Ç –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –±–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω -->
          {% endif %}
        </td>
        <td>
          {% if ent.bot_available %}
            <span class="status-active">–î–æ—Å—Ç—É–ø–µ–Ω</span>
          {% else %}
            <span class="status-inactive">–û—à–∏–±–∫–∞</span>
          {% endif %}
        </td>
        <td>{{ ent.chat_id }}</td>
        <td>{{ ent.ip }}</td>
        <td>{{ ent.name2 or '' }}</td>
        <td>
          <a href="/admin/enterprises/{{ ent.number }}/edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="action-icon">‚úé</a>
          <span title="–£–¥–∞–ª–∏—Ç—å" class="action-icon" onclick="confirmDelete('{{ ent.number }}')">üóë</span>
          {% if ent.bot_available %}
            <span title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" class="action-icon" onclick="openMessageDialog('{{ ent.number }}')">‚úâ</span>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="10">–ù–µ—Ç –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    function confirmDelete(number) {
      if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ —Å –Ω–æ–º–µ—Ä–æ–º ${number}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) {
        fetch(`/admin/enterprises/${number}`, { method: 'DELETE' })
          .then(resp => {
            if (resp.ok) {
              alert('–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ');
              location.reload();
            } else {
              resp.json().then(data => alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ${data.detail || 'Unknown error'}`));
            }
          })
          .catch(() => alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏'));
      }
    }

    function openMessageDialog(number) {
      const message = prompt(`–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è ${number}:`);
      if (!message) return;
      if (confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é ${number}?`)) {
        fetch(`/admin/enterprises/${number}/send_message`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ message })
        })
        .then(resp => {
          if (resp.ok) {
            alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
          } else {
            resp.json().then(data => alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ${data.detail || 'Unknown error'}`));
          }
        })
        .catch(() => alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è'));
      }
    }

    async function serviceAction(url, successMsg) {
      try {
        const response = await fetch(url, { method: 'POST' });
        const data = await response.json();
        if (response.ok) {
          alert(successMsg);
          location.reload();
        } else {
          alert("–û—à–∏–±–∫–∞: " + (data.detail || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
        }
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: " + e.message);
      }
    }

    async function toggleBots() {
      try {
        let response = await fetch('/service/bots_status');
        let data = await response.json();
        if (!response.ok) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–æ–≤");
          return;
        }
        const btn = document.getElementById('toggle-bots-btn');
        if (data.running) {
          await serviceAction('/service/stop_bots', '–°–µ—Ä–≤–∏—Å—ã –±–æ—Ç–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
          btn.classList.remove('green');
          btn.classList.add('red');
        } else {
          await serviceAction('/service/restart_bots', '–°–µ—Ä–≤–∏—Å—ã –±–æ—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω—ã');
          btn.classList.remove('red');
          btn.classList.add('green');
        }
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –±–æ—Ç–æ–≤: " + e.message);
      }
    }

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–±–Ω–æ–≤–∏–º —Ü–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        let response = await fetch('/service/bots_status');
        let data = await response.json();
        const btn = document.getElementById('toggle-bots-btn');
        if (data.running) {
          btn.classList.remove('red');
          btn.classList.add('green');
        } else {
          btn.classList.remove('green');
          btn.classList.add('red');
        }
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–æ–≤:", e);
      }
    });
  </script>
</body>
</html>
