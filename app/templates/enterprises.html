<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    .button {
      display: inline-block;
      padding: 0.2rem 0.4rem;
      margin: 0 0.2rem 0.5rem 0;
      background: #007bff;
      color: #fff;
      text-decoration: none;
      border-radius: 3px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .button.red {
      background: #dc3545;
    }
    .button.green {
      background: #28a745;
    }
    .copy-button {
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      background: none;
      border: none;
      padding: 0;
      margin: 0 auto;
      width: 100%;
    }
    .copy-button:hover {
      opacity: 0.7;
    }
    table { border-collapse: collapse; width: 100%; margin-top: 0.5rem; }
    th, td { 
      border: 1px solid #ccc; 
      padding: 0.2rem; 
      vertical-align: middle;
      font-size: 0.9rem;
      text-align: center;
    }
    th { 
      background: #f0f0f0;
      white-space: nowrap;
    }
    td.copy-cell {
      width: 60px;
      padding: 0;
    }
    td.name2-cell {
      width: 100px;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    td.active-cell {
      width: 60px;
      padding: 0;
    }
    .status-active { color: green; font-weight: bold; }
    .status-inactive { color: red; font-weight: bold; }
    .action-icon {
      margin-right: 4px;
      cursor: pointer;
      font-size: 1rem;
      vertical-align: middle;
      color: #007bff;
    }
    .action-icon:hover {
      color: #0056b3;
    }
    #service-buttons {
      margin-bottom: 0.5rem;
    }
    .toggle-button {
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      background: none;
      border: none;
      padding: 0;
      margin: 0 auto;
      width: 100%;
      transition: color 0.2s;
    }
    .toggle-button.active {
      color: #28a745;
    }
    .toggle-button.inactive {
      color: #dc3545;
    }
    .copy-notification {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      animation: fadeInOut 2s ease-in-out;
      z-index: 1000;
      font-size: 0.9rem;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }
    .banned-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 1rem 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
      font-size: 0.9rem;
    }
    .banned-count {
      color: #dc3545;
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .refresh-icon {
      cursor: pointer;
      font-size: 1.2rem;
      color: #6c757d;
    }
    .refresh-icon:hover {
      color: #007bff;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .modal-content {
      position: relative;
      background: white;
      margin: 10% auto;
      padding: 20px;
      width: 80%;
      max-width: 600px;
      border-radius: 5px;
      max-height: 70vh;
      overflow-y: auto;
    }
    .close-modal {
      position: absolute;
      right: 10px;
      top: 10px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6c757d;
    }
    .close-modal:hover {
      color: #dc3545;
    }
    .banned-ip-list {
      margin-top: 1rem;
    }
    .banned-ip-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      border-bottom: 1px solid #dee2e6;
    }
    .banned-ip-item:last-child {
      border-bottom: none;
    }
    .search-container {
      margin: 1rem 0;
    }
    .search-input {
      padding: 0.2rem 0.4rem;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      box-sizing: border-box;
      max-width: 120px;
    }
    .search-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    th.search-header {
      padding: 0;
      width: 120px;
      max-width: 120px;
    }
    td.name-cell {
      width: 120px;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <h1>–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π</h1>

  <div class="banned-info">
    <span>–ó–∞–±–∞–Ω–µ–Ω–æ: <span class="banned-count" onclick="showBannedIPs()">0</span></span>
    <span class="refresh-icon" onclick="refreshBannedCount()" title="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</span>
  </div>

  <div id="bannedModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeBannedModal()">&times;</span>
      <h2>–°–ø–∏—Å–æ–∫ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö IP-–∞–¥—Ä–µ—Å–æ–≤</h2>
      <div id="bannedIpList" class="banned-ip-list">
        <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–ø–∏—Å–æ–∫ IP -->
      </div>
    </div>
  </div>

  <div id="service-buttons">
    <button class="button" onclick="serviceAction('/service/restart_main', '–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω')">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å</button>
    <button class="button" onclick="serviceAction('/service/restart_all', '–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã')">üîÅ –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞</button>
    <button class="button" onclick="serviceAction('/service/restart_bots', '–°–µ—Ä–≤–∏—Å—ã –±–æ—Ç–æ–≤ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã')">ü§ñ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–æ–≤</button>
  </div>

  <div>
    <a href="/admin/enterprises/add" class="button">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</a>
    <a href="/admin/dashboard" class="button">–ù–∞–∑–∞–¥</a>
  </div>

  <div id="copyNotification" class="copy-notification">
    –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!
  </div>

  <table>
    <thead>
      <tr>
        <th>‚Ññ</th>
        <th class="search-header">
          <input type="text" 
                 class="search-input" 
                 id="nameFilter" 
                 placeholder="Name"
                 oninput="filterEnterprises()">
        </th>
        <th>Name2</th>
        <th>Secret</th>
        <th>Token</th>
        <th>Active</th>
        <th>–°–≤—è–∑—å</th>
        <th>IP</th>
        <th>RUN</th>
      </tr>
    </thead>
    <tbody>
      {% for ent in enterprises|sort(attribute='number', reverse=false) %}
      <tr>
        <td>{{ ent.number }}</td>
        <td class="name-cell">{{ ent.name }}</td>
        <td class="name2-cell">{{ ent.name2 or '' }}</td>
        <td class="copy-cell">
          <button class="copy-button" onclick="copyWithNotification('{{ ent.secret }}', 'Secret', '{{ ent.name }}')">üìã</button>
        </td>
        <td class="copy-cell">
          <button class="copy-button" onclick="copyWithNotification('{{ ent.bot_token }}', 'Token', '{{ ent.name }}')">üìã</button>
        </td>
        <td class="active-cell">
          {% if ent.bot_available %}
            <form method="post" action="/admin/enterprises/{{ ent.number }}/toggle" style="display:inline;">
              <button type="submit" class="toggle-button {% if ent.active %}active{% else %}inactive{% endif %}" title="{% if ent.active %}–ê–∫—Ç–∏–≤–µ–Ω{% else %}–ù–µ–∞–∫—Ç–∏–≤–µ–Ω{% endif %}">
                {% if ent.active %}üü¢{% else %}üî¥{% endif %}
              </button>
            </form>
          {% else %}
            <!-- –ù–µ—Ç –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –±–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω -->
          {% endif %}
        </td>
        <td>
          {% if ent.bot_available %}
            <span class="status-active">–î–æ—Å—Ç—É–ø–µ–Ω</span>
          {% else %}
            <span class="status-inactive">–û—à–∏–±–∫–∞</span>
          {% endif %}
        </td>
        <td>{{ ent.ip }}</td>
        <td>
          <a href="/admin/enterprises/{{ ent.number }}/edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="action-icon">‚úé</a>
          <span title="–£–¥–∞–ª–∏—Ç—å" class="action-icon" onclick="confirmDelete('{{ ent.number }}')">üóë</span>
          {% if ent.bot_available %}
            <span title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" class="action-icon" onclick="openMessageDialog('{{ ent.number }}')">‚úâ</span>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="9">–ù–µ—Ç –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    function confirmDelete(number) {
      if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ —Å –Ω–æ–º–µ—Ä–æ–º ${number}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) {
        fetch(`/admin/enterprises/${number}`, { method: 'DELETE' })
          .then(resp => {
            if (resp.ok) {
              alert('–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ');
              location.reload();
            } else {
              resp.json().then(data => alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ${data.detail || 'Unknown error'}`));
            }
          })
          .catch(() => alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏'));
      }
    }

    function openMessageDialog(number) {
      const message = prompt(`–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è ${number}:`);
      if (!message) return;
      if (confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—é ${number}?`)) {
        fetch(`/admin/enterprises/${number}/send_message`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ message })
        })
        .then(resp => {
          if (resp.ok) {
            alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
          } else {
            resp.json().then(data => alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ${data.detail || 'Unknown error'}`));
          }
        })
        .catch(() => alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è'));
      }
    }

    async function serviceAction(url, successMsg) {
      try {
        const response = await fetch(url, { method: 'POST' });
        const data = await response.json();
        if (response.ok) {
          alert(successMsg);
          location.reload();
        } else {
          alert("–û—à–∏–±–∫–∞: " + (data.detail || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
        }
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: " + e.message);
      }
    }

    function showCopyNotification(text, enterpriseName) {
      const notification = document.getElementById('copyNotification');
      notification.textContent = `${text} –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è "${enterpriseName}" —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!`;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 2000);
    }

    function copyWithNotification(text, type, enterpriseName) {
      navigator.clipboard.writeText(text)
        .then(() => {
          showCopyNotification(type, enterpriseName);
        })
        .catch(err => {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏: ' + err);
        });
    }

    async function refreshBannedCount() {
      try {
        const response = await fetch('/admin/banned_count');
        const data = await response.json();
        document.querySelector('.banned-count').textContent = data.count;
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö IP:', err);
      }
    }

    async function showBannedIPs() {
      try {
        const response = await fetch('/admin/banned_ips');
        const bannedIPs = await response.json();
        
        const listHTML = bannedIPs.map(ip => `
          <div class="banned-ip-item">
            <span>${ip.ip}</span>
            <span>${ip.country}, ${ip.city}, ${ip.region}</span>
          </div>
        `).join('');
        
        document.getElementById('bannedIpList').innerHTML = listHTML || '–ù–µ—Ç –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö IP-–∞–¥—Ä–µ—Å–æ–≤';
        document.getElementById('bannedModal').style.display = 'block';
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö IP:', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö IP');
      }
    }

    function closeBannedModal() {
      document.getElementById('bannedModal').style.display = 'none';
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    window.onclick = function(event) {
      const modal = document.getElementById('bannedModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö IP –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', refreshBannedCount);

    function filterEnterprises() {
      const searchText = document.getElementById('nameFilter').value.toLowerCase();
      const rows = document.querySelectorAll('table tbody tr');
      
      rows.forEach(row => {
        const nameCell = row.children[1]; // –∏–Ω–¥–µ–∫—Å 1 - —Å—Ç–æ–ª–±–µ—Ü Name
        const name = nameCell.textContent.toLowerCase();
        
        if (name.startsWith(searchText)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
  </script>
</body>
</html>
