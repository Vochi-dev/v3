# SIP: входящее преобразование номера (tracker)

## Цели
- Нормализовать входящий номер до канонического формата до маршрутизации/интеграций.
- Правила задаются пер‑SIP‑линии. Без изменений на удалённых АТС.

## DSL правила
- Формат: `<prefix>{N}`. Пример: `+375{9}` → взять последние 9 цифр входящего, приставить `+375`.
- Опционально (на будущее):
  - strip лидирующих символов: `strip=leading:+,0,8`
  - min_len: защита от слишком коротких номеров

## Acceptance Criteria
- Для линии `3880923` входящие `+0296254070`/`80296254070` → `+375296254070`.
- Нормализованный номер используется во всех сервисах (8021/8020/логирование/интеграции).
- Изменение правила на UI вступает в силу ≤ 1 мин (через инвалидацию кэша 8020).

---

## To‑Do (шаги внедрения)

### 1) База данных
- [x] Добавлено поле `incoming_transform TEXT` в `sip_unit` (+ COMMENT).

### 2) Backend: enterprise_admin_service
- [x] Поле `incoming_transform` включено в GET/детали SIP‑линий.
- [x] Поле принимается в POST/PUT и сохраняется в `sip_unit`.
- [x] После сохранения дергается `POST 8020/reload-incoming-transform/{enterprise}` + регенерация плана.

### 3) UI: `templates/enterprise_admin/dashboard.html`
- [x] В модалку SIP‑линии добавлено поле «Входящее преобразование» (пример `+375{9}`); значение подхватывается/сохраняется.
  - [ ] Дополнить кнопкой «Проверить» и валидацией `^(\+?\d+)?\{\d+\}$`.

### 4) Кэш 8020 (integration_cache)
- [x] Кэш правил `incoming_transform` на юнит (TTL 90с).
- [x] Эндпоинты: `GET /incoming-transform/{enterprise}`, `POST /reload-incoming-transform/{enterprise}`.
- [x] Применение правила в `/dispatch/call-event` (для всех интеграций, в т.ч. Telegram/Retail).

### 5) 8021 (smart.py)
- [x] Раннее применение нормализации по карте 8020 (для `sip:<trunk>` и `gsm:<trunk>`), кэш ответов отключён.
  - [ ] Добавить поле `normalized_phone` в decisions‑лог.

### 6) Поток звонков (start/dial/bridge/hangup)
- [x] В сервисе 8000 нормализация применяется до отправки сообщений в Telegram и до сохранения событий.

### 7) Тесты
- [ ] Набор юнит‑кейсов для нормализатора (BY/RU, разные мусорные форматы, граничные случаи).

### 8) Документация
- [ ] Обновить админ‑гайд/README: как задавать правила и проверять на UI.

### 9) Релиз
- [x] Канареечный запуск на 0367 (Anitex) — подтверждено, что в Telegram и Retail номер нормализован.
- [ ] Rollback: очистка `incoming_transform` и инвалидация кэша 8020 (при необходимости).

---

## Статус
- Выполнено: 1, 2, 3 (частично), 4, 5, 6, 9 (canary OK).
- Осталось: UI‑валидация/кнопка проверки, метрика normalized_phone в 8021, документация.
