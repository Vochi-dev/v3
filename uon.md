# Интеграция с U-ON.Travel (телефония)

Источник: документация U‑ON API — см. разделы и общие правила вызовов ([api.u-on.ru/doc](https://api.u-on.ru/doc)).

## Цели интеграции
- При входящем/исходящем звонке обогащать карточку диалога данными клиента из U‑ON (ФИО, статус, активные заявки, менеджер).
- Фиксировать звонки как события в U‑ON (по возможности: создать обращение/комментарий/задачу, привязать к клиенту/заявке).
- Синхронизировать телефонные номера клиентов (по E.164) с нашей БД `customers`.
- Поддержать вебхуки U‑ON (создание/изменение клиента, начисления, и т.п.)

## Ограничения и требования U‑ON
- Все запросы только по HTTPS.
- Лимит: не более 10 запросов/секунду.
- Многие методы — постраничная выдача (параметр `page`).
- API нужно активировать в U‑ON: «Настройки → Интеграции → API».

## Архитектура интеграции
- 8020 (integration_cache): новый провайдер `uon`, кэш на 2–5 мин для карточек клиентов и служебных справочников (менеджеры, заявки по номеру).
- 8000 (webhooks): на события `start/dial/bridge/hangup` — асинхронное обогащение и при `hangup` — создание события в U‑ON (если включено).
- 8019 (retailcrm) — без изменений; для U‑ON создаём новый сервис 8018 `uon.py` (FastAPI), который инкапсулирует вызовы U‑ON и маппинг.
- `customers` — дополнение полей при наличии данных из U‑ON (ФИО/компания, ответы по звонкам).

## Потоки
1) Входящий/исходящий звонок (live):
   - Нормализация номера → запрос профиля клиента в 8020/uon → обновление `customers` (перезапись непустыми свежими значениями) → Telegram: добавляем ФИО/теги U‑ON.
   - По `hangup`: при опции «логировать в U‑ON» — создаём обращение/комментарий (см. методы U‑ON, конкретный endpoint согласуем после пилота).
2) Recovery (8007): пакетное обогащение по уникальным номерам, без онлайн‑вызовов в U‑ON на каждый евент (RPS‑лимит).
3) Вебхуки U‑ON → наш 8018/uon-webhook:
   - type_id (по документации) → обновление локальных кэшей/привязок (клиенты, менеджеры, заявки).

## Точки интеграции (черновик)
- По документации видно, что API ключ: `{key}`, формат: `json|xml`. URL базовый: `https://api.u-on.ru/{key}/...` ([док](https://api.u-on.ru/doc)).
- Методы для клиентов/заявок/вебхуков присутствуют в общем справочнике API. Для телефонии прямых методов немного; используем:
  - По номеру телефона: поиск клиента/карт/заявок (конкретные endpoints уточняем; если нет прямого — используем поиск по клиентам/контактам).
  - Создание/логирование события/комментария в заявке/карточке клиента (подберём подходящий endpoint из /request/* или /lead/*, либо общий комментарий).
  - Вебхуки U‑ON (таблица с type_id) — на наш endpoint (подпись/ключ, список допустимых IP).

## Безопасность
- Хранение API‑ключей в `enterprises.integrations_config.uon` (JSONB) с маскированием в UI.
- IP‑фильтр/секрет при приёме вебхуков.
- RPS‑ограничение 8020 для U‑ON: не более 8 rps с запасом.

## Настройки в админке предприятия
- Раздел «Интеграции → U‑ON»:
  - Переключатель включено/выключено.
  - Поля: `api_key`, `primary` (если U‑ON — главный источник ФИО), чекбокс «логировать звонки в U‑ON».
  - Кнопка «Проверить» (health‑пинг и пробный поиск клиента по номеру).

## To‑Do
1) 8018 `uon.py` (FastAPI):
   - Клиент к U‑ON (httpx, таймауты, ретраи, rate‑limit).
   - Методы: `GET /internal/uon/customer-by-phone?phone=...` (возврат профиля с ФИО/ID/активные заявки), `POST /internal/uon/log-call` (создать событие).
   - Вебхуки `POST /uon/webhook` (обработка type_id, обновление кэшей через 8020).
2) 8020 (integration_cache):
   - Кэш профиля по (enterprise, phone), TTL 2–5 мин; negative‑TTL 1–2 мин.
   - Адаптер к 8018: `GET /customer-profile/{enterprise}/{phone}` с провайдером `uon`.
3) 8000:
   - Вставка обогащения U‑ON в live‑поток (и редактирование Telegram‑сообщений).
   - На `hangup` — условный вызов `log-call`.
4) UI (`enterprise_admin`):
   - Блок интеграции U‑ON в модалке «Интеграции» (ключ, тестовая проверка, включение логирования звонков).
5) Документация/мониторинг:
   - uon.md (этот файл), примеры запросов/ответов, форматы хранения.
   - Метрики RPS/ошибок и логи интеграции.

## Примеры (черновик)
- Ограничения & замечания: см. правила U‑ON (HTTPS, 10 rps, page) — [документация](https://api.u-on.ru/doc).
- Создание сущностей и справочники в U‑ON доступны множеством методов. На этапе пилота фокус — поиск клиента по телефону и создание события по звонку.

### Всплывашка у менеджера (уведомление)
Рабочий способ вызвать всплывающую карточку у менеджера — отправить уведомление:

```
POST https://api.u-on.ru/{API_KEY}/notification/create.json
Content-Type: application/json

{
  "text": "Входящий звонок +375296254070 → 151",
  "manager_id": "2"
}
```

Где `manager_id` — ID менеджера в U‑ON (не внутренний номер). Возвращает `{ "result": 200 }` при успехе. Этот метод мы используем для кнопки «Тест» в админке, чтобы имитировать звонок и показать карточку.

### Входящий вебхук из U‑ON → инициировать звонок (originate)

U‑ON может вызывать наш endpoint при нажатии «позвонить клиенту» в интерфейсе. Поддерживаем JSON и form‑urlencoded.

- Endpoint: `POST https://bot.vochi.by/uon/webhook`
- Параметры (ключи могут приходить на русском, они поддерживаются):
  - `method` | `метод`: строка, ожидаем значение `call`
  - `user_id` | `ID пользователя`: ID менеджера в U‑ON (например `2` или `4`)
  - `phone` | `телефон`: номер клиента, допускается без `+` (мы нормализуем к E.164)
  - `uon_id` | `account_id` | `uon_subdomain`: идентификатор/субдомен аккаунта U‑ON для привязки к нашему юниту
  - `client` | `клиент`: JSON со сведениями о клиенте (опционально)

Алгоритм обработки:
1) Ищем предприятие по `integrations_config.uon.account_id` либо `integrations_config.uon.subdomain` (если не найдены — берём единственный активный юнит с включённой U‑ON интеграцией).
2) По `user_id` находим внутренний номер через `integrations_config.uon.user_extensions`.
3) Нормализуем номер клиента к E.164.
4) Инициируем звонок через `asterisk.py` (`GET http://localhost:8018/api/makecallexternal?code=<ext>&phone=<e164>&clientId=<secret>`).
5) Возвращаем `{ ok: true }` при успехе.

Пример (form):
```
method=call&user_id=2&phone=375296254070&uon_id=67054
```

Пример (JSON):
```
{
  "method": "call",
  "user_id": 4,
  "phone": "375296254070",
  "uon_id": "67054"
}
```

## Полезные ссылки
- U‑ON API: https://api.u-on.ru/doc
- Неофициальный PHP‑клиент (как ориентир по эндпоинтам и моделям): https://github.com/DrTeamRocks/uon


