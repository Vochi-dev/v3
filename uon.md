# Интеграция с U-ON.Travel (телефония)

Источник: документация U‑ON API — см. разделы и общие правила вызовов ([api.u-on.ru/doc](https://api.u-on.ru/doc)).

## Цели интеграции
- При входящем/исходящем звонке обогащать карточку диалога данными клиента из U‑ON (ФИО, статус, активные заявки, менеджер).
- Фиксировать звонки как события в U‑ON (по возможности: создать обращение/комментарий/задачу, привязать к клиенту/заявке).
- Синхронизировать телефонные номера клиентов (по E.164) с нашей БД `customers`.
- Поддержать вебхуки U‑ON (создание/изменение клиента, начисления, и т.п.)

## Ограничения и требования U‑ON
- Все запросы только по HTTPS.
- Лимит: не более 10 запросов/секунду.
- Многие методы — постраничная выдача (параметр `page`).
- API нужно активировать в U‑ON: «Настройки → Интеграции → API».

## Архитектура интеграции
- 8020 (integration_cache): новый провайдер `uon`, кэш на 2–5 мин для карточек клиентов и служебных справочников (менеджеры, заявки по номеру).
- 8000 (webhooks): на события `start/dial/bridge/hangup` — асинхронное обогащение и при `hangup` — создание события в U‑ON (если включено).
- 8019 (retailcrm) — без изменений; для U‑ON создаём новый сервис 8018 `uon.py` (FastAPI), который инкапсулирует вызовы U‑ON и маппинг.
- `customers` — дополнение полей при наличии данных из U‑ON (ФИО/компания, ответы по звонкам).

## Потоки
1) Входящий/исходящий звонок (live):
   - Нормализация номера → запрос профиля клиента в 8020/uon → обновление `customers` (перезапись непустыми свежими значениями) → Telegram: добавляем ФИО/теги U‑ON.
   - По `hangup`: при опции «логировать в U‑ON» — создаём обращение/комментарий (см. методы U‑ON, конкретный endpoint согласуем после пилота).
2) Recovery (8007): пакетное обогащение по уникальным номерам, без онлайн‑вызовов в U‑ON на каждый евент (RPS‑лимит).
3) Вебхуки U‑ON → наш 8018/uon-webhook:
   - type_id (по документации) → обновление локальных кэшей/привязок (клиенты, менеджеры, заявки).

## Точки интеграции (черновик)
- По документации видно, что API ключ: `{key}`, формат: `json|xml`. URL базовый: `https://api.u-on.ru/{key}/...` ([док](https://api.u-on.ru/doc)).
- Методы для клиентов/заявок/вебхуков присутствуют в общем справочнике API. Для телефонии прямых методов немного; используем:
  - По номеру телефона: поиск клиента/карт/заявок (конкретные endpoints уточняем; если нет прямого — используем поиск по клиентам/контактам).
  - Создание/логирование события/комментария в заявке/карточке клиента (подберём подходящий endpoint из /request/* или /lead/*, либо общий комментарий).
  - Вебхуки U‑ON (таблица с type_id) — на наш endpoint (подпись/ключ, список допустимых IP).

## Безопасность
- Хранение API‑ключей в `enterprises.integrations_config.uon` (JSONB) с маскированием в UI.
- IP‑фильтр/секрет при приёме вебхуков.
- RPS‑ограничение 8020 для U‑ON: не более 8 rps с запасом.

## Настройки в админке предприятия
- Раздел «Интеграции → U‑ON»:
  - Переключатель включено/выключено.
  - Поля: `api_key`, `primary` (если U‑ON — главный источник ФИО), чекбокс «логировать звонки в U‑ON».
  - Кнопка «Проверить» (health‑пинг и пробный поиск клиента по номеру).

## To‑Do
1) 8018 `uon.py` (FastAPI):
   - Клиент к U‑ON (httpx, таймауты, ретраи, rate‑limit).
   - Методы: `GET /internal/uon/customer-by-phone?phone=...` (возврат профиля с ФИО/ID/активные заявки), `POST /internal/uon/log-call` (создать событие).
   - Вебхуки `POST /uon/webhook` (обработка type_id, обновление кэшей через 8020).
2) 8020 (integration_cache):
   - Кэш профиля по (enterprise, phone), TTL 2–5 мин; negative‑TTL 1–2 мин.
   - Адаптер к 8018: `GET /customer-profile/{enterprise}/{phone}` с провайдером `uon`.
3) 8000:
   - Вставка обогащения U‑ON в live‑поток (и редактирование Telegram‑сообщений).
   - На `hangup` — условный вызов `log-call`.
4) UI (`enterprise_admin`):
   - Блок интеграции U‑ON в модалке «Интеграции» (ключ, тестовая проверка, включение логирования звонков).
5) Документация/мониторинг:
   - uon.md (этот файл), примеры запросов/ответов, форматы хранения.
   - Метрики RPS/ошибок и логи интеграции.

### Дополнительно (следующий этап)
6) Запись ФИО клиента в БД при приоритете U‑ON:
   - Использовать флаг `integrations_config.uon.primary` (в `enterprises.integrations_config`).
   - Сохранять сквозной идентификатор клиента: в `customers.meta.ids.uon` добавлять `client_id` из U‑ON; при первом связывании выставлять `meta.person_uid = "uon:<client_id>"`.
   - При успешном получении профиля из U‑ON и по событию `hangup` — выполнять апсерт ФИО клиента в нашей БД. Массовый апдейт распространять на все записи с тем же `person_uid` (или совпадающим `ids.uon`).
   - Точный набор таблиц/полей определить после просмотра структуры БД (см. `db_readme.txt`) — не делать предположений до ревью схемы.
   - При сохранении конфигурации U‑ON автоматически:
     - удалить ранее созданные вебхуки (если есть ID в `integrations_config.uon.webhooks`),
     - зарегистрировать заново: type_id=47 (клик по номеру), type_id=3 (создание клиента), type_id=4 (изменение клиента),
     - сохранить новые ID в `integrations_config.uon.webhooks`.
7) Хэнгапы через сервис download.py:
   - При обработке завершённых вызовов сервисом `download.py` (порт 8012) отправлять событие в U‑ON (лог звонка) без поднятия карточки.
   - В этот же момент обновлять/записывать ФИО в БД (если U‑ON — приоритетный источник, см. п.6).
8) Взаимодействие со `smart.py` при маршрутизации:
   - При originate/роутинге вызывать `smart.py` для определения отображаемых данных (smart redirect) и передавать их в телефон/диалплан.
   - Согласовать формат обмена данными между `uon.py` и `smart.py` (имя клиента, метки, приоритеты, варианты редиректа).
   - Набор юнит‑тестов на сценарии smart redirect.
9) План по вариативности команд U‑ON:
   - Составить перечень используемых методов/альтернатив в U‑ON и варианты поведения (фичетогглы/параметры).
   - Подготовить вопросы/варианты на согласование с заказчиком (будут дополнительные комментарии).

## Примеры (черновик)
- Ограничения & замечания: см. правила U‑ON (HTTPS, 10 rps, page) — [документация](https://api.u-on.ru/doc).
- Создание сущностей и справочники в U‑ON доступны множеством методов. На этапе пилота фокус — поиск клиента по телефону и создание события по звонку.

### Всплывашка у менеджера (уведомление)
Рабочий способ вызвать всплывающую карточку у менеджера — отправить уведомление:

```
POST https://api.u-on.ru/{API_KEY}/notification/create.json
Content-Type: application/json

{
  "text": "Входящий звонок +375296254070 → 151",
  "manager_id": "2"
}
```

Где `manager_id` — ID менеджера в U‑ON (не внутренний номер). Возвращает `{ "result": 200 }` при успехе. Этот метод мы используем для кнопки «Тест» в админке, чтобы имитировать звонок и показать карточку.

### Входящий вебхук из U‑ON → инициировать звонок (originate)

U‑ON может вызывать наш endpoint при нажатии «позвонить клиенту» в интерфейсе. Поддерживаем JSON и form‑urlencoded.

- Endpoint: `POST https://bot.vochi.by/uon/webhook`
- Параметры (ключи могут приходить на русском, они поддерживаются):
  - `method` | `метод`: строка, ожидаем значение `call`
  - `user_id` | `ID пользователя`: ID менеджера в U‑ON (например `2` или `4`)
  - `phone` | `телефон`: номер клиента, допускается без `+` (мы нормализуем к E.164)
  - `uon_id` | `account_id` | `uon_subdomain`: идентификатор/субдомен аккаунта U‑ON для привязки к нашему юниту
  - `client` | `клиент`: JSON со сведениями о клиенте (опционально)

Алгоритм обработки:
1) Ищем предприятие по `integrations_config.uon.account_id` либо `integrations_config.uon.subdomain` (если не найдены — берём единственный активный юнит с включённой U‑ON интеграцией).
2) По `user_id` находим внутренний номер через `integrations_config.uon.user_extensions`.
3) Нормализуем номер клиента к E.164.
4) Инициируем звонок через `asterisk.py` (`GET http://localhost:8018/api/makecallexternal?code=<ext>&phone=<e164>&clientId=<secret>`).
5) Возвращаем `{ ok: true }` при успехе.

Пример (form):
```
method=call&user_id=2&phone=375296254070&uon_id=67054
```

Пример (JSON):
```
{
  "method": "call",
  "user_id": 4,
  "phone": "375296254070",
  "uon_id": "67054"
}
```

## Полезные ссылки
- U‑ON API: https://api.u-on.ru/doc
- Неофициальный PHP‑клиент (как ориентир по эндпоинтам и моделям): https://github.com/DrTeamRocks/uon


## Юнит‑тестирование (минимальный чек‑лист)

1) Подготовка
   - Включить U‑ON в `enterprises.integrations_config.uon` (api_key, enabled=true). Пересохранить, чтобы автозавелись вебхуки type_id 47/3/4.
   - По желанию: `uon.primary=true` или `smart.primary='uon'` — тогда ФИО из U‑ON перезаписывает БД.
   - Настроить `uon.user_extensions` для маппинга manager_id→extension (для маршрутизации через 8020/Smart).

2) Тест: создание клиента (type_id=3)
   - Отправить form-urlencoded на наш `POST /uon/webhook`:
     - Ключи: `uon_id|uon_subdomain`, `type_id=3`, `user_id`, `client_id`, `client[u_id]`, ФИО `client[u_surname]`, `client[u_name]`, отчество `client[u_sname]`, телефоны `client[u_phone]`, `client[u_phone_mobile]`, `client[u_phone_home]`.
   - Ожидаемое:
     - Для каждого телефона создан/обновлён `customers(enterprise_number, phone_e164)`.
     - В `meta.ids.uon` добавлен `client_id`, установлен `meta.person_uid='uon:<client_id>'` (если пуст).
     - ФИО записано по правилу приоритета.

   Пример (curl):
   ```bash
   curl -sS -X POST https://bot.vochi.by/uon/webhook \
     -H 'Content-Type: application/x-www-form-urlencoded' \
     --data 'uon_id=67054&type_id=3&user_id=2&client_id=5&client[u_id]=5&client[u_surname]=Иванов&client[u_name]=Иван&client[u_sname]=Иванович&client[u_phone]=+375297003134'
   ```

3) Тест: изменение клиента (type_id=4)
   - Аналогично, но `type_id=4` и изменённые поля ФИО/телефонов.
   - Ожидаемое: ФИО обновилось во всех строках с тем же `person_uid`; новые телефоны добавлены как отдельные строки и связаны через `meta.ids.uon`.

4) Быстрая проверка БД (psql)
   ```sql
   SELECT enterprise_number, phone_e164, last_name, first_name, middle_name,
          meta->'ids'->'uon' AS ids_uon, meta->>'person_uid' AS person_uid
   FROM customers
   WHERE enterprise_number = '<UNIT>' AND phone_e164 IN ('+375297003134', '+375296254070');
   ```

5) Маршрутизация (опционально)
   - Проверить `GET http://127.0.0.1:8020/responsible-extension/<UNIT>/<+E164>?nocache=true` возвращает внутренний код с учётом `uon.user_extensions`.


### Зафиксированные результаты нашего тестирования (2025‑08‑20)

- Создание клиента (id=5) с телефоном `+375293213218` → в БД записались:
  - ФИО: `Юонова Юлия Николаевна`
  - `meta.ids.uon=["5"]`, `meta.person_uid='uon:5'`
  - Затем запись удалялась по просьбе тестировщика.

- Создание клиента (id=7) с телефоном `+375297003134` → в БД:
  - ФИО: `Тестирование Третье Создание`, `meta.ids.uon=["7"]`, `person_uid='uon:7'`
  - Изменение ФИО (type_id=4) → `Тестирование Четвертое Редактирование`.
  - Добавление второго телефона `+375295556611` (type_id=4) создало вторую строку с тем же `person_uid='uon:7'` и тем же ФИО.
  - Повторное изменение ФИО распространилось на обе строки (оба номера показывают одинаковое актуальное ФИО: `Тестирование Пятое Редактирование`).

- Авто‑тесты: добавлен файл `test_uon_customers_flow.py`, который программно воспроизводит сценарии создания, изменения ФИО и добавления второго телефона через вебхуки `type_id=3/4`.

Статус primary‑проверки:
- Массовое обновление ФИО по одному `person_uid` подтверждено (оба номера клиента обновились одинаково).

Рекомендованный следующий тест:
- Проверка роутинга: настроить `uon.user_extensions` для нескольких `manager_id`, затем вызвать `GET /internal/uon/responsible-extension` и убедиться, что для реального номера клиента возвращается корректный внутренний extension; дополнительно протестировать originate через `/uon/webhook` с `method=call`.


