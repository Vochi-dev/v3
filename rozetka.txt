==============================
–û–ë–ó–û–† –°–ï–†–í–ò–°–û–í reboot.py –∏ ewelink_api.py (–û–ë–ù–û–í–õ–ï–ù–û 2025-07-27)
==============================

1. –û–ë–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê
--------------------
- reboot.py: —Å–µ—Ä–≤–∏—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ö–æ—Å—Ç–æ–≤ (Asterisk), –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ eWeLink-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –ë–î.
- ewelink_api.py: FastAPI-—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è eWeLink-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ —á–µ—Ä–µ–∑ HTTP API, —Å –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ú –û–ë–ù–û–í–õ–ï–ù–ò–ï–ú –¢–û–ö–ï–ù–û–í.

2. –õ–û–ì–ò –ò –û–¢–õ–ê–î–ö–ê
------------------
- reboot.py –ø–∏—à–µ—Ç –ª–æ–≥–∏ –≤ reboot_service.log
- ewelink_api.py –ø–∏—à–µ—Ç –ª–æ–≥–∏ –≤ ewelink_service.log
- –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –ø–∏—à–µ—Ç –ª–æ–≥–∏ –≤ token_refresh.log

3. –ê–í–¢–û–ú–ê–¢–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –¢–û–ö–ï–ù–û–í
-------------------------------------
‚úÖ –°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–ê–ï–¢ –ü–û–õ–ù–û–°–¢–¨–Æ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò!

üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
- –ö–∞–∂–¥—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç access_token —á–µ—Ä–µ–∑ refresh_token
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–∞–∂–¥—ã–µ 3 –¥–Ω—è —á–µ—Ä–µ–∑ cron (6:00 —É—Ç—Ä–∞)
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –ë–ï–ó –≤–∞—à–µ–≥–æ —É—á–∞—Å—Ç–∏—è

üìÖ –†—É—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω—É–∂–Ω–∞ –¢–û–õ–¨–ö–û:
- –†–∞–∑ –≤ 3-6 –º–µ—Å—è—Ü–µ–≤ (–∫–æ–≥–¥–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç refresh_token)
- –ü—Ä–∏ —Å–±–æ—è—Ö –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ eWeLink
- –ü–æ—Å–ª–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—è —Å–∏—Å—Ç–µ–º—ã

4. –ö–ê–ö –ü–û–ù–Ø–¢–¨, –ß–¢–û –ù–£–ñ–ù–ê –†–£–ß–ù–ê–Ø –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
--------------------------------------------
üö® –ü—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–µ–Ω–∞–º–∏:
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ eWeLink –Ω–µ –æ—Ç–≤–µ—á–∞—é—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
- –í ewelink_service.log –æ—à–∏–±–∫–∏: "401: cannot found access token info"
- API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:
- curl -s http://localhost:8010/devices | head -5
  (–ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - —Ç–æ–∫–µ–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç)

5. –ü–†–û–¶–ï–î–£–†–ê –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø –¢–û–ö–ï–ù–û–í (–ü–†–û–°–¢–ê–Ø!)
----------------------------------------------
üéØ –í–°–Å –í –û–î–ù–£ –ö–û–ú–ê–ù–î–£:

1Ô∏è‚É£ –ì–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ OAuth —Å—Å—ã–ª–∫—É:
   python3 -c "from ewelink_devices import EWeLinkDevices; EWeLinkDevices().generate_oauth_url()"

2Ô∏è‚É£ –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏–∑ –≤—ã–≤–æ–¥–∞ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

3Ô∏è‚É£ –ü—Ä–æ–π–¥–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ eWeLink

4Ô∏è‚É£ –í–°–Å! –¢–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò —á–µ—Ä–µ–∑ endpoint /ewelink-callback/

‚ùå –ù–ï –ù–£–ñ–ù–û –ë–û–õ–¨–®–ï:
- –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å code –≤—Ä—É—á–Ω—É—é
- –í—Å—Ç–∞–≤–ª—è—Ç—å code —á–µ—Ä–µ–∑ API
- –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã
- –î–µ–ª–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

6. –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø –í –î–ï–¢–ê–õ–Ø–•
--------------------------
üîß –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- Cron –∑–∞–¥–∞—á–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∫–∞–∂–¥—ã–µ 3 –¥–Ω—è –≤ 6:00
- Endpoint: https://bot.vochi.by/ewelink-callback/ –¥–ª—è –∞–≤—Ç–æ–ø—Ä–∏–µ–º–∞ —Ç–æ–∫–µ–Ω–æ–≤
- –°–∫—Ä–∏–ø—Ç: refresh_ewelink_tokens.py –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –°–∏—Å—Ç–µ–º–∞: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞

üìÅ –§–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã:
- ewelink_token.json - —Ç–µ–∫—É—â–∏–µ —Ç–æ–∫–µ–Ω—ã
- refresh_ewelink_tokens.py - —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è  
- token_refresh.log - –ª–æ–≥–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- cron_refresh.log - –ª–æ–≥–∏ cron –∑–∞–¥–∞—á–∏

7. unit_live_status ‚Äî –†–ê–°–®–ò–§–†–û–í–ö–ê –ü–û–õ–ï–ô
---------------------------------------
- enterprise_number (text, PK) ‚Äî –Ω–æ–º–µ—Ä –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è (—Å—Å—ã–ª–∫–∞ –Ω–∞ enterprises.number)
- last_status (text) ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å ('online'/'offline')
- last_checked_at (timestamp) ‚Äî –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
- failure_counter (int) ‚Äî —á–∏—Å–ª–æ –ø–æ–¥—Ä—è–¥ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏)
- last_error_message (text) ‚Äî –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
- disk_usage_percent (int) ‚Äî –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –¥–∏—Å–∫–∞ (%)
- line_stats (jsonb) ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ª–∏–Ω–∏—è–º (—Å–º. parse_sip_peers)
- sip_peers (int) ‚Äî —á–∏—Å–ª–æ SIP peers
- ewelink_action_done (bool) ‚Äî –±—ã–ª–∞ –ª–∏ —É–∂–µ –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ eWeLink (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å)

8. unit_status_history ‚Äî –†–ê–°–®–ò–§–†–û–í–ö–ê –ü–û–õ–ï–ô
------------------------------------------
- id (int, PK) ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
- enterprise_number (text, FK) ‚Äî –Ω–æ–º–µ—Ä –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
- prev_status (text) ‚Äî –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å—Ç–∞—Ç—É—Å ('on'/'off')
- new_status (text) ‚Äî –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å ('on'/'off')
- change_time (timestamp) ‚Äî –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è
- failure_counter (int) ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –Ω–µ—É–¥–∞—á –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–æ–±—ã—Ç–∏—è
- error_message (text) ‚Äî —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ –±—ã–ª–∞)
- action_type (text) ‚Äî —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'ewelink_toggle', 'ewelink_toggle_off', 'ewelink_toggle_on')
- action_result (text) ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç ('success'/'fail')
- action_time (timestamp) ‚Äî –≤—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è (–º–æ–∂–µ—Ç –Ω–µ –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è)
- user_initiator (text) ‚Äî –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä ('api', 'auto', 'user')
- extra_info (jsonb) ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, {"device_id": ..., "state": true/false})

9. –ö–†–ê–¢–ö–û –û –õ–û–ì–ò–ö–ï
------------------
- reboot.py –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ö–æ—Å—Ç—ã, –ø–∏—à–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –≤ unit_live_status, –ø—Ä–∏ 3 –æ—Ñ—Ñ–ª–∞–π–Ω–∞—Ö –∏ parameter_option_2=true –≤—ã–∑—ã–≤–∞–µ—Ç reboot_ewelink_device.
- reboot_ewelink_device –≤—ã–∑—ã–≤–∞–µ—Ç ewelink_api.py (POST /toggle), –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º –∏ –ø–∏—à–µ—Ç –∞—É–¥–∏—Ç –≤ unit_status_history.
- –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ .log-—Ñ–∞–π–ª—ã.
- –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã eWeLink –±–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

10. –ß–¢–û –î–ï–õ–ê–¢–¨ –ü–†–ò –ü–†–û–ë–õ–ï–ú–ê–•
----------------------------
üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É API: curl -s http://localhost:8010/devices | head -5
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: tail -20 ewelink_service.log | grep -E "(ERROR|401|403)"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cron: crontab -l | grep refresh_ewelink_tokens
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω—ã: cat ewelink_token.json | jq .expires_at

üö® –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Ç–æ–∫–µ–Ω–∞–º–∏:
1. –í—ã–ø–æ–ª–Ω–∏—Ç—å: python3 -c "from ewelink_devices import EWeLinkDevices; EWeLinkDevices().generate_oauth_url()"
2. –ü—Ä–æ–π—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –≤—ã–≤–æ–¥–∞
3. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã

üîß –ü—Ä–∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö:
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã: ./all.sh restart && ./reboot.sh restart && ./ewelink.sh restart
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ª–æ–≥–∏

11. –ß–ê–°–¢–û–¢–ê –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–Ø
-----------------------
üìÖ –û–±—ã—á–Ω–æ: —Ä—É—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–∑ –≤ 3-6 –º–µ—Å—è—Ü–µ–≤
ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∫–∞–∂–¥—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤  
üîÑ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: –ø—Ä–æ–≤–µ—Ä–∫–∞ cron –∫–∞–∂–¥—ã–µ 3 –¥–Ω—è
‚ö° –°–±–æ–∏: –∫—Ä–∞–π–Ω–µ —Ä–µ–¥–∫–æ, –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö eWeLink

–ò–¢–û–ì: –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω–æ! üéØ

-- EOF -- 