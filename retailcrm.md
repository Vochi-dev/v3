# 📞 **ИНТЕГРАЦИЯ СИСТЕМЫ ТЕЛЕФОНИИ С RETAILCRM**

**Версия:** 1.0  
**Дата создания:** 03.08.2025  
**Статус:** Планирование  

---

## 🎯 **ЦЕЛЬ ПРОЕКТА**

Интегрировать существующую систему телефонии `asterisk-webhook` с [RetailCRM](https://docs.retailcrm.ru/Developers/API) для автоматизации работы с клиентами и повышения эффективности продаж.

---

## 🔍 **АНАЛИЗ ВОЗМОЖНОСТЕЙ RETAILCRM**

### 📚 **Документация:**
- **API v5:** [https://docs.retailcrm.ru/Developers/API](https://docs.retailcrm.ru/Developers/API)
- **Справочник методов:** Доступны методы для работы с заказами, клиентами, звонками
- **Интеграции:** Поддержка webhook'ов и внешних API
- **Телефония:** Встроенная поддержка интеграции с АТС

### 🏗️ **Архитектура интеграции:**
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   RetailCRM     │◄──►│  asterisk.py     │◄──►│   Asterisk      │
│   (webhook)     │    │  (API Bridge)    │    │   Hosts         │
└─────────────────┘    └──────────────────┘    └─────────────────┘
        │                        │                       │
        ▼                        ▼                       ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Клиенты/Лиды   │    │   PostgreSQL     │    │ Записи звонков  │
│  Заказы/Сделки  │    │   (Единая БД)    │    │ Статистика      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

---

## 🚀 **ЭТАПЫ РЕАЛИЗАЦИИ**

### 📋 **ЭТАП 1: ПОДГОТОВКА (1-2 дня)**

#### ✅ **1.1 Изучение RetailCRM API**
- [ ] Создать тестовый аккаунт RetailCRM
- [ ] Получить API ключ для интеграции
- [ ] Изучить методы API для работы с:
  - Клиентами (`/api/v5/customers`)
  - Заказами (`/api/v5/orders`)
  - Звонками (`/api/v5/telephony`)
- [ ] Протестировать базовые запросы через Postman/curl

#### ✅ **1.2 Анализ существующей системы**
**У нас уже есть:**
- ✅ `asterisk.py` - API для управления звонками (порт 8018)
- ✅ PostgreSQL с данными предприятий и пользователей
- ✅ API endpoints: `/api/makecallexternal`, `/api/monitor`, `/api/transfer`
- ✅ Система аутентификации через `clientId`

**Потребуется доработка:**
- [ ] Webhook endpoint для приема событий от RetailCRM
- [ ] Методы синхронизации данных между системами
- [ ] Логика создания клиентов/лидов при новых звонках

---

### 🔧 **ЭТАП 2: РАЗРАБОТКА ИНТЕГРАЦИИ (3-5 дней)**

#### ✅ **2.1 Создание RetailCRM Service**
```python
# retailcrm_service.py
class RetailCRMService:
    def __init__(self, api_url, api_key):
        self.api_url = api_url
        self.api_key = api_key
    
    async def create_customer(self, phone, name=None):
        """Создание клиента в RetailCRM"""
        
    async def create_order(self, customer_id, products=None):
        """Создание заказа"""
        
    async def log_call(self, phone, duration, call_type):
        """Логирование звонка"""
        
    async def search_customer_by_phone(self, phone):
        """Поиск клиента по номеру телефона"""
```

#### ✅ **2.2 Расширение asterisk.py**
```python
# Добавить в asterisk.py
@app.post("/retailcrm/webhook")
async def handle_retailcrm_webhook(request):
    """Обработка webhook'ов от RetailCRM"""
    
@app.get("/api/makecallexternal")
async def make_call_with_crm_integration(code, phone, clientId):
    """Инициация звонка с интеграцией в CRM"""
    # 1. Проверить clientId
    # 2. Найти клиента в RetailCRM по телефону
    # 3. Инициировать звонок через SSH
    # 4. Логировать звонок в RetailCRM
```

#### ✅ **2.3 Webhook обработчики**
```python
# События для обработки:
WEBHOOK_EVENTS = [
    "call.incoming",      # Входящий звонок
    "call.outgoing",      # Исходящий звонок
    "call.answered",      # Звонок отвечен
    "call.finished",      # Звонок завершен
    "call.missed",        # Пропущенный звонок
]
```

---

### 📊 **ЭТАП 3: ФУНКЦИОНАЛ ИНТЕГРАЦИИ (2-3 дня)**

#### ✅ **3.1 Автоматическое создание клиентов**
- [ ] При входящем звонке от нового номера → создать клиента в RetailCRM
- [ ] При исходящем звонке на новый номер → создать клиента
- [ ] Сохранить связь между номером телефона и ID клиента в RetailCRM

#### ✅ **3.2 Логирование звонков**
```json
// Пример данных звонка для RetailCRM
{
  "phone": "+375296254070",
  "type": "outgoing",
  "status": "completed",
  "duration": 120,
  "date": "2025-08-03 14:30:00",
  "employee": "manager@company.com",
  "customer": 12345,
  "recording": "https://bot.vochi.by/recordings/call_123.mp3"
}
```

#### ✅ **3.3 Интеграция с интерфейсом**
- [ ] Click-to-call из карточки клиента в RetailCRM
- [ ] Всплывающие уведомления о звонках
- [ ] Автоматическое открытие карточки клиента при входящем звонке

---

### 🔗 **ЭТАП 4: WEBHOOK СИСТЕМА (1-2 дня)**

#### ✅ **4.1 Настройка в RetailCRM**
```json
// Webhook URL для отправки в RetailCRM
{
  "url": "https://bot.vochi.by/retailcrm/webhook",
  "events": [
    "customer.create",
    "customer.edit", 
    "order.create",
    "order.edit"
  ]
}
```

#### ✅ **4.2 Обработка событий**
- [ ] Синхронизация данных клиентов
- [ ] Обновление информации о заказах
- [ ] Триггеры для автоматических действий

---

## 📋 **ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ**

### 🔧 **Новые компоненты:**

#### **1. RetailCRM Service (retailcrm.py)**
```bash
# Порт: 8019
# Функции:
# - API клиент для RetailCRM
# - Webhook обработчик
# - Синхронизация данных
```

#### **2. Расширение asterisk.py**
```python
# Добавить функции:
# - Интеграция с RetailCRM при звонках
# - Автоматическое создание клиентов
# - Логирование звонков в CRM
```

#### **3. База данных**
```sql
-- Новая таблица для связи с RetailCRM
CREATE TABLE retailcrm_customers (
    id SERIAL PRIMARY KEY,
    phone VARCHAR(20) NOT NULL,
    retailcrm_customer_id INTEGER,
    enterprise_number VARCHAR(10),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### **4. Конфигурация**
```python
# retailcrm_config.py
RETAILCRM_CONFIG = {
    "api_url": "https://your-store.retailcrm.ru/api/v5",
    "api_key": "your-api-key",
    "webhook_secret": "webhook-secret-key"
}
```

---

## 📈 **ОЖИДАЕМЫЕ РЕЗУЛЬТАТЫ**

### ✅ **Автоматизация процессов:**
- 🎯 **Автоматическое создание клиентов** при новых звонках
- 📞 **Логирование всех звонков** в единой CRM системе
- 🔄 **Синхронизация данных** между телефонией и CRM
- 📊 **Единая аналитика** по звонкам и продажам

### ✅ **Улучшение UX:**
- 🖱️ **Click-to-call** из интерфейса RetailCRM
- 🔔 **Всплывающие уведомления** о звонках
- 📋 **Автоматическое открытие карточек** клиентов
- 🎵 **Записи разговоров** доступные в CRM

### ✅ **Аналитика:**
- 📈 **Статистика звонков** по менеджерам
- 💰 **Конверсия звонков в продажи**
- ⏱️ **Время обработки клиентов**
- 📊 **Отчеты по эффективности**

---

## 🛠️ **ПЛАН РАЗРАБОТКИ**

### **Неделя 1: Базовая интеграция**
- День 1-2: Изучение RetailCRM API, создание тестового аккаунта
- День 3-4: Создание `retailcrm_service.py`
- День 5: Тестирование базовых функций API

### **Неделя 2: Интеграция со звонками**  
- День 1-2: Расширение `asterisk.py` для работы с RetailCRM
- День 3-4: Реализация автоматического создания клиентов
- День 5: Тестирование полного цикла звонков

### **Неделя 3: Webhook система**
- День 1-2: Настройка webhook'ов в RetailCRM
- День 3-4: Обработка событий от CRM
- День 5: Интеграционное тестирование

### **Неделя 4: Финализация**
- День 1-2: Добавление в `all.sh` и мониторинг
- День 3-4: Документация и инструкции
- День 5: Продуктивное развертывание

---

## 🔐 **БЕЗОПАСНОСТЬ**

### ✅ **Аутентификация:**
- [ ] API ключи RetailCRM в защищенной конфигурации
- [ ] Валидация webhook secret для защиты от подделки
- [ ] Проверка `clientId` для всех запросов

### ✅ **Данные:**
- [ ] Шифрование чувствительных данных
- [ ] Логирование всех действий для аудита
- [ ] Резервное копирование интеграционных данных

---

## 📚 **ПОЛЕЗНЫЕ ССЫЛКИ**

### 🔗 **RetailCRM:**
- [Документация API v5](https://docs.retailcrm.ru/Developers/API)
- [Справочник методов](https://docs.retailcrm.ru/Developers/API/ApiVersions/Version5)
- [Примеры интеграций](https://docs.retailcrm.ru/Developers/Integration)

### 🔗 **Наша система:**
- [asterisk.md](./asterisk.md) - Документация Asterisk сервиса
- [auth_telegram.md](./auth_telegram.md) - Система авторизации
- PostgreSQL база: `enterprises`, `users` таблицы

---

## 📝 **ИСТОРИЯ ИЗМЕНЕНИЙ**

| Версия | Дата       | Изменения                                |
|--------|------------|------------------------------------------|
| 1.0    | 03.08.2025 | Первоначальный анализ и план интеграции |

---

## 🎯 **СЛЕДУЮЩИЕ ШАГИ**

1. **Создать тестовый аккаунт RetailCRM** и получить API ключи
2. **Протестировать API методы** через Postman 
3. **Создать `retailcrm_service.py`** с базовым функционалом
4. **Интегрировать с `asterisk.py`** для обработки звонков
5. **Настроить webhook'и** для двусторонней синхронизации

---

*Этот документ будет обновляться по мере развития проекта интеграции.*