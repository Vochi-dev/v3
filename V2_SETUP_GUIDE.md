# 🚀 Руководство по V2 логике обработки событий Asterisk

## 📋 **Обзор**

Согласно правилам из `CallsManual/Пояснение.txt`, была реализована новая архитектура V2, которая обеспечивает **реал-тайм мониторинг** с умным управлением сообщениями:

> **"Каждое следующее событие уничтожает предыдущее"**

## 🔄 **Различия между старой и новой логикой**

### ❌ **Старая логика (V1)**
- **START** → Отправляет сообщение в Telegram ✅
- **DIAL** → Отправляет сообщение в Telegram ✅
- **BRIDGE** → Отправляет сообщение в Telegram ✅
- **HANGUP** → Отправляет сообщение в Telegram ✅

**Проблема:** Накапливается много сообщений в чате, сложно отследить текущий статус

### ✅ **Новая логика (V2)**
- **START** → Отправляет в Telegram ✅
- **DIAL** → Отправляет в Telegram ✅ + УДАЛЯЕТ START сообщение 🗑️
- **BRIDGE** → Отправляет в Telegram ✅ + УДАЛЯЕТ DIAL сообщение 🗑️
- **HANGUP** → Отправляет в Telegram ✅ + УДАЛЯЕТ BRIDGE сообщение 🗑️

**Преимущества:** 
- 🔴 **Реал-тайм мониторинг** - видны все события в реальном времени
- 🧹 **Чистые чаты** - предыдущие события автоматически удаляются
- 📱 **Актуальная информация** - в чате всегда только текущий статус звонка

## ⚙️ **Переключение между логиками**

### 🔧 **В файле `main.py`:**

```python
# ────────────────────────────────────────────────────────────────────────────────
# КОНФИГУРАЦИЯ ВЕРСИИ ОБРАБОТЧИКОВ
# ────────────────────────────────────────────────────────────────────────────────
USE_V2_HANDLERS = True   # ✅ Новая V2 логика (реал-тайм + автоудаление)
USE_V2_HANDLERS = False  # ❌ Старая логика (все события накапливаются)
```

### 🔄 **Применение изменений:**

```bash
# Перезапуск сервисов (обязательно!)
./all.sh restart
```

## 📱 **Шаблоны V2 сообщений**

### 📞 **START - Начало звонка:**
```
📞 Исходящий звонок
☎️152 → 💰+375 29 625-40-70
🕐 20:17:44
```

### 🔄 **DIAL - Набор номера:**
```
📱 Набор номера
☎️152 → 💰+375 29 625-40-70
Линия: 0001363
🕐 20:17:44
```

### ☎️ **BRIDGE - Соединение:**
```
☎️152 📞➡️ 💰+375 29 625-40-70📞
Линия: 0001363
👤 Иванов Иван (если найден менеджер)
🕐 20:17:58
```

### ✅ **HANGUP - Завершение (успешный):**
```
✅Успешный исходящий звонок
☎️152
💰+375 29 625-40-70
Линия: 0001363
Звонил: 4 раз
Последний раз: 09.07.2025 в 20:17
⏰Начало звонка 20:17
⌛ Длительность: 01:32
🔉Запись разговора
```

### ❌ **HANGUP - Завершение (неуспешный):**
```
❌Неуспешный исходящий звонок
☎️152
💰+375 29 555-33-22  
Линия: 0001363
Звонил: 8 раз
Последний раз: 09.07.2025 в 20:17
⏰Начало звонка 20:17
⌛ Длительность: 00:00
```

## 🏗️ **Архитектура V2**

### 📁 **Файлы обработчиков:**

- `app/services/calls/start_v2.py` - START события (Telegram + БД)
- `app/services/calls/dial_v2.py` - DIAL события (Telegram + БД + удаление START) 
- `app/services/calls/bridge_v2.py` - BRIDGE события (Telegram + БД + удаление DIAL)
- `app/services/calls/hangup_v2.py` - HANGUP события (Telegram + БД + удаление BRIDGE)

### 🛣️ **Эндпоинты:**

#### Основные (используются Asterisk):
- `POST /start` → Переключается через `USE_V2_HANDLERS`
- `POST /dial` → Переключается через `USE_V2_HANDLERS`
- `POST /bridge` → Переключается через `USE_V2_HANDLERS` 
- `POST /hangup` → Переключается через `USE_V2_HANDLERS`

#### Тестовые (для отладки):
- `POST /v2/start` → Всегда V2 логика
- `POST /v2/dial` → Всегда V2 логика
- `POST /v2/bridge` → Всегда V2 логика
- `POST /v2/hangup` → Всегда V2 логика

## 🔧 **Техническая реализация**

### 💾 **In-Memory хранение message_id:**
```python
# В app/services/calls/utils.py
v2_messages = {
    "unique_id_123": {
        "chat_id": 374573193,
        "message_id": 12345,
        "event_type": "dial"
    }
}
```

### 🛡️ **HTML экранирование:**
- Поля типа `"<unknown>"` безопасно экранируются
- Предотвращает ошибки Telegram API
- Функция `escape_html()` в `utils.py`

### 🗑️ **Логика удаления:**
1. **DIAL** → удаляет message_id START для того же unique_id
2. **BRIDGE** → удаляет message_id DIAL для того же unique_id  
3. **HANGUP** → удаляет message_id BRIDGE для того же unique_id

## 🌐 **Nginx маршрутизация (ИСПРАВЛЕНО)**

### ⚠️ **Была проблема:**
```nginx
location /dial/ {  # со слешем
    proxy_pass http://127.0.0.1:8005/;  # React UI
}
```
**DIAL webhook попадал на React приложение вместо API!**

### ✅ **Исправлено:**
```nginx
# Webhook события Asterisk → API (порт 8000)
location ~ ^/(start|dial|bridge|hangup)$ {
    proxy_pass http://127.0.0.1:8000;
}

# React UI управления схемами → frontend (порт 8005)  
location /dial/ {
    proxy_pass http://127.0.0.1:8005/;
}
```

## 🧪 **Тестирование полной цепочки**

### 📋 **Сценарий тестирования:**
1. Отправить START → увидеть сообщение в Telegram
2. Отправить DIAL → START сообщение удалится, появится DIAL
3. Отправить BRIDGE → DIAL сообщение удалится, появится BRIDGE  
4. Отправить HANGUP → BRIDGE сообщение удалится, появится финальное HANGUP

### ✅ **Тест START:**
```bash
curl -X POST http://localhost:8000/start -H "Content-Type: application/json" -d '{
  "Phone": "+375296254070",
  "UniqueId": "TEST-V2-123",
  "Token": "375293332255",
  "CallType": 1,
  "Trunk": "0001363"
}'

# Ожидаемый результат в Telegram:
# 📞 Исходящий звонок
# ☎️152 → 💰+375 29 625-40-70
# 🕐 [время]
```

### ✅ **Тест DIAL (удаляет START):**
```bash
curl -X POST http://localhost:8000/dial -H "Content-Type: application/json" -d '{
  "Phone": "375296254070",
  "Extensions": ["152"],  
  "UniqueId": "TEST-V2-123",
  "Token": "375293332255",
  "CallType": 1,
  "Trunk": "0001363"
}'

# Ожидаемый результат:
# START сообщение удалено ❌
# Новое DIAL сообщение появилось ✅
```

### ✅ **Тест BRIDGE (удаляет DIAL):**
```bash
curl -X POST http://localhost:8000/bridge -H "Content-Type: application/json" -d '{
  "UniqueId": "TEST-V2-123",
  "Token": "375293332255",
  "CallerIDNum": "152",
  "ConnectedLineNum": "375296254070",
  "BridgeUniqueid": "test-bridge-id"
}'

# Ожидаемый результат:
# DIAL сообщение удалено ❌  
# Новое BRIDGE сообщение появилось ✅
```

### ✅ **Тест HANGUP (удаляет BRIDGE):**
```bash
curl -X POST http://localhost:8000/hangup -H "Content-Type: application/json" -d '{
  "Phone": "375296254070",
  "Extensions": ["152"],
  "CallStatus": "2", 
  "UniqueId": "TEST-V2-123",
  "Token": "375293332255",
  "CallType": 1,
  "Trunk": "0001363",
  "StartTime": "2025-07-09 20:17:43",
  "EndTime": "2025-07-09 20:18:02"
}'

# Ожидаемый результат:
# BRIDGE сообщение удалено ❌
# Финальное HANGUP сообщение появилось ✅
```

## 🔍 **Диагностика проблем**

### 🚨 **DIAL возвращает HTML:**
```html
<!doctype html>...Vochi Dial...
```
**Причина:** Неправильная маршрутизация nginx  
**Решение:** Проверить конфигурацию `/etc/nginx/sites-available/bot.vochi.by`

### 🚨 **Ошибка `<unknown>` в Telegram:**
```
"Can't parse entities: unsupported start tag \"unknown\""
```
**Причина:** Поля от Asterisk не экранированы  
**Решение:** HTML экранирование уже добавлено в V2 обработчики

### 🚨 **Сообщения не удаляются:**
```python
# Проверить в логах:
"Deleted X previous messages for unique_id"
```
**Причина:** Потеря message_id в памяти при перезапуске  
**Решение:** Это нормально, in-memory хранение очищается при рестарте

## 📈 **Преимущества V2**

1. 🔴 **Реал-тайм мониторинг** - видны все этапы звонка
2. 🧹 **Автоматическая очистка** - старые сообщения удаляются
3. 📱 **Актуальная информация** - в чате только текущий статус
4. 🛡️ **Безопасность** - экранирование HTML символов  
5. 🔧 **Простое переключение** - между V1 и V2 логикой
6. 🎯 **Правильная маршрутизация** - исправлены проблемы nginx

## 🛠️ **Настройка**

### 1. **Включить V2 логику:**
```python
# main.py
USE_V2_HANDLERS = True
```

### 2. **Проверить nginx маршрутизацию:**
```bash
# Должно быть в /etc/nginx/sites-available/bot.vochi.by:
location ~ ^/(start|dial|bridge|hangup)$ {
    proxy_pass http://127.0.0.1:8000;
}
```

### 3. **Перезапустить сервисы:**
```bash
./all.sh restart
systemctl reload nginx
```

### 4. **Проверить в логах:**
```bash
# Для всех событий должно быть:
tail -f logs/app.log | grep -E "(START|DIAL|BRIDGE|HANGUP)"

# Для DELETE операций:
tail -f logs/app.log | grep "Deleted.*previous messages"
```

## 🎯 **Проверка готовности системы**

### ✅ **Чек-лист:**
- [ ] `USE_V2_HANDLERS = True` в `main.py`
- [ ] Nginx правильно маршрутизирует webhook события на порт 8000
- [ ] Все сервисы перезапущены через `./all.sh restart`
- [ ] В логах видны корректные обработки событий
- [ ] Тестовый звонок показывает правильную цепочку сообщений

### 📊 **Ожидаемое поведение:**
1. **START** → Сообщение появляется в Telegram
2. **DIAL** → START удаляется, DIAL появляется  
3. **BRIDGE** → DIAL удаляется, BRIDGE появляется
4. **HANGUP** → BRIDGE удаляется, финальное HANGUP появляется

## 🔚 **Заключение**

V2 логика обеспечивает оптимальный баланс между:
- **Полным мониторингом** всех этапов звонка в реальном времени
- **Чистотой чатов** через автоматическое удаление промежуточных сообщений  
- **Богатой финальной информацией** в HANGUP сообщениях

**Результат:** Пользователь видит все события, но чат остается чистым! 🚀 