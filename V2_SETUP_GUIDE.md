# ๐ ะัะบะพะฒะพะดััะฒะพ ะฟะพ V2 ะปะพะณะธะบะต ะพะฑัะฐะฑะพัะบะธ ัะพะฑััะธะน Asterisk

## ๐ **ะะฑะทะพั**

ะกะพะณะปะฐัะฝะพ ะฟัะฐะฒะธะปะฐะผ ะธะท `CallsManual/ะะพััะฝะตะฝะธะต.txt`, ะฑัะปะฐ ัะตะฐะปะธะทะพะฒะฐะฝะฐ ะฝะพะฒะฐั ะฐััะธัะตะบัััะฐ V2, ะบะพัะพัะฐั ะพะฑะตัะฟะตัะธะฒะฐะตั **ัะตะฐะป-ัะฐะนะผ ะผะพะฝะธัะพัะธะฝะณ** ั ัะผะฝัะผ ัะฟัะฐะฒะปะตะฝะธะตะผ ัะพะพะฑัะตะฝะธัะผะธ:

> **"ะะฐะถะดะพะต ัะปะตะดัััะตะต ัะพะฑััะธะต ัะฝะธััะพะถะฐะตั ะฟัะตะดัะดััะตะต"**

## ๐ **ะะฐะทะปะธัะธั ะผะตะถะดั ััะฐัะพะน ะธ ะฝะพะฒะพะน ะปะพะณะธะบะพะน**

### โ **ะกัะฐัะฐั ะปะพะณะธะบะฐ (V1)**
- **START** โ ะัะฟัะฐะฒะปัะตั ัะพะพะฑัะตะฝะธะต ะฒ Telegram โ
- **DIAL** โ ะัะฟัะฐะฒะปัะตั ัะพะพะฑัะตะฝะธะต ะฒ Telegram โ
- **BRIDGE** โ ะัะฟัะฐะฒะปัะตั ัะพะพะฑัะตะฝะธะต ะฒ Telegram โ
- **HANGUP** โ ะัะฟัะฐะฒะปัะตั ัะพะพะฑัะตะฝะธะต ะฒ Telegram โ

**ะัะพะฑะปะตะผะฐ:** ะะฐะบะฐะฟะปะธะฒะฐะตััั ะผะฝะพะณะพ ัะพะพะฑัะตะฝะธะน ะฒ ัะฐัะต, ัะปะพะถะฝะพ ะพััะปะตะดะธัั ัะตะบััะธะน ััะฐััั

### โ **ะะพะฒะฐั ะปะพะณะธะบะฐ (V2)**
- **START** โ ะัะฟัะฐะฒะปัะตั ะฒ Telegram โ
- **DIAL** โ ะัะฟัะฐะฒะปัะตั ะฒ Telegram โ + ะฃะะะะฏะะข START ัะพะพะฑัะตะฝะธะต ๐๏ธ
- **BRIDGE** โ ะัะฟัะฐะฒะปัะตั ะฒ Telegram โ + ะฃะะะะฏะะข DIAL ัะพะพะฑัะตะฝะธะต ๐๏ธ
- **HANGUP** โ ะัะฟัะฐะฒะปัะตั ะฒ Telegram โ + ะฃะะะะฏะะข BRIDGE ัะพะพะฑัะตะฝะธะต ๐๏ธ

**ะัะตะธะผััะตััะฒะฐ:** 
- ๐ด **ะะตะฐะป-ัะฐะนะผ ะผะพะฝะธัะพัะธะฝะณ** - ะฒะธะดะฝั ะฒัะต ัะพะฑััะธั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- ๐งน **ะงะธัััะต ัะฐัั** - ะฟัะตะดัะดััะธะต ัะพะฑััะธั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะดะฐะปััััั
- ๐ฑ **ะะบััะฐะปัะฝะฐั ะธะฝัะพัะผะฐัะธั** - ะฒ ัะฐัะต ะฒัะตะณะดะฐ ัะพะปัะบะพ ัะตะบััะธะน ััะฐััั ะทะฒะพะฝะบะฐ

## โ๏ธ **ะะตัะตะบะปััะตะฝะธะต ะผะตะถะดั ะปะพะณะธะบะฐะผะธ**

### ๐ง **ะ ัะฐะนะปะต `main.py`:**

```python
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ะะะะคะะะฃะะะฆะะฏ ะะะะกะะ ะะะะะะะขะงะะะะ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
USE_V2_HANDLERS = True   # โ ะะพะฒะฐั V2 ะปะพะณะธะบะฐ (ัะตะฐะป-ัะฐะนะผ + ะฐะฒัะพัะดะฐะปะตะฝะธะต)
USE_V2_HANDLERS = False  # โ ะกัะฐัะฐั ะปะพะณะธะบะฐ (ะฒัะต ัะพะฑััะธั ะฝะฐะบะฐะฟะปะธะฒะฐัััั)
```

### ๐ **ะัะธะผะตะฝะตะฝะธะต ะธะทะผะตะฝะตะฝะธะน:**

```bash
# ะะตัะตะทะฐะฟััะบ ัะตัะฒะธัะพะฒ (ะพะฑัะทะฐัะตะปัะฝะพ!)
./all.sh restart
```

## ๐ฑ **ะจะฐะฑะปะพะฝั V2 ัะพะพะฑัะตะฝะธะน**

### ๐ **START - ะะฐัะฐะปะพ ะทะฒะพะฝะบะฐ:**
```
๐ ะััะพะดััะธะน ะทะฒะพะฝะพะบ
โ๏ธ152 โ ๐ฐ+375 29 625-40-70
๐ 20:17:44
```

### ๐ **DIAL - ะะฐะฑะพั ะฝะพะผะตัะฐ:**
```
๐ฑ ะะฐะฑะพั ะฝะพะผะตัะฐ
โ๏ธ152 โ ๐ฐ+375 29 625-40-70
ะะธะฝะธั: 0001363
๐ 20:17:44
```

### โ๏ธ **BRIDGE - ะกะพะตะดะธะฝะตะฝะธะต:**
```
โ๏ธ152 ๐โก๏ธ ๐ฐ+375 29 625-40-70๐
ะะธะฝะธั: 0001363
๐ค ะะฒะฐะฝะพะฒ ะะฒะฐะฝ (ะตัะปะธ ะฝะฐะนะดะตะฝ ะผะตะฝะตะดะถะตั)
๐ 20:17:58
```

### โ **HANGUP - ะะฐะฒะตััะตะฝะธะต (ััะฟะตัะฝัะน):**
```
โะฃัะฟะตัะฝัะน ะธััะพะดััะธะน ะทะฒะพะฝะพะบ
โ๏ธ152
๐ฐ+375 29 625-40-70
ะะธะฝะธั: 0001363
ะะฒะพะฝะธะป: 4 ัะฐะท
ะะพัะปะตะดะฝะธะน ัะฐะท: 09.07.2025 ะฒ 20:17
โฐะะฐัะฐะปะพ ะทะฒะพะฝะบะฐ 20:17
โ ะะปะธัะตะปัะฝะพััั: 01:32
๐ะะฐะฟะธัั ัะฐะทะณะพะฒะพัะฐ
```

### โ **HANGUP - ะะฐะฒะตััะตะฝะธะต (ะฝะตััะฟะตัะฝัะน):**
```
โะะตััะฟะตัะฝัะน ะธััะพะดััะธะน ะทะฒะพะฝะพะบ
โ๏ธ152
๐ฐ+375 29 555-33-22  
ะะธะฝะธั: 0001363
ะะฒะพะฝะธะป: 8 ัะฐะท
ะะพัะปะตะดะฝะธะน ัะฐะท: 09.07.2025 ะฒ 20:17
โฐะะฐัะฐะปะพ ะทะฒะพะฝะบะฐ 20:17
โ ะะปะธัะตะปัะฝะพััั: 00:00
```

## ๐๏ธ **ะััะธัะตะบัััะฐ V2**

### ๐ **ะคะฐะนะปั ะพะฑัะฐะฑะพััะธะบะพะฒ:**

- `app/services/calls/start_v2.py` - START ัะพะฑััะธั (Telegram + ะะ)
- `app/services/calls/dial_v2.py` - DIAL ัะพะฑััะธั (Telegram + ะะ + ัะดะฐะปะตะฝะธะต START) 
- `app/services/calls/bridge_v2.py` - BRIDGE ัะพะฑััะธั (Telegram + ะะ + ัะดะฐะปะตะฝะธะต DIAL)
- `app/services/calls/hangup_v2.py` - HANGUP ัะพะฑััะธั (Telegram + ะะ + ัะดะฐะปะตะฝะธะต BRIDGE)

### ๐ฃ๏ธ **ะญะฝะดะฟะพะธะฝัั:**

#### ะัะฝะพะฒะฝัะต (ะธัะฟะพะปัะทััััั Asterisk):
- `POST /start` โ ะะตัะตะบะปััะฐะตััั ัะตัะตะท `USE_V2_HANDLERS`
- `POST /dial` โ ะะตัะตะบะปััะฐะตััั ัะตัะตะท `USE_V2_HANDLERS`
- `POST /bridge` โ ะะตัะตะบะปััะฐะตััั ัะตัะตะท `USE_V2_HANDLERS` 
- `POST /hangup` โ ะะตัะตะบะปััะฐะตััั ัะตัะตะท `USE_V2_HANDLERS`

#### ะขะตััะพะฒัะต (ะดะปั ะพัะปะฐะดะบะธ):
- `POST /v2/start` โ ะัะตะณะดะฐ V2 ะปะพะณะธะบะฐ
- `POST /v2/dial` โ ะัะตะณะดะฐ V2 ะปะพะณะธะบะฐ
- `POST /v2/bridge` โ ะัะตะณะดะฐ V2 ะปะพะณะธะบะฐ
- `POST /v2/hangup` โ ะัะตะณะดะฐ V2 ะปะพะณะธะบะฐ

## ๐ง **ะขะตัะฝะธัะตัะบะฐั ัะตะฐะปะธะทะฐัะธั**

### ๐พ **In-Memory ััะฐะฝะตะฝะธะต message_id:**
```python
# ะ app/services/calls/utils.py
v2_messages = {
    "unique_id_123": {
        "chat_id": 374573193,
        "message_id": 12345,
        "event_type": "dial"
    }
}
```

### ๐ก๏ธ **HTML ัะบัะฐะฝะธัะพะฒะฐะฝะธะต:**
- ะะพะปั ัะธะฟะฐ `"<unknown>"` ะฑะตะทะพะฟะฐัะฝะพ ัะบัะฐะฝะธัััััั
- ะัะตะดะพัะฒัะฐัะฐะตั ะพัะธะฑะบะธ Telegram API
- ะคัะฝะบัะธั `escape_html()` ะฒ `utils.py`

### ๐๏ธ **ะะพะณะธะบะฐ ัะดะฐะปะตะฝะธั:**
1. **DIAL** โ ัะดะฐะปัะตั message_id START ะดะปั ัะพะณะพ ะถะต unique_id
2. **BRIDGE** โ ัะดะฐะปัะตั message_id DIAL ะดะปั ัะพะณะพ ะถะต unique_id  
3. **HANGUP** โ ัะดะฐะปัะตั message_id BRIDGE ะดะปั ัะพะณะพ ะถะต unique_id

## ๐ **Nginx ะผะฐัััััะธะทะฐัะธั (ะะกะะะะะะะะ)**

### โ๏ธ **ะัะปะฐ ะฟัะพะฑะปะตะผะฐ:**
```nginx
location /dial/ {  # ัะพ ัะปะตัะตะผ
    proxy_pass http://127.0.0.1:8005/;  # React UI
}
```
**DIAL webhook ะฟะพะฟะฐะดะฐะป ะฝะฐ React ะฟัะธะปะพะถะตะฝะธะต ะฒะผะตััะพ API!**

### โ **ะัะฟัะฐะฒะปะตะฝะพ:**
```nginx
# Webhook ัะพะฑััะธั Asterisk โ API (ะฟะพัั 8000)
location ~ ^/(start|dial|bridge|hangup)$ {
    proxy_pass http://127.0.0.1:8000;
}

# React UI ัะฟัะฐะฒะปะตะฝะธั ััะตะผะฐะผะธ โ frontend (ะฟะพัั 8005)  
location /dial/ {
    proxy_pass http://127.0.0.1:8005/;
}
```

## ๐งช **ะขะตััะธัะพะฒะฐะฝะธะต ะฟะพะปะฝะพะน ัะตะฟะพัะบะธ**

### ๐ **ะกัะตะฝะฐัะธะน ัะตััะธัะพะฒะฐะฝะธั:**
1. ะัะฟัะฐะฒะธัั START โ ัะฒะธะดะตัั ัะพะพะฑัะตะฝะธะต ะฒ Telegram
2. ะัะฟัะฐะฒะธัั DIAL โ START ัะพะพะฑัะตะฝะธะต ัะดะฐะปะธััั, ะฟะพัะฒะธััั DIAL
3. ะัะฟัะฐะฒะธัั BRIDGE โ DIAL ัะพะพะฑัะตะฝะธะต ัะดะฐะปะธััั, ะฟะพัะฒะธััั BRIDGE  
4. ะัะฟัะฐะฒะธัั HANGUP โ BRIDGE ัะพะพะฑัะตะฝะธะต ัะดะฐะปะธััั, ะฟะพัะฒะธััั ัะธะฝะฐะปัะฝะพะต HANGUP

### โ **ะขะตัั START:**
```bash
curl -X POST http://localhost:8000/start -H "Content-Type: application/json" -d '{
  "Phone": "+375296254070",
  "UniqueId": "TEST-V2-123",
  "Token": "375293332255",
  "CallType": 1,
  "Trunk": "0001363"
}'

# ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั ะฒ Telegram:
# ๐ ะััะพะดััะธะน ะทะฒะพะฝะพะบ
# โ๏ธ152 โ ๐ฐ+375 29 625-40-70
# ๐ [ะฒัะตะผั]
```

### โ **ะขะตัั DIAL (ัะดะฐะปัะตั START):**
```bash
curl -X POST http://localhost:8000/dial -H "Content-Type: application/json" -d '{
  "Phone": "375296254070",
  "Extensions": ["152"],  
  "UniqueId": "TEST-V2-123",
  "Token": "375293332255",
  "CallType": 1,
  "Trunk": "0001363"
}'

# ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:
# START ัะพะพะฑัะตะฝะธะต ัะดะฐะปะตะฝะพ โ
# ะะพะฒะพะต DIAL ัะพะพะฑัะตะฝะธะต ะฟะพัะฒะธะปะพัั โ
```

### โ **ะขะตัั BRIDGE (ัะดะฐะปัะตั DIAL):**
```bash
curl -X POST http://localhost:8000/bridge -H "Content-Type: application/json" -d '{
  "UniqueId": "TEST-V2-123",
  "Token": "375293332255",
  "CallerIDNum": "152",
  "ConnectedLineNum": "375296254070",
  "BridgeUniqueid": "test-bridge-id"
}'

# ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:
# DIAL ัะพะพะฑัะตะฝะธะต ัะดะฐะปะตะฝะพ โ  
# ะะพะฒะพะต BRIDGE ัะพะพะฑัะตะฝะธะต ะฟะพัะฒะธะปะพัั โ
```

### โ **ะขะตัั HANGUP (ัะดะฐะปัะตั BRIDGE):**
```bash
curl -X POST http://localhost:8000/hangup -H "Content-Type: application/json" -d '{
  "Phone": "375296254070",
  "Extensions": ["152"],
  "CallStatus": "2", 
  "UniqueId": "TEST-V2-123",
  "Token": "375293332255",
  "CallType": 1,
  "Trunk": "0001363",
  "StartTime": "2025-07-09 20:17:43",
  "EndTime": "2025-07-09 20:18:02"
}'

# ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:
# BRIDGE ัะพะพะฑัะตะฝะธะต ัะดะฐะปะตะฝะพ โ
# ะคะธะฝะฐะปัะฝะพะต HANGUP ัะพะพะฑัะตะฝะธะต ะฟะพัะฒะธะปะพัั โ
```

## ๐ **ะะธะฐะณะฝะพััะธะบะฐ ะฟัะพะฑะปะตะผ**

### ๐จ **DIAL ะฒะพะทะฒัะฐัะฐะตั HTML:**
```html
<!doctype html>...Vochi Dial...
```
**ะัะธัะธะฝะฐ:** ะะตะฟัะฐะฒะธะปัะฝะฐั ะผะฐัััััะธะทะฐัะธั nginx  
**ะะตัะตะฝะธะต:** ะัะพะฒะตัะธัั ะบะพะฝัะธะณััะฐัะธั `/etc/nginx/sites-available/bot.vochi.by`

### ๐จ **ะัะธะฑะบะฐ `<unknown>` ะฒ Telegram:**
```
"Can't parse entities: unsupported start tag \"unknown\""
```
**ะัะธัะธะฝะฐ:** ะะพะปั ะพั Asterisk ะฝะต ัะบัะฐะฝะธัะพะฒะฐะฝั  
**ะะตัะตะฝะธะต:** HTML ัะบัะฐะฝะธัะพะฒะฐะฝะธะต ัะถะต ะดะพะฑะฐะฒะปะตะฝะพ ะฒ V2 ะพะฑัะฐะฑะพััะธะบะธ

### ๐จ **ะกะพะพะฑัะตะฝะธั ะฝะต ัะดะฐะปััััั:**
```python
# ะัะพะฒะตัะธัั ะฒ ะปะพะณะฐั:
"Deleted X previous messages for unique_id"
```
**ะัะธัะธะฝะฐ:** ะะพัะตัั message_id ะฒ ะฟะฐะผััะธ ะฟัะธ ะฟะตัะตะทะฐะฟััะบะต  
**ะะตัะตะฝะธะต:** ะญัะพ ะฝะพัะผะฐะปัะฝะพ, in-memory ััะฐะฝะตะฝะธะต ะพัะธัะฐะตััั ะฟัะธ ัะตััะฐััะต

## ๐ **ะัะตะธะผััะตััะฒะฐ V2**

1. ๐ด **ะะตะฐะป-ัะฐะนะผ ะผะพะฝะธัะพัะธะฝะณ** - ะฒะธะดะฝั ะฒัะต ััะฐะฟั ะทะฒะพะฝะบะฐ
2. ๐งน **ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ** - ััะฐััะต ัะพะพะฑัะตะฝะธั ัะดะฐะปััััั
3. ๐ฑ **ะะบััะฐะปัะฝะฐั ะธะฝัะพัะผะฐัะธั** - ะฒ ัะฐัะต ัะพะปัะบะพ ัะตะบััะธะน ััะฐััั
4. ๐ก๏ธ **ะะตะทะพะฟะฐัะฝะพััั** - ัะบัะฐะฝะธัะพะฒะฐะฝะธะต HTML ัะธะผะฒะพะปะพะฒ  
5. ๐ง **ะัะพััะพะต ะฟะตัะตะบะปััะตะฝะธะต** - ะผะตะถะดั V1 ะธ V2 ะปะพะณะธะบะพะน
6. ๐ฏ **ะัะฐะฒะธะปัะฝะฐั ะผะฐัััััะธะทะฐัะธั** - ะธัะฟัะฐะฒะปะตะฝั ะฟัะพะฑะปะตะผั nginx

## ๐๏ธ **ะะฐัััะพะนะบะฐ**

### 1. **ะะบะปััะธัั V2 ะปะพะณะธะบั:**
```python
# main.py
USE_V2_HANDLERS = True
```

### 2. **ะัะพะฒะตัะธัั nginx ะผะฐัััััะธะทะฐัะธั:**
```bash
# ะะพะปะถะฝะพ ะฑััั ะฒ /etc/nginx/sites-available/bot.vochi.by:
location ~ ^/(start|dial|bridge|hangup)$ {
    proxy_pass http://127.0.0.1:8000;
}
```

### 3. **ะะตัะตะทะฐะฟัััะธัั ัะตัะฒะธัั:**
```bash
./all.sh restart
systemctl reload nginx
```

### 4. **ะัะพะฒะตัะธัั ะฒ ะปะพะณะฐั:**
```bash
# ะะปั ะฒัะตั ัะพะฑััะธะน ะดะพะปะถะฝะพ ะฑััั:
tail -f logs/app.log | grep -E "(START|DIAL|BRIDGE|HANGUP)"

# ะะปั DELETE ะพะฟะตัะฐัะธะน:
tail -f logs/app.log | grep "Deleted.*previous messages"
```

## ๐ฏ **ะัะพะฒะตัะบะฐ ะณะพัะพะฒะฝะพััะธ ัะธััะตะผั**

### โ **ะงะตะบ-ะปะธัั:**
- [ ] `USE_V2_HANDLERS = True` ะฒ `main.py`
- [ ] Nginx ะฟัะฐะฒะธะปัะฝะพ ะผะฐัััััะธะทะธััะตั webhook ัะพะฑััะธั ะฝะฐ ะฟะพัั 8000
- [ ] ะัะต ัะตัะฒะธัั ะฟะตัะตะทะฐะฟััะตะฝั ัะตัะตะท `./all.sh restart`
- [ ] ะ ะปะพะณะฐั ะฒะธะดะฝั ะบะพััะตะบัะฝัะต ะพะฑัะฐะฑะพัะบะธ ัะพะฑััะธะน
- [ ] ะขะตััะพะฒัะน ะทะฒะพะฝะพะบ ะฟะพะบะฐะทัะฒะฐะตั ะฟัะฐะฒะธะปัะฝัั ัะตะฟะพัะบั ัะพะพะฑัะตะฝะธะน

### ๐ **ะะถะธะดะฐะตะผะพะต ะฟะพะฒะตะดะตะฝะธะต:**
1. **START** โ ะกะพะพะฑัะตะฝะธะต ะฟะพัะฒะปัะตััั ะฒ Telegram
2. **DIAL** โ START ัะดะฐะปัะตััั, DIAL ะฟะพัะฒะปัะตััั  
3. **BRIDGE** โ DIAL ัะดะฐะปัะตััั, BRIDGE ะฟะพัะฒะปัะตััั
4. **HANGUP** โ BRIDGE ัะดะฐะปัะตััั, ัะธะฝะฐะปัะฝะพะต HANGUP ะฟะพัะฒะปัะตััั

## ๐ **ะะฐะบะปััะตะฝะธะต**

V2 ะปะพะณะธะบะฐ ะพะฑะตัะฟะตัะธะฒะฐะตั ะพะฟัะธะผะฐะปัะฝัะน ะฑะฐะปะฐะฝั ะผะตะถะดั:
- **ะะพะปะฝัะผ ะผะพะฝะธัะพัะธะฝะณะพะผ** ะฒัะตั ััะฐะฟะพะฒ ะทะฒะพะฝะบะฐ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
- **ะงะธััะพัะพะน ัะฐัะพะฒ** ัะตัะตะท ะฐะฒัะพะผะฐัะธัะตัะบะพะต ัะดะฐะปะตะฝะธะต ะฟัะพะผะตะถััะพัะฝัั ัะพะพะฑัะตะฝะธะน  
- **ะะพะณะฐัะพะน ัะธะฝะฐะปัะฝะพะน ะธะฝัะพัะผะฐัะธะตะน** ะฒ HANGUP ัะพะพะฑัะตะฝะธัั

**ะะตะทัะปััะฐั:** ะะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั ะฒัะต ัะพะฑััะธั, ะฝะพ ัะฐั ะพััะฐะตััั ัะธัััะผ! ๐ 